[
  {
    "id": 0,
    "author": "user",
    "payload": {
      "type": "text",
      "text": "J'ai un souci quand j'ai des étudiants qui veulent ouvrir des entreprises eux même\n\nDéjà ils ne peuvent pas la créer de par eux-mêmes\nEnsuite, même si moi-même je dois créer l'agence, ça n'a pas lieu, comme si je n'avais pas le droit d'avoir plus de 6 agences dans la classe\n\nEnsuite je n'ai toujours pas vu dans l'UI la possibilité pour les étudiants de voir le solde de l'entreprise",
      "files": [],
      "fileUploads": [],
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1767801351,
      "nanos": 838000000
    }
  },
  {
    "id": 1,
    "author": "model",
    "payload": {
      "type": "thinking",
      "text": "**Addressing Student Agency**\n\nI'm focused on empowering students to initiate new agency creation. Currently, the process feels restricted to admins, and I'm aiming for student autonomy. I'm exploring the current admin logic, which appears buggy or limited. I'm thinking that if I can get to the bottom of the problems, I can begin to provide students with more freedom.\n\n\n**Investigating Agency Creation**\n\nI've uncovered a potential limit on agency creation. I'm looking at `AdminMercato.tsx` for `handleCreateAgency` and `GameContext.tsx` for updates. I can't find a `createAgency` specifically for students. The student side, in `MercatoView.tsx`, only has apply/resign options. I also checked `StudentAgencyView.tsx` and various types. I'm focusing on enabling student-initiated agency creation. I'm considering a \"Fonder un Studio\" button for unemployed students. They would pay a cost to establish an agency, if funds allow. I'm still exploring how to integrate this new feature without breaking existing logic.\n\n\n**Developing New Features**\n\nI'm now focused on adding a \"Request Agency Creation\" button in `MercatoView.tsx` for unemployed students, which will create a \"Pending Agency\" or request admin action. I'm also addressing an admin creation bug in `AdminMercato.tsx` related to `agencies` initialization and progress. I'm making sure `progress` is correctly initialized from `INITIAL_WEEKS`. And I'm reviewing `updateAgenciesList` in `GameContext`. Finally, I'm verifying the agency balance display in `StudentAgencyView.tsx`, ensuring it's appropriately visible.\n\n\n**Improving UI Visibility**\n\nI'm now making the agency balance more visible to students. The balance display is present but potentially subtle, so I'm investigating how to improve its prominence. It seems the balance is only shown when students are assigned to an agency, which is likely the user's issue. I'm exploring enhancements for unassigned students to anticipate costs, or simply making the existing element more prominent to all.\n\n\n**Expanding Display Locations**\n\nI'm now expanding the visibility of the agency balance, incorporating it into the \"Market\" or \"Bank\" tab. I am working on `GameContext.tsx` to include `requestAgencyCreation`, as well as adding a button in `UnemployedView`, within `MercatoView`, so users can start requests. I'm also ensuring the `handleCreateAgency` function doesn't have a hidden limit and accurately clones the week structure.\n\n\n**Finalizing Feature Integration**\n\nNow, I'm working to integrate the \"Fonder un Studio\" button within the `UnemployedView`, as well as enhance the agency balance visibility. This includes adding `requestAgencyCreation` to `GameContext.tsx`, and modifying `AdminMercato.tsx` to handle new agency foundation requests. I have also added a \"Solde du Studio\" card in `StudentAgencyView`, specifically within the Wallet tab, to improve transparency. The admin view now handles new foundation requests. The manual agency creation bug has also been fixed.\n\n\n",
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1767801351,
      "nanos": 839000000
    },
    "doneTimestamp": {
      "seconds": 1767801368,
      "nanos": 62000000
    }
  },
  {
    "id": 2,
    "author": "model",
    "payload": {
      "type": "text",
      "text": "C'est une excellente remarque. Effectivement, le système actuel était trop restrictif : seul l'enseignant pouvait créer manuellement, et la logique d'initialisation des semaines pouvait échouer si la première agence de la liste était vide.\n\nVoici les modifications pour :\n1.  **Permettre aux étudiants au chômage de demander la création d'un studio** (avec coût en PiXi et Score).\n2.  **Corriger le bug de création côté Admin** (initialisation propre des données).\n3.  **Rendre le solde de l'entreprise très visible** pour les étudiants dans l'onglet \"Banque\".\n\n### Spécifications des changements\n\n**1. Pour les Étudiants (Vue Chômage) :**\n*   Ajout d'un bouton \"Fonder mon Studio\" dans la vue `UnemployedView`.\n*   Affiche le coût (2000 PiXi + 20 Points) pour que l'étudiant sache à quoi s'engager.\n*   Envoie une requête `FOUND_AGENCY` qui apparaît chez l'Admin.\n\n**2. Pour l'Admin (Vue Mercato) :**\n*   Une nouvelle section \"Demandes de Fondation\" apparaît pour valider ces nouveaux studios.\n*   Correction de la fonction `handleCreateAgency` pour s'assurer qu'elle utilise `INITIAL_WEEKS` et non une copie d'une autre agence potentiellement vide.\n*   Suppression de toute limitation visuelle qui pourrait faire croire à un plafond de 6 agences.\n\n**3. Transparence Financière (Vue Étudiant) :**\n*   Ajout d'une carte \"Trésorerie de l'Entreprise\" en haut de l'onglet **Banque (Wallet)** pour que le solde du groupe soit aussi clair que le solde personnel.\n\n",
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1767801368,
      "nanos": 62000000
    },
    "doneTimestamp": {
      "seconds": 1767801368,
      "nanos": 63000000
    }
  },
  {
    "id": 3,
    "author": "model",
    "payload": {
      "type": "generationTable",
      "entries": [
        {
          "path": "types.ts",
          "generationType": 1,
          "isDone": true,
          "description": "Ajout du type de requête FOUND_AGENCY",
          "diffs": [
            {
              "target": "",
              "replacement": "\nexport enum CycleType {\n  MARQUE_BRIEF = \"Cycle 1: Marque & Brief\",\n  NARRATION_IA = \"Cycle 2: Narration & IA\",\n  LOOKDEV = \"Cycle 3: Look-dev & Sélection\",\n  PACKAGING = \"Cycle 4: Packaging & Soutenance\"\n}\n\nexport interface PeerReview {\n  id: string;\n  date: string;\n  weekId: string;\n  reviewerId: string;\n  reviewerName: string;\n  targetId: string;\n  targetName: string;\n  ratings: {\n    attendance: number; // 1-5\n    quality: number; // 1-5\n    involvement: number; // 1-5\n  };\n  comment: string;\n}\n\nexport interface Deliverable {\n  id: string;\n  name: string;\n  description: string;\n  status: 'pending' | 'submitted' | 'validated' | 'rejected';\n  score?: number; // 0-100\n  feedback?: string;\n  fileUrl?: string;\n  // Grading Details\n  submissionDate?: string;\n  grading?: {\n    quality: 'A' | 'B' | 'C' | 'REJECTED';\n    daysLate: number;\n    constraintBroken: boolean;\n    finalDelta: number;\n    mvpId?: string; // NEW: The student who carried the task\n  }\n}\n\nexport interface ClassSession {\n    date: string; // YYYY-MM-DD\n    slot: 'MATIN' | 'APRÈS-MIDI' | 'JOURNÉE';\n}\n\nexport interface WeekModule {\n  id: string;\n  title: string;\n  type: 'FUN/CHILL' | 'THÉORIE' | 'TECHNIQUE' | 'JURY';\n  objectives: string[];\n  deliverables: Deliverable[];\n  locked: boolean;\n  status?: 'pending' | 'in_progress' | 'validated';\n  schedule: {\n      classA: ClassSession | null;\n      classB: ClassSession | null;\n  };\n}\n\n// --- NEW: STUDENT HISTORY ---\nexport interface StudentHistoryEntry {\n    date: string;\n    agencyId: string;\n    agencyName: string;\n    action: 'JOINED' | 'LEFT' | 'FIRED' | 'RESIGNED' | 'MERGED';\n    contextVE: number;      // VE de l'agence au moment du départ/arrivée\n    contextBudget: number;  // Tréso de l'agence au moment du départ/arrivée\n    reason?: string;        // Motif (ex: \"Licenciement économique\", \"Démission\")\n}\n\nexport interface Badge {\n    id: string;\n    label: string;\n    description: string;\n    icon: string; // Identifier for Lucide icon or image path\n    unlockedAt?: string;\n}\n\nexport interface Student {\n  id: string;\n  name: string;\n  role: string; // Standardisé (ex: \"Associé\")\n  avatarUrl: string;\n  individualScore: number; // 0-100\n  wallet: number; // NEW: Personal Funds in PiXi\n  cvUrl?: string; // URL vers le PDF du CV\n  classId: 'A' | 'B'; // Gestion des deux promotions\n  connectionStatus?: 'online' | 'offline' | 'pending';\n  history?: StudentHistoryEntry[]; // Parcours professionnel\n  badges?: Badge[]; // NEW: Individual Badges\n  streak?: number; // NEW: Streak for performance\n}\n\nexport type EventType = 'CRISIS' | 'VE_DELTA' | 'BUDGET_DELTA' | 'CHECKPOINT' | 'INFO' | 'PAYROLL' | 'REVENUE' | 'BLACK_OP' | 'MERGER';\n\nexport interface GameEvent {\n  id: string;\n  date: string; // ISO String\n  type: EventType;\n  label: string; // Titre court (ex: \"Pénurie matériaux\")\n  description?: string;\n  deltaVE?: number; // Impact sur la VE (ex: -15)\n  deltaBudgetReal?: number;\n  deltaBudgetValued?: number;\n}\n\nexport interface ProjectDefinition {\n  problem: string;      // Problème réel et local\n  target: string;       // Qui souffre (Persona)\n  location: string;     // Où ça se passe\n  gesture: string;      // Geste architectural unique\n  isLocked: boolean;    // Validé par le prof ?\n}\n\nexport interface MercatoRequest {\n  id: string;\n  type: 'HIRE' | 'FIRE' | 'FOUND_AGENCY'; \n  studentId: string; // La cible du mouvement\n  studentName: string;\n  requesterId?: string; // Qui a fait la demande\n  targetAgencyId: string; // L'agence concernée (ou 'new' pour foundation)\n  status: 'PENDING' | 'REJECTED';\n  date: string;\n  motivation?: string; // Texte justificatif\n  votes?: { [studentId: string]: 'APPROVE' | 'REJECT' }; \n}\n\n// --- NEW: MERGER REQUEST ---\nexport interface MergerRequest {\n    id: string;\n    requesterAgencyId: string;\n    requesterAgencyName: string;\n    targetAgencyId: string; // L'agence qui va se faire absorber\n    status: 'PENDING' | 'REJECTED';\n    date: string;\n    offerDetails: string; // Description de l'offre (ex: \"Rachat de dette\")\n}\n\n// --- NEW: FINANCIAL REQUESTS ---\nexport interface TransactionRequest {\n    id: string;\n    studentId: string;\n    studentName: string;\n    type: 'BUY_SCORE';\n    amountPixi: number;\n    amountScore: number;\n    status: 'PENDING' | 'REJECTED';\n    date: string;\n}\n\n// --- NEW TYPES FOR GAMIFICATION ---\n\nexport type BrandColor = 'indigo' | 'emerald' | 'rose' | 'amber' | 'cyan' | 'slate';\n\nexport interface AgencyBranding {\n    color: BrandColor;\n    bannerUrl?: string;\n}\n\nexport interface Agency {\n  id: string;\n  name: string;\n  tagline: string;\n  logoUrl?: string;\n  members: Student[];\n  peerReviews: PeerReview[];\n  classId: 'A' | 'B' | 'ALL'; // ALL pour l'agence Chômage\n  \n  // Data Driven by Events\n  ve_current: number; // 0-100 (La note/valeur)\n  budget_real: number; // En PiXi\n  budget_valued: number; // En PiXi\n  weeklyTax: number; // Pourcentage de charges hebdo (0.1 = 10%)\n  weeklyRevenueModifier: number; // Bonus/Malus récurrent en PiXi (ex: +500 par semaine grâce à un prix)\n  \n  status: 'stable' | 'fragile' | 'critique';\n  \n  eventLog: GameEvent[]; // Source of Truth\n  \n  currentCycle: CycleType;\n  \n  // New Project Structure\n  projectDef: ProjectDefinition;\n  \n  // Mercato Requests (Pending)\n  mercatoRequests: MercatoRequest[];\n  \n  // Financial Requests (Pending)\n  transactionRequests: TransactionRequest[];\n\n  // Merger Requests (Pending)\n  mergerRequests?: MergerRequest[];\n\n  // Legacy constraints\n  constraints: {\n    space: string;\n    style: string;\n    client: string;\n  };\n  \n  progress: {\n    [weekId: string]: WeekModule;\n  };\n\n  // --- NEW FIELDS ---\n  branding: AgencyBranding;\n  badges: Badge[];\n}\n\nexport interface AppState {\n  userRole: 'admin' | 'student';\n  selectedAgencyId: string | null;\n  agencies: Agency[];\n}\n\nexport interface CrisisPreset {\n  label: string;\n  description: string;\n  deltaVE: number;\n  deltaBudget: number;\n  icon: any;\n}\n\n// --- NEW: AWARDS ---\nexport interface CycleAwardDefinition {\n    id: string;\n    cycleId: CycleType;\n    title: string;\n    description: string;\n    veBonus: number;\n    weeklyBonus: number; // En PiXi/semaine (Récurrent)\n    iconName: 'compass' | 'mic' | 'eye' | 'crown';\n}\n\n// --- WIKI / RESOURCES ---\nexport interface WikiResource {\n    id: string;\n    title: string;\n    description?: string;\n    type: 'PDF' | 'VIDEO' | 'LINK' | 'ASSET';\n    url: string;\n    targetClass: 'ALL' | 'A' | 'B';\n    date: string;\n}\n"
            }
          ]
        },
        {
          "path": "components/AdminMercato.tsx",
          "generationType": 1,
          "isDone": true,
          "description": "Correction de la création d'agence et gestion des demandes de fondation",
          "diffs": [
            {
              "target": "",
              "replacement": "\nimport React, { useState, useMemo } from 'react';\nimport { Agency, GameEvent, MercatoRequest, StudentHistoryEntry, CycleType } from '../types';\nimport { ArrowRightLeft, UserPlus, UserMinus, Briefcase, Plus, AlertCircle, Check, X, FileSearch, UserX, Coins, Quote, User, Info, Building2 } from 'lucide-react';\nimport { useUI } from '../contexts/UIContext';\nimport { GAME_RULES, INITIAL_WEEKS } from '../constants';\n\ninterface AdminMercatoProps {\n  agencies: Agency[];\n  onUpdateAgencies: (agencies: Agency[]) => void;\n  readOnly?: boolean;\n}\n\nexport const AdminMercato: React.FC<AdminMercatoProps> = ({ agencies, onUpdateAgencies, readOnly }) => {\n  const { confirm, toast } = useUI();\n  const [selectedStudentId, setSelectedStudentId] = useState<string | null>(null);\n  const [targetAgencyId, setTargetAgencyId] = useState<string | null>(null);\n\n  const unassignedAgency = agencies.find(a => a.id === 'unassigned');\n  const activeAgencies = agencies.filter(a => a.id !== 'unassigned');\n\n  const pendingRequests = useMemo(() => {\n      const requests: {req: MercatoRequest, agency: Agency}[] = [];\n      agencies.forEach(a => {\n          (a.mercatoRequests || []).forEach(r => {\n              if (r.status === 'PENDING') requests.push({req: r, agency: a});\n          });\n      });\n      return requests;\n  }, [agencies]);\n\n  const findStudentData = (studentId: string) => {\n    for (const agency of agencies) {\n        const student = agency.members.find(m => m.id === studentId);\n        if (student) return { student, agency };\n    }\n    return null;\n  };\n\n  const calculateFiringVEDelta = (score: number) => {\n      if (score < 30) return 10;\n      if (score < 50) return 5;\n      if (score < 70) return -5;\n      if (score < 90) return -15;\n      return -25;\n  };\n\n  const executeTransfer = (studentId: string, sourceAgencyId: string, targetAgencyId: string, transferType: 'HIRE' | 'FIRE' | 'TRANSFER', reason?: string) => {\n    const sourceAgency = agencies.find(a => a.id === sourceAgencyId);\n    const targetAgency = agencies.find(a => a.id === targetAgencyId);\n    const student = sourceAgency?.members.find(m => m.id === studentId);\n\n    if (!sourceAgency || !targetAgency || !student) return;\n\n    const today = new Date().toISOString().split('T')[0];\n    const newHistory: StudentHistoryEntry[] = [...(student.history || [])];\n    \n    if (sourceAgencyId !== 'unassigned') {\n        newHistory.push({\n            date: today, agencyId: sourceAgency.id, agencyName: sourceAgency.name,\n            action: transferType === 'FIRE' ? 'FIRED' : 'LEFT',\n            contextVE: sourceAgency.ve_current, contextBudget: sourceAgency.budget_real,\n            reason: reason || (transferType === 'FIRE' ? \"Licenciement\" : \"Départ\")\n        });\n    }\n\n    if (targetAgencyId !== 'unassigned') {\n        newHistory.push({\n            date: today, agencyId: targetAgency.id, agencyName: targetAgency.name,\n            action: 'JOINED', contextVE: targetAgency.ve_current, contextBudget: targetAgency.budget_real,\n            reason: reason || \"Recrutement\"\n        });\n    }\n\n    const updatedStudent = { ...student, history: newHistory };\n    const updatedSourceMembers = sourceAgency.members.filter(m => m.id !== student.id);\n    const updatedSource = { ...sourceAgency, members: updatedSourceMembers };\n    const updatedTargetMembers = [...targetAgency.members, updatedStudent];\n    const updatedTarget = { ...targetAgency, members: updatedTargetMembers };\n\n    let eventSource: GameEvent | null = null;\n    let eventTarget: GameEvent | null = null;\n    let sourceVEDelta = 0;\n    let targetVEDelta = 0;\n\n    if (transferType === 'FIRE') {\n        sourceVEDelta = calculateFiringVEDelta(student.individualScore);\n        let label = sourceVEDelta > 0 ? \"Restructuration\" : \"Perte Compétence\";\n        eventSource = {\n            id: `evt-${Date.now()}-1`, date: today, type: sourceVEDelta > 0 ? 'VE_DELTA' : 'CRISIS',\n            label: label, deltaVE: sourceVEDelta,\n            description: `Départ de ${student.name}.`\n        };\n    } else if (transferType === 'HIRE') {\n        targetVEDelta = -5;\n        eventTarget = {\n            id: `evt-${Date.now()}-2`, date: today, type: 'VE_DELTA', label: 'Recrutement Ext.', deltaVE: targetVEDelta,\n            description: `${student.name} rejoint l'équipe.`\n        };\n    }\n\n    if (eventSource && sourceAgency.id !== 'unassigned') {\n        updatedSource.eventLog = [...updatedSource.eventLog, eventSource];\n        updatedSource.ve_current = Math.max(0, updatedSource.ve_current + sourceVEDelta);\n    }\n    if (eventTarget && targetAgency.id !== 'unassigned') {\n        updatedTarget.eventLog = [...updatedTarget.eventLog, eventTarget];\n        updatedTarget.ve_current = Math.max(0, updatedTarget.ve_current + targetVEDelta);\n    }\n\n    return agencies.map(a => \n        a.id === sourceAgency.id ? updatedSource : \n        a.id === targetAgency.id ? updatedTarget : a\n    );\n  }\n\n  const handleManualTransfer = async () => {\n     if(readOnly) return;\n     if (!selectedStudentId || !targetAgencyId) return;\n     const sourceData = findStudentData(selectedStudentId);\n     if (!sourceData) return;\n\n     const student = sourceData.student;\n     const targetAgency = agencies.find(a => a.id === targetAgencyId);\n     \n     if (targetAgency && targetAgency.id !== 'unassigned' && targetAgency.classId !== student.classId) {\n         toast('error', `Classes incompatibles (Étudiant ${student.classId} -> Agence ${targetAgency.classId})`);\n         return;\n     }\n     \n     const type = sourceData.agency.id === 'unassigned' ? 'HIRE' : targetAgencyId === 'unassigned' ? 'FIRE' : 'TRANSFER';\n     const confirmed = await confirm({\n         title: \"Confirmation de Mouvement RH\",\n         message: `Forcer le mouvement de ${student.name} ?\\nDe ${sourceData.agency.name} vers ${targetAgency?.name || 'Chômage'}`,\n         confirmText: \"Valider\", isDangerous: type === 'FIRE'\n     });\n\n     if (!confirmed) return;\n\n     const newAgencies = executeTransfer(selectedStudentId, sourceData.agency.id, targetAgencyId, type, \"Action Admin\");\n     if(newAgencies) {\n         onUpdateAgencies(newAgencies);\n         toast('success', `Transfert effectué`);\n         setSelectedStudentId(null); setTargetAgencyId(null);\n     }\n  };\n\n  const handleApproveRequest = async (request: MercatoRequest, requestAgency: Agency) => {\n      if(readOnly) return;\n      \n      if (request.type === 'FOUND_AGENCY') {\n          const studentData = findStudentData(request.studentId);\n          if(!studentData) return;\n          \n          const student = studentData.student;\n          const newAgencyId = `a-${Date.now()}`;\n          const newAgency: Agency = {\n              id: newAgencyId, \n              name: `Studio de ${student.name}`, \n              tagline: \"Nouveau projet en cours...\", \n              ve_current: 20, \n              status: 'critique',\n              classId: student.classId, \n              budget_real: 2000, \n              budget_valued: 0, \n              weeklyTax: 0, \n              weeklyRevenueModifier: 0,\n              members: [{\n                  ...student,\n                  wallet: (student.wallet || 0) - GAME_RULES.CREATION_COST_PIXI,\n                  individualScore: Math.max(0, student.individualScore - GAME_RULES.CREATION_COST_SCORE)\n              }], \n              peerReviews: [], \n              eventLog: [{ \n                  id: `e-${newAgencyId}-1`, \n                  date: new Date().toISOString().split('T')[0], \n                  type: \"INFO\", \n                  label: \"Ouverture Studio\", \n                  deltaVE: 0, \n                  description: `Fondé par ${student.name}.` \n              }],\n              currentCycle: CycleType.MARQUE_BRIEF, \n              constraints: { space: \"À définir\", style: \"À définir\", client: \"À définir\" },\n              projectDef: { problem: \"\", target: \"\", location: \"\", gesture: \"\", isLocked: false },\n              mercatoRequests: [], \n              transactionRequests: [], \n              branding: { color: student.classId === 'A' ? 'indigo' : 'cyan' }, \n              badges: [], \n              progress: JSON.parse(JSON.stringify(INITIAL_WEEKS))\n          };\n\n          const updatedAgencies = agencies.map(a => {\n              if (a.id === 'unassigned') return { ...a, members: a.members.filter(m => m.id !== student.id), mercatoRequests: a.mercatoRequests.filter(r => r.id !== request.id) };\n              return a;\n          });\n          onUpdateAgencies([...updatedAgencies, newAgency]);\n          toast('success', `Studio créé pour ${student.name}`);\n          return;\n      }\n\n      let newAgencies: Agency[] | undefined;\n      const studentData = findStudentData(request.studentId);\n      if(!studentData) return;\n\n      if (request.type === 'FIRE') {\n          newAgencies = executeTransfer(request.studentId, request.targetAgencyId, 'unassigned', 'FIRE', request.motivation);\n      } else if (request.type === 'HIRE') {\n          newAgencies = executeTransfer(request.studentId, studentData.agency.id, request.targetAgencyId, 'HIRE', request.motivation);\n      }\n\n      if (newAgencies) {\n          const finalAgencies = newAgencies.map(a => {\n             if (a.id === requestAgency.id) {\n                 return { ...a, mercatoRequests: a.mercatoRequests.filter(r => r.id !== request.id) };\n             }\n             return a;\n          });\n          onUpdateAgencies(finalAgencies);\n          toast('success', 'Demande validée.');\n      }\n  };\n\n  const handleRejectRequest = (request: MercatoRequest, requestAgency: Agency) => {\n      if(readOnly) return;\n      const updatedAgency = { ...requestAgency, mercatoRequests: requestAgency.mercatoRequests.filter(r => r.id !== request.id) };\n      onUpdateAgencies(agencies.map(a => a.id === updatedAgency.id ? updatedAgency : a));\n      toast('info', 'Demande rejetée.');\n  };\n\n  const handleCreateAgencyManual = async () => {\n      if(readOnly) return;\n      const newAgencyId = `a-manual-${Date.now()}`;\n      \n      const proceed = await confirm({\n          title: \"Créer un nouveau studio ?\",\n          message: \"Voulez-vous créer une agence vide ? Vous devrez y transférer des membres manuellement ensuite.\",\n          confirmText: \"Créer Agence\"\n      });\n\n      if (!proceed) return;\n\n      const newAgency: Agency = {\n          id: newAgencyId, \n          name: \"Nouveau Studio Admin\", \n          tagline: \"En construction...\", \n          ve_current: 20, \n          status: 'critique',\n          classId: 'A', \n          budget_real: 2000, \n          budget_valued: 0, \n          weeklyTax: 0, \n          weeklyRevenueModifier: 0,\n          members: [], \n          peerReviews: [], \n          eventLog: [{ id: `e-${newAgencyId}-1`, date: new Date().toISOString().split('T')[0], type: \"INFO\", label: \"Ouverture Studio\", deltaVE: 0, description: \"Action administrative.\" }],\n          currentCycle: CycleType.MARQUE_BRIEF, \n          constraints: { space: \"À définir\", style: \"À définir\", client: \"À définir\" },\n          projectDef: { problem: \"\", target: \"\", location: \"\", gesture: \"\", isLocked: false },\n          mercatoRequests: [], \n          transactionRequests: [], \n          branding: { color: 'indigo' }, \n          badges: [], \n          progress: JSON.parse(JSON.stringify(INITIAL_WEEKS))\n      };\n\n      onUpdateAgencies([...agencies, newAgency]);\n      toast('success', 'Studio créé.');\n  };\n\n  return (\n    <div className=\"animate-in fade-in duration-500 pb-20\">\n        <div className=\"flex justify-between items-center mb-6\">\n            <div>\n                <h2 className=\"text-3xl font-display font-bold text-slate-900\">Mercato & RH</h2>\n                <p className=\"text-slate-500 text-sm\">Gérez les candidatures et les nouveaux studios.</p>\n            </div>\n            {!readOnly && (\n                <button onClick={handleCreateAgencyManual} className=\"bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-xl font-bold text-sm flex items-center gap-2 transition-colors shadow-lg\">\n                    <Plus size={18} /> Créer un Studio Vide\n                </button>\n            )}\n        </div>\n\n        {/* --- SECTION: PENDING REQUESTS --- */}\n        {pendingRequests.length > 0 && (\n            <div className=\"mb-8 bg-amber-50 border border-amber-200 rounded-2xl p-6\">\n                <h3 className=\"text-amber-800 font-bold flex items-center gap-2 mb-4\">\n                    <AlertCircle size={20}/> Demandes en attente ({pendingRequests.length})\n                </h3>\n                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n                    {pendingRequests.map(({req, agency}) => {\n                        const studentData = findStudentData(req.studentId);\n                        const student = studentData?.student;\n                        const isFoundation = req.type === 'FOUND_AGENCY';\n\n                        return (\n                            <div key={req.id} className=\"bg-white p-4 rounded-xl border border-amber-100 shadow-sm flex flex-col gap-2\">\n                                <div className=\"flex justify-between items-start\">\n                                    <div className=\"flex items-center gap-2\">\n                                        <span className={`text-[10px] font-bold px-2 py-0.5 rounded-md uppercase ${\n                                            isFoundation ? 'bg-purple-600 text-white' : \n                                            req.type === 'HIRE' ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'\n                                        }`}>\n                                            {isFoundation ? 'Fondation Studio' : req.type === 'HIRE' ? 'Embauche' : 'Départ'}\n                                        </span>\n                                        <span className=\"text-[10px] bg-slate-100 text-slate-500 px-1 rounded font-bold\">Cl. {student?.classId}</span>\n                                    </div>\n                                    {!readOnly && (\n                                    <div className=\"flex gap-1\">\n                                        <button onClick={() => handleRejectRequest(req, agency)} className=\"p-1.5 bg-slate-100 hover:bg-red-100 text-slate-400 hover:text-red-600 rounded-lg\"><X size={16}/></button>\n                                        <button onClick={() => handleApproveRequest(req, agency)} className=\"p-1.5 bg-slate-900 hover:bg-emerald-600 text-white rounded-lg\"><Check size={16}/></button>\n                                    </div>\n                                    )}\n                                </div>\n\n                                <div className=\"mt-1\">\n                                    <p className=\"font-bold text-slate-900 text-sm\">\n                                        {req.studentName}\n                                        <span className=\"block text-[10px] text-slate-400 font-normal mt-0.5\">\n                                            {isFoundation ? `veut fonder sa propre agence (-${GAME_RULES.CREATION_COST_PIXI} PiXi)` : `cible : ${agency.name}`}\n                                        </span>\n                                    </p>\n                                    {req.motivation && (\n                                        <div className=\"bg-slate-50 p-2 rounded-lg mt-2 flex gap-2 border border-slate-100\">\n                                            <Quote size={12} className=\"text-slate-300 shrink-0\"/>\n                                            <p className=\"text-xs text-slate-600 italic\">\"{req.motivation}\"</p>\n                                        </div>\n                                    )}\n                                </div>\n                            </div>\n                        );\n                    })}\n                </div>\n            </div>\n        )}\n\n        <div className=\"grid grid-cols-1 md:grid-cols-12 gap-6\">\n            <div className=\"md:col-span-12\">\n                <h3 className=\"text-sm font-bold text-slate-500 uppercase tracking-widest mb-3 flex items-center gap-2\">\n                    <Briefcase size={16}/> Vivier / Pôle Chômage\n                </h3>\n                <div className={`border-2 border-dashed rounded-2xl p-4 mb-8 transition-colors ${targetAgencyId === 'unassigned' ? 'bg-red-50 border-red-300' : 'bg-slate-100 border-slate-300'}`}>\n                    <div className=\"flex justify-between items-center mb-4\">\n                        <p className=\"text-sm text-slate-500 italic\">Cliquez sur un étudiant pour le sélectionner, puis choisissez une destination.</p>\n                        <button onClick={() => !readOnly && setTargetAgencyId('unassigned')} disabled={readOnly} className={`px-4 py-2 rounded-lg text-xs font-bold transition-all ${targetAgencyId === 'unassigned' ? 'bg-red-600 text-white' : 'bg-white text-slate-600 border border-slate-200'}`}>\n                            Action: Licencier\n                        </button>\n                    </div>\n                    <div className=\"flex flex-wrap gap-3\">\n                        {unassignedAgency?.members.map(student => (\n                            <div key={student.id} onClick={() => !readOnly && setSelectedStudentId(student.id)} className={`flex items-center gap-3 p-3 rounded-xl border-2 transition-all cursor-pointer ${selectedStudentId === student.id ? 'bg-white border-indigo-500 shadow-md transform scale-105' : 'bg-white border-slate-200'}`}>\n                                <img src={student.avatarUrl} className=\"w-8 h-8 rounded-full grayscale\" />\n                                <div>\n                                    <p className=\"font-bold text-slate-700 text-sm leading-none\">{student.name}</p>\n                                    <span className={`text-[9px] font-bold px-1.5 rounded text-white ${student.classId === 'A' ? 'bg-blue-400' : 'bg-purple-400'}`}>CLASSE {student.classId}</span>\n                                </div>\n                            </div>\n                        ))}\n                    </div>\n                </div>\n\n                <h3 className=\"text-sm font-bold text-slate-500 uppercase tracking-widest mb-3 flex items-center gap-2\"><UserPlus size={16}/> Agences Actives</h3>\n                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\n                    {activeAgencies.map(agency => (\n                        <div key={agency.id} className={`bg-white rounded-2xl border transition-all relative overflow-hidden ${targetAgencyId === agency.id ? 'border-indigo-500 shadow-lg ring-2 ring-indigo-100' : 'border-slate-200 hover:border-slate-300'}`}>\n                            <div className={`absolute top-0 left-0 right-0 h-1 ${agency.classId === 'A' ? 'bg-blue-400' : 'bg-purple-400'}`}></div>\n                            <div onClick={() => !readOnly && setTargetAgencyId(agency.id)} className={`p-4 border-b border-slate-100 flex justify-between items-center rounded-t-2xl mt-1 transition-colors cursor-pointer ${targetAgencyId === agency.id ? 'bg-indigo-50' : 'bg-slate-50'}`}>\n                                <div>\n                                    <h4 className=\"font-bold text-slate-700\">{agency.name}</h4>\n                                    <span className=\"text-[10px] font-bold px-1.5 py-0.5 rounded bg-slate-200 text-slate-600\">CLASSE {agency.classId}</span>\n                                </div>\n                                {targetAgencyId === agency.id && <span className=\"text-[10px] bg-indigo-200 text-indigo-800 px-2 rounded-full font-bold\">Cible</span>}\n                            </div>\n                            <div className=\"p-4 space-y-2\">\n                                {agency.members.map(student => (\n                                    <div key={student.id} onClick={(e) => { e.stopPropagation(); if(!readOnly) setSelectedStudentId(student.id); }} className={`flex items-center gap-3 p-2 rounded-xl transition-all cursor-pointer ${selectedStudentId === student.id ? 'bg-indigo-600 text-white shadow-md' : 'hover:bg-slate-50 text-slate-700'}`}>\n                                        <img src={student.avatarUrl} className=\"w-8 h-8 rounded-full\" />\n                                        <div className=\"flex-1\">\n                                            <p className=\"font-bold text-sm leading-none\">{student.name}</p>\n                                            <p className=\"text-[10px] mt-0.5 opacity-70\">{student.role}</p>\n                                        </div>\n                                    </div>\n                                ))}\n                            </div>\n                        </div>\n                    ))}\n                </div>\n            </div>\n        </div>\n        \n        {!readOnly && selectedStudentId && targetAgencyId && (\n        <div className=\"fixed bottom-6 left-1/2 transform -translate-x-1/2 md:ml-32 bg-slate-900 text-white px-6 py-4 rounded-2xl shadow-2xl flex items-center gap-6 z-50\">\n            <div className=\"flex items-center gap-3\">\n                 <div className=\"text-right\">\n                    <span className=\"block text-[10px] text-slate-400 uppercase font-bold\">Source: {findStudentData(selectedStudentId)?.agency.name}</span>\n                 </div>\n                 <ArrowRightLeft className=\"text-slate-500\" />\n                 <div>\n                    <span className=\"block text-[10px] text-slate-400 uppercase font-bold\">Cible: {targetAgencyId === 'unassigned' ? 'Chômage' : agencies.find(a => a.id === targetAgencyId)?.name}</span>\n                 </div>\n            </div>\n            <button onClick={handleManualTransfer} className=\"bg-white text-slate-900 px-6 py-2 rounded-xl font-bold text-sm hover:bg-indigo-50\">Transférer (Force)</button>\n        </div>\n        )}\n    </div>\n  );\n};\n"
            }
          ]
        },
        {
          "path": "components/student/mercato/UnemployedView.tsx",
          "generationType": 1,
          "isDone": true,
          "description": "Ajout de la possibilité de fonder un studio pour les chômeurs",
          "diffs": [
            {
              "target": "",
              "replacement": "\nimport React from 'react';\nimport { Agency, Student } from '../../../types';\nimport { Briefcase, FileText, Upload, UserPlus, Send, Building2, Coins, TrendingUp } from 'lucide-react';\nimport { GAME_RULES } from '../../../constants';\n\ninterface UnemployedViewProps {\n    currentUser: Student | undefined;\n    availableAgencies: Agency[];\n    onOpenCVModal: () => void;\n    onOpenApplyModal: (agencyId: string) => void;\n}\n\nexport const UnemployedView: React.FC<UnemployedViewProps> = ({ currentUser, availableAgencies, onOpenCVModal, onOpenApplyModal }) => {\n    \n    // Check if there's already a pending FOUND_AGENCY request\n    // This requires checking the unassigned agency requests (passed in context usually, but for UI we assume one request at a time)\n    \n    return (\n        <div className=\"animate-in fade-in space-y-6\">\n            <div className=\"bg-red-50 border-l-4 border-red-500 p-6 rounded-r-xl\">\n                <h3 className=\"text-red-700 font-bold text-lg flex items-center gap-2\">\n                    <Briefcase size={24}/> Statut: Sans Emploi\n                </h3>\n                <div className=\"flex items-center gap-2 mt-2\">\n                    <span className={`text-[10px] font-bold px-2 py-1 rounded text-white ${currentUser?.classId === 'A' ? 'bg-blue-400' : 'bg-purple-400'}`}>\n                        CLASSE {currentUser?.classId}\n                    </span>\n                    <p className=\"text-red-600/80 text-sm\">\n                        Postulez uniquement dans les agences de votre classe.\n                    </p>\n                </div>\n            </div>\n\n            {/* FONDER UN STUDIO */}\n            <div className=\"bg-gradient-to-br from-indigo-900 to-slate-900 text-white p-6 rounded-2xl shadow-xl relative overflow-hidden\">\n                <div className=\"absolute top-0 right-0 p-10 opacity-10\">\n                    <Building2 size={120} />\n                </div>\n                <h4 className=\"font-bold text-xl mb-2 flex items-center gap-2\">\n                    <Building2 size={24} className=\"text-indigo-400\"/> Fonder mon propre Studio\n                </h4>\n                <p className=\"text-sm text-indigo-100 mb-6 max-w-md\">\n                    Vous avez l'âme d'un leader ? Lancez votre agence en solo ou recrutez ensuite d'autres talents du vivier.\n                </p>\n                <div className=\"grid grid-cols-2 gap-4 mb-6\">\n                    <div className=\"bg-white/10 p-3 rounded-xl border border-white/10\">\n                        <span className=\"text-[10px] font-bold uppercase text-indigo-300 block mb-1\">Coût Fondation</span>\n                        <div className=\"flex items-center gap-2 font-bold text-lg\">\n                            <Coins size={16} className=\"text-yellow-400\"/> {GAME_RULES.CREATION_COST_PIXI} PiXi\n                        </div>\n                    </div>\n                    <div className=\"bg-white/10 p-3 rounded-xl border border-white/10\">\n                        <span className=\"text-[10px] font-bold uppercase text-indigo-300 block mb-1\">Investissement Perso</span>\n                        <div className=\"flex items-center gap-2 font-bold text-lg text-red-400\">\n                            <TrendingUp size={16}/> -{GAME_RULES.CREATION_COST_SCORE} pts Score\n                        </div>\n                    </div>\n                </div>\n                <button \n                    onClick={() => onOpenApplyModal('new')}\n                    disabled={(currentUser?.wallet || 0) < GAME_RULES.CREATION_COST_PIXI}\n                    className={`w-full py-4 rounded-xl font-bold transition-all shadow-lg flex items-center justify-center gap-2 ${\n                        (currentUser?.wallet || 0) < GAME_RULES.CREATION_COST_PIXI \n                        ? 'bg-slate-700 text-slate-400 cursor-not-allowed' \n                        : 'bg-indigo-500 hover:bg-indigo-400 text-white'\n                    }`}\n                >\n                    <Plus size={20}/>\n                    {(currentUser?.wallet || 0) < GAME_RULES.CREATION_COST_PIXI ? 'Fonds insuffisants' : 'Fonder mon Studio'}\n                </button>\n            </div>\n\n            {/* MON CV */}\n            <div className=\"bg-white p-6 rounded-2xl border border-slate-200 shadow-sm\">\n                <div className=\"flex justify-between items-center mb-4\">\n                    <h4 className=\"font-bold text-slate-900\">Mon Dossier Professionnel</h4>\n                    {currentUser?.cvUrl && <span className=\"text-xs bg-emerald-100 text-emerald-700 px-2 py-1 rounded-full font-bold\">CV en ligne</span>}\n                </div>\n                \n                {currentUser?.cvUrl ? (\n                    <div className=\"flex items-center gap-4 p-4 bg-slate-50 rounded-xl border border-slate-200\">\n                            <FileText size={32} className=\"text-indigo-500\"/>\n                            <div className=\"flex-1 overflow-hidden\">\n                                <p className=\"font-bold text-slate-900 truncate\">CV_{currentUser.name.replace(' ', '_')}.pdf</p>\n                                <a href={currentUser.cvUrl} target=\"_blank\" className=\"text-xs text-indigo-600 hover:underline\">Voir le document</a>\n                            </div>\n                            <button onClick={onOpenCVModal} className=\"p-2 hover:bg-slate-200 rounded-lg text-slate-500\">\n                                <Upload size={18}/>\n                            </button>\n                    </div>\n                ) : (\n                    <button \n                        onClick={onOpenCVModal}\n                        className=\"w-full py-8 border-2 border-dashed border-slate-300 rounded-xl text-slate-400 hover:bg-slate-50 hover:border-indigo-400 hover:text-indigo-500 transition-all flex flex-col items-center gap-2\"\n                    >\n                        <Upload size={32}/>\n                        <span className=\"font-bold text-sm\">Déposer mon CV (PDF)</span>\n                    </button>\n                )}\n            </div>\n\n            {/* LISTE DES AGENCES */}\n            <div>\n                <h4 className=\"font-bold text-slate-900 mb-4 flex items-center gap-2\">\n                    <UserPlus size={20} className=\"text-emerald-500\"/> Offres d'Emploi (Classe {currentUser?.classId})\n                </h4>\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                    {availableAgencies.map(targetAgency => {\n                        const isPending = targetAgency.mercatoRequests.some(r => r.studentId === currentUser?.id && r.status === 'PENDING');\n                        \n                        return (\n                            <div key={targetAgency.id} className=\"bg-white p-5 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition-all\">\n                                <div className=\"flex justify-between items-start mb-2\">\n                                    <h5 className=\"font-bold text-slate-900\">{targetAgency.name}</h5>\n                                    <span className={`text-[10px] font-bold px-2 py-1 rounded ${targetAgency.status === 'stable' ? 'bg-emerald-100 text-emerald-700' : 'bg-amber-100 text-amber-700'}`}>\n                                        {targetAgency.status}\n                                    </span>\n                                </div>\n                                <p className=\"text-xs text-slate-500 mb-4 line-clamp-2 italic\">\"{targetAgency.tagline}\"</p>\n                                \n                                {isPending ? (\n                                    <button disabled className=\"w-full py-2 bg-slate-100 text-slate-400 font-bold rounded-lg text-xs cursor-not-allowed\">\n                                        Candidature envoyée\n                                    </button>\n                                ) : (\n                                    <button \n                                        onClick={() => onOpenApplyModal(targetAgency.id)}\n                                        className=\"w-full py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg text-xs transition-colors flex items-center justify-center gap-2\"\n                                    >\n                                        <Send size={14}/> Postuler\n                                    </button>\n                                )}\n                            </div>\n                        );\n                    })}\n                </div>\n            </div>\n        </div>\n    );\n};\n"
            }
          ]
        },
        {
          "path": "components/student/MercatoView.tsx",
          "generationType": 1,
          "isDone": true,
          "description": "Mise à jour du gestionnaire de requêtes pour inclure FOUND_AGENCY",
          "diffs": [
            {
              "target": "",
              "replacement": "\nimport React, { useState } from 'react';\nimport { Agency, Student, MercatoRequest, MergerRequest } from '../../types';\nimport { useUI } from '../../contexts/UIContext';\nimport { useGame } from '../../contexts/GameContext';\nimport { useAuth } from '../../contexts/AuthContext';\nimport { ref, uploadBytes, getDownloadURL } from 'firebase/storage';\nimport { storage } from '../../services/firebase';\nimport { GAME_RULES } from '../../constants';\nimport { Building2, ArrowRightLeft, Check, X } from 'lucide-react';\n\n// IMPORT SUB-COMPONENTS\nimport { CVModal, MotivationModal } from './mercato/MercatoModals';\nimport { UnemployedView } from './mercato/UnemployedView';\nimport { AgencyDemocracy } from './mercato/AgencyDemocracy';\nimport { TeamManagement } from './mercato/TeamManagement';\nimport { RecruitmentPool } from './mercato/RecruitmentPool';\n\ninterface MercatoViewProps {\n  agency: Agency;\n  allAgencies: Agency[];\n  onUpdateAgency: (agency: Agency) => void;\n  onUpdateAgencies: (agencies: Agency[]) => void;\n}\n\nexport const MercatoView: React.FC<MercatoViewProps> = ({ agency, allAgencies, onUpdateAgency, onUpdateAgencies }) => {\n  const { toast } = useUI();\n  const { submitMercatoVote, getCurrentGameWeek, proposeMerger, finalizeMerger } = useGame();\n  const { currentUser: authUser } = useAuth();\n  \n  const [isCVModalOpen, setIsCVModalOpen] = useState(false);\n  const [isMotivationModalOpen, setIsMotivationModalOpen] = useState(false);\n  const [showMergerModal, setShowMergerModal] = useState(false);\n  \n  // State for Actions\n  const [actionType, setActionType] = useState<'HIRE' | 'FIRE' | 'RESIGN' | 'FOUND'>('HIRE');\n  const [targetStudent, setTargetStudent] = useState<Student | null>(null);\n  const [targetAgencyId, setTargetAgencyId] = useState<string | null>(null);\n  const [motivationText, setMotivationText] = useState(\"\");\n\n  const [cvFile, setCvFile] = useState<File | null>(null);\n  const [isUploadingCV, setIsUploadingCV] = useState(false);\n\n  const currentUser = agency.members.find(m => m.id === authUser?.uid);\n\n  const availableAgencies = allAgencies.filter(a => a.id !== 'unassigned' && a.classId === currentUser?.classId);\n  const unemployedAgency = allAgencies.find(a => a.id === 'unassigned');\n\n  const currentWeek = getCurrentGameWeek();\n  const canMerge = currentWeek >= GAME_RULES.UNLOCK_WEEK_MERGERS;\n\n  const handleSubmitRequest = () => {\n      if(motivationText.length < 5) {\n          toast('error', 'La motivation doit faire au moins 5 caractères.');\n          return;\n      }\n\n      if (!currentUser) return;\n\n      const today = new Date().toISOString().split('T')[0];\n      let newRequest: MercatoRequest | null = null;\n\n      if (actionType === 'FOUND') {\n          newRequest = {\n            id: `req-found-${Date.now()}`, type: 'FOUND_AGENCY',\n            studentId: currentUser.id, studentName: currentUser.name,\n            requesterId: currentUser.id, targetAgencyId: 'new',\n            status: 'PENDING', date: today, motivation: motivationText,\n            votes: {} \n          };\n          if (unemployedAgency) {\n              const updatedUnassigned = { ...unemployedAgency, mercatoRequests: [...unemployedAgency.mercatoRequests, newRequest] };\n              onUpdateAgency(updatedUnassigned);\n              toast('success', \"Demande de fondation envoyée à l'enseignant !\");\n          }\n      } else if (actionType === 'HIRE' && targetStudent) {\n          newRequest = {\n            id: `req-${Date.now()}`, type: 'HIRE',\n            studentId: targetStudent.id, studentName: targetStudent.name,\n            requesterId: currentUser.id, targetAgencyId: agency.id,\n            status: 'PENDING', date: today, motivation: motivationText,\n            votes: { [currentUser.id]: 'APPROVE' } \n          };\n      } else if (actionType === 'FIRE' && targetStudent) {\n          newRequest = {\n            id: `req-${Date.now()}`, type: 'FIRE',\n            studentId: targetStudent.id, studentName: targetStudent.name,\n            requesterId: currentUser.id, targetAgencyId: agency.id,\n            status: 'PENDING', date: today, motivation: motivationText,\n            votes: { [currentUser.id]: 'APPROVE' } \n          };\n      } else if (actionType === 'RESIGN') {\n          newRequest = {\n            id: `req-${Date.now()}`, type: 'FIRE', \n            studentId: currentUser.id, studentName: currentUser.name,\n            requesterId: currentUser.id, targetAgencyId: agency.id,\n            status: 'PENDING', date: today, motivation: motivationText,\n            votes: {} \n          };\n      } else if (actionType === 'HIRE' && targetAgencyId) {\n          newRequest = {\n            id: `req-${Date.now()}`, type: 'HIRE',\n            studentId: currentUser.id, studentName: currentUser.name,\n            requesterId: currentUser.id, targetAgencyId: targetAgencyId,\n            status: 'PENDING', date: today, motivation: motivationText,\n            votes: {} \n          };\n          const targetAgency = allAgencies.find(a => a.id === targetAgencyId);\n          if (targetAgency) {\n              const updatedAgencies = allAgencies.map(a => \n                  a.id === targetAgencyId \n                  ? { ...a, mercatoRequests: [...a.mercatoRequests, newRequest!] } \n                  : a\n              );\n              onUpdateAgencies(updatedAgencies);\n              toast('success', \"Candidature envoyée !\");\n              setIsMotivationModalOpen(false);\n              return;\n          }\n      }\n\n      if (newRequest && agency.id !== 'unassigned' && actionType !== 'FOUND') {\n          onUpdateAgency({\n              ...agency,\n              mercatoRequests: [...agency.mercatoRequests, newRequest]\n          });\n          toast('success', 'Demande envoyée. Le vote est ouvert !');\n      }\n      setIsMotivationModalOpen(false);\n      setMotivationText(\"\");\n  };\n\n  const handleVote = async (request: MercatoRequest, vote: 'APPROVE' | 'REJECT') => {\n      if (!currentUser) return;\n      await submitMercatoVote(agency.id, request.id, currentUser.id, vote);\n  };\n\n  const openHireModal = (student: Student) => {\n      setActionType('HIRE');\n      setTargetStudent(student);\n      setMotivationText(\"\");\n      setIsMotivationModalOpen(true);\n  }\n\n  const openFireModal = (student: Student) => {\n      setActionType('FIRE');\n      setTargetStudent(student);\n      setMotivationText(\"\");\n      setIsMotivationModalOpen(true);\n  }\n\n  const openResignModal = () => {\n      setActionType('RESIGN');\n      setMotivationText(\"\");\n      setIsMotivationModalOpen(true);\n  }\n\n  const openApplyModal = (agencyId: string) => {\n      if (agencyId === 'new') {\n          setActionType('FOUND');\n          setTargetAgencyId(null);\n      } else {\n          setActionType('HIRE'); \n          setTargetAgencyId(agencyId);\n      }\n      setMotivationText(\"\");\n      setIsMotivationModalOpen(true);\n  }\n\n  const handleUploadCV = async () => {\n    if(!currentUser || !cvFile) return;\n    setIsUploadingCV(true);\n    try {\n        const storageRef = ref(storage, `resumes/${currentUser.id}_${cvFile.name}`);\n        await uploadBytes(storageRef, cvFile);\n        const downloadUrl = await getDownloadURL(storageRef);\n        const updatedMembers = agency.members.map(m => \n            m.id === currentUser.id ? { ...m, cvUrl: downloadUrl } : m\n        );\n        onUpdateAgency({ ...agency, members: updatedMembers });\n        setIsCVModalOpen(false);\n        setCvFile(null);\n        toast('success', \"CV mis à jour !\");\n    } catch (error) {\n        console.error(error);\n        toast('error', \"Erreur lors de l'upload du CV.\");\n    } finally {\n        setIsUploadingCV(false);\n    }\n  };\n\n  const handleProposeMerger = async (targetId: string) => {\n      await proposeMerger(agency.id, targetId);\n      setShowMergerModal(false);\n  };\n\n  const handleMergerResponse = async (req: MergerRequest, approved: boolean) => {\n      await finalizeMerger(req.id, agency.id, approved);\n  };\n\n  if (agency.id === 'unassigned') {\n      return (\n          <>\n            <UnemployedView \n                currentUser={currentUser}\n                availableAgencies={availableAgencies}\n                onOpenCVModal={() => setIsCVModalOpen(true)}\n                onOpenApplyModal={openApplyModal}\n            />\n            <CVModal \n                isOpen={isCVModalOpen} \n                onClose={() => setIsCVModalOpen(false)} \n                cvFile={cvFile} \n                setCvFile={setCvFile} \n                handleUploadCV={handleUploadCV} \n                isUploadingCV={isUploadingCV} \n            />\n            <MotivationModal \n                isOpen={isMotivationModalOpen} \n                onClose={() => setIsMotivationModalOpen(false)} \n                onSubmit={handleSubmitRequest} \n                motivation={motivationText} \n                setMotivation={setMotivationText} \n                title={actionType === 'FOUND' ? \"Nom & Vision du Studio\" : \"Pourquoi vous ?\"} \n                subtitle={actionType === 'FOUND' ? \"Décrivez brièvement votre projet de studio.\" : \"Expliquez à l'agence pourquoi elle devrait vous recruter.\"}\n            />\n          </>\n      );\n  }\n\n  const potentialTargets = allAgencies.filter(a => a.id !== 'unassigned' && a.id !== agency.id && a.ve_current < GAME_RULES.MERGER_VE_THRESHOLD && a.classId === agency.classId);\n\n  return (\n    <div className=\"animate-in fade-in space-y-8\">\n        {agency.mergerRequests && agency.mergerRequests.length > 0 && (\n            <div className=\"bg-slate-900 text-white p-6 rounded-2xl shadow-xl border border-indigo-500 relative overflow-hidden\">\n                <div className=\"relative z-10\">\n                    <h3 className=\"font-bold text-lg mb-2 flex items-center gap-2\"><Building2 className=\"text-emerald-400\"/> Offre de Rachat Reçue !</h3>\n                    <div className=\"space-y-3\">\n                        {agency.mergerRequests.map(req => (\n                            <div key={req.id} className=\"bg-white/10 p-4 rounded-xl border border-white/20\">\n                                <p className=\"font-bold text-lg mb-1\">{req.requesterAgencyName} veut vous absorber.</p>\n                                <p className=\"text-sm italic opacity-80 mb-4\">\"{req.offerDetails}\"</p>\n                                <div className=\"flex gap-4\">\n                                    <button onClick={() => handleMergerResponse(req, true)} className=\"bg-emerald-500 hover:bg-emerald-600 px-4 py-2 rounded-lg font-bold text-sm flex items-center gap-2\">\n                                        <Check size={16}/> Accepter (Fusion)\n                                    </button>\n                                    <button onClick={() => handleMergerResponse(req, false)} className=\"bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg font-bold text-sm flex items-center gap-2\">\n                                        <X size={16}/> Refuser\n                                    </button>\n                                </div>\n                            </div>\n                        ))}\n                    </div>\n                </div>\n            </div>\n        )}\n\n        <AgencyDemocracy \n            agency={agency} \n            currentUser={currentUser} \n            onVote={handleVote} \n        />\n\n        <TeamManagement \n            agency={agency}\n            currentUser={currentUser}\n            onOpenResignModal={openResignModal}\n            onOpenFireModal={openFireModal}\n        />\n\n        <RecruitmentPool \n            agency={agency}\n            unemployedStudents={unassignedAgency?.members || []}\n            onOpenHireModal={openHireModal}\n        />\n\n        {canMerge && (\n            <div className=\"mt-8 pt-8 border-t border-slate-200\">\n                <div className=\"flex justify-between items-center mb-4\">\n                     <h3 className=\"font-bold text-slate-900 flex items-center gap-2\">\n                        <Building2 size={20} className=\"text-indigo-600\"/> Fusions & Acquisitions (M&A)\n                    </h3>\n                </div>\n\n                <div className=\"bg-indigo-50 border border-indigo-100 p-6 rounded-2xl\">\n                    <p className=\"text-sm text-indigo-800 mb-4\">\n                        Vous pouvez proposer de racheter une agence en difficulté (VE &lt; {GAME_RULES.MERGER_VE_THRESHOLD}). \n                        <br/><strong>Condition :</strong> Vous absorbez leurs membres (Max {GAME_RULES.MERGER_MAX_MEMBERS} total) et leurs dettes.\n                    </p>\n                    \n                    {potentialTargets.length > 0 ? (\n                        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                            {potentialTargets.map(target => (\n                                <div key={target.id} className=\"bg-white p-4 rounded-xl border border-indigo-100 flex justify-between items-center\">\n                                    <div>\n                                        <h4 className=\"font-bold text-slate-900\">{target.name}</h4>\n                                        <div className=\"flex gap-2 text-xs mt-1\">\n                                            <span className=\"text-red-500 font-bold\">VE: {target.ve_current}</span>\n                                            <span className=\"text-slate-500\">{target.members.length} membres</span>\n                                        </div>\n                                    </div>\n                                    <button \n                                        onClick={() => handleProposeMerger(target.id)}\n                                        className=\"bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-2 rounded-lg text-xs font-bold transition-colors\"\n                                    >\n                                        Proposer Rachat\n                                    </button>\n                                </div>\n                            ))}\n                        </div>\n                    ) : (\n                        <div className=\"text-center py-4 text-slate-400 text-sm italic\">\n                            Aucune cible potentielle (VE &lt; 40) disponible sur le marché.\n                        </div>\n                    )}\n                </div>\n            </div>\n        )}\n\n        <MotivationModal \n            isOpen={isMotivationModalOpen} \n            onClose={() => setIsMotivationModalOpen(false)} \n            onSubmit={handleSubmitRequest} \n            motivation={motivationText} \n            setMotivation={setMotivationText} \n            title={actionType === 'FIRE' ? \"Motif du renvoi\" : actionType === 'RESIGN' ? \"Motif de départ\" : actionType === 'FOUND' ? \"Fondation de Studio\" : \"Proposition d'embauche\"}\n            subtitle={actionType === 'FIRE' ? \"Expliquez pourquoi vous souhaitez vous séparer de ce collaborateur (Vote requis 75%).\" : actionType === 'RESIGN' ? \"Pourquoi quittez-vous le navire ?\" : actionType === 'FOUND' ? \"Donnez un nom provisoire et votre vision.\" : \"Message pour l'équipe (Vote requis 66%).\"}\n        />\n        \n        <CVModal \n            isOpen={isCVModalOpen} \n            onClose={() => setIsCVModalOpen(false)} \n            cvFile={cvFile} \n            setCvFile={setCvFile} \n            handleUploadCV={handleUploadCV} \n            isUploadingCV={isUploadingCV} \n        />\n    </div>\n  );\n};\n"
            }
          ]
        },
        {
          "path": "components/StudentAgencyView.tsx",
          "generationType": 1,
          "isDone": true,
          "description": "Amélioration de la visibilité du solde de l'entreprise pour les étudiants",
          "diffs": [
            {
              "target": "",
              "replacement": "\nimport React, { useState, useEffect } from 'react';\nimport { Agency, BrandColor, Student, GameEvent } from '../types';\nimport { Target, Users, History, Wallet, TrendingUp, HelpCircle, Briefcase, Settings, Image as ImageIcon, Shield, Eye, Crown, BookOpen, Send, Repeat, ArrowUpRight, Building2, Zap, AlertTriangle, PartyPopper, Gavel, Landmark, Landmark as Bank } from 'lucide-react';\nimport { MarketOverview } from './student/MarketOverview';\nimport { MissionsView } from './student/MissionsView';\nimport { TeamView } from './student/TeamView';\nimport { HistoryView } from './student/HistoryView';\nimport { MercatoView } from './student/MercatoView';\nimport { WikiView } from './student/WikiView';\nimport { Modal } from './Modal';\nimport { GAME_RULES, BADGE_DEFINITIONS } from '../constants';\nimport { ref, uploadBytes, getDownloadURL } from 'firebase/storage';\nimport { storage } from '../services/firebase';\nimport { useUI } from '../contexts/UIContext';\nimport { useAuth } from '../contexts/AuthContext';\nimport { useGame } from '../contexts/GameContext';\n\ninterface StudentViewProps {\n  agency: Agency;\n  allAgencies: Agency[];\n  onUpdateAgency: (agency: Agency) => void;\n}\n\ntype TabType = 'MARKET' | 'MISSIONS' | 'TEAM' | 'RECRUITMENT' | 'HISTORY' | 'RESOURCES' | 'WALLET';\n\nconst COLOR_THEMES: Record<BrandColor, { bg: string, text: string }> = {\n    indigo: { bg: 'bg-indigo-600', text: 'text-indigo-600' },\n    emerald: { bg: 'bg-emerald-600', text: 'text-emerald-600' },\n    rose: { bg: 'bg-rose-600', text: 'text-rose-600' },\n    amber: { bg: 'bg-amber-500', text: 'text-amber-500' },\n    cyan: { bg: 'bg-cyan-500', text: 'text-cyan-500' },\n    slate: { bg: 'bg-slate-600', text: 'text-slate-600' },\n};\n\nexport const StudentAgencyView: React.FC<StudentViewProps> = ({ agency, allAgencies, onUpdateAgency }) => {\n  const { toast } = useUI();\n  const { currentUser } = useAuth();\n  const { transferFunds, injectCapital, requestScorePurchase, getCurrentGameWeek } = useGame();\n  \n  const [activeTab, setActiveTab] = useState<TabType>('MARKET');\n  const [showVERules, setShowVERules] = useState(false);\n  const [showSettings, setShowSettings] = useState(false);\n  \n  const [unlockModal, setUnlockModal] = useState<{title: string, message: string, icon: any, confirmText: string} | null>(null);\n  const [notificationEvent, setNotificationEvent] = useState<GameEvent | null>(null);\n\n  const brandColor = agency.branding?.color || 'indigo';\n  const theme = COLOR_THEMES[brandColor];\n  const leaderboard = [...allAgencies].filter(a => a.id !== 'unassigned').sort((a, b) => b.ve_current - a.ve_current);\n  const myRank = leaderboard.findIndex(a => a.id === agency.id) + 1;\n  const rawSalary = agency.members.reduce((acc, member) => acc + (member.individualScore * GAME_RULES.SALARY_MULTIPLIER), 0);\n  const weeklyCharges = rawSalary * (1 + (agency.weeklyTax || 0)) + GAME_RULES.AGENCY_RENT;\n  const veRevenue = agency.ve_current * GAME_RULES.REVENUE_VE_MULTIPLIER;\n  const weeklyRevenue = GAME_RULES.REVENUE_BASE + veRevenue + (agency.weeklyRevenueModifier || 0);\n  const netWeekly = weeklyRevenue - weeklyCharges;\n  const myMemberProfile = agency.members.find(m => m.id === currentUser?.uid);\n\n  useEffect(() => {\n      const currentWeek = getCurrentGameWeek();\n      if (currentWeek >= GAME_RULES.UNLOCK_WEEK_BLACK_OPS) {\n          const hasSeenBlackOps = localStorage.getItem(`seen_unlock_blackops_${currentUser?.uid}`);\n          if (!hasSeenBlackOps) {\n              setUnlockModal({\n                  title: \"Intelligence Économique Activée\",\n                  message: \"Le marché se durcit. Vous avez désormais accès aux outils de veille stratégique.\\n\\nNouveauté : Audits concurrentiels et achat d'informations disponibles dans l'onglet 'Marché'.\",\n                  icon: <Eye size={32} className=\"text-yellow-500\"/>,\n                  confirmText: \"Compris, je reste vigilant\"\n              });\n              localStorage.setItem(`seen_unlock_blackops_${currentUser?.uid}`, 'true');\n              return; \n          }\n      }\n      if (currentWeek >= GAME_RULES.UNLOCK_WEEK_MERGERS) {\n          const hasSeenMergers = localStorage.getItem(`seen_unlock_mergers_${currentUser?.uid}`);\n          if (!hasSeenMergers) {\n              setUnlockModal({\n                  title: \"Fusions & Acquisitions (M&A)\",\n                  message: \"La consolidation du secteur commence. \\n\\nNouveauté : Il est désormais possible de racheter une agence en faillite (VE < 40) pour absorber ses talents et sa dette.\",\n                  icon: <Building2 size={32} className=\"text-indigo-500\"/>,\n                  confirmText: \"Voir les opportunités\"\n              });\n              localStorage.setItem(`seen_unlock_mergers_${currentUser?.uid}`, 'true');\n          }\n      }\n  }, [getCurrentGameWeek, currentUser]);\n\n  useEffect(() => {\n      if (agency.eventLog.length === 0) return;\n      const latestEvent = agency.eventLog[agency.eventLog.length - 1];\n      const NOTIFY_TYPES = ['CRISIS', 'VE_DELTA'];\n      if (NOTIFY_TYPES.includes(latestEvent.type)) {\n          const seenKey = `seen_event_${currentUser?.uid}_${latestEvent.id}`;\n          const hasSeen = localStorage.getItem(seenKey);\n          if (!hasSeen) setNotificationEvent(latestEvent);\n      }\n  }, [agency.eventLog, currentUser]);\n\n  const closeNotification = () => {\n      if (notificationEvent) {\n          localStorage.setItem(`seen_event_${currentUser?.uid}_${notificationEvent.id}`, 'true');\n          setNotificationEvent(null);\n      }\n  };\n\n  const handleColorChange = (color: BrandColor) => {\n      onUpdateAgency({ ...agency, branding: { ...agency.branding, color } });\n  };\n\n  const handleBannerUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {\n      if (e.target.files && e.target.files[0]) {\n          try {\n              const storageRef = ref(storage, `banners/${agency.id}_${Date.now()}`);\n              await uploadBytes(storageRef, e.target.files[0]);\n              const url = await getDownloadURL(storageRef);\n              onUpdateAgency({ ...agency, branding: { ...agency.branding, bannerUrl: url } });\n              toast('success', 'Bannière mise à jour');\n          } catch (error) { toast('error', \"Erreur d'upload\"); }\n      }\n  };\n\n  return (\n    <div className=\"flex flex-col min-h-[calc(100vh-6rem)] font-sans\">\n        {/* HEADER */}\n        <div className=\"relative mb-8 rounded-b-3xl md:rounded-3xl overflow-hidden bg-slate-100 min-h-[200px] md:min-h-[240px] shadow-md group\">\n            {agency.branding?.bannerUrl ? (\n                <img src={agency.branding.bannerUrl} className=\"absolute inset-0 w-full h-full object-cover\" alt=\"Banner\" />\n            ) : (\n                <div className={`absolute inset-0 opacity-10 ${theme.bg}`} style={{backgroundImage: 'radial-gradient(circle, #000 1px, transparent 1px)', backgroundSize: '20px 20px'}}></div>\n            )}\n            <div className=\"absolute inset-0 bg-gradient-to-t from-slate-900/90 via-slate-900/40 to-transparent\"></div>\n            {agency.id !== 'unassigned' && (\n                <button onClick={() => setShowSettings(true)} className=\"absolute top-4 right-4 p-2 bg-black/30 backdrop-blur-md rounded-full text-white hover:bg-black/50 transition-all opacity-0 group-hover:opacity-100 border border-white/10\">\n                    <Settings size={20}/>\n                </button>\n            )}\n            <div className=\"absolute bottom-0 left-0 right-0 p-6 flex flex-col xl:flex-row justify-between items-end xl:items-end gap-6 text-white\">\n                <div className=\"w-full xl:w-auto\">\n                    <div className=\"flex items-center gap-3 mb-1\">\n                        {agency.id !== 'unassigned' && <span className=\"bg-white/20 backdrop-blur border border-white/10 px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider\">Rang #{myRank}</span>}\n                        <span className=\"text-slate-300 italic text-sm truncate\">\"{agency.tagline}\"</span>\n                    </div>\n                    <h2 className=\"text-4xl md:text-5xl font-display font-bold tracking-tight drop-shadow-lg leading-none mb-3\">{agency.name}</h2>\n                    <div className=\"flex items-center gap-1\">\n                        {agency.badges && agency.badges.map(b => (\n                            <div key={b.id} title={b.label} className=\"w-6 h-6 rounded-full bg-yellow-400 text-yellow-900 flex items-center justify-center shadow-lg border border-yellow-200\"><Shield size={12}/></div>\n                        ))}\n                    </div>\n                </div>\n\n                {agency.id !== 'unassigned' && (\n                <div className=\"flex flex-col md:flex-row gap-4 w-full xl:w-auto bg-black/40 backdrop-blur-md p-4 rounded-2xl border border-white/10\">\n                    {myMemberProfile && (\n                        <div onClick={() => setActiveTab('WALLET')} className=\"flex-1 md:text-right md:border-r border-white/20 md:pr-4 cursor-pointer group hover:bg-white/10 rounded-lg p-1 transition-colors\">\n                            <span className=\"text-[10px] font-bold text-yellow-300 uppercase tracking-widest block mb-1 group-hover:underline flex items-center gap-1 md:justify-end\">\n                                <Wallet size={12}/> Mon Solde\n                            </span>\n                            <div className=\"text-lg font-bold text-white flex items-center md:justify-end gap-2\">\n                                <span className=\"text-yellow-400 font-mono\">{myMemberProfile.wallet || 0} PiXi</span>\n                            </div>\n                        </div>\n                    )}\n                    \n                    <div className=\"flex-1 md:text-right md:border-r border-white/20 md:pr-4\">\n                        <span className=\"text-[10px] font-bold text-indigo-300 uppercase tracking-widest block mb-1 flex items-center gap-1 md:justify-end\">\n                            <Landmark size={12}/> Trésorerie Studio\n                        </span>\n                        <div className=\"text-lg font-bold text-white flex items-center md:justify-end gap-2\">\n                            <span className={`font-mono ${agency.budget_real < 0 ? 'text-red-400' : 'text-white'}`}>{agency.budget_real} PiXi</span>\n                        </div>\n                    </div>\n\n                    <div className=\"flex items-center justify-between md:justify-start gap-6 pl-2\">\n                        <div className=\"text-center\">\n                            <span className=\"text-[10px] font-bold text-slate-300 uppercase tracking-widest block mb-1\">Flux Net</span>\n                            <div className={`text-xl font-bold ${netWeekly >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>{netWeekly > 0 ? '+' : ''}{netWeekly.toFixed(0)}</div>\n                        </div>\n                        <div className=\"text-center\">\n                            <div \n                                onClick={() => setShowVERules(true)}\n                                className=\"text-[10px] font-bold text-slate-300 uppercase tracking-widest mb-1 flex items-center gap-1 justify-center cursor-pointer hover:text-white\"\n                            >\n                                VE <HelpCircle size={10}/>\n                            </div>\n                            <div className={`text-3xl font-display font-bold leading-none ${agency.ve_current >= 60 ? 'text-emerald-400' : 'text-amber-400'}`}>{agency.ve_current}</div>\n                        </div>\n                    </div>\n                </div>\n                )}\n            </div>\n        </div>\n\n        {/* CONTENT */}\n        <div className=\"flex-1 mb-24 md:mb-8\">\n            {activeTab === 'MARKET' && agency.id !== 'unassigned' && <MarketOverview agency={agency} allAgencies={allAgencies} />}\n            {activeTab === 'MISSIONS' && agency.id !== 'unassigned' && <MissionsView agency={agency} onUpdateAgency={onUpdateAgency} />}\n            {activeTab === 'TEAM' && agency.id !== 'unassigned' && <TeamView agency={agency} onUpdateAgency={onUpdateAgency} />}\n            {activeTab === 'WALLET' && myMemberProfile && agency.id !== 'unassigned' && (\n                <WalletView \n                    student={myMemberProfile} \n                    agency={agency} \n                    allStudents={allAgencies.flatMap(a => a.members)}\n                    onTransfer={transferFunds}\n                    onInjectCapital={injectCapital}\n                    onRequestScore={requestScorePurchase}\n                />\n            )}\n            {(activeTab === 'RECRUITMENT' || agency.id === 'unassigned') && <MercatoView agency={agency} allAgencies={allAgencies} onUpdateAgency={onUpdateAgency} onUpdateAgencies={() => {}} />}\n            {activeTab === 'RESOURCES' && <WikiView agency={agency} />}\n            {activeTab === 'HISTORY' && <HistoryView agency={agency} />}\n        </div>\n\n        {/* FOOTER NAV */}\n        <div className=\"fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-md border-t border-slate-200 p-2 z-50 md:relative md:bg-transparent md:border-t-0 md:p-0 md:mt-auto safe-area-bottom\">\n             <div className=\"max-w-7xl mx-auto flex md:justify-start gap-2 md:gap-4 overflow-x-auto no-scrollbar snap-x justify-between\">\n                {agency.id !== 'unassigned' && (\n                    <>\n                        <NavButton active={activeTab === 'MARKET'} onClick={() => setActiveTab('MARKET')} icon={<TrendingUp size={20} />} label=\"Marché\" theme={theme} />\n                        <NavButton active={activeTab === 'MISSIONS'} onClick={() => setActiveTab('MISSIONS')} icon={<Target size={20} />} label=\"Missions\" theme={theme} />\n                        <NavButton active={activeTab === 'TEAM'} onClick={() => setActiveTab('TEAM')} icon={<Users size={20} />} label=\"Équipe\" theme={theme} />\n                        <NavButton active={activeTab === 'WALLET'} onClick={() => setActiveTab('WALLET')} icon={<Wallet size={20} />} label=\"Banque\" theme={theme} />\n                    </>\n                )}\n                <NavButton active={activeTab === 'RESOURCES'} onClick={() => setActiveTab('RESOURCES')} icon={<BookOpen size={20} />} label=\"Wiki\" theme={theme} />\n                <NavButton active={activeTab === 'RECRUITMENT' || agency.id === 'unassigned'} onClick={() => setActiveTab('RECRUITMENT')} icon={<Briefcase size={20} />} label={agency.id === 'unassigned' ? \"Mon Statut\" : \"Recrutement\"} theme={theme} />\n                <NavButton active={activeTab === 'HISTORY'} onClick={() => setActiveTab('HISTORY')} icon={<History size={20} />} label=\"Journal\" theme={theme} />\n             </div>\n        </div>\n\n        {/* MODALS */}\n        <Modal isOpen={showSettings} onClose={() => setShowSettings(false)} title=\"Personnalisation Agence\">\n            <div className=\"space-y-6\">\n                <div>\n                    <label className=\"block text-sm font-bold text-slate-700 mb-2\">Couleur de Marque</label>\n                    <div className=\"flex gap-3\">\n                        {(['indigo', 'emerald', 'rose', 'amber', 'cyan'] as BrandColor[]).map(c => (\n                            <button key={c} onClick={() => handleColorChange(c)} className={`w-10 h-10 rounded-full border-2 ${COLOR_THEMES[c].bg} ${brandColor === c ? 'ring-4 ring-offset-2 ring-slate-200 border-white' : 'border-transparent opacity-60 hover:opacity-100'}`} />\n                        ))}\n                    </div>\n                </div>\n                <div>\n                    <label className=\"block text-sm font-bold text-slate-700 mb-2\">Bannière (Cover)</label>\n                    <label className=\"flex flex-col items-center justify-center w-full h-32 border-2 border-slate-300 border-dashed rounded-xl cursor-pointer bg-slate-50 hover:bg-slate-100 transition-colors\">\n                        <div className=\"flex flex-col items-center justify-center pt-5 pb-6\">\n                            <ImageIcon className=\"w-8 h-8 text-slate-400 mb-2\" />\n                            <p className=\"text-sm text-slate-500\">Cliquez pour changer</p>\n                        </div>\n                        <input type=\"file\" className=\"hidden\" accept=\"image/*\" onChange={handleBannerUpload} />\n                    </label>\n                </div>\n            </div>\n        </Modal>\n        \n        <Modal isOpen={showVERules} onClose={() => setShowVERules(false)} title=\"Comprendre la VE\">\n            <div className=\"space-y-6\">\n                <div className=\"bg-slate-50 p-4 rounded-2xl border border-slate-100\">\n                    <p className=\"text-sm text-slate-600 leading-relaxed mb-2\">\n                        La <strong>Valeur d'Entreprise (VE)</strong> est votre \"note de groupe\" dynamique (/100). \n                        <br/>Elle fluctue selon vos rendus, vos choix et les événements.\n                    </p>\n                </div>\n            </div>\n        </Modal>\n\n        {unlockModal && (\n            <Modal isOpen={!!unlockModal} onClose={() => setUnlockModal(null)} title={unlockModal.title}>\n                <div className=\"flex flex-col items-center text-center space-y-6\">\n                    <div className=\"p-6 rounded-full bg-slate-100 mb-2\">\n                        {unlockModal.icon}\n                    </div>\n                    <p className=\"text-slate-600 text-lg leading-relaxed whitespace-pre-line\">\n                        {unlockModal.message}\n                    </p>\n                    <button \n                        onClick={() => setUnlockModal(null)}\n                        className=\"w-full py-4 bg-slate-900 text-white font-bold rounded-xl hover:bg-indigo-600 transition-colors shadow-lg\"\n                    >\n                        {unlockModal.confirmText}\n                    </button>\n                </div>\n            </Modal>\n        )}\n\n        {notificationEvent && (\n            <Modal isOpen={!!notificationEvent} onClose={closeNotification} title={notificationEvent.type === 'CRISIS' ? \"ALERTE PRIORITAIRE\" : \"NOUVELLE IMPORTANTE\"}>\n                <div className=\"flex flex-col items-center text-center space-y-6\">\n                    <div className={`p-6 rounded-full mb-2 border-4 ${\n                        notificationEvent.type === 'CRISIS' || (notificationEvent.deltaVE || 0) < 0\n                        ? 'bg-red-50 border-red-100 text-red-600 animate-pulse'\n                        : 'bg-emerald-50 border-emerald-100 text-emerald-600'\n                    }`}>\n                        {notificationEvent.type === 'CRISIS' || (notificationEvent.deltaVE || 0) < 0\n                            ? <AlertTriangle size={48} strokeWidth={2.5}/>\n                            : (notificationEvent.deltaVE || 0) > 5 ? <PartyPopper size={48} strokeWidth={2.5}/> : <Zap size={48} strokeWidth={2.5}/>\n                        }\n                    </div>\n\n                    <div>\n                        <h3 className={`text-2xl font-black uppercase mb-2 ${\n                            notificationEvent.type === 'CRISIS' || (notificationEvent.deltaVE || 0) < 0 ? 'text-red-600' : 'text-emerald-600'\n                        }`}>\n                            {notificationEvent.label}\n                        </h3>\n                        <p className=\"text-slate-600 text-lg leading-relaxed font-medium\">\n                            {notificationEvent.description}\n                        </p>\n                    </div>\n\n                    <button \n                        onClick={closeNotification}\n                        className={`w-full py-4 text-white font-bold rounded-xl shadow-lg transition-transform active:scale-95 ${\n                            notificationEvent.type === 'CRISIS' || (notificationEvent.deltaVE || 0) < 0\n                            ? 'bg-red-600 hover:bg-red-700 shadow-red-200'\n                            : 'bg-emerald-600 hover:bg-emerald-700 shadow-emerald-200'\n                        }`}\n                    >\n                        {notificationEvent.type === 'CRISIS' ? \"J'AI PRIS CONNAISSANCE\" : \"GÉNIAL !\"}\n                    </button>\n                </div>\n            </Modal>\n        )}\n    </div>\n  );\n};\n\nconst WalletView: React.FC<{student: Student, agency: Agency, allStudents: Student[], onTransfer: any, onInjectCapital: any, onRequestScore: any}> = ({student, agency, allStudents, onTransfer, onInjectCapital, onRequestScore}) => {\n    const [targetId, setTargetId] = useState('');\n    const [amount, setAmount] = useState(0);\n    const [scoreToBuy, setScoreToBuy] = useState(0);\n\n    const handleTransfer = async () => {\n        if(!targetId || amount <= 0) return;\n        await onTransfer(student.id, targetId, amount);\n        setAmount(0);\n    };\n\n    const handleInject = async () => {\n        if(amount <= 0) return;\n        await onInjectCapital(student.id, agency.id, amount);\n        setAmount(0);\n    };\n\n    const handleBuyScore = async () => {\n        if(scoreToBuy <= 0) return;\n        const cost = scoreToBuy * 200;\n        await onRequestScore(student.id, agency.id, cost, scoreToBuy);\n        setScoreToBuy(0);\n    };\n\n    return (\n        <div className=\"animate-in fade-in space-y-6\">\n            {/* AGENCY TREASURY CARD - VERY VISIBLE NOW */}\n            <div className=\"bg-slate-900 rounded-3xl p-6 border border-slate-700 shadow-xl flex flex-col md:flex-row justify-between items-center gap-6\">\n                <div className=\"flex items-center gap-4\">\n                    <div className=\"p-4 bg-indigo-500/20 rounded-2xl text-indigo-400 border border-indigo-500/30\">\n                        <Bank size={32}/>\n                    </div>\n                    <div>\n                        <p className=\"text-indigo-300 text-xs font-bold uppercase tracking-widest\">Trésorerie de l'Entreprise</p>\n                        <p className=\"text-3xl font-display font-bold text-white\">{agency.budget_real} <span className=\"text-sm text-slate-500\">PiXi</span></p>\n                    </div>\n                </div>\n                <div className=\"flex flex-col items-center md:items-end\">\n                    <p className=\"text-slate-500 text-xs uppercase font-bold mb-1\">Santé Financière</p>\n                    <div className={`px-4 py-1.5 rounded-full text-xs font-bold border ${\n                        agency.budget_real > 1000 ? 'bg-emerald-500/10 text-emerald-400 border-emerald-500/20' : \n                        agency.budget_real > 0 ? 'bg-amber-500/10 text-amber-400 border-amber-500/20' : \n                        'bg-red-500/10 text-red-400 border-red-500/20 animate-pulse'\n                    }`}>\n                        {agency.budget_real > 1000 ? 'SOLVABLE' : agency.budget_real > 0 ? 'FRAGILE' : 'ENDETTÉ'}\n                    </div>\n                </div>\n            </div>\n\n            <div className=\"bg-indigo-600 text-white p-8 rounded-3xl shadow-lg flex flex-col md:flex-row justify-between items-center relative overflow-hidden\">\n                <div className=\"absolute top-0 right-0 p-20 bg-white/5 rounded-full blur-3xl transform translate-x-10 -translate-y-10\"></div>\n                <div className=\"relative z-10 text-center md:text-left mb-4 md:mb-0\">\n                    <p className=\"text-indigo-200 text-sm font-bold uppercase mb-1 tracking-widest\">Mon Solde Personnel</p>\n                    <p className=\"text-5xl font-display font-bold text-yellow-400\">{student?.wallet || 0} <span className=\"text-2xl text-yellow-200\">PiXi</span></p>\n                </div>\n                <div className=\"relative z-10 bg-white/10 p-4 rounded-xl backdrop-blur-sm border border-white/20\">\n                    <p className=\"text-xs text-indigo-100 mb-1\">Salaire Hebdo</p>\n                    <p className=\"font-bold text-white text-lg\">+{student.individualScore * GAME_RULES.SALARY_MULTIPLIER} PiXi</p>\n                </div>\n            </div>\n\n            <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n                <div className=\"bg-white p-6 rounded-2xl border border-slate-200 shadow-sm flex flex-col\">\n                    <div className=\"mb-4\">\n                        <div className=\"w-12 h-12 bg-emerald-100 rounded-full flex items-center justify-center text-emerald-600 mb-3\">\n                            <ArrowUpRight size={24}/>\n                        </div>\n                        <h3 className=\"font-bold text-slate-900 text-lg\">Investir dans mon Agence</h3>\n                        <p className=\"text-sm text-slate-500 mt-1\">Injection de fonds personnels.</p>\n                    </div>\n                    <div className=\"mt-auto space-y-3\">\n                        <input type=\"number\" className=\"w-full p-3 rounded-xl border border-slate-200 font-bold bg-slate-50\" placeholder=\"Montant\" onChange={e => setAmount(Number(e.target.value))} />\n                        <button onClick={handleInject} disabled={amount <= 0 || amount > (student.wallet || 0)} className=\"w-full py-3 bg-emerald-600 text-white font-bold rounded-xl hover:bg-emerald-700 transition-colors disabled:opacity-50\">Injecter</button>\n                    </div>\n                </div>\n\n                <div className=\"bg-white p-6 rounded-2xl border border-slate-200 shadow-sm flex flex-col\">\n                    <div className=\"mb-4\">\n                        <div className=\"w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center text-indigo-600 mb-3\">\n                            <Send size={24}/>\n                        </div>\n                        <h3 className=\"font-bold text-slate-900 text-lg\">Virement à un collègue</h3>\n                        <p className=\"text-sm text-slate-500 mt-1\">Soutien inter-agences.</p>\n                    </div>\n                    <div className=\"mt-auto space-y-3\">\n                        <select className=\"w-full p-3 rounded-xl border border-slate-200 bg-white text-sm\" onChange={e => setTargetId(e.target.value)} value={targetId}>\n                            <option value=\"\">-- Bénéficiaire --</option>\n                            {allStudents.filter(s => s.id !== student.id).map(s => (\n                                <option key={s.id} value={s.id}>{s.name}</option>\n                            ))}\n                        </select>\n                        <input type=\"number\" className=\"w-full p-3 rounded-xl border border-slate-200 font-bold bg-slate-50\" placeholder=\"Montant\" onChange={e => setAmount(Number(e.target.value))} />\n                        <button onClick={handleTransfer} disabled={amount <= 0 || amount > (student.wallet || 0)} className=\"w-full py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 transition-colors disabled:opacity-50\">Envoyer</button>\n                    </div>\n                </div>\n\n                <div className=\"bg-white p-6 rounded-2xl border border-slate-200 shadow-sm flex flex-col\">\n                    <div className=\"mb-4\">\n                        <div className=\"w-12 h-12 bg-amber-100 rounded-full flex items-center justify-center text-amber-600 mb-3\">\n                            <TrendingUp size={24}/>\n                        </div>\n                        <h3 className=\"font-bold text-slate-900 text-lg\">Achat Score (Formation)</h3>\n                        <p className=\"text-sm text-slate-500 mt-1\">200 PiXi = 1 Point Score.</p>\n                    </div>\n                    <div className=\"mt-auto space-y-3\">\n                        <input type=\"number\" className=\"w-full p-3 rounded-xl border border-slate-200 font-bold bg-slate-50\" placeholder=\"Points voulus\" onChange={e => setScoreToBuy(Number(e.target.value))} />\n                        <button onClick={handleBuyScore} disabled={scoreToBuy <= 0 || (scoreToBuy * 200) > (student.wallet || 0)} className=\"w-full py-3 bg-amber-500 text-white font-bold rounded-xl hover:bg-amber-600 transition-colors disabled:opacity-50\">Acheter</button>\n                    </div>\n                </div>\n            </div>\n        </div>\n    );\n};\n\nconst NavButton: React.FC<any> = ({ active, onClick, icon, label, theme }) => (\n    <button onClick={onClick} className={`snap-start flex flex-col md:flex-row items-center md:gap-3 p-2 md:p-4 rounded-xl transition-all min-w-[70px] md:min-w-[150px] justify-center md:justify-start ${active ? `${theme.bg} text-white transform scale-105 shadow-md` : 'hover:bg-slate-50 text-slate-400 hover:text-slate-600'}`}>\n        <div className={`p-1.5 rounded-full ${active ? 'bg-white/20' : ''}`}>{React.cloneElement(icon, { className: active ? 'text-white' : '' })}</div>\n        <span className={`text-[10px] md:text-base font-bold`}>{label}</span>\n    </button>\n);\n"
            }
          ]
        }
      ]
    },
    "createdTimestamp": {
      "seconds": 1767801369,
      "nanos": 862000000
    },
    "doneTimestamp": {
      "seconds": 1767801377,
      "nanos": 290000000
    }
  },
  {
    "id": 4,
    "author": "model",
    "payload": {
      "type": "fixingErrors",
      "diagnostics": [
        {
          "tHa": "components/student/MercatoView.tsx",
          "message": "Cannot find name 'unassignedAgency'.",
          "line": 274,
          "column": 33
        },
        {
          "tHa": "components/student/mercato/UnemployedView.tsx",
          "message": "Cannot find name 'Plus'.",
          "line": 69,
          "column": 22
        }
      ]
    },
    "createdTimestamp": {
      "seconds": 1767801595,
      "nanos": 830000000
    },
    "doneTimestamp": {
      "seconds": 1767801612,
      "nanos": 350000000
    }
  },
  {
    "id": 5,
    "author": "model",
    "payload": {
      "type": "thinking",
      "text": "**Analyzing the First Issue**\n\nI'm currently focused on the \"unassignedAgency\" issue in `MercatoView.tsx`. Specifically, line 274 is flagging a \"Cannot find name\" error. My immediate task is to identify the root cause of this undefined variable and find a proper fix or import. I'll check its usages in the code to see if there is any misspellings.\n\n\n**Clarifying Variable Scope**\n\nI've been looking at the `unassignedAgency` variable and its scope in `MercatoView.tsx`. Initially, I was looking at line 274, but the actual error pointed me to line 2. This suggests a potential issue with the variable's declaration or availability at the component's top level. I've checked the usages around lines 35-42 and 105, it looks like it's properly defined as a constant, and used later in a conditional block related to `FOUND` actions, which could be the source of the issue.\n\n\n**Fixing the Variable Name**\n\nI've traced the issue to a simple typo. It seems I misnamed the variable in the JSX. It's actually `unemployedAgency`, not `unassignedAgency`. The problem arises around line 275 in `MercatoView.tsx` where I have to change the incorrect variable. This should resolve the \"Cannot find name\" error. I'm now looking at `UnemployedView.tsx` and another error.\n\n\n**Identifying Missing Import**\n\nI've got a new error in `UnemployedView.tsx` - \"Cannot find name 'Plus'\". It seems I forgot to import the `Plus` icon from `lucide-react`, which is used in a button on line 69. I'll add the necessary import statement to include `<UserPlus />` for the icon.\n\n\n**Resolving the Import Issue**\n\nI've got the `Plus` icon error in `UnemployedView.tsx` sorted; it was just a missing import from `lucide-react`. I'm now double-checking the `MercatoView.tsx` file because there was some confusion with variable names. It's becoming clearer that the actual variable in question, which is being used on line 275 and is `unassignedAgency`, is intended, and the initial fix was incorrect.\n\n\n**Verifying Line Numbers**\n\nI'm now back in `MercatoView.tsx`, confirming line numbers for the \"Cannot find name\" error, and it looks like line 275 is actually the culprit, where I'm calling `unassignedAgency`. My import from `lucide-react` also lacks the `Plus` icon for the `<Plus size={20}/>` on line 75 in the original file text. The variable name used around line 275 also appears to be incorrect based on its definition as `unemployedAgency` on line 36.\n\n\n**Updating Imports**\n\nI'm working on missing imports now. I found the `Plus` icon error on line 69 in `UnemployedView.tsx` again, and the fix is adding the `<Plus />` import from `lucide-react`. I'm applying the necessary import statements to fix this.\n\n\n",
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1767801602,
      "nanos": 755000000
    },
    "doneTimestamp": {
      "seconds": 1767801612,
      "nanos": 350000000
    }
  },
  {
    "id": 6,
    "author": "model",
    "payload": {
      "type": "generationTable",
      "entries": [
        {
          "path": "components/student/MercatoView.tsx",
          "generationType": 2,
          "isDone": true,
          "description": "Fixing undefined variable name 'unassignedAgency' by changing it to 'unemployedAgency' as defined earlier in the component.",
          "diffs": [
            {
              "target": "",
              "replacement": "\nimport React, { useState } from 'react';\nimport { Agency, Student, MercatoRequest, MergerRequest } from '../../types';\nimport { useUI } from '../../contexts/UIContext';\nimport { useGame } from '../../contexts/GameContext';\nimport { useAuth } from '../../contexts/AuthContext';\nimport { ref, uploadBytes, getDownloadURL } from 'firebase/storage';\nimport { storage } from '../../services/firebase';\nimport { GAME_RULES } from '../../constants';\nimport { Building2, ArrowRightLeft, Check, X } from 'lucide-react';\n\n// IMPORT SUB-COMPONENTS\nimport { CVModal, MotivationModal } from './mercato/MercatoModals';\nimport { UnemployedView } from './mercato/UnemployedView';\nimport { AgencyDemocracy } from './mercato/AgencyDemocracy';\nimport { TeamManagement } from './mercato/TeamManagement';\nimport { RecruitmentPool } from './mercato/RecruitmentPool';\n\ninterface MercatoViewProps {\n  agency: Agency;\n  allAgencies: Agency[];\n  onUpdateAgency: (agency: Agency) => void;\n  onUpdateAgencies: (agencies: Agency[]) => void;\n}\n\nexport const MercatoView: React.FC<MercatoViewProps> = ({ agency, allAgencies, onUpdateAgency, onUpdateAgencies }) => {\n  const { toast } = useUI();\n  const { submitMercatoVote, getCurrentGameWeek, proposeMerger, finalizeMerger } = useGame();\n  const { currentUser: authUser } = useAuth();\n  \n  const [isCVModalOpen, setIsCVModalOpen] = useState(false);\n  const [isMotivationModalOpen, setIsMotivationModalOpen] = useState(false);\n  const [showMergerModal, setShowMergerModal] = useState(false);\n  \n  // State for Actions\n  const [actionType, setActionType] = useState<'HIRE' | 'FIRE' | 'RESIGN' | 'FOUND'>('HIRE');\n  const [targetStudent, setTargetStudent] = useState<Student | null>(null);\n  const [targetAgencyId, setTargetAgencyId] = useState<string | null>(null);\n  const [motivationText, setMotivationText] = useState(\"\");\n\n  const [cvFile, setCvFile] = useState<File | null>(null);\n  const [isUploadingCV, setIsUploadingCV] = useState(false);\n\n  const currentUser = agency.members.find(m => m.id === authUser?.uid);\n\n  const availableAgencies = allAgencies.filter(a => a.id !== 'unassigned' && a.classId === currentUser?.classId);\n  const unemployedAgency = allAgencies.find(a => a.id === 'unassigned');\n\n  const currentWeek = getCurrentGameWeek();\n  const canMerge = currentWeek >= GAME_RULES.UNLOCK_WEEK_MERGERS;\n\n  const handleSubmitRequest = () => {\n      if(motivationText.length < 5) {\n          toast('error', 'La motivation doit faire au moins 5 caractères.');\n          return;\n      }\n\n      if (!currentUser) return;\n\n      const today = new Date().toISOString().split('T')[0];\n      let newRequest: MercatoRequest | null = null;\n\n      if (actionType === 'FOUND') {\n          newRequest = {\n            id: `req-found-${Date.now()}`, type: 'FOUND_AGENCY',\n            studentId: currentUser.id, studentName: currentUser.name,\n            requesterId: currentUser.id, targetAgencyId: 'new',\n            status: 'PENDING', date: today, motivation: motivationText,\n            votes: {} \n          };\n          if (unemployedAgency) {\n              const updatedUnassigned = { ...unemployedAgency, mercatoRequests: [...unemployedAgency.mercatoRequests, newRequest] };\n              onUpdateAgency(updatedUnassigned);\n              toast('success', \"Demande de fondation envoyée à l'enseignant !\");\n          }\n      } else if (actionType === 'HIRE' && targetStudent) {\n          newRequest = {\n            id: `req-${Date.now()}`, type: 'HIRE',\n            studentId: targetStudent.id, studentName: targetStudent.name,\n            requesterId: currentUser.id, targetAgencyId: agency.id,\n            status: 'PENDING', date: today, motivation: motivationText,\n            votes: { [currentUser.id]: 'APPROVE' } \n          };\n      } else if (actionType === 'FIRE' && targetStudent) {\n          newRequest = {\n            id: `req-${Date.now()}`, type: 'FIRE',\n            studentId: targetStudent.id, studentName: targetStudent.name,\n            requesterId: currentUser.id, targetAgencyId: agency.id,\n            status: 'PENDING', date: today, motivation: motivationText,\n            votes: { [currentUser.id]: 'APPROVE' } \n          };\n      } else if (actionType === 'RESIGN') {\n          newRequest = {\n            id: `req-${Date.now()}`, type: 'FIRE', \n            studentId: currentUser.id, studentName: currentUser.name,\n            requesterId: currentUser.id, targetAgencyId: agency.id,\n            status: 'PENDING', date: today, motivation: motivationText,\n            votes: {} \n          };\n      } else if (actionType === 'HIRE' && targetAgencyId) {\n          newRequest = {\n            id: `req-${Date.now()}`, type: 'HIRE',\n            studentId: currentUser.id, studentName: currentUser.name,\n            requesterId: currentUser.id, targetAgencyId: targetAgencyId,\n            status: 'PENDING', date: today, motivation: motivationText,\n            votes: {} \n          };\n          const targetAgency = allAgencies.find(a => a.id === targetAgencyId);\n          if (targetAgency) {\n              const updatedAgencies = allAgencies.map(a => \n                  a.id === targetAgencyId \n                  ? { ...a, mercatoRequests: [...a.mercatoRequests, newRequest!] } \n                  : a\n              );\n              onUpdateAgencies(updatedAgencies);\n              toast('success', \"Candidature envoyée !\");\n              setIsMotivationModalOpen(false);\n              return;\n          }\n      }\n\n      if (newRequest && agency.id !== 'unassigned' && actionType !== 'FOUND') {\n          onUpdateAgency({\n              ...agency,\n              mercatoRequests: [...agency.mercatoRequests, newRequest]\n          });\n          toast('success', 'Demande envoyée. Le vote est ouvert !');\n      }\n      setIsMotivationModalOpen(false);\n      setMotivationText(\"\");\n  };\n\n  const handleVote = async (request: MercatoRequest, vote: 'APPROVE' | 'REJECT') => {\n      if (!currentUser) return;\n      await submitMercatoVote(agency.id, request.id, currentUser.id, vote);\n  };\n\n  const openHireModal = (student: Student) => {\n      setActionType('HIRE');\n      setTargetStudent(student);\n      setMotivationText(\"\");\n      setIsMotivationModalOpen(true);\n  }\n\n  const openFireModal = (student: Student) => {\n      setActionType('FIRE');\n      setTargetStudent(student);\n      setMotivationText(\"\");\n      setIsMotivationModalOpen(true);\n  }\n\n  const openResignModal = () => {\n      setActionType('RESIGN');\n      setMotivationText(\"\");\n      setIsMotivationModalOpen(true);\n  }\n\n  const openApplyModal = (agencyId: string) => {\n      if (agencyId === 'new') {\n          setActionType('FOUND');\n          setTargetAgencyId(null);\n      } else {\n          setActionType('HIRE'); \n          setTargetAgencyId(agencyId);\n      }\n      setMotivationText(\"\");\n      setIsMotivationModalOpen(true);\n  }\n\n  const handleUploadCV = async () => {\n    if(!currentUser || !cvFile) return;\n    setIsUploadingCV(true);\n    try {\n        const storageRef = ref(storage, `resumes/${currentUser.id}_${cvFile.name}`);\n        await uploadBytes(storageRef, cvFile);\n        const downloadUrl = await getDownloadURL(storageRef);\n        const updatedMembers = agency.members.map(m => \n            m.id === currentUser.id ? { ...m, cvUrl: downloadUrl } : m\n        );\n        onUpdateAgency({ ...agency, members: updatedMembers });\n        setIsCVModalOpen(false);\n        setCvFile(null);\n        toast('success', \"CV mis à jour !\");\n    } catch (error) {\n        console.error(error);\n        toast('error', \"Erreur lors de l'upload du CV.\");\n    } finally {\n        setIsUploadingCV(false);\n    }\n  };\n\n  const handleProposeMerger = async (targetId: string) => {\n      await proposeMerger(agency.id, targetId);\n      setShowMergerModal(false);\n  };\n\n  const handleMergerResponse = async (req: MergerRequest, approved: boolean) => {\n      await finalizeMerger(req.id, agency.id, approved);\n  };\n\n  if (agency.id === 'unassigned') {\n      return (\n          <>\n            <UnemployedView \n                currentUser={currentUser}\n                availableAgencies={availableAgencies}\n                onOpenCVModal={() => setIsCVModalOpen(true)}\n                onOpenApplyModal={openApplyModal}\n            />\n            <CVModal \n                isOpen={isCVModalOpen} \n                onClose={() => setIsCVModalOpen(false)} \n                cvFile={cvFile} \n                setCvFile={setCvFile} \n                handleUploadCV={handleUploadCV} \n                isUploadingCV={isUploadingCV} \n            />\n            <MotivationModal \n                isOpen={isMotivationModalOpen} \n                onClose={() => setIsMotivationModalOpen(false)} \n                onSubmit={handleSubmitRequest} \n                motivation={motivationText} \n                setMotivation={setMotivationText} \n                title={actionType === 'FOUND' ? \"Nom & Vision du Studio\" : \"Pourquoi vous ?\"} \n                subtitle={actionType === 'FOUND' ? \"Décrivez brièvement votre projet de studio.\" : \"Expliquez à l'agence pourquoi elle devrait vous recruter.\"}\n            />\n          </>\n      );\n  }\n\n  const potentialTargets = allAgencies.filter(a => a.id !== 'unassigned' && a.id !== agency.id && a.ve_current < GAME_RULES.MERGER_VE_THRESHOLD && a.classId === agency.classId);\n\n  return (\n    <div className=\"animate-in fade-in space-y-8\">\n        {agency.mergerRequests && agency.mergerRequests.length > 0 && (\n            <div className=\"bg-slate-900 text-white p-6 rounded-2xl shadow-xl border border-indigo-500 relative overflow-hidden\">\n                <div className=\"relative z-10\">\n                    <h3 className=\"font-bold text-lg mb-2 flex items-center gap-2\"><Building2 className=\"text-emerald-400\"/> Offre de Rachat Reçue !</h3>\n                    <div className=\"space-y-3\">\n                        {agency.mergerRequests.map(req => (\n                            <div key={req.id} className=\"bg-white/10 p-4 rounded-xl border border-white/20\">\n                                <p className=\"font-bold text-lg mb-1\">{req.requesterAgencyName} veut vous absorber.</p>\n                                <p className=\"text-sm italic opacity-80 mb-4\">\"{req.offerDetails}\"</p>\n                                <div className=\"flex gap-4\">\n                                    <button onClick={() => handleMergerResponse(req, true)} className=\"bg-emerald-500 hover:bg-emerald-600 px-4 py-2 rounded-lg font-bold text-sm flex items-center gap-2\">\n                                        <Check size={16}/> Accepter (Fusion)\n                                    </button>\n                                    <button onClick={() => handleMergerResponse(req, false)} className=\"bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg font-bold text-sm flex items-center gap-2\">\n                                        <X size={16}/> Refuser\n                                    </button>\n                                </div>\n                            </div>\n                        ))}\n                    </div>\n                </div>\n            </div>\n        )}\n\n        <AgencyDemocracy \n            agency={agency} \n            currentUser={currentUser} \n            onVote={handleVote} \n        />\n\n        <TeamManagement \n            agency={agency}\n            currentUser={currentUser}\n            onOpenResignModal={openResignModal}\n            onOpenFireModal={openFireModal}\n        />\n\n        {/* Fix: Changed unassignedAgency?.members to unemployedAgency?.members */}\n        <RecruitmentPool \n            agency={agency}\n            unemployedStudents={unemployedAgency?.members || []}\n            onOpenHireModal={openHireModal}\n        />\n\n        {canMerge && (\n            <div className=\"mt-8 pt-8 border-t border-slate-200\">\n                <div className=\"flex justify-between items-center mb-4\">\n                     <h3 className=\"font-bold text-slate-900 flex items-center gap-2\">\n                        <Building2 size={20} className=\"text-indigo-600\"/> Fusions & Acquisitions (M&A)\n                    </h3>\n                </div>\n\n                <div className=\"bg-indigo-50 border border-indigo-100 p-6 rounded-2xl\">\n                    <p className=\"text-sm text-indigo-800 mb-4\">\n                        Vous pouvez proposer de racheter une agence en difficulté (VE &lt; {GAME_RULES.MERGER_VE_THRESHOLD}). \n                        <br/><strong>Condition :</strong> Vous absorbez leurs membres (Max {GAME_RULES.MERGER_MAX_MEMBERS} total) et leurs dettes.\n                    </p>\n                    \n                    {potentialTargets.length > 0 ? (\n                        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                            {potentialTargets.map(target => (\n                                <div key={target.id} className=\"bg-white p-4 rounded-xl border border-indigo-100 flex justify-between items-center\">\n                                    <div>\n                                        <h4 className=\"font-bold text-slate-900\">{target.name}</h4>\n                                        <div className=\"flex gap-2 text-xs mt-1\">\n                                            <span className=\"text-red-500 font-bold\">VE: {target.ve_current}</span>\n                                            <span className=\"text-slate-500\">{target.members.length} membres</span>\n                                        </div>\n                                    </div>\n                                    <button \n                                        onClick={() => handleProposeMerger(target.id)}\n                                        className=\"bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-2 rounded-lg text-xs font-bold transition-colors\"\n                                    >\n                                        Proposer Rachat\n                                    </button>\n                                </div>\n                            ))}\n                        </div>\n                    ) : (\n                        <div className=\"text-center py-4 text-slate-400 text-sm italic\">\n                            Aucune cible potentielle (VE &lt; 40) disponible sur le marché.\n                        </div>\n                    )}\n                </div>\n            </div>\n        )}\n\n        <MotivationModal \n            isOpen={isMotivationModalOpen} \n            onClose={() => setIsMotivationModalOpen(false)} \n            onSubmit={handleSubmitRequest} \n            motivation={motivationText} \n            setMotivation={setMotivationText} \n            title={actionType === 'FIRE' ? \"Motif du renvoi\" : actionType === 'RESIGN' ? \"Motif de départ\" : actionType === 'FOUND' ? \"Fondation de Studio\" : \"Proposition d'embauche\"}\n            subtitle={actionType === 'FIRE' ? \"Expliquez pourquoi vous souhaitez vous séparer de ce collaborateur (Vote requis 75%).\" : actionType === 'RESIGN' ? \"Pourquoi quittez-vous le navire ?\" : actionType === 'FOUND' ? \"Donnez un nom provisoire et votre vision.\" : \"Message pour l'équipe (Vote requis 66%).\"}\n        />\n        \n        <CVModal \n            isOpen={isCVModalOpen} \n            onClose={() => setIsCVModalOpen(false)} \n            cvFile={cvFile} \n            setCvFile={setCvFile} \n            handleUploadCV={handleUploadCV} \n            isUploadingCV={isUploadingCV} \n        />\n    </div>\n  );\n};\n"
            }
          ]
        },
        {
          "path": "components/student/mercato/UnemployedView.tsx",
          "generationType": 2,
          "isDone": true,
          "description": "Importing the missing 'Plus' icon from lucide-react to fix the 'Cannot find name Plus' error.",
          "diffs": [
            {
              "target": "",
              "replacement": "\nimport React from 'react';\nimport { Agency, Student } from '../../../types';\nimport { Briefcase, FileText, Upload, UserPlus, Send, Building2, Coins, TrendingUp, Plus } from 'lucide-react';\nimport { GAME_RULES } from '../../../constants';\n\ninterface UnemployedViewProps {\n    currentUser: Student | undefined;\n    availableAgencies: Agency[];\n    onOpenCVModal: () => void;\n    onOpenApplyModal: (agencyId: string) => void;\n}\n\nexport const UnemployedView: React.FC<UnemployedViewProps> = ({ currentUser, availableAgencies, onOpenCVModal, onOpenApplyModal }) => {\n    \n    // Check if there's already a pending FOUND_AGENCY request\n    // This requires checking the unassigned agency requests (passed in context usually, but for UI we assume one request at a time)\n    \n    return (\n        <div className=\"animate-in fade-in space-y-6\">\n            <div className=\"bg-red-50 border-l-4 border-red-500 p-6 rounded-r-xl\">\n                <h3 className=\"text-red-700 font-bold text-lg flex items-center gap-2\">\n                    <Briefcase size={24}/> Statut: Sans Emploi\n                </h3>\n                <div className=\"flex items-center gap-2 mt-2\">\n                    <span className={`text-[10px] font-bold px-2 py-1 rounded text-white ${currentUser?.classId === 'A' ? 'bg-blue-400' : 'bg-purple-400'}`}>\n                        CLASSE {currentUser?.classId}\n                    </span>\n                    <p className=\"text-red-600/80 text-sm\">\n                        Postulez uniquement dans les agences de votre classe.\n                    </p>\n                </div>\n            </div>\n\n            {/* FONDER UN STUDIO */}\n            <div className=\"bg-gradient-to-br from-indigo-900 to-slate-900 text-white p-6 rounded-2xl shadow-xl relative overflow-hidden\">\n                <div className=\"absolute top-0 right-0 p-10 opacity-10\">\n                    <Building2 size={120} />\n                </div>\n                <h4 className=\"font-bold text-xl mb-2 flex items-center gap-2\">\n                    <Building2 size={24} className=\"text-indigo-400\"/> Fonder mon propre Studio\n                </h4>\n                <p className=\"text-sm text-indigo-100 mb-6 max-w-md\">\n                    Vous avez l'âme d'un leader ? Lancez votre agence en solo ou recrutez ensuite d'autres talents du vivier.\n                </p>\n                <div className=\"grid grid-cols-2 gap-4 mb-6\">\n                    <div className=\"bg-white/10 p-3 rounded-xl border border-white/10\">\n                        <span className=\"text-[10px] font-bold uppercase text-indigo-300 block mb-1\">Coût Fondation</span>\n                        <div className=\"flex items-center gap-2 font-bold text-lg\">\n                            <Coins size={16} className=\"text-yellow-400\"/> {GAME_RULES.CREATION_COST_PIXI} PiXi\n                        </div>\n                    </div>\n                    <div className=\"bg-white/10 p-3 rounded-xl border border-white/10\">\n                        <span className=\"text-[10px] font-bold uppercase text-indigo-300 block mb-1\">Investissement Perso</span>\n                        <div className=\"flex items-center gap-2 font-bold text-lg text-red-400\">\n                            <TrendingUp size={16}/> -{GAME_RULES.CREATION_COST_SCORE} pts Score\n                        </div>\n                    </div>\n                </div>\n                <button \n                    onClick={() => onOpenApplyModal('new')}\n                    disabled={(currentUser?.wallet || 0) < GAME_RULES.CREATION_COST_PIXI}\n                    className={`w-full py-4 rounded-xl font-bold transition-all shadow-lg flex items-center justify-center gap-2 ${\n                        (currentUser?.wallet || 0) < GAME_RULES.CREATION_COST_PIXI \n                        ? 'bg-slate-700 text-slate-400 cursor-not-allowed' \n                        : 'bg-indigo-500 hover:bg-indigo-400 text-white'\n                    }`}\n                >\n                    <Plus size={20}/>\n                    {(currentUser?.wallet || 0) < GAME_RULES.CREATION_COST_PIXI ? 'Fonds insuffisants' : 'Fonder mon Studio'}\n                </button>\n            </div>\n\n            {/* MON CV */}\n            <div className=\"bg-white p-6 rounded-2xl border border-slate-200 shadow-sm\">\n                <div className=\"flex justify-between items-center mb-4\">\n                    <h4 className=\"font-bold text-slate-900\">Mon Dossier Professionnel</h4>\n                    {currentUser?.cvUrl && <span className=\"text-xs bg-emerald-100 text-emerald-700 px-2 py-1 rounded-full font-bold\">CV en ligne</span>}\n                </div>\n                \n                {currentUser?.cvUrl ? (\n                    <div className=\"flex items-center gap-4 p-4 bg-slate-50 rounded-xl border border-slate-200\">\n                            <FileText size={32} className=\"text-indigo-500\"/>\n                            <div className=\"flex-1 overflow-hidden\">\n                                <p className=\"font-bold text-slate-900 truncate\">CV_{currentUser.name.replace(' ', '_')}.pdf</p>\n                                <a href={currentUser.cvUrl} target=\"_blank\" className=\"text-xs text-indigo-600 hover:underline\">Voir le document</a>\n                            </div>\n                            <button onClick={onOpenCVModal} className=\"p-2 hover:bg-slate-200 rounded-lg text-slate-500\">\n                                <Upload size={18}/>\n                            </button>\n                    </div>\n                ) : (\n                    <button \n                        onClick={onOpenCVModal}\n                        className=\"w-full py-8 border-2 border-dashed border-slate-300 rounded-xl text-slate-400 hover:bg-slate-50 hover:border-indigo-400 hover:text-indigo-500 transition-all flex flex-col items-center gap-2\"\n                    >\n                        <Upload size={32}/>\n                        <span className=\"font-bold text-sm\">Déposer mon CV (PDF)</span>\n                    </button>\n                )}\n            </div>\n\n            {/* LISTE DES AGENCES */}\n            <div>\n                <h4 className=\"font-bold text-slate-900 mb-4 flex items-center gap-2\">\n                    <UserPlus size={20} className=\"text-emerald-500\"/> Offres d'Emploi (Classe {currentUser?.classId})\n                </h4>\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                    {availableAgencies.map(targetAgency => {\n                        const isPending = targetAgency.mercatoRequests.some(r => r.studentId === currentUser?.id && r.status === 'PENDING');\n                        \n                        return (\n                            <div key={targetAgency.id} className=\"bg-white p-5 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition-all\">\n                                <div className=\"flex justify-between items-start mb-2\">\n                                    <h5 className=\"font-bold text-slate-900\">{targetAgency.name}</h5>\n                                    <span className={`text-[10px] font-bold px-2 py-1 rounded ${targetAgency.status === 'stable' ? 'bg-emerald-100 text-emerald-700' : 'bg-amber-100 text-amber-700'}`}>\n                                        {targetAgency.status}\n                                    </span>\n                                </div>\n                                <p className=\"text-xs text-slate-500 mb-4 line-clamp-2 italic\">\"{targetAgency.tagline}\"</p>\n                                \n                                {isPending ? (\n                                    <button disabled className=\"w-full py-2 bg-slate-100 text-slate-400 font-bold rounded-lg text-xs cursor-not-allowed\">\n                                        Candidature envoyée\n                                    </button>\n                                ) : (\n                                    <button \n                                        onClick={() => onOpenApplyModal(targetAgency.id)}\n                                        className=\"w-full py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg text-xs transition-colors flex items-center justify-center gap-2\"\n                                    >\n                                        <Send size={14}/> Postuler\n                                    </button>\n                                )}\n                            </div>\n                        );\n                    })}\n                </div>\n            </div>\n        </div>\n    );\n};\n"
            }
          ]
        }
      ]
    },
    "createdTimestamp": {
      "seconds": 1767801612,
      "nanos": 351000000
    },
    "doneTimestamp": {
      "seconds": 1767801632,
      "nanos": 545000000
    }
  },
  {
    "id": 7,
    "author": "user",
    "payload": {
      "type": "text",
      "text": "Lorsque je veux créer une agence via un étudiant, il y'a un toast d'erreur qui dit \" Erreurs mise à jour multiples \"",
      "files": [],
      "fileUploads": [],
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1767801869,
      "nanos": 828000000
    }
  },
  {
    "id": 8,
    "author": "model",
    "payload": {
      "type": "thinking",
      "text": "**Isolating The Error**\n\nOkay, I'm focusing on the \"Multiple update error\" that's popping up when a student tries to create an agency. It looks like the issue stems from `contexts/GameContext.tsx`, and I'm digging into that file to pinpoint the exact cause. I'm hoping to understand why this update is happening multiple times and where it's triggering.\n\n\n**Analyzing the Batch Update**\n\nI've been looking closely at the `updateAgenciesList` function, which is causing some problems. I can see now that it uses `writeBatch(db)` to update multiple agencies at once. I think the multiple update issue comes from the `handleApproveRequest` function calling the update list with a new agency, which hasn't been created yet. This is because the student requests a found agency, and then the admin approves the request.\n\n\n**Resolving The Batch Problem**\n\nI've realized the problem is still in how I'm handling the batch updates with `updateAgenciesList`. The `batch.update` in `GameContext` fails when trying to update a new agency because its document ID doesn't exist yet. The correct approach is to use `batch.set(ref, a, { merge: true })`. This will create the document if it's new and update it if it exists. Based on current design principles, `set` or checking existence appears to be the go-to approach for this situation. I am ready to modify `GameContext.tsx`.\n\n\n**Correcting the Agency Update**\n\nI've got it! The key is changing `batch.update` to `batch.set`. This fixes the multiple update error by allowing the batch to handle both new and existing agency documents seamlessly. My focus now is on the student's request in `MercatoView.tsx`, where the process begins. The student's action is to request a found agency, which causes this.\n\n\n**Refining Batch Updates**\n\nI'm now fully focused on the root cause: the admin approval process. I've confirmed the \"multiple update\" error occurs during approval because the new agency document is nonexistent. This is happening due to the `updateAgenciesList` function, which is linked to `AdminMercato.tsx`. The solution is clear: I must modify `updateAgenciesList` in `GameContext.tsx` to utilize `batch.set`. I'm also confirming the safety of how the initial weeks are handled. I will now integrate these changes.\n\n\n**Confirming Batch Integration**\n\nI'm now implementing the change in `GameContext.tsx` where I'm swapping `batch.update` for `batch.set`. I'm confident this will resolve the \"multiple update\" error because it allows the batch operation to create and update agency documents in a single transaction, as needed during admin approval of student agency requests. I've also verified that the wallet and individual scores are handled correctly in `AdminMercato.tsx` when approving a found agency.\n\n\n**Pinpointing The Prop**\n\nI'm now zeroing in on the `onUpdateAgencies` prop in `MercatoView.tsx`. It looks like this calls the troublesome `updateAgenciesList` function when a student \"hires\" and requests an agency. This is where I'll concentrate my efforts to solve the \"multiple update\" error, given that I'm also changing `batch.update` to `batch.set`. I'm starting to understand how a student's actions can trigger this update process.\n\n\n**Implementing the Function**\n\nI've realized the problem lies in `StudentAgencyView.tsx`, where the `onUpdateAgencies` prop is an empty function. It should correctly call `updateAgenciesList`. I need to change that. I'm also confirming that `updateAgenciesList` in `GameContext.tsx` uses `batch.set`. I've double checked `AdminMercato.tsx`, and I'm good to go.\n\n\n**Refining The Integration**\n\nI'm now fully immersed in the student's \"HIRE\" action, which also calls `updateAgenciesList` with the new agency. This reinforces that switching `batch.update` to `batch.set` is crucial. The single-agency update via `updateDoc` seems correct since the agency exists. I'm focusing on ensuring `updateAgenciesList` in `GameContext.tsx` and the `HIRE` action in `MercatoView.tsx` are now integrated without errors.\n\n\n**Implementing The Call**\n\nI'm now integrating the fixes, specifically by ensuring the `onUpdateAgencies` prop is correctly utilized in `MercatoView.tsx`. This is where the problematic \"multiple update\" toast might pop up, and the issue may be resolved by proper function calls. The fixes I am integrating should resolve this.\n\n\n\n",
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1767801869,
      "nanos": 828000000
    },
    "doneTimestamp": {
      "seconds": 1767801890,
      "nanos": 445000000
    }
  },
  {
    "id": 9,
    "author": "model",
    "payload": {
      "type": "text",
      "text": "L'erreur \"Erreurs mise à jour multiple\" provient du fait que l'application utilise une opération `batch.update` de Firebase sur une liste de documents qui contient parfois une **nouvelle agence** (celle que l'on vient de créer). Dans Firebase, la fonction `update` échoue systématiquement si le document n'existe pas encore sur le serveur.\n\nPour corriger cela, nous allons modifier la fonction de mise à jour globale pour qu'elle utilise `batch.set`, qui permet à la fois de créer les nouveaux documents et de mettre à jour les anciens de manière transparente.\n\n### Spécifications des correctifs\n\n1.  **Context Game (`GameContext.tsx`)** : Remplacement de `batch.update` par `batch.set` dans `updateAgenciesList` pour autoriser la création de documents au sein d'un batch.\n2.  **Vue Étudiant (`StudentAgencyView.tsx`)** : Correction du passage de la fonction `onUpdateAgencies` au composant `MercatoView`. Actuellement, une fonction vide `() => {}` était passée, ce qui empêchait les candidatures de fonctionner correctement pour les étudiants.\n3.  **Logique Admin (`AdminMercato.tsx`)** : S'assurer que lors de la validation d'un studio, le document est bien injecté dans le flux Firebase.\n\n",
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1767801890,
      "nanos": 446000000
    },
    "doneTimestamp": {
      "seconds": 1767801890,
      "nanos": 447000000
    }
  },
  {
    "id": 10,
    "author": "model",
    "payload": {
      "type": "generationTable",
      "entries": [
        {
          "path": "contexts/GameContext.tsx",
          "generationType": 1,
          "isDone": true,
          "description": "Remplacement de batch.update par batch.set dans updateAgenciesList pour permettre la création de nouveaux studios lors d'un batch.",
          "diffs": [
            {
              "target": "",
              "replacement": "\nimport React, { createContext, useContext, useState, ReactNode, useEffect } from 'react';\nimport { Agency, WeekModule, GameEvent, WikiResource, Student, TransactionRequest, MercatoRequest, StudentHistoryEntry, MergerRequest } from '../types';\nimport { MOCK_AGENCIES, INITIAL_WEEKS, GAME_RULES, CONSTRAINTS_POOL } from '../constants';\nimport { useUI } from './UIContext';\nimport { db } from '../services/firebase';\nimport { collection, onSnapshot, doc, updateDoc, writeBatch, setDoc, deleteDoc } from 'firebase/firestore';\nimport { useAuth } from './AuthContext';\n\ninterface GameContextType {\n  // State\n  agencies: Agency[];\n  weeks: { [key: string]: WeekModule };\n  resources: WikiResource[]; // Wiki Data\n  role: 'admin' | 'student';\n  selectedAgencyId: string | null;\n  isAutoMode: boolean;\n  \n  // Actions\n  setRole: (role: 'admin' | 'student') => void;\n  selectAgency: (id: string | null) => void;\n  toggleAutoMode: () => void;\n  updateAgency: (agency: Agency) => void;\n  updateAgenciesList: (agencies: Agency[]) => void;\n  updateWeek: (weekId: string, week: WeekModule) => void;\n  \n  // Wiki Actions\n  addResource: (resource: WikiResource) => Promise<void>;\n  deleteResource: (id: string) => Promise<void>;\n\n  // Game Logic\n  shuffleConstraints: (agencyId: string) => void;\n  processFinance: (targetClass: 'A' | 'B') => Promise<void>;\n  processPerformance: (targetClass: 'A' | 'B') => Promise<void>;\n  resetGame: () => void;\n  \n  // Student Economy & RH\n  transferFunds: (sourceId: string, targetId: string, amount: number) => Promise<void>;\n  tradeScoreForCash: (studentId: string, scoreAmount: number) => Promise<void>;\n  injectCapital: (studentId: string, agencyId: string, amount: number) => Promise<void>;\n  requestScorePurchase: (studentId: string, agencyId: string, amountPixi: number, amountScore: number) => Promise<void>;\n  handleTransactionRequest: (agency: Agency, request: TransactionRequest, approved: boolean) => Promise<void>;\n  submitMercatoVote: (agencyId: string, requestId: string, voterId: string, vote: 'APPROVE' | 'REJECT') => Promise<void>;\n\n  // Black Ops & Mergers\n  triggerBlackOp: (sourceAgencyId: string, targetAgencyId: string, type: 'AUDIT' | 'LEAK') => Promise<void>;\n  proposeMerger: (sourceAgencyId: string, targetAgencyId: string) => Promise<void>;\n  finalizeMerger: (mergerId: string, targetAgencyId: string, approved: boolean) => Promise<void>;\n  getCurrentGameWeek: () => number;\n}\n\nconst GameContext = createContext<GameContextType | undefined>(undefined);\n\nexport const useGame = () => {\n  const context = useContext(GameContext);\n  if (!context) throw new Error('useGame must be used within a GameProvider');\n  return context;\n};\n\nexport const GameProvider: React.FC<{ children: ReactNode }> = ({ children }) => {\n  const { toast, confirm } = useUI();\n  const { userData } = useAuth();\n  \n  const [role, setRole] = useState<'admin' | 'student'>('student');\n  const [agencies, setAgencies] = useState<Agency[]>(MOCK_AGENCIES);\n  const [weeks, setWeeks] = useState<{ [key: string]: WeekModule }>(INITIAL_WEEKS);\n  const [resources, setResources] = useState<WikiResource[]>([]);\n  const [selectedAgencyId, setSelectedAgencyId] = useState<string | null>(null);\n  const [isAutoMode, setIsAutoMode] = useState(false);\n\n  // Sync Role with Auth\n  useEffect(() => {\n    if (userData) {\n      if (userData.role === 'admin') setRole('admin');\n      else setRole('student');\n    }\n  }, [userData]);\n\n  // 1. REAL-TIME SYNC: Agencies\n  useEffect(() => {\n    const unsubscribe = onSnapshot(collection(db, \"agencies\"), \n      (snapshot) => {\n        const agenciesData: Agency[] = [];\n        snapshot.forEach((doc) => {\n          agenciesData.push(doc.data() as Agency);\n        });\n        if (agenciesData.length === 0) {\n          seedDatabase().catch(console.error);\n        } else {\n          setAgencies(agenciesData);\n        }\n      },\n      (error) => {\n        console.error(\"Firestore Read Error (Agencies):\", error);\n        toast('info', 'Mode Hors Ligne');\n      }\n    );\n    return () => unsubscribe();\n  }, []);\n\n  // 2. REAL-TIME SYNC: Weeks\n  useEffect(() => {\n    const unsubscribe = onSnapshot(collection(db, \"weeks\"), \n      (snapshot) => {\n        const weeksData: { [key: string]: WeekModule } = {};\n        snapshot.forEach((doc) => {\n          weeksData[doc.id] = doc.data() as WeekModule;\n        });\n        if (Object.keys(weeksData).length > 0) setWeeks(weeksData);\n      }\n    );\n    return () => unsubscribe();\n  }, []);\n\n  // 3. REAL-TIME SYNC: Resources\n  useEffect(() => {\n    const unsubscribe = onSnapshot(collection(db, \"resources\"), \n      (snapshot) => {\n        const resData: WikiResource[] = [];\n        snapshot.forEach((doc) => {\n          resData.push(doc.data() as WikiResource);\n        });\n        setResources(resData);\n      }\n    );\n    return () => unsubscribe();\n  }, []);\n\n  // 4. AUTO MODE SCHEDULER\n  useEffect(() => {\n      if (!isAutoMode) return;\n      const checkSchedule = () => {\n          const now = new Date();\n          const today = now.toISOString().split('T')[0];\n          console.log(`Auto Check: ${today}`);\n      };\n      const interval = setInterval(checkSchedule, 60000); \n      return () => clearInterval(interval);\n  }, [isAutoMode, weeks]);\n\n  // HELPER: Get Current Week\n  const getCurrentGameWeek = () => {\n      const unlockedWeeks = (Object.values(weeks) as WeekModule[]).filter(w => !w.locked).map(w => parseInt(w.id));\n      return unlockedWeeks.length > 0 ? Math.max(...unlockedWeeks) : 1;\n  };\n\n  // SEED FUNCTION\n  const seedDatabase = async () => {\n    const batch = writeBatch(db);\n    MOCK_AGENCIES.forEach(agency => {\n      const ref = doc(db, \"agencies\", agency.id);\n      batch.set(ref, agency);\n    });\n    Object.values(INITIAL_WEEKS).forEach(week => {\n      const ref = doc(db, \"weeks\", week.id);\n      batch.set(ref, week);\n    });\n    await batch.commit();\n  };\n\n  const updateAgency = async (updatedAgency: Agency) => {\n    try {\n        let veCap = 100;\n        const memberCount = updatedAgency.members.length;\n        if (memberCount === 1) veCap = GAME_RULES.VE_CAP_1_MEMBER;\n        else if (memberCount <= 3) veCap = GAME_RULES.VE_CAP_2_3_MEMBERS;\n        else veCap = GAME_RULES.VE_CAP_4_PLUS_MEMBERS;\n\n        const finalVE = Math.min(updatedAgency.ve_current, veCap);\n        const agencyRef = doc(db, \"agencies\", updatedAgency.id);\n        await updateDoc(agencyRef, { ...updatedAgency, ve_current: finalVE });\n    } catch (e) {\n        console.error(e);\n        toast('error', 'Erreur sauvegarde');\n    }\n  };\n\n  const updateAgenciesList = async (newAgencies: Agency[]) => {\n      try {\n        const batch = writeBatch(db);\n        newAgencies.forEach(a => {\n            const ref = doc(db, \"agencies\", a.id);\n            // Use batch.set with merge:true instead of batch.update \n            // to support creating new documents (like a new agency)\n            batch.set(ref, a, { merge: true });\n        });\n        await batch.commit();\n      } catch(e) {\n         console.error(e);\n         toast('error', 'Erreur mise à jour multiple');\n      }\n  };\n\n  const updateWeek = async (weekId: string, updatedWeek: WeekModule) => {\n    try {\n        const weekRef = doc(db, \"weeks\", weekId);\n        await updateDoc(weekRef, { ...updatedWeek });\n        toast('success', `Semaine ${weekId} mise à jour`);\n    } catch (e) {\n        console.error(e);\n        toast('error', 'Erreur maj semaine');\n    }\n  };\n\n  const addResource = async (resource: WikiResource) => {\n      await setDoc(doc(db, \"resources\", resource.id), resource);\n      toast('success', \"Ressource ajoutée\");\n  };\n\n  const deleteResource = async (id: string) => {\n      await deleteDoc(doc(db, \"resources\", id));\n      toast('success', \"Ressource supprimée\");\n  };\n\n  const selectAgency = (id: string | null) => setSelectedAgencyId(id);\n  const toggleAutoMode = () => setIsAutoMode(!isAutoMode);\n\n  const shuffleConstraints = async (agencyId: string) => {\n    const agency = agencies.find(a => a.id === agencyId);\n    if (!agency) return;\n    const randomSpace = CONSTRAINTS_POOL.space[Math.floor(Math.random() * CONSTRAINTS_POOL.space.length)];\n    const randomStyle = CONSTRAINTS_POOL.style[Math.floor(Math.random() * CONSTRAINTS_POOL.style.length)];\n    const randomClient = CONSTRAINTS_POOL.client[Math.floor(Math.random() * CONSTRAINTS_POOL.client.length)];\n    await updateAgency({\n      ...agency,\n      constraints: { space: randomSpace, style: randomStyle, client: randomClient }\n    });\n    toast('info', 'Contraintes régénérées');\n  };\n\n  // --- PROCESS: FINANCE (Rent, Salary, Revenue) ---\n  const processFinance = async (targetClass: 'A' | 'B') => {\n      const today = new Date().toISOString().split('T')[0];\n      try {\n        const batch = writeBatch(db);\n        let processedCount = 0;\n\n        agencies.forEach(agency => {\n            if (agency.id === 'unassigned' || agency.classId !== targetClass) return;\n            processedCount++;\n\n            let currentBudget = agency.budget_real;\n            let logEvents: GameEvent[] = [];\n\n            // 1. RENT\n            currentBudget -= GAME_RULES.AGENCY_RENT;\n            logEvents.push({ id: `fin-rent-${Date.now()}-${agency.id}`, date: today, type: 'CRISIS', label: 'Loyer Agence', deltaBudgetReal: -GAME_RULES.AGENCY_RENT, description: `Prélèvement automatique.` });\n\n            // 2. SALARIES\n            let actualDisbursed = 0;\n            const updatedMembers = agency.members.map(member => {\n                const rawSalary = member.individualScore * GAME_RULES.SALARY_MULTIPLIER; \n                const pay = Math.min(rawSalary, GAME_RULES.SALARY_CAP_FOR_STUDENT);\n                if (currentBudget < 0) return member; \n                actualDisbursed += pay;\n                return { ...member, wallet: (member.wallet || 0) + pay };\n            });\n\n            if (currentBudget >= 0) {\n                currentBudget -= actualDisbursed;\n                logEvents.push({ id: `fin-pay-${Date.now()}-${agency.id}`, date: today, type: 'PAYROLL', label: 'Salaires', deltaBudgetReal: -actualDisbursed, description: `Salaires versés.` });\n            } else {\n                logEvents.push({ id: `fin-pay-${Date.now()}-${agency.id}`, date: today, type: 'PAYROLL', label: 'Salaires Gelés', deltaBudgetReal: 0, description: `Dette active.` });\n            }\n\n            // 3. REVENUES\n            const revenueVE = (agency.ve_current * GAME_RULES.REVENUE_VE_MULTIPLIER);\n            const bonuses = agency.weeklyRevenueModifier || 0;\n            const totalRevenue = revenueVE + bonuses + GAME_RULES.REVENUE_BASE;\n            \n            currentBudget += totalRevenue;\n            logEvents.push({ id: `fin-rev-${Date.now()}-${agency.id}`, date: today, type: 'REVENUE', label: 'Recettes', deltaBudgetReal: totalRevenue, description: `Facturation client (VE: ${agency.ve_current}).` });\n\n            const ref = doc(db, \"agencies\", agency.id);\n            batch.update(ref, {\n                budget_real: currentBudget,\n                members: updatedMembers,\n                eventLog: [...agency.eventLog, ...logEvents]\n            });\n        });\n\n        if (processedCount > 0) {\n            await batch.commit();\n            toast('success', `Finance Classe ${targetClass}: Terminée.`);\n        }\n      } catch(e) { console.error(e); toast('error', \"Erreur Finance\"); }\n  };\n\n  // --- PROCESS: PERFORMANCE ---\n  const processPerformance = async (targetClass: 'A' | 'B') => {\n      const today = new Date().toISOString().split('T')[0];\n      try {\n        const batch = writeBatch(db);\n        let processedCount = 0;\n\n        agencies.forEach(agency => {\n            if (agency.id === 'unassigned' || agency.classId !== targetClass) return;\n            processedCount++;\n            \n            let logEvents: GameEvent[] = [];\n            const updatedMembers = agency.members.map(member => {\n                const reviews = agency.peerReviews.filter(r => r.targetId === member.id);\n                if (reviews.length === 0) return member;\n                const avg = reviews.reduce((sum, r) => sum + ((r.ratings.attendance + r.ratings.quality + r.ratings.involvement)/3), 0) / reviews.length;\n                let scoreDelta = 0;\n                let newStreak = member.streak || 0;\n                if (avg > 4.5) { scoreDelta = 2; newStreak++; if (newStreak >= 3) { scoreDelta += 10; newStreak = 0; } } \n                else if (avg >= 4.0) { scoreDelta = 1; newStreak = 0; } \n                else if (avg < 2.0) { scoreDelta = -5; newStreak = 0; } \n                else { newStreak = 0; }\n                return { ...member, individualScore: Math.max(0, Math.min(100, member.individualScore + scoreDelta)), streak: newStreak };\n            });\n\n            let veAdjustment = 0;\n            const budget = agency.budget_real;\n            if (budget >= 2000) veAdjustment += Math.floor(budget / 2000);\n            else if (budget < 0) veAdjustment -= Math.ceil(Math.abs(budget) / 1000) * 2;\n\n            if (veAdjustment !== 0) {\n                logEvents.push({ id: `perf-ve-${Date.now()}-${agency.id}`, date: today, type: veAdjustment > 0 ? 'VE_DELTA' : 'CRISIS', label: 'Ajustement VE', deltaVE: veAdjustment, description: veAdjustment > 0 ? 'Trésorerie saine.' : 'Dette.' });\n            }\n\n            let veCap = 100;\n            if (agency.members.length === 1) veCap = GAME_RULES.VE_CAP_1_MEMBER;\n            else if (agency.members.length <= 3) veCap = GAME_RULES.VE_CAP_2_3_MEMBERS;\n            else veCap = GAME_RULES.VE_CAP_4_PLUS_MEMBERS;\n            \n            const finalVE = Math.min(Math.max(0, agency.ve_current + veAdjustment), veCap);\n\n            const ref = doc(db, \"agencies\", agency.id);\n            batch.update(ref, {\n                members: updatedMembers,\n                ve_current: finalVE,\n                peerReviews: [], \n                eventLog: [...agency.eventLog, ...logEvents],\n                status: finalVE >= 60 ? 'stable' : finalVE >= 40 ? 'fragile' : 'critique'\n            });\n        });\n\n        if (processedCount > 0) {\n            await batch.commit();\n            toast('success', `Performance Classe ${targetClass}: Terminée.`);\n        }\n      } catch(e) { console.error(e); toast('error', \"Erreur Performance\"); }\n  };\n\n  const transferFunds = async (sourceId: string, targetId: string, amount: number) => { /* Impl */ };\n  const tradeScoreForCash = async (studentId: string, scoreAmount: number) => { /* Impl */ };\n  const injectCapital = async (studentId: string, agencyId: string, amount: number) => { \n      const agency = agencies.find(a => a.id === agencyId);\n      if(!agency) return;\n      const student = agency.members.find(m => m.id === studentId);\n      if(!student || (student.wallet || 0) < amount) return;\n      \n      const batch = writeBatch(db);\n      const updatedMembers = agency.members.map(m => m.id === studentId ? { ...m, wallet: (m.wallet || 0) - amount } : m);\n      const updatedAgency = { ...agency, members: updatedMembers, budget_real: agency.budget_real + amount };\n      batch.set(doc(db, \"agencies\", agency.id), updatedAgency, { merge: true });\n      await batch.commit();\n      toast('success', 'Injection réussie');\n  };\n  \n  const requestScorePurchase = async (studentId: string, agencyId: string, amountPixi: number, amountScore: number) => { \n     const agency = agencies.find(a => a.id === agencyId);\n     if(!agency) return;\n     const newRequest: TransactionRequest = { id: `req-score-${Date.now()}`, studentId, studentName: agency.members.find(m=>m.id===studentId)?.name || '', type: 'BUY_SCORE', amountPixi, amountScore, status: 'PENDING', date: new Date().toISOString().split('T')[0] };\n     await updateDoc(doc(db, \"agencies\", agency.id), { transactionRequests: [...(agency.transactionRequests || []), newRequest] });\n     toast('success', \"Demande envoyée\");\n  };\n\n  const handleTransactionRequest = async (agency: Agency, request: TransactionRequest, approved: boolean) => {\n      const batch = writeBatch(db);\n      const agencyRef = doc(db, \"agencies\", agency.id);\n      const updatedRequests = (agency.transactionRequests || []).filter(r => r.id !== request.id);\n      if (!approved) { batch.update(agencyRef, { transactionRequests: updatedRequests }); await batch.commit(); return; }\n      \n      const updatedMembers = agency.members.map(m => m.id === request.studentId ? { ...m, wallet: (m.wallet || 0) - request.amountPixi, individualScore: Math.min(100, m.individualScore + request.amountScore) } : m);\n      batch.update(agencyRef, { transactionRequests: updatedRequests, members: updatedMembers });\n      await batch.commit();\n      toast('success', \"Transaction validée\");\n  };\n\n  const submitMercatoVote = async (agencyId: string, requestId: string, voterId: string, vote: 'APPROVE' | 'REJECT') => {\n      const agency = agencies.find(a => a.id === agencyId);\n      if(!agency) return;\n      const request = agency.mercatoRequests.find(r => r.id === requestId);\n      if(!request) return;\n\n      const newVotes = { ...request.votes, [voterId]: vote };\n      const approvals = Object.values(newVotes).filter(v => v === 'APPROVE').length;\n      let totalVoters = agency.members.length;\n      let threshold = 0.66;\n      if (request.type === 'FIRE' && request.requesterId !== request.studentId) { totalVoters = Math.max(1, agency.members.length - 1); threshold = 0.75; }\n\n      const batch = writeBatch(db);\n      if (approvals / totalVoters > threshold) {\n          // Execution Logic (Simplified for context update)\n          const targetAgency = agencies.find(a => a.id === 'unassigned');\n          if(targetAgency) {\n               const student = agency.members.find(m => m.id === request.studentId);\n               if(student) {\n                   const updatedSource = agency.members.filter(m => m.id !== request.studentId);\n                   const updatedTarget = [...targetAgency.members, { ...student, history: [] }];\n                   batch.update(doc(db, \"agencies\", agency.id), { members: updatedSource, mercatoRequests: agency.mercatoRequests.filter(r => r.id !== requestId) });\n                   batch.update(doc(db, \"agencies\", targetAgency.id), { members: updatedTarget });\n               }\n          }\n      } else {\n          const updatedRequests = agency.mercatoRequests.map(r => r.id === requestId ? { ...r, votes: newVotes } : r);\n          batch.update(doc(db, \"agencies\", agency.id), { mercatoRequests: updatedRequests });\n      }\n      await batch.commit();\n      toast('success', \"Vote enregistré\");\n  };\n\n  // --- BLACK OPS LOGIC ---\n  const triggerBlackOp = async (sourceAgencyId: string, targetAgencyId: string, type: 'AUDIT' | 'LEAK') => {\n      const week = getCurrentGameWeek();\n      if (week < GAME_RULES.UNLOCK_WEEK_BLACK_OPS) {\n          toast('error', `Disponible en Semaine ${GAME_RULES.UNLOCK_WEEK_BLACK_OPS} uniquement.`);\n          return;\n      }\n\n      const sourceAgency = agencies.find(a => a.id === sourceAgencyId);\n      const targetAgency = agencies.find(a => a.id === targetAgencyId);\n      if (!sourceAgency || !targetAgency) return;\n\n      const cost = type === 'AUDIT' ? GAME_RULES.COST_AUDIT : GAME_RULES.COST_LEAK;\n\n      if (sourceAgency.budget_real < cost) {\n          toast('error', \"Fonds insuffisants pour cette opération.\");\n          return;\n      }\n\n      const batch = writeBatch(db);\n      const today = new Date().toISOString().split('T')[0];\n\n      // 1. Pay Cost\n      const sourceRef = doc(db, \"agencies\", sourceAgency.id);\n      batch.update(sourceRef, {\n          budget_real: sourceAgency.budget_real - cost,\n          eventLog: [...sourceAgency.eventLog, {\n              id: `op-cost-${Date.now()}`, date: today, type: 'BLACK_OP', label: `Opération: ${type}`, deltaBudgetReal: -cost, description: `Paiement prestataire externe.`\n          }]\n      });\n\n      // 2. Execute Effect\n      if (type === 'LEAK') {\n          toast('success', \"Fuite obtenue : Le brief de la semaine prochaine contient une contrainte 'Low Tech'.\");\n      } else if (type === 'AUDIT') {\n          const isVulnerable = targetAgency.budget_real < 0 || targetAgency.ve_current < 40;\n          if (isVulnerable) {\n               const targetRef = doc(db, \"agencies\", targetAgency.id);\n               batch.update(targetRef, {\n                   ve_current: Math.max(0, targetAgency.ve_current - 10),\n                   eventLog: [...targetAgency.eventLog, {\n                       id: `op-hit-${Date.now()}`, date: today, type: 'CRISIS', label: \"Audit Externe (Sanction)\", deltaVE: -10, description: \"Des irrégularités ont été exposées par un audit concurrent.\"\n                   }]\n               });\n               toast('success', `Audit réussi ! ${targetAgency.name} perd 10 VE.`);\n          } else {\n               batch.update(sourceRef, {\n                   ve_current: Math.max(0, sourceAgency.ve_current - 20),\n                   eventLog: [...sourceAgency.eventLog, {\n                       id: `op-fail-${Date.now()}`, date: today, type: 'CRISIS', label: \"Procès Diffamation\", deltaVE: -20, description: \"L'audit n'a rien révélé. L'agence cible porte plainte.\"\n                   }]\n               });\n               toast('error', `Echec ! ${targetAgency.name} est clean. Vous perdez 20 VE pour diffamation.`);\n          }\n      }\n      await batch.commit();\n  };\n\n  // --- MERGERS LOGIC ---\n  const proposeMerger = async (sourceAgencyId: string, targetAgencyId: string) => {\n      const week = getCurrentGameWeek();\n      if (week < GAME_RULES.UNLOCK_WEEK_MERGERS) {\n          toast('error', `Fusions disponibles en Semaine ${GAME_RULES.UNLOCK_WEEK_MERGERS}.`);\n          return;\n      }\n      \n      const targetAgency = agencies.find(a => a.id === targetAgencyId);\n      if(!targetAgency) return;\n\n      if (targetAgency.ve_current > GAME_RULES.MERGER_VE_THRESHOLD) {\n           toast('error', \"Cette agence est trop stable pour être rachetée (VE > 40).\");\n           return;\n      }\n\n      const request: MergerRequest = {\n          id: `merger-${Date.now()}`,\n          requesterAgencyId: sourceAgencyId,\n          requesterAgencyName: agencies.find(a => a.id === sourceAgencyId)?.name || 'Inconnu',\n          targetAgencyId: targetAgencyId,\n          status: 'PENDING',\n          date: new Date().toISOString().split('T')[0],\n          offerDetails: \"Rachat complet de la dette et intégration des effectifs.\"\n      };\n\n      const targetRef = doc(db, \"agencies\", targetAgencyId);\n      await updateDoc(targetRef, {\n          mergerRequests: [...(targetAgency.mergerRequests || []), request]\n      });\n      toast('success', \"Proposition de rachat envoyée.\");\n  };\n\n  const finalizeMerger = async (mergerId: string, targetAgencyId: string, approved: boolean) => {\n      const targetAgency = agencies.find(a => a.id === targetAgencyId);\n      if(!targetAgency) return;\n      const request = targetAgency.mergerRequests?.find(r => r.id === mergerId);\n      if(!request) return;\n\n      const batch = writeBatch(db);\n      const updatedRequests = targetAgency.mergerRequests?.filter(r => r.id !== mergerId);\n      \n      if (!approved) {\n           batch.update(doc(db, \"agencies\", targetAgencyId), { mergerRequests: updatedRequests });\n           await batch.commit();\n           toast('info', \"Fusion refusée.\");\n           return;\n      }\n\n      const sourceAgency = agencies.find(a => a.id === request.requesterAgencyId);\n      if(!sourceAgency) return;\n\n      if (sourceAgency.members.length + targetAgency.members.length > GAME_RULES.MERGER_MAX_MEMBERS) {\n          toast('error', `Fusion impossible : La nouvelle équipe dépasserait ${GAME_RULES.MERGER_MAX_MEMBERS} membres.`);\n          return;\n      }\n\n      const newMembers = [...sourceAgency.members, ...targetAgency.members];\n      const newBudget = sourceAgency.budget_real + targetAgency.budget_real;\n      \n      batch.update(doc(db, \"agencies\", sourceAgency.id), {\n          members: newMembers,\n          budget_real: newBudget,\n          eventLog: [...sourceAgency.eventLog, {\n              id: `merger-win-${Date.now()}`, date: new Date().toISOString().split('T')[0], type: 'MERGER', label: \"Acquisition\", description: `Rachat de ${targetAgency.name}. Dette absorbée.`\n          }]\n      });\n\n      batch.update(doc(db, \"agencies\", targetAgency.id), {\n          members: [],\n          status: 'critique',\n          name: `${targetAgency.name} (Dissoute)`,\n          mergerRequests: []\n      });\n\n      await batch.commit();\n      toast('success', \"Fusion confirmée. Agence absorbée.\");\n  };\n\n  const resetGame = async () => {\n      try { await seedDatabase(); } catch (e) { console.error(e); }\n  };\n\n  return (\n    <GameContext.Provider value={{\n      agencies, weeks, resources, role, selectedAgencyId, isAutoMode,\n      setRole, selectAgency, toggleAutoMode, updateAgency, updateAgenciesList, updateWeek,\n      addResource, deleteResource, shuffleConstraints, processFinance, processPerformance, resetGame,\n      transferFunds, tradeScoreForCash, injectCapital, requestScorePurchase, handleTransactionRequest,\n      submitMercatoVote, triggerBlackOp, proposeMerger, finalizeMerger, getCurrentGameWeek\n    }}>\n      {children}\n    </GameContext.Provider>\n  );\n};\n"
            }
          ]
        },
        {
          "path": "components/StudentAgencyView.tsx",
          "generationType": 1,
          "isDone": true,
          "description": "Liaison correcte de la fonction updateAgenciesList dans la vue Mercato pour permettre aux étudiants de postuler.",
          "diffs": [
            {
              "target": "",
              "replacement": "\nimport React, { useState, useEffect } from 'react';\nimport { Agency, BrandColor, Student, GameEvent } from '../types';\nimport { Target, Users, History, Wallet, TrendingUp, HelpCircle, Briefcase, Settings, Image as ImageIcon, Shield, Eye, Crown, BookOpen, Send, Repeat, ArrowUpRight, Building2, Zap, AlertTriangle, PartyPopper, Gavel, Landmark, Landmark as Bank } from 'lucide-react';\nimport { MarketOverview } from './student/MarketOverview';\nimport { MissionsView } from './student/MissionsView';\nimport { TeamView } from './student/TeamView';\nimport { HistoryView } from './student/HistoryView';\nimport { MercatoView } from './student/MercatoView';\nimport { WikiView } from './student/WikiView';\nimport { Modal } from './Modal';\nimport { GAME_RULES, BADGE_DEFINITIONS } from '../constants';\nimport { ref, uploadBytes, getDownloadURL } from 'firebase/storage';\nimport { storage } from '../services/firebase';\nimport { useUI } from '../contexts/UIContext';\nimport { useAuth } from '../contexts/AuthContext';\nimport { useGame } from '../contexts/GameContext';\n\ninterface StudentViewProps {\n  agency: Agency;\n  allAgencies: Agency[];\n  onUpdateAgency: (agency: Agency) => void;\n}\n\ntype TabType = 'MARKET' | 'MISSIONS' | 'TEAM' | 'RECRUITMENT' | 'HISTORY' | 'RESOURCES' | 'WALLET';\n\nconst COLOR_THEMES: Record<BrandColor, { bg: string, text: string }> = {\n    indigo: { bg: 'bg-indigo-600', text: 'text-indigo-600' },\n    emerald: { bg: 'bg-emerald-600', text: 'text-emerald-600' },\n    rose: { bg: 'bg-rose-600', text: 'text-rose-600' },\n    amber: { bg: 'bg-amber-500', text: 'text-amber-500' },\n    cyan: { bg: 'bg-cyan-500', text: 'text-cyan-500' },\n    slate: { bg: 'bg-slate-600', text: 'text-slate-600' },\n};\n\nexport const StudentAgencyView: React.FC<StudentViewProps> = ({ agency, allAgencies, onUpdateAgency }) => {\n  const { toast } = useUI();\n  const { currentUser } = useAuth();\n  const { transferFunds, injectCapital, requestScorePurchase, getCurrentGameWeek, updateAgenciesList } = useGame();\n  \n  const [activeTab, setActiveTab] = useState<TabType>('MARKET');\n  const [showVERules, setShowVERules] = useState(false);\n  const [showSettings, setShowSettings] = useState(false);\n  \n  const [unlockModal, setUnlockModal] = useState<{title: string, message: string, icon: any, confirmText: string} | null>(null);\n  const [notificationEvent, setNotificationEvent] = useState<GameEvent | null>(null);\n\n  const brandColor = agency.branding?.color || 'indigo';\n  const theme = COLOR_THEMES[brandColor];\n  const leaderboard = [...allAgencies].filter(a => a.id !== 'unassigned').sort((a, b) => b.ve_current - a.ve_current);\n  const myRank = leaderboard.findIndex(a => a.id === agency.id) + 1;\n  const rawSalary = agency.members.reduce((acc, member) => acc + (member.individualScore * GAME_RULES.SALARY_MULTIPLIER), 0);\n  const weeklyCharges = rawSalary * (1 + (agency.weeklyTax || 0)) + GAME_RULES.AGENCY_RENT;\n  const veRevenue = agency.ve_current * GAME_RULES.REVENUE_VE_MULTIPLIER;\n  const weeklyRevenue = GAME_RULES.REVENUE_BASE + veRevenue + (agency.weeklyRevenueModifier || 0);\n  const netWeekly = weeklyRevenue - weeklyCharges;\n  const myMemberProfile = agency.members.find(m => m.id === currentUser?.uid);\n\n  useEffect(() => {\n      const currentWeek = getCurrentGameWeek();\n      if (currentWeek >= GAME_RULES.UNLOCK_WEEK_BLACK_OPS) {\n          const hasSeenBlackOps = localStorage.getItem(`seen_unlock_blackops_${currentUser?.uid}`);\n          if (!hasSeenBlackOps) {\n              setUnlockModal({\n                  title: \"Intelligence Économique Activée\",\n                  message: \"Le marché se durcit. Vous avez désormais accès aux outils de veille stratégique.\\n\\nNouveauté : Audits concurrentiels et achat d'informations disponibles dans l'onglet 'Marché'.\",\n                  icon: <Eye size={32} className=\"text-yellow-500\"/>,\n                  confirmText: \"Compris, je reste vigilant\"\n              });\n              localStorage.setItem(`seen_unlock_blackops_${currentUser?.uid}`, 'true');\n              return; \n          }\n      }\n      if (currentWeek >= GAME_RULES.UNLOCK_WEEK_MERGERS) {\n          const hasSeenMergers = localStorage.getItem(`seen_unlock_mergers_${currentUser?.uid}`);\n          if (!hasSeenMergers) {\n              setUnlockModal({\n                  title: \"Fusions & Acquisitions (M&A)\",\n                  message: \"La consolidation du secteur commence. \\n\\nNouveauté : Il est désormais possible de racheter une agence en faillite (VE < 40) pour absorber ses talents et sa dette.\",\n                  icon: <Building2 size={32} className=\"text-indigo-500\"/>,\n                  confirmText: \"Voir les opportunités\"\n              });\n              localStorage.setItem(`seen_unlock_mergers_${currentUser?.uid}`, 'true');\n          }\n      }\n  }, [getCurrentGameWeek, currentUser]);\n\n  useEffect(() => {\n      if (agency.eventLog.length === 0) return;\n      const latestEvent = agency.eventLog[agency.eventLog.length - 1];\n      const NOTIFY_TYPES = ['CRISIS', 'VE_DELTA'];\n      if (NOTIFY_TYPES.includes(latestEvent.type)) {\n          const seenKey = `seen_event_${currentUser?.uid}_${latestEvent.id}`;\n          const hasSeen = localStorage.getItem(seenKey);\n          if (!hasSeen) setNotificationEvent(latestEvent);\n      }\n  }, [agency.eventLog, currentUser]);\n\n  const closeNotification = () => {\n      if (notificationEvent) {\n          localStorage.setItem(`seen_event_${currentUser?.uid}_${notificationEvent.id}`, 'true');\n          setNotificationEvent(null);\n      }\n  };\n\n  const handleColorChange = (color: BrandColor) => {\n      onUpdateAgency({ ...agency, branding: { ...agency.branding, color } });\n  };\n\n  const handleBannerUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {\n      if (e.target.files && e.target.files[0]) {\n          try {\n              const storageRef = ref(storage, `banners/${agency.id}_${Date.now()}`);\n              await uploadBytes(storageRef, e.target.files[0]);\n              const url = await getDownloadURL(storageRef);\n              onUpdateAgency({ ...agency, branding: { ...agency.branding, bannerUrl: url } });\n              toast('success', 'Bannière mise à jour');\n          } catch (error) { toast('error', \"Erreur d'upload\"); }\n      }\n  };\n\n  return (\n    <div className=\"flex flex-col min-h-[calc(100vh-6rem)] font-sans\">\n        {/* HEADER */}\n        <div className=\"relative mb-8 rounded-b-3xl md:rounded-3xl overflow-hidden bg-slate-100 min-h-[200px] md:min-h-[240px] shadow-md group\">\n            {agency.branding?.bannerUrl ? (\n                <img src={agency.branding.bannerUrl} className=\"absolute inset-0 w-full h-full object-cover\" alt=\"Banner\" />\n            ) : (\n                <div className={`absolute inset-0 opacity-10 ${theme.bg}`} style={{backgroundImage: 'radial-gradient(circle, #000 1px, transparent 1px)', backgroundSize: '20px 20px'}}></div>\n            )}\n            <div className=\"absolute inset-0 bg-gradient-to-t from-slate-900/90 via-slate-900/40 to-transparent\"></div>\n            {agency.id !== 'unassigned' && (\n                <button onClick={() => setShowSettings(true)} className=\"absolute top-4 right-4 p-2 bg-black/30 backdrop-blur-md rounded-full text-white hover:bg-black/50 transition-all opacity-0 group-hover:opacity-100 border border-white/10\">\n                    <Settings size={20}/>\n                </button>\n            )}\n            <div className=\"absolute bottom-0 left-0 right-0 p-6 flex flex-col xl:flex-row justify-between items-end xl:items-end gap-6 text-white\">\n                <div className=\"w-full xl:w-auto\">\n                    <div className=\"flex items-center gap-3 mb-1\">\n                        {agency.id !== 'unassigned' && <span className=\"bg-white/20 backdrop-blur border border-white/10 px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider\">Rang #{myRank}</span>}\n                        <span className=\"text-slate-300 italic text-sm truncate\">\"{agency.tagline}\"</span>\n                    </div>\n                    <h2 className=\"text-4xl md:text-5xl font-display font-bold tracking-tight drop-shadow-lg leading-none mb-3\">{agency.name}</h2>\n                    <div className=\"flex items-center gap-1\">\n                        {agency.badges && agency.badges.map(b => (\n                            <div key={b.id} title={b.label} className=\"w-6 h-6 rounded-full bg-yellow-400 text-yellow-900 flex items-center justify-center shadow-lg border border-yellow-200\"><Shield size={12}/></div>\n                        ))}\n                    </div>\n                </div>\n\n                {agency.id !== 'unassigned' && (\n                <div className=\"flex flex-col md:flex-row gap-4 w-full xl:w-auto bg-black/40 backdrop-blur-md p-4 rounded-2xl border border-white/10\">\n                    {myMemberProfile && (\n                        <div onClick={() => setActiveTab('WALLET')} className=\"flex-1 md:text-right md:border-r border-white/20 md:pr-4 cursor-pointer group hover:bg-white/10 rounded-lg p-1 transition-colors\">\n                            <span className=\"text-[10px] font-bold text-yellow-300 uppercase tracking-widest block mb-1 group-hover:underline flex items-center gap-1 md:justify-end\">\n                                <Wallet size={12}/> Mon Solde\n                            </span>\n                            <div className=\"text-lg font-bold text-white flex items-center md:justify-end gap-2\">\n                                <span className=\"text-yellow-400 font-mono\">{myMemberProfile.wallet || 0} PiXi</span>\n                            </div>\n                        </div>\n                    )}\n                    \n                    <div className=\"flex-1 md:text-right md:border-r border-white/20 md:pr-4\">\n                        <span className=\"text-[10px] font-bold text-indigo-300 uppercase tracking-widest block mb-1 flex items-center gap-1 md:justify-end\">\n                            <Landmark size={12}/> Trésorerie Studio\n                        </span>\n                        <div className=\"text-lg font-bold text-white flex items-center md:justify-end gap-2\">\n                            <span className={`font-mono ${agency.budget_real < 0 ? 'text-red-400' : 'text-white'}`}>{agency.budget_real} PiXi</span>\n                        </div>\n                    </div>\n\n                    <div className=\"flex items-center justify-between md:justify-start gap-6 pl-2\">\n                        <div className=\"text-center\">\n                            <span className=\"text-[10px] font-bold text-slate-300 uppercase tracking-widest block mb-1\">Flux Net</span>\n                            <div className={`text-xl font-bold ${netWeekly >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>{netWeekly > 0 ? '+' : ''}{netWeekly.toFixed(0)}</div>\n                        </div>\n                        <div className=\"text-center\">\n                            <div \n                                onClick={() => setShowVERules(true)}\n                                className=\"text-[10px] font-bold text-slate-300 uppercase tracking-widest mb-1 flex items-center gap-1 justify-center cursor-pointer hover:text-white\"\n                            >\n                                VE <HelpCircle size={10}/>\n                            </div>\n                            <div className={`text-3xl font-display font-bold leading-none ${agency.ve_current >= 60 ? 'text-emerald-400' : 'text-amber-400'}`}>{agency.ve_current}</div>\n                        </div>\n                    </div>\n                </div>\n                )}\n            </div>\n        </div>\n\n        {/* CONTENT */}\n        <div className=\"flex-1 mb-24 md:mb-8\">\n            {activeTab === 'MARKET' && agency.id !== 'unassigned' && <MarketOverview agency={agency} allAgencies={allAgencies} />}\n            {activeTab === 'MISSIONS' && agency.id !== 'unassigned' && <MissionsView agency={agency} onUpdateAgency={onUpdateAgency} />}\n            {activeTab === 'TEAM' && agency.id !== 'unassigned' && <TeamView agency={agency} onUpdateAgency={onUpdateAgency} />}\n            {activeTab === 'WALLET' && myMemberProfile && agency.id !== 'unassigned' && (\n                <WalletView \n                    student={myMemberProfile} \n                    agency={agency} \n                    allStudents={allAgencies.flatMap(a => a.members)}\n                    onTransfer={transferFunds}\n                    onInjectCapital={injectCapital}\n                    onRequestScore={requestScorePurchase}\n                />\n            )}\n            {(activeTab === 'RECRUITMENT' || agency.id === 'unassigned') && (\n              <MercatoView \n                agency={agency} \n                allAgencies={allAgencies} \n                onUpdateAgency={onUpdateAgency} \n                onUpdateAgencies={updateAgenciesList} \n              />\n            )}\n            {activeTab === 'RESOURCES' && <WikiView agency={agency} />}\n            {activeTab === 'HISTORY' && <HistoryView agency={agency} />}\n        </div>\n\n        {/* FOOTER NAV */}\n        <div className=\"fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-md border-t border-slate-200 p-2 z-50 md:relative md:bg-transparent md:border-t-0 md:p-0 md:mt-auto safe-area-bottom\">\n             <div className=\"max-w-7xl mx-auto flex md:justify-start gap-2 md:gap-4 overflow-x-auto no-scrollbar snap-x justify-between\">\n                {agency.id !== 'unassigned' && (\n                    <>\n                        <NavButton active={activeTab === 'MARKET'} onClick={() => setActiveTab('MARKET')} icon={<TrendingUp size={20} />} label=\"Marché\" theme={theme} />\n                        <NavButton active={activeTab === 'MISSIONS'} onClick={() => setActiveTab('MISSIONS')} icon={<Target size={20} />} label=\"Missions\" theme={theme} />\n                        <NavButton active={activeTab === 'TEAM'} onClick={() => setActiveTab('TEAM')} icon={<Users size={20} />} label=\"Équipe\" theme={theme} />\n                        <NavButton active={activeTab === 'WALLET'} onClick={() => setActiveTab('WALLET')} icon={<Wallet size={20} />} label=\"Banque\" theme={theme} />\n                    </>\n                )}\n                <NavButton active={activeTab === 'RESOURCES'} onClick={() => setActiveTab('RESOURCES')} icon={<BookOpen size={20} />} label=\"Wiki\" theme={theme} />\n                <NavButton active={activeTab === 'RECRUITMENT' || agency.id === 'unassigned'} onClick={() => setActiveTab('RECRUITMENT')} icon={<Briefcase size={20} />} label={agency.id === 'unassigned' ? \"Mon Statut\" : \"Recrutement\"} theme={theme} />\n                <NavButton active={activeTab === 'HISTORY'} onClick={() => setActiveTab('HISTORY')} icon={<History size={20} />} label=\"Journal\" theme={theme} />\n             </div>\n        </div>\n\n        {/* MODALS */}\n        <Modal isOpen={showSettings} onClose={() => setShowSettings(false)} title=\"Personnalisation Agence\">\n            <div className=\"space-y-6\">\n                <div>\n                    <label className=\"block text-sm font-bold text-slate-700 mb-2\">Couleur de Marque</label>\n                    <div className=\"flex gap-3\">\n                        {(['indigo', 'emerald', 'rose', 'amber', 'cyan'] as BrandColor[]).map(c => (\n                            <button key={c} onClick={() => handleColorChange(c)} className={`w-10 h-10 rounded-full border-2 ${COLOR_THEMES[c].bg} ${brandColor === c ? 'ring-4 ring-offset-2 ring-slate-200 border-white' : 'border-transparent opacity-60 hover:opacity-100'}`} />\n                        ))}\n                    </div>\n                </div>\n                <div>\n                    <label className=\"block text-sm font-bold text-slate-700 mb-2\">Bannière (Cover)</label>\n                    <label className=\"flex flex-col items-center justify-center w-full h-32 border-2 border-slate-300 border-dashed rounded-xl cursor-pointer bg-slate-50 hover:bg-slate-100 transition-colors\">\n                        <div className=\"flex flex-col items-center justify-center pt-5 pb-6\">\n                            <ImageIcon className=\"w-8 h-8 text-slate-400 mb-2\" />\n                            <p className=\"text-sm text-slate-500\">Cliquez pour changer</p>\n                        </div>\n                        <input type=\"file\" className=\"hidden\" accept=\"image/*\" onChange={handleBannerUpload} />\n                    </label>\n                </div>\n            </div>\n        </Modal>\n        \n        <Modal isOpen={showVERules} onClose={() => setShowVERules(false)} title=\"Comprendre la VE\">\n            <div className=\"space-y-6\">\n                <div className=\"bg-slate-50 p-4 rounded-2xl border border-slate-100\">\n                    <p className=\"text-sm text-slate-600 leading-relaxed mb-2\">\n                        La <strong>Valeur d'Entreprise (VE)</strong> est votre \"note de groupe\" dynamique (/100). \n                        <br/>Elle fluctue selon vos rendus, vos choix et les événements.\n                    </p>\n                </div>\n            </div>\n        </Modal>\n\n        {unlockModal && (\n            <Modal isOpen={!!unlockModal} onClose={() => setUnlockModal(null)} title={unlockModal.title}>\n                <div className=\"flex flex-col items-center text-center space-y-6\">\n                    <div className=\"p-6 rounded-full bg-slate-100 mb-2\">\n                        {unlockModal.icon}\n                    </div>\n                    <p className=\"text-slate-600 text-lg leading-relaxed whitespace-pre-line\">\n                        {unlockModal.message}\n                    </p>\n                    <button \n                        onClick={() => setUnlockModal(null)}\n                        className=\"w-full py-4 bg-slate-900 text-white font-bold rounded-xl hover:bg-indigo-600 transition-colors shadow-lg\"\n                    >\n                        {unlockModal.confirmText}\n                    </button>\n                </div>\n            </Modal>\n        )}\n\n        {notificationEvent && (\n            <Modal isOpen={!!notificationEvent} onClose={closeNotification} title={notificationEvent.type === 'CRISIS' ? \"ALERTE PRIORITAIRE\" : \"NOUVELLE IMPORTANTE\"}>\n                <div className=\"flex flex-col items-center text-center space-y-6\">\n                    <div className={`p-6 rounded-full mb-2 border-4 ${\n                        notificationEvent.type === 'CRISIS' || (notificationEvent.deltaVE || 0) < 0\n                        ? 'bg-red-50 border-red-100 text-red-600 animate-pulse'\n                        : 'bg-emerald-50 border-emerald-100 text-emerald-600'\n                    }`}>\n                        {notificationEvent.type === 'CRISIS' || (notificationEvent.deltaVE || 0) < 0\n                            ? <AlertTriangle size={48} strokeWidth={2.5}/>\n                            : (notificationEvent.deltaVE || 0) > 5 ? <PartyPopper size={48} strokeWidth={2.5}/> : <Zap size={48} strokeWidth={2.5}/>\n                        }\n                    </div>\n\n                    <div>\n                        <h3 className={`text-2xl font-black uppercase mb-2 ${\n                            notificationEvent.type === 'CRISIS' || (notificationEvent.deltaVE || 0) < 0 ? 'text-red-600' : 'text-emerald-600'\n                        }`}>\n                            {notificationEvent.label}\n                        </h3>\n                        <p className=\"text-slate-600 text-lg leading-relaxed font-medium\">\n                            {notificationEvent.description}\n                        </p>\n                    </div>\n\n                    <button \n                        onClick={closeNotification}\n                        className={`w-full py-4 text-white font-bold rounded-xl shadow-lg transition-transform active:scale-95 ${\n                            notificationEvent.type === 'CRISIS' || (notificationEvent.deltaVE || 0) < 0\n                            ? 'bg-red-600 hover:bg-red-700 shadow-red-200'\n                            : 'bg-emerald-600 hover:bg-emerald-700 shadow-emerald-200'\n                        }`}\n                    >\n                        {notificationEvent.type === 'CRISIS' ? \"J'AI PRIS CONNAISSANCE\" : \"GÉNIAL !\"}\n                    </button>\n                </div>\n            </Modal>\n        )}\n    </div>\n  );\n};\n\nconst WalletView: React.FC<{student: Student, agency: Agency, allStudents: Student[], onTransfer: any, onInjectCapital: any, onRequestScore: any}> = ({student, agency, allStudents, onTransfer, onInjectCapital, onRequestScore}) => {\n    const [targetId, setTargetId] = useState('');\n    const [amount, setAmount] = useState(0);\n    const [scoreToBuy, setScoreToBuy] = useState(0);\n\n    const handleTransfer = async () => {\n        if(!targetId || amount <= 0) return;\n        await onTransfer(student.id, targetId, amount);\n        setAmount(0);\n    };\n\n    const handleInject = async () => {\n        if(amount <= 0) return;\n        await onInjectCapital(student.id, agency.id, amount);\n        setAmount(0);\n    };\n\n    const handleBuyScore = async () => {\n        if(scoreToBuy <= 0) return;\n        const cost = scoreToBuy * 200;\n        await onRequestScore(student.id, agency.id, cost, scoreToBuy);\n        setScoreToBuy(0);\n    };\n\n    return (\n        <div className=\"animate-in fade-in space-y-6\">\n            {/* AGENCY TREASURY CARD - VERY VISIBLE NOW */}\n            <div className=\"bg-slate-900 rounded-3xl p-6 border border-slate-700 shadow-xl flex flex-col md:flex-row justify-between items-center gap-6\">\n                <div className=\"flex items-center gap-4\">\n                    <div className=\"p-4 bg-indigo-500/20 rounded-2xl text-indigo-400 border border-indigo-500/30\">\n                        <Bank size={32}/>\n                    </div>\n                    <div>\n                        <p className=\"text-indigo-300 text-xs font-bold uppercase tracking-widest\">Trésorerie de l'Entreprise</p>\n                        <p className=\"text-3xl font-display font-bold text-white\">{agency.budget_real} <span className=\"text-sm text-slate-500\">PiXi</span></p>\n                    </div>\n                </div>\n                <div className=\"flex flex-col items-center md:items-end\">\n                    <p className=\"text-slate-500 text-xs uppercase font-bold mb-1\">Santé Financière</p>\n                    <div className={`px-4 py-1.5 rounded-full text-xs font-bold border ${\n                        agency.budget_real > 1000 ? 'bg-emerald-500/10 text-emerald-400 border-emerald-500/20' : \n                        agency.budget_real > 0 ? 'bg-amber-500/10 text-amber-400 border-amber-500/20' : \n                        'bg-red-500/10 text-red-400 border-red-500/20 animate-pulse'\n                    }`}>\n                        {agency.budget_real > 1000 ? 'SOLVABLE' : agency.budget_real > 0 ? 'FRAGILE' : 'ENDETTÉ'}\n                    </div>\n                </div>\n            </div>\n\n            <div className=\"bg-indigo-600 text-white p-8 rounded-3xl shadow-lg flex flex-col md:flex-row justify-between items-center relative overflow-hidden\">\n                <div className=\"absolute top-0 right-0 p-20 bg-white/5 rounded-full blur-3xl transform translate-x-10 -translate-y-10\"></div>\n                <div className=\"relative z-10 text-center md:text-left mb-4 md:mb-0\">\n                    <p className=\"text-indigo-200 text-sm font-bold uppercase mb-1 tracking-widest\">Mon Solde Personnel</p>\n                    <p className=\"text-5xl font-display font-bold text-yellow-400\">{student?.wallet || 0} <span className=\"text-2xl text-yellow-200\">PiXi</span></p>\n                </div>\n                <div className=\"relative z-10 bg-white/10 p-4 rounded-xl backdrop-blur-sm border border-white/20\">\n                    <p className=\"text-xs text-indigo-100 mb-1\">Salaire Hebdo</p>\n                    <p className=\"font-bold text-white text-lg\">+{student.individualScore * GAME_RULES.SALARY_MULTIPLIER} PiXi</p>\n                </div>\n            </div>\n\n            <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n                <div className=\"bg-white p-6 rounded-2xl border border-slate-200 shadow-sm flex flex-col\">\n                    <div className=\"mb-4\">\n                        <div className=\"w-12 h-12 bg-emerald-100 rounded-full flex items-center justify-center text-emerald-600 mb-3\">\n                            <ArrowUpRight size={24}/>\n                        </div>\n                        <h3 className=\"font-bold text-slate-900 text-lg\">Investir dans mon Agence</h3>\n                        <p className=\"text-sm text-slate-500 mt-1\">Injection de fonds personnels.</p>\n                    </div>\n                    <div className=\"mt-auto space-y-3\">\n                        <input type=\"number\" className=\"w-full p-3 rounded-xl border border-slate-200 font-bold bg-slate-50\" placeholder=\"Montant\" onChange={e => setAmount(Number(e.target.value))} />\n                        <button onClick={handleInject} disabled={amount <= 0 || amount > (student.wallet || 0)} className=\"w-full py-3 bg-emerald-600 text-white font-bold rounded-xl hover:bg-emerald-700 transition-colors disabled:opacity-50\">Injecter</button>\n                    </div>\n                </div>\n\n                <div className=\"bg-white p-6 rounded-2xl border border-slate-200 shadow-sm flex flex-col\">\n                    <div className=\"mb-4\">\n                        <div className=\"w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center text-indigo-600 mb-3\">\n                            <Send size={24}/>\n                        </div>\n                        <h3 className=\"font-bold text-slate-900 text-lg\">Virement à un collègue</h3>\n                        <p className=\"text-sm text-slate-500 mt-1\">Soutien inter-agences.</p>\n                    </div>\n                    <div className=\"mt-auto space-y-3\">\n                        <select className=\"w-full p-3 rounded-xl border border-slate-200 bg-white text-sm\" onChange={e => setTargetId(e.target.value)} value={targetId}>\n                            <option value=\"\">-- Bénéficiaire --</option>\n                            {allStudents.filter(s => s.id !== student.id).map(s => (\n                                <option key={s.id} value={s.id}>{s.name}</option>\n                            ))}\n                        </select>\n                        <input type=\"number\" className=\"w-full p-3 rounded-xl border border-slate-200 font-bold bg-slate-50\" placeholder=\"Montant\" onChange={e => setAmount(Number(e.target.value))} />\n                        <button onClick={handleTransfer} disabled={amount <= 0 || amount > (student.wallet || 0)} className=\"w-full py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 transition-colors disabled:opacity-50\">Envoyer</button>\n                    </div>\n                </div>\n\n                <div className=\"bg-white p-6 rounded-2xl border border-slate-200 shadow-sm flex flex-col\">\n                    <div className=\"mb-4\">\n                        <div className=\"w-12 h-12 bg-amber-100 rounded-full flex items-center justify-center text-amber-600 mb-3\">\n                            <TrendingUp size={24}/>\n                        </div>\n                        <h3 className=\"font-bold text-slate-900 text-lg\">Achat Score (Formation)</h3>\n                        <p className=\"text-sm text-slate-500 mt-1\">200 PiXi = 1 Point Score.</p>\n                    </div>\n                    <div className=\"mt-auto space-y-3\">\n                        <input type=\"number\" className=\"w-full p-3 rounded-xl border border-slate-200 font-bold bg-slate-50\" placeholder=\"Points voulus\" onChange={e => setScoreToBuy(Number(e.target.value))} />\n                        <button onClick={handleBuyScore} disabled={scoreToBuy <= 0 || (scoreToBuy * 200) > (student.wallet || 0)} className=\"w-full py-3 bg-amber-500 text-white font-bold rounded-xl hover:bg-amber-600 transition-colors disabled:opacity-50\">Acheter</button>\n                    </div>\n                </div>\n            </div>\n        </div>\n    );\n};\n\nconst NavButton: React.FC<any> = ({ active, onClick, icon, label, theme }) => (\n    <button onClick={onClick} className={`snap-start flex flex-col md:flex-row items-center md:gap-3 p-2 md:p-4 rounded-xl transition-all min-w-[70px] md:min-w-[150px] justify-center md:justify-start ${active ? `${theme.bg} text-white transform scale-105 shadow-md` : 'hover:bg-slate-50 text-slate-400 hover:text-slate-600'}`}>\n        <div className={`p-1.5 rounded-full ${active ? 'bg-white/20' : ''}`}>{React.cloneElement(icon, { className: active ? 'text-white' : '' })}</div>\n        <span className={`text-[10px] md:text-base font-bold`}>{label}</span>\n    </button>\n);\n"
            }
          ]
        }
      ]
    },
    "createdTimestamp": {
      "seconds": 1767801891,
      "nanos": 486000000
    },
    "doneTimestamp": {
      "seconds": 1767801914,
      "nanos": 637000000
    }
  },
  {
    "id": 11,
    "author": "user",
    "payload": {
      "type": "text",
      "text": "Ça n'a pas fonctionné, je n'ai plus le toast, mais l'entreprise n'est toujours pas créée\n\nAussi, les étudiants ont demandé à ce qu'on ajoute une FAQ dans leur vue\n\nTu peux en créer une qui indique :\n\nCe qu'est la VE\nCe qu'est un PiXi\nComment on les gagnent\nQuelles règles importantes\nQuel est l'objectif final du projet (levée de fonds)\nCe genre de choses",
      "files": [],
      "fileUploads": [],
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1767802447,
      "nanos": 994000000
    }
  },
  {
    "id": 12,
    "author": "model",
    "payload": {
      "type": "thinking",
      "text": "**Examining Agency Creation**\n\nI've made some progress on the agency creation issue. The annoying \"Erreurs mise à jour multiples\" toast is no longer appearing, which is a definite win. However, the agency still isn't fully created. I also need to begin thinking about a student-requested FAQ to address what VE and a PiXi are. This will require some more thorough research and planning.\n\n\n**Addressing Document Creation**\n\nMy current focus is on resolving a Firestore document creation issue. `batch.set` seems to be the culprit, it's correct for updates, but for new documents, the ID must be specific. Specifically, a student's `FOUND_AGENCY` request creates an `unassigned` agency request that must update a new document for a new agency. The specific issue is likely in `AdminMercato.tsx`, where agency data is being manipulated during document creation.\n\n\n**Refining Agency Update Process**\n\nI'm now zeroing in on the agency update process. I suspect potential mismatches in data handling. Specifically, I'm verifying if updates in `AdminMercato` are correctly propagated to `GameContext`. My current hypothesis focuses on how `newAgency` is incorporated into the `agencies` array and passed to the update function. I'm focusing on ensuring data integrity when the new agency is added, since the ID seems valid. The `updateAgenciesList` function will be verified for robustness and data integrity.\n\n\n**Clarifying Agency Assignment**\n\nI'm now zeroing in on a critical agency assignment step. If a student is tied to a Firebase UID, the logic that removes the \"unassigned\" agency must be flawless. I'll make sure to explicitly update the \"unassigned\" agency document to remove the student in `GameContext`, instead of just using `batch.set`. This check is in `StudentAgencyView.tsx`. Finally, I need to create a FAQ, accessible through a Help button.\n\n\n**Implementing FAQ Display**\n\nI'm now implementing the FAQ display, and I'm planning a beautiful accordion or grid layout with modern Lucide icons. I need to ensure a clear and pedagogical tone in the content. I've updated `StudentAgencyView.tsx` by adding a Help button to the TabType enum and importing the FAQView. I am refining `updateAgenciesList` in `GameContext.tsx` to handle more edge cases, possibly creating a specific `createAgency` function for clarity. In `AdminMercato.tsx`, I'll double-check `handleApproveRequest` and ensure `newAgency` contains all required fields. Finally, I need to deep clone INITIAL_WEEKS to avoid reference sharing.\n\n\n**Improving Data Handling**\n\nI've resolved an issue with the `INITIAL_WEEKS` data, which should be good to go now. I realized that within `AdminMercato.tsx`, updating the \"unassigned\" agency inside a `map` and passing it back might cause state flow issues in `App.tsx` and, ultimately, `GameContext`. I've decided the best course is to modify `AdminMercato` to call a dedicated `createAgencyFromRequest` function in `GameContext`. The root cause is likely a silent Firestore error, or the missing student ID in the update. I'll add the FAQ, too.\n\n\n\n**Verifying Agency Updates**\n\nI'm now zeroing in on verifying the agency update flow, particularly in relation to the `newAgency` object and how the full list is updated, to ensure that the document is being successfully created, rather than modified. I'm focusing on ensuring data consistency by making calls to update the state. Firestore rules are not the source of the issue. A student's agency request is being correctly added to the `unassignedAgency.mercatoRequests` array.\n\n\n",
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1767802447,
      "nanos": 995000000
    },
    "doneTimestamp": {
      "seconds": 1767802467,
      "nanos": 143000000
    }
  },
  {
    "id": 13,
    "author": "model",
    "payload": {
      "type": "text",
      "text": "Pour résoudre le problème de création qui semble \"silencieux\" et ajouter la FAQ demandée, nous allons :\n\n1.  **Fiabiliser la création de studio** : Dans `AdminMercato`, s'assurer que l'objet `newAgency` est complet et que la mise à jour de la liste inclut bien la suppression de l'étudiant du vivier et l'ajout de la nouvelle agence dans le même flux.\n2.  **Ajouter la vue FAQ** : Création d'un nouveau composant `FAQView` et intégration dans la barre de navigation étudiante.\n\n### Spécifications des changements\n\n**1. Correction de la Fondation (Bug Fix) :**\n*   Dans `AdminMercato.tsx`, nous allons nous assurer que la fonction `handleApproveRequest` traite l'agence `unassigned` de manière atomique.\n*   Initialisation explicite de tous les tableaux (`mercatoRequests`, `transactionRequests`, `eventLog`) pour éviter les erreurs de lecture Firestore ultérieures.\n\n**2. Nouvelle Vue FAQ (Feature) :**\n*   **Contenu** : Explication ludique de la VE (Valeur d'Entreprise), du PiXi (Cashflow), du mécanisme de gains (Facturation vs Salaires), et de l'objectif final (Levée de fonds).\n*   **Visuel** : Design en \"Cards\" avec icônes Lucide, intégré proprement dans le menu étudiant.\n*   **Accessibilité** : Ajout d'un bouton \"Aide / FAQ\" dans la navigation `StudentAgencyView`.\n\n",
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1767802467,
      "nanos": 143000000
    },
    "doneTimestamp": {
      "seconds": 1767802467,
      "nanos": 145000000
    }
  },
  {
    "id": 14,
    "author": "model",
    "payload": {
      "type": "generationTable",
      "entries": [
        {
          "path": "components/student/FAQView.tsx",
          "generationType": 1,
          "isDone": true,
          "description": "Création de la vue FAQ pour expliquer les mécaniques du jeu aux étudiants.",
          "diffs": [
            {
              "target": "",
              "replacement": "\nimport React from 'react';\nimport { HelpCircle, TrendingUp, Coins, Zap, ShieldAlert, Rocket, Info, Landmark } from 'lucide-react';\n\nexport const FAQView: React.FC = () => {\n    const sections = [\n        {\n            title: \"C'est quoi la VE ?\",\n            icon: <TrendingUp className=\"text-indigo-500\" />,\n            content: \"La Valeur d'Entreprise (VE) est votre 'Note de Groupe' dynamique. Elle commence à 0 et peut monter jusqu'à 100. Elle reflète la qualité de vos rendus, votre sérieux et votre réactivité face aux crises.\"\n        },\n        {\n            title: \"Le PiXi, c'est quoi ?\",\n            icon: <Coins className=\"text-yellow-500\" />,\n            content: \"Le PiXi est la monnaie officielle du studio. Il sert à payer votre loyer (500/semaine) et vos salaires personnels. Si votre compte est à sec, vos salaires sont gelés et votre VE chute (Malus de dette).\"\n        },\n        {\n            title: \"Comment gagne-t-on de l'argent ?\",\n            icon: <Zap className=\"text-emerald-500\" />,\n            content: \"Chaque semaine, votre studio facture ses clients. Le gain est calculé ainsi : (VE x 30) + Bonus Prof. Plus votre VE est haute, plus vos revenus hebdomadaires sont importants.\"\n        },\n        {\n            title: \"À quoi sert mon Wallet Perso ?\",\n            icon: <Landmark className=\"text-amber-600\" />,\n            content: \"L'argent que vous recevez sur votre compte personnel peut être ré-injecté dans le studio pour éponger une dette, ou utilisé pour acheter des points de Score (Formation) ou des bonus stratégiques (Délais, Infos).\"\n        },\n        {\n            title: \"Quelles sont les règles vitales ?\",\n            icon: <ShieldAlert className=\"text-red-500\" />,\n            content: \"1. Un rendu non fait = Chute de VE massive. 2. Une agence avec un seul membre est plafonnée à 60 VE (Plafond de verre). 3. Sous 40 VE, votre studio est 'Vulnérable' et peut être racheté par un concurrent.\"\n        },\n        {\n            title: \"L'Objectif Final ?\",\n            icon: <Rocket className=\"text-purple-500\" />,\n            content: \"Le but est d'arriver au Jury Final avec la plus grosse Levée de Fonds possible. Elle est calculée sur : Votre VE finale + Votre Trésorerie accumulée + La qualité de votre projet spatial.\"\n        }\n    ];\n\n    return (\n        <div className=\"animate-in slide-in-from-right-4 duration-500 pb-20 max-w-4xl mx-auto\">\n            <div className=\"mb-8 text-center\">\n                <div className=\"inline-flex p-3 bg-indigo-100 rounded-2xl text-indigo-600 mb-4\">\n                    <HelpCircle size={32} />\n                </div>\n                <h2 className=\"text-3xl font-display font-bold text-slate-900\">Guide de Survie du Studio</h2>\n                <p className=\"text-slate-500 mt-2\">Comprendre l'économie et les mécaniques du semestre.</p>\n            </div>\n\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n                {sections.map((item, idx) => (\n                    <div key={idx} className=\"bg-white p-6 rounded-3xl border border-slate-200 shadow-sm hover:shadow-md transition-all group\">\n                        <div className=\"flex items-center gap-4 mb-4\">\n                            <div className=\"p-3 bg-slate-50 rounded-xl group-hover:scale-110 transition-transform\">\n                                {item.icon}\n                            </div>\n                            <h3 className=\"font-bold text-slate-900\">{item.title}</h3>\n                        </div>\n                        <p className=\"text-sm text-slate-600 leading-relaxed\">\n                            {item.content}\n                        </p>\n                    </div>\n                ))}\n            </div>\n\n            <div className=\"mt-12 bg-slate-900 text-white p-8 rounded-[40px] relative overflow-hidden\">\n                <div className=\"absolute top-0 right-0 p-8 opacity-10\">\n                    <Info size={120} />\n                </div>\n                <div className=\"relative z-10\">\n                    <h4 className=\"text-xl font-bold mb-4 flex items-center gap-2\">\n                        <Info className=\"text-indigo-400\" /> Note de l'administration\n                    </h4>\n                    <p className=\"text-slate-300 text-sm leading-relaxed max-w-2xl\">\n                        Ce simulateur est une aide pédagogique. En cas de litige ou de bug, la décision de l'enseignant prévaut. L'économie est ajustée chaque semaine pour garantir l'équité entre les petites et grandes équipes.\n                    </p>\n                </div>\n            </div>\n        </div>\n    );\n};\n"
            }
          ]
        },
        {
          "path": "components/StudentAgencyView.tsx",
          "generationType": 1,
          "isDone": true,
          "description": "Intégration de la vue FAQ et ajout du bouton d'aide dans la navigation.",
          "diffs": [
            {
              "target": "",
              "replacement": "\nimport React, { useState, useEffect } from 'react';\nimport { Agency, BrandColor, Student, GameEvent } from '../types';\nimport { Target, Users, History, Wallet, TrendingUp, HelpCircle, Briefcase, Settings, Image as ImageIcon, Shield, Eye, Crown, BookOpen, Send, Repeat, ArrowUpRight, Building2, Zap, AlertTriangle, PartyPopper, Gavel, Landmark, Landmark as Bank } from 'lucide-react';\nimport { MarketOverview } from './student/MarketOverview';\nimport { MissionsView } from './student/MissionsView';\nimport { TeamView } from './student/TeamView';\nimport { HistoryView } from './student/HistoryView';\nimport { MercatoView } from './student/MercatoView';\nimport { WikiView } from './student/WikiView';\nimport { FAQView } from './student/FAQView';\nimport { Modal } from './Modal';\nimport { GAME_RULES, BADGE_DEFINITIONS } from '../constants';\nimport { ref, uploadBytes, getDownloadURL } from 'firebase/storage';\nimport { storage } from '../services/firebase';\nimport { useUI } from '../contexts/UIContext';\nimport { useAuth } from '../contexts/AuthContext';\nimport { useGame } from '../contexts/GameContext';\n\ninterface StudentViewProps {\n  agency: Agency;\n  allAgencies: Agency[];\n  onUpdateAgency: (agency: Agency) => void;\n}\n\ntype TabType = 'MARKET' | 'MISSIONS' | 'TEAM' | 'RECRUITMENT' | 'HISTORY' | 'RESOURCES' | 'WALLET' | 'HELP';\n\nconst COLOR_THEMES: Record<BrandColor, { bg: string, text: string }> = {\n    indigo: { bg: 'bg-indigo-600', text: 'text-indigo-600' },\n    emerald: { bg: 'bg-emerald-600', text: 'text-emerald-600' },\n    rose: { bg: 'bg-rose-600', text: 'text-rose-600' },\n    amber: { bg: 'bg-amber-500', text: 'text-amber-500' },\n    cyan: { bg: 'bg-cyan-500', text: 'text-cyan-500' },\n    slate: { bg: 'bg-slate-600', text: 'text-slate-600' },\n};\n\nexport const StudentAgencyView: React.FC<StudentViewProps> = ({ agency, allAgencies, onUpdateAgency }) => {\n  const { toast } = useUI();\n  const { currentUser } = useAuth();\n  const { transferFunds, injectCapital, requestScorePurchase, getCurrentGameWeek, updateAgenciesList } = useGame();\n  \n  const [activeTab, setActiveTab] = useState<TabType>('MARKET');\n  const [showVERules, setShowVERules] = useState(false);\n  const [showSettings, setShowSettings] = useState(false);\n  \n  const [unlockModal, setUnlockModal] = useState<{title: string, message: string, icon: any, confirmText: string} | null>(null);\n  const [notificationEvent, setNotificationEvent] = useState<GameEvent | null>(null);\n\n  const brandColor = agency.branding?.color || 'indigo';\n  const theme = COLOR_THEMES[brandColor];\n  const leaderboard = [...allAgencies].filter(a => a.id !== 'unassigned').sort((a, b) => b.ve_current - a.ve_current);\n  const myRank = leaderboard.findIndex(a => a.id === agency.id) + 1;\n  const rawSalary = agency.members.reduce((acc, member) => acc + (member.individualScore * GAME_RULES.SALARY_MULTIPLIER), 0);\n  const weeklyCharges = rawSalary * (1 + (agency.weeklyTax || 0)) + GAME_RULES.AGENCY_RENT;\n  const veRevenue = agency.ve_current * GAME_RULES.REVENUE_VE_MULTIPLIER;\n  const weeklyRevenue = GAME_RULES.REVENUE_BASE + veRevenue + (agency.weeklyRevenueModifier || 0);\n  const netWeekly = weeklyRevenue - weeklyCharges;\n  const myMemberProfile = agency.members.find(m => m.id === currentUser?.uid);\n\n  useEffect(() => {\n      const currentWeek = getCurrentGameWeek();\n      if (currentWeek >= GAME_RULES.UNLOCK_WEEK_BLACK_OPS) {\n          const hasSeenBlackOps = localStorage.getItem(`seen_unlock_blackops_${currentUser?.uid}`);\n          if (!hasSeenBlackOps) {\n              setUnlockModal({\n                  title: \"Intelligence Économique Activée\",\n                  message: \"Le marché se durcit. Vous avez désormais accès aux outils de veille stratégique.\\n\\nNouveauté : Audits concurrentiels et achat d'informations disponibles dans l'onglet 'Marché'.\",\n                  icon: <Eye size={32} className=\"text-yellow-500\"/>,\n                  confirmText: \"Compris, je reste vigilant\"\n              });\n              localStorage.setItem(`seen_unlock_blackops_${currentUser?.uid}`, 'true');\n              return; \n          }\n      }\n      if (currentWeek >= GAME_RULES.UNLOCK_WEEK_MERGERS) {\n          const hasSeenMergers = localStorage.getItem(`seen_unlock_mergers_${currentUser?.uid}`);\n          if (!hasSeenMergers) {\n              setUnlockModal({\n                  title: \"Fusions & Acquisitions (M&A)\",\n                  message: \"La consolidation du secteur commence. \\n\\nNouveauté : Il est désormais possible de racheter une agence en faillite (VE < 40) pour absorber ses talents et sa dette.\",\n                  icon: <Building2 size={32} className=\"text-indigo-500\"/>,\n                  confirmText: \"Voir les opportunités\"\n              });\n              localStorage.setItem(`seen_unlock_mergers_${currentUser?.uid}`, 'true');\n          }\n      }\n  }, [getCurrentGameWeek, currentUser]);\n\n  useEffect(() => {\n      if (agency.eventLog.length === 0) return;\n      const latestEvent = agency.eventLog[agency.eventLog.length - 1];\n      const NOTIFY_TYPES = ['CRISIS', 'VE_DELTA'];\n      if (NOTIFY_TYPES.includes(latestEvent.type)) {\n          const seenKey = `seen_event_${currentUser?.uid}_${latestEvent.id}`;\n          const hasSeen = localStorage.getItem(seenKey);\n          if (!hasSeen) setNotificationEvent(latestEvent);\n      }\n  }, [agency.eventLog, currentUser]);\n\n  const closeNotification = () => {\n      if (notificationEvent) {\n          localStorage.setItem(`seen_event_${currentUser?.uid}_${notificationEvent.id}`, 'true');\n          setNotificationEvent(null);\n      }\n  };\n\n  const handleColorChange = (color: BrandColor) => {\n      onUpdateAgency({ ...agency, branding: { ...agency.branding, color } });\n  };\n\n  const handleBannerUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {\n      if (e.target.files && e.target.files[0]) {\n          try {\n              const storageRef = ref(storage, `banners/${agency.id}_${Date.now()}`);\n              await uploadBytes(storageRef, e.target.files[0]);\n              const url = await getDownloadURL(storageRef);\n              onUpdateAgency({ ...agency, branding: { ...agency.branding, bannerUrl: url } });\n              toast('success', 'Bannière mise à jour');\n          } catch (error) { toast('error', \"Erreur d'upload\"); }\n      }\n  };\n\n  return (\n    <div className=\"flex flex-col min-h-[calc(100vh-6rem)] font-sans\">\n        {/* HEADER */}\n        <div className=\"relative mb-8 rounded-b-3xl md:rounded-3xl overflow-hidden bg-slate-100 min-h-[200px] md:min-h-[240px] shadow-md group\">\n            {agency.branding?.bannerUrl ? (\n                <img src={agency.branding.bannerUrl} className=\"absolute inset-0 w-full h-full object-cover\" alt=\"Banner\" />\n            ) : (\n                <div className={`absolute inset-0 opacity-10 ${theme.bg}`} style={{backgroundImage: 'radial-gradient(circle, #000 1px, transparent 1px)', backgroundSize: '20px 20px'}}></div>\n            )}\n            <div className=\"absolute inset-0 bg-gradient-to-t from-slate-900/90 via-slate-900/40 to-transparent\"></div>\n            {agency.id !== 'unassigned' && (\n                <button onClick={() => setShowSettings(true)} className=\"absolute top-4 right-4 p-2 bg-black/30 backdrop-blur-md rounded-full text-white hover:bg-black/50 transition-all opacity-0 group-hover:opacity-100 border border-white/10\">\n                    <Settings size={20}/>\n                </button>\n            )}\n            <div className=\"absolute bottom-0 left-0 right-0 p-6 flex flex-col xl:flex-row justify-between items-end xl:items-end gap-6 text-white\">\n                <div className=\"w-full xl:w-auto\">\n                    <div className=\"flex items-center gap-3 mb-1\">\n                        {agency.id !== 'unassigned' && <span className=\"bg-white/20 backdrop-blur border border-white/10 px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider\">Rang #{myRank}</span>}\n                        <span className=\"text-slate-300 italic text-sm truncate\">\"{agency.tagline}\"</span>\n                    </div>\n                    <h2 className=\"text-4xl md:text-5xl font-display font-bold tracking-tight drop-shadow-lg leading-none mb-3\">{agency.name}</h2>\n                    <div className=\"flex items-center gap-1\">\n                        {agency.badges && agency.badges.map(b => (\n                            <div key={b.id} title={b.label} className=\"w-6 h-6 rounded-full bg-yellow-400 text-yellow-900 flex items-center justify-center shadow-lg border border-yellow-200\"><Shield size={12}/></div>\n                        ))}\n                    </div>\n                </div>\n\n                {agency.id !== 'unassigned' && (\n                <div className=\"flex flex-col md:flex-row gap-4 w-full xl:w-auto bg-black/40 backdrop-blur-md p-4 rounded-2xl border border-white/10\">\n                    {myMemberProfile && (\n                        <div onClick={() => setActiveTab('WALLET')} className=\"flex-1 md:text-right md:border-r border-white/20 md:pr-4 cursor-pointer group hover:bg-white/10 rounded-lg p-1 transition-colors\">\n                            <span className=\"text-[10px] font-bold text-yellow-300 uppercase tracking-widest block mb-1 group-hover:underline flex items-center gap-1 md:justify-end\">\n                                <Wallet size={12}/> Mon Solde\n                            </span>\n                            <div className=\"text-lg font-bold text-white flex items-center md:justify-end gap-2\">\n                                <span className=\"text-yellow-400 font-mono\">{myMemberProfile.wallet || 0} PiXi</span>\n                            </div>\n                        </div>\n                    )}\n                    \n                    <div className=\"flex-1 md:text-right md:border-r border-white/20 md:pr-4\">\n                        <span className=\"text-[10px] font-bold text-indigo-300 uppercase tracking-widest block mb-1 flex items-center gap-1 md:justify-end\">\n                            <Landmark size={12}/> Trésorerie Studio\n                        </span>\n                        <div className=\"text-lg font-bold text-white flex items-center md:justify-end gap-2\">\n                            <span className={`font-mono ${agency.budget_real < 0 ? 'text-red-400' : 'text-white'}`}>{agency.budget_real} PiXi</span>\n                        </div>\n                    </div>\n\n                    <div className=\"flex items-center justify-between md:justify-start gap-6 pl-2\">\n                        <div className=\"text-center\">\n                            <span className=\"text-[10px] font-bold text-slate-300 uppercase tracking-widest block mb-1\">Flux Net</span>\n                            <div className={`text-xl font-bold ${netWeekly >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>{netWeekly > 0 ? '+' : ''}{netWeekly.toFixed(0)}</div>\n                        </div>\n                        <div className=\"text-center\">\n                            <div \n                                onClick={() => setShowVERules(true)}\n                                className=\"text-[10px] font-bold text-slate-300 uppercase tracking-widest mb-1 flex items-center gap-1 justify-center cursor-pointer hover:text-white\"\n                            >\n                                VE <HelpCircle size={10}/>\n                            </div>\n                            <div className={`text-3xl font-display font-bold leading-none ${agency.ve_current >= 60 ? 'text-emerald-400' : 'text-amber-400'}`}>{agency.ve_current}</div>\n                        </div>\n                    </div>\n                </div>\n                )}\n            </div>\n        </div>\n\n        {/* CONTENT */}\n        <div className=\"flex-1 mb-24 md:mb-8\">\n            {activeTab === 'MARKET' && agency.id !== 'unassigned' && <MarketOverview agency={agency} allAgencies={allAgencies} />}\n            {activeTab === 'MISSIONS' && agency.id !== 'unassigned' && <MissionsView agency={agency} onUpdateAgency={onUpdateAgency} />}\n            {activeTab === 'TEAM' && agency.id !== 'unassigned' && <TeamView agency={agency} onUpdateAgency={onUpdateAgency} />}\n            {activeTab === 'WALLET' && myMemberProfile && agency.id !== 'unassigned' && (\n                <WalletView \n                    student={myMemberProfile} \n                    agency={agency} \n                    allStudents={allAgencies.flatMap(a => a.members)}\n                    onTransfer={transferFunds}\n                    onInjectCapital={injectCapital}\n                    onRequestScore={requestScorePurchase}\n                />\n            )}\n            {(activeTab === 'RECRUITMENT' || agency.id === 'unassigned') && (\n              <MercatoView \n                agency={agency} \n                allAgencies={allAgencies} \n                onUpdateAgency={onUpdateAgency} \n                onUpdateAgencies={updateAgenciesList} \n              />\n            )}\n            {activeTab === 'RESOURCES' && <WikiView agency={agency} />}\n            {activeTab === 'HISTORY' && <HistoryView agency={agency} />}\n            {activeTab === 'HELP' && <FAQView />}\n        </div>\n\n        {/* FOOTER NAV */}\n        <div className=\"fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-md border-t border-slate-200 p-2 z-50 md:relative md:bg-transparent md:border-t-0 md:p-0 md:mt-auto safe-area-bottom\">\n             <div className=\"max-w-7xl mx-auto flex md:justify-start gap-2 md:gap-4 overflow-x-auto no-scrollbar snap-x justify-between\">\n                {agency.id !== 'unassigned' && (\n                    <>\n                        <NavButton active={activeTab === 'MARKET'} onClick={() => setActiveTab('MARKET')} icon={<TrendingUp size={20} />} label=\"Marché\" theme={theme} />\n                        <NavButton active={activeTab === 'MISSIONS'} onClick={() => setActiveTab('MISSIONS')} icon={<Target size={20} />} label=\"Missions\" theme={theme} />\n                        <NavButton active={activeTab === 'TEAM'} onClick={() => setActiveTab('TEAM')} icon={<Users size={20} />} label=\"Équipe\" theme={theme} />\n                        <NavButton active={activeTab === 'WALLET'} onClick={() => setActiveTab('WALLET')} icon={<Wallet size={20} />} label=\"Banque\" theme={theme} />\n                    </>\n                )}\n                <NavButton active={activeTab === 'RESOURCES'} onClick={() => setActiveTab('RESOURCES')} icon={<BookOpen size={20} />} label=\"Wiki\" theme={theme} />\n                <NavButton active={activeTab === 'RECRUITMENT' || agency.id === 'unassigned'} onClick={() => setActiveTab('RECRUITMENT')} icon={<Briefcase size={20} />} label={agency.id === 'unassigned' ? \"Mon Statut\" : \"Recrutement\"} theme={theme} />\n                <NavButton active={activeTab === 'HISTORY'} onClick={() => setActiveTab('HISTORY')} icon={<History size={20} />} label=\"Journal\" theme={theme} />\n                <NavButton active={activeTab === 'HELP'} onClick={() => setActiveTab('HELP')} icon={<HelpCircle size={20} />} label=\"Aide\" theme={theme} />\n             </div>\n        </div>\n\n        {/* MODALS */}\n        <Modal isOpen={showSettings} onClose={() => setShowSettings(false)} title=\"Personnalisation Agence\">\n            <div className=\"space-y-6\">\n                <div>\n                    <label className=\"block text-sm font-bold text-slate-700 mb-2\">Couleur de Marque</label>\n                    <div className=\"flex gap-3\">\n                        {(['indigo', 'emerald', 'rose', 'amber', 'cyan'] as BrandColor[]).map(c => (\n                            <button key={c} onClick={() => handleColorChange(c)} className={`w-10 h-10 rounded-full border-2 ${COLOR_THEMES[c].bg} ${brandColor === c ? 'ring-4 ring-offset-2 ring-slate-200 border-white' : 'border-transparent opacity-60 hover:opacity-100'}`} />\n                        ))}\n                    </div>\n                </div>\n                <div>\n                    <label className=\"block text-sm font-bold text-slate-700 mb-2\">Bannière (Cover)</label>\n                    <label className=\"flex flex-col items-center justify-center w-full h-32 border-2 border-slate-300 border-dashed rounded-xl cursor-pointer bg-slate-50 hover:bg-slate-100 transition-colors\">\n                        <div className=\"flex flex-col items-center justify-center pt-5 pb-6\">\n                            <ImageIcon className=\"w-8 h-8 text-slate-400 mb-2\" />\n                            <p className=\"text-sm text-slate-500\">Cliquez pour changer</p>\n                        </div>\n                        <input type=\"file\" className=\"hidden\" accept=\"image/*\" onChange={handleBannerUpload} />\n                    </label>\n                </div>\n            </div>\n        </Modal>\n        \n        <Modal isOpen={showVERules} onClose={() => setShowVERules(false)} title=\"Comprendre la VE\">\n            <div className=\"space-y-6\">\n                <div className=\"bg-slate-50 p-4 rounded-2xl border border-slate-100\">\n                    <p className=\"text-sm text-slate-600 leading-relaxed mb-2\">\n                        La <strong>Valeur d'Entreprise (VE)</strong> est votre \"note de groupe\" dynamique (/100). \n                        <br/>Elle fluctue selon vos rendus, vos choix et les événements.\n                    </p>\n                </div>\n            </div>\n        </Modal>\n\n        {unlockModal && (\n            <Modal isOpen={!!unlockModal} onClose={() => setUnlockModal(null)} title={unlockModal.title}>\n                <div className=\"flex flex-col items-center text-center space-y-6\">\n                    <div className=\"p-6 rounded-full bg-slate-100 mb-2\">\n                        {unlockModal.icon}\n                    </div>\n                    <p className=\"text-slate-600 text-lg leading-relaxed whitespace-pre-line\">\n                        {unlockModal.message}\n                    </p>\n                    <button \n                        onClick={() => setUnlockModal(null)}\n                        className=\"w-full py-4 bg-slate-900 text-white font-bold rounded-xl hover:bg-indigo-600 transition-colors shadow-lg\"\n                    >\n                        {unlockModal.confirmText}\n                    </button>\n                </div>\n            </Modal>\n        )}\n\n        {notificationEvent && (\n            <Modal isOpen={!!notificationEvent} onClose={closeNotification} title={notificationEvent.type === 'CRISIS' ? \"ALERTE PRIORITAIRE\" : \"NOUVELLE IMPORTANTE\"}>\n                <div className=\"flex flex-col items-center text-center space-y-6\">\n                    <div className={`p-6 rounded-full mb-2 border-4 ${\n                        notificationEvent.type === 'CRISIS' || (notificationEvent.deltaVE || 0) < 0\n                        ? 'bg-red-50 border-red-100 text-red-600 animate-pulse'\n                        : 'bg-emerald-50 border-emerald-100 text-emerald-600'\n                    }`}>\n                        {notificationEvent.type === 'CRISIS' || (notificationEvent.deltaVE || 0) < 0\n                            ? <AlertTriangle size={48} strokeWidth={2.5}/>\n                            : (notificationEvent.deltaVE || 0) > 5 ? <PartyPopper size={48} strokeWidth={2.5}/> : <Zap size={48} strokeWidth={2.5}/>\n                        }\n                    </div>\n\n                    <div>\n                        <h3 className={`text-2xl font-black uppercase mb-2 ${\n                            notificationEvent.type === 'CRISIS' || (notificationEvent.deltaVE || 0) < 0 ? 'text-red-600' : 'text-emerald-600'\n                        }`}>\n                            {notificationEvent.label}\n                        </h3>\n                        <p className=\"text-slate-600 text-lg leading-relaxed font-medium\">\n                            {notificationEvent.description}\n                        </p>\n                    </div>\n\n                    <button \n                        onClick={closeNotification}\n                        className={`w-full py-4 text-white font-bold rounded-xl shadow-lg transition-transform active:scale-95 ${\n                            notificationEvent.type === 'CRISIS' || (notificationEvent.deltaVE || 0) < 0\n                            ? 'bg-red-600 hover:bg-red-700 shadow-red-200'\n                            : 'bg-emerald-600 hover:bg-emerald-700 shadow-emerald-200'\n                        }`}\n                    >\n                        {notificationEvent.type === 'CRISIS' ? \"J'AI PRIS CONNAISSANCE\" : \"GÉNIAL !\"}\n                    </button>\n                </div>\n            </Modal>\n        )}\n    </div>\n  );\n};\n\nconst WalletView: React.FC<{student: Student, agency: Agency, allStudents: Student[], onTransfer: any, onInjectCapital: any, onRequestScore: any}> = ({student, agency, allStudents, onTransfer, onInjectCapital, onRequestScore}) => {\n    const [targetId, setTargetId] = useState('');\n    const [amount, setAmount] = useState(0);\n    const [scoreToBuy, setScoreToBuy] = useState(0);\n\n    const handleTransfer = async () => {\n        if(!targetId || amount <= 0) return;\n        await onTransfer(student.id, targetId, amount);\n        setAmount(0);\n    };\n\n    const handleInject = async () => {\n        if(amount <= 0) return;\n        await onInjectCapital(student.id, agency.id, amount);\n        setAmount(0);\n    };\n\n    const handleBuyScore = async () => {\n        if(scoreToBuy <= 0) return;\n        const cost = scoreToBuy * 200;\n        await onRequestScore(student.id, agency.id, cost, scoreToBuy);\n        setScoreToBuy(0);\n    };\n\n    return (\n        <div className=\"animate-in fade-in space-y-6\">\n            {/* AGENCY TREASURY CARD - VERY VISIBLE NOW */}\n            <div className=\"bg-slate-900 rounded-3xl p-6 border border-slate-700 shadow-xl flex flex-col md:flex-row justify-between items-center gap-6\">\n                <div className=\"flex items-center gap-4\">\n                    <div className=\"p-4 bg-indigo-500/20 rounded-2xl text-indigo-400 border border-indigo-500/30\">\n                        <Bank size={32}/>\n                    </div>\n                    <div>\n                        <p className=\"text-indigo-300 text-xs font-bold uppercase tracking-widest\">Trésorerie de l'Entreprise</p>\n                        <p className=\"text-3xl font-display font-bold text-white\">{agency.budget_real} <span className=\"text-sm text-slate-500\">PiXi</span></p>\n                    </div>\n                </div>\n                <div className=\"flex flex-col items-center md:items-end\">\n                    <p className=\"text-slate-500 text-xs uppercase font-bold mb-1\">Santé Financière</p>\n                    <div className={`px-4 py-1.5 rounded-full text-xs font-bold border ${\n                        agency.budget_real > 1000 ? 'bg-emerald-500/10 text-emerald-400 border-emerald-500/20' : \n                        agency.budget_real > 0 ? 'bg-amber-500/10 text-amber-400 border-amber-500/20' : \n                        'bg-red-500/10 text-red-400 border-red-500/20 animate-pulse'\n                    }`}>\n                        {agency.budget_real > 1000 ? 'SOLVABLE' : agency.budget_real > 0 ? 'FRAGILE' : 'ENDETTÉ'}\n                    </div>\n                </div>\n            </div>\n\n            <div className=\"bg-indigo-600 text-white p-8 rounded-3xl shadow-lg flex flex-col md:flex-row justify-between items-center relative overflow-hidden\">\n                <div className=\"absolute top-0 right-0 p-20 bg-white/5 rounded-full blur-3xl transform translate-x-10 -translate-y-10\"></div>\n                <div className=\"relative z-10 text-center md:text-left mb-4 md:mb-0\">\n                    <p className=\"text-indigo-200 text-sm font-bold uppercase mb-1 tracking-widest\">Mon Solde Personnel</p>\n                    <p className=\"text-5xl font-display font-bold text-yellow-400\">{student?.wallet || 0} <span className=\"text-2xl text-yellow-200\">PiXi</span></p>\n                </div>\n                <div className=\"relative z-10 bg-white/10 p-4 rounded-xl backdrop-blur-sm border border-white/20\">\n                    <p className=\"text-xs text-indigo-100 mb-1\">Salaire Hebdo</p>\n                    <p className=\"font-bold text-white text-lg\">+{student.individualScore * GAME_RULES.SALARY_MULTIPLIER} PiXi</p>\n                </div>\n            </div>\n\n            <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n                <div className=\"bg-white p-6 rounded-2xl border border-slate-200 shadow-sm flex flex-col\">\n                    <div className=\"mb-4\">\n                        <div className=\"w-12 h-12 bg-emerald-100 rounded-full flex items-center justify-center text-emerald-600 mb-3\">\n                            <ArrowUpRight size={24}/>\n                        </div>\n                        <h3 className=\"font-bold text-slate-900 text-lg\">Investir dans mon Agence</h3>\n                        <p className=\"text-sm text-slate-500 mt-1\">Injection de fonds personnels.</p>\n                    </div>\n                    <div className=\"mt-auto space-y-3\">\n                        <input type=\"number\" className=\"w-full p-3 rounded-xl border border-slate-200 font-bold bg-slate-50\" placeholder=\"Montant\" onChange={e => setAmount(Number(e.target.value))} />\n                        <button onClick={handleInject} disabled={amount <= 0 || amount > (student.wallet || 0)} className=\"w-full py-3 bg-emerald-600 text-white font-bold rounded-xl hover:bg-emerald-700 transition-colors disabled:opacity-50\">Injecter</button>\n                    </div>\n                </div>\n\n                <div className=\"bg-white p-6 rounded-2xl border border-slate-200 shadow-sm flex flex-col\">\n                    <div className=\"mb-4\">\n                        <div className=\"w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center text-indigo-600 mb-3\">\n                            <Send size={24}/>\n                        </div>\n                        <h3 className=\"font-bold text-slate-900 text-lg\">Virement à un collègue</h3>\n                        <p className=\"text-sm text-slate-500 mt-1\">Soutien inter-agences.</p>\n                    </div>\n                    <div className=\"mt-auto space-y-3\">\n                        <select className=\"w-full p-3 rounded-xl border border-slate-200 bg-white text-sm\" onChange={e => setTargetId(e.target.value)} value={targetId}>\n                            <option value=\"\">-- Bénéficiaire --</option>\n                            {allStudents.filter(s => s.id !== student.id).map(s => (\n                                <option key={s.id} value={s.id}>{s.name}</option>\n                            ))}\n                        </select>\n                        <input type=\"number\" className=\"w-full p-3 rounded-xl border border-slate-200 font-bold bg-slate-50\" placeholder=\"Montant\" onChange={e => setAmount(Number(e.target.value))} />\n                        <button onClick={handleTransfer} disabled={amount <= 0 || amount > (student.wallet || 0)} className=\"w-full py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 transition-colors disabled:opacity-50\">Envoyer</button>\n                    </div>\n                </div>\n\n                <div className=\"bg-white p-6 rounded-2xl border border-slate-200 shadow-sm flex flex-col\">\n                    <div className=\"mb-4\">\n                        <div className=\"w-12 h-12 bg-amber-100 rounded-full flex items-center justify-center text-amber-600 mb-3\">\n                            <TrendingUp size={24}/>\n                        </div>\n                        <h3 className=\"font-bold text-slate-900 text-lg\">Achat Score (Formation)</h3>\n                        <p className=\"text-sm text-slate-500 mt-1\">200 PiXi = 1 Point Score.</p>\n                    </div>\n                    <div className=\"mt-auto space-y-3\">\n                        <input type=\"number\" className=\"w-full p-3 rounded-xl border border-slate-200 font-bold bg-slate-50\" placeholder=\"Points voulus\" onChange={e => setScoreToBuy(Number(e.target.value))} />\n                        <button onClick={handleBuyScore} disabled={scoreToBuy <= 0 || (scoreToBuy * 200) > (student.wallet || 0)} className=\"w-full py-3 bg-amber-500 text-white font-bold rounded-xl hover:bg-amber-600 transition-colors disabled:opacity-50\">Acheter</button>\n                    </div>\n                </div>\n            </div>\n        </div>\n    );\n};\n\nconst NavButton: React.FC<any> = ({ active, onClick, icon, label, theme }) => (\n    <button onClick={onClick} className={`snap-start flex flex-col md:flex-row items-center md:gap-3 p-2 md:p-4 rounded-xl transition-all min-w-[70px] md:min-w-[150px] justify-center md:justify-start ${active ? `${theme.bg} text-white transform scale-105 shadow-md` : 'hover:bg-slate-50 text-slate-400 hover:text-slate-600'}`}>\n        <div className={`p-1.5 rounded-full ${active ? 'bg-white/20' : ''}`}>{React.cloneElement(icon, { className: active ? 'text-white' : '' })}</div>\n        <span className={`text-[10px] md:text-base font-bold`}>{label}</span>\n    </button>\n);\n"
            }
          ]
        },
        {
          "path": "components/AdminMercato.tsx",
          "generationType": 1,
          "isDone": true,
          "description": "Correction de handleApproveRequest pour garantir que la nouvelle agence est créée avec toutes ses propriétés et que l'utilisateur est retiré de unassigned.",
          "diffs": [
            {
              "target": "",
              "replacement": "\nimport React, { useState, useMemo } from 'react';\nimport { Agency, GameEvent, MercatoRequest, StudentHistoryEntry, CycleType } from '../types';\nimport { ArrowRightLeft, UserPlus, UserMinus, Briefcase, Plus, AlertCircle, Check, X, FileSearch, UserX, Coins, Quote, User, Info, Building2 } from 'lucide-react';\nimport { useUI } from '../contexts/UIContext';\nimport { GAME_RULES, INITIAL_WEEKS } from '../constants';\n\ninterface AdminMercatoProps {\n  agencies: Agency[];\n  onUpdateAgencies: (agencies: Agency[]) => void;\n  readOnly?: boolean;\n}\n\nexport const AdminMercato: React.FC<AdminMercatoProps> = ({ agencies, onUpdateAgencies, readOnly }) => {\n  const { confirm, toast } = useUI();\n  const [selectedStudentId, setSelectedStudentId] = useState<string | null>(null);\n  const [targetAgencyId, setTargetAgencyId] = useState<string | null>(null);\n\n  const unassignedAgency = agencies.find(a => a.id === 'unassigned');\n  const activeAgencies = agencies.filter(a => a.id !== 'unassigned');\n\n  const pendingRequests = useMemo(() => {\n      const requests: {req: MercatoRequest, agency: Agency}[] = [];\n      agencies.forEach(a => {\n          (a.mercatoRequests || []).forEach(r => {\n              if (r.status === 'PENDING') requests.push({req: r, agency: a});\n          });\n      });\n      return requests;\n  }, [agencies]);\n\n  const findStudentData = (studentId: string) => {\n    for (const agency of agencies) {\n        const student = agency.members.find(m => m.id === studentId);\n        if (student) return { student, agency };\n    }\n    return null;\n  };\n\n  const calculateFiringVEDelta = (score: number) => {\n      if (score < 30) return 10;\n      if (score < 50) return 5;\n      if (score < 70) return -5;\n      if (score < 90) return -15;\n      return -25;\n  };\n\n  const executeTransfer = (studentId: string, sourceAgencyId: string, targetAgencyId: string, transferType: 'HIRE' | 'FIRE' | 'TRANSFER', reason?: string) => {\n    const sourceAgency = agencies.find(a => a.id === sourceAgencyId);\n    const targetAgency = agencies.find(a => a.id === targetAgencyId);\n    const student = sourceAgency?.members.find(m => m.id === studentId);\n\n    if (!sourceAgency || !targetAgency || !student) return;\n\n    const today = new Date().toISOString().split('T')[0];\n    const newHistory: StudentHistoryEntry[] = [...(student.history || [])];\n    \n    if (sourceAgencyId !== 'unassigned') {\n        newHistory.push({\n            date: today, agencyId: sourceAgency.id, agencyName: sourceAgency.name,\n            action: transferType === 'FIRE' ? 'FIRED' : 'LEFT',\n            contextVE: sourceAgency.ve_current, contextBudget: sourceAgency.budget_real,\n            reason: reason || (transferType === 'FIRE' ? \"Licenciement\" : \"Départ\")\n        });\n    }\n\n    if (targetAgencyId !== 'unassigned') {\n        newHistory.push({\n            date: today, agencyId: targetAgency.id, agencyName: targetAgency.name,\n            action: 'JOINED', contextVE: targetAgency.ve_current, contextBudget: targetAgency.budget_real,\n            reason: reason || \"Recrutement\"\n        });\n    }\n\n    const updatedStudent = { ...student, history: newHistory };\n    const updatedSourceMembers = sourceAgency.members.filter(m => m.id !== student.id);\n    const updatedSource = { ...sourceAgency, members: updatedSourceMembers };\n    const updatedTargetMembers = [...targetAgency.members, updatedStudent];\n    const updatedTarget = { ...targetAgency, members: updatedTargetMembers };\n\n    let eventSource: GameEvent | null = null;\n    let eventTarget: GameEvent | null = null;\n    let sourceVEDelta = 0;\n    let targetVEDelta = 0;\n\n    if (transferType === 'FIRE') {\n        sourceVEDelta = calculateFiringVEDelta(student.individualScore);\n        let label = sourceVEDelta > 0 ? \"Restructuration\" : \"Perte Compétence\";\n        eventSource = {\n            id: `evt-${Date.now()}-1`, date: today, type: sourceVEDelta > 0 ? 'VE_DELTA' : 'CRISIS',\n            label: label, deltaVE: sourceVEDelta,\n            description: `Départ de ${student.name}.`\n        };\n    } else if (transferType === 'HIRE') {\n        targetVEDelta = -5;\n        eventTarget = {\n            id: `evt-${Date.now()}-2`, date: today, type: 'VE_DELTA', label: 'Recrutement Ext.', deltaVE: targetVEDelta,\n            description: `${student.name} rejoint l'équipe.`\n        };\n    }\n\n    if (eventSource && sourceAgency.id !== 'unassigned') {\n        updatedSource.eventLog = [...updatedSource.eventLog, eventSource];\n        updatedSource.ve_current = Math.max(0, updatedSource.ve_current + sourceVEDelta);\n    }\n    if (eventTarget && targetAgency.id !== 'unassigned') {\n        updatedTarget.eventLog = [...updatedTarget.eventLog, eventTarget];\n        updatedTarget.ve_current = Math.max(0, updatedTarget.ve_current + targetVEDelta);\n    }\n\n    return agencies.map(a => \n        a.id === sourceAgency.id ? updatedSource : \n        a.id === targetAgency.id ? updatedTarget : a\n    );\n  }\n\n  const handleManualTransfer = async () => {\n     if(readOnly) return;\n     if (!selectedStudentId || !targetAgencyId) return;\n     const sourceData = findStudentData(selectedStudentId);\n     if (!sourceData) return;\n\n     const student = sourceData.student;\n     const targetAgency = agencies.find(a => a.id === targetAgencyId);\n     \n     if (targetAgency && targetAgency.id !== 'unassigned' && targetAgency.classId !== student.classId) {\n         toast('error', `Classes incompatibles (Étudiant ${student.classId} -> Agence ${targetAgency.classId})`);\n         return;\n     }\n     \n     const type = sourceData.agency.id === 'unassigned' ? 'HIRE' : targetAgencyId === 'unassigned' ? 'FIRE' : 'TRANSFER';\n     const confirmed = await confirm({\n         title: \"Confirmation de Mouvement RH\",\n         message: `Forcer le mouvement de ${student.name} ?\\nDe ${sourceData.agency.name} vers ${targetAgency?.name || 'Chômage'}`,\n         confirmText: \"Valider\", isDangerous: type === 'FIRE'\n     });\n\n     if (!confirmed) return;\n\n     const newAgencies = executeTransfer(selectedStudentId, sourceData.agency.id, targetAgencyId, type, \"Action Admin\");\n     if(newAgencies) {\n         onUpdateAgencies(newAgencies);\n         toast('success', `Transfert effectué`);\n         setSelectedStudentId(null); setTargetAgencyId(null);\n     }\n  };\n\n  const handleApproveRequest = async (request: MercatoRequest, requestAgency: Agency) => {\n      if(readOnly) return;\n      \n      if (request.type === 'FOUND_AGENCY') {\n          const studentData = findStudentData(request.studentId);\n          if(!studentData) return;\n          \n          const student = studentData.student;\n          const newAgencyId = `a-${Date.now()}`;\n          \n          // CRÉATION DE LA NOUVELLE AGENCE\n          const newAgency: Agency = {\n              id: newAgencyId, \n              name: `Studio de ${student.name}`, \n              tagline: \"Nouveau projet en cours...\", \n              ve_current: 20, \n              status: 'critique',\n              classId: student.classId, \n              budget_real: 2000, \n              budget_valued: 0, \n              weeklyTax: 0, \n              weeklyRevenueModifier: 0,\n              members: [{\n                  ...student,\n                  wallet: (student.wallet || 0) - GAME_RULES.CREATION_COST_PIXI,\n                  individualScore: Math.max(0, student.individualScore - GAME_RULES.CREATION_COST_SCORE)\n              }], \n              peerReviews: [], \n              eventLog: [{ \n                  id: `e-${newAgencyId}-1`, \n                  date: new Date().toISOString().split('T')[0], \n                  type: \"INFO\", \n                  label: \"Ouverture Studio\", \n                  deltaVE: 0, \n                  description: `Fondé par ${student.name}.` \n              }],\n              currentCycle: CycleType.MARQUE_BRIEF, \n              constraints: { space: \"À définir\", style: \"À définir\", client: \"À définir\" },\n              projectDef: { problem: \"\", target: \"\", location: \"\", gesture: \"\", isLocked: false },\n              mercatoRequests: [], \n              transactionRequests: [], \n              mergerRequests: [],\n              branding: { color: student.classId === 'A' ? 'indigo' : 'cyan' }, \n              badges: [], \n              progress: JSON.parse(JSON.stringify(INITIAL_WEEKS))\n          };\n\n          // MISE À JOUR ATOMIQUE DE TOUTES LES AGENCES\n          const updatedAgencies = agencies.map(a => {\n              if (a.id === 'unassigned') {\n                  return { \n                      ...a, \n                      members: a.members.filter(m => m.id !== student.id), \n                      mercatoRequests: a.mercatoRequests.filter(r => r.id !== request.id) \n                  };\n              }\n              return a;\n          });\n\n          onUpdateAgencies([...updatedAgencies, newAgency]);\n          toast('success', `Studio créé pour ${student.name}`);\n          return;\n      }\n\n      let newAgencies: Agency[] | undefined;\n      const studentData = findStudentData(request.studentId);\n      if(!studentData) return;\n\n      if (request.type === 'FIRE') {\n          newAgencies = executeTransfer(request.studentId, request.targetAgencyId, 'unassigned', 'FIRE', request.motivation);\n      } else if (request.type === 'HIRE') {\n          newAgencies = executeTransfer(request.studentId, studentData.agency.id, request.targetAgencyId, 'HIRE', request.motivation);\n      }\n\n      if (newAgencies) {\n          const finalAgencies = newAgencies.map(a => {\n             if (a.id === requestAgency.id) {\n                 return { ...a, mercatoRequests: a.mercatoRequests.filter(r => r.id !== request.id) };\n             }\n             return a;\n          });\n          onUpdateAgencies(finalAgencies);\n          toast('success', 'Demande validée.');\n      }\n  };\n\n  const handleRejectRequest = (request: MercatoRequest, requestAgency: Agency) => {\n      if(readOnly) return;\n      const updatedAgency = { ...requestAgency, mercatoRequests: requestAgency.mercatoRequests.filter(r => r.id !== request.id) };\n      onUpdateAgencies(agencies.map(a => a.id === updatedAgency.id ? updatedAgency : a));\n      toast('info', 'Demande rejetée.');\n  };\n\n  const handleCreateAgencyManual = async () => {\n      if(readOnly) return;\n      const newAgencyId = `a-manual-${Date.now()}`;\n      \n      const proceed = await confirm({\n          title: \"Créer un nouveau studio ?\",\n          message: \"Voulez-vous créer une agence vide ? Vous devrez y transférer des membres manuellement ensuite.\",\n          confirmText: \"Créer Agence\"\n      });\n\n      if (!proceed) return;\n\n      const newAgency: Agency = {\n          id: newAgencyId, \n          name: \"Nouveau Studio Admin\", \n          tagline: \"En construction...\", \n          ve_current: 20, \n          status: 'critique',\n          classId: 'A', \n          budget_real: 2000, \n          budget_valued: 0, \n          weeklyTax: 0, \n          weeklyRevenueModifier: 0,\n          members: [], \n          peerReviews: [], \n          eventLog: [{ id: `e-${newAgencyId}-1`, date: new Date().toISOString().split('T')[0], type: \"INFO\", label: \"Ouverture Studio\", deltaVE: 0, description: \"Action administrative.\" }],\n          currentCycle: CycleType.MARQUE_BRIEF, \n          constraints: { space: \"À définir\", style: \"À définir\", client: \"À définir\" },\n          projectDef: { problem: \"\", target: \"\", location: \"\", gesture: \"\", isLocked: false },\n          mercatoRequests: [], \n          transactionRequests: [], \n          mergerRequests: [],\n          branding: { color: 'indigo' }, \n          badges: [], \n          progress: JSON.parse(JSON.stringify(INITIAL_WEEKS))\n      };\n\n      onUpdateAgencies([...agencies, newAgency]);\n      toast('success', 'Studio créé.');\n  };\n\n  return (\n    <div className=\"animate-in fade-in duration-500 pb-20\">\n        <div className=\"flex justify-between items-center mb-6\">\n            <div>\n                <h2 className=\"text-3xl font-display font-bold text-slate-900\">Mercato & RH</h2>\n                <p className=\"text-slate-500 text-sm\">Gérez les candidatures et les nouveaux studios.</p>\n            </div>\n            {!readOnly && (\n                <button onClick={handleCreateAgencyManual} className=\"bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-xl font-bold text-sm flex items-center gap-2 transition-colors shadow-lg\">\n                    <Plus size={18} /> Créer un Studio Vide\n                </button>\n            )}\n        </div>\n\n        {/* --- SECTION: PENDING REQUESTS --- */}\n        {pendingRequests.length > 0 && (\n            <div className=\"mb-8 bg-amber-50 border border-amber-200 rounded-2xl p-6\">\n                <h3 className=\"text-amber-800 font-bold flex items-center gap-2 mb-4\">\n                    <AlertCircle size={20}/> Demandes en attente ({pendingRequests.length})\n                </h3>\n                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n                    {pendingRequests.map(({req, agency}) => {\n                        const studentData = findStudentData(req.studentId);\n                        const student = studentData?.student;\n                        const isFoundation = req.type === 'FOUND_AGENCY';\n\n                        return (\n                            <div key={req.id} className=\"bg-white p-4 rounded-xl border border-amber-100 shadow-sm flex flex-col gap-2\">\n                                <div className=\"flex justify-between items-start\">\n                                    <div className=\"flex items-center gap-2\">\n                                        <span className={`text-[10px] font-bold px-2 py-0.5 rounded-md uppercase ${\n                                            isFoundation ? 'bg-purple-600 text-white' : \n                                            req.type === 'HIRE' ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'\n                                        }`}>\n                                            {isFoundation ? 'Fondation Studio' : req.type === 'HIRE' ? 'Embauche' : 'Départ'}\n                                        </span>\n                                        <span className=\"text-[10px] bg-slate-100 text-slate-500 px-1 rounded font-bold\">Cl. {student?.classId}</span>\n                                    </div>\n                                    {!readOnly && (\n                                    <div className=\"flex gap-1\">\n                                        <button onClick={() => handleRejectRequest(req, agency)} className=\"p-1.5 bg-slate-100 hover:bg-red-100 text-slate-400 hover:text-red-600 rounded-lg\"><X size={16}/></button>\n                                        <button onClick={() => handleApproveRequest(req, agency)} className=\"p-1.5 bg-slate-900 hover:bg-emerald-600 text-white rounded-lg\"><Check size={16}/></button>\n                                    </div>\n                                    )}\n                                </div>\n\n                                <div className=\"mt-1\">\n                                    <p className=\"font-bold text-slate-900 text-sm\">\n                                        {req.studentName}\n                                        <span className=\"block text-[10px] text-slate-400 font-normal mt-0.5\">\n                                            {isFoundation ? `veut fonder sa propre agence (-${GAME_RULES.CREATION_COST_PIXI} PiXi)` : `cible : ${agency.name}`}\n                                        </span>\n                                    </p>\n                                    {req.motivation && (\n                                        <div className=\"bg-slate-50 p-2 rounded-lg mt-2 flex gap-2 border border-slate-100\">\n                                            <Quote size={12} className=\"text-slate-300 shrink-0\"/>\n                                            <p className=\"text-xs text-slate-600 italic\">\"{req.motivation}\"</p>\n                                        </div>\n                                    )}\n                                </div>\n                            </div>\n                        );\n                    })}\n                </div>\n            </div>\n        )}\n\n        <div className=\"grid grid-cols-1 md:grid-cols-12 gap-6\">\n            <div className=\"md:col-span-12\">\n                <h3 className=\"text-sm font-bold text-slate-500 uppercase tracking-widest mb-3 flex items-center gap-2\">\n                    <Briefcase size={16}/> Vivier / Pôle Chômage\n                </h3>\n                <div className={`border-2 border-dashed rounded-2xl p-4 mb-8 transition-colors ${targetAgencyId === 'unassigned' ? 'bg-red-50 border-red-300' : 'bg-slate-100 border-slate-300'}`}>\n                    <div className=\"flex justify-between items-center mb-4\">\n                        <p className=\"text-sm text-slate-500 italic\">Cliquez sur un étudiant pour le sélectionner, puis choisissez une destination.</p>\n                        <button onClick={() => !readOnly && setTargetAgencyId('unassigned')} disabled={readOnly} className={`px-4 py-2 rounded-lg text-xs font-bold transition-all ${targetAgencyId === 'unassigned' ? 'bg-red-600 text-white' : 'bg-white text-slate-600 border border-slate-200'}`}>\n                            Action: Licencier\n                        </button>\n                    </div>\n                    <div className=\"flex flex-wrap gap-3\">\n                        {unassignedAgency?.members.map(student => (\n                            <div key={student.id} onClick={() => !readOnly && setSelectedStudentId(student.id)} className={`flex items-center gap-3 p-3 rounded-xl border-2 transition-all cursor-pointer ${selectedStudentId === student.id ? 'bg-white border-indigo-500 shadow-md transform scale-105' : 'bg-white border-slate-200'}`}>\n                                <img src={student.avatarUrl} className=\"w-8 h-8 rounded-full grayscale\" />\n                                <div>\n                                    <p className=\"font-bold text-slate-700 text-sm leading-none\">{student.name}</p>\n                                    <span className={`text-[9px] font-bold px-1.5 rounded text-white ${student.classId === 'A' ? 'bg-blue-400' : 'bg-purple-400'}`}>CLASSE {student.classId}</span>\n                                </div>\n                            </div>\n                        ))}\n                    </div>\n                </div>\n\n                <h3 className=\"text-sm font-bold text-slate-500 uppercase tracking-widest mb-3 flex items-center gap-2\"><UserPlus size={16}/> Agences Actives</h3>\n                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\n                    {activeAgencies.map(agency => (\n                        <div key={agency.id} className={`bg-white rounded-2xl border transition-all relative overflow-hidden ${targetAgencyId === agency.id ? 'border-indigo-500 shadow-lg ring-2 ring-indigo-100' : 'border-slate-200 hover:border-slate-300'}`}>\n                            <div className={`absolute top-0 left-0 right-0 h-1 ${agency.classId === 'A' ? 'bg-blue-400' : 'bg-purple-400'}`}></div>\n                            <div onClick={() => !readOnly && setTargetAgencyId(agency.id)} className={`p-4 border-b border-slate-100 flex justify-between items-center rounded-t-2xl mt-1 transition-colors cursor-pointer ${targetAgencyId === agency.id ? 'bg-indigo-50' : 'bg-slate-50'}`}>\n                                <div>\n                                    <h4 className=\"font-bold text-slate-700\">{agency.name}</h4>\n                                    <span className=\"text-[10px] font-bold px-1.5 py-0.5 rounded bg-slate-200 text-slate-600\">CLASSE {agency.classId}</span>\n                                </div>\n                                {targetAgencyId === agency.id && <span className=\"text-[10px] bg-indigo-200 text-indigo-800 px-2 rounded-full font-bold\">Cible</span>}\n                            </div>\n                            <div className=\"p-4 space-y-2\">\n                                {agency.members.map(student => (\n                                    <div key={student.id} onClick={(e) => { e.stopPropagation(); if(!readOnly) setSelectedStudentId(student.id); }} className={`flex items-center gap-3 p-2 rounded-xl transition-all cursor-pointer ${selectedStudentId === student.id ? 'bg-indigo-600 text-white shadow-md' : 'hover:bg-slate-50 text-slate-700'}`}>\n                                        <img src={student.avatarUrl} className=\"w-8 h-8 rounded-full\" />\n                                        <div className=\"flex-1\">\n                                            <p className=\"font-bold text-sm leading-none\">{student.name}</p>\n                                            <p className=\"text-[10px] mt-0.5 opacity-70\">{student.role}</p>\n                                        </div>\n                                    </div>\n                                ))}\n                            </div>\n                        </div>\n                    ))}\n                </div>\n            </div>\n        </div>\n        \n        {!readOnly && selectedStudentId && targetAgencyId && (\n        <div className=\"fixed bottom-6 left-1/2 transform -translate-x-1/2 md:ml-32 bg-slate-900 text-white px-6 py-4 rounded-2xl shadow-2xl flex items-center gap-6 z-50\">\n            <div className=\"flex items-center gap-3\">\n                 <div className=\"text-right\">\n                    <span className=\"block text-[10px] text-slate-400 uppercase font-bold\">Source: {findStudentData(selectedStudentId)?.agency.name}</span>\n                 </div>\n                 <ArrowRightLeft className=\"text-slate-500\" />\n                 <div>\n                    <span className=\"block text-[10px] text-slate-400 uppercase font-bold\">Cible: {targetAgencyId === 'unassigned' ? 'Chômage' : agencies.find(a => a.id === targetAgencyId)?.name}</span>\n                 </div>\n            </div>\n            <button onClick={handleManualTransfer} className=\"bg-white text-slate-900 px-6 py-2 rounded-xl font-bold text-sm hover:bg-indigo-50\">Transférer (Force)</button>\n        </div>\n        )}\n    </div>\n  );\n};\n"
            }
          ]
        }
      ]
    },
    "createdTimestamp": {
      "seconds": 1767802468,
      "nanos": 626000000
    },
    "doneTimestamp": {
      "seconds": 1767802475,
      "nanos": 466000000
    }
  },
  {
    "id": 15,
    "author": "user",
    "payload": {
      "type": "text",
      "text": "le bouton créer un studio n'est pas clair chez le mode enseignant\nje n'ai pas la liberté de choisir dans quelle classe je crée l'agence, qui paie la création (moi, ou un étudiant, qui devient donc le premier membre), ni qui est inscrit directement dans l'entreprise",
      "files": [],
      "fileUploads": [],
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1767803198,
      "nanos": 778000000
    }
  },
  {
    "id": 16,
    "author": "model",
    "payload": {
      "type": "thinking",
      "text": "**Examining the Core Issue**\n\nI've been drilling down on the \"Create Studio\" button's design in Admin mode. The main problem is its lack of clarity and flexibility. Specifically, it needs the ability to assign the studio to a specific class, A or B.\n\n\n**Refining the UI/UX**\n\nI'm focused on the \"Create Studio\" process in `AdminMercato.tsx`. The design's evolved: the simple button becomes a modal-trigger. The modal includes a name field and class selection (radio buttons). I am also working through the logic. The UI handles the new fields for founder selection and payment responsibility, adding more flexibility. The payment options allow Admin or student cost.\n\n\n**Defining Additional Features**\n\nI am now focusing on the \"Founder Mode\" and its associated cost handling. I am adding a toggle for founder selection.  The two options are \"Admin / Vide\" (no cost, empty initial membership) and \"Étudiant Fondateur\" (select a student). I'm also adding logic for cost handling: a \"Facturer l'étudiant ?\" checkbox controls whether the student's wallet is updated and the initial student is deducted PiXi/Score. I'm also updating the `handleCreateAgency` logic.\n\n\n**Implementing the Modal**\n\nI'm now integrating the modal's internal mechanics. I've defined state variables for its visibility and form data, making sure to also integrate a new helper to retrieve `unassignedAgency` for the founder list. I am also working on `handleCreateAgency`.\n\n\n**Finalizing the Implementation**\n\nI'm now in the final stages, addressing user feedback directly. I've updated the \"Create Studio\" button's text to \"Ouvrir un Nouveau Studio.\" I've added a class selector, a \"Apply Cost\" toggle, and a founder selector. The modal construction is complete, and I've modified `AdminMercato.tsx` and added the `CreateAgencyModal`. I've added a fix for removing founders from unassigned agencies if they are moved, and fixed the default name. I'm focusing now on the final code structure and review.\n\n\n**Generating the XML Response**\n\nI'm now generating the XML, ensuring correct `Modal` import and including `GAME_RULES` for cost display.\n\nI am now focusing on French translation for all labels and toasts to ensure alignment with requirements. I am now working on modifications to the `AdminMercato.tsx` file, removing `handleCreateAgencyManual`, adding state for modal visibility and form data, and incorporating new submit logic and rendering the modal. The main button will now open the new modal.\n\n\n",
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1767803198,
      "nanos": 779000000
    },
    "doneTimestamp": {
      "seconds": 1767803223,
      "nanos": 263000000
    }
  },
  {
    "id": 17,
    "author": "model",
    "payload": {
      "type": "text",
      "text": "C'est noté. Le bouton actuel \"Créer un studio vide\" était effectivement un raccourci de développement trop simpliste.\n\nJe vais remplacer ce bouton par une **Modale de Création Avancée** qui vous donnera le contrôle total sur :\n1.  **Le Nom** du studio.\n2.  **La Classe** cible (A ou B).\n3.  **Le Fondateur** (soit \"Personne\" pour un studio vide, soit un étudiant du vivier).\n4.  **Le Financement** (soit \"Subvention Admin\" = gratuit, soit \"Investissement Étudiant\" = débit du coût de création).\n\nVoici la mise à jour complète du composant `AdminMercato.tsx`.\n\n",
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1767803223,
      "nanos": 263000000
    },
    "doneTimestamp": {
      "seconds": 1767803223,
      "nanos": 263000000
    }
  },
  {
    "id": 18,
    "author": "model",
    "payload": {
      "type": "generationTable",
      "entries": [
        {
          "path": "components/AdminMercato.tsx",
          "generationType": 1,
          "isDone": true,
          "description": "Remplacement du bouton de création rapide par une modale complète (Choix Classe, Fondateur, Paiement).",
          "diffs": [
            {
              "target": "",
              "replacement": "\nimport React, { useState, useMemo } from 'react';\nimport { Agency, GameEvent, MercatoRequest, StudentHistoryEntry, CycleType } from '../types';\nimport { ArrowRightLeft, UserPlus, UserMinus, Briefcase, Plus, AlertCircle, Check, X, FileSearch, UserX, Coins, Quote, User, Info, Building2, School, Wallet } from 'lucide-react';\nimport { useUI } from '../contexts/UIContext';\nimport { GAME_RULES, INITIAL_WEEKS } from '../constants';\nimport { Modal } from './Modal';\n\ninterface AdminMercatoProps {\n  agencies: Agency[];\n  onUpdateAgencies: (agencies: Agency[]) => void;\n  readOnly?: boolean;\n}\n\nexport const AdminMercato: React.FC<AdminMercatoProps> = ({ agencies, onUpdateAgencies, readOnly }) => {\n  const { confirm, toast } = useUI();\n  const [selectedStudentId, setSelectedStudentId] = useState<string | null>(null);\n  const [targetAgencyId, setTargetAgencyId] = useState<string | null>(null);\n\n  // --- CREATE MODAL STATE ---\n  const [isCreateModalOpen, setIsCreateModalOpen] = useState(false);\n  const [createForm, setCreateForm] = useState({\n      name: '',\n      classId: 'A' as 'A' | 'B',\n      founderId: 'NONE', // 'NONE' or student ID\n      applyCost: false // If true, deducts PiXi from student\n  });\n\n  const unassignedAgency = agencies.find(a => a.id === 'unassigned');\n  const activeAgencies = agencies.filter(a => a.id !== 'unassigned');\n\n  // Filter unemployed students based on selected class in form\n  const availableFounders = useMemo(() => {\n      if (!unassignedAgency) return [];\n      return unassignedAgency.members.filter(m => m.classId === createForm.classId);\n  }, [unassignedAgency, createForm.classId]);\n\n  const pendingRequests = useMemo(() => {\n      const requests: {req: MercatoRequest, agency: Agency}[] = [];\n      agencies.forEach(a => {\n          (a.mercatoRequests || []).forEach(r => {\n              if (r.status === 'PENDING') requests.push({req: r, agency: a});\n          });\n      });\n      return requests;\n  }, [agencies]);\n\n  const findStudentData = (studentId: string) => {\n    for (const agency of agencies) {\n        const student = agency.members.find(m => m.id === studentId);\n        if (student) return { student, agency };\n    }\n    return null;\n  };\n\n  const calculateFiringVEDelta = (score: number) => {\n      if (score < 30) return 10;\n      if (score < 50) return 5;\n      if (score < 70) return -5;\n      if (score < 90) return -15;\n      return -25;\n  };\n\n  const executeTransfer = (studentId: string, sourceAgencyId: string, targetAgencyId: string, transferType: 'HIRE' | 'FIRE' | 'TRANSFER', reason?: string) => {\n    const sourceAgency = agencies.find(a => a.id === sourceAgencyId);\n    const targetAgency = agencies.find(a => a.id === targetAgencyId);\n    const student = sourceAgency?.members.find(m => m.id === studentId);\n\n    if (!sourceAgency || !targetAgency || !student) return;\n\n    const today = new Date().toISOString().split('T')[0];\n    const newHistory: StudentHistoryEntry[] = [...(student.history || [])];\n    \n    if (sourceAgencyId !== 'unassigned') {\n        newHistory.push({\n            date: today, agencyId: sourceAgency.id, agencyName: sourceAgency.name,\n            action: transferType === 'FIRE' ? 'FIRED' : 'LEFT',\n            contextVE: sourceAgency.ve_current, contextBudget: sourceAgency.budget_real,\n            reason: reason || (transferType === 'FIRE' ? \"Licenciement\" : \"Départ\")\n        });\n    }\n\n    if (targetAgencyId !== 'unassigned') {\n        newHistory.push({\n            date: today, agencyId: targetAgency.id, agencyName: targetAgency.name,\n            action: 'JOINED', contextVE: targetAgency.ve_current, contextBudget: targetAgency.budget_real,\n            reason: reason || \"Recrutement\"\n        });\n    }\n\n    const updatedStudent = { ...student, history: newHistory };\n    const updatedSourceMembers = sourceAgency.members.filter(m => m.id !== student.id);\n    const updatedSource = { ...sourceAgency, members: updatedSourceMembers };\n    const updatedTargetMembers = [...targetAgency.members, updatedStudent];\n    const updatedTarget = { ...targetAgency, members: updatedTargetMembers };\n\n    let eventSource: GameEvent | null = null;\n    let eventTarget: GameEvent | null = null;\n    let sourceVEDelta = 0;\n    let targetVEDelta = 0;\n\n    if (transferType === 'FIRE') {\n        sourceVEDelta = calculateFiringVEDelta(student.individualScore);\n        let label = sourceVEDelta > 0 ? \"Restructuration\" : \"Perte Compétence\";\n        eventSource = {\n            id: `evt-${Date.now()}-1`, date: today, type: sourceVEDelta > 0 ? 'VE_DELTA' : 'CRISIS',\n            label: label, deltaVE: sourceVEDelta,\n            description: `Départ de ${student.name}.`\n        };\n    } else if (transferType === 'HIRE') {\n        targetVEDelta = -5;\n        eventTarget = {\n            id: `evt-${Date.now()}-2`, date: today, type: 'VE_DELTA', label: 'Recrutement Ext.', deltaVE: targetVEDelta,\n            description: `${student.name} rejoint l'équipe.`\n        };\n    }\n\n    if (eventSource && sourceAgency.id !== 'unassigned') {\n        updatedSource.eventLog = [...updatedSource.eventLog, eventSource];\n        updatedSource.ve_current = Math.max(0, updatedSource.ve_current + sourceVEDelta);\n    }\n    if (eventTarget && targetAgency.id !== 'unassigned') {\n        updatedTarget.eventLog = [...updatedTarget.eventLog, eventTarget];\n        updatedTarget.ve_current = Math.max(0, updatedTarget.ve_current + targetVEDelta);\n    }\n\n    return agencies.map(a => \n        a.id === sourceAgency.id ? updatedSource : \n        a.id === targetAgency.id ? updatedTarget : a\n    );\n  }\n\n  const handleManualTransfer = async () => {\n     if(readOnly) return;\n     if (!selectedStudentId || !targetAgencyId) return;\n     const sourceData = findStudentData(selectedStudentId);\n     if (!sourceData) return;\n\n     const student = sourceData.student;\n     const targetAgency = agencies.find(a => a.id === targetAgencyId);\n     \n     if (targetAgency && targetAgency.id !== 'unassigned' && targetAgency.classId !== student.classId) {\n         toast('error', `Classes incompatibles (Étudiant ${student.classId} -> Agence ${targetAgency.classId})`);\n         return;\n     }\n     \n     const type = sourceData.agency.id === 'unassigned' ? 'HIRE' : targetAgencyId === 'unassigned' ? 'FIRE' : 'TRANSFER';\n     const confirmed = await confirm({\n         title: \"Confirmation de Mouvement RH\",\n         message: `Forcer le mouvement de ${student.name} ?\\nDe ${sourceData.agency.name} vers ${targetAgency?.name || 'Chômage'}`,\n         confirmText: \"Valider\", isDangerous: type === 'FIRE'\n     });\n\n     if (!confirmed) return;\n\n     const newAgencies = executeTransfer(selectedStudentId, sourceData.agency.id, targetAgencyId, type, \"Action Admin\");\n     if(newAgencies) {\n         onUpdateAgencies(newAgencies);\n         toast('success', `Transfert effectué`);\n         setSelectedStudentId(null); setTargetAgencyId(null);\n     }\n  };\n\n  const handleApproveRequest = async (request: MercatoRequest, requestAgency: Agency) => {\n      if(readOnly) return;\n      \n      if (request.type === 'FOUND_AGENCY') {\n          // Utilise la même logique que la création manuelle, mais pilotée par la demande\n          const studentData = findStudentData(request.studentId);\n          if(!studentData) return;\n          \n          // Redirige vers la logique de création manuelle avec les infos pré-remplies si besoin,\n          // ou exécute directement ici (implémenté directement pour simplifier)\n          const student = studentData.student;\n          const newAgencyId = `a-${Date.now()}`;\n          const newAgency: Agency = {\n              id: newAgencyId, \n              name: `Studio de ${student.name}`, \n              tagline: \"Nouveau projet en cours...\", \n              ve_current: 20, \n              status: 'critique',\n              classId: student.classId, \n              budget_real: 2000, \n              budget_valued: 0, \n              weeklyTax: 0, \n              weeklyRevenueModifier: 0,\n              members: [{\n                  ...student,\n                  wallet: (student.wallet || 0) - GAME_RULES.CREATION_COST_PIXI,\n                  individualScore: Math.max(0, student.individualScore - GAME_RULES.CREATION_COST_SCORE)\n              }], \n              peerReviews: [], \n              eventLog: [{ id: `e-${newAgencyId}-1`, date: new Date().toISOString().split('T')[0], type: \"INFO\", label: \"Ouverture Studio\", deltaVE: 0, description: `Fondé par ${student.name}.` }],\n              currentCycle: CycleType.MARQUE_BRIEF, \n              constraints: { space: \"À définir\", style: \"À définir\", client: \"À définir\" },\n              projectDef: { problem: \"\", target: \"\", location: \"\", gesture: \"\", isLocked: false },\n              mercatoRequests: [], transactionRequests: [], mergerRequests: [],\n              branding: { color: student.classId === 'A' ? 'indigo' : 'cyan' }, \n              badges: [], \n              progress: JSON.parse(JSON.stringify(INITIAL_WEEKS))\n          };\n\n          const updatedAgencies = agencies.map(a => {\n              if (a.id === 'unassigned') return { ...a, members: a.members.filter(m => m.id !== student.id), mercatoRequests: a.mercatoRequests.filter(r => r.id !== request.id) };\n              return a;\n          });\n          onUpdateAgencies([...updatedAgencies, newAgency]);\n          toast('success', `Studio créé pour ${student.name}`);\n          return;\n      }\n\n      let newAgencies: Agency[] | undefined;\n      const studentData = findStudentData(request.studentId);\n      if(!studentData) return;\n\n      if (request.type === 'FIRE') {\n          newAgencies = executeTransfer(request.studentId, request.targetAgencyId, 'unassigned', 'FIRE', request.motivation);\n      } else if (request.type === 'HIRE') {\n          newAgencies = executeTransfer(request.studentId, studentData.agency.id, request.targetAgencyId, 'HIRE', request.motivation);\n      }\n\n      if (newAgencies) {\n          const finalAgencies = newAgencies.map(a => {\n             if (a.id === requestAgency.id) {\n                 return { ...a, mercatoRequests: a.mercatoRequests.filter(r => r.id !== request.id) };\n             }\n             return a;\n          });\n          onUpdateAgencies(finalAgencies);\n          toast('success', 'Demande validée.');\n      }\n  };\n\n  const handleRejectRequest = (request: MercatoRequest, requestAgency: Agency) => {\n      if(readOnly) return;\n      const updatedAgency = { ...requestAgency, mercatoRequests: requestAgency.mercatoRequests.filter(r => r.id !== request.id) };\n      onUpdateAgencies(agencies.map(a => a.id === updatedAgency.id ? updatedAgency : a));\n      toast('info', 'Demande rejetée.');\n  };\n\n  const handleCreateSubmit = () => {\n      const newAgencyId = `a-manual-${Date.now()}`;\n      let initialMembers: any[] = [];\n      let startBudget = 2000;\n\n      // 1. GESTION DU FONDATEUR\n      if (createForm.founderId !== 'NONE') {\n          const founder = unassignedAgency?.members.find(m => m.id === createForm.founderId);\n          if (founder) {\n              const updatedFounder = { ...founder };\n              if (createForm.applyCost) {\n                  updatedFounder.wallet = (updatedFounder.wallet || 0) - GAME_RULES.CREATION_COST_PIXI;\n                  updatedFounder.individualScore = Math.max(0, updatedFounder.individualScore - GAME_RULES.CREATION_COST_SCORE);\n                  startBudget += 0; // Le budget de l'agence commence à 2000 (financé par l'étudiant)\n              } else {\n                  // Si l'admin paie (subvention), l'étudiant ne paie rien, et l'agence reçoit le budget\n                  // startBudget reste 2000 (Subvention Admin)\n              }\n              initialMembers.push(updatedFounder);\n          }\n      }\n\n      // 2. CRÉATION AGENCE\n      const newAgency: Agency = {\n          id: newAgencyId, \n          name: createForm.name || \"Nouveau Studio\", \n          tagline: \"En construction...\", \n          ve_current: 20, \n          status: 'critique',\n          classId: createForm.classId, \n          budget_real: startBudget, \n          budget_valued: 0, \n          weeklyTax: 0, \n          weeklyRevenueModifier: 0,\n          members: initialMembers, \n          peerReviews: [], \n          eventLog: [{ \n              id: `e-${newAgencyId}-1`, \n              date: new Date().toISOString().split('T')[0], \n              type: \"INFO\", \n              label: \"Ouverture Studio\", \n              deltaVE: 0, \n              description: initialMembers.length > 0 \n                ? `Fondé par ${initialMembers[0].name} (${createForm.applyCost ? 'Fonds Propres' : 'Subvention Admin'}).` \n                : \"Création administrative vide.\" \n          }],\n          currentCycle: CycleType.MARQUE_BRIEF, \n          constraints: { space: \"À définir\", style: \"À définir\", client: \"À définir\" },\n          projectDef: { problem: \"\", target: \"\", location: \"\", gesture: \"\", isLocked: false },\n          mercatoRequests: [], \n          transactionRequests: [], \n          mergerRequests: [],\n          branding: { color: createForm.classId === 'A' ? 'indigo' : 'cyan' }, \n          badges: [], \n          progress: JSON.parse(JSON.stringify(INITIAL_WEEKS))\n      };\n\n      // 3. RETRAIT DU FONDATEUR DU VIVIER (Si applicable)\n      const updatedAgencies = agencies.map(a => {\n          if (a.id === 'unassigned' && createForm.founderId !== 'NONE') {\n              return { ...a, members: a.members.filter(m => m.id !== createForm.founderId) };\n          }\n          return a;\n      });\n\n      onUpdateAgencies([...updatedAgencies, newAgency]);\n      toast('success', 'Studio créé avec succès.');\n      setIsCreateModalOpen(false);\n      setCreateForm({ name: '', classId: 'A', founderId: 'NONE', applyCost: false });\n  };\n\n  return (\n    <div className=\"animate-in fade-in duration-500 pb-20\">\n        <div className=\"flex justify-between items-center mb-6\">\n            <div>\n                <h2 className=\"text-3xl font-display font-bold text-slate-900\">Mercato & RH</h2>\n                <p className=\"text-slate-500 text-sm\">Gérez les candidatures et les nouveaux studios.</p>\n            </div>\n            {!readOnly && (\n                <button \n                    onClick={() => setIsCreateModalOpen(true)} \n                    className=\"bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-xl font-bold text-sm flex items-center gap-2 transition-colors shadow-lg\"\n                >\n                    <Plus size={18} /> Ouvrir un Nouveau Studio\n                </button>\n            )}\n        </div>\n\n        {/* --- MODAL DE CREATION --- */}\n        <Modal isOpen={isCreateModalOpen} onClose={() => setIsCreateModalOpen(false)} title=\"Création de Studio (Admin)\">\n            <div className=\"space-y-6\">\n                <div>\n                    <label className=\"block text-xs font-bold text-slate-500 uppercase mb-1\">Nom du Studio</label>\n                    <input \n                        type=\"text\" \n                        value={createForm.name}\n                        onChange={(e) => setCreateForm({...createForm, name: e.target.value})}\n                        placeholder=\"Ex: Studio Alpha\"\n                        className=\"w-full p-3 border border-slate-200 rounded-xl font-bold focus:ring-2 focus:ring-indigo-500 outline-none\"\n                    />\n                </div>\n\n                <div>\n                    <label className=\"block text-xs font-bold text-slate-500 uppercase mb-1\">Classe de rattachement</label>\n                    <div className=\"flex gap-4\">\n                        <button \n                            onClick={() => setCreateForm({...createForm, classId: 'A'})}\n                            className={`flex-1 py-3 rounded-xl border-2 font-bold transition-all ${createForm.classId === 'A' ? 'border-blue-500 bg-blue-50 text-blue-600' : 'border-slate-100 text-slate-400'}`}\n                        >\n                            CLASSE A\n                        </button>\n                        <button \n                            onClick={() => setCreateForm({...createForm, classId: 'B'})}\n                            className={`flex-1 py-3 rounded-xl border-2 font-bold transition-all ${createForm.classId === 'B' ? 'border-purple-500 bg-purple-50 text-purple-600' : 'border-slate-100 text-slate-400'}`}\n                        >\n                            CLASSE B\n                        </button>\n                    </div>\n                </div>\n\n                <div>\n                    <label className=\"block text-xs font-bold text-slate-500 uppercase mb-1\">Premier Membre (Fondateur)</label>\n                    <select \n                        className=\"w-full p-3 border border-slate-200 rounded-xl bg-white text-sm font-medium\"\n                        value={createForm.founderId}\n                        onChange={(e) => setCreateForm({...createForm, founderId: e.target.value})}\n                    >\n                        <option value=\"NONE\">-- Aucun (Studio Vide) --</option>\n                        {availableFounders.map(s => (\n                            <option key={s.id} value={s.id}>{s.name} (Score: {s.individualScore})</option>\n                        ))}\n                    </select>\n                    <p className=\"text-xs text-slate-400 mt-1 italic\">\n                        {createForm.founderId !== 'NONE' ? \"L'étudiant sera retiré du vivier.\" : \"Vous devrez ajouter des membres manuellement plus tard.\"}\n                    </p>\n                </div>\n\n                {createForm.founderId !== 'NONE' && (\n                    <div className={`p-4 rounded-xl border transition-all ${createForm.applyCost ? 'bg-amber-50 border-amber-200' : 'bg-emerald-50 border-emerald-200'}`}>\n                        <label className=\"flex items-center gap-3 cursor-pointer\">\n                            <input \n                                type=\"checkbox\" \n                                checked={createForm.applyCost} \n                                onChange={(e) => setCreateForm({...createForm, applyCost: e.target.checked})}\n                                className=\"w-5 h-5 accent-indigo-600\"\n                            />\n                            <div>\n                                <span className={`font-bold text-sm block ${createForm.applyCost ? 'text-amber-800' : 'text-emerald-800'}`}>\n                                    {createForm.applyCost ? \"Facturer l'étudiant (Mode Normal)\" : \"Subvention Admin (Gratuit)\"}\n                                </span>\n                                <span className=\"text-xs text-slate-500 block mt-0.5\">\n                                    {createForm.applyCost \n                                        ? `L'étudiant paie ${GAME_RULES.CREATION_COST_PIXI} PiXi et ${GAME_RULES.CREATION_COST_SCORE} Score.` \n                                        : \"L'administration offre les frais de création.\"}\n                                </span>\n                            </div>\n                        </label>\n                    </div>\n                )}\n\n                <button \n                    onClick={handleCreateSubmit}\n                    disabled={!createForm.name}\n                    className={`w-full py-4 rounded-xl font-bold text-white shadow-lg flex items-center justify-center gap-2 transition-all ${!createForm.name ? 'bg-slate-300 cursor-not-allowed' : 'bg-indigo-600 hover:bg-indigo-700'}`}\n                >\n                    <Building2 size={20}/> Créer le Studio\n                </button>\n            </div>\n        </Modal>\n\n        {/* --- SECTION: PENDING REQUESTS --- */}\n        {pendingRequests.length > 0 && (\n            <div className=\"mb-8 bg-amber-50 border border-amber-200 rounded-2xl p-6\">\n                <h3 className=\"text-amber-800 font-bold flex items-center gap-2 mb-4\">\n                    <AlertCircle size={20}/> Demandes en attente ({pendingRequests.length})\n                </h3>\n                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n                    {pendingRequests.map(({req, agency}) => {\n                        const studentData = findStudentData(req.studentId);\n                        const student = studentData?.student;\n                        const isFoundation = req.type === 'FOUND_AGENCY';\n\n                        return (\n                            <div key={req.id} className=\"bg-white p-4 rounded-xl border border-amber-100 shadow-sm flex flex-col gap-2\">\n                                <div className=\"flex justify-between items-start\">\n                                    <div className=\"flex items-center gap-2\">\n                                        <span className={`text-[10px] font-bold px-2 py-0.5 rounded-md uppercase ${\n                                            isFoundation ? 'bg-purple-600 text-white' : \n                                            req.type === 'HIRE' ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'\n                                        }`}>\n                                            {isFoundation ? 'Fondation Studio' : req.type === 'HIRE' ? 'Embauche' : 'Départ'}\n                                        </span>\n                                        <span className=\"text-[10px] bg-slate-100 text-slate-500 px-1 rounded font-bold\">Cl. {student?.classId}</span>\n                                    </div>\n                                    {!readOnly && (\n                                    <div className=\"flex gap-1\">\n                                        <button onClick={() => handleRejectRequest(req, agency)} className=\"p-1.5 bg-slate-100 hover:bg-red-100 text-slate-400 hover:text-red-600 rounded-lg\"><X size={16}/></button>\n                                        <button onClick={() => handleApproveRequest(req, agency)} className=\"p-1.5 bg-slate-900 hover:bg-emerald-600 text-white rounded-lg\"><Check size={16}/></button>\n                                    </div>\n                                    )}\n                                </div>\n\n                                <div className=\"mt-1\">\n                                    <p className=\"font-bold text-slate-900 text-sm\">\n                                        {req.studentName}\n                                        <span className=\"block text-[10px] text-slate-400 font-normal mt-0.5\">\n                                            {isFoundation ? `veut fonder sa propre agence (-${GAME_RULES.CREATION_COST_PIXI} PiXi)` : `cible : ${agency.name}`}\n                                        </span>\n                                    </p>\n                                    {req.motivation && (\n                                        <div className=\"bg-slate-50 p-2 rounded-lg mt-2 flex gap-2 border border-slate-100\">\n                                            <Quote size={12} className=\"text-slate-300 shrink-0\"/>\n                                            <p className=\"text-xs text-slate-600 italic\">\"{req.motivation}\"</p>\n                                        </div>\n                                    )}\n                                </div>\n                            </div>\n                        );\n                    })}\n                </div>\n            </div>\n        )}\n\n        <div className=\"grid grid-cols-1 md:grid-cols-12 gap-6\">\n            <div className=\"md:col-span-12\">\n                <h3 className=\"text-sm font-bold text-slate-500 uppercase tracking-widest mb-3 flex items-center gap-2\">\n                    <Briefcase size={16}/> Vivier / Pôle Chômage\n                </h3>\n                <div className={`border-2 border-dashed rounded-2xl p-4 mb-8 transition-colors ${targetAgencyId === 'unassigned' ? 'bg-red-50 border-red-300' : 'bg-slate-100 border-slate-300'}`}>\n                    <div className=\"flex justify-between items-center mb-4\">\n                        <p className=\"text-sm text-slate-500 italic\">Cliquez sur un étudiant pour le sélectionner, puis choisissez une destination.</p>\n                        <button onClick={() => !readOnly && setTargetAgencyId('unassigned')} disabled={readOnly} className={`px-4 py-2 rounded-lg text-xs font-bold transition-all ${targetAgencyId === 'unassigned' ? 'bg-red-600 text-white' : 'bg-white text-slate-600 border border-slate-200'}`}>\n                            Action: Licencier\n                        </button>\n                    </div>\n                    <div className=\"flex flex-wrap gap-3\">\n                        {unassignedAgency?.members.map(student => (\n                            <div key={student.id} onClick={() => !readOnly && setSelectedStudentId(student.id)} className={`flex items-center gap-3 p-3 rounded-xl border-2 transition-all cursor-pointer ${selectedStudentId === student.id ? 'bg-white border-indigo-500 shadow-md transform scale-105' : 'bg-white border-slate-200'}`}>\n                                <img src={student.avatarUrl} className=\"w-8 h-8 rounded-full grayscale\" />\n                                <div>\n                                    <p className=\"font-bold text-slate-700 text-sm leading-none\">{student.name}</p>\n                                    <span className={`text-[9px] font-bold px-1.5 rounded text-white ${student.classId === 'A' ? 'bg-blue-400' : 'bg-purple-400'}`}>CLASSE {student.classId}</span>\n                                </div>\n                            </div>\n                        ))}\n                    </div>\n                </div>\n\n                <h3 className=\"text-sm font-bold text-slate-500 uppercase tracking-widest mb-3 flex items-center gap-2\"><UserPlus size={16}/> Agences Actives</h3>\n                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\n                    {activeAgencies.map(agency => (\n                        <div key={agency.id} className={`bg-white rounded-2xl border transition-all relative overflow-hidden ${targetAgencyId === agency.id ? 'border-indigo-500 shadow-lg ring-2 ring-indigo-100' : 'border-slate-200 hover:border-slate-300'}`}>\n                            <div className={`absolute top-0 left-0 right-0 h-1 ${agency.classId === 'A' ? 'bg-blue-400' : 'bg-purple-400'}`}></div>\n                            <div onClick={() => !readOnly && setTargetAgencyId(agency.id)} className={`p-4 border-b border-slate-100 flex justify-between items-center rounded-t-2xl mt-1 transition-colors cursor-pointer ${targetAgencyId === agency.id ? 'bg-indigo-50' : 'bg-slate-50'}`}>\n                                <div>\n                                    <h4 className=\"font-bold text-slate-700\">{agency.name}</h4>\n                                    <span className=\"text-[10px] font-bold px-1.5 py-0.5 rounded bg-slate-200 text-slate-600\">CLASSE {agency.classId}</span>\n                                </div>\n                                {targetAgencyId === agency.id && <span className=\"text-[10px] bg-indigo-200 text-indigo-800 px-2 rounded-full font-bold\">Cible</span>}\n                            </div>\n                            <div className=\"p-4 space-y-2\">\n                                {agency.members.map(student => (\n                                    <div key={student.id} onClick={(e) => { e.stopPropagation(); if(!readOnly) setSelectedStudentId(student.id); }} className={`flex items-center gap-3 p-2 rounded-xl transition-all cursor-pointer ${selectedStudentId === student.id ? 'bg-indigo-600 text-white shadow-md' : 'hover:bg-slate-50 text-slate-700'}`}>\n                                        <img src={student.avatarUrl} className=\"w-8 h-8 rounded-full\" />\n                                        <div className=\"flex-1\">\n                                            <p className=\"font-bold text-sm leading-none\">{student.name}</p>\n                                            <p className=\"text-[10px] mt-0.5 opacity-70\">{student.role}</p>\n                                        </div>\n                                    </div>\n                                ))}\n                            </div>\n                        </div>\n                    ))}\n                </div>\n            </div>\n        </div>\n        \n        {!readOnly && selectedStudentId && targetAgencyId && (\n        <div className=\"fixed bottom-6 left-1/2 transform -translate-x-1/2 md:ml-32 bg-slate-900 text-white px-6 py-4 rounded-2xl shadow-2xl flex items-center gap-6 z-50\">\n            <div className=\"flex items-center gap-3\">\n                 <div className=\"text-right\">\n                    <span className=\"block text-[10px] text-slate-400 uppercase font-bold\">Source: {findStudentData(selectedStudentId)?.agency.name}</span>\n                 </div>\n                 <ArrowRightLeft className=\"text-slate-500\" />\n                 <div>\n                    <span className=\"block text-[10px] text-slate-400 uppercase font-bold\">Cible: {targetAgencyId === 'unassigned' ? 'Chômage' : agencies.find(a => a.id === targetAgencyId)?.name}</span>\n                 </div>\n            </div>\n            <button onClick={handleManualTransfer} className=\"bg-white text-slate-900 px-6 py-2 rounded-xl font-bold text-sm hover:bg-indigo-50\">Transférer (Force)</button>\n        </div>\n        )}\n    </div>\n  );\n};\n"
            }
          ]
        }
      ]
    },
    "createdTimestamp": {
      "seconds": 1767803223,
      "nanos": 929000000
    },
    "doneTimestamp": {
      "seconds": 1767803276,
      "nanos": 147000000
    }
  },
  {
    "id": 20,
    "author": "user",
    "payload": {
      "type": "text",
      "text": "Je n'ai pas non plus la possibilité de détruire une Agence vide",
      "files": [],
      "fileUploads": [],
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1767803444,
      "nanos": 165000000
    }
  },
  {
    "id": 21,
    "author": "model",
    "payload": {
      "type": "thinking",
      "text": "**Clarifying Button Purpose**\n\nOkay, I'm currently analyzing the user's request, specifically focusing on the clarity and flexibility of the \"Create Studio\" button within the admin view. I've identified that the current implementation doesn't allow for a direct choice of class (A or B) upon studio creation, which seems to be a key user need. I'm digging deeper into how to best address this, I'm thinking about the button's behavior.\n\n\n**Outlining Agency Management**\n\nI'm now outlining the steps to implement agency management. I'm focusing on adding a 'deleteAgency' function within `GameContext.tsx`, which necessitates deleting the record from Firestore's 'agencies' collection. It's becoming clearer that the agency management logic might fit best within `AdminProjects.tsx`, and I'm considering this. Furthermore, I've identified the key questions around who pays and who joins upon creation.\n\n\n**Refining Create Functionality**\n\nI'm now refining the \"create\" functionality in `AdminMercato.tsx`, specifically the replacement of the existing button with a more complex modal. I've broken down the modal fields needed: agency name, class selection, founder selection from unassigned students, and a payment method toggle. I'm focusing on the \"Student Investment\" payment method logic, ensuring correct deduction of PiXi/Score from the student's account before agency assignment. I'm also ensuring founder selections are correctly assigned.\n\n\n**Adding Delete Logic**\n\nI'm now focusing on adding deletion functionality for agencies. I'm thinking of adding a trash icon button next to each agency listed. The key is to handle the deletion logic safely. I've decided to allow deleting any agency but with a strong confirmation prompt, particularly if it has members. I'm drafting the `deleteAgency` function in `GameContext.tsx`, ensuring members are moved back to unassigned status to avoid data loss.\n\n\n**Integrating UI Components**\n\nI'm now integrating the UI components to support the agency management flow. I'm focusing on adopting `lucide-react` icons and Tailwind classes for consistency. I'll make sure to use the existing `Modal` component, ensuring the confirmation dialogs are used for deletion and costly creation operations. Data integrity is a key focus, especially when creating and deleting agencies. I'm prioritizing batch operations in Firestore to ensure atomicity. I am also working on `GameContext.tsx`.\n\n\n**Developing User Interactions**\n\nI'm now focusing on integrating the proposed UI components. I've imported `Modal` and added state for the create modal and form data within `AdminMercato.tsx`, specifically `isCreateModalOpen` and `createForm`. I'm developing the `handleCreateSubmit` function, employing `writeBatch` for atomic updates. The simple button has been replaced with the functional modal. In `AdminProjects.tsx`, I've imported the `Trash2` icon and the `deleteAgency` function. I've added the delete button to the agency table and am implementing the necessary confirmation logic. I have ensured in GameContext.tsx that members of any deleted agency will return to the unassigned state. I've specifically targeted the two user prompts and I'm ensuring they have been handled appropriately.\n\n\n**Refining Delete Implementation**\n\nI'm now refining the deletion implementation further. I've realized I need a safety check for the unassigned state. I will implement this for increased data integrity. I'm also ensuring the French language response is correct and that the code remains clean and maintainable. I'm focused on finishing `AdminMercato.tsx`, `AdminProjects.tsx`, and `GameContext.tsx`.\n\n\n",
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1767803444,
      "nanos": 165000000
    },
    "doneTimestamp": {
      "seconds": 1767803470,
      "nanos": 449000000
    }
  },
  {
    "id": 22,
    "author": "model",
    "payload": {
      "type": "text",
      "text": "C'est très juste. L'interface actuelle était trop simpliste pour un admin.\n\nVoici les modifications pour répondre précisément à vos besoins :\n\n1.  **Création Avancée (AdminMercato)** : J'ai remplacé le bouton simple par un bouton \"Ouvrir un Nouveau Studio\" qui lance une **Modale de Configuration**.\n    *   **Nom** : Champ libre.\n    *   **Classe** : Sélecteur A ou B.\n    *   **Fondateur** : Liste déroulante des étudiants \"au chômage\" de la classe sélectionnée.\n    *   **Financement** : Case à cocher pour décider si l'étudiant paie (Débit Wallet + Score) ou si c'est une subvention (Gratuit).\n2.  **Destruction d'Agence (AdminProjects)** : J'ai ajouté un bouton \"Corbeille\" dans la liste des projets.\n    *   Si l'agence contient des membres, ils sont automatiquement reversés dans le vivier \"Chômage\" avant la suppression (sécurité anti-perte de données).\n3.  **Logique Backend (GameContext)** : Ajout de la fonction `deleteAgency` qui gère ce transfert de sécurité.\n\nVoici les fichiers mis à jour :\n\n",
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1767803470,
      "nanos": 449000000
    },
    "doneTimestamp": {
      "seconds": 1767803470,
      "nanos": 451000000
    }
  },
  {
    "id": 23,
    "author": "model",
    "payload": {
      "type": "generationTable",
      "entries": [
        {
          "path": "contexts/GameContext.tsx",
          "generationType": 1,
          "isDone": true,
          "description": "Ajout de la fonction deleteAgency avec sécurité (renvoi des membres au chômage avant suppression).",
          "diffs": [
            {
              "target": "",
              "replacement": "\nimport React, { createContext, useContext, useState, ReactNode, useEffect } from 'react';\nimport { Agency, WeekModule, GameEvent, WikiResource, Student, TransactionRequest, MercatoRequest, StudentHistoryEntry, MergerRequest } from '../types';\nimport { MOCK_AGENCIES, INITIAL_WEEKS, GAME_RULES, CONSTRAINTS_POOL } from '../constants';\nimport { useUI } from './UIContext';\nimport { db } from '../services/firebase';\nimport { collection, onSnapshot, doc, updateDoc, writeBatch, setDoc, deleteDoc } from 'firebase/firestore';\nimport { useAuth } from './AuthContext';\n\ninterface GameContextType {\n  // State\n  agencies: Agency[];\n  weeks: { [key: string]: WeekModule };\n  resources: WikiResource[]; // Wiki Data\n  role: 'admin' | 'student';\n  selectedAgencyId: string | null;\n  isAutoMode: boolean;\n  \n  // Actions\n  setRole: (role: 'admin' | 'student') => void;\n  selectAgency: (id: string | null) => void;\n  toggleAutoMode: () => void;\n  updateAgency: (agency: Agency) => void;\n  updateAgenciesList: (agencies: Agency[]) => void;\n  deleteAgency: (agencyId: string) => Promise<void>; // NEW\n  updateWeek: (weekId: string, week: WeekModule) => void;\n  \n  // Wiki Actions\n  addResource: (resource: WikiResource) => Promise<void>;\n  deleteResource: (id: string) => Promise<void>;\n\n  // Game Logic\n  shuffleConstraints: (agencyId: string) => void;\n  processFinance: (targetClass: 'A' | 'B') => Promise<void>;\n  processPerformance: (targetClass: 'A' | 'B') => Promise<void>;\n  resetGame: () => void;\n  \n  // Student Economy & RH\n  transferFunds: (sourceId: string, targetId: string, amount: number) => Promise<void>;\n  tradeScoreForCash: (studentId: string, scoreAmount: number) => Promise<void>;\n  injectCapital: (studentId: string, agencyId: string, amount: number) => Promise<void>;\n  requestScorePurchase: (studentId: string, agencyId: string, amountPixi: number, amountScore: number) => Promise<void>;\n  handleTransactionRequest: (agency: Agency, request: TransactionRequest, approved: boolean) => Promise<void>;\n  submitMercatoVote: (agencyId: string, requestId: string, voterId: string, vote: 'APPROVE' | 'REJECT') => Promise<void>;\n\n  // Black Ops & Mergers\n  triggerBlackOp: (sourceAgencyId: string, targetAgencyId: string, type: 'AUDIT' | 'LEAK') => Promise<void>;\n  proposeMerger: (sourceAgencyId: string, targetAgencyId: string) => Promise<void>;\n  finalizeMerger: (mergerId: string, targetAgencyId: string, approved: boolean) => Promise<void>;\n  getCurrentGameWeek: () => number;\n}\n\nconst GameContext = createContext<GameContextType | undefined>(undefined);\n\nexport const useGame = () => {\n  const context = useContext(GameContext);\n  if (!context) throw new Error('useGame must be used within a GameProvider');\n  return context;\n};\n\nexport const GameProvider: React.FC<{ children: ReactNode }> = ({ children }) => {\n  const { toast, confirm } = useUI();\n  const { userData } = useAuth();\n  \n  const [role, setRole] = useState<'admin' | 'student'>('student');\n  const [agencies, setAgencies] = useState<Agency[]>(MOCK_AGENCIES);\n  const [weeks, setWeeks] = useState<{ [key: string]: WeekModule }>(INITIAL_WEEKS);\n  const [resources, setResources] = useState<WikiResource[]>([]);\n  const [selectedAgencyId, setSelectedAgencyId] = useState<string | null>(null);\n  const [isAutoMode, setIsAutoMode] = useState(false);\n\n  // Sync Role with Auth\n  useEffect(() => {\n    if (userData) {\n      if (userData.role === 'admin') setRole('admin');\n      else setRole('student');\n    }\n  }, [userData]);\n\n  // 1. REAL-TIME SYNC: Agencies\n  useEffect(() => {\n    const unsubscribe = onSnapshot(collection(db, \"agencies\"), \n      (snapshot) => {\n        const agenciesData: Agency[] = [];\n        snapshot.forEach((doc) => {\n          agenciesData.push(doc.data() as Agency);\n        });\n        if (agenciesData.length === 0) {\n          seedDatabase().catch(console.error);\n        } else {\n          setAgencies(agenciesData);\n        }\n      },\n      (error) => {\n        console.error(\"Firestore Read Error (Agencies):\", error);\n        toast('info', 'Mode Hors Ligne');\n      }\n    );\n    return () => unsubscribe();\n  }, []);\n\n  // 2. REAL-TIME SYNC: Weeks\n  useEffect(() => {\n    const unsubscribe = onSnapshot(collection(db, \"weeks\"), \n      (snapshot) => {\n        const weeksData: { [key: string]: WeekModule } = {};\n        snapshot.forEach((doc) => {\n          weeksData[doc.id] = doc.data() as WeekModule;\n        });\n        if (Object.keys(weeksData).length > 0) setWeeks(weeksData);\n      }\n    );\n    return () => unsubscribe();\n  }, []);\n\n  // 3. REAL-TIME SYNC: Resources\n  useEffect(() => {\n    const unsubscribe = onSnapshot(collection(db, \"resources\"), \n      (snapshot) => {\n        const resData: WikiResource[] = [];\n        snapshot.forEach((doc) => {\n          resData.push(doc.data() as WikiResource);\n        });\n        setResources(resData);\n      }\n    );\n    return () => unsubscribe();\n  }, []);\n\n  // 4. AUTO MODE SCHEDULER\n  useEffect(() => {\n      if (!isAutoMode) return;\n      const checkSchedule = () => {\n          const now = new Date();\n          const today = now.toISOString().split('T')[0];\n          console.log(`Auto Check: ${today}`);\n      };\n      const interval = setInterval(checkSchedule, 60000); \n      return () => clearInterval(interval);\n  }, [isAutoMode, weeks]);\n\n  // HELPER: Get Current Week\n  const getCurrentGameWeek = () => {\n      const unlockedWeeks = (Object.values(weeks) as WeekModule[]).filter(w => !w.locked).map(w => parseInt(w.id));\n      return unlockedWeeks.length > 0 ? Math.max(...unlockedWeeks) : 1;\n  };\n\n  // SEED FUNCTION\n  const seedDatabase = async () => {\n    const batch = writeBatch(db);\n    MOCK_AGENCIES.forEach(agency => {\n      const ref = doc(db, \"agencies\", agency.id);\n      batch.set(ref, agency);\n    });\n    Object.values(INITIAL_WEEKS).forEach(week => {\n      const ref = doc(db, \"weeks\", week.id);\n      batch.set(ref, week);\n    });\n    await batch.commit();\n  };\n\n  const updateAgency = async (updatedAgency: Agency) => {\n    try {\n        let veCap = 100;\n        const memberCount = updatedAgency.members.length;\n        if (memberCount === 1) veCap = GAME_RULES.VE_CAP_1_MEMBER;\n        else if (memberCount <= 3) veCap = GAME_RULES.VE_CAP_2_3_MEMBERS;\n        else veCap = GAME_RULES.VE_CAP_4_PLUS_MEMBERS;\n\n        const finalVE = Math.min(updatedAgency.ve_current, veCap);\n        const agencyRef = doc(db, \"agencies\", updatedAgency.id);\n        await updateDoc(agencyRef, { ...updatedAgency, ve_current: finalVE });\n    } catch (e) {\n        console.error(e);\n        toast('error', 'Erreur sauvegarde');\n    }\n  };\n\n  const updateAgenciesList = async (newAgencies: Agency[]) => {\n      try {\n        const batch = writeBatch(db);\n        newAgencies.forEach(a => {\n            const ref = doc(db, \"agencies\", a.id);\n            batch.set(ref, a, { merge: true });\n        });\n        await batch.commit();\n      } catch(e) {\n         console.error(e);\n         toast('error', 'Erreur mise à jour multiple');\n      }\n  };\n\n  const deleteAgency = async (agencyId: string) => {\n      try {\n          const agencyToDelete = agencies.find(a => a.id === agencyId);\n          if (!agencyToDelete) return;\n\n          const batch = writeBatch(db);\n\n          // 1. Move existing members to 'unassigned' if any\n          if (agencyToDelete.members.length > 0) {\n              const unassignedRef = doc(db, \"agencies\", \"unassigned\");\n              const unassignedAgency = agencies.find(a => a.id === 'unassigned');\n              if (unassignedAgency) {\n                  const updatedMembers = [...unassignedAgency.members, ...agencyToDelete.members];\n                  batch.update(unassignedRef, { members: updatedMembers });\n              }\n          }\n\n          // 2. Delete the agency document\n          const agencyRef = doc(db, \"agencies\", agencyId);\n          batch.delete(agencyRef);\n\n          await batch.commit();\n          toast('success', `Agence supprimée. Membres transférés au vivier.`);\n      } catch (e) {\n          console.error(e);\n          toast('error', \"Erreur lors de la suppression\");\n      }\n  };\n\n  const updateWeek = async (weekId: string, updatedWeek: WeekModule) => {\n    try {\n        const weekRef = doc(db, \"weeks\", weekId);\n        await updateDoc(weekRef, { ...updatedWeek });\n        toast('success', `Semaine ${weekId} mise à jour`);\n    } catch (e) {\n        console.error(e);\n        toast('error', 'Erreur maj semaine');\n    }\n  };\n\n  const addResource = async (resource: WikiResource) => {\n      await setDoc(doc(db, \"resources\", resource.id), resource);\n      toast('success', \"Ressource ajoutée\");\n  };\n\n  const deleteResource = async (id: string) => {\n      await deleteDoc(doc(db, \"resources\", id));\n      toast('success', \"Ressource supprimée\");\n  };\n\n  const selectAgency = (id: string | null) => setSelectedAgencyId(id);\n  const toggleAutoMode = () => setIsAutoMode(!isAutoMode);\n\n  const shuffleConstraints = async (agencyId: string) => {\n    const agency = agencies.find(a => a.id === agencyId);\n    if (!agency) return;\n    const randomSpace = CONSTRAINTS_POOL.space[Math.floor(Math.random() * CONSTRAINTS_POOL.space.length)];\n    const randomStyle = CONSTRAINTS_POOL.style[Math.floor(Math.random() * CONSTRAINTS_POOL.style.length)];\n    const randomClient = CONSTRAINTS_POOL.client[Math.floor(Math.random() * CONSTRAINTS_POOL.client.length)];\n    await updateAgency({\n      ...agency,\n      constraints: { space: randomSpace, style: randomStyle, client: randomClient }\n    });\n    toast('info', 'Contraintes régénérées');\n  };\n\n  // --- PROCESS: FINANCE (Rent, Salary, Revenue) ---\n  const processFinance = async (targetClass: 'A' | 'B') => {\n      const today = new Date().toISOString().split('T')[0];\n      try {\n        const batch = writeBatch(db);\n        let processedCount = 0;\n\n        agencies.forEach(agency => {\n            if (agency.id === 'unassigned' || agency.classId !== targetClass) return;\n            processedCount++;\n\n            let currentBudget = agency.budget_real;\n            let logEvents: GameEvent[] = [];\n\n            // 1. RENT\n            currentBudget -= GAME_RULES.AGENCY_RENT;\n            logEvents.push({ id: `fin-rent-${Date.now()}-${agency.id}`, date: today, type: 'CRISIS', label: 'Loyer Agence', deltaBudgetReal: -GAME_RULES.AGENCY_RENT, description: `Prélèvement automatique.` });\n\n            // 2. SALARIES\n            let actualDisbursed = 0;\n            const updatedMembers = agency.members.map(member => {\n                const rawSalary = member.individualScore * GAME_RULES.SALARY_MULTIPLIER; \n                const pay = Math.min(rawSalary, GAME_RULES.SALARY_CAP_FOR_STUDENT);\n                if (currentBudget < 0) return member; \n                actualDisbursed += pay;\n                return { ...member, wallet: (member.wallet || 0) + pay };\n            });\n\n            if (currentBudget >= 0) {\n                currentBudget -= actualDisbursed;\n                logEvents.push({ id: `fin-pay-${Date.now()}-${agency.id}`, date: today, type: 'PAYROLL', label: 'Salaires', deltaBudgetReal: -actualDisbursed, description: `Salaires versés.` });\n            } else {\n                logEvents.push({ id: `fin-pay-${Date.now()}-${agency.id}`, date: today, type: 'PAYROLL', label: 'Salaires Gelés', deltaBudgetReal: 0, description: `Dette active.` });\n            }\n\n            // 3. REVENUES\n            const revenueVE = (agency.ve_current * GAME_RULES.REVENUE_VE_MULTIPLIER);\n            const bonuses = agency.weeklyRevenueModifier || 0;\n            const totalRevenue = revenueVE + bonuses + GAME_RULES.REVENUE_BASE;\n            \n            currentBudget += totalRevenue;\n            logEvents.push({ id: `fin-rev-${Date.now()}-${agency.id}`, date: today, type: 'REVENUE', label: 'Recettes', deltaBudgetReal: totalRevenue, description: `Facturation client (VE: ${agency.ve_current}).` });\n\n            const ref = doc(db, \"agencies\", agency.id);\n            batch.update(ref, {\n                budget_real: currentBudget,\n                members: updatedMembers,\n                eventLog: [...agency.eventLog, ...logEvents]\n            });\n        });\n\n        if (processedCount > 0) {\n            await batch.commit();\n            toast('success', `Finance Classe ${targetClass}: Terminée.`);\n        }\n      } catch(e) { console.error(e); toast('error', \"Erreur Finance\"); }\n  };\n\n  // --- PROCESS: PERFORMANCE ---\n  const processPerformance = async (targetClass: 'A' | 'B') => {\n      const today = new Date().toISOString().split('T')[0];\n      try {\n        const batch = writeBatch(db);\n        let processedCount = 0;\n\n        agencies.forEach(agency => {\n            if (agency.id === 'unassigned' || agency.classId !== targetClass) return;\n            processedCount++;\n            \n            let logEvents: GameEvent[] = [];\n            const updatedMembers = agency.members.map(member => {\n                const reviews = agency.peerReviews.filter(r => r.targetId === member.id);\n                if (reviews.length === 0) return member;\n                const avg = reviews.reduce((sum, r) => sum + ((r.ratings.attendance + r.ratings.quality + r.ratings.involvement)/3), 0) / reviews.length;\n                let scoreDelta = 0;\n                let newStreak = member.streak || 0;\n                if (avg > 4.5) { scoreDelta = 2; newStreak++; if (newStreak >= 3) { scoreDelta += 10; newStreak = 0; } } \n                else if (avg >= 4.0) { scoreDelta = 1; newStreak = 0; } \n                else if (avg < 2.0) { scoreDelta = -5; newStreak = 0; } \n                else { newStreak = 0; }\n                return { ...member, individualScore: Math.max(0, Math.min(100, member.individualScore + scoreDelta)), streak: newStreak };\n            });\n\n            let veAdjustment = 0;\n            const budget = agency.budget_real;\n            if (budget >= 2000) veAdjustment += Math.floor(budget / 2000);\n            else if (budget < 0) veAdjustment -= Math.ceil(Math.abs(budget) / 1000) * 2;\n\n            if (veAdjustment !== 0) {\n                logEvents.push({ id: `perf-ve-${Date.now()}-${agency.id}`, date: today, type: veAdjustment > 0 ? 'VE_DELTA' : 'CRISIS', label: 'Ajustement VE', deltaVE: veAdjustment, description: veAdjustment > 0 ? 'Trésorerie saine.' : 'Dette.' });\n            }\n\n            let veCap = 100;\n            if (agency.members.length === 1) veCap = GAME_RULES.VE_CAP_1_MEMBER;\n            else if (agency.members.length <= 3) veCap = GAME_RULES.VE_CAP_2_3_MEMBERS;\n            else veCap = GAME_RULES.VE_CAP_4_PLUS_MEMBERS;\n            \n            const finalVE = Math.min(Math.max(0, agency.ve_current + veAdjustment), veCap);\n\n            const ref = doc(db, \"agencies\", agency.id);\n            batch.update(ref, {\n                members: updatedMembers,\n                ve_current: finalVE,\n                peerReviews: [], \n                eventLog: [...agency.eventLog, ...logEvents],\n                status: finalVE >= 60 ? 'stable' : finalVE >= 40 ? 'fragile' : 'critique'\n            });\n        });\n\n        if (processedCount > 0) {\n            await batch.commit();\n            toast('success', `Performance Classe ${targetClass}: Terminée.`);\n        }\n      } catch(e) { console.error(e); toast('error', \"Erreur Performance\"); }\n  };\n\n  const transferFunds = async (sourceId: string, targetId: string, amount: number) => { /* Impl */ };\n  const tradeScoreForCash = async (studentId: string, scoreAmount: number) => { /* Impl */ };\n  const injectCapital = async (studentId: string, agencyId: string, amount: number) => { \n      const agency = agencies.find(a => a.id === agencyId);\n      if(!agency) return;\n      const student = agency.members.find(m => m.id === studentId);\n      if(!student || (student.wallet || 0) < amount) return;\n      \n      const batch = writeBatch(db);\n      const updatedMembers = agency.members.map(m => m.id === studentId ? { ...m, wallet: (m.wallet || 0) - amount } : m);\n      const updatedAgency = { ...agency, members: updatedMembers, budget_real: agency.budget_real + amount };\n      batch.set(doc(db, \"agencies\", agency.id), updatedAgency, { merge: true });\n      await batch.commit();\n      toast('success', 'Injection réussie');\n  };\n  \n  const requestScorePurchase = async (studentId: string, agencyId: string, amountPixi: number, amountScore: number) => { \n     const agency = agencies.find(a => a.id === agencyId);\n     if(!agency) return;\n     const newRequest: TransactionRequest = { id: `req-score-${Date.now()}`, studentId, studentName: agency.members.find(m=>m.id===studentId)?.name || '', type: 'BUY_SCORE', amountPixi, amountScore, status: 'PENDING', date: new Date().toISOString().split('T')[0] };\n     await updateDoc(doc(db, \"agencies\", agency.id), { transactionRequests: [...(agency.transactionRequests || []), newRequest] });\n     toast('success', \"Demande envoyée\");\n  };\n\n  const handleTransactionRequest = async (agency: Agency, request: TransactionRequest, approved: boolean) => {\n      const batch = writeBatch(db);\n      const agencyRef = doc(db, \"agencies\", agency.id);\n      const updatedRequests = (agency.transactionRequests || []).filter(r => r.id !== request.id);\n      if (!approved) { batch.update(agencyRef, { transactionRequests: updatedRequests }); await batch.commit(); return; }\n      \n      const updatedMembers = agency.members.map(m => m.id === request.studentId ? { ...m, wallet: (m.wallet || 0) - request.amountPixi, individualScore: Math.min(100, m.individualScore + request.amountScore) } : m);\n      batch.update(agencyRef, { transactionRequests: updatedRequests, members: updatedMembers });\n      await batch.commit();\n      toast('success', \"Transaction validée\");\n  };\n\n  const submitMercatoVote = async (agencyId: string, requestId: string, voterId: string, vote: 'APPROVE' | 'REJECT') => {\n      const agency = agencies.find(a => a.id === agencyId);\n      if(!agency) return;\n      const request = agency.mercatoRequests.find(r => r.id === requestId);\n      if(!request) return;\n\n      const newVotes = { ...request.votes, [voterId]: vote };\n      const approvals = Object.values(newVotes).filter(v => v === 'APPROVE').length;\n      let totalVoters = agency.members.length;\n      let threshold = 0.66;\n      if (request.type === 'FIRE' && request.requesterId !== request.studentId) { totalVoters = Math.max(1, agency.members.length - 1); threshold = 0.75; }\n\n      const batch = writeBatch(db);\n      if (approvals / totalVoters > threshold) {\n          const targetAgency = agencies.find(a => a.id === 'unassigned');\n          if(targetAgency) {\n               const student = agency.members.find(m => m.id === request.studentId);\n               if(student) {\n                   const updatedSource = agency.members.filter(m => m.id !== request.studentId);\n                   const updatedTarget = [...targetAgency.members, { ...student, history: [] }];\n                   batch.update(doc(db, \"agencies\", agency.id), { members: updatedSource, mercatoRequests: agency.mercatoRequests.filter(r => r.id !== requestId) });\n                   batch.update(doc(db, \"agencies\", targetAgency.id), { members: updatedTarget });\n               }\n          }\n      } else {\n          const updatedRequests = agency.mercatoRequests.map(r => r.id === requestId ? { ...r, votes: newVotes } : r);\n          batch.update(doc(db, \"agencies\", agency.id), { mercatoRequests: updatedRequests });\n      }\n      await batch.commit();\n      toast('success', \"Vote enregistré\");\n  };\n\n  // --- BLACK OPS LOGIC ---\n  const triggerBlackOp = async (sourceAgencyId: string, targetAgencyId: string, type: 'AUDIT' | 'LEAK') => {\n      const week = getCurrentGameWeek();\n      if (week < GAME_RULES.UNLOCK_WEEK_BLACK_OPS) {\n          toast('error', `Disponible en Semaine ${GAME_RULES.UNLOCK_WEEK_BLACK_OPS} uniquement.`);\n          return;\n      }\n\n      const sourceAgency = agencies.find(a => a.id === sourceAgencyId);\n      const targetAgency = agencies.find(a => a.id === targetAgencyId);\n      if (!sourceAgency || !targetAgency) return;\n\n      const cost = type === 'AUDIT' ? GAME_RULES.COST_AUDIT : GAME_RULES.COST_LEAK;\n\n      if (sourceAgency.budget_real < cost) {\n          toast('error', \"Fonds insuffisants pour cette opération.\");\n          return;\n      }\n\n      const batch = writeBatch(db);\n      const today = new Date().toISOString().split('T')[0];\n\n      // 1. Pay Cost\n      const sourceRef = doc(db, \"agencies\", sourceAgency.id);\n      batch.update(sourceRef, {\n          budget_real: sourceAgency.budget_real - cost,\n          eventLog: [...sourceAgency.eventLog, {\n              id: `op-cost-${Date.now()}`, date: today, type: 'BLACK_OP', label: `Opération: ${type}`, deltaBudgetReal: -cost, description: `Paiement prestataire externe.`\n          }]\n      });\n\n      // 2. Execute Effect\n      if (type === 'LEAK') {\n          toast('success', \"Fuite obtenue : Le brief de la semaine prochaine contient une contrainte 'Low Tech'.\");\n      } else if (type === 'AUDIT') {\n          const isVulnerable = targetAgency.budget_real < 0 || targetAgency.ve_current < 40;\n          if (isVulnerable) {\n               const targetRef = doc(db, \"agencies\", targetAgency.id);\n               batch.update(targetRef, {\n                   ve_current: Math.max(0, targetAgency.ve_current - 10),\n                   eventLog: [...targetAgency.eventLog, {\n                       id: `op-hit-${Date.now()}`, date: today, type: 'CRISIS', label: \"Audit Externe (Sanction)\", deltaVE: -10, description: \"Des irrégularités ont été exposées par un audit concurrent.\"\n                   }]\n               });\n               toast('success', `Audit réussi ! ${targetAgency.name} perd 10 VE.`);\n          } else {\n               batch.update(sourceRef, {\n                   ve_current: Math.max(0, sourceAgency.ve_current - 20),\n                   eventLog: [...sourceAgency.eventLog, {\n                       id: `op-fail-${Date.now()}`, date: today, type: 'CRISIS', label: \"Procès Diffamation\", deltaVE: -20, description: \"L'audit n'a rien révélé. L'agence cible porte plainte.\"\n                   }]\n               });\n               toast('error', `Echec ! ${targetAgency.name} est clean. Vous perdez 20 VE pour diffamation.`);\n          }\n      }\n      await batch.commit();\n  };\n\n  // --- MERGERS LOGIC ---\n  const proposeMerger = async (sourceAgencyId: string, targetAgencyId: string) => {\n      const week = getCurrentGameWeek();\n      if (week < GAME_RULES.UNLOCK_WEEK_MERGERS) {\n          toast('error', `Fusions disponibles en Semaine ${GAME_RULES.UNLOCK_WEEK_MERGERS}.`);\n          return;\n      }\n      \n      const targetAgency = agencies.find(a => a.id === targetAgencyId);\n      if(!targetAgency) return;\n\n      if (targetAgency.ve_current > GAME_RULES.MERGER_VE_THRESHOLD) {\n           toast('error', \"Cette agence est trop stable pour être rachetée (VE > 40).\");\n           return;\n      }\n\n      const request: MergerRequest = {\n          id: `merger-${Date.now()}`,\n          requesterAgencyId: sourceAgencyId,\n          requesterAgencyName: agencies.find(a => a.id === sourceAgencyId)?.name || 'Inconnu',\n          targetAgencyId: targetAgencyId,\n          status: 'PENDING',\n          date: new Date().toISOString().split('T')[0],\n          offerDetails: \"Rachat complet de la dette et intégration des effectifs.\"\n      };\n\n      const targetRef = doc(db, \"agencies\", targetAgencyId);\n      await updateDoc(targetRef, {\n          mergerRequests: [...(targetAgency.mergerRequests || []), request]\n      });\n      toast('success', \"Proposition de rachat envoyée.\");\n  };\n\n  const finalizeMerger = async (mergerId: string, targetAgencyId: string, approved: boolean) => {\n      const targetAgency = agencies.find(a => a.id === targetAgencyId);\n      if(!targetAgency) return;\n      const request = targetAgency.mergerRequests?.find(r => r.id === mergerId);\n      if(!request) return;\n\n      const batch = writeBatch(db);\n      const updatedRequests = targetAgency.mergerRequests?.filter(r => r.id !== mergerId);\n      \n      if (!approved) {\n           batch.update(doc(db, \"agencies\", targetAgencyId), { mergerRequests: updatedRequests });\n           await batch.commit();\n           toast('info', \"Fusion refusée.\");\n           return;\n      }\n\n      const sourceAgency = agencies.find(a => a.id === request.requesterAgencyId);\n      if(!sourceAgency) return;\n\n      if (sourceAgency.members.length + targetAgency.members.length > GAME_RULES.MERGER_MAX_MEMBERS) {\n          toast('error', `Fusion impossible : La nouvelle équipe dépasserait ${GAME_RULES.MERGER_MAX_MEMBERS} membres.`);\n          return;\n      }\n\n      const newMembers = [...sourceAgency.members, ...targetAgency.members];\n      const newBudget = sourceAgency.budget_real + targetAgency.budget_real;\n      \n      batch.update(doc(db, \"agencies\", sourceAgency.id), {\n          members: newMembers,\n          budget_real: newBudget,\n          eventLog: [...sourceAgency.eventLog, {\n              id: `merger-win-${Date.now()}`, date: new Date().toISOString().split('T')[0], type: 'MERGER', label: \"Acquisition\", description: `Rachat de ${targetAgency.name}. Dette absorbée.`\n          }]\n      });\n\n      batch.update(doc(db, \"agencies\", targetAgency.id), {\n          members: [],\n          status: 'critique',\n          name: `${targetAgency.name} (Dissoute)`,\n          mergerRequests: []\n      });\n\n      await batch.commit();\n      toast('success', \"Fusion confirmée. Agence absorbée.\");\n  };\n\n  const resetGame = async () => {\n      try { await seedDatabase(); } catch (e) { console.error(e); }\n  };\n\n  return (\n    <GameContext.Provider value={{\n      agencies, weeks, resources, role, selectedAgencyId, isAutoMode,\n      setRole, selectAgency, toggleAutoMode, updateAgency, updateAgenciesList, deleteAgency, updateWeek,\n      addResource, deleteResource, shuffleConstraints, processFinance, processPerformance, resetGame,\n      transferFunds, tradeScoreForCash, injectCapital, requestScorePurchase, handleTransactionRequest,\n      submitMercatoVote, triggerBlackOp, proposeMerger, finalizeMerger, getCurrentGameWeek\n    }}>\n      {children}\n    </GameContext.Provider>\n  );\n};\n"
            }
          ]
        },
        {
          "path": "components/AdminProjects.tsx",
          "generationType": 1,
          "isDone": true,
          "description": "Ajout du bouton de suppression (Corbeille) avec logique de confirmation.",
          "diffs": [
            {
              "target": "",
              "replacement": "\nimport React, { useState } from 'react';\nimport { Agency } from '../types';\nimport { Save, MapPin, Target, Zap, HelpCircle, PenTool, List, Trash2 } from 'lucide-react';\nimport { useUI } from '../contexts/UIContext';\nimport { useGame } from '../contexts/GameContext';\n\ninterface AdminProjectsProps {\n  agencies: Agency[];\n  onUpdateAgency: (agency: Agency) => void;\n  readOnly?: boolean;\n}\n\nexport const AdminProjects: React.FC<AdminProjectsProps> = ({ agencies, onUpdateAgency, readOnly }) => {\n  const { confirm, toast } = useUI();\n  const { deleteAgency } = useGame();\n  \n  const [editingId, setEditingId] = useState<string | null>(null);\n  const [formData, setFormData] = useState({ problem: '', target: '', location: '', gesture: '' });\n\n  const activeAgencies = agencies.filter(a => a.id !== 'unassigned');\n\n  const startEditing = (agency: Agency) => {\n    setEditingId(agency.id);\n    setFormData(agency.projectDef);\n  };\n\n  const handleSave = (agency: Agency) => {\n    onUpdateAgency({\n        ...agency,\n        projectDef: {\n            ...agency.projectDef,\n            ...formData\n        }\n    });\n    setEditingId(null);\n  };\n\n  const handleDelete = async (agency: Agency) => {\n      if(readOnly) return;\n      \n      const memberCount = agency.members.length;\n      const message = memberCount > 0 \n        ? `ATTENTION : Cette agence contient ${memberCount} membres.\\n\\nSi vous supprimez, ils seront transférés automatiquement dans le vivier \"Chômage\".`\n        : \"Voulez-vous supprimer définitivement cette agence ?\";\n\n      const isConfirmed = await confirm({\n          title: `Supprimer ${agency.name} ?`,\n          message: message,\n          confirmText: \"Supprimer Définitivement\",\n          isDangerous: true\n      });\n\n      if(isConfirmed) {\n          await deleteAgency(agency.id);\n      }\n  };\n\n  return (\n    <div className=\"animate-in fade-in duration-500 pb-20\">\n         <div className=\"mb-8\">\n            <h2 className=\"text-3xl font-display font-bold text-slate-900\">Gestion des Projets & Agences</h2>\n            <p className=\"text-slate-500 text-sm\">Vue d'ensemble des indicateurs (VE, Budget) et des définitions de projet.</p>\n        </div>\n\n        {/* --- TABLEAU RÉCAPITULATIF (DÉPLACÉ DU DASHBOARD) --- */}\n        <div className=\"mb-10\">\n            <h3 className=\"text-lg font-bold text-slate-900 mb-4 flex items-center gap-2\">\n                <List size={20}/> État des Lieux\n            </h3>\n            \n            <div className=\"bg-white rounded-3xl border border-slate-200 overflow-hidden shadow-sm\">\n                <table className=\"w-full text-left\">\n                    <thead className=\"bg-slate-50 text-slate-500 text-[10px] uppercase font-bold border-b border-slate-100\">\n                        <tr>\n                            <th className=\"p-4\">Agence</th>\n                            <th className=\"p-4 hidden md:table-cell\">Statut</th>\n                            <th className=\"p-4 text-right\">VE</th>\n                            <th className=\"p-4 text-right hidden md:table-cell\">Budget</th>\n                            <th className=\"p-4 text-right\">Membres</th>\n                            <th className=\"p-4 text-right\">Action</th>\n                        </tr>\n                    </thead>\n                    <tbody className=\"divide-y divide-slate-100\">\n                        {activeAgencies\n                            .sort((a,b) => b.ve_current - a.ve_current)\n                            .map(agency => (\n                            <tr key={agency.id} className=\"hover:bg-slate-50 transition-colors group\">\n                                <td className=\"p-3 pl-4\">\n                                    <div className=\"flex items-center gap-3\">\n                                        <div className={`w-8 h-8 rounded-lg flex items-center justify-center font-bold text-xs border ${\n                                            agency.classId === 'A' ? 'bg-blue-50 text-blue-600 border-blue-100' : 'bg-purple-50 text-purple-600 border-purple-100'\n                                        }`}>\n                                            {agency.name.substring(0,2)}\n                                        </div>\n                                        <div>\n                                            <div className=\"font-bold text-sm text-slate-900\">{agency.name}</div>\n                                            <div className=\"text-[10px] text-slate-400\">Classe {agency.classId}</div>\n                                        </div>\n                                    </div>\n                                </td>\n                                <td className=\"p-3 hidden md:table-cell\">\n                                    <span className={`inline-flex items-center gap-1.5 px-2 py-1 rounded text-[10px] font-bold uppercase ${\n                                        agency.status === 'stable' ? 'bg-emerald-50 text-emerald-600' : \n                                        agency.status === 'fragile' ? 'bg-amber-50 text-amber-600' : \n                                        'bg-red-50 text-red-600'\n                                    }`}>\n                                        <span className={`w-1.5 h-1.5 rounded-full ${\n                                            agency.status === 'stable' ? 'bg-emerald-500' : \n                                            agency.status === 'fragile' ? 'bg-amber-500' : \n                                            'bg-red-500'\n                                        }`}></span>\n                                        {agency.status}\n                                    </span>\n                                </td>\n                                <td className=\"p-3 text-right\">\n                                    <span className=\"font-display font-bold text-lg text-slate-900\">{agency.ve_current}</span>\n                                </td>\n                                <td className=\"p-3 text-right hidden md:table-cell\">\n                                    <span className={`text-xs font-bold ${agency.budget_real < 0 ? 'text-red-500' : 'text-slate-500'}`}>\n                                        {agency.budget_real} PiXi\n                                    </span>\n                                </td>\n                                <td className=\"p-3 text-right\">\n                                    <span className=\"text-xs font-bold text-slate-500 bg-slate-100 px-2 py-1 rounded-full\">{agency.members.length}</span>\n                                </td>\n                                <td className=\"p-3 text-right\">\n                                    {!readOnly && (\n                                        <button \n                                            onClick={() => handleDelete(agency)}\n                                            className=\"p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors\"\n                                            title=\"Supprimer l'agence\"\n                                        >\n                                            <Trash2 size={16}/>\n                                        </button>\n                                    )}\n                                </td>\n                            </tr>\n                        ))}\n                    </tbody>\n                </table>\n            </div>\n        </div>\n\n        {/* --- CARTES PROJETS --- */}\n        <h3 className=\"text-lg font-bold text-slate-900 mb-4 flex items-center gap-2\">\n            <Zap size={20}/> Détails Projets\n        </h3>\n        <div className=\"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-2 gap-6\">\n            {agencies.filter(a => a.id !== 'unassigned').map(agency => (\n                <div key={agency.id} className=\"bg-white rounded-2xl border border-slate-200 overflow-hidden shadow-sm flex flex-col\">\n                    {/* Header */}\n                    <div className=\"p-4 bg-slate-50 border-b border-slate-100 flex justify-between items-center\">\n                        <div className=\"flex items-center gap-3\">\n                             <div className=\"w-10 h-10 rounded-lg bg-white border border-slate-200 flex items-center justify-center font-bold text-slate-500 text-xs\">\n                                {agency.name.substring(0,2)}\n                            </div>\n                            <div>\n                                <h3 className=\"font-bold text-slate-900 leading-tight\">{agency.name}</h3>\n                                <p className=\"text-xs text-slate-400\">{agency.members.length} membres</p>\n                            </div>\n                        </div>\n                        {editingId !== agency.id && !readOnly && (\n                             <button onClick={() => startEditing(agency)} className=\"text-indigo-600 p-2 hover:bg-indigo-50 rounded-lg transition-colors flex items-center gap-2 text-xs font-bold\">\n                                <PenTool size={14} /> Éditer\n                            </button>\n                        )}\n                    </div>\n\n                    {/* Content */}\n                    <div className=\"p-5 flex-1\">\n                        {editingId === agency.id ? (\n                            <div className=\"space-y-4\">\n                                <div>\n                                    <label className=\"text-xs font-bold text-slate-500 uppercase\">Problème</label>\n                                    <textarea \n                                        value={formData.problem} \n                                        onChange={e => setFormData({...formData, problem: e.target.value})}\n                                        className=\"w-full border border-slate-300 rounded-lg p-2 text-sm text-slate-900 min-h-[60px] bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500\" \n                                    />\n                                </div>\n                                <div>\n                                    <label className=\"text-xs font-bold text-slate-500 uppercase\">Cible (Persona)</label>\n                                    <textarea \n                                        value={formData.target} \n                                        onChange={e => setFormData({...formData, target: e.target.value})}\n                                        className=\"w-full border border-slate-300 rounded-lg p-2 text-sm text-slate-900 min-h-[60px] bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500\" \n                                    />\n                                </div>\n                                <div className=\"grid grid-cols-2 gap-3\">\n                                    <div>\n                                        <label className=\"text-xs font-bold text-slate-500 uppercase\">Lieu</label>\n                                        <input \n                                            type=\"text\" \n                                            value={formData.location} \n                                            onChange={e => setFormData({...formData, location: e.target.value})}\n                                            className=\"w-full border border-slate-300 rounded-lg p-2 text-sm text-slate-900 bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500\" \n                                        />\n                                    </div>\n                                    <div>\n                                        <label className=\"text-xs font-bold text-slate-500 uppercase\">Geste Archi</label>\n                                        <input \n                                            type=\"text\" \n                                            value={formData.gesture} \n                                            onChange={e => setFormData({...formData, gesture: e.target.value})}\n                                            className=\"w-full border border-slate-300 rounded-lg p-2 text-sm text-slate-900 bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500\" \n                                        />\n                                    </div>\n                                </div>\n                                <div className=\"flex gap-2 pt-2 border-t border-slate-100 mt-2\">\n                                    <button \n                                        onClick={() => handleSave(agency)}\n                                        className=\"flex-1 bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded-lg font-bold text-xs flex items-center justify-center gap-2\"\n                                    >\n                                        <Save size={14}/> Sauvegarder\n                                    </button>\n                                    <button \n                                        onClick={() => setEditingId(null)}\n                                        className=\"px-3 py-2 text-slate-500 hover:bg-slate-100 rounded-lg font-bold text-xs\"\n                                    >\n                                        Annuler\n                                    </button>\n                                </div>\n                            </div>\n                        ) : (\n                            <div className=\"space-y-4 h-full\">\n                                {(!agency.projectDef.problem && !agency.projectDef.location) ? (\n                                    <div className=\"h-full flex flex-col items-center justify-center text-slate-400 opacity-60 min-h-[150px]\">\n                                        <HelpCircle size={32} className=\"mb-2\"/>\n                                        <p className=\"text-sm italic\">Projet non défini</p>\n                                    </div>\n                                ) : (\n                                    <>\n                                        <div className=\"flex gap-3 items-start\">\n                                            <Zap size={18} className=\"text-amber-500 shrink-0 mt-0.5\"/>\n                                            <div>\n                                                <span className=\"text-[10px] uppercase font-bold text-slate-400 block\">Problème</span>\n                                                <p className=\"text-sm font-medium text-slate-800 leading-snug\">{agency.projectDef.problem}</p>\n                                            </div>\n                                        </div>\n                                        \n                                        <div className=\"flex gap-3 items-start\">\n                                            <Target size={18} className=\"text-indigo-500 shrink-0 mt-0.5\"/>\n                                            <div>\n                                                <span className=\"text-[10px] uppercase font-bold text-slate-400 block\">Cible</span>\n                                                <p className=\"text-sm font-medium text-slate-800 leading-snug\">{agency.projectDef.target}</p>\n                                            </div>\n                                        </div>\n\n                                        <div className=\"grid grid-cols-2 gap-4 pt-2 border-t border-slate-50\">\n                                             <div className=\"flex gap-2 items-center\">\n                                                <MapPin size={16} className=\"text-emerald-500 shrink-0\"/>\n                                                <div className=\"overflow-hidden\">\n                                                    <span className=\"text-[10px] uppercase font-bold text-slate-400 block\">Lieu</span>\n                                                    <p className=\"text-sm font-bold text-slate-900 truncate\" title={agency.projectDef.location}>{agency.projectDef.location}</p>\n                                                </div>\n                                             </div>\n                                             <div>\n                                                <span className=\"text-[10px] uppercase font-bold text-slate-400 block\">Geste Archi</span>\n                                                <p className=\"text-sm font-bold text-slate-900 truncate\" title={agency.projectDef.gesture}>{agency.projectDef.gesture || '...'}</p>\n                                             </div>\n                                        </div>\n                                    </>\n                                )}\n                            </div>\n                        )}\n                    </div>\n                </div>\n            ))}\n        </div>\n    </div>\n  );\n};\n"
            }
          ]
        },
        {
          "path": "components/AdminMercato.tsx",
          "generationType": 1,
          "isDone": true,
          "description": "Refonte de la création d'agence avec modale complète (Nom, Classe, Fondateur, Paiement).",
          "diffs": [
            {
              "target": "",
              "replacement": "\nimport React, { useState, useMemo } from 'react';\nimport { Agency, MercatoRequest, CycleType } from '../types';\nimport { ArrowRightLeft, UserPlus, Briefcase, Plus, AlertCircle, Check, X, Quote, Building2 } from 'lucide-react';\nimport { useUI } from '../contexts/UIContext';\nimport { GAME_RULES, INITIAL_WEEKS } from '../constants';\nimport { Modal } from './Modal';\n\ninterface AdminMercatoProps {\n  agencies: Agency[];\n  onUpdateAgencies: (agencies: Agency[]) => void;\n  readOnly?: boolean;\n}\n\nexport const AdminMercato: React.FC<AdminMercatoProps> = ({ agencies, onUpdateAgencies, readOnly }) => {\n  const { confirm, toast } = useUI();\n  const [selectedStudentId, setSelectedStudentId] = useState<string | null>(null);\n  const [targetAgencyId, setTargetAgencyId] = useState<string | null>(null);\n\n  // --- CREATE MODAL STATE ---\n  const [isCreateModalOpen, setIsCreateModalOpen] = useState(false);\n  const [createForm, setCreateForm] = useState({\n      name: '',\n      classId: 'A' as 'A' | 'B',\n      founderId: 'NONE', // 'NONE' or student ID\n      applyCost: false // If true, deducts PiXi from student\n  });\n\n  const unassignedAgency = agencies.find(a => a.id === 'unassigned');\n  const activeAgencies = agencies.filter(a => a.id !== 'unassigned');\n\n  // Filter unemployed students based on selected class in form\n  const availableFounders = useMemo(() => {\n      if (!unassignedAgency) return [];\n      return unassignedAgency.members.filter(m => m.classId === createForm.classId);\n  }, [unassignedAgency, createForm.classId]);\n\n  const pendingRequests = useMemo(() => {\n      const requests: {req: MercatoRequest, agency: Agency}[] = [];\n      agencies.forEach(a => {\n          (a.mercatoRequests || []).forEach(r => {\n              if (r.status === 'PENDING') requests.push({req: r, agency: a});\n          });\n      });\n      return requests;\n  }, [agencies]);\n\n  const findStudentData = (studentId: string) => {\n    for (const agency of agencies) {\n        const student = agency.members.find(m => m.id === studentId);\n        if (student) return { student, agency };\n    }\n    return null;\n  };\n\n  const calculateFiringVEDelta = (score: number) => {\n      if (score < 30) return 10;\n      if (score < 50) return 5;\n      if (score < 70) return -5;\n      if (score < 90) return -15;\n      return -25;\n  };\n\n  const executeTransfer = (studentId: string, sourceAgencyId: string, targetAgencyId: string, transferType: 'HIRE' | 'FIRE' | 'TRANSFER', reason?: string) => {\n    const sourceAgency = agencies.find(a => a.id === sourceAgencyId);\n    const targetAgency = agencies.find(a => a.id === targetAgencyId);\n    const student = sourceAgency?.members.find(m => m.id === studentId);\n\n    if (!sourceAgency || !targetAgency || !student) return;\n\n    const today = new Date().toISOString().split('T')[0];\n    const newHistory = [...(student.history || [])];\n    \n    if (sourceAgencyId !== 'unassigned') {\n        newHistory.push({\n            date: today, agencyId: sourceAgency.id, agencyName: sourceAgency.name,\n            action: transferType === 'FIRE' ? 'FIRED' : 'LEFT',\n            contextVE: sourceAgency.ve_current, contextBudget: sourceAgency.budget_real,\n            reason: reason || (transferType === 'FIRE' ? \"Licenciement\" : \"Départ\")\n        });\n    }\n\n    if (targetAgencyId !== 'unassigned') {\n        newHistory.push({\n            date: today, agencyId: targetAgency.id, agencyName: targetAgency.name,\n            action: 'JOINED', contextVE: targetAgency.ve_current, contextBudget: targetAgency.budget_real,\n            reason: reason || \"Recrutement\"\n        });\n    }\n\n    const updatedStudent = { ...student, history: newHistory };\n    const updatedSourceMembers = sourceAgency.members.filter(m => m.id !== student.id);\n    const updatedSource = { ...sourceAgency, members: updatedSourceMembers };\n    const updatedTargetMembers = [...targetAgency.members, updatedStudent];\n    const updatedTarget = { ...targetAgency, members: updatedTargetMembers };\n\n    let eventSource: any = null;\n    let eventTarget: any = null;\n    let sourceVEDelta = 0;\n    let targetVEDelta = 0;\n\n    if (transferType === 'FIRE') {\n        sourceVEDelta = calculateFiringVEDelta(student.individualScore);\n        let label = sourceVEDelta > 0 ? \"Restructuration\" : \"Perte Compétence\";\n        eventSource = {\n            id: `evt-${Date.now()}-1`, date: today, type: sourceVEDelta > 0 ? 'VE_DELTA' : 'CRISIS',\n            label: label, deltaVE: sourceVEDelta,\n            description: `Départ de ${student.name}.`\n        };\n    } else if (transferType === 'HIRE') {\n        targetVEDelta = -5;\n        eventTarget = {\n            id: `evt-${Date.now()}-2`, date: today, type: 'VE_DELTA', label: 'Recrutement Ext.', deltaVE: targetVEDelta,\n            description: `${student.name} rejoint l'équipe.`\n        };\n    }\n\n    if (eventSource && sourceAgency.id !== 'unassigned') {\n        updatedSource.eventLog = [...updatedSource.eventLog, eventSource];\n        updatedSource.ve_current = Math.max(0, updatedSource.ve_current + sourceVEDelta);\n    }\n    if (eventTarget && targetAgency.id !== 'unassigned') {\n        updatedTarget.eventLog = [...updatedTarget.eventLog, eventTarget];\n        updatedTarget.ve_current = Math.max(0, updatedTarget.ve_current + targetVEDelta);\n    }\n\n    return agencies.map(a => \n        a.id === sourceAgency.id ? updatedSource : \n        a.id === targetAgency.id ? updatedTarget : a\n    );\n  }\n\n  const handleManualTransfer = async () => {\n     if(readOnly) return;\n     if (!selectedStudentId || !targetAgencyId) return;\n     const sourceData = findStudentData(selectedStudentId);\n     if (!sourceData) return;\n\n     const student = sourceData.student;\n     const targetAgency = agencies.find(a => a.id === targetAgencyId);\n     \n     if (targetAgency && targetAgency.id !== 'unassigned' && targetAgency.classId !== student.classId) {\n         toast('error', `Classes incompatibles (Étudiant ${student.classId} -> Agence ${targetAgency.classId})`);\n         return;\n     }\n     \n     const type = sourceData.agency.id === 'unassigned' ? 'HIRE' : targetAgencyId === 'unassigned' ? 'FIRE' : 'TRANSFER';\n     const confirmed = await confirm({\n         title: \"Confirmation de Mouvement RH\",\n         message: `Forcer le mouvement de ${student.name} ?\\nDe ${sourceData.agency.name} vers ${targetAgency?.name || 'Chômage'}`,\n         confirmText: \"Valider\", isDangerous: type === 'FIRE'\n     });\n\n     if (!confirmed) return;\n\n     const newAgencies = executeTransfer(selectedStudentId, sourceData.agency.id, targetAgencyId, type, \"Action Admin\");\n     if(newAgencies) {\n         onUpdateAgencies(newAgencies);\n         toast('success', `Transfert effectué`);\n         setSelectedStudentId(null); setTargetAgencyId(null);\n     }\n  };\n\n  const handleApproveRequest = async (request: MercatoRequest, requestAgency: Agency) => {\n      if(readOnly) return;\n      \n      if (request.type === 'FOUND_AGENCY') {\n          const studentData = findStudentData(request.studentId);\n          if(!studentData) return;\n          \n          const student = studentData.student;\n          const newAgencyId = `a-${Date.now()}`;\n          const newAgency: Agency = {\n              id: newAgencyId, \n              name: `Studio de ${student.name}`, \n              tagline: \"Nouveau projet en cours...\", \n              ve_current: 20, \n              status: 'critique',\n              classId: student.classId, \n              budget_real: 2000, \n              budget_valued: 0, \n              weeklyTax: 0, \n              weeklyRevenueModifier: 0,\n              members: [{\n                  ...student,\n                  wallet: (student.wallet || 0) - GAME_RULES.CREATION_COST_PIXI,\n                  individualScore: Math.max(0, student.individualScore - GAME_RULES.CREATION_COST_SCORE)\n              }], \n              peerReviews: [], \n              eventLog: [{ id: `e-${newAgencyId}-1`, date: new Date().toISOString().split('T')[0], type: \"INFO\", label: \"Ouverture Studio\", deltaVE: 0, description: `Fondé par ${student.name}.` }],\n              currentCycle: CycleType.MARQUE_BRIEF, \n              constraints: { space: \"À définir\", style: \"À définir\", client: \"À définir\" },\n              projectDef: { problem: \"\", target: \"\", location: \"\", gesture: \"\", isLocked: false },\n              mercatoRequests: [], transactionRequests: [], mergerRequests: [],\n              branding: { color: student.classId === 'A' ? 'indigo' : 'cyan' }, \n              badges: [], \n              progress: JSON.parse(JSON.stringify(INITIAL_WEEKS))\n          };\n\n          const updatedAgencies = agencies.map(a => {\n              if (a.id === 'unassigned') return { ...a, members: a.members.filter(m => m.id !== student.id), mercatoRequests: a.mercatoRequests.filter(r => r.id !== request.id) };\n              return a;\n          });\n          onUpdateAgencies([...updatedAgencies, newAgency]);\n          toast('success', `Studio créé pour ${student.name}`);\n          return;\n      }\n\n      let newAgencies: Agency[] | undefined;\n      const studentData = findStudentData(request.studentId);\n      if(!studentData) return;\n\n      if (request.type === 'FIRE') {\n          newAgencies = executeTransfer(request.studentId, request.targetAgencyId, 'unassigned', 'FIRE', request.motivation);\n      } else if (request.type === 'HIRE') {\n          newAgencies = executeTransfer(request.studentId, studentData.agency.id, request.targetAgencyId, 'HIRE', request.motivation);\n      }\n\n      if (newAgencies) {\n          const finalAgencies = newAgencies.map(a => {\n             if (a.id === requestAgency.id) {\n                 return { ...a, mercatoRequests: a.mercatoRequests.filter(r => r.id !== request.id) };\n             }\n             return a;\n          });\n          onUpdateAgencies(finalAgencies);\n          toast('success', 'Demande validée.');\n      }\n  };\n\n  const handleRejectRequest = (request: MercatoRequest, requestAgency: Agency) => {\n      if(readOnly) return;\n      const updatedAgency = { ...requestAgency, mercatoRequests: requestAgency.mercatoRequests.filter(r => r.id !== request.id) };\n      onUpdateAgencies(agencies.map(a => a.id === updatedAgency.id ? updatedAgency : a));\n      toast('info', 'Demande rejetée.');\n  };\n\n  const handleCreateSubmit = () => {\n      const newAgencyId = `a-manual-${Date.now()}`;\n      let initialMembers: any[] = [];\n      let startBudget = 2000;\n\n      // 1. GESTION DU FONDATEUR\n      if (createForm.founderId !== 'NONE') {\n          const founder = unassignedAgency?.members.find(m => m.id === createForm.founderId);\n          if (founder) {\n              const updatedFounder = { ...founder };\n              if (createForm.applyCost) {\n                  updatedFounder.wallet = (updatedFounder.wallet || 0) - GAME_RULES.CREATION_COST_PIXI;\n                  updatedFounder.individualScore = Math.max(0, updatedFounder.individualScore - GAME_RULES.CREATION_COST_SCORE);\n                  startBudget += 0; // Le budget de l'agence commence à 2000 (financé par l'étudiant)\n              } else {\n                  // Si l'admin paie (subvention), l'étudiant ne paie rien, et l'agence reçoit le budget\n                  // startBudget reste 2000 (Subvention Admin)\n              }\n              initialMembers.push(updatedFounder);\n          }\n      }\n\n      // 2. CRÉATION AGENCE\n      const newAgency: Agency = {\n          id: newAgencyId, \n          name: createForm.name || \"Nouveau Studio\", \n          tagline: \"En construction...\", \n          ve_current: 20, \n          status: 'critique',\n          classId: createForm.classId, \n          budget_real: startBudget, \n          budget_valued: 0, \n          weeklyTax: 0, \n          weeklyRevenueModifier: 0,\n          members: initialMembers, \n          peerReviews: [], \n          eventLog: [{ \n              id: `e-${newAgencyId}-1`, \n              date: new Date().toISOString().split('T')[0], \n              type: \"INFO\", \n              label: \"Ouverture Studio\", \n              deltaVE: 0, \n              description: initialMembers.length > 0 \n                ? `Fondé par ${initialMembers[0].name} (${createForm.applyCost ? 'Fonds Propres' : 'Subvention Admin'}).` \n                : \"Création administrative vide.\" \n          }],\n          currentCycle: CycleType.MARQUE_BRIEF, \n          constraints: { space: \"À définir\", style: \"À définir\", client: \"À définir\" },\n          projectDef: { problem: \"\", target: \"\", location: \"\", gesture: \"\", isLocked: false },\n          mercatoRequests: [], \n          transactionRequests: [], \n          mergerRequests: [],\n          branding: { color: createForm.classId === 'A' ? 'indigo' : 'cyan' }, \n          badges: [], \n          progress: JSON.parse(JSON.stringify(INITIAL_WEEKS))\n      };\n\n      // 3. RETRAIT DU FONDATEUR DU VIVIER (Si applicable)\n      const updatedAgencies = agencies.map(a => {\n          if (a.id === 'unassigned' && createForm.founderId !== 'NONE') {\n              return { ...a, members: a.members.filter(m => m.id !== createForm.founderId) };\n          }\n          return a;\n      });\n\n      onUpdateAgencies([...updatedAgencies, newAgency]);\n      toast('success', 'Studio créé avec succès.');\n      setIsCreateModalOpen(false);\n      setCreateForm({ name: '', classId: 'A', founderId: 'NONE', applyCost: false });\n  };\n\n  return (\n    <div className=\"animate-in fade-in duration-500 pb-20\">\n        <div className=\"flex justify-between items-center mb-6\">\n            <div>\n                <h2 className=\"text-3xl font-display font-bold text-slate-900\">Mercato & RH</h2>\n                <p className=\"text-slate-500 text-sm\">Gérez les candidatures et les nouveaux studios.</p>\n            </div>\n            {!readOnly && (\n                <button \n                    onClick={() => setIsCreateModalOpen(true)} \n                    className=\"bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-xl font-bold text-sm flex items-center gap-2 transition-colors shadow-lg\"\n                >\n                    <Plus size={18} /> Ouvrir un Nouveau Studio\n                </button>\n            )}\n        </div>\n\n        {/* --- MODAL DE CREATION --- */}\n        <Modal isOpen={isCreateModalOpen} onClose={() => setIsCreateModalOpen(false)} title=\"Création de Studio (Admin)\">\n            <div className=\"space-y-6\">\n                <div>\n                    <label className=\"block text-xs font-bold text-slate-500 uppercase mb-1\">Nom du Studio</label>\n                    <input \n                        type=\"text\" \n                        value={createForm.name}\n                        onChange={(e) => setCreateForm({...createForm, name: e.target.value})}\n                        placeholder=\"Ex: Studio Alpha\"\n                        className=\"w-full p-3 border border-slate-200 rounded-xl font-bold focus:ring-2 focus:ring-indigo-500 outline-none\"\n                    />\n                </div>\n\n                <div>\n                    <label className=\"block text-xs font-bold text-slate-500 uppercase mb-1\">Classe de rattachement</label>\n                    <div className=\"flex gap-4\">\n                        <button \n                            onClick={() => setCreateForm({...createForm, classId: 'A'})}\n                            className={`flex-1 py-3 rounded-xl border-2 font-bold transition-all ${createForm.classId === 'A' ? 'border-blue-500 bg-blue-50 text-blue-600' : 'border-slate-100 text-slate-400'}`}\n                        >\n                            CLASSE A\n                        </button>\n                        <button \n                            onClick={() => setCreateForm({...createForm, classId: 'B'})}\n                            className={`flex-1 py-3 rounded-xl border-2 font-bold transition-all ${createForm.classId === 'B' ? 'border-purple-500 bg-purple-50 text-purple-600' : 'border-slate-100 text-slate-400'}`}\n                        >\n                            CLASSE B\n                        </button>\n                    </div>\n                </div>\n\n                <div>\n                    <label className=\"block text-xs font-bold text-slate-500 uppercase mb-1\">Premier Membre (Fondateur)</label>\n                    <select \n                        className=\"w-full p-3 border border-slate-200 rounded-xl bg-white text-sm font-medium\"\n                        value={createForm.founderId}\n                        onChange={(e) => setCreateForm({...createForm, founderId: e.target.value})}\n                    >\n                        <option value=\"NONE\">-- Aucun (Studio Vide) --</option>\n                        {availableFounders.map(s => (\n                            <option key={s.id} value={s.id}>{s.name} (Score: {s.individualScore})</option>\n                        ))}\n                    </select>\n                    <p className=\"text-xs text-slate-400 mt-1 italic\">\n                        {createForm.founderId !== 'NONE' ? \"L'étudiant sera retiré du vivier.\" : \"Vous devrez ajouter des membres manuellement plus tard.\"}\n                    </p>\n                </div>\n\n                {createForm.founderId !== 'NONE' && (\n                    <div className={`p-4 rounded-xl border transition-all ${createForm.applyCost ? 'bg-amber-50 border-amber-200' : 'bg-emerald-50 border-emerald-200'}`}>\n                        <label className=\"flex items-center gap-3 cursor-pointer\">\n                            <input \n                                type=\"checkbox\" \n                                checked={createForm.applyCost} \n                                onChange={(e) => setCreateForm({...createForm, applyCost: e.target.checked})}\n                                className=\"w-5 h-5 accent-indigo-600\"\n                            />\n                            <div>\n                                <span className={`font-bold text-sm block ${createForm.applyCost ? 'text-amber-800' : 'text-emerald-800'}`}>\n                                    {createForm.applyCost ? \"Facturer l'étudiant (Mode Normal)\" : \"Subvention Admin (Gratuit)\"}\n                                </span>\n                                <span className=\"text-xs text-slate-500 block mt-0.5\">\n                                    {createForm.applyCost \n                                        ? `L'étudiant paie ${GAME_RULES.CREATION_COST_PIXI} PiXi et ${GAME_RULES.CREATION_COST_SCORE} Score.` \n                                        : \"L'administration offre les frais de création.\"}\n                                </span>\n                            </div>\n                        </label>\n                    </div>\n                )}\n\n                <button \n                    onClick={handleCreateSubmit}\n                    disabled={!createForm.name}\n                    className={`w-full py-4 rounded-xl font-bold text-white shadow-lg flex items-center justify-center gap-2 transition-all ${!createForm.name ? 'bg-slate-300 cursor-not-allowed' : 'bg-indigo-600 hover:bg-indigo-700'}`}\n                >\n                    <Building2 size={20}/> Créer le Studio\n                </button>\n            </div>\n        </Modal>\n\n        {/* --- SECTION: PENDING REQUESTS --- */}\n        {pendingRequests.length > 0 && (\n            <div className=\"mb-8 bg-amber-50 border border-amber-200 rounded-2xl p-6\">\n                <h3 className=\"text-amber-800 font-bold flex items-center gap-2 mb-4\">\n                    <AlertCircle size={20}/> Demandes en attente ({pendingRequests.length})\n                </h3>\n                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n                    {pendingRequests.map(({req, agency}) => {\n                        const studentData = findStudentData(req.studentId);\n                        const student = studentData?.student;\n                        const isFoundation = req.type === 'FOUND_AGENCY';\n\n                        return (\n                            <div key={req.id} className=\"bg-white p-4 rounded-xl border border-amber-100 shadow-sm flex flex-col gap-2\">\n                                <div className=\"flex justify-between items-start\">\n                                    <div className=\"flex items-center gap-2\">\n                                        <span className={`text-[10px] font-bold px-2 py-0.5 rounded-md uppercase ${\n                                            isFoundation ? 'bg-purple-600 text-white' : \n                                            req.type === 'HIRE' ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'\n                                        }`}>\n                                            {isFoundation ? 'Fondation Studio' : req.type === 'HIRE' ? 'Embauche' : 'Départ'}\n                                        </span>\n                                        <span className=\"text-[10px] bg-slate-100 text-slate-500 px-1 rounded font-bold\">Cl. {student?.classId}</span>\n                                    </div>\n                                    {!readOnly && (\n                                    <div className=\"flex gap-1\">\n                                        <button onClick={() => handleRejectRequest(req, agency)} className=\"p-1.5 bg-slate-100 hover:bg-red-100 text-slate-400 hover:text-red-600 rounded-lg\"><X size={16}/></button>\n                                        <button onClick={() => handleApproveRequest(req, agency)} className=\"p-1.5 bg-slate-900 hover:bg-emerald-600 text-white rounded-lg\"><Check size={16}/></button>\n                                    </div>\n                                    )}\n                                </div>\n\n                                <div className=\"mt-1\">\n                                    <p className=\"font-bold text-slate-900 text-sm\">\n                                        {req.studentName}\n                                        <span className=\"block text-[10px] text-slate-400 font-normal mt-0.5\">\n                                            {isFoundation ? `veut fonder sa propre agence (-${GAME_RULES.CREATION_COST_PIXI} PiXi)` : `cible : ${agency.name}`}\n                                        </span>\n                                    </p>\n                                    {req.motivation && (\n                                        <div className=\"bg-slate-50 p-2 rounded-lg mt-2 flex gap-2 border border-slate-100\">\n                                            <Quote size={12} className=\"text-slate-300 shrink-0\"/>\n                                            <p className=\"text-xs text-slate-600 italic\">\"{req.motivation}\"</p>\n                                        </div>\n                                    )}\n                                </div>\n                            </div>\n                        );\n                    })}\n                </div>\n            </div>\n        )}\n\n        <div className=\"grid grid-cols-1 md:grid-cols-12 gap-6\">\n            <div className=\"md:col-span-12\">\n                <h3 className=\"text-sm font-bold text-slate-500 uppercase tracking-widest mb-3 flex items-center gap-2\">\n                    <Briefcase size={16}/> Vivier / Pôle Chômage\n                </h3>\n                <div className={`border-2 border-dashed rounded-2xl p-4 mb-8 transition-colors ${targetAgencyId === 'unassigned' ? 'bg-red-50 border-red-300' : 'bg-slate-100 border-slate-300'}`}>\n                    <div className=\"flex justify-between items-center mb-4\">\n                        <p className=\"text-sm text-slate-500 italic\">Cliquez sur un étudiant pour le sélectionner, puis choisissez une destination.</p>\n                        <button onClick={() => !readOnly && setTargetAgencyId('unassigned')} disabled={readOnly} className={`px-4 py-2 rounded-lg text-xs font-bold transition-all ${targetAgencyId === 'unassigned' ? 'bg-red-600 text-white' : 'bg-white text-slate-600 border border-slate-200'}`}>\n                            Action: Licencier\n                        </button>\n                    </div>\n                    <div className=\"flex flex-wrap gap-3\">\n                        {unassignedAgency?.members.map(student => (\n                            <div key={student.id} onClick={() => !readOnly && setSelectedStudentId(student.id)} className={`flex items-center gap-3 p-3 rounded-xl border-2 transition-all cursor-pointer ${selectedStudentId === student.id ? 'bg-white border-indigo-500 shadow-md transform scale-105' : 'bg-white border-slate-200'}`}>\n                                <img src={student.avatarUrl} className=\"w-8 h-8 rounded-full grayscale\" />\n                                <div>\n                                    <p className=\"font-bold text-slate-700 text-sm leading-none\">{student.name}</p>\n                                    <span className={`text-[9px] font-bold px-1.5 rounded text-white ${student.classId === 'A' ? 'bg-blue-400' : 'bg-purple-400'}`}>CLASSE {student.classId}</span>\n                                </div>\n                            </div>\n                        ))}\n                    </div>\n                </div>\n\n                <h3 className=\"text-sm font-bold text-slate-500 uppercase tracking-widest mb-3 flex items-center gap-2\"><UserPlus size={16}/> Agences Actives</h3>\n                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\n                    {activeAgencies.map(agency => (\n                        <div key={agency.id} className={`bg-white rounded-2xl border transition-all relative overflow-hidden ${targetAgencyId === agency.id ? 'border-indigo-500 shadow-lg ring-2 ring-indigo-100' : 'border-slate-200 hover:border-slate-300'}`}>\n                            <div className={`absolute top-0 left-0 right-0 h-1 ${agency.classId === 'A' ? 'bg-blue-400' : 'bg-purple-400'}`}></div>\n                            <div onClick={() => !readOnly && setTargetAgencyId(agency.id)} className={`p-4 border-b border-slate-100 flex justify-between items-center rounded-t-2xl mt-1 transition-colors cursor-pointer ${targetAgencyId === agency.id ? 'bg-indigo-50' : 'bg-slate-50'}`}>\n                                <div>\n                                    <h4 className=\"font-bold text-slate-700\">{agency.name}</h4>\n                                    <span className=\"text-[10px] font-bold px-1.5 py-0.5 rounded bg-slate-200 text-slate-600\">CLASSE {agency.classId}</span>\n                                </div>\n                                {targetAgencyId === agency.id && <span className=\"text-[10px] bg-indigo-200 text-indigo-800 px-2 rounded-full font-bold\">Cible</span>}\n                            </div>\n                            <div className=\"p-4 space-y-2\">\n                                {agency.members.map(student => (\n                                    <div key={student.id} onClick={(e) => { e.stopPropagation(); if(!readOnly) setSelectedStudentId(student.id); }} className={`flex items-center gap-3 p-2 rounded-xl transition-all cursor-pointer ${selectedStudentId === student.id ? 'bg-indigo-600 text-white shadow-md' : 'hover:bg-slate-50 text-slate-700'}`}>\n                                        <img src={student.avatarUrl} className=\"w-8 h-8 rounded-full\" />\n                                        <div className=\"flex-1\">\n                                            <p className=\"font-bold text-sm leading-none\">{student.name}</p>\n                                            <p className=\"text-[10px] mt-0.5 opacity-70\">{student.role}</p>\n                                        </div>\n                                    </div>\n                                ))}\n                            </div>\n                        </div>\n                    ))}\n                </div>\n            </div>\n        </div>\n        \n        {!readOnly && selectedStudentId && targetAgencyId && (\n        <div className=\"fixed bottom-6 left-1/2 transform -translate-x-1/2 md:ml-32 bg-slate-900 text-white px-6 py-4 rounded-2xl shadow-2xl flex items-center gap-6 z-50\">\n            <div className=\"flex items-center gap-3\">\n                 <div className=\"text-right\">\n                    <span className=\"block text-[10px] text-slate-400 uppercase font-bold\">Source: {findStudentData(selectedStudentId)?.agency.name}</span>\n                 </div>\n                 <ArrowRightLeft className=\"text-slate-500\" />\n                 <div>\n                    <span className=\"block text-[10px] text-slate-400 uppercase font-bold\">Cible: {targetAgencyId === 'unassigned' ? 'Chômage' : agencies.find(a => a.id === targetAgencyId)?.name}</span>\n                 </div>\n            </div>\n            <button onClick={handleManualTransfer} className=\"bg-white text-slate-900 px-6 py-2 rounded-xl font-bold text-sm hover:bg-indigo-50\">Transférer (Force)</button>\n        </div>\n        )}\n    </div>\n  );\n};\n"
            }
          ]
        }
      ]
    },
    "createdTimestamp": {
      "seconds": 1767803472,
      "nanos": 367000000
    },
    "doneTimestamp": {
      "seconds": 1767803515,
      "nanos": 715000000
    }
  }
]