[
  {
    "id": 24,
    "author": "user",
    "payload": {
      "type": "text",
      "text": "J'ai quelques soucis à résoudre :\n\n- Les étudiants voient leurs propres soldes, mais pas celui de l'entreprise, il faut que tu l'ajoute à la bannière\n\n- Les demandes des étudiants au chômage qui postulent dans une entreprise ne sont ni visibles par l'entreprise, ni par l'enseignant\n\n- L'enseignant n'a pas le droit d'envoyer des points ou des pixi à un étudiant pour un don/sanction custom",
      "files": [],
      "fileUploads": [],
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1767783566,
      "nanos": 251000000
    }
  },
  {
    "id": 25,
    "author": "model",
    "payload": {
      "type": "thinking",
      "text": "**Analyzing Agency Balance Display**\n\nI'm currently focused on the practical implications of displaying the company's balance (PiXi) within the \"RNP Studio Manager\" application's agency banner. The primary goal is enhanced accessibility for students. I'm considering how this integration affects UI design. This update will include the term \"Chômage.\"\n\n\n**Implementing UI Updates**\n\nI've been drilling into the UI implementation. The banner in `StudentAgencyView.tsx` will display the agency PiXi alongside the student's. I'm prioritizing visibility of student applications, particularly for unemployed students, in `AdminMercato.tsx` and `AgencyDemocracy.tsx`. I also need to verify and improve the manual override panel in `AdminCrisisStudent.tsx` for teacher rewards.\n\n\n**Validating Crisis Student Updates**\n\nI'm now zeroing in on the crisis student update function. The logic appears sound for students within agencies, applying score and wallet deltas correctly. However, I need to confirm the `onUpdateAgency` method handles unassigned students properly. I'll examine `GameContext.tsx` to ensure there's not a missing function for directly impacting individual student state, but it is unlikely given my analysis thus far.\n\n\n**Expanding Mercato Visibility**\n\nI'm expanding the visibility of hire requests and agency budget displays. Specifically, I'm working to display these requests and the agency budget properly in the Admin Dashboard, Mercato view, and Student's Agency Democracy tab. Also, I'm allowing teachers to provide students with Pixi or Points in the \"Zone de Crise\" > \"Cas Particuliers\" section. Now the Admin Crisis view will clearly label the score/wallet inputs.\n\n\n**Refining Hire Request Display**\n\nI'm now focusing on hire request visibility. The code in `AdminMercato.tsx` and `AgencyDemocracy.tsx` seems correct, using nested loops and filters to display requests from unemployed students. I'm exploring potential issues with the UI filters or state propagation. My investigation will involve checking if the requests are being correctly added to the target agency and displayed in the agency banner. I'll include the agency budget in `StudentAgencyView.tsx`, and I will examine the teacher reward fix in `AdminCrisisStudent.tsx`.\n\n\n**Clarifying Student Application View**\n\nI'm revisiting the student application visibility. Initially, my focus was on making sure the `handleApply` function correctly assigns students, including those unassigned, to agencies using `targetInfo.agencyId`. Now, I'm thinking the issue might be in how the AdminDashboard or AdminMercato displays the applications. To improve clarity, I'm planning an update to AdminMercato that will explicitly show \"Candidatures Externes.\"\n\n\n",
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1767783566,
      "nanos": 251000000
    },
    "doneTimestamp": {
      "seconds": 1767783578,
      "nanos": 330000000
    }
  },
  {
    "id": 26,
    "author": "model",
    "payload": {
      "type": "generationTable",
      "entries": [
        {
          "path": "components/StudentAgencyView.tsx",
          "generationType": 1,
          "isDone": true,
          "description": "Add agency balance (PiXi) to the header banner for student visibility.",
          "diffs": [
            {
              "target": "",
              "replacement": "\nimport React, { useState, useEffect } from 'react';\nimport { Agency, BrandColor, Student, GameEvent } from '../types';\nimport { Target, Users, History, Wallet, TrendingUp, HelpCircle, Briefcase, Settings, Image as ImageIcon, Shield, Eye, Crown, BookOpen, Send, Repeat, ArrowUpRight, Building2, Zap, AlertTriangle, PartyPopper, Gavel, Landmark } from 'lucide-react';\nimport { MarketOverview } from './student/MarketOverview';\nimport { MissionsView } from './student/MissionsView';\nimport { TeamView } from './student/TeamView';\nimport { HistoryView } from './student/HistoryView';\nimport { MercatoView } from './student/MercatoView';\nimport { WikiView } from './student/WikiView';\nimport { Modal } from './Modal';\nimport { GAME_RULES, BADGE_DEFINITIONS } from '../constants';\nimport { ref, uploadBytes, getDownloadURL } from 'firebase/storage';\nimport { storage } from '../services/firebase';\nimport { useUI } from '../contexts/UIContext';\nimport { useAuth } from '../contexts/AuthContext';\nimport { useGame } from '../contexts/GameContext';\n\ninterface StudentViewProps {\n  agency: Agency;\n  allAgencies: Agency[];\n  onUpdateAgency: (agency: Agency) => void;\n}\n\ntype TabType = 'MARKET' | 'MISSIONS' | 'TEAM' | 'RECRUITMENT' | 'HISTORY' | 'RESOURCES' | 'WALLET';\n\nconst COLOR_THEMES: Record<BrandColor, { bg: string, text: string }> = {\n    indigo: { bg: 'bg-indigo-600', text: 'text-indigo-600' },\n    emerald: { bg: 'bg-emerald-600', text: 'text-emerald-600' },\n    rose: { bg: 'bg-rose-600', text: 'text-rose-600' },\n    amber: { bg: 'bg-amber-500', text: 'text-amber-500' },\n    cyan: { bg: 'bg-cyan-500', text: 'text-cyan-500' },\n    slate: { bg: 'bg-slate-600', text: 'text-slate-600' },\n};\n\nexport const StudentAgencyView: React.FC<StudentViewProps> = ({ agency, allAgencies, onUpdateAgency }) => {\n  const { toast } = useUI();\n  const { currentUser } = useAuth();\n  const { transferFunds, injectCapital, requestScorePurchase, getCurrentGameWeek } = useGame();\n  \n  const [activeTab, setActiveTab] = useState<TabType>('MARKET');\n  const [showVERules, setShowVERules] = useState(false);\n  const [showSettings, setShowSettings] = useState(false);\n  \n  // State for Feature Unlock Modals\n  const [unlockModal, setUnlockModal] = useState<{title: string, message: string, icon: any, confirmText: string} | null>(null);\n  \n  // State for Real-Time Event Notifications (Crisis/Rewards)\n  const [notificationEvent, setNotificationEvent] = useState<GameEvent | null>(null);\n\n  const brandColor = agency.branding?.color || 'indigo';\n  const theme = COLOR_THEMES[brandColor];\n  const leaderboard = [...allAgencies].filter(a => a.id !== 'unassigned').sort((a, b) => b.ve_current - a.ve_current);\n  const myRank = leaderboard.findIndex(a => a.id === agency.id) + 1;\n  const rawSalary = agency.members.reduce((acc, member) => acc + (member.individualScore * GAME_RULES.SALARY_MULTIPLIER), 0);\n  const weeklyCharges = rawSalary * (1 + (agency.weeklyTax || 0)) + GAME_RULES.AGENCY_RENT;\n  const veRevenue = agency.ve_current * GAME_RULES.REVENUE_VE_MULTIPLIER;\n  const weeklyRevenue = GAME_RULES.REVENUE_BASE + veRevenue + (agency.weeklyRevenueModifier || 0);\n  const netWeekly = weeklyRevenue - weeklyCharges;\n  const myMemberProfile = agency.members.find(m => m.id === currentUser?.uid);\n\n  // --- 1. FEATURE UNLOCK CHECKER ---\n  useEffect(() => {\n      const currentWeek = getCurrentGameWeek();\n      \n      // CHECK WEEK 3: BLACK OPS\n      if (currentWeek >= GAME_RULES.UNLOCK_WEEK_BLACK_OPS) {\n          const hasSeenBlackOps = localStorage.getItem(`seen_unlock_blackops_${currentUser?.uid}`);\n          if (!hasSeenBlackOps) {\n              setUnlockModal({\n                  title: \"Intelligence Économique Activée\",\n                  message: \"Le marché se durcit. Vous avez désormais accès aux outils de veille stratégique.\\n\\nNouveauté : Audits concurrentiels et achat d'informations disponibles dans l'onglet 'Marché'.\",\n                  icon: <Eye size={32} className=\"text-yellow-500\"/>,\n                  confirmText: \"Compris, je reste vigilant\"\n              });\n              localStorage.setItem(`seen_unlock_blackops_${currentUser?.uid}`, 'true');\n              return; // Show only one at a time\n          }\n      }\n\n      // CHECK WEEK 6: MERGERS\n      if (currentWeek >= GAME_RULES.UNLOCK_WEEK_MERGERS) {\n          const hasSeenMergers = localStorage.getItem(`seen_unlock_mergers_${currentUser?.uid}`);\n          if (!hasSeenMergers) {\n              setUnlockModal({\n                  title: \"Fusions & Acquisitions (M&A)\",\n                  message: \"La consolidation du secteur commence. \\n\\nNouveauté : Il est désormais possible de racheter une agence en faillite (VE < 40) pour absorber ses talents et sa dette.\",\n                  icon: <Building2 size={32} className=\"text-indigo-500\"/>,\n                  confirmText: \"Voir les opportunités\"\n              });\n              localStorage.setItem(`seen_unlock_mergers_${currentUser?.uid}`, 'true');\n          }\n      }\n  }, [getCurrentGameWeek, currentUser]);\n\n  // --- 2. REAL-TIME EVENT NOTIFICATION SYSTEM ---\n  useEffect(() => {\n      if (agency.eventLog.length === 0) return;\n\n      // Get the very last event\n      const latestEvent = agency.eventLog[agency.eventLog.length - 1];\n      \n      // Define types that trigger a popup\n      const NOTIFY_TYPES = ['CRISIS', 'VE_DELTA'];\n      \n      if (NOTIFY_TYPES.includes(latestEvent.type)) {\n          // Check if already seen in LocalStorage to avoid spam on reload\n          const seenKey = `seen_event_${currentUser?.uid}_${latestEvent.id}`;\n          const hasSeen = localStorage.getItem(seenKey);\n\n          if (!hasSeen) {\n              setNotificationEvent(latestEvent);\n          }\n      }\n  }, [agency.eventLog, currentUser]);\n\n  const closeNotification = () => {\n      if (notificationEvent) {\n          localStorage.setItem(`seen_event_${currentUser?.uid}_${notificationEvent.id}`, 'true');\n          setNotificationEvent(null);\n      }\n  };\n\n  const handleColorChange = (color: BrandColor) => {\n      onUpdateAgency({ ...agency, branding: { ...agency.branding, color } });\n  };\n\n  const handleBannerUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {\n      if (e.target.files && e.target.files[0]) {\n          try {\n              const storageRef = ref(storage, `banners/${agency.id}_${Date.now()}`);\n              await uploadBytes(storageRef, e.target.files[0]);\n              const url = await getDownloadURL(storageRef);\n              onUpdateAgency({ ...agency, branding: { ...agency.branding, bannerUrl: url } });\n              toast('success', 'Bannière mise à jour');\n          } catch (error) { toast('error', \"Erreur d'upload\"); }\n      }\n  };\n\n  return (\n    <div className=\"flex flex-col min-h-[calc(100vh-6rem)] font-sans\">\n        {/* HEADER */}\n        <div className=\"relative mb-8 rounded-b-3xl md:rounded-3xl overflow-hidden bg-slate-100 min-h-[200px] md:min-h-[240px] shadow-md group\">\n            {agency.branding?.bannerUrl ? (\n                <img src={agency.branding.bannerUrl} className=\"absolute inset-0 w-full h-full object-cover\" alt=\"Banner\" />\n            ) : (\n                <div className={`absolute inset-0 opacity-10 ${theme.bg}`} style={{backgroundImage: 'radial-gradient(circle, #000 1px, transparent 1px)', backgroundSize: '20px 20px'}}></div>\n            )}\n            <div className=\"absolute inset-0 bg-gradient-to-t from-slate-900/90 via-slate-900/40 to-transparent\"></div>\n            {agency.id !== 'unassigned' && (\n                <button onClick={() => setShowSettings(true)} className=\"absolute top-4 right-4 p-2 bg-black/30 backdrop-blur-md rounded-full text-white hover:bg-black/50 transition-all opacity-0 group-hover:opacity-100 border border-white/10\">\n                    <Settings size={20}/>\n                </button>\n            )}\n            <div className=\"absolute bottom-0 left-0 right-0 p-6 flex flex-col xl:flex-row justify-between items-end xl:items-end gap-6 text-white\">\n                <div className=\"w-full xl:w-auto\">\n                    <div className=\"flex items-center gap-3 mb-1\">\n                        {agency.id !== 'unassigned' && <span className=\"bg-white/20 backdrop-blur border border-white/10 px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider\">Rang #{myRank}</span>}\n                        <span className=\"text-slate-300 italic text-sm truncate\">\"{agency.tagline}\"</span>\n                    </div>\n                    <h2 className=\"text-4xl md:text-5xl font-display font-bold tracking-tight drop-shadow-lg leading-none mb-3\">{agency.name}</h2>\n                    {/* Badges */}\n                    <div className=\"flex items-center gap-1\">\n                        {agency.badges && agency.badges.map(b => (\n                            <div key={b.id} title={b.label} className=\"w-6 h-6 rounded-full bg-yellow-400 text-yellow-900 flex items-center justify-center shadow-lg border border-yellow-200\"><Shield size={12}/></div>\n                        ))}\n                    </div>\n                </div>\n\n                {agency.id !== 'unassigned' && (\n                <div className=\"flex flex-col md:flex-row gap-4 w-full xl:w-auto bg-black/40 backdrop-blur-md p-4 rounded-2xl border border-white/10\">\n                    {/* Personal Wallet Stats */}\n                    {myMemberProfile && (\n                        <div onClick={() => setActiveTab('WALLET')} className=\"flex-1 md:text-right md:border-r border-white/20 md:pr-4 cursor-pointer group hover:bg-white/10 rounded-lg p-1 transition-colors\">\n                            <span className=\"text-[10px] font-bold text-yellow-300 uppercase tracking-widest block mb-1 group-hover:underline flex items-center gap-1 md:justify-end\">\n                                <Wallet size={12}/> Mon Solde\n                            </span>\n                            <div className=\"text-lg font-bold text-white flex items-center md:justify-end gap-2\">\n                                <span className=\"text-yellow-400 font-mono\">{myMemberProfile.wallet || 0} PiXi</span>\n                            </div>\n                        </div>\n                    )}\n                    \n                    {/* NEW: Agency Balance Display */}\n                    <div className=\"flex-1 md:text-right md:border-r border-white/20 md:pr-4\">\n                        <span className=\"text-[10px] font-bold text-indigo-300 uppercase tracking-widest block mb-1 flex items-center gap-1 md:justify-end\">\n                            <Landmark size={12}/> Trésorerie Studio\n                        </span>\n                        <div className=\"text-lg font-bold text-white flex items-center md:justify-end gap-2\">\n                            <span className={`font-mono ${agency.budget_real < 0 ? 'text-red-400' : 'text-white'}`}>{agency.budget_real} PiXi</span>\n                        </div>\n                    </div>\n\n                    <div className=\"flex items-center justify-between md:justify-start gap-6 pl-2\">\n                        <div className=\"text-center\">\n                            <span className=\"text-[10px] font-bold text-slate-300 uppercase tracking-widest block mb-1\">Flux Net</span>\n                            <div className={`text-xl font-bold ${netWeekly >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>{netWeekly > 0 ? '+' : ''}{netWeekly.toFixed(0)}</div>\n                        </div>\n                        <div className=\"text-center\">\n                            <div \n                                onClick={() => setShowVERules(true)}\n                                className=\"text-[10px] font-bold text-slate-300 uppercase tracking-widest mb-1 flex items-center gap-1 justify-center cursor-pointer hover:text-white\"\n                            >\n                                VE <HelpCircle size={10}/>\n                            </div>\n                            <div className={`text-3xl font-display font-bold leading-none ${agency.ve_current >= 60 ? 'text-emerald-400' : 'text-amber-400'}`}>{agency.ve_current}</div>\n                        </div>\n                    </div>\n                </div>\n                )}\n            </div>\n        </div>\n\n        {/* CONTENT */}\n        <div className=\"flex-1 mb-24 md:mb-8\">\n            {activeTab === 'MARKET' && agency.id !== 'unassigned' && <MarketOverview agency={agency} allAgencies={allAgencies} />}\n            {activeTab === 'MISSIONS' && agency.id !== 'unassigned' && <MissionsView agency={agency} onUpdateAgency={onUpdateAgency} />}\n            {activeTab === 'TEAM' && agency.id !== 'unassigned' && <TeamView agency={agency} onUpdateAgency={onUpdateAgency} />}\n            {activeTab === 'WALLET' && myMemberProfile && agency.id !== 'unassigned' && (\n                <WalletView \n                    student={myMemberProfile} \n                    agency={agency} \n                    allStudents={allAgencies.flatMap(a => a.members)}\n                    onTransfer={transferFunds}\n                    onInjectCapital={injectCapital}\n                    onRequestScore={requestScorePurchase}\n                />\n            )}\n            {(activeTab === 'RECRUITMENT' || agency.id === 'unassigned') && <MercatoView agency={agency} allAgencies={allAgencies} onUpdateAgency={onUpdateAgency} onUpdateAgencies={() => {}} />}\n            {activeTab === 'RESOURCES' && <WikiView agency={agency} />}\n            {activeTab === 'HISTORY' && <HistoryView agency={agency} />}\n        </div>\n\n        {/* FOOTER NAV */}\n        <div className=\"fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-md border-t border-slate-200 p-2 z-50 md:relative md:bg-transparent md:border-t-0 md:p-0 md:mt-auto safe-area-bottom\">\n             <div className=\"max-w-7xl mx-auto flex md:justify-start gap-2 md:gap-4 overflow-x-auto no-scrollbar snap-x justify-between\">\n                {agency.id !== 'unassigned' && (\n                    <>\n                        <NavButton active={activeTab === 'MARKET'} onClick={() => setActiveTab('MARKET')} icon={<TrendingUp size={20} />} label=\"Marché\" theme={theme} />\n                        <NavButton active={activeTab === 'MISSIONS'} onClick={() => setActiveTab('MISSIONS')} icon={<Target size={20} />} label=\"Missions\" theme={theme} />\n                        <NavButton active={activeTab === 'TEAM'} onClick={() => setActiveTab('TEAM')} icon={<Users size={20} />} label=\"Équipe\" theme={theme} />\n                        <NavButton active={activeTab === 'WALLET'} onClick={() => setActiveTab('WALLET')} icon={<Wallet size={20} />} label=\"Banque\" theme={theme} />\n                    </>\n                )}\n                <NavButton active={activeTab === 'RESOURCES'} onClick={() => setActiveTab('RESOURCES')} icon={<BookOpen size={20} />} label=\"Wiki\" theme={theme} />\n                <NavButton active={activeTab === 'RECRUITMENT' || agency.id === 'unassigned'} onClick={() => setActiveTab('RECRUITMENT')} icon={<Briefcase size={20} />} label={agency.id === 'unassigned' ? \"Mon Statut\" : \"Recrutement\"} theme={theme} />\n                <NavButton active={activeTab === 'HISTORY'} onClick={() => setActiveTab('HISTORY'} icon={<History size={20} />} label=\"Journal\" theme={theme} />\n             </div>\n        </div>\n\n        {/* SETTINGS & HELP MODALS */}\n        <Modal isOpen={showSettings} onClose={() => setShowSettings(false)} title=\"Personnalisation Agence\">\n            <div className=\"space-y-6\">\n                <div>\n                    <label className=\"block text-sm font-bold text-slate-700 mb-2\">Couleur de Marque</label>\n                    <div className=\"flex gap-3\">\n                        {(['indigo', 'emerald', 'rose', 'amber', 'cyan'] as BrandColor[]).map(c => (\n                            <button key={c} onClick={() => handleColorChange(c)} className={`w-10 h-10 rounded-full border-2 ${COLOR_THEMES[c].bg} ${brandColor === c ? 'ring-4 ring-offset-2 ring-slate-200 border-white' : 'border-transparent opacity-60 hover:opacity-100'}`} />\n                        ))}\n                    </div>\n                </div>\n                <div>\n                    <label className=\"block text-sm font-bold text-slate-700 mb-2\">Bannière (Cover)</label>\n                    <label className=\"flex flex-col items-center justify-center w-full h-32 border-2 border-slate-300 border-dashed rounded-xl cursor-pointer bg-slate-50 hover:bg-slate-100 transition-colors\">\n                        <div className=\"flex flex-col items-center justify-center pt-5 pb-6\">\n                            <ImageIcon className=\"w-8 h-8 text-slate-400 mb-2\" />\n                            <p className=\"text-sm text-slate-500\">Cliquez pour changer</p>\n                        </div>\n                        <input type=\"file\" className=\"hidden\" accept=\"image/*\" onChange={handleBannerUpload} />\n                    </label>\n                </div>\n            </div>\n        </Modal>\n        \n        <Modal isOpen={showVERules} onClose={() => setShowVERules(false)} title=\"Comprendre la VE\">\n            <div className=\"space-y-6\">\n                <div className=\"bg-slate-50 p-4 rounded-2xl border border-slate-100\">\n                    <p className=\"text-sm text-slate-600 leading-relaxed mb-2\">\n                        La <strong>Valeur d'Entreprise (VE)</strong> est votre \"note de groupe\" dynamique (/100). \n                        <br/>Elle fluctue selon vos rendus, vos choix et les événements.\n                    </p>\n                    <div className=\"flex gap-2 mt-4\">\n                        <div className=\"flex-1 bg-white p-2 rounded border text-center\">\n                            <div className=\"text-xs font-bold text-emerald-600 uppercase\">Impact Revenus</div>\n                            <div className=\"text-sm font-bold\">1 Point VE = {GAME_RULES.REVENUE_VE_MULTIPLIER} PiXi/sem</div>\n                        </div>\n                        <div className=\"flex-1 bg-white p-2 rounded border text-center\">\n                            <div className=\"text-xs font-bold text-indigo-600 uppercase\">Note Finale</div>\n                            <div className=\"text-sm font-bold\">Compte pour 40%</div>\n                        </div>\n                    </div>\n                </div>\n                <div>\n                    <h4 className=\"font-bold text-slate-900 text-sm mb-2\">Derniers Mouvements</h4>\n                    <div className=\"space-y-2 max-h-40 overflow-y-auto pr-2 custom-scrollbar\">\n                        {agency.eventLog.filter(e => e.deltaVE).map(e => (\n                            <div key={e.id} className=\"flex justify-between items-center py-2 border-b border-slate-100 last:border-0\">\n                                <span className=\"text-slate-600 text-xs\">{e.label}</span>\n                                <span className={`font-mono font-bold text-xs ${(e.deltaVE || 0) > 0 ? 'text-emerald-600' : 'text-red-500'}`}>{(e.deltaVE || 0) > 0 ? '+' : ''}{e.deltaVE}</span>\n                            </div>\n                        ))}\n                    </div>\n                </div>\n            </div>\n        </Modal>\n\n        {/* --- UNLOCK POP-UP (LEVEL UP) --- */}\n        {unlockModal && (\n            <Modal isOpen={!!unlockModal} onClose={() => setUnlockModal(null)} title={unlockModal.title}>\n                <div className=\"flex flex-col items-center text-center space-y-6\">\n                    <div className=\"p-6 rounded-full bg-slate-100 mb-2\">\n                        {unlockModal.icon}\n                    </div>\n                    <p className=\"text-slate-600 text-lg leading-relaxed whitespace-pre-line\">\n                        {unlockModal.message}\n                    </p>\n                    <button \n                        onClick={() => setUnlockModal(null)}\n                        className=\"w-full py-4 bg-slate-900 text-white font-bold rounded-xl hover:bg-indigo-600 transition-colors shadow-lg\"\n                    >\n                        {unlockModal.confirmText}\n                    </button>\n                </div>\n            </Modal>\n        )}\n\n        {/* --- EVENT NOTIFICATION POP-UP (CRISIS / REWARD) --- */}\n        {notificationEvent && (\n            <Modal isOpen={!!notificationEvent} onClose={closeNotification} title={notificationEvent.type === 'CRISIS' ? \"ALERTE PRIORITAIRE\" : \"NOUVELLE IMPORTANTE\"}>\n                <div className=\"flex flex-col items-center text-center space-y-6\">\n                    <div className={`p-6 rounded-full mb-2 border-4 ${\n                        notificationEvent.type === 'CRISIS' || (notificationEvent.deltaVE || 0) < 0\n                        ? 'bg-red-50 border-red-100 text-red-600 animate-pulse'\n                        : 'bg-emerald-50 border-emerald-100 text-emerald-600'\n                    }`}>\n                        {notificationEvent.type === 'CRISIS' || (notificationEvent.deltaVE || 0) < 0\n                            ? <AlertTriangle size={48} strokeWidth={2.5}/>\n                            : (notificationEvent.deltaVE || 0) > 5 ? <PartyPopper size={48} strokeWidth={2.5}/> : <Zap size={48} strokeWidth={2.5}/>\n                        }\n                    </div>\n\n                    <div>\n                        <h3 className={`text-2xl font-black uppercase mb-2 ${\n                            notificationEvent.type === 'CRISIS' || (notificationEvent.deltaVE || 0) < 0 ? 'text-red-600' : 'text-emerald-600'\n                        }`}>\n                            {notificationEvent.label}\n                        </h3>\n                        <p className=\"text-slate-600 text-lg leading-relaxed font-medium\">\n                            {notificationEvent.description}\n                        </p>\n                    </div>\n\n                    <div className=\"flex justify-center gap-4 w-full\">\n                        {notificationEvent.deltaVE !== 0 && (\n                            <div className={`flex flex-col items-center p-3 rounded-xl border w-full ${\n                                (notificationEvent.deltaVE || 0) > 0 ? 'bg-emerald-50 border-emerald-200' : 'bg-red-50 border-red-200'\n                            }`}>\n                                <span className=\"text-[10px] font-bold uppercase text-slate-500\">Impact VE</span>\n                                <span className={`text-2xl font-black ${(notificationEvent.deltaVE || 0) > 0 ? 'text-emerald-600' : 'text-red-600'}`}>\n                                    {(notificationEvent.deltaVE || 0) > 0 ? '+' : ''}{notificationEvent.deltaVE}\n                                </span>\n                            </div>\n                        )}\n                        \n                        {notificationEvent.deltaBudgetReal !== undefined && notificationEvent.deltaBudgetReal !== 0 && (\n                            <div className={`flex flex-col items-center p-3 rounded-xl border w-full ${\n                                (notificationEvent.deltaBudgetReal || 0) > 0 ? 'bg-emerald-50 border-emerald-200' : 'bg-red-50 border-red-200'\n                            }`}>\n                                <span className=\"text-[10px] font-bold uppercase text-slate-500\">Impact Budget</span>\n                                <span className={`text-2xl font-black ${(notificationEvent.deltaBudgetReal || 0) > 0 ? 'text-emerald-600' : 'text-red-600'}`}>\n                                    {(notificationEvent.deltaBudgetReal || 0) > 0 ? '+' : ''}{notificationEvent.deltaBudgetReal}\n                                </span>\n                            </div>\n                        )}\n                    </div>\n\n                    <button \n                        onClick={closeNotification}\n                        className={`w-full py-4 text-white font-bold rounded-xl shadow-lg transition-transform active:scale-95 ${\n                            notificationEvent.type === 'CRISIS' || (notificationEvent.deltaVE || 0) < 0\n                            ? 'bg-red-600 hover:bg-red-700 shadow-red-200'\n                            : 'bg-emerald-600 hover:bg-emerald-700 shadow-emerald-200'\n                        }`}\n                    >\n                        {notificationEvent.type === 'CRISIS' ? \"J'AI PRIS CONNAISSANCE\" : \"GÉNIAL !\"}\n                    </button>\n                </div>\n            </Modal>\n        )}\n    </div>\n  );\n};\n\nconst WalletView: React.FC<{student: Student, agency: Agency, allStudents: Student[], onTransfer: any, onInjectCapital: any, onRequestScore: any}> = ({student, agency, allStudents, onTransfer, onInjectCapital, onRequestScore}) => {\n    const [targetId, setTargetId] = useState('');\n    const [amount, setAmount] = useState(0);\n    const [scoreToBuy, setScoreToBuy] = useState(0);\n\n    const handleTransfer = async () => {\n        if(!targetId || amount <= 0) return;\n        await onTransfer(student.id, targetId, amount);\n        setAmount(0);\n    };\n\n    const handleInject = async () => {\n        if(amount <= 0) return;\n        await onInjectCapital(student.id, agency.id, amount);\n        setAmount(0);\n    };\n\n    const handleBuyScore = async () => {\n        if(scoreToBuy <= 0) return;\n        const cost = scoreToBuy * 200;\n        await onRequestScore(student.id, agency.id, cost, scoreToBuy);\n        setScoreToBuy(0);\n    };\n\n    return (\n        <div className=\"animate-in fade-in space-y-6\">\n            <div className=\"bg-indigo-900 text-white p-8 rounded-3xl shadow-lg flex flex-col md:flex-row justify-between items-center relative overflow-hidden\">\n                <div className=\"absolute top-0 right-0 p-20 bg-white/5 rounded-full blur-3xl transform translate-x-10 -translate-y-10\"></div>\n                <div className=\"relative z-10 text-center md:text-left mb-4 md:mb-0\">\n                    <p className=\"text-indigo-300 text-sm font-bold uppercase mb-1 tracking-widest\">Solde Disponible</p>\n                    <p className=\"text-5xl font-display font-bold text-yellow-400\">{student?.wallet || 0} <span className=\"text-2xl text-yellow-200\">PiXi</span></p>\n                </div>\n                <div className=\"relative z-10 bg-white/10 p-4 rounded-xl backdrop-blur-sm border border-white/20\">\n                    <p className=\"text-xs text-indigo-200 mb-1\">Salaire Hebdo</p>\n                    <p className=\"font-bold text-white text-lg\">+{student.individualScore * GAME_RULES.SALARY_MULTIPLIER} PiXi</p>\n                </div>\n            </div>\n\n            <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n                <div className=\"bg-white p-6 rounded-2xl border border-slate-200 shadow-sm flex flex-col\">\n                    <div className=\"mb-4\">\n                        <div className=\"w-12 h-12 bg-emerald-100 rounded-full flex items-center justify-center text-emerald-600 mb-3\">\n                            <ArrowUpRight size={24}/>\n                        </div>\n                        <h3 className=\"font-bold text-slate-900 text-lg\">Investir dans mon Agence</h3>\n                        <p className=\"text-sm text-slate-500 mt-1\">\n                            Injectez votre argent personnel pour sauver la trésorerie ou payer le loyer.\n                        </p>\n                    </div>\n                    <div className=\"mt-auto space-y-3\">\n                        <input type=\"number\" className=\"w-full p-3 rounded-xl border border-slate-200 font-bold bg-slate-50\" placeholder=\"Montant\" onChange={e => setAmount(Number(e.target.value))} />\n                        <button onClick={handleInject} disabled={amount <= 0 || amount > (student.wallet || 0)} className=\"w-full py-3 bg-emerald-600 text-white font-bold rounded-xl hover:bg-emerald-700 transition-colors disabled:opacity-50\">\n                            Confirmer l'injection\n                        </button>\n                    </div>\n                </div>\n\n                <div className=\"bg-white p-6 rounded-2xl border border-slate-200 shadow-sm flex flex-col\">\n                    <div className=\"mb-4\">\n                        <div className=\"w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center text-indigo-600 mb-3\">\n                            <Send size={24}/>\n                        </div>\n                        <h3 className=\"font-bold text-slate-900 text-lg\">Soutien & Prêt Inter-Agences</h3>\n                        <p className=\"text-sm text-slate-500 mt-1\">\n                            Envoyez des fonds à un collègue d'une autre agence pour les aider.\n                            <br/><span className=\"text-xs text-indigo-600 font-bold\">Conseil : Négociez un gain de VE en retour !</span>\n                        </p>\n                    </div>\n                    <div className=\"mt-auto space-y-3\">\n                        <select className=\"w-full p-3 rounded-xl border border-slate-200 bg-white text-sm\" onChange={e => setTargetId(e.target.value)} value={targetId}>\n                            <option value=\"\">-- Bénéficiaire --</option>\n                            {allStudents.filter(s => s.id !== student.id).map(s => (\n                                <option key={s.id} value={s.id}>{s.name}</option>\n                            ))}\n                        </select>\n                        <input type=\"number\" className=\"w-full p-3 rounded-xl border border-slate-200 font-bold bg-slate-50\" placeholder=\"Montant\" onChange={e => setAmount(Number(e.target.value))} />\n                        <button onClick={handleTransfer} disabled={amount <= 0 || amount > (student.wallet || 0)} className=\"w-full py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 transition-colors disabled:opacity-50\">\n                            Envoyer les fonds\n                        </button>\n                    </div>\n                </div>\n\n                <div className=\"bg-white p-6 rounded-2xl border border-slate-200 shadow-sm flex flex-col\">\n                    <div className=\"mb-4\">\n                        <div className=\"w-12 h-12 bg-amber-100 rounded-full flex items-center justify-center text-amber-600 mb-3\">\n                            <TrendingUp size={24}/>\n                        </div>\n                        <h3 className=\"font-bold text-slate-900 text-lg\">Formation (Achat Score)</h3>\n                        <p className=\"text-sm text-slate-500 mt-1\">\n                            Convertissez votre argent en compétence. \n                            <br/><strong>200 PiXi = 1 Point Score</strong>.\n                        </p>\n                    </div>\n                    <div className=\"mt-auto space-y-3\">\n                        <input type=\"number\" className=\"w-full p-3 rounded-xl border border-slate-200 font-bold bg-slate-50\" placeholder=\"Points voulus\" onChange={e => setScoreToBuy(Number(e.target.value))} />\n                        <div className=\"text-right text-xs font-bold text-slate-400\">Coût: {scoreToBuy * 200} PiXi</div>\n                        <button onClick={handleBuyScore} disabled={scoreToBuy <= 0 || (scoreToBuy * 200) > (student.wallet || 0)} className=\"w-full py-3 bg-amber-500 text-white font-bold rounded-xl hover:bg-amber-600 transition-colors disabled:opacity-50\">\n                            Demander la validation\n                        </button>\n                    </div>\n                </div>\n            </div>\n        </div>\n    );\n};\n\nconst NavButton: React.FC<any> = ({ active, onClick, icon, label, theme }) => (\n    <button onClick={onClick} className={`snap-start flex flex-col md:flex-row items-center md:gap-3 p-2 md:p-4 rounded-xl transition-all min-w-[70px] md:min-w-[150px] justify-center md:justify-start ${active ? `${theme.bg} text-white transform scale-105 shadow-md` : 'hover:bg-slate-50 text-slate-400 hover:text-slate-600'}`}>\n        <div className={`p-1.5 rounded-full ${active ? 'bg-white/20' : ''}`}>{React.cloneElement(icon, { className: active ? 'text-white' : '' })}</div>\n        <span className={`text-[10px] md:text-base font-bold`}>{label}</span>\n    </button>\n);\n"
            }
          ]
        },
        {
          "path": "components/student/mercato/AgencyDemocracy.tsx",
          "generationType": 1,
          "isDone": true,
          "description": "Improve visibility of HIRE requests (applications) from outside students for the agency.",
          "diffs": [
            {
              "target": "",
              "replacement": "\nimport React from 'react';\nimport { Agency, MercatoRequest, Student } from '../../../types';\nimport { Vote, Check, X, UserPlus, Info } from 'lucide-react';\n\ninterface AgencyDemocracyProps {\n    agency: Agency;\n    currentUser: Student | undefined;\n    onVote: (request: MercatoRequest, vote: 'APPROVE' | 'REJECT') => void;\n}\n\nexport const AgencyDemocracy: React.FC<AgencyDemocracyProps> = ({ agency, currentUser, onVote }) => {\n    \n    // Show HIRE requests (external applications) and FIRE requests (resignations or team moves)\n    const visibleRequests = agency.mercatoRequests.filter(req => req.status === 'PENDING');\n\n    if (visibleRequests.length === 0) return null;\n\n    return (\n        <div className=\"bg-indigo-900 text-white p-6 rounded-2xl shadow-xl border border-indigo-700 relative overflow-hidden mb-8\">\n            <div className=\"absolute -right-10 -top-10 opacity-10\">\n                <Vote size={128} />\n            </div>\n            <h3 className=\"font-bold text-lg mb-4 flex items-center gap-2 relative z-10\">\n                <Vote size={20} className=\"text-yellow-400\"/> Decisions d'Agence ({visibleRequests.length})\n            </h3>\n            <div className=\"space-y-4 relative z-10\">\n                {visibleRequests.map(req => {\n                    const hasVoted = req.votes && currentUser && req.votes[currentUser.id];\n                    const approvals = Object.values(req.votes || {}).filter(v => v === 'APPROVE').length;\n                    \n                    // Logic Threshold: HIRE = 66%, FIRE = 75%\n                    const isHire = req.type === 'HIRE';\n                    const thresholdPercent = isHire ? 66 : 75;\n                    const totalVoters = isHire ? agency.members.length : Math.max(1, agency.members.length - 1);\n                    \n                    const currentPercent = totalVoters > 0 ? Math.round((approvals / totalVoters) * 100) : 0;\n                    const canVote = currentUser && !hasVoted && (isHire || req.studentId !== currentUser.id);\n\n                    return (\n                        <div key={req.id} className=\"bg-white/10 backdrop-blur-sm p-4 rounded-xl border border-white/20\">\n                            <div className=\"flex justify-between items-start mb-2\">\n                                <div>\n                                    <div className=\"flex items-center gap-2\">\n                                        <span className={`text-[10px] font-bold px-2 py-0.5 rounded uppercase ${isHire ? 'bg-emerald-500' : 'bg-red-500'} text-white`}>\n                                            {isHire ? 'Candidature Entrante' : 'Demande de Départ'}\n                                        </span>\n                                        {!isHire && req.requesterId === req.studentId && (\n                                            <span className=\"text-[10px] font-bold px-2 py-0.5 rounded uppercase bg-amber-500 text-white\">\n                                                Démission\n                                            </span>\n                                        )}\n                                    </div>\n                                    <p className=\"font-bold text-sm mt-2 flex items-center gap-2\">\n                                        {isHire && <UserPlus size={14} className=\"text-emerald-400\"/>}\n                                        {req.studentName}\n                                    </p>\n                                </div>\n                                <div className=\"text-right\">\n                                    <div className=\"text-2xl font-bold font-display\">{currentPercent}%</div>\n                                    <div className=\"text-[10px] uppercase opacity-70\">Approbation (Obj. {thresholdPercent}%)</div>\n                                </div>\n                            </div>\n                            \n                            <div className=\"bg-black/20 p-3 rounded-lg text-xs italic opacity-90 mb-3 border border-white/5\">\n                                <Info size={12} className=\"inline mr-2 opacity-50\"/>\n                                \"{req.motivation || 'Aucun message fourni.'}\"\n                            </div>\n                            \n                            {canVote ? (\n                                <div className=\"flex gap-2\">\n                                    <button \n                                        onClick={() => onVote(req, 'APPROVE')}\n                                        className=\"flex-1 py-2 bg-emerald-600 hover:bg-emerald-500 rounded-lg font-bold text-xs flex items-center justify-center gap-1 transition-colors\"\n                                    >\n                                        <Check size={14}/> Voter Pour\n                                    </button>\n                                    <button \n                                        onClick={() => onVote(req, 'REJECT')}\n                                        className=\"flex-1 py-2 bg-red-600 hover:bg-red-500 rounded-lg font-bold text-xs flex items-center justify-center gap-1 transition-colors\"\n                                    >\n                                        <X size={14}/> Voter Contre\n                                    </button>\n                                </div>\n                            ) : (\n                                <div className=\"text-center py-2 bg-black/20 rounded-lg text-xs font-bold text-white/50 border border-white/5\">\n                                    {hasVoted ? '✓ Vote enregistré' : req.studentId === currentUser?.id ? 'Attente du vote de vos collègues' : 'Action non autorisée'}\n                                </div>\n                            )}\n                        </div>\n                    )\n                })}\n            </div>\n        </div>\n    );\n};\n"
            }
          ]
        },
        {
          "path": "components/AdminMercato.tsx",
          "generationType": 1,
          "isDone": true,
          "description": "Fix visibility of applications for teachers and add clear separation of external candidatures.",
          "diffs": [
            {
              "target": "",
              "replacement": "\nimport React, { useState, useMemo } from 'react';\nimport { Agency, GameEvent, MercatoRequest, StudentHistoryEntry } from '../types';\nimport { ArrowRightLeft, UserPlus, UserMinus, Briefcase, Plus, AlertCircle, Check, X, FileSearch, UserX, Coins, Quote, User, Info } from 'lucide-react';\nimport { useUI } from '../contexts/UIContext';\nimport { GAME_RULES } from '../constants';\n\ninterface AdminMercatoProps {\n  agencies: Agency[];\n  onUpdateAgencies: (agencies: Agency[]) => void;\n  readOnly?: boolean;\n}\n\nexport const AdminMercato: React.FC<AdminMercatoProps> = ({ agencies, onUpdateAgencies, readOnly }) => {\n  const { confirm, toast } = useUI();\n  const [selectedStudentId, setSelectedStudentId] = useState<string | null>(null);\n  const [targetAgencyId, setTargetAgencyId] = useState<string | null>(null);\n\n  // Separate Unassigned (Chômage) from Active Agencies\n  const unassignedAgency = agencies.find(a => a.id === 'unassigned');\n  const activeAgencies = agencies.filter(a => a.id !== 'unassigned');\n\n  // Collect all Pending Requests including HIRE from outside\n  const pendingRequests = useMemo(() => {\n      const requests: {req: MercatoRequest, agency: Agency}[] = [];\n      agencies.forEach(a => {\n          // Both unassigned and assigned agencies might have requests\n          (a.mercatoRequests || []).forEach(r => {\n              if (r.status === 'PENDING') requests.push({req: r, agency: a});\n          });\n      });\n      return requests;\n  }, [agencies]);\n\n  // Helper to find student and their current agency\n  const findStudentData = (studentId: string) => {\n    for (const agency of agencies) {\n        const student = agency.members.find(m => m.id === studentId);\n        if (student) return { student, agency };\n    }\n    return null;\n  };\n\n  const calculateFiringVEDelta = (score: number) => {\n      if (score < 30) return 10;\n      if (score < 50) return 5;\n      if (score < 70) return -5;\n      if (score < 90) return -15;\n      return -25;\n  };\n\n  const executeTransfer = (studentId: string, sourceAgencyId: string, targetAgencyId: string, transferType: 'HIRE' | 'FIRE' | 'TRANSFER', reason?: string) => {\n    const sourceAgency = agencies.find(a => a.id === sourceAgencyId);\n    const targetAgency = agencies.find(a => a.id === targetAgencyId);\n    const student = sourceAgency?.members.find(m => m.id === studentId);\n\n    if (!sourceAgency || !targetAgency || !student) return;\n\n    const today = new Date().toISOString().split('T')[0];\n    const newHistory: StudentHistoryEntry[] = [...(student.history || [])];\n    \n    if (sourceAgencyId !== 'unassigned') {\n        newHistory.push({\n            date: today, agencyId: sourceAgency.id, agencyName: sourceAgency.name,\n            action: transferType === 'FIRE' ? 'FIRED' : 'LEFT',\n            contextVE: sourceAgency.ve_current, contextBudget: sourceAgency.budget_real,\n            reason: reason || (transferType === 'FIRE' ? \"Licenciement\" : \"Départ\")\n        });\n    }\n\n    if (targetAgencyId !== 'unassigned') {\n        newHistory.push({\n            date: today, agencyId: targetAgency.id, agencyName: targetAgency.name,\n            action: 'JOINED', contextVE: targetAgency.ve_current, contextBudget: targetAgency.budget_real,\n            reason: reason || \"Recrutement\"\n        });\n    }\n\n    const updatedStudent = { ...student, history: newHistory };\n    const updatedSourceMembers = sourceAgency.members.filter(m => m.id !== student.id);\n    const updatedSource = { ...sourceAgency, members: updatedSourceMembers };\n    const updatedTargetMembers = [...targetAgency.members, updatedStudent];\n    const updatedTarget = { ...targetAgency, members: updatedTargetMembers };\n\n    let eventSource: GameEvent | null = null;\n    let eventTarget: GameEvent | null = null;\n    let sourceVEDelta = 0;\n    let targetVEDelta = 0;\n\n    if (transferType === 'FIRE') {\n        sourceVEDelta = calculateFiringVEDelta(student.individualScore);\n        let label = sourceVEDelta > 0 ? \"Restructuration\" : \"Perte Compétence\";\n        eventSource = {\n            id: `evt-${Date.now()}-1`, date: today, type: sourceVEDelta > 0 ? 'VE_DELTA' : 'CRISIS',\n            label: label, deltaVE: sourceVEDelta,\n            description: `Départ de ${student.name}.`\n        };\n    } else if (transferType === 'HIRE') {\n        targetVEDelta = -5;\n        eventTarget = {\n            id: `evt-${Date.now()}-2`, date: today, type: 'VE_DELTA', label: 'Recrutement Ext.', deltaVE: targetVEDelta,\n            description: `${student.name} rejoint l'équipe.`\n        };\n    } else {\n         sourceVEDelta = -5; targetVEDelta = -2;\n         eventSource = { id: `evt-${Date.now()}-1`, date: today, type: 'VE_DELTA', label: 'Transfert Sortant', deltaVE: sourceVEDelta, description: `${student.name} quitte l'agence.` };\n         eventTarget = { id: `evt-${Date.now()}-2`, date: today, type: 'VE_DELTA', label: 'Transfert Entrant', deltaVE: targetVEDelta, description: `${student.name} rejoint l'agence.` };\n    }\n\n    if (eventSource && sourceAgency.id !== 'unassigned') {\n        updatedSource.eventLog = [...updatedSource.eventLog, eventSource];\n        updatedSource.ve_current = Math.max(0, updatedSource.ve_current + sourceVEDelta);\n    }\n    if (eventTarget && targetAgency.id !== 'unassigned') {\n        updatedTarget.eventLog = [...updatedTarget.eventLog, eventTarget];\n        updatedTarget.ve_current = Math.max(0, updatedTarget.ve_current + targetVEDelta);\n    }\n\n    const newAgencies = agencies.map(a => \n        a.id === sourceAgency.id ? updatedSource : \n        a.id === targetAgency.id ? updatedTarget : a\n    );\n    return newAgencies;\n  }\n\n  const handleManualTransfer = async () => {\n     if(readOnly) return;\n     if (!selectedStudentId || !targetAgencyId) return;\n     const sourceData = findStudentData(selectedStudentId);\n     if (!sourceData) return;\n\n     const student = sourceData.student;\n     const targetAgency = agencies.find(a => a.id === targetAgencyId);\n     \n     if (targetAgency && targetAgency.id !== 'unassigned' && targetAgency.classId !== student.classId) {\n         toast('error', `Classes incompatibles (Étudiant ${student.classId} -> Agence ${targetAgency.classId})`);\n         return;\n     }\n     \n     const type = sourceData.agency.id === 'unassigned' ? 'HIRE' : targetAgencyId === 'unassigned' ? 'FIRE' : 'TRANSFER';\n     const confirmed = await confirm({\n         title: \"Confirmation de Mouvement RH\",\n         message: `Forcer le mouvement de ${student.name} ?\\nDe ${sourceData.agency.name} vers ${targetAgency?.name || 'Chômage'}`,\n         confirmText: \"Valider\", isDangerous: type === 'FIRE'\n     });\n\n     if (!confirmed) return;\n\n     const newAgencies = executeTransfer(selectedStudentId, sourceData.agency.id, targetAgencyId, type, \"Action Admin\");\n     if(newAgencies) {\n         onUpdateAgencies(newAgencies);\n         toast('success', `Transfert effectué`);\n         setSelectedStudentId(null); setTargetAgencyId(null);\n     }\n  };\n\n  const handleApproveRequest = (request: MercatoRequest, requestAgency: Agency) => {\n      if(readOnly) return;\n      let newAgencies: Agency[] | undefined;\n      const studentData = findStudentData(request.studentId);\n      if(!studentData) return;\n\n      if (request.type === 'FIRE') {\n          newAgencies = executeTransfer(request.studentId, request.targetAgencyId, 'unassigned', 'FIRE', request.motivation);\n      } else if (request.type === 'HIRE') {\n          newAgencies = executeTransfer(request.studentId, studentData.agency.id, request.targetAgencyId, 'HIRE', request.motivation);\n      }\n\n      if (newAgencies) {\n          const finalAgencies = newAgencies.map(a => {\n             if (a.id === requestAgency.id) {\n                 return { ...a, mercatoRequests: a.mercatoRequests.filter(r => r.id !== request.id) };\n             }\n             return a;\n          });\n          onUpdateAgencies(finalAgencies);\n          toast('success', 'Demande validée.');\n      }\n  };\n\n  const handleRejectRequest = (request: MercatoRequest, requestAgency: Agency) => {\n      if(readOnly) return;\n      const updatedAgency = { ...requestAgency, mercatoRequests: requestAgency.mercatoRequests.filter(r => r.id !== request.id) };\n      onUpdateAgencies(agencies.map(a => a.id === updatedAgency.id ? updatedAgency : a));\n      toast('info', 'Demande rejetée.');\n  };\n\n  const handleCreateAgency = async () => {\n      if(readOnly) return;\n      let founderId = selectedStudentId && findStudentData(selectedStudentId)?.agency.id === 'unassigned' ? selectedStudentId : null;\n      let founder = founderId ? findStudentData(founderId)?.student : null;\n\n      if (founder) {\n          const proceed = await confirm({ title: \"Fonder une Agence\", message: `Voulez-vous que ${founder.name} fonde ce studio ? (-${GAME_RULES.CREATION_COST_PIXI} PiXi / -${GAME_RULES.CREATION_COST_SCORE} pts)`, confirmText: \"Payer et Créer\", isDangerous: true });\n          if (!proceed) return;\n      } else {\n          if (!await confirm({ title: \"Création Agence\", message: \"Créer une agence vide ?\", confirmText: \"Créer\" })) return;\n      }\n\n      const newAgencyId = `a-${Date.now()}`;\n      const newAgency: Agency = {\n          id: newAgencyId, name: \"Nouveau Studio\", tagline: \"En construction...\", ve_current: 20, status: 'critique',\n          classId: founder ? founder.classId : 'A', budget_real: 2000, budget_valued: 0, weeklyTax: 0, weeklyRevenueModifier: 0,\n          members: [], peerReviews: [], eventLog: [{ id: `e-${newAgencyId}-1`, date: new Date().toISOString().split('T')[0], type: \"INFO\", label: \"Ouverture Studio\", deltaVE: 0, description: \"Ouverture du compte.\" }],\n          currentCycle: agencies[0].currentCycle, constraints: { space: \"À définir\", style: \"À définir\", client: \"À définir\" },\n          projectDef: { problem: \"\", target: \"\", location: \"\", gesture: \"\", isLocked: false },\n          mercatoRequests: [], transactionRequests: [], branding: { color: 'indigo' }, badges: [], progress: JSON.parse(JSON.stringify(agencies[0].progress))\n      };\n\n      let updatedAgencies = [...agencies, newAgency];\n      if (founder && founderId) {\n         const unassigned = agencies.find(a => a.id === 'unassigned');\n         if (unassigned) {\n             const updatedFounder = { ...founder, wallet: (founder.wallet || 0) - GAME_RULES.CREATION_COST_PIXI, individualScore: Math.max(0, founder.individualScore - GAME_RULES.CREATION_COST_SCORE) };\n             updatedAgencies = updatedAgencies.map(a => {\n                 if (a.id === 'unassigned') return { ...a, members: a.members.filter(m => m.id !== founderId) };\n                 if (a.id === newAgencyId) return { ...a, members: [updatedFounder] };\n                 return a;\n             });\n         }\n      }\n      onUpdateAgencies(updatedAgencies);\n      toast('success', 'Studio créé.');\n      setSelectedStudentId(null);\n  };\n\n  return (\n    <div className=\"animate-in fade-in duration-500 pb-20\">\n        <div className=\"flex justify-between items-center mb-6\">\n            <div>\n                <h2 className=\"text-3xl font-display font-bold text-slate-900\">Mercato & RH</h2>\n                <p className=\"text-slate-500 text-sm\">Gérez les candidatures et les mouvements d'effectifs.</p>\n            </div>\n            {!readOnly && (\n            <button onClick={handleCreateAgency} className=\"bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-xl font-bold text-sm flex items-center gap-2 transition-colors shadow-lg\">\n                <Plus size={18} /> {selectedStudentId && findStudentData(selectedStudentId)?.agency.id === 'unassigned' ? \"Fonder Agence (Sélection)\" : \"Créer un Groupe\"}\n            </button>\n            )}\n        </div>\n\n        {/* --- SECTION: PENDING REQUESTS --- */}\n        {pendingRequests.length > 0 && (\n            <div className=\"mb-8 bg-amber-50 border border-amber-200 rounded-2xl p-6\">\n                <h3 className=\"text-amber-800 font-bold flex items-center gap-2 mb-4\">\n                    <AlertCircle size={20}/> Demandes & Candidatures en attente ({pendingRequests.length})\n                </h3>\n                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n                    {pendingRequests.map(({req, agency}) => {\n                        const studentData = findStudentData(req.studentId);\n                        const student = studentData?.student;\n                        const sourceAgency = studentData?.agency;\n                        const isExternalApply = sourceAgency?.id === 'unassigned' && req.type === 'HIRE';\n                        const isResignation = req.requesterId === req.studentId && req.type === 'FIRE';\n\n                        return (\n                            <div key={req.id} className=\"bg-white p-4 rounded-xl border border-amber-100 shadow-sm flex flex-col gap-2\">\n                                <div className=\"flex justify-between items-start\">\n                                    <div className=\"flex items-center gap-2\">\n                                        <span className={`text-[10px] font-bold px-2 py-0.5 rounded-md uppercase ${\n                                            isExternalApply ? 'bg-indigo-600 text-white' : \n                                            req.type === 'HIRE' ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'\n                                        }`}>\n                                            {isExternalApply ? 'Candidature' : req.type === 'HIRE' ? 'Embauche' : (isResignation ? 'Démission' : 'Renvoi')}\n                                        </span>\n                                        <span className=\"text-[10px] bg-slate-100 text-slate-500 px-1 rounded font-bold\">Cl. {student?.classId}</span>\n                                    </div>\n                                    {!readOnly && (\n                                    <div className=\"flex gap-1\">\n                                        <button onClick={() => handleRejectRequest(req, agency)} className=\"p-1.5 bg-slate-100 hover:bg-red-100 text-slate-400 hover:text-red-600 rounded-lg\"><X size={16}/></button>\n                                        <button onClick={() => handleApproveRequest(req, agency)} className=\"p-1.5 bg-slate-900 hover:bg-emerald-600 text-white rounded-lg\"><Check size={16}/></button>\n                                    </div>\n                                    )}\n                                </div>\n\n                                <div className=\"mt-1\">\n                                    <p className=\"font-bold text-slate-900 text-sm\">\n                                        {req.studentName}\n                                        <span className=\"block text-[10px] text-slate-400 font-normal mt-0.5\">\n                                            {isExternalApply ? `veut rejoindre ${agency.name}` : `veut quitter ${agency.name}`}\n                                        </span>\n                                    </p>\n                                    <div className=\"bg-slate-50 p-2 rounded-lg mt-2 flex gap-2 border border-slate-100\">\n                                        <Quote size={12} className=\"text-slate-300 shrink-0\"/>\n                                        <p className=\"text-xs text-slate-600 italic\">\"{req.motivation || 'Pas de motivation'}\"</p>\n                                    </div>\n                                </div>\n                            </div>\n                        );\n                    })}\n                </div>\n            </div>\n        )}\n\n        <div className=\"grid grid-cols-1 md:grid-cols-12 gap-6\">\n            <div className=\"md:col-span-12\">\n                <h3 className=\"text-sm font-bold text-slate-500 uppercase tracking-widest mb-3 flex items-center gap-2\">\n                    <Briefcase size={16}/> Vivier / Pôle Chômage\n                </h3>\n                <div className={`border-2 border-dashed rounded-2xl p-4 mb-8 transition-colors ${targetAgencyId === 'unassigned' ? 'bg-red-50 border-red-300' : 'bg-slate-100 border-slate-300'}`}>\n                    <div className=\"flex justify-between items-center mb-4\">\n                        <p className=\"text-sm text-slate-500 italic\">Cliquez sur un étudiant pour le sélectionner, puis choisissez une destination.</p>\n                        <button onClick={() => !readOnly && setTargetAgencyId('unassigned')} disabled={readOnly} className={`px-4 py-2 rounded-lg text-xs font-bold transition-all ${targetAgencyId === 'unassigned' ? 'bg-red-600 text-white' : 'bg-white text-slate-600 border border-slate-200'}`}>\n                            Destination: Licenciement\n                        </button>\n                    </div>\n                    <div className=\"flex flex-wrap gap-3\">\n                        {unassignedAgency?.members.map(student => (\n                            <div key={student.id} onClick={() => !readOnly && setSelectedStudentId(student.id)} className={`flex items-center gap-3 p-3 rounded-xl border-2 transition-all cursor-pointer ${selectedStudentId === student.id ? 'bg-white border-indigo-500 shadow-md transform scale-105' : 'bg-white border-slate-200'}`}>\n                                <img src={student.avatarUrl} className=\"w-8 h-8 rounded-full grayscale\" />\n                                <div>\n                                    <p className=\"font-bold text-slate-700 text-sm leading-none\">{student.name}</p>\n                                    <span className={`text-[9px] font-bold px-1.5 rounded text-white ${student.classId === 'A' ? 'bg-blue-400' : 'bg-purple-400'}`}>CLASSE {student.classId}</span>\n                                </div>\n                            </div>\n                        ))}\n                    </div>\n                </div>\n\n                <h3 className=\"text-sm font-bold text-slate-500 uppercase tracking-widest mb-3 flex items-center gap-2\"><UserPlus size={16}/> Agences Actives</h3>\n                <div className=\"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6\">\n                    {activeAgencies.map(agency => (\n                        <div key={agency.id} className={`bg-white rounded-2xl border transition-all relative overflow-hidden ${targetAgencyId === agency.id ? 'border-indigo-500 shadow-lg ring-2 ring-indigo-100' : 'border-slate-200 hover:border-slate-300'}`}>\n                            <div className={`absolute top-0 left-0 right-0 h-1 ${agency.classId === 'A' ? 'bg-blue-400' : 'bg-purple-400'}`}></div>\n                            <div onClick={() => !readOnly && setTargetAgencyId(agency.id)} className={`p-4 border-b border-slate-100 flex justify-between items-center rounded-t-2xl mt-1 transition-colors cursor-pointer ${targetAgencyId === agency.id ? 'bg-indigo-50' : 'bg-slate-50'}`}>\n                                <div>\n                                    <h4 className=\"font-bold text-slate-700\">{agency.name}</h4>\n                                    <span className=\"text-[10px] font-bold px-1.5 py-0.5 rounded bg-slate-200 text-slate-600\">CLASSE {agency.classId}</span>\n                                </div>\n                                {targetAgencyId === agency.id && <span className=\"text-[10px] bg-indigo-200 text-indigo-800 px-2 rounded-full font-bold\">Cible</span>}\n                            </div>\n                            <div className=\"p-4 space-y-2\">\n                                {agency.members.map(student => (\n                                    <div key={student.id} onClick={(e) => { e.stopPropagation(); if(!readOnly) setSelectedStudentId(student.id); }} className={`flex items-center gap-3 p-2 rounded-xl transition-all cursor-pointer ${selectedStudentId === student.id ? 'bg-indigo-600 text-white shadow-md' : 'hover:bg-slate-50 text-slate-700'}`}>\n                                        <img src={student.avatarUrl} className=\"w-8 h-8 rounded-full\" />\n                                        <div className=\"flex-1\">\n                                            <p className=\"font-bold text-sm leading-none\">{student.name}</p>\n                                            <p className=\"text-[10px] mt-0.5 opacity-70\">{student.role}</p>\n                                        </div>\n                                    </div>\n                                ))}\n                            </div>\n                        </div>\n                    ))}\n                </div>\n            </div>\n        </div>\n        \n        {!readOnly && selectedStudentId && targetAgencyId && (\n        <div className=\"fixed bottom-6 left-1/2 transform -translate-x-1/2 md:ml-32 bg-slate-900 text-white px-6 py-4 rounded-2xl shadow-2xl flex items-center gap-6 z-50\">\n            <div className=\"flex items-center gap-3\">\n                 <div className=\"text-right\">\n                    <span className=\"block text-[10px] text-slate-400 uppercase font-bold\">Source: {findStudentData(selectedStudentId)?.agency.name}</span>\n                 </div>\n                 <ArrowRightLeft className=\"text-slate-500\" />\n                 <div>\n                    <span className=\"block text-[10px] text-slate-400 uppercase font-bold\">Cible: {targetAgencyId === 'unassigned' ? 'Chômage' : agencies.find(a => a.id === targetAgencyId)?.name}</span>\n                 </div>\n            </div>\n            <button onClick={handleManualTransfer} className=\"bg-white text-slate-900 px-6 py-2 rounded-xl font-bold text-sm hover:bg-indigo-50\">Transférer (Force)</button>\n        </div>\n        )}\n    </div>\n  );\n};\n"
            }
          ]
        },
        {
          "path": "components/AdminCrisisStudent.tsx",
          "generationType": 1,
          "isDone": true,
          "description": "Enable teacher to freely send/take points or PiXi from students, with improved clarity in the UI.",
          "diffs": [
            {
              "target": "",
              "replacement": "\nimport React, { useState, useMemo } from 'react';\nimport { Agency, CrisisPreset, GameEvent, Student } from '../types';\nimport { Crown, User, UserMinus, Sparkles, Gavel, Briefcase, FileWarning, ShieldAlert, BadgeCheck, Heart, Medal, Star, TrendingUp, TrendingDown, Coins, Plus, Minus } from 'lucide-react';\nimport { useUI } from '../contexts/UIContext';\n\ninterface AdminCrisisStudentProps {\n  agencies: Agency[];\n  onUpdateAgency: (agency: Agency) => void;\n  readOnly?: boolean;\n}\n\ninterface StudentPreset extends CrisisPreset {\n    category: 'STUDENT_SANCTION' | 'STUDENT_BONUS' | 'CEREMONY';\n    deltaScore?: number;\n    deltaWallet?: number;\n    defaultReason: string;\n}\n\nexport const AdminCrisisStudent: React.FC<AdminCrisisStudentProps> = ({ agencies, onUpdateAgency, readOnly }) => {\n  const { confirm, toast } = useUI();\n\n  const [selectedStudentId, setSelectedStudentId] = useState<string>('');\n  const [presetType, setPresetType] = useState<'SANCTION' | 'BONUS' | 'CEREMONY'>('BONUS');\n  \n  const [form, setForm] = useState({\n      label: \"\",\n      reason: \"\",\n      deltaScore: 0,\n      deltaWallet: 0\n  });\n\n  const allStudents = useMemo(() => {\n      const list: {student: Student, agencyName: string, agencyId: string}[] = [];\n      agencies.forEach(a => {\n          a.members.forEach(m => list.push({student: m, agencyName: a.name, agencyId: a.id}));\n      });\n      return list.sort((a,b) => a.student.name.localeCompare(b.student.name));\n  }, [agencies]);\n\n  const PRESETS: StudentPreset[] = [\n    { label: \"Raté de Sprint\", defaultReason: \"Deadline manquée.\", deltaScore: -2, deltaWallet: -50, deltaVE: 0, deltaBudget: 0, icon: <FileWarning/>, category: 'STUDENT_SANCTION', description: \"Retard\" },\n    { label: \"Ghosting / Abandon\", defaultReason: \"Absence injustifiée.\", deltaScore: -5, deltaWallet: -200, deltaVE: 0, deltaBudget: 0, icon: <UserMinus/>, category: 'STUDENT_SANCTION', description: \"Absence\" },\n    { label: \"Faute Grave\", defaultReason: \"Comportement nuisible.\", deltaScore: -15, deltaWallet: -500, deltaVE: 0, deltaBudget: 0, icon: <ShieldAlert/>, category: 'STUDENT_SANCTION', description: \"Comportement\" },\n    \n    { label: \"MVP Technique\", defaultReason: \"A débloqué une situation complexe.\", deltaScore: +5, deltaWallet: 300, deltaVE: 0, deltaBudget: 0, icon: <BadgeCheck/>, category: 'STUDENT_BONUS', description: \"Skill\" },\n    { label: \"Esprit de Corps\", defaultReason: \"A soutenu ses collègues.\", deltaScore: +3, deltaWallet: 150, deltaVE: 0, deltaBudget: 0, icon: <Heart/>, category: 'STUDENT_BONUS', description: \"Soft Skill\" },\n    { label: \"Crunch Hero\", defaultReason: \"Effort exceptionnel.\", deltaScore: +4, deltaWallet: 200, deltaVE: 0, deltaBudget: 0, icon: <Sparkles/>, category: 'STUDENT_BONUS', description: \"Effort\" },\n\n    { label: \"🥇 Major de Promo\", defaultReason: \"1ère place au classement général du S1.\", deltaScore: +15, deltaWallet: 1000, deltaVE: 0, deltaBudget: 0, icon: <Medal/>, category: 'CEREMONY', description: \"Top 1 Classe\" },\n    { label: \"🥈 Dauphin\", defaultReason: \"2ème place au classement général du S1.\", deltaScore: +10, deltaWallet: 750, deltaVE: 0, deltaBudget: 0, icon: <Medal/>, category: 'CEREMONY', description: \"Top 2 Classe\" },\n    { label: \"🥉 Podium\", defaultReason: \"3ème place au classement général du S1.\", deltaScore: +5, deltaWallet: 500, deltaVE: 0, deltaBudget: 0, icon: <Medal/>, category: 'CEREMONY', description: \"Top 3 Classe\" },\n  ];\n\n  const filteredPresets = PRESETS.filter(p => \n      (presetType === 'SANCTION' && p.category === 'STUDENT_SANCTION') ||\n      (presetType === 'BONUS' && p.category === 'STUDENT_BONUS') ||\n      (presetType === 'CEREMONY' && p.category === 'CEREMONY')\n  );\n\n  const selectPreset = (preset: StudentPreset) => {\n      setForm({\n          label: preset.label,\n          reason: preset.defaultReason,\n          deltaScore: preset.deltaScore || 0,\n          deltaWallet: preset.deltaWallet || 0\n      });\n  };\n\n  const handleApply = async () => {\n      if(readOnly) return;\n      if (!selectedStudentId) { toast('error', \"Sélectionnez un étudiant.\"); return; }\n      if(!form.label || !form.reason) { toast('error', \"Motif obligatoire.\"); return; }\n\n      const targetInfo = allStudents.find(s => s.student.id === selectedStudentId);\n      if(!targetInfo) return;\n\n      const confirmed = await confirm({\n          title: \"Confirmer l'Arbitrage RH\",\n          message: `Donner/Prendre à ${targetInfo.student.name}:\\n${form.deltaScore > 0 ? '+' : ''}${form.deltaScore} pts de Score\\n${form.deltaWallet > 0 ? '+' : ''}${form.deltaWallet} PiXi\\n\\nMotif: ${form.label}`,\n          confirmText: \"Appliquer les Changements\",\n          isDangerous: form.deltaScore < 0 || form.deltaWallet < 0\n      });\n\n      if(confirmed) {\n          const agency = agencies.find(a => a.id === targetInfo.agencyId);\n          if(!agency) return;\n\n          const updatedMembers = agency.members.map(m => \n              m.id === selectedStudentId \n              ? { \n                  ...m, \n                  individualScore: Math.max(0, Math.min(100, m.individualScore + form.deltaScore)),\n                  wallet: (m.wallet || 0) + form.deltaWallet\n                } \n              : m\n          );\n\n          onUpdateAgency({\n              ...agency,\n              members: updatedMembers,\n              eventLog: [...agency.eventLog, {\n                  id: `rh-${Date.now()}`, date: new Date().toISOString().split('T')[0], type: 'INFO',\n                  label: `Arbitrage RH: ${targetInfo.student.name}`,\n                  description: `${form.label}: ${form.reason} (Score: ${form.deltaScore}, PiXi: ${form.deltaWallet})`\n              }]\n          });\n          toast('success', \"Arbitrage appliqué.\");\n          setForm({label: \"\", reason: \"\", deltaScore: 0, deltaWallet: 0});\n      }\n  };\n\n  return (\n    <div className=\"grid grid-cols-1 lg:grid-cols-12 gap-8\">\n         <div className=\"lg:col-span-4 flex flex-col gap-4\">\n            <div className=\"p-4 bg-white rounded-2xl border border-slate-200 shadow-sm\">\n                <h3 className=\"font-bold text-slate-900 mb-4 flex items-center gap-2\"><User size={20}/> Étudiant Cible</h3>\n                <select \n                    className=\"w-full p-3 rounded-xl border border-slate-200 bg-slate-50 font-bold text-sm outline-none focus:ring-2 focus:ring-indigo-500\"\n                    value={selectedStudentId}\n                    onChange={(e) => setSelectedStudentId(e.target.value)}\n                    size={12}\n                >\n                    {allStudents.map(item => (\n                        <option key={item.student.id} value={item.student.id} className=\"py-2 px-2 border-b border-slate-100 last:border-0 hover:bg-indigo-50 cursor-pointer\">\n                            {item.student.name} ({item.agencyName})\n                        </option>\n                    ))}\n                </select>\n            </div>\n         </div>\n\n         <div className=\"lg:col-span-8 space-y-6\">\n            <div className=\"flex gap-2 bg-slate-100 p-1 rounded-2xl\">\n                <button onClick={() => setPresetType('SANCTION')} className={`flex-1 py-3 rounded-xl font-bold text-xs uppercase transition-all ${presetType === 'SANCTION' ? 'bg-white shadow text-red-600' : 'text-slate-400'}`}>Sanctions</button>\n                <button onClick={() => setPresetType('BONUS')} className={`flex-1 py-3 rounded-xl font-bold text-xs uppercase transition-all ${presetType === 'BONUS' ? 'bg-white shadow text-emerald-600' : 'text-slate-400'}`}>Bonus</button>\n                <button onClick={() => setPresetType('CEREMONY')} className={`flex-1 py-3 rounded-xl font-bold text-xs uppercase transition-all ${presetType === 'CEREMONY' ? 'bg-white shadow text-amber-600' : 'text-slate-400'}`}>Cérémonie S1</button>\n            </div>\n\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                {filteredPresets.map((preset, idx) => (\n                    <div key={idx} onClick={() => selectPreset(preset)} className=\"p-4 rounded-xl border-2 border-white bg-white hover:border-indigo-300 cursor-pointer transition-all shadow-sm\">\n                        <div className=\"flex items-center gap-3 mb-2\">\n                            <div className=\"p-2 bg-slate-50 rounded-lg\">{preset.icon}</div>\n                            <h4 className=\"font-bold text-slate-900 text-sm\">{preset.label}</h4>\n                        </div>\n                        <div className=\"flex gap-2 mt-2\">\n                            <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded ${preset.deltaScore! > 0 ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'}`}>Score {preset.deltaScore! > 0 ? '+' : ''}{preset.deltaScore}</span>\n                            <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded ${preset.deltaWallet! > 0 ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700'}`}>PiXi {preset.deltaWallet! > 0 ? '+' : ''}{preset.deltaWallet}</span>\n                        </div>\n                    </div>\n                ))}\n            </div>\n\n            <div className=\"bg-slate-900 text-white p-6 rounded-3xl shadow-xl space-y-6\">\n                <h4 className=\"font-bold text-indigo-300 text-sm uppercase tracking-widest flex items-center gap-2\"><Gavel size={18}/> Console d'Arbitrage Libre</h4>\n                \n                <div className=\"grid grid-cols-2 gap-6\">\n                    <div className=\"space-y-2\">\n                        <label className=\"text-[10px] font-bold uppercase text-slate-400 flex items-center gap-1\"><TrendingUp size={12}/> Ajustement Note / 100</label>\n                        <div className=\"flex items-center gap-3\">\n                            <button onClick={() => setForm({...form, deltaScore: form.deltaScore - 1})} className=\"p-2 bg-white/10 rounded-lg hover:bg-red-500\"><Minus size={16}/></button>\n                            <input type=\"number\" value={form.deltaScore} onChange={e => setForm({...form, deltaScore: Number(e.target.value)})} className=\"flex-1 bg-white/5 border border-white/10 rounded-xl p-3 text-center text-xl font-bold focus:ring-2 focus:ring-indigo-500 outline-none\" />\n                            <button onClick={() => setForm({...form, deltaScore: form.deltaScore + 1})} className=\"p-2 bg-white/10 rounded-lg hover:bg-emerald-500\"><Plus size={16}/></button>\n                        </div>\n                    </div>\n                    <div className=\"space-y-2\">\n                        <label className=\"text-[10px] font-bold uppercase text-slate-400 flex items-center gap-1\"><Coins size={12}/> Don / Amende (PiXi)</label>\n                        <div className=\"flex items-center gap-3\">\n                            <button onClick={() => setForm({...form, deltaWallet: form.deltaWallet - 100})} className=\"p-2 bg-white/10 rounded-lg hover:bg-red-500\"><Minus size={16}/></button>\n                            <input type=\"number\" value={form.deltaWallet} onChange={e => setForm({...form, deltaWallet: Number(e.target.value)})} className=\"flex-1 bg-white/5 border border-white/10 rounded-xl p-3 text-center text-xl font-bold focus:ring-2 focus:ring-indigo-500 outline-none\" />\n                            <button onClick={() => setForm({...form, deltaWallet: form.deltaWallet + 100})} className=\"p-2 bg-white/10 rounded-lg hover:bg-emerald-500\"><Plus size={16}/></button>\n                        </div>\n                    </div>\n                </div>\n\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                    <div>\n                        <label className=\"text-[10px] font-bold uppercase text-slate-400 block mb-1\">Libellé de l'action</label>\n                        <input type=\"text\" value={form.label} onChange={e => setForm({...form, label: e.target.value})} className=\"w-full bg-white/5 border border-white/10 rounded-xl p-3 text-sm font-bold\" placeholder=\"Ex: Don Exceptionnel\" />\n                    </div>\n                    <div>\n                        <label className=\"text-[10px] font-bold uppercase text-slate-400 block mb-1\">Détails (Optionnel)</label>\n                        <input type=\"text\" value={form.reason} onChange={e => setForm({...form, reason: e.target.value})} className=\"w-full bg-white/5 border border-white/10 rounded-xl p-3 text-sm\" placeholder=\"Justification pédagogique...\" />\n                    </div>\n                </div>\n\n                <button \n                    onClick={handleApply}\n                    disabled={!selectedStudentId || readOnly}\n                    className=\"w-full py-4 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-2xl shadow-lg shadow-indigo-900/50 transition-all flex items-center justify-center gap-3 disabled:opacity-50\"\n                >\n                    <Send size={20}/> Appliquer la Décision RH\n                </button>\n            </div>\n         </div>\n    </div>\n  );\n};\n"
            }
          ]
        }
      ]
    },
    "createdTimestamp": {
      "seconds": 1767783578,
      "nanos": 331000000
    },
    "doneTimestamp": {
      "seconds": 1767783604,
      "nanos": 495000000
    }
  },
  {
    "id": 27,
    "author": "model",
    "payload": {
      "type": "fixingErrors",
      "diagnostics": [
        {
          "gHa": "contexts/GameContext.tsx",
          "message": "Property 'locked' does not exist on type 'unknown'.",
          "line": 145,
          "column": 65
        },
        {
          "gHa": "contexts/GameContext.tsx",
          "message": "Property 'id' does not exist on type 'unknown'.",
          "line": 145,
          "column": 93
        },
        {
          "gHa": "components/AdminCrisisStudent.tsx",
          "message": "Cannot find name 'Send'.",
          "line": 193,
          "column": 22
        }
      ]
    },
    "createdTimestamp": {
      "seconds": 1767783644,
      "nanos": 604000000
    },
    "doneTimestamp": {
      "seconds": 1767783662,
      "nanos": 485000000
    }
  },
  {
    "id": 28,
    "author": "model",
    "payload": {
      "type": "thinking",
      "text": "**Identifying Contextual Errors**\n\nI'm currently focused on pinpointing two errors within `contexts/GameContext.tsx`. Specifically, I've identified that the properties 'locked' and 'id' are causing issues because they're not recognized on a variable of type 'unknown'. The goal is to correct their unrecognized status.\n\n\n**Clarifying Week Data**\n\nI'm now diving into the `getCurrentGameWeek` function and its interactions with the `weeks` state. It seems I have a handle on how this function determines the current week. Specifically, by filtering for unlocked weeks and finding the maximum ID among them. I see that the `WeekModule` interface, as defined in `types.ts`, provides the structure for each week's data.\n\n\n**Addressing Type Safety Concerns**\n\nI'm now investigating a type mismatch issue. Specifically, `Object.values(weeks)` is unexpectedly returning `unknown[]` instead of `WeekModule[]`. This is preventing proper use in my code. It seems like the state definition should provide the correct type information. Casting to `WeekModule[]` directly in the problematic line, or within the filter, might be the solution I am looking for.\n\n\n**Rectifying Lucide Import**\n\nI've isolated a missing import within `components/AdminCrisisStudent.tsx`. The `Send` icon from `lucide-react` is utilized in the button component but isn't imported, which leads to a \"Cannot find name 'Send'\" error. The fix is straightforward: adding `Send` to the existing `lucide-react` import list within the file should resolve this.\n\n\n**Confirming Type Casting**\n\nI'm revisiting the potential type casting for `Object.values(weeks)` within `getCurrentGameWeek`. I believe casting to `WeekModule[]` directly in that problematic line will address the type mismatch, enabling proper use in subsequent array operations, namely filtering and mapping to `parseInt(w.id)`. The goal is to make sure this is properly typed.\n\n\n**Applying Contextual Fixes**\n\nI am now moving on to resolving the type safety issue within `contexts/GameContext.tsx`, particularly around the `Object.values(weeks)` operation. I'm exploring the nuances of this function when dealing with `Record<string, WeekModule>` types in older ES versions and considering how these might be related to the error. I've now applied a targeted fix to address it, and I'm ready to review the results.\n\n\n**Verifying Unknown Types**\n\nI'm now revisiting `contexts/GameContext.tsx`, particularly focusing on line 144. I see there may be more `unknown` types to identify. Specifically, I need to verify that `Object.values(weeks)` is appropriately typed. I think this relates to the earlier `getCurrentGameWeek` function. It looks like it may be related to the `weeks` state's record. I will resolve this to avoid any more problems.\n\n\n**Revisiting Type Guarantees**\n\nI am now focusing on line 144 in `contexts/GameContext.tsx`. I see that the `Object.values(weeks)` operation is the root of my type safety issue. The errors related to the `locked` and `id` properties confirm this. To correct, I will cast the array returned by `Object.values(weeks)` to ensure it is of type `WeekModule[]`, allowing the code to use the expected properties.\n\n\n",
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1767783648,
      "nanos": 469000000
    },
    "doneTimestamp": {
      "seconds": 1767783662,
      "nanos": 485000000
    }
  },
  {
    "id": 29,
    "author": "model",
    "payload": {
      "type": "generationTable",
      "entries": [
        {
          "path": "contexts/GameContext.tsx",
          "generationType": 2,
          "isDone": true,
          "description": "Fix TypeScript errors in getCurrentGameWeek by explicitly casting Object.values(weeks) to WeekModule[] to avoid 'unknown' type issues.",
          "diffs": [
            {
              "target": "",
              "replacement": "\nimport React, { createContext, useContext, useState, ReactNode, useEffect } from 'react';\nimport { Agency, WeekModule, GameEvent, WikiResource, Student, TransactionRequest, MercatoRequest, StudentHistoryEntry, MergerRequest } from '../types';\nimport { MOCK_AGENCIES, INITIAL_WEEKS, GAME_RULES, CONSTRAINTS_POOL } from '../constants';\nimport { useUI } from './UIContext';\nimport { db } from '../services/firebase';\nimport { collection, onSnapshot, doc, updateDoc, writeBatch, setDoc, deleteDoc } from 'firebase/firestore';\nimport { useAuth } from './AuthContext';\n\ninterface GameContextType {\n  // State\n  agencies: Agency[];\n  weeks: { [key: string]: WeekModule };\n  resources: WikiResource[]; // Wiki Data\n  role: 'admin' | 'student';\n  selectedAgencyId: string | null;\n  isAutoMode: boolean;\n  \n  // Actions\n  setRole: (role: 'admin' | 'student') => void;\n  selectAgency: (id: string | null) => void;\n  toggleAutoMode: () => void;\n  updateAgency: (agency: Agency) => void;\n  updateAgenciesList: (agencies: Agency[]) => void;\n  updateWeek: (weekId: string, week: WeekModule) => void;\n  \n  // Wiki Actions\n  addResource: (resource: WikiResource) => Promise<void>;\n  deleteResource: (id: string) => Promise<void>;\n\n  // Game Logic\n  shuffleConstraints: (agencyId: string) => void;\n  processFinance: (targetClass: 'A' | 'B') => Promise<void>;\n  processPerformance: (targetClass: 'A' | 'B') => Promise<void>;\n  resetGame: () => void;\n  \n  // Student Economy & RH\n  transferFunds: (sourceId: string, targetId: string, amount: number) => Promise<void>;\n  tradeScoreForCash: (studentId: string, scoreAmount: number) => Promise<void>;\n  injectCapital: (studentId: string, agencyId: string, amount: number) => Promise<void>;\n  requestScorePurchase: (studentId: string, agencyId: string, amountPixi: number, amountScore: number) => Promise<void>;\n  handleTransactionRequest: (agency: Agency, request: TransactionRequest, approved: boolean) => Promise<void>;\n  submitMercatoVote: (agencyId: string, requestId: string, voterId: string, vote: 'APPROVE' | 'REJECT') => Promise<void>;\n\n  // Black Ops & Mergers\n  triggerBlackOp: (sourceAgencyId: string, targetAgencyId: string, type: 'AUDIT' | 'LEAK') => Promise<void>;\n  proposeMerger: (sourceAgencyId: string, targetAgencyId: string) => Promise<void>;\n  finalizeMerger: (mergerId: string, targetAgencyId: string, approved: boolean) => Promise<void>;\n  getCurrentGameWeek: () => number;\n}\n\nconst GameContext = createContext<GameContextType | undefined>(undefined);\n\nexport const useGame = () => {\n  const context = useContext(GameContext);\n  if (!context) throw new Error('useGame must be used within a GameProvider');\n  return context;\n};\n\nexport const GameProvider: React.FC<{ children: ReactNode }> = ({ children }) => {\n  const { toast, confirm } = useUI();\n  const { userData } = useAuth();\n  \n  const [role, setRole] = useState<'admin' | 'student'>('student');\n  const [agencies, setAgencies] = useState<Agency[]>(MOCK_AGENCIES);\n  const [weeks, setWeeks] = useState<{ [key: string]: WeekModule }>(INITIAL_WEEKS);\n  const [resources, setResources] = useState<WikiResource[]>([]);\n  const [selectedAgencyId, setSelectedAgencyId] = useState<string | null>(null);\n  const [isAutoMode, setIsAutoMode] = useState(false);\n\n  // Sync Role with Auth\n  useEffect(() => {\n    if (userData) {\n      if (userData.role === 'admin') setRole('admin');\n      else setRole('student');\n    }\n  }, [userData]);\n\n  // 1. REAL-TIME SYNC: Agencies\n  useEffect(() => {\n    const unsubscribe = onSnapshot(collection(db, \"agencies\"), \n      (snapshot) => {\n        const agenciesData: Agency[] = [];\n        snapshot.forEach((doc) => {\n          agenciesData.push(doc.data() as Agency);\n        });\n        if (agenciesData.length === 0) {\n          seedDatabase().catch(console.error);\n        } else {\n          setAgencies(agenciesData);\n        }\n      },\n      (error) => {\n        console.error(\"Firestore Read Error (Agencies):\", error);\n        toast('info', 'Mode Hors Ligne');\n      }\n    );\n    return () => unsubscribe();\n  }, []);\n\n  // 2. REAL-TIME SYNC: Weeks\n  useEffect(() => {\n    const unsubscribe = onSnapshot(collection(db, \"weeks\"), \n      (snapshot) => {\n        const weeksData: { [key: string]: WeekModule } = {};\n        snapshot.forEach((doc) => {\n          weeksData[doc.id] = doc.data() as WeekModule;\n        });\n        if (Object.keys(weeksData).length > 0) setWeeks(weeksData);\n      }\n    );\n    return () => unsubscribe();\n  }, []);\n\n  // 3. REAL-TIME SYNC: Resources\n  useEffect(() => {\n    const unsubscribe = onSnapshot(collection(db, \"resources\"), \n      (snapshot) => {\n        const resData: WikiResource[] = [];\n        snapshot.forEach((doc) => {\n          resData.push(doc.data() as WikiResource);\n        });\n        setResources(resData);\n      }\n    );\n    return () => unsubscribe();\n  }, []);\n\n  // 4. AUTO MODE SCHEDULER\n  useEffect(() => {\n      if (!isAutoMode) return;\n      const checkSchedule = () => {\n          const now = new Date();\n          const today = now.toISOString().split('T')[0];\n          console.log(`Auto Check: ${today}`);\n      };\n      const interval = setInterval(checkSchedule, 60000); \n      return () => clearInterval(interval);\n  }, [isAutoMode, weeks]);\n\n  // HELPER: Get Current Week\n  const getCurrentGameWeek = () => {\n      // Logic: Find the highest week number that is unlocked.\n      // Or simply return 3 for dev purposes if needed, but better to calculate.\n      // Cast Object.values(weeks) to WeekModule[] to fix 'unknown' type errors for property 'locked' and 'id'\n      const unlockedWeeks = (Object.values(weeks) as WeekModule[]).filter(w => !w.locked).map(w => parseInt(w.id));\n      return unlockedWeeks.length > 0 ? Math.max(...unlockedWeeks) : 1;\n  };\n\n  // SEED FUNCTION\n  const seedDatabase = async () => {\n    const batch = writeBatch(db);\n    MOCK_AGENCIES.forEach(agency => {\n      const ref = doc(db, \"agencies\", agency.id);\n      batch.set(ref, agency);\n    });\n    Object.values(INITIAL_WEEKS).forEach(week => {\n      const ref = doc(db, \"weeks\", week.id);\n      batch.set(ref, week);\n    });\n    await batch.commit();\n  };\n\n  const updateAgency = async (updatedAgency: Agency) => {\n    try {\n        let veCap = 100;\n        const memberCount = updatedAgency.members.length;\n        if (memberCount === 1) veCap = GAME_RULES.VE_CAP_1_MEMBER;\n        else if (memberCount <= 3) veCap = GAME_RULES.VE_CAP_2_3_MEMBERS;\n        else veCap = GAME_RULES.VE_CAP_4_PLUS_MEMBERS;\n\n        const finalVE = Math.min(updatedAgency.ve_current, veCap);\n        const agencyRef = doc(db, \"agencies\", updatedAgency.id);\n        await updateDoc(agencyRef, { ...updatedAgency, ve_current: finalVE });\n    } catch (e) {\n        console.error(e);\n        toast('error', 'Erreur sauvegarde');\n    }\n  };\n\n  const updateAgenciesList = async (newAgencies: Agency[]) => {\n      try {\n        const batch = writeBatch(db);\n        newAgencies.forEach(a => {\n            const ref = doc(db, \"agencies\", a.id);\n            batch.update(ref, { ...a });\n        });\n        await batch.commit();\n      } catch(e) {\n         console.error(e);\n         toast('error', 'Erreur mise à jour multiple');\n      }\n  };\n\n  const updateWeek = async (weekId: string, updatedWeek: WeekModule) => {\n    try {\n        const weekRef = doc(db, \"weeks\", weekId);\n        await updateDoc(weekRef, { ...updatedWeek });\n        toast('success', `Semaine ${weekId} mise à jour`);\n    } catch (e) {\n        console.error(e);\n        toast('error', 'Erreur maj semaine');\n    }\n  };\n\n  const addResource = async (resource: WikiResource) => {\n      await setDoc(doc(db, \"resources\", resource.id), resource);\n      toast('success', \"Ressource ajoutée\");\n  };\n\n  const deleteResource = async (id: string) => {\n      await deleteDoc(doc(db, \"resources\", id));\n      toast('success', \"Ressource supprimée\");\n  };\n\n  const selectAgency = (id: string | null) => setSelectedAgencyId(id);\n  const toggleAutoMode = () => setIsAutoMode(!isAutoMode);\n\n  const shuffleConstraints = async (agencyId: string) => {\n    const agency = agencies.find(a => a.id === agencyId);\n    if (!agency) return;\n    const randomSpace = CONSTRAINTS_POOL.space[Math.floor(Math.random() * CONSTRAINTS_POOL.space.length)];\n    const randomStyle = CONSTRAINTS_POOL.style[Math.floor(Math.random() * CONSTRAINTS_POOL.style.length)];\n    const randomClient = CONSTRAINTS_POOL.client[Math.floor(Math.random() * CONSTRAINTS_POOL.client.length)];\n    await updateAgency({\n      ...agency,\n      constraints: { space: randomSpace, style: randomStyle, client: randomClient }\n    });\n    toast('info', 'Contraintes régénérées');\n  };\n\n  // --- PROCESS: FINANCE (Rent, Salary, Revenue) ---\n  const processFinance = async (targetClass: 'A' | 'B') => {\n      const today = new Date().toISOString().split('T')[0];\n      try {\n        const batch = writeBatch(db);\n        let processedCount = 0;\n\n        agencies.forEach(agency => {\n            if (agency.id === 'unassigned' || agency.classId !== targetClass) return;\n            processedCount++;\n\n            let currentBudget = agency.budget_real;\n            let logEvents: GameEvent[] = [];\n\n            // 1. RENT\n            currentBudget -= GAME_RULES.AGENCY_RENT;\n            logEvents.push({ id: `fin-rent-${Date.now()}-${agency.id}`, date: today, type: 'CRISIS', label: 'Loyer Agence', deltaBudgetReal: -GAME_RULES.AGENCY_RENT, description: `Prélèvement automatique.` });\n\n            // 2. SALARIES\n            let actualDisbursed = 0;\n            const updatedMembers = agency.members.map(member => {\n                const rawSalary = member.individualScore * GAME_RULES.SALARY_MULTIPLIER; \n                const pay = Math.min(rawSalary, GAME_RULES.SALARY_CAP_FOR_STUDENT);\n                if (currentBudget < 0) return member; \n                actualDisbursed += pay;\n                return { ...member, wallet: (member.wallet || 0) + pay };\n            });\n\n            if (currentBudget >= 0) {\n                currentBudget -= actualDisbursed;\n                logEvents.push({ id: `fin-pay-${Date.now()}-${agency.id}`, date: today, type: 'PAYROLL', label: 'Salaires', deltaBudgetReal: -actualDisbursed, description: `Salaires versés.` });\n            } else {\n                logEvents.push({ id: `fin-pay-${Date.now()}-${agency.id}`, date: today, type: 'PAYROLL', label: 'Salaires Gelés', deltaBudgetReal: 0, description: `Dette active.` });\n            }\n\n            // 3. REVENUES\n            const revenueVE = (agency.ve_current * GAME_RULES.REVENUE_VE_MULTIPLIER);\n            const bonuses = agency.weeklyRevenueModifier || 0;\n            const totalRevenue = revenueVE + bonuses + GAME_RULES.REVENUE_BASE;\n            \n            currentBudget += totalRevenue;\n            logEvents.push({ id: `fin-rev-${Date.now()}-${agency.id}`, date: today, type: 'REVENUE', label: 'Recettes', deltaBudgetReal: totalRevenue, description: `Facturation client (VE: ${agency.ve_current}).` });\n\n            const ref = doc(db, \"agencies\", agency.id);\n            batch.update(ref, {\n                budget_real: currentBudget,\n                members: updatedMembers,\n                eventLog: [...agency.eventLog, ...logEvents]\n            });\n        });\n\n        if (processedCount > 0) {\n            await batch.commit();\n            toast('success', `Finance Classe ${targetClass}: Terminée.`);\n        }\n      } catch(e) { console.error(e); toast('error', \"Erreur Finance\"); }\n  };\n\n  // --- PROCESS: PERFORMANCE ---\n  const processPerformance = async (targetClass: 'A' | 'B') => {\n      const today = new Date().toISOString().split('T')[0];\n      try {\n        const batch = writeBatch(db);\n        let processedCount = 0;\n\n        agencies.forEach(agency => {\n            if (agency.id === 'unassigned' || agency.classId !== targetClass) return;\n            processedCount++;\n            \n            let logEvents: GameEvent[] = [];\n            const updatedMembers = agency.members.map(member => {\n                const reviews = agency.peerReviews.filter(r => r.targetId === member.id);\n                if (reviews.length === 0) return member;\n                const avg = reviews.reduce((sum, r) => sum + ((r.ratings.attendance + r.ratings.quality + r.ratings.involvement)/3), 0) / reviews.length;\n                let scoreDelta = 0;\n                let newStreak = member.streak || 0;\n                if (avg > 4.5) { scoreDelta = 2; newStreak++; if (newStreak >= 3) { scoreDelta += 10; newStreak = 0; } } \n                else if (avg >= 4.0) { scoreDelta = 1; newStreak = 0; } \n                else if (avg < 2.0) { scoreDelta = -5; newStreak = 0; } \n                else { newStreak = 0; }\n                return { ...member, individualScore: Math.max(0, Math.min(100, member.individualScore + scoreDelta)), streak: newStreak };\n            });\n\n            let veAdjustment = 0;\n            const budget = agency.budget_real;\n            if (budget >= 2000) veAdjustment += Math.floor(budget / 2000);\n            else if (budget < 0) veAdjustment -= Math.ceil(Math.abs(budget) / 1000) * 2;\n\n            if (veAdjustment !== 0) {\n                logEvents.push({ id: `perf-ve-${Date.now()}-${agency.id}`, date: today, type: veAdjustment > 0 ? 'VE_DELTA' : 'CRISIS', label: 'Ajustement VE', deltaVE: veAdjustment, description: veAdjustment > 0 ? 'Trésorerie saine.' : 'Dette.' });\n            }\n\n            let veCap = 100;\n            if (agency.members.length === 1) veCap = GAME_RULES.VE_CAP_1_MEMBER;\n            else if (agency.members.length <= 3) veCap = GAME_RULES.VE_CAP_2_3_MEMBERS;\n            else veCap = GAME_RULES.VE_CAP_4_PLUS_MEMBERS;\n            \n            const finalVE = Math.min(Math.max(0, agency.ve_current + veAdjustment), veCap);\n\n            const ref = doc(db, \"agencies\", agency.id);\n            batch.update(ref, {\n                members: updatedMembers,\n                ve_current: finalVE,\n                peerReviews: [], \n                eventLog: [...agency.eventLog, ...logEvents],\n                status: finalVE >= 60 ? 'stable' : finalVE >= 40 ? 'fragile' : 'critique'\n            });\n        });\n\n        if (processedCount > 0) {\n            await batch.commit();\n            toast('success', `Performance Classe ${targetClass}: Terminée.`);\n        }\n      } catch(e) { console.error(e); toast('error', \"Erreur Performance\"); }\n  };\n\n  const transferFunds = async (sourceId: string, targetId: string, amount: number) => { /* Impl */ };\n  const tradeScoreForCash = async (studentId: string, scoreAmount: number) => { /* Impl */ };\n  const injectCapital = async (studentId: string, agencyId: string, amount: number) => { \n      const agency = agencies.find(a => a.id === agencyId);\n      if(!agency) return;\n      const student = agency.members.find(m => m.id === studentId);\n      if(!student || (student.wallet || 0) < amount) return;\n      \n      const batch = writeBatch(db);\n      const updatedMembers = agency.members.map(m => m.id === studentId ? { ...m, wallet: (m.wallet || 0) - amount } : m);\n      const updatedAgency = { ...agency, members: updatedMembers, budget_real: agency.budget_real + amount };\n      batch.update(doc(db, \"agencies\", agency.id), updatedAgency);\n      await batch.commit();\n      toast('success', 'Injection réussie');\n  };\n  \n  const requestScorePurchase = async (studentId: string, agencyId: string, amountPixi: number, amountScore: number) => { \n     const agency = agencies.find(a => a.id === agencyId);\n     if(!agency) return;\n     const newRequest: TransactionRequest = { id: `req-score-${Date.now()}`, studentId, studentName: agency.members.find(m=>m.id===studentId)?.name || '', type: 'BUY_SCORE', amountPixi, amountScore, status: 'PENDING', date: new Date().toISOString().split('T')[0] };\n     await updateDoc(doc(db, \"agencies\", agency.id), { transactionRequests: [...(agency.transactionRequests || []), newRequest] });\n     toast('success', \"Demande envoyée\");\n  };\n\n  const handleTransactionRequest = async (agency: Agency, request: TransactionRequest, approved: boolean) => {\n      const batch = writeBatch(db);\n      const agencyRef = doc(db, \"agencies\", agency.id);\n      const updatedRequests = (agency.transactionRequests || []).filter(r => r.id !== request.id);\n      if (!approved) { batch.update(agencyRef, { transactionRequests: updatedRequests }); await batch.commit(); return; }\n      \n      const updatedMembers = agency.members.map(m => m.id === request.studentId ? { ...m, wallet: (m.wallet || 0) - request.amountPixi, individualScore: Math.min(100, m.individualScore + request.amountScore) } : m);\n      batch.update(agencyRef, { transactionRequests: updatedRequests, members: updatedMembers });\n      await batch.commit();\n      toast('success', \"Transaction validée\");\n  };\n\n  const submitMercatoVote = async (agencyId: string, requestId: string, voterId: string, vote: 'APPROVE' | 'REJECT') => {\n      const agency = agencies.find(a => a.id === agencyId);\n      if(!agency) return;\n      const request = agency.mercatoRequests.find(r => r.id === requestId);\n      if(!request) return;\n\n      const newVotes = { ...request.votes, [voterId]: vote };\n      const approvals = Object.values(newVotes).filter(v => v === 'APPROVE').length;\n      let totalVoters = agency.members.length;\n      let threshold = 0.66;\n      if (request.type === 'FIRE' && request.requesterId !== request.studentId) { totalVoters = Math.max(1, agency.members.length - 1); threshold = 0.75; }\n\n      const batch = writeBatch(db);\n      if (approvals / totalVoters > threshold) {\n          // Execution Logic (Simplified for context update)\n          const targetAgency = agencies.find(a => a.id === 'unassigned');\n          if(targetAgency) {\n               // Execution Logic (Simplified for context update)\n               const student = agency.members.find(m => m.id === request.studentId);\n               if(student) {\n                   const updatedSource = agency.members.filter(m => m.id !== request.studentId);\n                   const updatedTarget = [...targetAgency.members, { ...student, history: [] }]; // Simplified history update\n                   batch.update(doc(db, \"agencies\", agency.id), { members: updatedSource, mercatoRequests: agency.mercatoRequests.filter(r => r.id !== requestId) });\n                   batch.update(doc(db, \"agencies\", targetAgency.id), { members: updatedTarget });\n               }\n          }\n      } else {\n          const updatedRequests = agency.mercatoRequests.map(r => r.id === requestId ? { ...r, votes: newVotes } : r);\n          batch.update(doc(db, \"agencies\", agency.id), { mercatoRequests: updatedRequests });\n      }\n      await batch.commit();\n      toast('success', \"Vote enregistré\");\n  };\n\n  // --- BLACK OPS LOGIC ---\n  const triggerBlackOp = async (sourceAgencyId: string, targetAgencyId: string, type: 'AUDIT' | 'LEAK') => {\n      const week = getCurrentGameWeek();\n      if (week < GAME_RULES.UNLOCK_WEEK_BLACK_OPS) {\n          toast('error', `Disponible en Semaine ${GAME_RULES.UNLOCK_WEEK_BLACK_OPS} uniquement.`);\n          return;\n      }\n\n      const sourceAgency = agencies.find(a => a.id === sourceAgencyId);\n      const targetAgency = agencies.find(a => a.id === targetAgencyId);\n      if (!sourceAgency || !targetAgency) return;\n\n      const cost = type === 'AUDIT' ? GAME_RULES.COST_AUDIT : GAME_RULES.COST_LEAK;\n\n      if (sourceAgency.budget_real < cost) {\n          toast('error', \"Fonds insuffisants pour cette opération.\");\n          return;\n      }\n\n      const batch = writeBatch(db);\n      const today = new Date().toISOString().split('T')[0];\n\n      // 1. Pay Cost\n      const sourceRef = doc(db, \"agencies\", sourceAgency.id);\n      batch.update(sourceRef, {\n          budget_real: sourceAgency.budget_real - cost,\n          eventLog: [...sourceAgency.eventLog, {\n              id: `op-cost-${Date.now()}`, date: today, type: 'BLACK_OP', label: `Opération: ${type}`, deltaBudgetReal: -cost, description: `Paiement prestataire externe.`\n          }]\n      });\n\n      // 2. Execute Effect\n      if (type === 'LEAK') {\n          // Leak logic: Just a notification for now (Simulated \"Intel\")\n          toast('success', \"Fuite obtenue : Le brief de la semaine prochaine contient une contrainte 'Low Tech'.\");\n      } else if (type === 'AUDIT') {\n          // Audit Logic: Check Target Health\n          // Vulnerability: < 50% attendance (mocked by low VE) or Negative Budget\n          const isVulnerable = targetAgency.budget_real < 0 || targetAgency.ve_current < 40;\n          \n          if (isVulnerable) {\n               // SUCCESSFUL ATTACK\n               const targetRef = doc(db, \"agencies\", targetAgency.id);\n               batch.update(targetRef, {\n                   ve_current: Math.max(0, targetAgency.ve_current - 10),\n                   eventLog: [...targetAgency.eventLog, {\n                       id: `op-hit-${Date.now()}`, date: today, type: 'CRISIS', label: \"Audit Externe (Sanction)\", deltaVE: -10, description: \"Des irrégularités ont été exposées par un audit concurrent.\"\n                   }]\n               });\n               toast('success', `Audit réussi ! ${targetAgency.name} perd 10 VE.`);\n          } else {\n               // BACKFIRE\n               batch.update(sourceRef, {\n                   ve_current: Math.max(0, sourceAgency.ve_current - 20),\n                   eventLog: [...sourceAgency.eventLog, {\n                       id: `op-fail-${Date.now()}`, date: today, type: 'CRISIS', label: \"Procès Diffamation\", deltaVE: -20, description: \"L'audit n'a rien révélé. L'agence cible porte plainte.\"\n                   }]\n               });\n               toast('error', `Echec ! ${targetAgency.name} est clean. Vous perdez 20 VE pour diffamation.`);\n          }\n      }\n\n      await batch.commit();\n  };\n\n  // --- MERGERS LOGIC ---\n  const proposeMerger = async (sourceAgencyId: string, targetAgencyId: string) => {\n      const week = getCurrentGameWeek();\n      if (week < GAME_RULES.UNLOCK_WEEK_MERGERS) {\n          toast('error', `Fusions disponibles en Semaine ${GAME_RULES.UNLOCK_WEEK_MERGERS}.`);\n          return;\n      }\n      \n      const targetAgency = agencies.find(a => a.id === targetAgencyId);\n      if(!targetAgency) return;\n\n      if (targetAgency.ve_current > GAME_RULES.MERGER_VE_THRESHOLD) {\n           toast('error', \"Cette agence est trop stable pour être rachetée (VE > 40).\");\n           return;\n      }\n\n      const request: MergerRequest = {\n          id: `merger-${Date.now()}`,\n          requesterAgencyId: sourceAgencyId,\n          requesterAgencyName: agencies.find(a => a.id === sourceAgencyId)?.name || 'Inconnu',\n          targetAgencyId: targetAgencyId,\n          status: 'PENDING',\n          date: new Date().toISOString().split('T')[0],\n          offerDetails: \"Rachat complet de la dette et intégration des effectifs.\"\n      };\n\n      const targetRef = doc(db, \"agencies\", targetAgencyId);\n      await updateDoc(targetRef, {\n          mergerRequests: [...(targetAgency.mergerRequests || []), request]\n      });\n      toast('success', \"Proposition de rachat envoyée.\");\n  };\n\n  const finalizeMerger = async (mergerId: string, targetAgencyId: string, approved: boolean) => {\n      const targetAgency = agencies.find(a => a.id === targetAgencyId);\n      if(!targetAgency) return;\n      const request = targetAgency.mergerRequests?.find(r => r.id === mergerId);\n      if(!request) return;\n\n      const batch = writeBatch(db);\n      \n      // Update Target Requests (Remove pending)\n      const updatedRequests = targetAgency.mergerRequests?.filter(r => r.id !== mergerId);\n      \n      if (!approved) {\n           batch.update(doc(db, \"agencies\", targetAgencyId), { mergerRequests: updatedRequests });\n           await batch.commit();\n           toast('info', \"Fusion refusée.\");\n           return;\n      }\n\n      const sourceAgency = agencies.find(a => a.id === request.requesterAgencyId);\n      if(!sourceAgency) return;\n\n      // CHECK LIMITS\n      if (sourceAgency.members.length + targetAgency.members.length > GAME_RULES.MERGER_MAX_MEMBERS) {\n          toast('error', `Fusion impossible : La nouvelle équipe dépasserait ${GAME_RULES.MERGER_MAX_MEMBERS} membres.`);\n          return;\n      }\n\n      // EXECUTE FUSION\n      // 1. Move Members\n      const newMembers = [...sourceAgency.members, ...targetAgency.members];\n      \n      // 2. Absorb Budget (Debts included!)\n      const newBudget = sourceAgency.budget_real + targetAgency.budget_real;\n      \n      // 3. Update Source\n      batch.update(doc(db, \"agencies\", sourceAgency.id), {\n          members: newMembers,\n          budget_real: newBudget,\n          eventLog: [...sourceAgency.eventLog, {\n              id: `merger-win-${Date.now()}`, date: new Date().toISOString().split('T')[0], type: 'MERGER', label: \"Acquisition\", description: `Rachat de ${targetAgency.name}. Dette absorbée.`\n          }]\n      });\n\n      // 4. Delete Target (or Reset to empty shell)\n      // Ideally delete, but to avoid bugs with references, let's empty it and mark as DISSOLVED\n      batch.update(doc(db, \"agencies\", targetAgency.id), {\n          members: [],\n          status: 'critique',\n          name: `${targetAgency.name} (Dissoute)`,\n          mergerRequests: []\n      });\n\n      await batch.commit();\n      toast('success', \"Fusion confirmée. Agence absorbée.\");\n  };\n\n  const resetGame = async () => {\n      try { await seedDatabase(); } catch (e) { console.error(e); }\n  };\n\n  return (\n    <GameContext.Provider value={{\n      agencies, weeks, resources, role, selectedAgencyId, isAutoMode,\n      setRole, selectAgency, toggleAutoMode, updateAgency, updateAgenciesList, updateWeek,\n      addResource, deleteResource, shuffleConstraints, processFinance, processPerformance, resetGame,\n      transferFunds, tradeScoreForCash, injectCapital, requestScorePurchase, handleTransactionRequest,\n      submitMercatoVote, triggerBlackOp, proposeMerger, finalizeMerger, getCurrentGameWeek\n    }}>\n      {children}\n    </GameContext.Provider>\n  );\n};\n"
            }
          ]
        },
        {
          "path": "components/AdminCrisisStudent.tsx",
          "generationType": 2,
          "isDone": true,
          "description": "Add missing 'Send' import from lucide-react to resolve 'Cannot find name Send' error.",
          "diffs": [
            {
              "target": "",
              "replacement": "\nimport React, { useState, useMemo } from 'react';\nimport { Agency, CrisisPreset, GameEvent, Student } from '../types';\nimport { Crown, User, UserMinus, Sparkles, Gavel, Briefcase, FileWarning, ShieldAlert, BadgeCheck, Heart, Medal, Star, TrendingUp, TrendingDown, Coins, Plus, Minus, Send } from 'lucide-react';\nimport { useUI } from '../contexts/UIContext';\n\ninterface AdminCrisisStudentProps {\n  agencies: Agency[];\n  onUpdateAgency: (agency: Agency) => void;\n  readOnly?: boolean;\n}\n\ninterface StudentPreset extends CrisisPreset {\n    category: 'STUDENT_SANCTION' | 'STUDENT_BONUS' | 'CEREMONY';\n    deltaScore?: number;\n    deltaWallet?: number;\n    defaultReason: string;\n}\n\nexport const AdminCrisisStudent: React.FC<AdminCrisisStudentProps> = ({ agencies, onUpdateAgency, readOnly }) => {\n  const { confirm, toast } = useUI();\n\n  const [selectedStudentId, setSelectedStudentId] = useState<string>('');\n  const [presetType, setPresetType] = useState<'SANCTION' | 'BONUS' | 'CEREMONY'>('BONUS');\n  \n  const [form, setForm] = useState({\n      label: \"\",\n      reason: \"\",\n      deltaScore: 0,\n      deltaWallet: 0\n  });\n\n  const allStudents = useMemo(() => {\n      const list: {student: Student, agencyName: string, agencyId: string}[] = [];\n      agencies.forEach(a => {\n          a.members.forEach(m => list.push({student: m, agencyName: a.name, agencyId: a.id}));\n      });\n      return list.sort((a,b) => a.student.name.localeCompare(b.student.name));\n  }, [agencies]);\n\n  const PRESETS: StudentPreset[] = [\n    { label: \"Raté de Sprint\", defaultReason: \"Deadline manquée.\", deltaScore: -2, deltaWallet: -50, deltaVE: 0, deltaBudget: 0, icon: <FileWarning/>, category: 'STUDENT_SANCTION', description: \"Retard\" },\n    { label: \"Ghosting / Abandon\", defaultReason: \"Absence injustifiée.\", deltaScore: -5, deltaWallet: -200, deltaVE: 0, deltaBudget: 0, icon: <UserMinus/>, category: 'STUDENT_SANCTION', description: \"Absence\" },\n    { label: \"Faute Grave\", defaultReason: \"Comportement nuisible.\", deltaScore: -15, deltaWallet: -500, deltaVE: 0, deltaBudget: 0, icon: <ShieldAlert/>, category: 'STUDENT_SANCTION', description: \"Comportement\" },\n    \n    { label: \"MVP Technique\", defaultReason: \"A débloqué une situation complexe.\", deltaScore: +5, deltaWallet: 300, deltaVE: 0, deltaBudget: 0, icon: <BadgeCheck/>, category: 'STUDENT_BONUS', description: \"Skill\" },\n    { label: \"Esprit de Corps\", defaultReason: \"A soutenu ses collègues.\", deltaScore: +3, deltaWallet: 150, deltaVE: 0, deltaBudget: 0, icon: <Heart/>, category: 'STUDENT_BONUS', description: \"Soft Skill\" },\n    { label: \"Crunch Hero\", defaultReason: \"Effort exceptionnel.\", deltaScore: +4, deltaWallet: 200, deltaVE: 0, deltaBudget: 0, icon: <Sparkles/>, category: 'STUDENT_BONUS', description: \"Effort\" },\n\n    { label: \"🥇 Major de Promo\", defaultReason: \"1ère place au classement général du S1.\", deltaScore: +15, deltaWallet: 1000, deltaVE: 0, deltaBudget: 0, icon: <Medal/>, category: 'CEREMONY', description: \"Top 1 Classe\" },\n    { label: \"🥈 Dauphin\", defaultReason: \"2ème place au classement général du S1.\", deltaScore: +10, deltaWallet: 750, deltaVE: 0, deltaBudget: 0, icon: <Medal/>, category: 'CEREMONY', description: \"Top 2 Classe\" },\n    { label: \"🥉 Podium\", defaultReason: \"3ème place au classement général du S1.\", deltaScore: +5, deltaWallet: 500, deltaVE: 0, deltaBudget: 0, icon: <Medal/>, category: 'CEREMONY', description: \"Top 3 Classe\" },\n  ];\n\n  const filteredPresets = PRESETS.filter(p => \n      (presetType === 'SANCTION' && p.category === 'STUDENT_SANCTION') ||\n      (presetType === 'BONUS' && p.category === 'STUDENT_BONUS') ||\n      (presetType === 'CEREMONY' && p.category === 'CEREMONY')\n  );\n\n  const selectPreset = (preset: StudentPreset) => {\n      setForm({\n          label: preset.label,\n          reason: preset.defaultReason,\n          deltaScore: preset.deltaScore || 0,\n          deltaWallet: preset.deltaWallet || 0\n      });\n  };\n\n  const handleApply = async () => {\n      if(readOnly) return;\n      if (!selectedStudentId) { toast('error', \"Sélectionnez un étudiant.\"); return; }\n      if(!form.label || !form.reason) { toast('error', \"Motif obligatoire.\"); return; }\n\n      const targetInfo = allStudents.find(s => s.student.id === selectedStudentId);\n      if(!targetInfo) return;\n\n      const confirmed = await confirm({\n          title: \"Confirmer l'Arbitrage RH\",\n          message: `Donner/Prendre à ${targetInfo.student.name}:\\n${form.deltaScore > 0 ? '+' : ''}${form.deltaScore} pts de Score\\n${form.deltaWallet > 0 ? '+' : ''}${form.deltaWallet} PiXi\\n\\nMotif: ${form.label}`,\n          confirmText: \"Appliquer les Changements\",\n          isDangerous: form.deltaScore < 0 || form.deltaWallet < 0\n      });\n\n      if(confirmed) {\n          const agency = agencies.find(a => a.id === targetInfo.agencyId);\n          if(!agency) return;\n\n          const updatedMembers = agency.members.map(m => \n              m.id === selectedStudentId \n              ? { \n                  ...m, \n                  individualScore: Math.max(0, Math.min(100, m.individualScore + form.deltaScore)),\n                  wallet: (m.wallet || 0) + form.deltaWallet\n                } \n              : m\n          );\n\n          onUpdateAgency({\n              ...agency,\n              members: updatedMembers,\n              eventLog: [...agency.eventLog, {\n                  id: `rh-${Date.now()}`, date: new Date().toISOString().split('T')[0], type: 'INFO',\n                  label: `Arbitrage RH: ${targetInfo.student.name}`,\n                  description: `${form.label}: ${form.reason} (Score: ${form.deltaScore}, PiXi: ${form.deltaWallet})`\n              }]\n          });\n          toast('success', \"Arbitrage appliqué.\");\n          setForm({label: \"\", reason: \"\", deltaScore: 0, deltaWallet: 0});\n      }\n  };\n\n  return (\n    <div className=\"grid grid-cols-1 lg:grid-cols-12 gap-8\">\n         <div className=\"lg:col-span-4 flex flex-col gap-4\">\n            <div className=\"p-4 bg-white rounded-2xl border border-slate-200 shadow-sm\">\n                <h3 className=\"font-bold text-slate-900 mb-4 flex items-center gap-2\"><User size={20}/> Étudiant Cible</h3>\n                <select \n                    className=\"w-full p-3 rounded-xl border border-slate-200 bg-slate-50 font-bold text-sm outline-none focus:ring-2 focus:ring-indigo-500\"\n                    value={selectedStudentId}\n                    onChange={(e) => setSelectedStudentId(e.target.value)}\n                    size={12}\n                >\n                    {allStudents.map(item => (\n                        <option key={item.student.id} value={item.student.id} className=\"py-2 px-2 border-b border-slate-100 last:border-0 hover:bg-indigo-50 cursor-pointer\">\n                            {item.student.name} ({item.agencyName})\n                        </option>\n                    ))}\n                </select>\n            </div>\n         </div>\n\n         <div className=\"lg:col-span-8 space-y-6\">\n            <div className=\"flex gap-2 bg-slate-100 p-1 rounded-2xl\">\n                <button onClick={() => setPresetType('SANCTION')} className={`flex-1 py-3 rounded-xl font-bold text-xs uppercase transition-all ${presetType === 'SANCTION' ? 'bg-white shadow text-red-600' : 'text-slate-400'}`}>Sanctions</button>\n                <button onClick={() => setPresetType('BONUS')} className={`flex-1 py-3 rounded-xl font-bold text-xs uppercase transition-all ${presetType === 'BONUS' ? 'bg-white shadow text-emerald-600' : 'text-slate-400'}`}>Bonus</button>\n                <button onClick={() => setPresetType('CEREMONY')} className={`flex-1 py-3 rounded-xl font-bold text-xs uppercase transition-all ${presetType === 'CEREMONY' ? 'bg-white shadow text-amber-600' : 'text-slate-400'}`}>Cérémonie S1</button>\n            </div>\n\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                {filteredPresets.map((preset, idx) => (\n                    <div key={idx} onClick={() => selectPreset(preset)} className=\"p-4 rounded-xl border-2 border-white bg-white hover:border-indigo-300 cursor-pointer transition-all shadow-sm\">\n                        <div className=\"flex items-center gap-3 mb-2\">\n                            <div className=\"p-2 bg-slate-50 rounded-lg\">{preset.icon}</div>\n                            <h4 className=\"font-bold text-slate-900 text-sm\">{preset.label}</h4>\n                        </div>\n                        <div className=\"flex gap-2 mt-2\">\n                            <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded ${preset.deltaScore! > 0 ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'}`}>Score {preset.deltaScore! > 0 ? '+' : ''}{preset.deltaScore}</span>\n                            <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded ${preset.deltaWallet! > 0 ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700'}`}>PiXi {preset.deltaWallet! > 0 ? '+' : ''}{preset.deltaWallet}</span>\n                        </div>\n                    </div>\n                ))}\n            </div>\n\n            <div className=\"bg-slate-900 text-white p-6 rounded-3xl shadow-xl space-y-6\">\n                <h4 className=\"font-bold text-indigo-300 text-sm uppercase tracking-widest flex items-center gap-2\"><Gavel size={18}/> Console d'Arbitrage Libre</h4>\n                \n                <div className=\"grid grid-cols-2 gap-6\">\n                    <div className=\"space-y-2\">\n                        <label className=\"text-[10px] font-bold uppercase text-slate-400 flex items-center gap-1\"><TrendingUp size={12}/> Ajustement Note / 100</label>\n                        <div className=\"flex items-center gap-3\">\n                            <button onClick={() => setForm({...form, deltaScore: form.deltaScore - 1})} className=\"p-2 bg-white/10 rounded-lg hover:bg-red-500\"><Minus size={16}/></button>\n                            <input type=\"number\" value={form.deltaScore} onChange={e => setForm({...form, deltaScore: Number(e.target.value)})} className=\"flex-1 bg-white/5 border border-white/10 rounded-xl p-3 text-center text-xl font-bold focus:ring-2 focus:ring-indigo-500 outline-none\" />\n                            <button onClick={() => setForm({...form, deltaScore: form.deltaScore + 1})} className=\"p-2 bg-white/10 rounded-lg hover:bg-emerald-500\"><Plus size={16}/></button>\n                        </div>\n                    </div>\n                    <div className=\"space-y-2\">\n                        <label className=\"text-[10px] font-bold uppercase text-slate-400 flex items-center gap-1\"><Coins size={12}/> Don / Amende (PiXi)</label>\n                        <div className=\"flex items-center gap-3\">\n                            <button onClick={() => setForm({...form, deltaWallet: form.deltaWallet - 100})} className=\"p-2 bg-white/10 rounded-lg hover:bg-red-500\"><Minus size={16}/></button>\n                            <input type=\"number\" value={form.deltaWallet} onChange={e => setForm({...form, deltaWallet: Number(e.target.value)})} className=\"flex-1 bg-white/5 border border-white/10 rounded-xl p-3 text-center text-xl font-bold focus:ring-2 focus:ring-indigo-500 outline-none\" />\n                            <button onClick={() => setForm({...form, deltaWallet: form.deltaWallet + 100})} className=\"p-2 bg-white/10 rounded-lg hover:bg-emerald-500\"><Plus size={16}/></button>\n                        </div>\n                    </div>\n                </div>\n\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                    <div>\n                        <label className=\"text-[10px] font-bold uppercase text-slate-400 block mb-1\">Libellé de l'action</label>\n                        <input type=\"text\" value={form.label} onChange={e => setForm({...form, label: e.target.value})} className=\"w-full bg-white/5 border border-white/10 rounded-xl p-3 text-sm font-bold\" placeholder=\"Ex: Don Exceptionnel\" />\n                    </div>\n                    <div>\n                        <label className=\"text-[10px] font-bold uppercase text-slate-400 block mb-1\">Détails (Optionnel)</label>\n                        <input type=\"text\" value={form.reason} onChange={e => setForm({...form, reason: e.target.value})} className=\"w-full bg-white/5 border border-white/10 rounded-xl p-3 text-sm\" placeholder=\"Justification pédagogique...\" />\n                    </div>\n                </div>\n\n                <button \n                    onClick={handleApply}\n                    disabled={!selectedStudentId || readOnly}\n                    className=\"w-full py-4 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-2xl shadow-lg shadow-indigo-900/50 transition-all flex items-center justify-center gap-3 disabled:opacity-50\"\n                >\n                    <Send size={20}/> Appliquer la Décision RH\n                </button>\n            </div>\n         </div>\n    </div>\n  );\n};\n"
            }
          ]
        }
      ]
    },
    "createdTimestamp": {
      "seconds": 1767783662,
      "nanos": 485000000
    },
    "doneTimestamp": {
      "seconds": 1767783696,
      "nanos": 811000000
    }
  },
  {
    "id": 31,
    "author": "user",
    "payload": {
      "type": "text",
      "text": "Est-ce qu'il existe encore des informations qui manquent dans l'UI étudiants ou des bug de workflow/logique ?\n\nNe changes pas le code, réponds juste",
      "files": [],
      "fileUploads": [],
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1767785381,
      "nanos": 533000000
    }
  },
  {
    "id": 32,
    "author": "model",
    "payload": {
      "type": "thinking",
      "text": "**Evaluating Student Interface**\n\nI've been meticulously assessing the student interface, workflow, and underlying logic within the \"RNP Studio Manager\" application. My focus is on identifying any missing information or potential bugs that might hinder the user experience. I'm taking a very structured approach, using my expertise in UI/UX to find any pain points.\n\n\n**Examining Interface Details**\n\nI'm now diving into the finer points of the student interface. I've pinpointed several areas where crucial information seems absent. Specifically, I'm concerned about the lack of a personal history view, a centralized notification system, explicit deliverable deadlines, and easily accessible constraint details within the dashboard. My goal is to enhance user clarity and reduce confusion in the RNP Studio Manager application.\n\n\n**Uncovering Workflow Concerns**\n\nI'm now zeroing in on workflow and logic concerns. I'm focusing on these elements: notification systems, potential peer review abuse (e.g., repeated reviews), Simulation mode security, financial transparency (budget shortfalls), and the opacity around individual score changes. I'm checking if the app delivers expected alerts or if it simply lacks critical details to the end-users. My aim is to identify and address ambiguities that could impact usability.\n\n\n**Reviewing Individual Feedback**\n\nI'm now focusing on the need for a private individual log for students to consult. My analysis revealed gaps in the student UI, including a lack of pedagogical feedback on individual score evolution, and real-time previews of \"Next expected pay.\" I'm also looking into the absence of \"Remaining Time\" and \"Hard Deadline\" on missions within the student view, even though this data is visible in the admin schedule.\n\n\n",
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1767785381,
      "nanos": 533000000
    },
    "doneTimestamp": {
      "seconds": 1767785391,
      "nanos": 832000000
    }
  },
  {
    "id": 33,
    "author": "model",
    "payload": {
      "type": "text",
      "text": "D'après l'analyse du code actuel, l'application est très robuste, mais il reste quelques **zones d'ombre informationnelles** et des **angles morts logiques** qui pourraient frustrer les étudiants ou compliquer ta gestion.\n\nVoici un diagnostic précis :\n\n### 1. Informations manquantes dans l'UI Étudiant\n*   **Historique Individuel vs Agence :** L'étudiant a un `eventLog` pour son agence (mouvements de VE, crises), mais il n'a pas de vue sur son **historique personnel** (pourquoi mon score a baissé ? qui m'a versé un bonus ?). Il voit son score actuel, mais pas la \"traçabilité\" de ses points.\n*   **Dates de Rendu (Deadlines) :** Bien que tu gères un calendrier côté Admin, la vue \"Missions\" des étudiants affiche les semaines (Semaine 1, 2...) mais n'affiche pas explicitement la **date limite réelle** (ex: \"À rendre avant mardi 23:59\"). Ils doivent naviguer dans le Wiki ou te demander.\n*   **Visibilité des Contraintes :** Les contraintes de projet (Espace, Style, Client) sont stockées dans l'objet `Agency`, mais elles ne sont pas affichées de manière permanente sur le Dashboard étudiant. Pour une agence \"Cyberpunk / Hall de gare\", l'info est un peu \"cachée\" dans les tréfonds de la base.\n*   **Statut de la Paie :** En cas de faillite de l'agence, les salaires sont gelés. Actuellement, l'étudiant ne voit pas de message clair du type : *\"Alerte : Votre agence est insolvable, votre salaire n'a pas été versé cette semaine\"*.\n\n### 2. Workflow & Logiques à surveiller (Bugs potentiels)\n*   **Doubles Évaluations :** Rien dans le code n'empêche un étudiant de soumettre 50 évaluations par les pairs pour le même collègue en une heure. Il manque un verrou \"Une seule évaluation par semaine et par cible\".\n*   **Conflit de Simulation :** Quand tu es en \"Mode Simulation\" (Admin qui regarde une vue étudiant), le code passe la fonction `onUpdateAgency`. Si tu modifies un truc par erreur en simulant, cela impacte la vraie base de données. Il manque un \"ReadOnly\" strict pour le mode simulation.\n*   **Le Syndrome du \"Chômeur Fantôme\" :** Si un étudiant quitte une agence, il tombe dans `unassigned`. S'il postule ailleurs, la demande apparaît dans l'onglet Mercato de l'agence cible. Cependant, si l'agence ne va jamais dans cet onglet, la candidature peut expirer ou rester en attente indéfiniment sans que personne ne reçoive de **notification visuelle** sur le dashboard principal de l'agence.\n*   **L'ID de l'étudiant \"Connecté\" :** Dans `TeamView.tsx`, l'identité de l'utilisateur est basée sur `currentUser.uid`. Si tu n'as pas encore fait la liaison entre le compte Google et le profil (via AdminAccess), le `TeamView` risque de ne pas reconnaître l'utilisateur comme membre de l'équipe, bloquant ainsi le bouton \"Évaluer\".\n\n### 3. Suggestions d'améliorations UX\n*   **Compte à rebours :** Ajouter un timer avant la prochaine \"Actualisation du Marché\" (le moment où tu lances les scripts de finance) pour créer de la tension.\n*   **Notifications de Vote :** Un indicateur (pastille rouge) sur l'onglet Mercato quand un vote est requis. Actuellement, c'est aux étudiants de vérifier manuellement s'il y a une décision démocratique à prendre.\n\n**En résumé :** L'app est prête pour la V1, mais le point le plus critique est le **manque de traçabilité individuelle** du score pour l'étudiant (il va te demander 10 fois par jour \"pourquoi j'ai perdu 2 points ?\").",
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1767785391,
      "nanos": 832000000
    },
    "doneTimestamp": {
      "seconds": 1767785391,
      "nanos": 834000000
    }
  }
]