[
  {
    "id": 8,
    "author": "user",
    "payload": {
      "type": "text",
      "text": "j'aiùerais qyu'on pârle du 22-04\n\ncomment le glitch se déclenche \nou est-ce qu'il apparait ?\n\nNE CHANGES PAS LE CODE\nREPONDS JUSTE",
      "files": [],
      "fileUploads": [],
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1768862644,
      "nanos": 722000000
    }
  },
  {
    "id": 9,
    "author": "model",
    "payload": {
      "type": "thinking",
      "text": "**Investigating the Core Issue**\n\nI've begun dissecting the user's request, focusing on \"TheBackdoor\" topic. My primary questions revolve around the trigger mechanism of the identified glitch. I'm aiming to understand the specific conditions required for its activation, in the hopes of tracing back the origins.\n\n\n**Pinpointing the Trigger**\n\nI've identified the trigger condition for \"TheBackdoor\". It's time-based, available between 22h and 4h, or when the user is an admin. I'm focusing on the code in `StudentAgencyView.tsx`, looking specifically at the `isBackdoorAvailable` state and the button logic, and have synthesized the hour condition details. Now, I will trace this with the specific code snippets.\n\n\n**Detailing the Glitch's Manifestation**\n\nI'm now detailing the visual presentation of \"TheBackdoor.\" The code in `StudentAgencyView.tsx` (lines 150-157) reveals a near-invisible, pulsing green dot fixed to the bottom-right. It's only 2x2 pixels, with low opacity, making it extremely hard to spot. Clicking it is tied to the `isBackdoorAvailable` state, and reveals a backdoor mechanism.\n\n\n**Analyzing User Interactions**\n\nI'm now diving deeper into the user interaction. The cursor changes to an \"alias\" upon hover, which is a key visual clue. Clicking it activates a state change, `showBackdoor(true)`, which then renders the `<TheBackdoor />` component as a full-screen matrix. I have started drafting a response in French, explaining the time constraint, visual trigger, and the \"Admin\" exception for clarity and conciseness, as requested. I am now refining the draft response in French.\n\n\n**Clarifying the Activation Logic**\n\nI am clarifying the activation logic. The backdoor is always active for admins for testing purposes, which overrides the time condition. For the visual manifestation, I've confirmed a nearly invisible, pulsing green dot. It appears at the bottom-right, at a tiny 8px square, almost transparent, with the animation \"animate-ping\". The cursor changes to \"alias\" on hover, with a \"?\" tooltip. Clicking the dot triggers the full-screen matrix view. I am refining my draft in French, ensuring the tone is professional.\n\n\n",
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1768862644,
      "nanos": 722000000
    },
    "doneTimestamp": {
      "seconds": 1768862661,
      "nanos": 763000000
    }
  },
  {
    "id": 10,
    "author": "model",
    "payload": {
      "type": "text",
      "text": "Le \"22-04\" (appelé `TheBackdoor` dans le code) est une fonctionnalité cachée conçue pour les \"oiseaux de nuit\". Voici les conditions exactes définies dans le fichier `StudentAgencyView.tsx` :\n\n### 1. Comment le glitch se déclenche (Condition Temporelle)\nLe code vérifie l'heure locale du navigateur de l'utilisateur toutes les minutes. Le glitch s'active uniquement si :\n*   Il est **22h00** passé.\n*   Ou s'il est avant **04h00** du matin.\n\n*(Note : En mode \"Admin\" ou \"Simulation\", cette restriction est levée pour permettre les tests).*\n\n### 2. Où est-ce qu'il apparaît (Indice Visuel)\nSi l'heure correspond, un élément interactif quasi-invisible apparaît sur le **Tableau de Bord Étudiant** (`StudentAgencyView`) :\n\n*   **Position :** Tout en bas à droite de l'écran (fixé au coin de la fenêtre).\n*   **Apparence :** C'est un minuscule carré (environ 8x8 pixels).\n*   **Effet visuel :** Il contient un point **vert fluo** qui clignote lentement (`animate-ping`), mais avec une opacité très faible (20%). Il ressemble à un pixel mort ou un bug d'affichage.\n*   **Interaction :** Il est invisible tant qu'on ne le cherche pas. Si la souris passe dessus, le curseur change (devient une flèche de raccourci) et une infobulle affiche simplement \"**?**\".\n\nUn clic sur ce pixel déclenche l'ouverture de l'interface \"Matrix\" du marché noir.",
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1768862661,
      "nanos": 763000000
    },
    "doneTimestamp": {
      "seconds": 1768862661,
      "nanos": 833000000
    }
  },
  {
    "id": 11,
    "author": "user",
    "payload": {
      "type": "text",
      "text": "il n'est pas assez visible, meme si c'est un secret il devient un peu trop difficile à voir ave juste 8 x 8\net le clic ne fonctionne pas",
      "files": [],
      "fileUploads": [],
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1768862835,
      "nanos": 756000000
    }
  },
  {
    "id": 12,
    "author": "model",
    "payload": {
      "type": "thinking",
      "text": "**Focusing on Analysis**\n\nI'm currently analyzing the request to improve the \"Backdoor\" trigger in `StudentAgencyView.tsx`. My primary goal is to enhance its visibility and usability. I'm breaking down the objective to understand the specific elements that need adjustment, and I am focused on identifying areas for improvement in the user interface.\n\n\n**Improving the Trigger**\n\nNow, I'm focusing on the practical solutions to enhance the backdoor trigger. Increasing the clickable area is a priority; I'm considering 24x24 or 40x40 pixels for the hit zone while keeping the visual element small. I'll increase the opacity, or explore a pulsing effect, using \"matrix green\" or \"glitchy red/cyan\" to maintain the secret vibe. The goal is a functional, yet subtle, improvement.\n\n\n**Designing the UI Element**\n\nI'm now fully immersed in the design phase, playing with different concepts in my mental sandbox. I'm moving away from a bug icon, feeling it's too overt. I am leaning toward a \"glitch\" block - a slightly larger, neon green square that pulses. Refining this further, I envision it as a terminal cursor or a \"broken\" pixel block. The dimensions are 24px and low opacity until hovered over, which triggers a change in color and appearance.\n\n\n**Defining the Implementation**\n\nNow I'm creating a specific implementation plan, the specification update clarifies the parameters to use. I'll make the clickable area larger with padding, with a small neon green square inside, animated with a pulse effect, and at low opacity. On hover, the opacity will increase, and the cursor will change to `alias` or `pointer`. I'll focus on integrating this into `StudentAgencyView.tsx`, starting by locating the existing trigger.\n\n\n**Refining the Implementation**\n\nI'm now refining the implementation based on the code provided, creating specific steps. My focus is on increasing the hit target and improving the visual cues. I'm removing the width and height constraints on the button to enable the padding. I plan to enhance the inner graphic and add a hover state to make it obvious. I'll maintain the pulsing effect but might add a static center for consistent clickability.\n\n\n**Confirming the Design**\n\nI've just finalized the code and incorporated improvements based on the constraints. The `p-4` padding drastically increases the clickable area, and the visual elements are improved with neon green and a subtle shadow. The opacity increases on hover, maintaining the \"secret\" feel. I'm satisfied that this meets the design requirements. I've also re-confirmed the `z-[99]` for the z-index. I've composed a French response explaining these changes.\n\n\n**Revising Positioning Parameters**\n\nI'm now carefully reviewing the positioning parameters to ensure the trigger is always accessible. I've realized the previous `bottom-4` setting might be too close to the footer, especially on smaller screens. I'm increasing the z-index to ensure it stays visible, and increasing the vertical offset as a precaution. I'm focusing on \"bug in the matrix\" design aesthetic.\n\n\n**Finalizing Implementation Steps**\n\nI'm now fully immersed in the coding process, focusing on the refined design. I've confirmed that no new imports are required for this div-based glitch effect. I'm prioritizing the creation of a large, invisible wrapper for the button with `fixed bottom-6 right-6 z-[100] p-6`. The inner visual will be a `w-4 h-4 bg-green-500` pixel. On hover, the pixel will have an opacity of 100% and scale up, which should complete the design.\n\n\n",
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1768862835,
      "nanos": 756000000
    },
    "doneTimestamp": {
      "seconds": 1768862860,
      "nanos": 940000000
    }
  },
  {
    "id": 13,
    "author": "model",
    "payload": {
      "type": "text",
      "text": "C'est noté. Le problème venait de deux choses : la zone de clic (8x8 pixels) était effectivement trop petite pour être ciblée facilement, et la position pouvait entrer en conflit avec les marges du navigateur ou le footer sur mobile.\n\nVoici la modification pour le rendre plus accessible tout en gardant l'esprit \"Easter Egg / Glitch\" :\n\n1.  **Zone de clic élargie** : J'ai ajouté un padding invisible (`p-4`) autour de l'élément. Vous pouvez cliquer \"à côté\" du pixel, ça marchera quand même.\n2.  **Visibilité accrue** : J'ai remplacé le pixel mort par un \"bug du système\" (un carré vert fluo style Matrix) un peu plus gros (`w-3 h-3`), avec une ombre portée néon pour qu'il ressorte sur le fond.\n3.  **Feedback** : Au survol, il devient totalement opaque et grossit légèrement pour confirmer qu'il est interactif.\n4.  **Position** : Remonté légèrement (`bottom-8`) pour éviter tout conflit avec le footer ou les bords d'écran arrondis.\n\nVoici le changement :\n\n",
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1768862860,
      "nanos": 941000000
    },
    "doneTimestamp": {
      "seconds": 1768862860,
      "nanos": 992000000
    }
  },
  {
    "id": 14,
    "author": "model",
    "payload": {
      "type": "generationTable",
      "entries": [
        {
          "path": "components/StudentAgencyView.tsx",
          "generationType": 1,
          "isDone": true,
          "description": "Amélioration de la visibilité et de la zone de clic du trigger Backdoor",
          "diffs": [
            {
              "target": "",
              "replacement": "\nimport React, { useState, useEffect } from 'react';\nimport { Agency, BrandColor, Student, GameEvent, MercatoRequest, ChallengeRequest } from '../types';\nimport { Target, Users, History, Wallet, TrendingUp, HelpCircle, Briefcase, Settings, Image as ImageIcon, Shield, Eye, Crown, BookOpen, Send, Repeat, ArrowUpRight, Building2, Zap, AlertTriangle, PartyPopper, Gavel, Landmark, Landmark as Bank, Check, X, Info, Rocket, Upload, Bug } from 'lucide-react';\nimport { MarketOverview } from './student/MarketOverview';\nimport { MissionsView } from './student/MissionsView';\nimport { TeamView } from './student/TeamView';\n// HistoryView removed from direct import as it is now inside MarketOverview\nimport { MercatoView } from './student/MercatoView';\nimport { WikiView } from './student/WikiView';\nimport { FAQView } from './student/FAQView';\nimport { TheBackdoor } from './student/TheBackdoor'; // IMPORT\nimport { Modal } from './Modal';\nimport { GAME_RULES, BADGE_DEFINITIONS } from '../constants';\nimport { ref, uploadBytes, getDownloadURL, storage } from '../services/firebase';\nimport { useUI } from '../contexts/UIContext';\nimport { useAuth } from '../contexts/AuthContext';\nimport { useGame } from '../contexts/GameContext';\n\ninterface StudentViewProps {\n  agency: Agency;\n  allAgencies: Agency[];\n  onUpdateAgency: (agency: Agency) => void;\n}\n\ntype TabType = 'MARKET' | 'MISSIONS' | 'TEAM' | 'RECRUITMENT' | 'RESOURCES' | 'HELP';\n\nconst COLOR_THEMES: Record<BrandColor, { bg: string, text: string }> = {\n    indigo: { bg: 'bg-indigo-600', text: 'text-indigo-600' },\n    emerald: { bg: 'bg-emerald-600', text: 'text-emerald-600' },\n    rose: { bg: 'bg-rose-600', text: 'text-rose-600' },\n    amber: { bg: 'bg-amber-500', text: 'text-amber-500' },\n    cyan: { bg: 'bg-cyan-500', text: 'text-cyan-500' },\n    slate: { bg: 'bg-slate-600', text: 'text-slate-600' },\n};\n\n// LIMITE IMAGES : 2 Mo\nconst MAX_IMAGE_SIZE = 2 * 1024 * 1024;\n\nexport const StudentAgencyView: React.FC<StudentViewProps> = ({ agency, allAgencies, onUpdateAgency }) => {\n  const { toast } = useUI();\n  const { currentUser, userData } = useAuth();\n  const { transferFunds, injectCapital, requestScorePurchase, getCurrentGameWeek, updateAgenciesList, submitMercatoVote, submitChallengeVote } = useGame();\n  \n  const [activeTab, setActiveTab] = useState<TabType>('MARKET');\n  const [showVERules, setShowVERules] = useState(false);\n  const [showSettings, setShowSettings] = useState(false);\n  \n  const [unlockModal, setUnlockModal] = useState<{title: string, message: string, icon: any, confirmText: string} | null>(null);\n  const [notificationEvent, setNotificationEvent] = useState<GameEvent | null>(null);\n\n  // BACKDOOR STATE\n  const [showBackdoor, setShowBackdoor] = useState(false);\n  const [isBackdoorAvailable, setIsBackdoorAvailable] = useState(false);\n\n  const brandColor = agency.branding?.color || 'indigo';\n  const theme = COLOR_THEMES[brandColor];\n  const leaderboard = [...allAgencies].filter(a => a.id !== 'unassigned').sort((a, b) => b.ve_current - a.ve_current);\n  const myRank = leaderboard.findIndex(a => a.id === agency.id) + 1;\n  const rawSalary = agency.members.reduce((acc, member) => acc + (member.individualScore * GAME_RULES.SALARY_MULTIPLIER), 0);\n  const weeklyCharges = rawSalary * (1 + (agency.weeklyTax || 0)) + GAME_RULES.AGENCY_RENT;\n  const veRevenue = agency.ve_current * GAME_RULES.REVENUE_VE_MULTIPLIER;\n  const weeklyRevenue = GAME_RULES.REVENUE_BASE + veRevenue + (agency.weeklyRevenueModifier || 0);\n  const netWeekly = weeklyRevenue - weeklyCharges;\n  const myMemberProfile = agency.members.find(m => m.id === currentUser?.uid);\n\n  // TIME CHECK FOR BACKDOOR\n  useEffect(() => {\n      const checkTime = () => {\n          const hour = new Date().getHours();\n          // Available between 22h and 04h OR IF ADMIN (Simulation Mode)\n          const isOpen = hour >= 22 || hour < 4 || userData?.role === 'admin';\n          setIsBackdoorAvailable(isOpen);\n      };\n      checkTime();\n      const timer = setInterval(checkTime, 60000); // Check every minute\n      return () => clearInterval(timer);\n  }, [userData]);\n\n  useEffect(() => {\n      const currentWeek = getCurrentGameWeek();\n      if (currentWeek >= GAME_RULES.UNLOCK_WEEK_BLACK_OPS) {\n          const hasSeenBlackOps = localStorage.getItem(`seen_unlock_blackops_${currentUser?.uid}`);\n          if (!hasSeenBlackOps) {\n              setUnlockModal({\n                  title: \"Intelligence Économique Activée\",\n                  message: \"Le marché se durcit. Vous avez désormais accès aux outils de veille stratégique.\\n\\nNouveauté : Audits concurrentiels et achat d'informations disponibles dans l'onglet 'Marché'.\",\n                  icon: <Eye size={32} className=\"text-yellow-500\"/>,\n                  confirmText: \"Compris, je reste vigilant\"\n              });\n              localStorage.setItem(`seen_unlock_blackops_${currentUser?.uid}`, 'true');\n              return; \n          }\n      }\n  }, [getCurrentGameWeek, currentUser]);\n\n  useEffect(() => {\n      if (agency.eventLog.length === 0) return;\n      const latestEvent = agency.eventLog[agency.eventLog.length - 1];\n      const NOTIFY_TYPES = ['CRISIS', 'VE_DELTA'];\n      if (NOTIFY_TYPES.includes(latestEvent.type)) {\n          const seenKey = `seen_event_${currentUser?.uid}_${latestEvent.id}`;\n          const hasSeen = localStorage.getItem(seenKey);\n          if (!hasSeen) setNotificationEvent(latestEvent);\n      }\n  }, [agency.eventLog, currentUser]);\n\n  const closeNotification = () => {\n      if (notificationEvent) {\n          localStorage.setItem(`seen_event_${currentUser?.uid}_${notificationEvent.id}`, 'true');\n          setNotificationEvent(null);\n      }\n  };\n\n  const handleColorChange = (color: BrandColor) => {\n      onUpdateAgency({ ...agency, branding: { ...agency.branding, color } });\n  };\n\n  const handleBannerUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {\n      if (e.target.files && e.target.files[0]) {\n          const file = e.target.files[0];\n          if (file.size > MAX_IMAGE_SIZE) {\n              toast('error', `Image trop lourde (${(file.size/1024/1024).toFixed(1)} Mo). Max 2 Mo.`);\n              return;\n          }\n          try {\n              const storageRef = ref(storage, `banners/${agency.id}_${Date.now()}`);\n              await uploadBytes(storageRef, file);\n              const url = await getDownloadURL(storageRef);\n              onUpdateAgency({ ...agency, branding: { ...agency.branding, bannerUrl: url } });\n              toast('success', 'Bannière mise à jour');\n          } catch (error) { toast('error', \"Erreur d'upload\"); }\n      }\n  };\n\n  const handleLogoUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {\n    if (e.target.files && e.target.files[0]) {\n        const file = e.target.files[0];\n        if (file.size > MAX_IMAGE_SIZE) {\n            toast('error', `Image trop lourde (${(file.size/1024/1024).toFixed(1)} Mo). Max 2 Mo.`);\n            return;\n        }\n        try {\n            const storageRef = ref(storage, `logos/${agency.id}_${Date.now()}`);\n            await uploadBytes(storageRef, file);\n            const url = await getDownloadURL(storageRef);\n            onUpdateAgency({ ...agency, logoUrl: url });\n            toast('success', 'Logo mis à jour');\n        } catch (error) { toast('error', \"Erreur d'upload du logo\"); }\n    }\n  };\n\n  if (showBackdoor && myMemberProfile) {\n      return <TheBackdoor agency={agency} allAgencies={allAgencies} currentUser={myMemberProfile} onClose={() => setShowBackdoor(false)} />;\n  }\n\n  return (\n    <div className=\"flex flex-col min-h-[calc(100vh-6rem)] font-sans relative\">\n        \n        {/* BACKDOOR TRIGGER (UPDATED FOR BETTER VISIBILITY & CLICKABILITY) */}\n        {isBackdoorAvailable && (\n            <button \n                onClick={() => setShowBackdoor(true)}\n                className=\"fixed bottom-8 right-6 z-[100] p-4 group cursor-alias transition-all hover:scale-110\"\n                title=\"Faille Système Détectée\"\n            >\n                <div className=\"relative\">\n                    {/* Ping Effect Larger */}\n                    <div className=\"absolute inset-0 bg-[#00ff41] rounded-sm animate-ping opacity-30 group-hover:opacity-80 duration-500\"></div>\n                    {/* Visual Core - Slightly bigger and brighter */}\n                    <div className=\"w-3 h-3 bg-[#00ff41] rounded-sm shadow-[0_0_15px_#00ff41] opacity-50 group-hover:opacity-100 transition-all duration-300 border border-white/20\"></div>\n                </div>\n            </button>\n        )}\n\n        {/* HEADER */}\n        <div className=\"relative mb-8 rounded-b-3xl md:rounded-3xl overflow-hidden bg-slate-100 min-h-[200px] md:min-h-[240px] shadow-md group\">\n            {agency.branding?.bannerUrl ? (\n                <img src={agency.branding.bannerUrl} className=\"absolute inset-0 w-full h-full object-cover\" alt=\"Banner\" />\n            ) : (\n                <div className={`absolute inset-0 opacity-10 ${theme.bg}`} style={{backgroundImage: 'radial-gradient(circle, #000 1px, transparent 1px)', backgroundSize: '20px 20px'}}></div>\n            )}\n            <div className=\"absolute inset-0 bg-gradient-to-t from-slate-900/90 via-slate-900/40 to-transparent\"></div>\n            {agency.id !== 'unassigned' && (\n                <button onClick={() => setShowSettings(true)} className=\"absolute top-4 right-4 p-2 bg-black/30 backdrop-blur-md rounded-full text-white hover:bg-black/50 transition-all opacity-0 group-hover:opacity-100 border border-white/10 z-20\">\n                    <Settings size={20}/>\n                </button>\n            )}\n            <div className=\"absolute bottom-0 left-0 right-0 p-6 flex flex-col xl:flex-row justify-between items-end xl:items-end gap-6 text-white\">\n                <div className=\"w-full xl:w-auto flex gap-4 items-end\">\n                    {/* AGENCY LOGO */}\n                    {agency.logoUrl && (\n                        <div className=\"w-20 h-20 md:w-24 md:h-24 rounded-2xl bg-white p-1 shadow-2xl shrink-0 animate-in zoom-in duration-300\">\n                            <img src={agency.logoUrl} className=\"w-full h-full object-contain rounded-xl\" alt=\"Logo\" />\n                        </div>\n                    )}\n                    <div className=\"flex-1\">\n                        <div className=\"flex items-center gap-3 mb-1\">\n                            {agency.id !== 'unassigned' && <span className=\"bg-white/20 backdrop-blur border border-white/10 px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider\">Rang #{myRank}</span>}\n                            <span className=\"text-slate-300 italic text-sm truncate\">\"{agency.tagline}\"</span>\n                        </div>\n                        <h2 className=\"text-4xl md:text-5xl font-display font-bold tracking-tight drop-shadow-lg leading-none mb-3\">{agency.name}</h2>\n                        <div className=\"flex items-center gap-1\">\n                            {agency.badges && agency.badges.map(b => (\n                                <div key={b.id} title={b.label} className=\"w-6 h-6 rounded-full bg-yellow-400 text-yellow-900 flex items-center justify-center shadow-lg border border-yellow-200\"><Shield size={12}/></div>\n                            ))}\n                        </div>\n                    </div>\n                </div>\n\n                {agency.id !== 'unassigned' && (\n                <div className=\"flex flex-col md:flex-row gap-4 w-full xl:w-auto bg-black/40 backdrop-blur-md p-4 rounded-2xl border border-white/10\">\n                    {myMemberProfile && (\n                        <div className=\"flex-1 md:text-right md:border-r border-white/20 md:pr-4\">\n                            <span className=\"text-[10px] font-bold text-yellow-300 uppercase tracking-widest block mb-1 flex items-center gap-1 md:justify-end\">\n                                <Wallet size={12}/> Mon Solde\n                            </span>\n                            <div className=\"text-lg font-bold text-white flex items-center md:justify-end gap-2\">\n                                <span className={`font-mono ${myMemberProfile.wallet && myMemberProfile.wallet < 0 ? 'text-red-400' : 'text-yellow-400'}`}>{myMemberProfile.wallet || 0} PiXi</span>\n                            </div>\n                        </div>\n                    )}\n                    \n                    <div className=\"flex-1 md:text-right md:border-r border-white/20 md:pr-4\">\n                        <span className=\"text-[10px] font-bold text-indigo-300 uppercase tracking-widest block mb-1 flex items-center gap-1 md:justify-end\">\n                            <Landmark size={12}/> Trésorerie Studio\n                        </span>\n                        <div className=\"text-lg font-bold text-white flex items-center md:justify-end gap-2\">\n                            <span className={`font-mono ${agency.budget_real < 0 ? 'text-red-400' : 'text-white'}`}>{agency.budget_real} PiXi</span>\n                        </div>\n                    </div>\n\n                    <div className=\"flex items-center justify-between md:justify-start gap-6 pl-2\">\n                        <div className=\"text-center\">\n                            <span className=\"text-[10px] font-bold text-slate-300 uppercase tracking-widest block mb-1\">Flux Net</span>\n                            <div className={`text-xl font-bold ${netWeekly >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>{netWeekly > 0 ? '+' : ''}{netWeekly.toFixed(0)}</div>\n                        </div>\n                        <div className=\"text-center\">\n                            <div \n                                onClick={() => setShowVERules(true)}\n                                className=\"text-[10px] font-bold text-slate-300 uppercase tracking-widest mb-1 flex items-center gap-1 justify-center cursor-pointer hover:text-white\"\n                            >\n                                VE <HelpCircle size={10}/>\n                            </div>\n                            <div className={`text-3xl font-display font-bold leading-none ${agency.ve_current >= 60 ? 'text-emerald-400' : 'text-amber-400'}`}>{agency.ve_current}</div>\n                        </div>\n                    </div>\n                </div>\n                )}\n            </div>\n        </div>\n\n        {/* VOTING BOOTHS (POPUP AUTOMATIQUE) */}\n        {myMemberProfile && (\n            <>\n                <VotingBooth \n                    agency={agency} \n                    currentUser={myMemberProfile} \n                    onVote={submitMercatoVote} \n                />\n                <ChallengeVotingBooth \n                    agency={agency}\n                    currentUser={myMemberProfile}\n                    onVote={submitChallengeVote}\n                />\n            </>\n        )}\n\n        {/* CONTENT */}\n        <div className=\"flex-1 mb-24 md:mb-8\">\n            {activeTab === 'MARKET' && agency.id !== 'unassigned' && <MarketOverview agency={agency} allAgencies={allAgencies} currentUser={myMemberProfile} />}\n            {activeTab === 'MISSIONS' && agency.id !== 'unassigned' && <MissionsView agency={agency} onUpdateAgency={onUpdateAgency} />}\n            {activeTab === 'TEAM' && agency.id !== 'unassigned' && <TeamView agency={agency} onUpdateAgency={onUpdateAgency} />}\n            {(activeTab === 'RECRUITMENT' || agency.id === 'unassigned') && (\n              <MercatoView \n                agency={agency} \n                allAgencies={allAgencies} \n                onUpdateAgency={onUpdateAgency} \n                onUpdateAgencies={updateAgenciesList} \n              />\n            )}\n            {activeTab === 'RESOURCES' && <WikiView agency={agency} />}\n            {activeTab === 'HELP' && <FAQView />}\n        </div>\n\n        {/* FOOTER NAV */}\n        <div className=\"fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-md border-t border-slate-200 p-2 z-50 md:relative md:bg-transparent md:border-t-0 md:p-0 md:mt-auto safe-area-bottom\">\n             <div className=\"max-w-7xl mx-auto flex md:justify-start gap-2 md:gap-4 overflow-x-auto no-scrollbar snap-x justify-between\">\n                {agency.id !== 'unassigned' && (\n                    <>\n                        <NavButton active={activeTab === 'MARKET'} onClick={() => setActiveTab('MARKET')} icon={<TrendingUp size={20} />} label=\"Tableau de Bord\" theme={theme} />\n                        <NavButton active={activeTab === 'MISSIONS'} onClick={() => setActiveTab('MISSIONS')} icon={<Target size={20} />} label=\"Missions\" theme={theme} />\n                        <NavButton active={activeTab === 'TEAM'} onClick={() => setActiveTab('TEAM')} icon={<Users size={20} />} label=\"Équipe\" theme={theme} />\n                    </>\n                )}\n                <NavButton active={activeTab === 'RESOURCES'} onClick={() => setActiveTab('RESOURCES')} icon={<BookOpen size={20} />} label=\"Wiki\" theme={theme} />\n                <NavButton active={activeTab === 'RECRUITMENT' || agency.id === 'unassigned'} onClick={() => setActiveTab('RECRUITMENT')} icon={<Briefcase size={20} />} label={agency.id === 'unassigned' ? \"Mon Statut\" : \"Recrutement\"} theme={theme} />\n                <NavButton active={activeTab === 'HELP'} onClick={() => setActiveTab('HELP')} icon={<HelpCircle size={20} />} label=\"Aide\" theme={theme} />\n             </div>\n        </div>\n\n        {/* MODALS */}\n        <Modal isOpen={showSettings} onClose={() => setShowSettings(false)} title=\"Identité Visuelle du Studio\">\n            <div className=\"space-y-6\">\n                <div>\n                    <label className=\"block text-sm font-bold text-slate-700 mb-2\">Logo de l'Agence (Carré)</label>\n                    <div className=\"flex items-center gap-4\">\n                        <div className=\"w-20 h-20 rounded-2xl bg-slate-100 border border-slate-200 overflow-hidden flex items-center justify-center shrink-0\">\n                            {agency.logoUrl ? <img src={agency.logoUrl} className=\"w-full h-full object-contain\" /> : <Landmark className=\"text-slate-300\" size={32}/>}\n                        </div>\n                        <label className=\"flex-1 flex flex-col items-center justify-center h-20 border-2 border-slate-300 border-dashed rounded-xl cursor-pointer bg-slate-50 hover:bg-slate-100 transition-colors\">\n                            <div className=\"flex flex-col items-center justify-center\">\n                                <Upload className=\"w-5 h-5 text-slate-400 mb-1\" />\n                                <p className=\"text-[10px] text-slate-500 font-bold uppercase\">Changer le Logo</p>\n                            </div>\n                            <input type=\"file\" className=\"hidden\" accept=\"image/*\" onChange={handleLogoUpload} />\n                        </label>\n                    </div>\n                </div>\n\n                <div>\n                    <label className=\"block text-sm font-bold text-slate-700 mb-2\">Couleur de Marque</label>\n                    <div className=\"flex gap-3\">\n                        {(['indigo', 'emerald', 'rose', 'amber', 'cyan'] as BrandColor[]).map(c => (\n                            <button key={c} onClick={() => handleColorChange(c)} className={`w-10 h-10 rounded-full border-2 ${COLOR_THEMES[c].bg} ${brandColor === c ? 'ring-4 ring-offset-2 ring-slate-200 border-white' : 'border-transparent opacity-60 hover:opacity-100'}`} />\n                        ))}\n                    </div>\n                </div>\n                <div>\n                    <label className=\"block text-sm font-bold text-slate-700 mb-2\">Bannière (Cover)</label>\n                    <label className=\"flex flex-col items-center justify-center w-full h-32 border-2 border-slate-300 border-dashed rounded-xl cursor-pointer bg-slate-50 hover:bg-slate-100 transition-colors\">\n                        <div className=\"flex flex-col items-center justify-center pt-5 pb-6\">\n                            <ImageIcon className=\"w-8 h-8 text-slate-400 mb-2\" />\n                            <p className=\"text-sm text-slate-500\">Cliquez pour changer la bannière</p>\n                        </div>\n                        <input type=\"file\" className=\"hidden\" accept=\"image/*\" onChange={handleBannerUpload} />\n                    </label>\n                </div>\n            </div>\n        </Modal>\n        \n        <Modal isOpen={showVERules} onClose={() => setShowVERules(false)} title=\"Comprendre la VE\">\n            <div className=\"space-y-6\">\n                <div className=\"bg-slate-50 p-4 rounded-2xl border border-slate-100\">\n                    <p className=\"text-sm text-slate-600 leading-relaxed mb-2\">\n                        La <strong>Valeur d'Entreprise (VE)</strong> est votre \"note de groupe\" dynamique (/100). \n                        <br/>Elle fluctue selon vos rendus, vos choix et les événements.\n                        <br/><br/>\n                        <strong>Attention :</strong> Si votre VE tombe à 0, c'est grave, mais la vraie mort est financière : <strong>-5000 PiXi = FAILLITE</strong>.\n                    </p>\n                </div>\n            </div>\n        </Modal>\n\n        {unlockModal && (\n            <Modal isOpen={!!unlockModal} onClose={() => setUnlockModal(null)} title={unlockModal.title}>\n                <div className=\"flex flex-col items-center text-center space-y-6\">\n                    <div className=\"p-6 rounded-full bg-slate-100 mb-2\">\n                        {unlockModal.icon}\n                    </div>\n                    <p className=\"text-slate-600 text-lg leading-relaxed whitespace-pre-line\">\n                        {unlockModal.message}\n                    </p>\n                    <button \n                        onClick={() => setUnlockModal(null)}\n                        className=\"w-full py-4 bg-slate-900 text-white font-bold rounded-xl hover:bg-indigo-600 transition-colors shadow-lg\"\n                    >\n                        {unlockModal.confirmText}\n                    </button>\n                </div>\n            </Modal>\n        )}\n\n        {notificationEvent && (\n            <Modal isOpen={!!notificationEvent} onClose={closeNotification} title={notificationEvent.type === 'CRISIS' ? \"ALERTE PRIORITAIRE\" : \"NOUVELLE IMPORTANTE\"}>\n                <div className=\"flex flex-col items-center text-center space-y-6\">\n                    <div className={`p-6 rounded-full mb-2 border-4 ${\n                        notificationEvent.type === 'CRISIS' || (notificationEvent.deltaVE || 0) < 0\n                        ? 'bg-red-50 border-red-100 text-red-600 animate-pulse'\n                        : 'bg-emerald-50 border-emerald-100 text-emerald-600'\n                    }`}>\n                        {notificationEvent.type === 'CRISIS' || (notificationEvent.deltaVE || 0) < 0\n                            ? <AlertTriangle size={48} strokeWidth={2.5}/>\n                            : (notificationEvent.deltaVE || 0) > 5 ? <PartyPopper size={48} strokeWidth={2.5}/> : <Zap size={48} strokeWidth={2.5}/>\n                        }\n                    </div>\n\n                    <div>\n                        <h3 className={`text-2xl font-black uppercase mb-2 ${\n                            notificationEvent.type === 'CRISIS' || (notificationEvent.deltaVE || 0) < 0 ? 'text-red-600' : 'text-emerald-600'\n                        }`}>\n                            {notificationEvent.label}\n                        </h3>\n                        <p className=\"text-slate-600 text-lg leading-relaxed font-medium\">\n                            {notificationEvent.description}\n                        </p>\n                    </div>\n\n                    <button \n                        onClick={closeNotification}\n                        className={`w-full py-4 text-white font-bold rounded-xl shadow-lg transition-transform active:scale-95 ${\n                            notificationEvent.type === 'CRISIS' || (notificationEvent.deltaVE || 0) < 0\n                            ? 'bg-red-600 hover:bg-red-700 shadow-red-200'\n                            : 'bg-emerald-600 hover:bg-emerald-700 shadow-emerald-200'\n                        }`}\n                    >\n                        {notificationEvent.type === 'CRISIS' ? \"J'AI PRIS CONNAISSANCE\" : \"GÉNIAL !\"}\n                    </button>\n                </div>\n            </Modal>\n        )}\n    </div>\n  );\n};\n\n// --- VOTING BOOTHS & COMPONENTS ---\nconst VotingBooth: React.FC<{agency: Agency, currentUser: Student, onVote: any}> = ({agency, currentUser, onVote}) => {\n    const pendingVote = agency.mercatoRequests.find(req => {\n        if (req.status !== 'PENDING') return false;\n        if (req.votes && req.votes[currentUser.id]) return false;\n        if (req.type === 'FIRE' && req.studentId === currentUser.id) return false;\n        return true;\n    });\n\n    if (!pendingVote) return null;\n    const isHire = pendingVote.type === 'HIRE';\n\n    return (\n        <Modal isOpen={true} onClose={() => {}} title=\"Session de Vote en cours\">\n            <div className=\"space-y-6\">\n                <div className={`p-4 rounded-xl border-l-4 ${isHire ? 'bg-emerald-50 border-emerald-500 text-emerald-800' : 'bg-red-50 border-red-500 text-red-800'}`}>\n                    <h4 className=\"font-bold text-lg mb-1 flex items-center gap-2\">\n                        {isHire ? <Users size={20}/> : <Gavel size={20}/>}\n                        {isHire ? \"Proposition de Recrutement\" : \"Proposition de Départ\"}\n                    </h4>\n                    <p className=\"text-sm\">Votre avis est requis pour valider cette décision d'agence.</p>\n                </div>\n\n                <div className=\"bg-white border border-slate-200 rounded-xl p-4 shadow-sm\">\n                    <p className=\"text-xs font-bold text-slate-400 uppercase tracking-wider mb-1\">Candidat / Cible</p>\n                    <p className=\"text-xl font-bold text-slate-900\">{pendingVote.studentName}</p>\n                    \n                    <div className=\"mt-4\">\n                        <p className=\"text-xs font-bold text-slate-400 uppercase tracking-wider mb-1\">Motivation / Motif</p>\n                        <p className=\"text-sm italic text-slate-600 bg-slate-50 p-3 rounded-lg border border-slate-100\">\n                            \"{pendingVote.motivation || 'Aucun motif fourni.'}\"\n                        </p>\n                    </div>\n                </div>\n\n                <div className=\"grid grid-cols-2 gap-4\">\n                    <button \n                        onClick={() => onVote(agency.id, pendingVote.id, currentUser.id, 'REJECT')}\n                        className=\"py-4 bg-white border-2 border-slate-200 text-slate-600 hover:border-red-200 hover:text-red-600 hover:bg-red-50 font-bold rounded-xl transition-all flex flex-col items-center gap-1\"\n                    >\n                        <X size={24}/>\n                        NON (Refuser)\n                    </button>\n                    <button \n                        onClick={() => onVote(agency.id, pendingVote.id, currentUser.id, 'APPROVE')}\n                        className=\"py-4 bg-slate-900 text-white hover:bg-emerald-600 font-bold rounded-xl transition-all flex flex-col items-center gap-1 shadow-lg\"\n                    >\n                        <Check size={24}/>\n                        OUI (Accepter)\n                    </button>\n                </div>\n            </div>\n        </Modal>\n    );\n};\n\nconst ChallengeVotingBooth: React.FC<{agency: Agency, currentUser: Student, onVote: any}> = ({agency, currentUser, onVote}) => {\n    const pendingChallenge = agency.challenges?.find(c => c.status === 'PENDING_VOTE' && (!c.votes || !c.votes[currentUser.id]));\n    if (!pendingChallenge) return null;\n\n    return (\n        <Modal isOpen={true} onClose={() => {}} title=\"⚠️ DÉFI SPÉCIAL DÉTECTÉ\">\n            <div className=\"space-y-6\">\n                <div className=\"bg-gradient-to-br from-indigo-900 to-slate-900 text-white p-6 rounded-2xl shadow-xl relative overflow-hidden\">\n                    <div className=\"relative z-10\">\n                        <div className=\"flex items-center gap-2 mb-2\">\n                            <Rocket className=\"text-yellow-400 animate-pulse\"/>\n                            <span className=\"text-xs font-bold uppercase tracking-widest text-indigo-300\">Opportunité IA</span>\n                        </div>\n                        <h3 className=\"text-2xl font-black mb-4 leading-tight\">{pendingChallenge.title}</h3>\n                        <p className=\"text-sm text-indigo-100 leading-relaxed bg-white/10 p-4 rounded-xl border border-white/10\">\n                            {pendingChallenge.description}\n                        </p>\n                    </div>\n                </div>\n\n                <div className=\"text-center\">\n                    <p className=\"text-sm text-slate-600 mb-4\">\n                        Si l'équipe accepte ce défi (Majorité &gt; {GAME_RULES.VOTE_THRESHOLD_CHALLENGE * 100}%), une <strong>mission spéciale</strong> sera ajoutée.\n                    </p>\n                    <div className=\"grid grid-cols-2 gap-4\">\n                        <button \n                            onClick={() => onVote(agency.id, pendingChallenge.id, currentUser.id, 'REJECT')}\n                            className=\"py-4 bg-white border-2 border-slate-200 text-slate-500 hover:text-red-500 hover:border-red-200 font-bold rounded-xl transition-all\"\n                        >\n                            Refuser\n                        </button>\n                        <button \n                            onClick={() => onVote(agency.id, pendingChallenge.id, currentUser.id, 'APPROVE')}\n                            className=\"py-4 bg-emerald-600 text-white hover:bg-emerald-500 font-bold rounded-xl transition-all shadow-lg shadow-emerald-200\"\n                        >\n                            Accepter le Défi\n                        </button>\n                    </div>\n                </div>\n            </div>\n        </Modal>\n    );\n};\n\nconst NavButton: React.FC<any> = ({ active, onClick, icon, label, theme }) => (\n    <button onClick={onClick} className={`snap-start flex flex-col md:flex-row items-center md:gap-3 p-2 md:p-4 rounded-xl transition-all min-w-[70px] md:min-w-[150px] justify-center md:justify-start ${active ? `${theme.bg} text-white transform scale-105 shadow-md` : 'hover:bg-slate-50 text-slate-400 hover:text-slate-600'}`}>\n        <div className={`p-1.5 rounded-full ${active ? 'bg-white/20' : ''}`}>{React.cloneElement(icon, { className: active ? 'text-white' : '' })}</div>\n        <span className={`text-[10px] md:text-base font-bold`}>{label}</span>\n    </button>\n);\n"
            }
          ]
        }
      ]
    },
    "createdTimestamp": {
      "seconds": 1768862862,
      "nanos": 686000000
    },
    "doneTimestamp": {
      "seconds": 1768862908,
      "nanos": 900000000
    }
  },
  {
    "id": 16,
    "author": "user",
    "payload": {
      "type": "text",
      "text": "scinde le StudentAgencyView en plusieurs fichiers pour assurer la stabilite et faciliter la maintenance",
      "files": [],
      "fileUploads": [],
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1768863064,
      "nanos": 988000000
    }
  },
  {
    "id": 17,
    "author": "model",
    "payload": {
      "type": "thinking",
      "text": "**Defining the Goal**\n\nI'm currently focused on the overarching goal: to break down `StudentAgencyView.tsx`. The primary drivers behind this are improved stability and easier maintenance in the long run. I'm carefully considering the constraints before I start.\n\n\n**Revising Component Boundaries**\n\nI'm now carefully analyzing the existing `StudentAgencyView.tsx`, aiming for a complete overhaul. My primary focus is establishing clear boundaries for each component. The current state is a sprawling monolith handling layout, state, specific trigger logic, file uploads, sub-view rendering, and modal management. This directly violates the Single Responsibility Principle, and I'm developing a refactoring strategy centered around component splitting, focusing on isolating high-level state within the main container.\n\n\n**Refining Component Division**\n\nI'm now diving into the component breakdown, creating new files as planned. I've separated the header visuals into `AgencyHeader.tsx` and navigation into `AgencyNav.tsx`. The specific logic for the glitch button is now isolated in `BackdoorTrigger.tsx`. I'm starting to work on the `VotingBooths.tsx` component to group voting logic. I am planning on moving the settings and the image uploading / color picking logic into `AgencySettingsModal.tsx` as its own separate module as well. Rendering modal logic will be extracted.\n\n\n**Implementing the UI**\n\nI'm now focusing on implementation, refining the code after the component split. I'm updating imports and passing props down the component tree, ensuring each receives necessary data and handlers. I've moved the banner/logo upload logic, as well as the color change and backdoor trigger effects to their new components. The goal is to retain the original UI's exact structure and classNames. I am focusing on what properties each component needs, as I get ready to draft the code.\n\n\n**Isolating Component Logic**\n\nI'm now implementing the backdoor button and access checks within the `BackdoorTrigger` component, rather than in the parent view. This should streamline the main view significantly. I'm focusing on ensuring imports are correct and placing the new components in the appropriate `components/student/` directory. The view itself will be much cleaner.\n\n\n**Analyzing Remaining Code**\n\nI'm now carefully reviewing `StudentAgencyView.tsx` against the constraints. I'm focusing on ensuring smaller files increase stability and maintainability. My approach involves migrating code and adjusting import statements. I'm keeping the global view context, including the `Notification` logic, along with the state related to tabs, settings, and backdoor access. I'm planning out the file structure, aiming for clear separation using `layout` and `features` subdirectories.\n\n\n**Reorganizing the Layout**\n\nI'm now restructuring the remaining code, aiming for a cleaner directory structure. I'm focusing on organizing the view components into `layout` and `features` subdirectories. This will enhance code organization and facilitate future maintenance. I'm carefully analyzing existing dependencies and making adjustments to import paths. The ultimate goal is a more modular and understandable codebase.\n\n\n",
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1768863064,
      "nanos": 988000000
    },
    "doneTimestamp": {
      "seconds": 1768863087,
      "nanos": 285000000
    }
  },
  {
    "id": 18,
    "author": "model",
    "payload": {
      "type": "text",
      "text": "C'est une excellente initiative. Scinder ce fichier massif (Monolith) va grandement améliorer la lisibilité, réduire les risques de régressions lors des modifications futures et isoler la logique métier complexe (comme le trigger du Backdoor ou l'upload d'images).\n\nVoici la nouvelle architecture proposée, sans **aucune modification visuelle** :\n\n1.  **`AgencyHeader`** : Gère l'affichage de la bannière, du logo, des stats financières et de la VE.\n2.  **`AgencyNav`** : Gère la barre de navigation (onglets).\n3.  **`BackdoorTrigger`** : Isole la logique temporelle (22h-04h) et le bouton \"Glitch\".\n4.  **`VotingSystem`** : Regroupe les popups de vote (Mercato & Challenge).\n5.  **`AgencySettingsModal`** : Gère l'upload de fichiers et le changement de couleur.\n6.  **`StudentAgencyView`** : Reste l'orchestrateur principal mais devient beaucoup plus léger.\n\nVoici les fichiers :\n\n",
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1768863087,
      "nanos": 285000000
    },
    "doneTimestamp": {
      "seconds": 1768863087,
      "nanos": 285000000
    }
  },
  {
    "id": 19,
    "author": "model",
    "payload": {
      "type": "generationTable",
      "entries": [
        {
          "path": "components/student/layout/AgencyHeader.tsx",
          "generationType": 1,
          "isDone": true,
          "description": "Nouveau composant : En-tête de l'agence (Banner, Logo, Stats)",
          "diffs": [
            {
              "target": "",
              "replacement": "\nimport React from 'react';\nimport { Agency, BrandColor, Student } from '../../../types';\nimport { Settings, Wallet, Landmark, HelpCircle, Shield } from 'lucide-react';\nimport { GAME_RULES } from '../../../constants';\n\ninterface AgencyHeaderProps {\n    agency: Agency;\n    myRank: number;\n    theme: { bg: string, text: string };\n    myMemberProfile?: Student;\n    onOpenSettings: () => void;\n    onOpenVERules: () => void;\n}\n\nexport const AgencyHeader: React.FC<AgencyHeaderProps> = ({ \n    agency, \n    myRank, \n    theme, \n    myMemberProfile, \n    onOpenSettings, \n    onOpenVERules \n}) => {\n    \n    // Calculs financiers pour l'affichage\n    const rawSalary = agency.members.reduce((acc, member) => acc + (member.individualScore * GAME_RULES.SALARY_MULTIPLIER), 0);\n    const weeklyCharges = rawSalary * (1 + (agency.weeklyTax || 0)) + GAME_RULES.AGENCY_RENT;\n    const veRevenue = agency.ve_current * GAME_RULES.REVENUE_VE_MULTIPLIER;\n    const weeklyRevenue = GAME_RULES.REVENUE_BASE + veRevenue + (agency.weeklyRevenueModifier || 0);\n    const netWeekly = weeklyRevenue - weeklyCharges;\n\n    return (\n        <div className=\"relative mb-8 rounded-b-3xl md:rounded-3xl overflow-hidden bg-slate-100 min-h-[200px] md:min-h-[240px] shadow-md group\">\n            {agency.branding?.bannerUrl ? (\n                <img src={agency.branding.bannerUrl} className=\"absolute inset-0 w-full h-full object-cover\" alt=\"Banner\" />\n            ) : (\n                <div className={`absolute inset-0 opacity-10 ${theme.bg}`} style={{backgroundImage: 'radial-gradient(circle, #000 1px, transparent 1px)', backgroundSize: '20px 20px'}}></div>\n            )}\n            <div className=\"absolute inset-0 bg-gradient-to-t from-slate-900/90 via-slate-900/40 to-transparent\"></div>\n            {agency.id !== 'unassigned' && (\n                <button onClick={onOpenSettings} className=\"absolute top-4 right-4 p-2 bg-black/30 backdrop-blur-md rounded-full text-white hover:bg-black/50 transition-all opacity-0 group-hover:opacity-100 border border-white/10 z-20\">\n                    <Settings size={20}/>\n                </button>\n            )}\n            <div className=\"absolute bottom-0 left-0 right-0 p-6 flex flex-col xl:flex-row justify-between items-end xl:items-end gap-6 text-white\">\n                <div className=\"w-full xl:w-auto flex gap-4 items-end\">\n                    {/* AGENCY LOGO */}\n                    {agency.logoUrl && (\n                        <div className=\"w-20 h-20 md:w-24 md:h-24 rounded-2xl bg-white p-1 shadow-2xl shrink-0 animate-in zoom-in duration-300\">\n                            <img src={agency.logoUrl} className=\"w-full h-full object-contain rounded-xl\" alt=\"Logo\" />\n                        </div>\n                    )}\n                    <div className=\"flex-1\">\n                        <div className=\"flex items-center gap-3 mb-1\">\n                            {agency.id !== 'unassigned' && <span className=\"bg-white/20 backdrop-blur border border-white/10 px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider\">Rang #{myRank}</span>}\n                            <span className=\"text-slate-300 italic text-sm truncate\">\"{agency.tagline}\"</span>\n                        </div>\n                        <h2 className=\"text-4xl md:text-5xl font-display font-bold tracking-tight drop-shadow-lg leading-none mb-3\">{agency.name}</h2>\n                        <div className=\"flex items-center gap-1\">\n                            {agency.badges && agency.badges.map(b => (\n                                <div key={b.id} title={b.label} className=\"w-6 h-6 rounded-full bg-yellow-400 text-yellow-900 flex items-center justify-center shadow-lg border border-yellow-200\"><Shield size={12}/></div>\n                            ))}\n                        </div>\n                    </div>\n                </div>\n\n                {agency.id !== 'unassigned' && (\n                <div className=\"flex flex-col md:flex-row gap-4 w-full xl:w-auto bg-black/40 backdrop-blur-md p-4 rounded-2xl border border-white/10\">\n                    {myMemberProfile && (\n                        <div className=\"flex-1 md:text-right md:border-r border-white/20 md:pr-4\">\n                            <span className=\"text-[10px] font-bold text-yellow-300 uppercase tracking-widest block mb-1 flex items-center gap-1 md:justify-end\">\n                                <Wallet size={12}/> Mon Solde\n                            </span>\n                            <div className=\"text-lg font-bold text-white flex items-center md:justify-end gap-2\">\n                                <span className={`font-mono ${myMemberProfile.wallet && myMemberProfile.wallet < 0 ? 'text-red-400' : 'text-yellow-400'}`}>{myMemberProfile.wallet || 0} PiXi</span>\n                            </div>\n                        </div>\n                    )}\n                    \n                    <div className=\"flex-1 md:text-right md:border-r border-white/20 md:pr-4\">\n                        <span className=\"text-[10px] font-bold text-indigo-300 uppercase tracking-widest block mb-1 flex items-center gap-1 md:justify-end\">\n                            <Landmark size={12}/> Trésorerie Studio\n                        </span>\n                        <div className=\"text-lg font-bold text-white flex items-center md:justify-end gap-2\">\n                            <span className={`font-mono ${agency.budget_real < 0 ? 'text-red-400' : 'text-white'}`}>{agency.budget_real} PiXi</span>\n                        </div>\n                    </div>\n\n                    <div className=\"flex items-center justify-between md:justify-start gap-6 pl-2\">\n                        <div className=\"text-center\">\n                            <span className=\"text-[10px] font-bold text-slate-300 uppercase tracking-widest block mb-1\">Flux Net</span>\n                            <div className={`text-xl font-bold ${netWeekly >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>{netWeekly > 0 ? '+' : ''}{netWeekly.toFixed(0)}</div>\n                        </div>\n                        <div className=\"text-center\">\n                            <div \n                                onClick={onOpenVERules}\n                                className=\"text-[10px] font-bold text-slate-300 uppercase tracking-widest mb-1 flex items-center gap-1 justify-center cursor-pointer hover:text-white\"\n                            >\n                                VE <HelpCircle size={10}/>\n                            </div>\n                            <div className={`text-3xl font-display font-bold leading-none ${agency.ve_current >= 60 ? 'text-emerald-400' : 'text-amber-400'}`}>{agency.ve_current}</div>\n                        </div>\n                    </div>\n                </div>\n                )}\n            </div>\n        </div>\n    );\n};\n"
            }
          ]
        },
        {
          "path": "components/student/layout/AgencyNav.tsx",
          "generationType": 1,
          "isDone": true,
          "description": "Nouveau composant : Barre de navigation inférieure",
          "diffs": [
            {
              "target": "",
              "replacement": "\nimport React from 'react';\nimport { TrendingUp, Target, Users, BookOpen, Briefcase, HelpCircle } from 'lucide-react';\nimport { Agency } from '../../../types';\n\ntype TabType = 'MARKET' | 'MISSIONS' | 'TEAM' | 'RECRUITMENT' | 'RESOURCES' | 'HELP';\n\ninterface AgencyNavProps {\n    activeTab: TabType;\n    setActiveTab: (tab: TabType) => void;\n    agency: Agency;\n    theme: { bg: string, text: string };\n}\n\nexport const AgencyNav: React.FC<AgencyNavProps> = ({ activeTab, setActiveTab, agency, theme }) => {\n    return (\n        <div className=\"fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-md border-t border-slate-200 p-2 z-50 md:relative md:bg-transparent md:border-t-0 md:p-0 md:mt-auto safe-area-bottom\">\n             <div className=\"max-w-7xl mx-auto flex md:justify-start gap-2 md:gap-4 overflow-x-auto no-scrollbar snap-x justify-between\">\n                {agency.id !== 'unassigned' && (\n                    <>\n                        <NavButton active={activeTab === 'MARKET'} onClick={() => setActiveTab('MARKET')} icon={<TrendingUp size={20} />} label=\"Tableau de Bord\" theme={theme} />\n                        <NavButton active={activeTab === 'MISSIONS'} onClick={() => setActiveTab('MISSIONS')} icon={<Target size={20} />} label=\"Missions\" theme={theme} />\n                        <NavButton active={activeTab === 'TEAM'} onClick={() => setActiveTab('TEAM')} icon={<Users size={20} />} label=\"Équipe\" theme={theme} />\n                    </>\n                )}\n                <NavButton active={activeTab === 'RESOURCES'} onClick={() => setActiveTab('RESOURCES')} icon={<BookOpen size={20} />} label=\"Wiki\" theme={theme} />\n                <NavButton active={activeTab === 'RECRUITMENT' || agency.id === 'unassigned'} onClick={() => setActiveTab('RECRUITMENT')} icon={<Briefcase size={20} />} label={agency.id === 'unassigned' ? \"Mon Statut\" : \"Recrutement\"} theme={theme} />\n                <NavButton active={activeTab === 'HELP'} onClick={() => setActiveTab('HELP')} icon={<HelpCircle size={20} />} label=\"Aide\" theme={theme} />\n             </div>\n        </div>\n    );\n};\n\nconst NavButton: React.FC<any> = ({ active, onClick, icon, label, theme }) => (\n    <button onClick={onClick} className={`snap-start flex flex-col md:flex-row items-center md:gap-3 p-2 md:p-4 rounded-xl transition-all min-w-[70px] md:min-w-[150px] justify-center md:justify-start ${active ? `${theme.bg} text-white transform scale-105 shadow-md` : 'hover:bg-slate-50 text-slate-400 hover:text-slate-600'}`}>\n        <div className={`p-1.5 rounded-full ${active ? 'bg-white/20' : ''}`}>{React.cloneElement(icon, { className: active ? 'text-white' : '' })}</div>\n        <span className={`text-[10px] md:text-base font-bold`}>{label}</span>\n    </button>\n);\n"
            }
          ]
        },
        {
          "path": "components/student/features/BackdoorTrigger.tsx",
          "generationType": 1,
          "isDone": true,
          "description": "Nouveau composant : Logique et bouton du Glitch (Backdoor)",
          "diffs": [
            {
              "target": "",
              "replacement": "\nimport React, { useEffect, useState } from 'react';\nimport { useAuth } from '../../../contexts/AuthContext';\n\ninterface BackdoorTriggerProps {\n    onTrigger: () => void;\n}\n\nexport const BackdoorTrigger: React.FC<BackdoorTriggerProps> = ({ onTrigger }) => {\n    const { userData } = useAuth();\n    const [isBackdoorAvailable, setIsBackdoorAvailable] = useState(false);\n\n    // TIME CHECK FOR BACKDOOR\n    useEffect(() => {\n        const checkTime = () => {\n            const hour = new Date().getHours();\n            // Available between 22h and 04h OR IF ADMIN (Simulation Mode)\n            const isOpen = hour >= 22 || hour < 4 || userData?.role === 'admin';\n            setIsBackdoorAvailable(isOpen);\n        };\n        checkTime();\n        const timer = setInterval(checkTime, 60000); // Check every minute\n        return () => clearInterval(timer);\n    }, [userData]);\n\n    if (!isBackdoorAvailable) return null;\n\n    return (\n        <button \n            onClick={onTrigger}\n            className=\"fixed bottom-8 right-6 z-[100] p-4 group cursor-alias transition-all hover:scale-110\"\n            title=\"Faille Système Détectée\"\n        >\n            <div className=\"relative\">\n                {/* Ping Effect Larger */}\n                <div className=\"absolute inset-0 bg-[#00ff41] rounded-sm animate-ping opacity-30 group-hover:opacity-80 duration-500\"></div>\n                {/* Visual Core - Slightly bigger and brighter */}\n                <div className=\"w-3 h-3 bg-[#00ff41] rounded-sm shadow-[0_0_15px_#00ff41] opacity-50 group-hover:opacity-100 transition-all duration-300 border border-white/20\"></div>\n            </div>\n        </button>\n    );\n};\n"
            }
          ]
        },
        {
          "path": "components/student/features/VotingSystem.tsx",
          "generationType": 1,
          "isDone": true,
          "description": "Nouveau composant : Gestion des popups de votes (Mercato & Challenge)",
          "diffs": [
            {
              "target": "",
              "replacement": "\nimport React from 'react';\nimport { Agency, Student } from '../../../types';\nimport { Modal } from '../../Modal';\nimport { Users, Gavel, X, Check, Rocket } from 'lucide-react';\nimport { GAME_RULES } from '../../../constants';\n\ninterface VotingSystemProps {\n    agency: Agency;\n    currentUser: Student;\n    onVoteMercato: any;\n    onVoteChallenge: any;\n}\n\nexport const VotingSystem: React.FC<VotingSystemProps> = ({ agency, currentUser, onVoteMercato, onVoteChallenge }) => {\n    return (\n        <>\n            <VotingBooth \n                agency={agency} \n                currentUser={currentUser} \n                onVote={onVoteMercato} \n            />\n            <ChallengeVotingBooth \n                agency={agency}\n                currentUser={currentUser}\n                onVote={onVoteChallenge}\n            />\n        </>\n    );\n};\n\nconst VotingBooth: React.FC<{agency: Agency, currentUser: Student, onVote: any}> = ({agency, currentUser, onVote}) => {\n    const pendingVote = agency.mercatoRequests.find(req => {\n        if (req.status !== 'PENDING') return false;\n        if (req.votes && req.votes[currentUser.id]) return false;\n        if (req.type === 'FIRE' && req.studentId === currentUser.id) return false;\n        return true;\n    });\n\n    if (!pendingVote) return null;\n    const isHire = pendingVote.type === 'HIRE';\n\n    return (\n        <Modal isOpen={true} onClose={() => {}} title=\"Session de Vote en cours\">\n            <div className=\"space-y-6\">\n                <div className={`p-4 rounded-xl border-l-4 ${isHire ? 'bg-emerald-50 border-emerald-500 text-emerald-800' : 'bg-red-50 border-red-500 text-red-800'}`}>\n                    <h4 className=\"font-bold text-lg mb-1 flex items-center gap-2\">\n                        {isHire ? <Users size={20}/> : <Gavel size={20}/>}\n                        {isHire ? \"Proposition de Recrutement\" : \"Proposition de Départ\"}\n                    </h4>\n                    <p className=\"text-sm\">Votre avis est requis pour valider cette décision d'agence.</p>\n                </div>\n\n                <div className=\"bg-white border border-slate-200 rounded-xl p-4 shadow-sm\">\n                    <p className=\"text-xs font-bold text-slate-400 uppercase tracking-wider mb-1\">Candidat / Cible</p>\n                    <p className=\"text-xl font-bold text-slate-900\">{pendingVote.studentName}</p>\n                    \n                    <div className=\"mt-4\">\n                        <p className=\"text-xs font-bold text-slate-400 uppercase tracking-wider mb-1\">Motivation / Motif</p>\n                        <p className=\"text-sm italic text-slate-600 bg-slate-50 p-3 rounded-lg border border-slate-100\">\n                            \"{pendingVote.motivation || 'Aucun motif fourni.'}\"\n                        </p>\n                    </div>\n                </div>\n\n                <div className=\"grid grid-cols-2 gap-4\">\n                    <button \n                        onClick={() => onVote(agency.id, pendingVote.id, currentUser.id, 'REJECT')}\n                        className=\"py-4 bg-white border-2 border-slate-200 text-slate-600 hover:border-red-200 hover:text-red-600 hover:bg-red-50 font-bold rounded-xl transition-all flex flex-col items-center gap-1\"\n                    >\n                        <X size={24}/>\n                        NON (Refuser)\n                    </button>\n                    <button \n                        onClick={() => onVote(agency.id, pendingVote.id, currentUser.id, 'APPROVE')}\n                        className=\"py-4 bg-slate-900 text-white hover:bg-emerald-600 font-bold rounded-xl transition-all flex flex-col items-center gap-1 shadow-lg\"\n                    >\n                        <Check size={24}/>\n                        OUI (Accepter)\n                    </button>\n                </div>\n            </div>\n        </Modal>\n    );\n};\n\nconst ChallengeVotingBooth: React.FC<{agency: Agency, currentUser: Student, onVote: any}> = ({agency, currentUser, onVote}) => {\n    const pendingChallenge = agency.challenges?.find(c => c.status === 'PENDING_VOTE' && (!c.votes || !c.votes[currentUser.id]));\n    if (!pendingChallenge) return null;\n\n    return (\n        <Modal isOpen={true} onClose={() => {}} title=\"⚠️ DÉFI SPÉCIAL DÉTECTÉ\">\n            <div className=\"space-y-6\">\n                <div className=\"bg-gradient-to-br from-indigo-900 to-slate-900 text-white p-6 rounded-2xl shadow-xl relative overflow-hidden\">\n                    <div className=\"relative z-10\">\n                        <div className=\"flex items-center gap-2 mb-2\">\n                            <Rocket className=\"text-yellow-400 animate-pulse\"/>\n                            <span className=\"text-xs font-bold uppercase tracking-widest text-indigo-300\">Opportunité IA</span>\n                        </div>\n                        <h3 className=\"text-2xl font-black mb-4 leading-tight\">{pendingChallenge.title}</h3>\n                        <p className=\"text-sm text-indigo-100 leading-relaxed bg-white/10 p-4 rounded-xl border border-white/10\">\n                            {pendingChallenge.description}\n                        </p>\n                    </div>\n                </div>\n\n                <div className=\"text-center\">\n                    <p className=\"text-sm text-slate-600 mb-4\">\n                        Si l'équipe accepte ce défi (Majorité &gt; {GAME_RULES.VOTE_THRESHOLD_CHALLENGE * 100}%), une <strong>mission spéciale</strong> sera ajoutée.\n                    </p>\n                    <div className=\"grid grid-cols-2 gap-4\">\n                        <button \n                            onClick={() => onVote(agency.id, pendingChallenge.id, currentUser.id, 'REJECT')}\n                            className=\"py-4 bg-white border-2 border-slate-200 text-slate-500 hover:text-red-500 hover:border-red-200 font-bold rounded-xl transition-all\"\n                        >\n                            Refuser\n                        </button>\n                        <button \n                            onClick={() => onVote(agency.id, pendingChallenge.id, currentUser.id, 'APPROVE')}\n                            className=\"py-4 bg-emerald-600 text-white hover:bg-emerald-500 font-bold rounded-xl transition-all shadow-lg shadow-emerald-200\"\n                        >\n                            Accepter le Défi\n                        </button>\n                    </div>\n                </div>\n            </div>\n        </Modal>\n    );\n};\n"
            }
          ]
        },
        {
          "path": "components/student/modals/AgencySettingsModal.tsx",
          "generationType": 1,
          "isDone": true,
          "description": "Nouveau composant : Modal de paramètres (Logo, bannière, couleur)",
          "diffs": [
            {
              "target": "",
              "replacement": "\nimport React from 'react';\nimport { Modal } from '../../Modal';\nimport { BrandColor, Agency } from '../../../types';\nimport { Upload, Landmark, ImageIcon } from 'lucide-react';\nimport { ref, uploadBytes, getDownloadURL, storage } from '../../../services/firebase';\nimport { useUI } from '../../../contexts/UIContext';\n\ninterface AgencySettingsModalProps {\n    isOpen: boolean;\n    onClose: () => void;\n    agency: Agency;\n    onUpdateAgency: (a: Agency) => void;\n}\n\nconst COLOR_THEMES: Record<BrandColor, { bg: string, text: string }> = {\n    indigo: { bg: 'bg-indigo-600', text: 'text-indigo-600' },\n    emerald: { bg: 'bg-emerald-600', text: 'text-emerald-600' },\n    rose: { bg: 'bg-rose-600', text: 'text-rose-600' },\n    amber: { bg: 'bg-amber-500', text: 'text-amber-500' },\n    cyan: { bg: 'bg-cyan-500', text: 'text-cyan-500' },\n    slate: { bg: 'bg-slate-600', text: 'text-slate-600' },\n};\n\nconst MAX_IMAGE_SIZE = 2 * 1024 * 1024;\n\nexport const AgencySettingsModal: React.FC<AgencySettingsModalProps> = ({ isOpen, onClose, agency, onUpdateAgency }) => {\n    const { toast } = useUI();\n    const brandColor = agency.branding?.color || 'indigo';\n\n    const handleColorChange = (color: BrandColor) => {\n        onUpdateAgency({ ...agency, branding: { ...agency.branding, color } });\n    };\n  \n    const handleBannerUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {\n        if (e.target.files && e.target.files[0]) {\n            const file = e.target.files[0];\n            if (file.size > MAX_IMAGE_SIZE) {\n                toast('error', `Image trop lourde (${(file.size/1024/1024).toFixed(1)} Mo). Max 2 Mo.`);\n                return;\n            }\n            try {\n                const storageRef = ref(storage, `banners/${agency.id}_${Date.now()}`);\n                await uploadBytes(storageRef, file);\n                const url = await getDownloadURL(storageRef);\n                onUpdateAgency({ ...agency, branding: { ...agency.branding, bannerUrl: url } });\n                toast('success', 'Bannière mise à jour');\n            } catch (error) { toast('error', \"Erreur d'upload\"); }\n        }\n    };\n  \n    const handleLogoUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {\n      if (e.target.files && e.target.files[0]) {\n          const file = e.target.files[0];\n          if (file.size > MAX_IMAGE_SIZE) {\n              toast('error', `Image trop lourde (${(file.size/1024/1024).toFixed(1)} Mo). Max 2 Mo.`);\n              return;\n          }\n          try {\n              const storageRef = ref(storage, `logos/${agency.id}_${Date.now()}`);\n              await uploadBytes(storageRef, file);\n              const url = await getDownloadURL(storageRef);\n              onUpdateAgency({ ...agency, logoUrl: url });\n              toast('success', 'Logo mis à jour');\n          } catch (error) { toast('error', \"Erreur d'upload du logo\"); }\n      }\n    };\n\n    return (\n        <Modal isOpen={isOpen} onClose={onClose} title=\"Identité Visuelle du Studio\">\n            <div className=\"space-y-6\">\n                <div>\n                    <label className=\"block text-sm font-bold text-slate-700 mb-2\">Logo de l'Agence (Carré)</label>\n                    <div className=\"flex items-center gap-4\">\n                        <div className=\"w-20 h-20 rounded-2xl bg-slate-100 border border-slate-200 overflow-hidden flex items-center justify-center shrink-0\">\n                            {agency.logoUrl ? <img src={agency.logoUrl} className=\"w-full h-full object-contain\" /> : <Landmark className=\"text-slate-300\" size={32}/>}\n                        </div>\n                        <label className=\"flex-1 flex flex-col items-center justify-center h-20 border-2 border-slate-300 border-dashed rounded-xl cursor-pointer bg-slate-50 hover:bg-slate-100 transition-colors\">\n                            <div className=\"flex flex-col items-center justify-center\">\n                                <Upload className=\"w-5 h-5 text-slate-400 mb-1\" />\n                                <p className=\"text-[10px] text-slate-500 font-bold uppercase\">Changer le Logo</p>\n                            </div>\n                            <input type=\"file\" className=\"hidden\" accept=\"image/*\" onChange={handleLogoUpload} />\n                        </label>\n                    </div>\n                </div>\n\n                <div>\n                    <label className=\"block text-sm font-bold text-slate-700 mb-2\">Couleur de Marque</label>\n                    <div className=\"flex gap-3\">\n                        {(['indigo', 'emerald', 'rose', 'amber', 'cyan'] as BrandColor[]).map(c => (\n                            <button key={c} onClick={() => handleColorChange(c)} className={`w-10 h-10 rounded-full border-2 ${COLOR_THEMES[c].bg} ${brandColor === c ? 'ring-4 ring-offset-2 ring-slate-200 border-white' : 'border-transparent opacity-60 hover:opacity-100'}`} />\n                        ))}\n                    </div>\n                </div>\n                <div>\n                    <label className=\"block text-sm font-bold text-slate-700 mb-2\">Bannière (Cover)</label>\n                    <label className=\"flex flex-col items-center justify-center w-full h-32 border-2 border-slate-300 border-dashed rounded-xl cursor-pointer bg-slate-50 hover:bg-slate-100 transition-colors\">\n                        <div className=\"flex flex-col items-center justify-center pt-5 pb-6\">\n                            <ImageIcon className=\"w-8 h-8 text-slate-400 mb-2\" />\n                            <p className=\"text-sm text-slate-500\">Cliquez pour changer la bannière</p>\n                        </div>\n                        <input type=\"file\" className=\"hidden\" accept=\"image/*\" onChange={handleBannerUpload} />\n                    </label>\n                </div>\n            </div>\n        </Modal>\n    );\n};\n"
            }
          ]
        },
        {
          "path": "components/StudentAgencyView.tsx",
          "generationType": 1,
          "isDone": true,
          "description": "Refactoring : Utilisation des nouveaux sous-composants pour alléger le fichier",
          "diffs": [
            {
              "target": "",
              "replacement": "\nimport React, { useState, useEffect } from 'react';\nimport { Agency, BrandColor, GameEvent } from '../types';\nimport { Eye, AlertTriangle, PartyPopper, Zap } from 'lucide-react';\nimport { MarketOverview } from './student/MarketOverview';\nimport { MissionsView } from './student/MissionsView';\nimport { TeamView } from './student/TeamView';\nimport { MercatoView } from './student/MercatoView';\nimport { WikiView } from './student/WikiView';\nimport { FAQView } from './student/FAQView';\nimport { TheBackdoor } from './student/TheBackdoor';\nimport { Modal } from './Modal';\nimport { GAME_RULES } from '../constants';\nimport { useAuth } from '../contexts/AuthContext';\nimport { useGame } from '../contexts/GameContext';\n\n// IMPORT SUB-COMPONENTS\nimport { AgencyHeader } from './student/layout/AgencyHeader';\nimport { AgencyNav } from './student/layout/AgencyNav';\nimport { BackdoorTrigger } from './student/features/BackdoorTrigger';\nimport { VotingSystem } from './student/features/VotingSystem';\nimport { AgencySettingsModal } from './student/modals/AgencySettingsModal';\n\ninterface StudentViewProps {\n  agency: Agency;\n  allAgencies: Agency[];\n  onUpdateAgency: (agency: Agency) => void;\n}\n\ntype TabType = 'MARKET' | 'MISSIONS' | 'TEAM' | 'RECRUITMENT' | 'RESOURCES' | 'HELP';\n\nconst COLOR_THEMES: Record<BrandColor, { bg: string, text: string }> = {\n    indigo: { bg: 'bg-indigo-600', text: 'text-indigo-600' },\n    emerald: { bg: 'bg-emerald-600', text: 'text-emerald-600' },\n    rose: { bg: 'bg-rose-600', text: 'text-rose-600' },\n    amber: { bg: 'bg-amber-500', text: 'text-amber-500' },\n    cyan: { bg: 'bg-cyan-500', text: 'text-cyan-500' },\n    slate: { bg: 'bg-slate-600', text: 'text-slate-600' },\n};\n\nexport const StudentAgencyView: React.FC<StudentViewProps> = ({ agency, allAgencies, onUpdateAgency }) => {\n  const { currentUser } = useAuth();\n  const { getCurrentGameWeek, updateAgenciesList, submitMercatoVote, submitChallengeVote } = useGame();\n  \n  const [activeTab, setActiveTab] = useState<TabType>('MARKET');\n  const [showVERules, setShowVERules] = useState(false);\n  const [showSettings, setShowSettings] = useState(false);\n  const [showBackdoor, setShowBackdoor] = useState(false);\n  \n  const [unlockModal, setUnlockModal] = useState<{title: string, message: string, icon: any, confirmText: string} | null>(null);\n  const [notificationEvent, setNotificationEvent] = useState<GameEvent | null>(null);\n\n  const brandColor = agency.branding?.color || 'indigo';\n  const theme = COLOR_THEMES[brandColor];\n  const leaderboard = [...allAgencies].filter(a => a.id !== 'unassigned').sort((a, b) => b.ve_current - a.ve_current);\n  const myRank = leaderboard.findIndex(a => a.id === agency.id) + 1;\n  const myMemberProfile = agency.members.find(m => m.id === currentUser?.uid);\n\n  // --- UNLOCKS & NOTIFICATIONS LOGIC ---\n  useEffect(() => {\n      const currentWeek = getCurrentGameWeek();\n      if (currentWeek >= GAME_RULES.UNLOCK_WEEK_BLACK_OPS) {\n          const hasSeenBlackOps = localStorage.getItem(`seen_unlock_blackops_${currentUser?.uid}`);\n          if (!hasSeenBlackOps) {\n              setUnlockModal({\n                  title: \"Intelligence Économique Activée\",\n                  message: \"Le marché se durcit. Vous avez désormais accès aux outils de veille stratégique.\\n\\nNouveauté : Audits concurrentiels et achat d'informations disponibles dans l'onglet 'Marché'.\",\n                  icon: <Eye size={32} className=\"text-yellow-500\"/>,\n                  confirmText: \"Compris, je reste vigilant\"\n              });\n              localStorage.setItem(`seen_unlock_blackops_${currentUser?.uid}`, 'true');\n              return; \n          }\n      }\n  }, [getCurrentGameWeek, currentUser]);\n\n  useEffect(() => {\n      if (agency.eventLog.length === 0) return;\n      const latestEvent = agency.eventLog[agency.eventLog.length - 1];\n      const NOTIFY_TYPES = ['CRISIS', 'VE_DELTA'];\n      if (NOTIFY_TYPES.includes(latestEvent.type)) {\n          const seenKey = `seen_event_${currentUser?.uid}_${latestEvent.id}`;\n          const hasSeen = localStorage.getItem(seenKey);\n          if (!hasSeen) setNotificationEvent(latestEvent);\n      }\n  }, [agency.eventLog, currentUser]);\n\n  const closeNotification = () => {\n      if (notificationEvent) {\n          localStorage.setItem(`seen_event_${currentUser?.uid}_${notificationEvent.id}`, 'true');\n          setNotificationEvent(null);\n      }\n  };\n\n  if (showBackdoor && myMemberProfile) {\n      return <TheBackdoor agency={agency} allAgencies={allAgencies} currentUser={myMemberProfile} onClose={() => setShowBackdoor(false)} />;\n  }\n\n  return (\n    <div className=\"flex flex-col min-h-[calc(100vh-6rem)] font-sans relative\">\n        \n        {/* BACKDOOR TRIGGER */}\n        <BackdoorTrigger onTrigger={() => setShowBackdoor(true)} />\n\n        {/* HEADER */}\n        <AgencyHeader \n            agency={agency}\n            myRank={myRank}\n            theme={theme}\n            myMemberProfile={myMemberProfile}\n            onOpenSettings={() => setShowSettings(true)}\n            onOpenVERules={() => setShowVERules(true)}\n        />\n\n        {/* VOTING BOOTHS */}\n        {myMemberProfile && (\n            <VotingSystem \n                agency={agency}\n                currentUser={myMemberProfile}\n                onVoteMercato={submitMercatoVote}\n                onVoteChallenge={submitChallengeVote}\n            />\n        )}\n\n        {/* MAIN CONTENT AREA */}\n        <div className=\"flex-1 mb-24 md:mb-8\">\n            {activeTab === 'MARKET' && agency.id !== 'unassigned' && <MarketOverview agency={agency} allAgencies={allAgencies} currentUser={myMemberProfile} />}\n            {activeTab === 'MISSIONS' && agency.id !== 'unassigned' && <MissionsView agency={agency} onUpdateAgency={onUpdateAgency} />}\n            {activeTab === 'TEAM' && agency.id !== 'unassigned' && <TeamView agency={agency} onUpdateAgency={onUpdateAgency} />}\n            {(activeTab === 'RECRUITMENT' || agency.id === 'unassigned') && (\n              <MercatoView \n                agency={agency} \n                allAgencies={allAgencies} \n                onUpdateAgency={onUpdateAgency} \n                onUpdateAgencies={updateAgenciesList} \n              />\n            )}\n            {activeTab === 'RESOURCES' && <WikiView agency={agency} />}\n            {activeTab === 'HELP' && <FAQView />}\n        </div>\n\n        {/* FOOTER NAV */}\n        <AgencyNav \n            activeTab={activeTab}\n            setActiveTab={setActiveTab}\n            agency={agency}\n            theme={theme}\n        />\n\n        {/* SETTINGS MODAL */}\n        <AgencySettingsModal \n            isOpen={showSettings}\n            onClose={() => setShowSettings(false)}\n            agency={agency}\n            onUpdateAgency={onUpdateAgency}\n        />\n        \n        {/* HELP MODALS */}\n        <Modal isOpen={showVERules} onClose={() => setShowVERules(false)} title=\"Comprendre la VE\">\n            <div className=\"space-y-6\">\n                <div className=\"bg-slate-50 p-4 rounded-2xl border border-slate-100\">\n                    <p className=\"text-sm text-slate-600 leading-relaxed mb-2\">\n                        La <strong>Valeur d'Entreprise (VE)</strong> est votre \"note de groupe\" dynamique (/100). \n                        <br/>Elle fluctue selon vos rendus, vos choix et les événements.\n                        <br/><br/>\n                        <strong>Attention :</strong> Si votre VE tombe à 0, c'est grave, mais la vraie mort est financière : <strong>-5000 PiXi = FAILLITE</strong>.\n                    </p>\n                </div>\n            </div>\n        </Modal>\n\n        {unlockModal && (\n            <Modal isOpen={!!unlockModal} onClose={() => setUnlockModal(null)} title={unlockModal.title}>\n                <div className=\"flex flex-col items-center text-center space-y-6\">\n                    <div className=\"p-6 rounded-full bg-slate-100 mb-2\">\n                        {unlockModal.icon}\n                    </div>\n                    <p className=\"text-slate-600 text-lg leading-relaxed whitespace-pre-line\">\n                        {unlockModal.message}\n                    </p>\n                    <button \n                        onClick={() => setUnlockModal(null)}\n                        className=\"w-full py-4 bg-slate-900 text-white font-bold rounded-xl hover:bg-indigo-600 transition-colors shadow-lg\"\n                    >\n                        {unlockModal.confirmText}\n                    </button>\n                </div>\n            </Modal>\n        )}\n\n        {notificationEvent && (\n            <Modal isOpen={!!notificationEvent} onClose={closeNotification} title={notificationEvent.type === 'CRISIS' ? \"ALERTE PRIORITAIRE\" : \"NOUVELLE IMPORTANTE\"}>\n                <div className=\"flex flex-col items-center text-center space-y-6\">\n                    <div className={`p-6 rounded-full mb-2 border-4 ${\n                        notificationEvent.type === 'CRISIS' || (notificationEvent.deltaVE || 0) < 0\n                        ? 'bg-red-50 border-red-100 text-red-600 animate-pulse'\n                        : 'bg-emerald-50 border-emerald-100 text-emerald-600'\n                    }`}>\n                        {notificationEvent.type === 'CRISIS' || (notificationEvent.deltaVE || 0) < 0\n                            ? <AlertTriangle size={48} strokeWidth={2.5}/>\n                            : (notificationEvent.deltaVE || 0) > 5 ? <PartyPopper size={48} strokeWidth={2.5}/> : <Zap size={48} strokeWidth={2.5}/>\n                        }\n                    </div>\n\n                    <div>\n                        <h3 className={`text-2xl font-black uppercase mb-2 ${\n                            notificationEvent.type === 'CRISIS' || (notificationEvent.deltaVE || 0) < 0 ? 'text-red-600' : 'text-emerald-600'\n                        }`}>\n                            {notificationEvent.label}\n                        </h3>\n                        <p className=\"text-slate-600 text-lg leading-relaxed font-medium\">\n                            {notificationEvent.description}\n                        </p>\n                    </div>\n\n                    <button \n                        onClick={closeNotification}\n                        className={`w-full py-4 text-white font-bold rounded-xl shadow-lg transition-transform active:scale-95 ${\n                            notificationEvent.type === 'CRISIS' || (notificationEvent.deltaVE || 0) < 0\n                            ? 'bg-red-600 hover:bg-red-700 shadow-red-200'\n                            : 'bg-emerald-600 hover:bg-emerald-700 shadow-emerald-200'\n                        }`}\n                    >\n                        {notificationEvent.type === 'CRISIS' ? \"J'AI PRIS CONNAISSANCE\" : \"GÉNIAL !\"}\n                    </button>\n                </div>\n            </Modal>\n        )}\n    </div>\n  );\n};\n"
            }
          ]
        }
      ]
    },
    "createdTimestamp": {
      "seconds": 1768863088,
      "nanos": 647000000
    },
    "doneTimestamp": {
      "seconds": 1768863098,
      "nanos": 45000000
    }
  }
]