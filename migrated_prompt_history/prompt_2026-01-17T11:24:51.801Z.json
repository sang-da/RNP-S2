[
  {
    "id": 108,
    "author": "user",
    "payload": {
      "type": "text",
      "text": "Je veux augmenter ce qu'il m'est disponible d'un point de vue analytics des étudiants",
      "files": [],
      "fileUploads": [],
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1768528432,
      "nanos": 140000000
    }
  },
  {
    "id": 109,
    "author": "model",
    "payload": {
      "type": "thinking",
      "text": "**Examining Student Data**\n\nI'm currently focused on analyzing the user's request, specifically the goal of expanding student analytics. I'm parsing the phrasing \"Je veux augmenter ce qu'il m'\" to understand the precise needs and scope. This involves identifying the specific aspects of student data the user is interested in and the desired level of detail.\n\n\n**Expanding Data Insights**\n\nI'm now considering the existing Admin Dashboard structure. To give the user deeper student analytics without cluttering the UI, I'm leaning toward either a \"Detailed Analytics\" mode within the current dashboard or a dedicated \"Student Analytics\" sub-view. The user's need for granular data, performance comparisons, and time-based trends is becoming clearer. This also includes visualizing aspects such as attendance and participation.\n\n\n**Defining Feature Placement**\n\nOkay, I've narrowed down the best approach for the user's need. I'm moving forward with a new \"Analytics & Performance\" view, accessible from the Admin Sidebar. Instead of making the change a new modal, I'll integrate it into the AdminDashboard as a new sophisticated section. I've also identified specific metrics to add, including individual performance over time and overall Agency stats.\n\n\n**Formulating Analytics Modules**\n\nI'm now fully immersed in the design specs. I've broken down the new analytics view into four distinct tabs. \"Global Health\" will feature a scatter plot. \"Top Talents\" will provide a ranked list. \"Wealth Gap\" will highlight the distribution. Finally, \"Participation\" will visualize peer review data using a heatmap. I'm focusing on data sources and component updates, with plans to modify `types.ts`, `AdminSidebar.tsx`, and create a new `AdminAnalytics.tsx`.\n\n\n**Constructing New Component**\n\nI'm now fully immersed in the coding phase for the `AdminAnalytics.tsx` component. I'm focusing on data extraction logic, specifically how to iterate through the `agencies` within the `GameContext`. My current focus is the data prep. I'm importing necessary modules, including Recharts and Lucide icons. I'm also preparing arrays for all students, top performers (sorted by score), richest (sorted by wallet), and engagement (average peer review scores).\n\n\n**Designing Specific Visualizations**\n\nI'm now fully immersed in the design specs. I've been thinking about several charts. A RadarChart will visualize student skills, while a BarChart will represent wealth distribution. I will include routing in `src/App.tsx`, a menu item in `src/components/AdminSidebar.tsx`, and the new component, `src/components/AdminAnalytics.tsx`. I have confirmed that Recharts is an available import. I will be sure to add a title, KPIs, and several charts, including a talent/context chart.\n\n\n**Implementing Visualizations**\n\nI'm now focusing on specific visualizations and their associated data structures within `AdminAnalytics.tsx`. I'm starting to build out a radar chart for aggregated soft skills from peer reviews, focusing on Assiduité, Qualité, and Implication. Additionally, I'll be creating a table for the \"Top 10 High Potentials\", based on Score, Cash, and Streak, including the required data extraction.\n\n\n",
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1768528432,
      "nanos": 140000000
    },
    "doneTimestamp": {
      "seconds": 1768528459,
      "nanos": 737000000
    }
  },
  {
    "id": 110,
    "author": "model",
    "payload": {
      "type": "text",
      "text": "C'est une excellente initiative. Pour piloter une classe comme une entreprise, il ne suffit pas de voir les notes, il faut comprendre les **dynamiques**.\n\nJe vais créer un nouveau module **\"Centre d'Analyse (Analytics)\"** dédié à l'enseignant.\n\nVoici les spécifications de cette mise à jour :\n\n1.  **Matrice \"Talent vs Environnement\" (Scatter Chart)** : Un graphique croisé dynamique qui place chaque agence selon deux axes : *Qualité des Talents* (Moyenne des scores individuels) vs *Performance Agence* (VE). Cela permet d'identifier immédiatement les **\"Talents gâchés\"** (Bons élèves dans une mauvaise agence) ou les **\"Passagers Clandestins\"** (Mauvais élèves portés par une bonne agence).\n2.  **Radar de Soft Skills** : Une visualisation agrégée des données de *Peer Review* (Assiduité, Qualité, Implication) pour voir les forces et faiblesses globales de la promo.\n3.  **Classement \"High Potential\"** : Une liste des étudiants les plus \"Rentables\" (Haut score + Haute épargne), utile pour le Mercato.\n4.  **Distribution des Richesses** : Un graphique pour surveiller les inégalités économiques (Écart type entre les plus riches et les précaires).\n\nVoici les modifications :\n\n",
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1768528459,
      "nanos": 737000000
    },
    "doneTimestamp": {
      "seconds": 1768528459,
      "nanos": 737000000
    }
  },
  {
    "id": 111,
    "author": "model",
    "payload": {
      "type": "generationTable",
      "entries": [
        {
          "path": "components/AdminSidebar.tsx",
          "generationType": 1,
          "isDone": true,
          "description": "Ajout de l'entrée \"Analytics\" dans le menu latéral.",
          "diffs": [
            {
              "target": "",
              "replacement": "\nimport React from 'react';\nimport { LayoutDashboard, Users, Briefcase, Settings, LogOut, Flame, CalendarRange, KeyRound, FolderOpen, MonitorPlay, X, Bot, TrendingUp, PieChart } from 'lucide-react';\n\ninterface AdminSidebarProps {\n  activeView: string;\n  onNavigate: (view: any) => void;\n  onLogout: () => void;\n  isOpen: boolean; // Mobile state\n  onClose: () => void; // Mobile action\n}\n\nexport const AdminSidebar: React.FC<AdminSidebarProps> = ({ activeView, onNavigate, onLogout, isOpen, onClose }) => {\n  const menuItems = [\n    { id: 'OVERVIEW', label: 'Vue Globale', icon: <LayoutDashboard size={20} /> },\n    { id: 'ANALYTICS', label: 'Analytics & Data', icon: <PieChart size={20} /> }, // NOUVEAU\n    { id: 'MARKET', label: 'Marché Live', icon: <TrendingUp size={20} /> },\n    { id: 'AI_ASSISTANT', label: 'Co-Pilote IA', icon: <Bot size={20} /> },\n    { id: 'ACCESS', label: 'Accès & Comptes', icon: <KeyRound size={20} /> },\n    { id: 'SCHEDULE', label: 'Calendrier', icon: <CalendarRange size={20} /> },\n    { id: 'MERCATO', label: 'Mercato RH', icon: <Users size={20} /> },\n    { id: 'PROJECTS', label: 'Gestion Projets', icon: <Briefcase size={20} /> },\n    { id: 'CRISIS', label: 'Zone de Crise', icon: <Flame size={20} /> },\n  ];\n\n  const secondaryItems = [\n    { id: 'RESOURCES', label: 'Ressources', icon: <FolderOpen size={20} /> },\n    { id: 'VIEWS', label: 'Vues & Simulation', icon: <MonitorPlay size={20} /> },\n    { id: 'SETTINGS', label: 'Paramètres', icon: <Settings size={20} /> },\n  ];\n\n  return (\n    <>\n        {/* Mobile Overlay */}\n        {isOpen && (\n            <div \n                className=\"fixed inset-0 bg-slate-900/50 z-[49] md:hidden backdrop-blur-sm transition-opacity\"\n                onClick={onClose}\n            />\n        )}\n\n        {/* Sidebar */}\n        <div className={`\n            fixed left-0 top-0 h-screen w-64 bg-slate-900 text-white flex flex-col z-[50] shadow-2xl\n            transition-transform duration-300 ease-in-out\n            ${isOpen ? 'translate-x-0' : '-translate-x-full md:translate-x-0'}\n        `}>\n          {/* Brand */}\n          <div className=\"h-16 flex items-center justify-between px-6 border-b border-slate-800\">\n            <div className=\"flex items-center gap-3\">\n                <div className=\"w-8 h-8 rounded-lg bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center\">\n                    <div className=\"w-3 h-3 bg-white rounded-full\"></div>\n                </div>\n                <span className=\"font-display font-bold text-lg tracking-tight\">RNP Admin</span>\n            </div>\n            {/* Mobile Close Button */}\n            <button onClick={onClose} className=\"md:hidden text-slate-400 hover:text-white\">\n                <X size={24} />\n            </button>\n          </div>\n\n          {/* Navigation */}\n          <nav className=\"flex-1 p-4 space-y-8 overflow-y-auto custom-scrollbar\">\n            \n            {/* Main Section */}\n            <div className=\"space-y-2\">\n                <p className=\"px-4 text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Gestion</p>\n                {menuItems.map((item) => (\n                    <button\n                        key={item.id}\n                        onClick={() => { onNavigate(item.id as any); onClose(); }}\n                        className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${\n                            activeView === item.id \n                            ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-900/50 font-bold' \n                            : 'text-slate-400 hover:bg-slate-800 hover:text-white'\n                        }`}\n                    >\n                        {item.icon}\n                        <span className=\"text-sm\">{item.label}</span>\n                    </button>\n                ))}\n            </div>\n\n            {/* Secondary Section */}\n            <div className=\"space-y-2\">\n                <p className=\"px-4 text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Outils</p>\n                {secondaryItems.map((item) => (\n                    <button\n                        key={item.id}\n                        onClick={() => { onNavigate(item.id as any); onClose(); }}\n                        className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${\n                            activeView === item.id \n                            ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-900/50 font-bold' \n                            : 'text-slate-400 hover:bg-slate-800 hover:text-white'\n                        }`}\n                    >\n                        {item.icon}\n                        <span className=\"text-sm\">{item.label}</span>\n                    </button>\n                ))}\n            </div>\n\n          </nav>\n\n          {/* Footer (Simplified as Logout is in Settings now, or keep just quick logout) */}\n          <div className=\"p-4 border-t border-slate-800\">\n            <button \n                onClick={onLogout}\n                className=\"w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:text-red-400 hover:bg-red-900/20 transition-colors\"\n            >\n                <LogOut size={20} />\n                <span className=\"text-sm font-bold\">Déconnexion</span>\n            </button>\n          </div>\n        </div>\n    </>\n  );\n};\n"
            }
          ]
        },
        {
          "path": "components/AdminAnalytics.tsx",
          "generationType": 1,
          "isDone": true,
          "description": "Création du nouveau composant d'analyse de données avancées.",
          "diffs": [
            {
              "target": "",
              "replacement": "\nimport React, { useMemo } from 'react';\nimport { Agency, Student } from '../types';\nimport { ResponsiveContainer, ScatterChart, Scatter, XAxis, YAxis, CartesianGrid, Tooltip, Legend, BarChart, Bar, RadarChart, PolarGrid, PolarAngleAxis, PolarRadiusAxis, Radar } from 'recharts';\nimport { TrendingUp, Users, Wallet, Trophy, AlertTriangle, Lightbulb, Activity } from 'lucide-react';\n\ninterface AdminAnalyticsProps {\n    agencies: Agency[];\n}\n\nexport const AdminAnalytics: React.FC<AdminAnalyticsProps> = ({ agencies }) => {\n    \n    // --- DATA PROCESSING ---\n    const activeAgencies = useMemo(() => agencies.filter(a => a.id !== 'unassigned'), [agencies]);\n    \n    const allStudents = useMemo(() => {\n        const students: (Student & { agencyName: string, agencyId: string })[] = [];\n        activeAgencies.forEach(a => {\n            a.members.forEach(m => students.push({ ...m, agencyName: a.name, agencyId: a.id }));\n        });\n        return students;\n    }, [activeAgencies]);\n\n    // 1. SCATTER DATA: TALENT vs AGENCY PERFORMANCE\n    const scatterData = useMemo(() => {\n        return activeAgencies.map(a => {\n            const avgScore = a.members.length > 0 \n                ? a.members.reduce((acc, m) => acc + m.individualScore, 0) / a.members.length \n                : 0;\n            return {\n                name: a.name,\n                ve: a.ve_current, // Y Axis\n                avgScore: Math.round(avgScore), // X Axis\n                classId: a.classId,\n                members: a.members.length\n            };\n        });\n    }, [activeAgencies]);\n\n    // 2. RADAR DATA: SOFT SKILLS (From Peer Reviews)\n    const radarData = useMemo(() => {\n        let totalAttendance = 0, totalQuality = 0, totalInvolvement = 0;\n        let count = 0;\n\n        activeAgencies.forEach(a => {\n            a.peerReviews.forEach(r => {\n                totalAttendance += r.ratings.attendance;\n                totalQuality += r.ratings.quality;\n                totalInvolvement += r.ratings.involvement;\n                count++;\n            });\n        });\n\n        if (count === 0) return [];\n\n        return [\n            { subject: 'Assiduité', A: parseFloat((totalAttendance / count).toFixed(2)), fullMark: 5 },\n            { subject: 'Qualité', A: parseFloat((totalQuality / count).toFixed(2)), fullMark: 5 },\n            { subject: 'Implication', A: parseFloat((totalInvolvement / count).toFixed(2)), fullMark: 5 },\n        ];\n    }, [activeAgencies]);\n\n    // 3. WEALTH DISTRIBUTION\n    const wealthData = useMemo(() => {\n        const sorted = [...allStudents].sort((a,b) => (b.wallet || 0) - (a.wallet || 0));\n        const top10 = sorted.slice(0, 10);\n        const flop5 = sorted.slice(-5).reverse();\n        return { top10, flop5 };\n    }, [allStudents]);\n\n    // 4. TOP PERFORMERS (High Potential)\n    const topPerformers = useMemo(() => {\n        return [...allStudents]\n            .sort((a,b) => b.individualScore - a.individualScore)\n            .slice(0, 5);\n    }, [allStudents]);\n\n    // Custom Tooltip for Scatter\n    const ScatterTooltip = ({ active, payload }: any) => {\n        if (active && payload && payload.length) {\n            const data = payload[0].payload;\n            return (\n                <div className=\"bg-white p-3 border border-slate-200 shadow-xl rounded-xl text-xs\">\n                    <p className=\"font-bold text-slate-900 mb-1\">{data.name}</p>\n                    <p className=\"text-indigo-600 font-bold\">VE: {data.ve}</p>\n                    <p className=\"text-slate-500\">Moy. Talent: {data.avgScore}/100</p>\n                    <p className=\"text-slate-400 italic\">{data.members} membres</p>\n                </div>\n            );\n        }\n        return null;\n    };\n\n    return (\n        <div className=\"animate-in fade-in duration-500 pb-20\">\n            <div className=\"mb-8\">\n                <h2 className=\"text-3xl font-display font-bold text-slate-900 flex items-center gap-3\">\n                    <div className=\"p-2 bg-purple-100 rounded-xl text-purple-700\"><PieChart size={32}/></div>\n                    Centre d'Analyse\n                </h2>\n                <p className=\"text-slate-500 text-sm mt-1\">\n                    Métriques avancées pour détecter les anomalies et les talents cachés.\n                </p>\n            </div>\n\n            {/* KPI ROW */}\n            <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4 mb-8\">\n                <div className=\"bg-white p-4 rounded-2xl border border-slate-200 shadow-sm flex items-center gap-4\">\n                    <div className=\"p-3 bg-indigo-50 rounded-xl text-indigo-600\"><Users size={24}/></div>\n                    <div>\n                        <p className=\"text-xs text-slate-400 font-bold uppercase\">Effectif Total</p>\n                        <p className=\"text-2xl font-bold text-slate-900\">{allStudents.length}</p>\n                    </div>\n                </div>\n                <div className=\"bg-white p-4 rounded-2xl border border-slate-200 shadow-sm flex items-center gap-4\">\n                    <div className=\"p-3 bg-emerald-50 rounded-xl text-emerald-600\"><Activity size={24}/></div>\n                    <div>\n                        <p className=\"text-xs text-slate-400 font-bold uppercase\">Moyenne Promo</p>\n                        <p className=\"text-2xl font-bold text-slate-900\">\n                            {Math.round(allStudents.reduce((acc, s) => acc + s.individualScore, 0) / Math.max(1, allStudents.length))}\n                            <span className=\"text-sm text-slate-400 font-medium\">/100</span>\n                        </p>\n                    </div>\n                </div>\n                <div className=\"bg-white p-4 rounded-2xl border border-slate-200 shadow-sm flex items-center gap-4\">\n                    <div className=\"p-3 bg-yellow-50 rounded-xl text-yellow-600\"><Wallet size={24}/></div>\n                    <div>\n                        <p className=\"text-xs text-slate-400 font-bold uppercase\">Masse Monétaire</p>\n                        <p className=\"text-2xl font-bold text-slate-900\">\n                            {(allStudents.reduce((acc, s) => acc + (s.wallet || 0), 0) / 1000).toFixed(1)}k\n                            <span className=\"text-sm text-slate-400 font-medium\"> px</span>\n                        </p>\n                    </div>\n                </div>\n                <div className=\"bg-white p-4 rounded-2xl border border-slate-200 shadow-sm flex items-center gap-4\">\n                    <div className=\"p-3 bg-red-50 rounded-xl text-red-600\"><AlertTriangle size={24}/></div>\n                    <div>\n                        <p className=\"text-xs text-slate-400 font-bold uppercase\">Agences Fragiles</p>\n                        <p className=\"text-2xl font-bold text-slate-900\">\n                            {activeAgencies.filter(a => a.ve_current < 40 || a.budget_real < 0).length}\n                        </p>\n                    </div>\n                </div>\n            </div>\n\n            <div className=\"grid grid-cols-1 xl:grid-cols-2 gap-8 mb-8\">\n                \n                {/* 1. SCATTER CHART: Matrix Talent/Performance */}\n                <div className=\"bg-white p-6 rounded-3xl border border-slate-200 shadow-sm\">\n                    <div className=\"flex justify-between items-start mb-6\">\n                        <div>\n                            <h3 className=\"text-lg font-bold text-slate-900 flex items-center gap-2\">\n                                <Lightbulb size={20} className=\"text-amber-500\"/> Matrice Talent / Performance\n                            </h3>\n                            <p className=\"text-xs text-slate-500 mt-1\">\n                                <strong>Haut-Gauche :</strong> Agence performante mais équipe faible (Leadeurs ?).<br/>\n                                <strong>Bas-Droite :</strong> Talents gâchés (Bons élèves, mauvaise gestion).\n                            </p>\n                        </div>\n                    </div>\n                    <div className=\"h-[350px] w-full\">\n                        <ResponsiveContainer width=\"100%\" height=\"100%\">\n                            <ScatterChart margin={{ top: 20, right: 20, bottom: 20, left: 0 }}>\n                                <CartesianGrid strokeDasharray=\"3 3\" />\n                                <XAxis type=\"number\" dataKey=\"avgScore\" name=\"Moyenne Talent\" unit=\"/100\" domain={[0, 100]} />\n                                <YAxis type=\"number\" dataKey=\"ve\" name=\"Valeur Agence\" unit=\" VE\" domain={[0, 100]} />\n                                <Tooltip content={<ScatterTooltip />} cursor={{ strokeDasharray: '3 3' }} />\n                                <Legend />\n                                <Scatter name=\"Agences\" data={scatterData} fill=\"#6366f1\" shape=\"circle\" />\n                            </ScatterChart>\n                        </ResponsiveContainer>\n                    </div>\n                </div>\n\n                {/* 2. RADAR CHART: Soft Skills */}\n                <div className=\"bg-white p-6 rounded-3xl border border-slate-200 shadow-sm flex flex-col\">\n                    <h3 className=\"text-lg font-bold text-slate-900 flex items-center gap-2 mb-2\">\n                        <Users size={20} className=\"text-emerald-500\"/> Radar RH (Moyenne Promo)\n                    </h3>\n                    <p className=\"text-xs text-slate-500 mb-4\">Basé sur les évaluations hebdomadaires entre pairs.</p>\n                    \n                    <div className=\"flex-1 min-h-[300px]\">\n                        {radarData.length > 0 ? (\n                            <ResponsiveContainer width=\"100%\" height=\"100%\">\n                                <RadarChart cx=\"50%\" cy=\"50%\" outerRadius=\"80%\" data={radarData}>\n                                    <PolarGrid stroke=\"#e2e8f0\" />\n                                    <PolarAngleAxis dataKey=\"subject\" tick={{ fill: '#64748b', fontSize: 12, fontWeight: 'bold' }} />\n                                    <PolarRadiusAxis angle={30} domain={[0, 5]} tick={false} />\n                                    <Radar name=\"Promo\" dataKey=\"A\" stroke=\"#10b981\" fill=\"#10b981\" fillOpacity={0.4} />\n                                    <Tooltip \n                                        contentStyle={{borderRadius: '12px', border: 'none', boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1)'}}\n                                        itemStyle={{color: '#065f46', fontWeight: 'bold'}}\n                                    />\n                                </RadarChart>\n                            </ResponsiveContainer>\n                        ) : (\n                            <div className=\"h-full flex items-center justify-center text-slate-400 text-sm italic\">\n                                Pas assez de données RH.\n                            </div>\n                        )}\n                    </div>\n                </div>\n            </div>\n\n            <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-8\">\n                \n                {/* 3. HIGH POTENTIALS */}\n                <div className=\"bg-slate-900 rounded-3xl p-6 text-white shadow-xl lg:col-span-1\">\n                    <h3 className=\"text-lg font-bold flex items-center gap-2 mb-6\">\n                        <Trophy size={20} className=\"text-yellow-400\"/> Top Performers\n                    </h3>\n                    <div className=\"space-y-4\">\n                        {topPerformers.map((student, i) => (\n                            <div key={student.id} className=\"flex items-center gap-3 p-3 bg-white/10 rounded-xl border border-white/5\">\n                                <div className=\"font-bold text-lg text-white/50 w-6\">#{i+1}</div>\n                                <img src={student.avatarUrl} className=\"w-10 h-10 rounded-full bg-slate-800\" />\n                                <div className=\"flex-1 overflow-hidden\">\n                                    <p className=\"font-bold text-sm truncate\">{student.name}</p>\n                                    <p className=\"text-[10px] text-slate-400 truncate\">{student.agencyName}</p>\n                                </div>\n                                <div className=\"text-right\">\n                                    <span className=\"block font-bold text-emerald-400\">{student.individualScore}</span>\n                                    <span className=\"text-[10px] text-slate-500\">SCORE</span>\n                                </div>\n                            </div>\n                        ))}\n                    </div>\n                </div>\n\n                {/* 4. WEALTH DISTRIBUTION */}\n                <div className=\"bg-white rounded-3xl p-6 border border-slate-200 shadow-sm lg:col-span-2\">\n                    <h3 className=\"text-lg font-bold text-slate-900 flex items-center gap-2 mb-6\">\n                        <TrendingUp size={20} className=\"text-indigo-500\"/> Inégalités Économiques (Top 10 vs Flop 5)\n                    </h3>\n                    <div className=\"h-[300px]\">\n                        <ResponsiveContainer width=\"100%\" height=\"100%\">\n                            <BarChart\n                                data={[...wealthData.top10, ...wealthData.flop5]}\n                                margin={{ top: 5, right: 30, left: 20, bottom: 5 }}\n                            >\n                                <CartesianGrid strokeDasharray=\"3 3\" vertical={false} stroke=\"#f1f5f9\"/>\n                                <XAxis dataKey=\"name\" tick={{fontSize: 10}} interval={0} angle={-20} textAnchor=\"end\" height={60}/>\n                                <YAxis />\n                                <Tooltip \n                                    cursor={{fill: '#f8fafc'}}\n                                    contentStyle={{borderRadius: '12px', border: '1px solid #e2e8f0'}}\n                                />\n                                <Bar dataKey=\"wallet\" fill=\"#6366f1\" radius={[4, 4, 0, 0]} />\n                            </BarChart>\n                        </ResponsiveContainer>\n                    </div>\n                </div>\n            </div>\n        </div>\n    );\n};\n"
            }
          ]
        },
        {
          "path": "App.tsx",
          "generationType": 1,
          "isDone": true,
          "description": "Mise à jour du routage pour inclure la vue Analytics.",
          "diffs": [
            {
              "target": "",
              "replacement": "\nimport React, { useState, useRef } from 'react';\nimport { Layout } from './components/Layout';\nimport { AdminDashboard } from './components/AdminDashboard';\nimport { StudentAgencyView } from './components/StudentAgencyView';\nimport { AdminSidebar } from './components/AdminSidebar';\nimport { AdminMercato } from './components/AdminMercato';\nimport { AdminProjects } from './components/AdminProjects';\nimport { AdminCrisis } from './components/AdminCrisis';\nimport { AdminSchedule } from './components/AdminSchedule';\nimport { AdminAccess } from './components/AdminAccess';\nimport { AdminResources } from './components/AdminResources';\nimport { AdminSettings } from './components/AdminSettings';\nimport { AdminViews } from './components/AdminViews';\nimport { AdminAIAssistant } from './components/AdminAIAssistant';\nimport { AdminMarket } from './components/AdminMarket';\nimport { AdminAnalytics } from './components/AdminAnalytics'; // IMPORT\nimport { LandingPage } from './components/LandingPage';\nimport { WaitingScreen } from './components/WaitingScreen';\nimport { GameProvider, useGame } from './contexts/GameContext';\nimport { UIProvider } from './contexts/UIContext';\nimport { AuthProvider, useAuth } from './contexts/AuthContext';\nimport { Menu, EyeOff, ChevronRight, Home, Eye, Unplug, RefreshCw } from 'lucide-react';\nimport { signOut, auth } from './services/firebase';\nimport { NewsTicker } from './components/NewsTicker';\n\ntype AdminViewType = 'OVERVIEW' | 'ANALYTICS' | 'MARKET' | 'MERCATO' | 'PROJECTS' | 'CRISIS' | 'SCHEDULE' | 'ACCESS' | 'RESOURCES' | 'SETTINGS' | 'VIEWS' | 'AI_ASSISTANT';\n\nconst GameContainer: React.FC = () => {\n  const { currentUser, userData, loading } = useAuth();\n  const { \n    agencies, \n    selectedAgencyId, \n    selectAgency, \n    updateAgency,\n    weeks,\n    updateWeek,\n    updateAgenciesList,\n    shuffleConstraints\n  } = useGame();\n\n  const [adminView, setAdminView] = useState<AdminViewType>('OVERVIEW');\n  const [isSidebarOpen, setIsSidebarOpen] = useState(false);\n  const [simulationMode, setSimulationMode] = useState<'NONE' | 'WAITING' | 'AGENCY'>('NONE');\n  const [simulatedAgencyId, setSimulatedAgencyId] = useState<string | null>(null);\n\n  const touchStart = useRef(0);\n  const touchEnd = useRef(0);\n\n  const handleTouchStart = (e: React.TouchEvent) => { touchStart.current = e.targetTouches[0].clientX; };\n  const handleTouchMove = (e: React.TouchEvent) => { touchEnd.current = e.targetTouches[0].clientX; };\n  const handleTouchEnd = () => {\n    if (!touchStart.current || !touchEnd.current) return;\n    const distance = touchStart.current - touchEnd.current;\n    if (distance < -50 && !isSidebarOpen) setIsSidebarOpen(true);\n    if (distance > 50 && isSidebarOpen) setIsSidebarOpen(false);\n    touchStart.current = 0; touchEnd.current = 0;\n  };\n\n  if (loading) {\n      return (\n          <div className=\"min-h-screen flex items-center justify-center bg-slate-50\">\n              <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600\"></div>\n          </div>\n      );\n  }\n\n  if (!currentUser) return <LandingPage />;\n\n  // CAS 1 : ADMIN OU SUPERVISEUR\n  if (userData?.role === 'admin' || userData?.role === 'supervisor') {\n      const isReadOnly = userData.role === 'supervisor';\n\n      if (simulationMode !== 'NONE') {\n          return (\n              <div className=\"flex flex-col min-h-screen bg-slate-50\">\n                  <div className=\"bg-red-600 text-white px-4 py-3 shadow-md z-[100] flex justify-between items-center sticky top-0\">\n                      <div className=\"flex items-center gap-2\"><EyeOff size={20}/><span className=\"font-bold text-sm uppercase tracking-wide\">Mode Simulation Étudiant</span></div>\n                      <button onClick={() => { setSimulationMode('NONE'); setSimulatedAgencyId(null); }} className=\"bg-white text-red-600 hover:bg-red-50 px-4 py-1.5 rounded-lg font-bold text-xs uppercase transition-colors shadow-sm\">Quitter</button>\n                  </div>\n                  <div className=\"flex-1 relative\">\n                    {simulationMode === 'WAITING' ? <WaitingScreen /> : simulatedAgencyId && (\n                        <Layout role=\"student\" switchRole={() => {}}>\n                            <StudentAgencyView agency={agencies.find(a => a.id === simulatedAgencyId) || agencies[0]} allAgencies={agencies} onUpdateAgency={updateAgency} />\n                        </Layout>\n                    )}\n                  </div>\n              </div>\n          );\n      }\n\n      if (selectedAgencyId) {\n        const agency = agencies.find(a => a.id === selectedAgencyId);\n        if (!agency) return <div>Agence introuvable</div>;\n        return (\n            <div className=\"md:ml-64 bg-slate-50 min-h-screen flex flex-col\">\n                 <div className=\"sticky top-0 z-30 bg-white border-b border-slate-200 px-4 md:px-8 py-3 flex items-center gap-2 shadow-sm\">\n                    <button onClick={() => selectAgency(null)} className=\"text-slate-400 hover:text-indigo-600 flex items-center gap-1 text-sm font-medium transition-colors\"><Home size={16}/> Dashboard</button>\n                    <ChevronRight size={14} className=\"text-slate-300\"/><span className=\"text-slate-400 text-sm font-medium\">Agences</span><ChevronRight size={14} className=\"text-slate-300\"/><span className=\"text-indigo-700 text-sm font-bold bg-indigo-50 px-2 py-0.5 rounded-md\">{agency.name}</span>\n                 </div>\n                 <div className=\"p-4 md:p-8\"><StudentAgencyView agency={agency} allAgencies={agencies} onUpdateAgency={isReadOnly ? () => {} : updateAgency} /></div>\n            </div>\n        );\n      }\n\n      return (\n          <>\n            <AdminSidebar activeView={adminView} onNavigate={(view) => setAdminView(view as AdminViewType)} onLogout={() => signOut(auth)} isOpen={isSidebarOpen} onClose={() => setIsSidebarOpen(false)} />\n            <div className=\"md:ml-64 min-h-screen bg-slate-50/50 flex flex-col\" onTouchStart={handleTouchStart} onTouchMove={handleTouchMove} onTouchEnd={handleTouchEnd}>\n                <NewsTicker />\n                {isReadOnly && <div className=\"bg-purple-600 text-white px-4 py-2 text-xs font-bold uppercase tracking-widest text-center shadow-sm z-40 flex items-center justify-center gap-2\"><Eye size={14}/> Mode Superviseur (Lecture Seule)</div>}\n                <div className=\"p-4 md:p-8 pt-16 md:pt-8 flex-1\">\n                    <button onClick={() => setIsSidebarOpen(true)} className=\"md:hidden fixed top-14 left-4 z-40 p-2 bg-white rounded-lg shadow-sm border border-slate-200 text-slate-700\"><Menu size={24} /></button>\n                    {adminView === 'OVERVIEW' && <AdminDashboard agencies={agencies} onSelectAgency={selectAgency} onShuffleConstraints={shuffleConstraints} onUpdateAgency={updateAgency} onProcessWeek={() => {}} onNavigate={(view: string) => setAdminView(view as AdminViewType)} readOnly={isReadOnly} />}\n                    {adminView === 'ANALYTICS' && <AdminAnalytics agencies={agencies} />}\n                    {adminView === 'MARKET' && <AdminMarket agencies={agencies} />}\n                    {adminView === 'AI_ASSISTANT' && <AdminAIAssistant agencies={agencies} />}\n                    {adminView === 'ACCESS' && <AdminAccess agencies={agencies} onUpdateAgencies={updateAgenciesList} readOnly={isReadOnly} />}\n                    {adminView === 'SCHEDULE' && <AdminSchedule weeksData={weeks} onUpdateWeek={updateWeek} readOnly={isReadOnly} />}\n                    {adminView === 'MERCATO' && <AdminMercato agencies={agencies} onUpdateAgencies={updateAgenciesList} readOnly={isReadOnly} />}\n                    {adminView === 'PROJECTS' && <AdminProjects agencies={agencies} onUpdateAgency={updateAgency} readOnly={isReadOnly} />}\n                    {adminView === 'CRISIS' && <AdminCrisis agencies={agencies} onUpdateAgency={updateAgency} readOnly={isReadOnly} />}\n                    {adminView === 'RESOURCES' && <AdminResources agencies={agencies} readOnly={isReadOnly} />}\n                    {adminView === 'SETTINGS' && <AdminSettings readOnly={isReadOnly} />}\n                    {adminView === 'VIEWS' && <AdminViews agencies={agencies} onSimulateWaitingRoom={() => setSimulationMode('WAITING')} onSimulateAgency={(id) => { setSimulatedAgencyId(id); setSimulationMode('AGENCY'); }} />}\n                </div>\n            </div>\n          </>\n      );\n  }\n\n  // CAS 2 : ÉTUDIANT VALIDÉ MAIS PERDU (Reset ou ID invalide)\n  const myAgency = agencies.find(a => a.members.some(m => m.id === userData?.uid));\n  \n  if (userData?.role === 'student' && !myAgency) {\n      return (\n          <div className=\"min-h-screen bg-slate-900 flex items-center justify-center p-6 text-center text-white\">\n              <div className=\"max-w-md space-y-6\">\n                  <div className=\"flex justify-center\"><div className=\"p-6 bg-red-500/20 rounded-full border-2 border-red-500/50 text-red-500 animate-pulse\"><Unplug size={64}/></div></div>\n                  <h2 className=\"text-3xl font-display font-bold\">Lien Studio Rompu</h2>\n                  <p className=\"text-slate-400 leading-relaxed\">Votre compte est bien validé, mais suite à une réinitialisation des données, le lien avec votre studio a été perdu.</p>\n                  <div className=\"bg-white/5 p-4 rounded-xl border border-white/10 text-sm\">\n                      Veuillez demander à votre enseignant de vous ré-assigner à votre agence dans l'onglet <strong>\"Accès & Comptes\"</strong> (Section: Étudiants Orphelins).\n                  </div>\n                  <button onClick={() => window.location.reload()} className=\"w-full py-4 bg-white text-slate-900 font-bold rounded-2xl flex items-center justify-center gap-2 hover:bg-slate-200 transition-colors\"><RefreshCw size={20}/> Rafraîchir la page</button>\n                  <button onClick={() => signOut(auth)} className=\"text-slate-500 hover:text-white text-sm font-bold\">Déconnexion</button>\n              </div>\n          </div>\n      );\n  }\n\n  // CAS 3 : ÉTUDIANT NORMAL\n  if (userData?.role === 'student' && myAgency) {\n      return (\n        <Layout role=\"student\" switchRole={() => {}}>\n          <NewsTicker />\n          <StudentAgencyView agency={myAgency} allAgencies={agencies} onUpdateAgency={updateAgency} />\n        </Layout>\n      );\n  }\n\n  // CAS 4 : SALLE D'ATTENTE (Nouveaux venus)\n  return <WaitingScreen />;\n};\n\nconst App: React.FC = () => {\n  return (\n    <UIProvider>\n        <AuthProvider>\n            <GameProvider>\n                <GameContainer />\n            </GameProvider>\n        </AuthProvider>\n    </UIProvider>\n  );\n};\n\nexport default App;\n"
            }
          ]
        }
      ]
    },
    "createdTimestamp": {
      "seconds": 1768528462,
      "nanos": 39000000
    },
    "doneTimestamp": {
      "seconds": 1768528470,
      "nanos": 397000000
    }
  },
  {
    "id": 112,
    "author": "model",
    "payload": {
      "type": "fixingErrors",
      "diagnostics": [
        {
          "LIa": "components/AdminAnalytics.tsx",
          "message": "Cannot find name 'PieChart'.",
          "line": 98,
          "column": 84
        }
      ]
    },
    "createdTimestamp": {
      "seconds": 1768528550,
      "nanos": 574000000
    },
    "doneTimestamp": {
      "seconds": 1768528586,
      "nanos": 326000000
    }
  },
  {
    "id": 113,
    "author": "model",
    "payload": {
      "type": "thinking",
      "text": "**Debugging Compilation Failure**\n\nI'm currently focused on resolving a \"Cannot find name 'PieChart'\" error in `AdminAnalytics.tsx`. I've examined the imports, suspecting a missing or incorrect import statement as the likely source of the problem. Digging deeper, I am confirming the correct import statement.\n\n\n**Verifying Import Correctness**\n\nI've just confirmed the error stems from an incorrect import. My current focus is ensuring the correct `PieChart` component is imported. It seems I mistakenly assumed the usage was from `lucide-react`, which lacks the component. Digging further into the code, I must clarify if the `recharts` version is the intended one. This requires examining the context to understand the expected behavior of `PieChart` in the component.\n\n\n**Updating Lucide-React Imports**\n\nI'm now certain the `PieChart` icon is indeed intended to be imported from `lucide-react`. Looking at line 98 within the provided code, the context strongly suggests this, given the styling and usage. I will add `PieChart` to the `lucide-react` import statement in `AdminAnalytics.tsx` and re-evaluate for the compilation failure.\n\n\n**Finalizing Lucide-React Import**\n\nI've just added `PieChart` to the `lucide-react` import statement, as intended for the icon on line 98. Upon scanning the file, I've confirmed that `recharts`' `PieChart` isn't used. I updated the statement to resolve the initial compilation failure and ensure consistent usage within the context of the icons.\n\n\n**Completing Import Addition**\n\nI'm in the process of adding `PieChart` to the `lucide-react` import statement in `components/AdminAnalytics.tsx`, like the others. I'm reviewing the existing import to ensure proper formatting and placement. Then, I need to provide the complete file content as an XML snippet for the update.\n\n\n**Refining Component Structure**\n\nI am now focusing on refining the `AdminAnalytics` component. I'm implementing the data processing logic, specifically the scatter plot data generation. My goal is to extract relevant data from the `agencies` prop. I'm creating `activeAgencies` to filter out the \"unassigned\" agency. Then, I am mapping this array into a `scatterData` structure with calculated values. I'm currently constructing an array `allStudents` to process the data efficiently.\n\n\n**Calculating Radar Data**\n\nI'm now calculating radar chart data from peer reviews using `useMemo`, focusing on active agencies. I've aggregated attendance, quality, and involvement scores, and computed averages. The aim is to create a structured dataset reflecting soft skills, ensuring no division by zero error is present.\n\n\n**Evaluating Wealth Distribution**\n\nI'm now calculating data for the wealth distribution section, focusing on top and bottom performers. I'm sorting all students by wallet, selecting the top 10 and bottom 5, storing them within an object. This structure facilitates the presentation of wealth and income disparities within the component.\n\n\n**Generating KPI Display**\n\nI'm now integrating the KPI display with the component, drawing from the data provided. My focus is structuring the data for presentation. I'm extracting and formatting `avgScore` and `members` for each displayed item. I'm also preparing for the visual layout, using the provided HTML structure.\n\n\n**Calculating Promotional Averages**\n\nI'm presently calculating the average promotional score. I am accessing the `allStudents` data to process this effectively. I'm using reduce to sum the individual scores and am dividing by the maximum of 1, and the length of `allStudents`, to provide an average.\n\n\n**Displaying Wallet Balance**\n\nI'm structuring the code for a wallet balance display now, starting with the provided HTML template. I'm focusing on calculating the total wallet balance from all student data. I am using `reduce` to sum up each student's wallet balance and converting the sum to thousands with `.toFixed(1)` for a \"k\" presentation.\n\n\n**Analyzing Agency Fragility**\n\nI'm now calculating the number of \"fragile\" agencies, filtering by `ve_current < 40` or `budget_real < 0`. I am presenting the count within an HTML structure, as planned. The data reflects those agencies needing close attention, helping guide business priorities.\n\n\n**Refining Scatter Plot Data**\n\nI'm now focusing on refining the scatter plot data generation. Currently, I'm analyzing how to represent the \"wasted talents\" insight. I'm considering integrating this into the scatter plot to visually depict agencies with high average scores and low value. The goal is to accurately represent this 'wasted talent' dynamic through the `scatterData` structure.\n\n\n**Implementing RadarChart Integration**\n\nI am now integrating the radar chart component. I'm focusing on rendering the `RadarChart` within a responsive container, like I planned. I'm using the `radarData` to populate the chart's structure and customizing the grid and axes. The goal is to visually represent soft skills from the weekly peer evaluations. I need to make sure the data is properly formatted.\n\n\n**Implementing RadarChart Integration**\n\nI am now focusing on integrating the radar chart component. I'm focusing on rendering the `RadarChart` within a responsive container, like I planned. I'm using the `radarData` to populate the chart's structure and customizing the grid and axes. The goal is to visually represent soft skills from the weekly peer evaluations. I need to make sure the data is properly formatted.\n\n\n**Categorizing Top Performers**\n\nI am now structuring the code for the \"Top Performers\" section of the display, per the provided HTML template. I'm extracting and presenting the data of the `topPerformers` object, including their ranks, avatar URLs, and names. It's to be a visual and organized presentation.\n\n\n**Structuring Top Performer Data**\n\nI am now focusing on structuring the code for the \"Top Performers\" section using the HTML template. I'm taking the data from the `topPerformers` object and displaying ranks, avatar URLs, and student names. I aim to create a visual and organized presentation of the data within the dashboard.\n\n\n**Refining Wealth Chart Display**\n\nI am now focusing on refining the wealth distribution chart, specifically the BarChart component. I'm preparing to display both the top 10 and bottom 5 performers' wallet data. I'm reviewing the provided XML structure to ensure proper dataKey usage for the X and Y axes, ensuring the chart accurately reflects wealth disparities.\n\n\n",
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1768528558,
      "nanos": 56000000
    },
    "doneTimestamp": {
      "seconds": 1768528586,
      "nanos": 326000000
    }
  },
  {
    "id": 114,
    "author": "model",
    "payload": {
      "type": "text",
      "text": "<!-- Fix the import error in AdminAnalytics.tsx -->\n",
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1768528586,
      "nanos": 326000000
    },
    "doneTimestamp": {
      "seconds": 1768528586,
      "nanos": 342000000
    }
  },
  {
    "id": 115,
    "author": "model",
    "payload": {
      "type": "generationTable",
      "entries": [
        {
          "path": "components/AdminAnalytics.tsx",
          "generationType": 2,
          "isDone": true,
          "description": "Add PieChart to lucide-react imports to fix 'Cannot find name PieChart' error.",
          "diffs": [
            {
              "target": "",
              "replacement": "\nimport React, { useMemo } from 'react';\nimport { Agency, Student } from '../types';\nimport { ResponsiveContainer, ScatterChart, Scatter, XAxis, YAxis, CartesianGrid, Tooltip, Legend, BarChart, Bar, RadarChart, PolarGrid, PolarAngleAxis, PolarRadiusAxis, Radar } from 'recharts';\nimport { TrendingUp, Users, Wallet, Trophy, AlertTriangle, Lightbulb, Activity, PieChart } from 'lucide-react';\n\ninterface AdminAnalyticsProps {\n    agencies: Agency[];\n}\n\nexport const AdminAnalytics: React.FC<AdminAnalyticsProps> = ({ agencies }) => {\n    \n    // --- DATA PROCESSING ---\n    const activeAgencies = useMemo(() => agencies.filter(a => a.id !== 'unassigned'), [agencies]);\n    \n    const allStudents = useMemo(() => {\n        const students: (Student & { agencyName: string, agencyId: string })[] = [];\n        activeAgencies.forEach(a => {\n            a.members.forEach(m => students.push({ ...m, agencyName: a.name, agencyId: a.id }));\n        });\n        return students;\n    }, [activeAgencies]);\n\n    // 1. SCATTER DATA: TALENT vs AGENCY PERFORMANCE\n    const scatterData = useMemo(() => {\n        return activeAgencies.map(a => {\n            const avgScore = a.members.length > 0 \n                ? a.members.reduce((acc, m) => acc + m.individualScore, 0) / a.members.length \n                : 0;\n            return {\n                name: a.name,\n                ve: a.ve_current, // Y Axis\n                avgScore: Math.round(avgScore), // X Axis\n                classId: a.classId,\n                members: a.members.length\n            };\n        });\n    }, [activeAgencies]);\n\n    // 2. RADAR DATA: SOFT SKILLS (From Peer Reviews)\n    const radarData = useMemo(() => {\n        let totalAttendance = 0, totalQuality = 0, totalInvolvement = 0;\n        let count = 0;\n\n        activeAgencies.forEach(a => {\n            a.peerReviews.forEach(r => {\n                totalAttendance += r.ratings.attendance;\n                totalQuality += r.ratings.quality;\n                totalInvolvement += r.ratings.involvement;\n                count++;\n            });\n        });\n\n        if (count === 0) return [];\n\n        return [\n            { subject: 'Assiduité', A: parseFloat((totalAttendance / count).toFixed(2)), fullMark: 5 },\n            { subject: 'Qualité', A: parseFloat((totalQuality / count).toFixed(2)), fullMark: 5 },\n            { subject: 'Implication', A: parseFloat((totalInvolvement / count).toFixed(2)), fullMark: 5 },\n        ];\n    }, [activeAgencies]);\n\n    // 3. WEALTH DISTRIBUTION\n    const wealthData = useMemo(() => {\n        const sorted = [...allStudents].sort((a,b) => (b.wallet || 0) - (a.wallet || 0));\n        const top10 = sorted.slice(0, 10);\n        const flop5 = sorted.slice(-5).reverse();\n        return { top10, flop5 };\n    }, [allStudents]);\n\n    // 4. TOP PERFORMERS (High Potential)\n    const topPerformers = useMemo(() => {\n        return [...allStudents]\n            .sort((a,b) => b.individualScore - a.individualScore)\n            .slice(0, 5);\n    }, [allStudents]);\n\n    // Custom Tooltip for Scatter\n    const ScatterTooltip = ({ active, payload }: any) => {\n        if (active && payload && payload.length) {\n            const data = payload[0].payload;\n            return (\n                <div className=\"bg-white p-3 border border-slate-200 shadow-xl rounded-xl text-xs\">\n                    <p className=\"font-bold text-slate-900 mb-1\">{data.name}</p>\n                    <p className=\"text-indigo-600 font-bold\">VE: {data.ve}</p>\n                    <p className=\"text-slate-500\">Moy. Talent: {data.avgScore}/100</p>\n                    <p className=\"text-slate-400 italic\">{data.members} membres</p>\n                </div>\n            );\n        }\n        return null;\n    };\n\n    return (\n        <div className=\"animate-in fade-in duration-500 pb-20\">\n            <div className=\"mb-8\">\n                <h2 className=\"text-3xl font-display font-bold text-slate-900 flex items-center gap-3\">\n                    <div className=\"p-2 bg-purple-100 rounded-xl text-purple-700\"><PieChart size={32}/></div>\n                    Centre d'Analyse\n                </h2>\n                <p className=\"text-slate-500 text-sm mt-1\">\n                    Métriques avancées pour détecter les anomalies et les talents cachés.\n                </p>\n            </div>\n\n            {/* KPI ROW */}\n            <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4 mb-8\">\n                <div className=\"bg-white p-4 rounded-2xl border border-slate-200 shadow-sm flex items-center gap-4\">\n                    <div className=\"p-3 bg-indigo-50 rounded-xl text-indigo-600\"><Users size={24}/></div>\n                    <div>\n                        <p className=\"text-xs text-slate-400 font-bold uppercase\">Effectif Total</p>\n                        <p className=\"text-2xl font-bold text-slate-900\">{allStudents.length}</p>\n                    </div>\n                </div>\n                <div className=\"bg-white p-4 rounded-2xl border border-slate-200 shadow-sm flex items-center gap-4\">\n                    <div className=\"p-3 bg-emerald-50 rounded-xl text-emerald-600\"><Activity size={24}/></div>\n                    <div>\n                        <p className=\"text-xs text-slate-400 font-bold uppercase\">Moyenne Promo</p>\n                        <p className=\"text-2xl font-bold text-slate-900\">\n                            {Math.round(allStudents.reduce((acc, s) => acc + s.individualScore, 0) / Math.max(1, allStudents.length))}\n                            <span className=\"text-sm text-slate-400 font-medium\">/100</span>\n                        </p>\n                    </div>\n                </div>\n                <div className=\"bg-white p-4 rounded-2xl border border-slate-200 shadow-sm flex items-center gap-4\">\n                    <div className=\"p-3 bg-yellow-50 rounded-xl text-yellow-600\"><Wallet size={24}/></div>\n                    <div>\n                        <p className=\"text-xs text-slate-400 font-bold uppercase\">Masse Monétaire</p>\n                        <p className=\"text-2xl font-bold text-slate-900\">\n                            {(allStudents.reduce((acc, s) => acc + (s.wallet || 0), 0) / 1000).toFixed(1)}k\n                            <span className=\"text-sm text-slate-400 font-medium\"> px</span>\n                        </p>\n                    </div>\n                </div>\n                <div className=\"bg-white p-4 rounded-2xl border border-slate-200 shadow-sm flex items-center gap-4\">\n                    <div className=\"p-3 bg-red-50 rounded-xl text-red-600\"><AlertTriangle size={24}/></div>\n                    <div>\n                        <p className=\"text-xs text-slate-400 font-bold uppercase\">Agences Fragiles</p>\n                        <p className=\"text-2xl font-bold text-slate-900\">\n                            {activeAgencies.filter(a => a.ve_current < 40 || a.budget_real < 0).length}\n                        </p>\n                    </div>\n                </div>\n            </div>\n\n            <div className=\"grid grid-cols-1 xl:grid-cols-2 gap-8 mb-8\">\n                \n                {/* 1. SCATTER CHART: Matrix Talent/Performance */}\n                <div className=\"bg-white p-6 rounded-3xl border border-slate-200 shadow-sm\">\n                    <div className=\"flex justify-between items-start mb-6\">\n                        <div>\n                            <h3 className=\"text-lg font-bold text-slate-900 flex items-center gap-2\">\n                                <Lightbulb size={20} className=\"text-amber-500\"/> Matrice Talent / Performance\n                            </h3>\n                            <p className=\"text-xs text-slate-500 mt-1\">\n                                <strong>Haut-Gauche :</strong> Agence performante mais équipe faible (Leadeurs ?).<br/>\n                                <strong>Bas-Droite :</strong> Talents gâchés (Bons élèves, mauvaise gestion).\n                            </p>\n                        </div>\n                    </div>\n                    <div className=\"h-[350px] w-full\">\n                        <ResponsiveContainer width=\"100%\" height=\"100%\">\n                            <ScatterChart margin={{ top: 20, right: 20, bottom: 20, left: 0 }}>\n                                <CartesianGrid strokeDasharray=\"3 3\" />\n                                <XAxis type=\"number\" dataKey=\"avgScore\" name=\"Moyenne Talent\" unit=\"/100\" domain={[0, 100]} />\n                                <YAxis type=\"number\" dataKey=\"ve\" name=\"Valeur Agence\" unit=\" VE\" domain={[0, 100]} />\n                                <Tooltip content={<ScatterTooltip />} cursor={{ strokeDasharray: '3 3' }} />\n                                <Legend />\n                                <Scatter name=\"Agences\" data={scatterData} fill=\"#6366f1\" shape=\"circle\" />\n                            </ScatterChart>\n                        </ResponsiveContainer>\n                    </div>\n                </div>\n\n                {/* 2. RADAR CHART: Soft Skills */}\n                <div className=\"bg-white p-6 rounded-3xl border border-slate-200 shadow-sm flex flex-col\">\n                    <h3 className=\"text-lg font-bold text-slate-900 flex items-center gap-2 mb-2\">\n                        <Users size={20} className=\"text-emerald-500\"/> Radar RH (Moyenne Promo)\n                    </h3>\n                    <p className=\"text-xs text-slate-500 mb-4\">Basé sur les évaluations hebdomadaires entre pairs.</p>\n                    \n                    <div className=\"flex-1 min-h-[300px]\">\n                        {radarData.length > 0 ? (\n                            <ResponsiveContainer width=\"100%\" height=\"100%\">\n                                <RadarChart cx=\"50%\" cy=\"50%\" outerRadius=\"80%\" data={radarData}>\n                                    <PolarGrid stroke=\"#e2e8f0\" />\n                                    <PolarAngleAxis dataKey=\"subject\" tick={{ fill: '#64748b', fontSize: 12, fontWeight: 'bold' }} />\n                                    <PolarRadiusAxis angle={30} domain={[0, 5]} tick={false} />\n                                    <Radar name=\"Promo\" dataKey=\"A\" stroke=\"#10b981\" fill=\"#10b981\" fillOpacity={0.4} />\n                                    <Tooltip \n                                        contentStyle={{borderRadius: '12px', border: 'none', boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1)'}}\n                                        itemStyle={{color: '#065f46', fontWeight: 'bold'}}\n                                    />\n                                </RadarChart>\n                            </ResponsiveContainer>\n                        ) : (\n                            <div className=\"h-full flex items-center justify-center text-slate-400 text-sm italic\">\n                                Pas assez de données RH.\n                            </div>\n                        )}\n                    </div>\n                </div>\n            </div>\n\n            <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-8\">\n                \n                {/* 3. HIGH POTENTIALS */}\n                <div className=\"bg-slate-900 rounded-3xl p-6 text-white shadow-xl lg:col-span-1\">\n                    <h3 className=\"text-lg font-bold flex items-center gap-2 mb-6\">\n                        <Trophy size={20} className=\"text-yellow-400\"/> Top Performers\n                    </h3>\n                    <div className=\"space-y-4\">\n                        {topPerformers.map((student, i) => (\n                            <div key={student.id} className=\"flex items-center gap-3 p-3 bg-white/10 rounded-xl border border-white/5\">\n                                <div className=\"font-bold text-lg text-white/50 w-6\">#{i+1}</div>\n                                <img src={student.avatarUrl} className=\"w-10 h-10 rounded-full bg-slate-800\" />\n                                <div className=\"flex-1 overflow-hidden\">\n                                    <p className=\"font-bold text-sm truncate\">{student.name}</p>\n                                    <p className=\"text-[10px] text-slate-400 truncate\">{student.agencyName}</p>\n                                </div>\n                                <div className=\"text-right\">\n                                    <span className=\"block font-bold text-emerald-400\">{student.individualScore}</span>\n                                    <span className=\"text-[10px] text-slate-500\">SCORE</span>\n                                </div>\n                            </div>\n                        ))}\n                    </div>\n                </div>\n\n                {/* 4. WEALTH DISTRIBUTION */}\n                <div className=\"bg-white rounded-3xl p-6 border border-slate-200 shadow-sm lg:col-span-2\">\n                    <h3 className=\"text-lg font-bold text-slate-900 flex items-center gap-2 mb-6\">\n                        <TrendingUp size={20} className=\"text-indigo-500\"/> Inégalités Économiques (Top 10 vs Flop 5)\n                    </h3>\n                    <div className=\"h-[300px]\">\n                        <ResponsiveContainer width=\"100%\" height=\"100%\">\n                            <BarChart\n                                data={[...wealthData.top10, ...wealthData.flop5]}\n                                margin={{ top: 5, right: 30, left: 20, bottom: 5 }}\n                            >\n                                <CartesianGrid strokeDasharray=\"3 3\" vertical={false} stroke=\"#f1f5f9\"/>\n                                <XAxis dataKey=\"name\" tick={{fontSize: 10}} interval={0} angle={-20} textAnchor=\"end\" height={60}/>\n                                <YAxis />\n                                <Tooltip \n                                    cursor={{fill: '#f8fafc'}}\n                                    contentStyle={{borderRadius: '12px', border: '1px solid #e2e8f0'}}\n                                />\n                                <Bar dataKey=\"wallet\" fill=\"#6366f1\" radius={[4, 4, 0, 0]} />\n                            </BarChart>\n                        </ResponsiveContainer>\n                    </div>\n                </div>\n            </div>\n        </div>\n    );\n};\n"
            }
          ]
        }
      ]
    },
    "createdTimestamp": {
      "seconds": 1768528586,
      "nanos": 342000000
    },
    "doneTimestamp": {
      "seconds": 1768528606,
      "nanos": 92000000
    }
  },
  {
    "id": 117,
    "author": "user",
    "payload": {
      "type": "text",
      "text": "J'aimerais que tu calcule aussi une nouvelle unité pour les étudiants\n\nmais qui soit totalement secrète pour eux\n\nle karma\n\net je veux que tu fasse en sorte que le karma soit calculé suivant les actions posées par les étudiants\n\net que je puisse en tant qu'enseignant voir le karma, mais seulement moi",
      "files": [],
      "fileUploads": [],
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1768528954,
      "nanos": 673000000
    }
  },
  {
    "id": 118,
    "author": "model",
    "payload": {
      "type": "thinking",
      "text": "**Defining the Parameters**\n\nI've initiated the \"Karma\" system implementation by carefully defining its parameters. My focus is now on meticulously analyzing the user request to grasp the precise goal – introducing this new metric for students. I'm also ensuring a rigid separation: keeping it strictly confidential from students, with complete teacher (admin) visibility. I will ensure to consider other constraints.\n\n\n**Elaborating the \"Vibe\"**\n\nNow, I'm diving deep into the \"Vibe\" logic for Karma calculation. Positive actions, like peer reviews and financial aid, will increase it, with varying point values assigned. I've begun to consider negative actions, like late submissions, but am still working through the precise impact. There's a nascent data structure to hold this, a new 'karma' field for students, initializing at zero. I need to keep the UI constraints in mind.\n\n\n**Finalizing the Penalties**\n\nI've finalized the penalty values and triggered action on grades. Late submissions now deduct 5 Karma points per day, getting fired results in a 20-point decrease, and resignation leads to a 10-point reduction. Receiving a \"C\" grade results in a 5-point deduction. I've begun making the necessary UI updates to ensure Admin-only visibility. I now plan to update the leaderboard and introduce visual indicators.\n\n\n**Incorporating Secret Metrics**\n\nI'm now integrating the \"Secret Data\" aspect seamlessly within the existing system. This involved a series of precise code adjustments. First, I added the `karma: number;` field to the `Student` type definition, in `types.ts`. Next, I updated logic hooks, including `TeamView.tsx` for peer reviews, `useFinanceLogic.ts` for financial adjustments, and `GradingModal.tsx` to reflect grade and lateness-based Karma impacts. Finally, I'm updating the Admin UI to include a dedicated, hidden section for Karma and updating the mock data to initialize Karma for mock students.\n\n\n**Hiding the Field**\n\nI'm now carefully implementing the new \"Karma\" field, making certain that it remains confidential. My current priority is to ensure the `StudentAgencyView` component *never* displays the `student.karma` value. I'm focusing on the state update logic in the parent or context, ensuring the UI only triggers the action.\n\n\n\n**Executing the Implementation**\n\nNow, I'm integrating Karma into the grading logic and planning its visualization in AdminAnalytics. I'm leaving StudentAgencyView and WalletView untouched to uphold the confidentiality. In `TeamView`, I'm updating `handlePeerReview` to increment the reviewer's karma within the members array. In `GradingModal`, I'm implementing a collective karma penalty for lateness across agency members, with MVP receiving an additional individual karma boost. Finally, I'll work on the `AdminAnalytics` visualization.\n\n\n**Visualizing the Data**\n\nI'm now integrating the \"Karma\" data into the `AdminAnalytics` component. I'm focusing on the implementation of a toggle labeled \"👁️ Afficher le Karma\" to control the visibility of this hidden layer within the Admin view. Also, I've confirmed that the `PieChart` is correctly imported from `lucide-react`. I've updated the karma logic with the values to be included. I've updated logic with new values: **Don (Transfert)** : +5 Karma (Générosité), **Investissement (Injection)** : +10 Karma (Dévouement), **Reviewer (Donner une note)** : +1 Karma (Participation), **MVP (Grading)** : +15 Karma (Excellence), **Retard (Grading)** : -2 Karma per day late (Manque de rigueur, applied to the entire team), **Absence (Peer Review < 2/5)** : -5 Karma (Ghosting).\n\n\n",
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1768528954,
      "nanos": 673000000
    },
    "doneTimestamp": {
      "seconds": 1768528979,
      "nanos": 235000000
    }
  },
  {
    "id": 119,
    "author": "model",
    "payload": {
      "type": "text",
      "text": "C'est une excellente idée pour ajouter une couche de profondeur \"invisible\" à la gestion de classe. Le **Karma** servira de \"Note de Comportement 2.0\", calculée automatiquement par le système sans que les étudiants ne puissent la \"gamer\" puisqu'ils ne la voient pas.\n\nVoici les spécifications pour l'intégration du système **Karma** :\n\n1.  **Structure de Données** : Ajout du champ `karma` (number) au profil Étudiant. Départ à 0.\n2.  **Règles de Calcul (Backend Logic)** :\n    *   **Altruisme (Transfert d'argent)** : +5 Karma (Aider un collègue).\n    *   **Dévouement (Injection Capital)** : +10 Karma (Sauver l'agence).\n    *   **Participation (Faire une Review)** : +2 Karma (Jouer le jeu RH).\n    *   **Excellence (MVP)** : +15 Karma (Porteur de projet).\n    *   **Négligence (Retard Rendu)** : -2 Karma par jour de retard (Collectif).\n    *   **Toxicité (Note reçue < 2/5)** : -5 Karma (Sanction sociale par les pairs).\n3.  **Visualisation (Admin Only)** :\n    *   Mise à jour du module **Analytics** pour inclure un onglet \"Karma Police\" qui révèle les scores cachés.\n    *   Les étudiants ne verront **jamais** cette valeur sur leur interface.\n\nVoici les modifications :\n\n",
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1768528979,
      "nanos": 235000000
    },
    "doneTimestamp": {
      "seconds": 1768528979,
      "nanos": 235000000
    }
  },
  {
    "id": 120,
    "author": "model",
    "payload": {
      "type": "generationTable",
      "entries": [
        {
          "path": "types.ts",
          "generationType": 1,
          "isDone": true,
          "description": "Ajout de la propriété Karma au type Student.",
          "diffs": [
            {
              "target": "",
              "replacement": "\nexport enum CycleType {\n  MARQUE_BRIEF = \"Cycle 1: Marque & Brief\",\n  NARRATION_IA = \"Cycle 2: Narration & IA\",\n  LOOKDEV = \"Cycle 3: Look-dev & Sélection\",\n  PACKAGING = \"Cycle 4: Packaging & Soutenance\"\n}\n\nexport interface PeerReview {\n  id: string;\n  date: string;\n  weekId: string;\n  reviewerId: string;\n  reviewerName: string;\n  targetId: string;\n  targetName: string;\n  ratings: {\n    attendance: number; // 1-5\n    quality: number; // 1-5\n    involvement: number; // 1-5\n  };\n  comment: string;\n}\n\n// NOUVEAU : Types de livrables pour le Mission Builder\nexport type DeliverableType = 'FILE' | 'LINK' | 'FORM_CHARTER' | 'FORM_NAMING' | 'SPECIAL_LOGO' | 'SPECIAL_BANNER';\n\nexport interface Deliverable {\n  id: string;\n  name: string;\n  description: string;\n  type?: DeliverableType; // NOUVEAU CHAMP (Optionnel pour rétrocompatibilité, défaut = FILE)\n  status: 'pending' | 'submitted' | 'validated' | 'rejected';\n  score?: number; // 0-100\n  feedback?: string;\n  fileUrl?: string;\n  deadline?: string; // NOUVEAU: Date limite de rendu\n  // Grading Details\n  submissionDate?: string;\n  grading?: {\n    quality: 'A' | 'B' | 'C' | 'REJECTED';\n    daysLate: number;\n    constraintBroken: boolean;\n    finalDelta: number;\n    mvpId?: string; // NEW: The student who carried the task\n  }\n}\n\nexport interface ClassSession {\n    date: string; // YYYY-MM-DD\n    slot: 'MATIN' | 'APRÈS-MIDI' | 'JOURNÉE';\n}\n\nexport interface WeekModule {\n  id: string;\n  title: string;\n  type: 'FUN/CHILL' | 'THÉORIE' | 'TECHNIQUE' | 'JURY';\n  objectives: string[];\n  deliverables: Deliverable[];\n  locked: boolean;\n  status?: 'pending' | 'in_progress' | 'validated';\n  schedule: {\n      classA: ClassSession | null;\n      classB: ClassSession | null;\n  };\n}\n\n// --- NEW: STUDENT HISTORY ---\nexport interface StudentHistoryEntry {\n    date: string;\n    agencyId: string;\n    agencyName: string;\n    action: 'JOINED' | 'LEFT' | 'FIRED' | 'RESIGNED' | 'MERGED';\n    contextVE: number;      // VE de l'agence au moment du départ/arrivée\n    contextBudget: number;  // Tréso de l'agence au moment du départ/arrivée\n    reason?: string;        // Motif (ex: \"Licenciement économique\", \"Démission\")\n}\n\nexport interface Badge {\n    id: string;\n    label: string;\n    description: string;\n    icon: string; // Identifier for Lucide icon or image path\n    unlockedAt?: string;\n}\n\nexport interface Student {\n  id: string;\n  name: string;\n  email?: string; // AJOUT : Email pour les notifications\n  role: string; // Standardisé (ex: \"Associé\")\n  avatarUrl: string;\n  individualScore: number; // 0-100\n  wallet: number; // NEW: Personal Funds in PiXi\n  karma?: number; // NEW: Hidden score based on behavior (+ = Altruiste, - = Toxique)\n  cvUrl?: string; // URL vers le PDF du CV\n  classId: 'A' | 'B'; // Gestion des deux promotions\n  connectionStatus?: 'online' | 'offline' | 'pending';\n  history?: StudentHistoryEntry[]; // Parcours professionnel\n  badges?: Badge[]; // NEW: Individual Badges\n  streak?: number; // NEW: Streak for performance\n}\n\nexport type EventType = 'CRISIS' | 'VE_DELTA' | 'BUDGET_DELTA' | 'CHECKPOINT' | 'INFO' | 'PAYROLL' | 'REVENUE' | 'BLACK_OP' | 'MERGER';\n\nexport interface GameEvent {\n  id: string;\n  date: string; // ISO String\n  type: EventType;\n  label: string; // Titre court (ex: \"Pénurie matériaux\")\n  description?: string;\n  deltaVE?: number; // Impact sur la VE (ex: -15)\n  deltaBudgetReal?: number;\n  deltaBudgetValued?: number;\n}\n\nexport interface ProjectDefinition {\n  problem: string;      // Problème réel et local\n  target: string;       // Qui souffre (Persona)\n  location: string;     // Où ça se passe\n  gesture: string;      // Geste architectural unique\n  theme?: string;       // NOUVEAU: Thématique globale\n  direction?: string;   // NOUVEAU: Direction Artistique / Intention\n  context?: string;     // NOUVEAU: Contexte sociétal ou urbain\n  isLocked: boolean;    // Validé par le prof ?\n}\n\nexport interface MercatoRequest {\n  id: string;\n  type: 'HIRE' | 'FIRE' | 'FOUND_AGENCY'; \n  studentId: string; // La cible du mouvement\n  studentName: string;\n  requesterId?: string; // Qui a fait la demande\n  targetAgencyId: string; // L'agence concernée (ou 'new' pour foundation)\n  status: 'PENDING' | 'REJECTED';\n  date: string;\n  motivation?: string; // Texte justificatif\n  votes?: { [studentId: string]: 'APPROVE' | 'REJECT' }; \n}\n\n// --- NEW: CHALLENGE REQUEST (AI GENERATED) ---\nexport interface ChallengeRequest {\n    id: string;\n    title: string;\n    description: string;\n    status: 'PENDING_VOTE' | 'ACCEPTED' | 'REJECTED';\n    date: string;\n    rewardVE: number; // Bonus si réussi\n    votes: { [studentId: string]: 'APPROVE' | 'REJECT' };\n}\n\n// --- NEW: MERGER REQUEST ---\nexport interface MergerRequest {\n    id: string;\n    requesterAgencyId: string;\n    requesterAgencyName: string;\n    targetAgencyId: string; // L'agence qui va se faire absorber\n    status: 'PENDING' | 'REJECTED';\n    date: string;\n    offerDetails: string; // Description de l'offre (ex: \"Rachat de dette\")\n}\n\n// --- NEW: FINANCIAL REQUESTS ---\nexport interface TransactionRequest {\n    id: string;\n    studentId: string;\n    studentName: string;\n    type: 'BUY_SCORE';\n    amountPixi: number;\n    amountScore: number;\n    status: 'PENDING' | 'REJECTED';\n    date: string;\n}\n\n// --- NEW: AI ANALYSIS TYPES ---\nexport interface AIInsight {\n    id: string;\n    type: 'URGENT' | 'WARNING' | 'OPPORTUNITY';\n    title: string;\n    analysis: string; // L'explication du \"Pourquoi\"\n    suggestedAction: {\n        label: string;\n        actionType: 'CRISIS' | 'REWARD' | 'MESSAGE' | 'AUDIT';\n        payload?: any; // Données pour pré-remplir l'action\n    };\n    targetAgencyId?: string;\n    targetStudentId?: string;\n}\n\n// --- NEW TYPES FOR GAMIFICATION ---\n\nexport type BrandColor = 'indigo' | 'emerald' | 'rose' | 'amber' | 'cyan' | 'slate';\n\nexport interface AgencyBranding {\n    color: BrandColor;\n    bannerUrl?: string;\n}\n\nexport interface Agency {\n  id: string;\n  name: string;\n  tagline: string;\n  logoUrl?: string;\n  members: Student[];\n  peerReviews: PeerReview[];\n  classId: 'A' | 'B' | 'ALL'; // ALL pour l'agence Chômage\n  \n  // Data Driven by Events\n  ve_current: number; // 0-100 (La note/valeur)\n  veCapOverride?: number; // NEW: Manual override for the VE Ceiling\n  budget_real: number; // En PiXi\n  budget_valued: number; // En PiXi\n  weeklyTax: number; // Pourcentage de charges hebdo (0.1 = 10%)\n  weeklyRevenueModifier: number; // Bonus/Malus récurrent en PiXi (ex: +500 par semaine grâce à un prix)\n  \n  status: 'stable' | 'fragile' | 'critique';\n  \n  eventLog: GameEvent[]; // Source of Truth\n  \n  currentCycle: CycleType;\n  \n  // New Project Structure\n  projectDef: ProjectDefinition;\n  \n  // Mercato Requests (Pending)\n  mercatoRequests: MercatoRequest[];\n  \n  // Financial Requests (Pending)\n  transactionRequests: TransactionRequest[];\n\n  // Merger Requests (Pending)\n  mergerRequests?: MergerRequest[];\n\n  // Active Challenges (AI)\n  challenges?: ChallengeRequest[];\n\n  // Legacy constraints\n  constraints: {\n    space: string;\n    style: string;\n    client: string;\n  };\n  \n  progress: {\n    [weekId: string]: WeekModule;\n  };\n\n  // --- NEW FIELDS ---\n  branding: AgencyBranding;\n  badges: Badge[];\n}\n\nexport interface AppState {\n  userRole: 'admin' | 'student';\n  selectedAgencyId: string | null;\n  agencies: Agency[];\n}\n\nexport interface CrisisPreset {\n  label: string;\n  description: string;\n  deltaVE: number;\n  deltaBudget: number;\n  icon: any;\n}\n\n// --- NEW: AWARDS ---\nexport interface CycleAwardDefinition {\n    id: string;\n    cycleId: CycleType;\n    title: string;\n    description: string;\n    veBonus: number;\n    weeklyBonus: number; // En PiXi/semaine (Récurrent)\n    iconName: 'compass' | 'mic' | 'eye' | 'crown';\n}\n\n// --- WIKI / RESOURCES ---\nexport interface WikiResource {\n    id: string;\n    title: string;\n    description?: string;\n    type: 'PDF' | 'VIDEO' | 'LINK' | 'ASSET';\n    url: string;\n    targetClass: 'ALL' | 'A' | 'B';\n    date: string;\n}\n"
            }
          ]
        },
        {
          "path": "config/teams.ts",
          "generationType": 1,
          "isDone": true,
          "description": "Initialisation du Karma à 0 pour les étudiants fictifs.",
          "diffs": [
            {
              "target": "",
              "replacement": "\nimport { Agency, CycleType, GameEvent, Student, Badge } from '../types';\nimport { BADGE_DEFINITIONS, S1_INDIVIDUAL_WINNERS, S1_AVERAGES } from './awards';\nimport { INITIAL_WEEKS } from './weeks';\nimport { GAME_RULES } from './rules';\n\n// --- LISTES DE RÉFÉRENCE POUR LES BADGES S1 (L'HISTORIQUE) ---\n// Ces listes servent uniquement à distribuer les badges aux bonnes personnes\nconst S1_GOLD_MEMBERS = [\"Zirwath\", \"Aubine\", \"Maëlys\", \"Tiffany\", \"Roxane\"];\nconst S1_SILVER_MEMBERS = [\"Rayane\", \"Erudice\", \"Pascal\", \"Jennifer\"];\nconst S1_BRONZE_MEMBERS = [\"Tryphose\", \"Sarah\", \"Grâce\", \"Stessy\"];\n\n// --- POOLS COMPLETS (POUR RÉFÉRENCE ET CHÔMAGE) ---\nconst STUDENTS_CLASSE_A_POOL = [\n    \"Marie-Trinité\", \"Jessica\", \"Lydia\", \"Ronelle\", \"Tiffany\",\n    \"Ian\", \"Kassandra\", \"Aubine\", \"Lidwine\", \"Sarah\",\n    \"Maëlys\", \"Rebecca\", \"Rolyx\", \"Emeraude\", \"Shaneen\",\n    \"Noriane\", \"Pascal\", \"Roxane\", \"Loan\", \"Korell\", \"Iris\"\n];\n\nconst STUDENTS_CLASSE_B_POOL = [\n    \"Tryphose\", \"Vianney\", \"Esther\", \"Achabys\", \"Zirwath\",\n    \"Elicia\", \"Loïs\", \"Coralie\", \"Ruth\", \"Lindsay\",\n    \"Ghintia\", \"Rayane\", \"Ashley\", \"Faghez\", \"Erudice\",\n    \"Myra\", \"Brunelle\", \"Stessy\", \"Duamel\", \"Grâce\", \"Jennifer\"\n];\n\n// --- DEFINITION DES EQUIPES MANUELLES ---\nconst TEAMS_A_SPECIFIC = [\n    [\"Roxane\", \"Sarah\"],\n    [\"Maëlys\", \"Ronelle\"],\n    [\"Iris\", \"Aubine\", \"Jessica\"],\n    [\"Shaneen\", \"Lydia\"],\n    [\"Rebecca\", \"Korell\"],\n    [\"Kassandra\", \"Pascal\"]\n];\n\nconst TEAMS_B_SPECIFIC = [\n    [\"Rayane\"],\n    [\"Faghez\", \"Achabys\"],\n    [\"Coralie\", \"Myra\"],\n    [\"Grâce\", \"Ashley\", \"Tryphose\"],\n    [\"Ruth\", \"Loïs\", \"Brunelle\"], // \"Ruth\" correspond à Ruth-De-Franck dans les stats S1\n    [\"Esther\", \"Erudice\"]\n];\n\nconst generateMockAgencies = (): Agency[] => {\n  const agencies: Agency[] = [];\n  let globalStudentIndex = 0;\n\n  // --- FONCTION DE CRÉATION D'ÉTUDIANT ---\n  const createStudent = (name: string, classId: 'A' | 'B'): Student => {\n      // 1. Récupération des données S1 (Score & Awards)\n      const individualAward = S1_INDIVIDUAL_WINNERS[name];\n      const averageS1 = S1_AVERAGES[name] || 10;\n      \n      // 2. Calcul du Score de départ S2\n      // Formule : SMIG (30) + Moyenne S1 (x2 pour base 40) + Bonus Badges (Indiv + Group)\n      const baseScore = 30;\n      const s1Part = averageS1 * 2;\n      \n      let bonusScore = 0;\n\n      // A. Bonus Badges Individuels\n      // Or = 10, Argent = 7.5, Bronze = 5\n      if (individualAward) {\n          if (individualAward.badge === 's1_gold') bonusScore += 10;\n          else if (individualAward.badge === 's1_silver') bonusScore += 7.5;\n          else if (individualAward.badge === 's1_bronze') bonusScore += 5;\n      }\n\n      // B. Bonus Badges Groupe\n      // Or = 10, Argent = 7.5, Bronze = 5\n      if (S1_GOLD_MEMBERS.includes(name)) {\n          bonusScore += 10; \n      } else if (S1_SILVER_MEMBERS.includes(name)) {\n          bonusScore += 7.5;\n      } else if (S1_BRONZE_MEMBERS.includes(name)) {\n          bonusScore += 5;\n      }\n\n      const calculatedScore = Math.round(baseScore + s1Part + bonusScore);\n\n      // 3. Attribution des Badges (Visuels)\n      const studentBadges: Badge[] = [];\n\n      // A. Badge Individuel (Major, Vice-Major...)\n      if (individualAward) {\n          const badgeDef = BADGE_DEFINITIONS.find(b => b.id === individualAward.badge);\n          if (badgeDef) studentBadges.push(badgeDef);\n      }\n\n      // B. Badge Historique Groupe S1 (Or/Argent/Bronze)\n      if (S1_GOLD_MEMBERS.includes(name)) {\n          const b = BADGE_DEFINITIONS.find(def => def.id === 's1_gold_group');\n          if (b) studentBadges.push(b);\n      }\n      if (S1_SILVER_MEMBERS.includes(name)) {\n          const b = BADGE_DEFINITIONS.find(def => def.id === 's1_silver_group');\n          if (b) studentBadges.push(b);\n      }\n      if (S1_BRONZE_MEMBERS.includes(name)) {\n          const b = BADGE_DEFINITIONS.find(def => def.id === 's1_bronze_group');\n          if (b) studentBadges.push(b);\n      }\n\n      return {\n        id: `s-${globalStudentIndex++}`, // ID technique unique\n        name: name,\n        role: 'Associé',\n        avatarUrl: `https://api.dicebear.com/7.x/avataaars/svg?seed=${name.replace(' ', '')}`,\n        individualScore: calculatedScore,\n        wallet: individualAward ? individualAward.amount : 0, // Cash prize S1 si applicable\n        karma: 0, // Karma initial neutre\n        classId: classId,\n        connectionStatus: 'offline',\n        badges: studentBadges, // Liste des badges calculée\n        history: individualAward ? [{\n            date: \"2024-02-01\",\n            agencyId: \"system\",\n            agencyName: \"RNP Awards\",\n            action: \"JOINED\",\n            contextVE: 0,\n            contextBudget: 0,\n            reason: `Prix S1 (+${individualAward.amount} PiXi)`\n        }] : []\n      };\n  };\n\n  // --- 1. CRÉATION DES AGENCES CLASSE A (Assignées) ---\n  TEAMS_A_SPECIFIC.forEach((membersNames, index) => {\n      const agencyNum = index + 1;\n      const agencyId = `agency_A_${agencyNum}`;\n      const members = membersNames.map(name => createStudent(name, 'A'));\n\n      agencies.push({\n          id: agencyId,\n          name: `Agence A${agencyNum}`,\n          tagline: \"Nouvelle Agence S2\",\n          ve_current: 0, // START AT 0\n          status: 'critique', // Start in critic because VE < 40\n          classId: 'A',\n          budget_real: 0,\n          budget_valued: 0,\n          weeklyTax: 0,\n          weeklyRevenueModifier: 0,\n          eventLog: [\n             { id: `e-${agencyId}-1`, date: \"2024-02-01\", type: \"INFO\", label: \"Création Agence\", deltaVE: 0, description: \"Ouverture du compte PiXi (0).\" }\n          ],\n          members: members,\n          peerReviews: [],\n          currentCycle: CycleType.MARQUE_BRIEF,\n          projectDef: { problem: \"\", target: \"\", location: \"\", gesture: \"\", isLocked: false },\n          mercatoRequests: [],\n          transactionRequests: [], // Init empty\n          constraints: { space: \"\", style: \"\", client: \"\" },\n          progress: JSON.parse(JSON.stringify(INITIAL_WEEKS)),\n          branding: { color: 'indigo' }, // Couleur par défaut Classe A\n          badges: []\n      });\n  });\n\n  // --- 2. CRÉATION DES AGENCES CLASSE B (Assignées) ---\n  TEAMS_B_SPECIFIC.forEach((membersNames, index) => {\n      const agencyNum = index + 1;\n      const agencyId = `agency_B_${agencyNum}`;\n      const members = membersNames.map(name => createStudent(name, 'B'));\n\n      agencies.push({\n          id: agencyId,\n          name: `Agence B${agencyNum}`,\n          tagline: \"Nouvelle Agence S2\",\n          ve_current: 0, // START AT 0\n          status: 'critique',\n          classId: 'B',\n          budget_real: 0,\n          budget_valued: 0,\n          weeklyTax: 0,\n          weeklyRevenueModifier: 0,\n          eventLog: [\n             { id: `e-${agencyId}-1`, date: \"2024-02-01\", type: \"INFO\", label: \"Création Agence\", deltaVE: 0, description: \"Ouverture du compte PiXi (0).\" }\n          ],\n          members: members,\n          peerReviews: [],\n          currentCycle: CycleType.MARQUE_BRIEF,\n          projectDef: { problem: \"\", target: \"\", location: \"\", gesture: \"\", isLocked: false },\n          mercatoRequests: [],\n          transactionRequests: [], // Init empty\n          constraints: { space: \"\", style: \"\", client: \"\" },\n          progress: JSON.parse(JSON.stringify(INITIAL_WEEKS)),\n          branding: { color: 'cyan' }, // Couleur par défaut Classe B\n          badges: []\n      });\n  });\n\n  // --- 3. GESTION DES CHÔMEURS (Tous ceux qui ne sont pas dans les listes spécifiques) ---\n  const assignedA = TEAMS_A_SPECIFIC.flat();\n  const assignedB = TEAMS_B_SPECIFIC.flat();\n\n  const unemployedMembers: Student[] = [];\n\n  // Filtrer Classe A\n  STUDENTS_CLASSE_A_POOL.forEach(name => {\n      if (!assignedA.includes(name)) {\n          unemployedMembers.push(createStudent(name, 'A'));\n      }\n  });\n\n  // Filtrer Classe B\n  STUDENTS_CLASSE_B_POOL.forEach(name => {\n      if (!assignedB.includes(name)) {\n          unemployedMembers.push(createStudent(name, 'B'));\n      }\n  });\n\n  // Agence Chômage / Vivier\n  agencies.push({\n      id: 'unassigned',\n      name: \"Vivier / Chômage\",\n      tagline: \"En recherche d'opportunité\",\n      ve_current: 0,\n      status: 'critique',\n      classId: 'ALL', \n      budget_real: 0,\n      budget_valued: 0,\n      weeklyTax: 0,\n      weeklyRevenueModifier: 0,\n      eventLog: [],\n      members: unemployedMembers, // Tous les restants\n      peerReviews: [],\n      currentCycle: CycleType.MARQUE_BRIEF,\n      projectDef: { problem: \"\", target: \"\", location: \"\", gesture: \"\", isLocked: true },\n      mercatoRequests: [],\n      transactionRequests: [],\n      constraints: { space: \"\", style: \"\", client: \"\" },\n      progress: {},\n      branding: { color: 'slate' },\n      badges: []\n  });\n\n  return agencies;\n};\n\nexport const MOCK_AGENCIES: Agency[] = generateMockAgencies();\n"
            }
          ]
        },
        {
          "path": "contexts/game/useFinanceLogic.ts",
          "generationType": 1,
          "isDone": true,
          "description": "Mise à jour de la logique financière pour impacter le Karma lors des transferts et injections.",
          "diffs": [
            {
              "target": "",
              "replacement": "\nimport { writeBatch, doc, updateDoc, db } from '../../services/firebase';\nimport { Agency, GameEvent, TransactionRequest } from '../../types';\nimport { GAME_RULES } from '../../constants';\n\nexport const useFinanceLogic = (agencies: Agency[], toast: (type: string, msg: string) => void) => {\n\n  const processFinance = async (targetClass: 'A' | 'B') => {\n      const today = new Date().toISOString().split('T')[0];\n      try {\n        const batch = writeBatch(db);\n        let processedCount = 0;\n\n        agencies.forEach(agency => {\n            if (agency.id === 'unassigned' || agency.classId !== targetClass) return;\n            processedCount++;\n\n            let currentBudget = agency.budget_real;\n            let logEvents: GameEvent[] = [];\n            // SAFETY: Ensure members array exists\n            let agencyMembers = [...(agency.members || [])];\n\n            // 1. REVENUES\n            const revenueVE = (agency.ve_current * GAME_RULES.REVENUE_VE_MULTIPLIER);\n            const bonuses = agency.weeklyRevenueModifier || 0;\n            const totalRevenue = revenueVE + bonuses + GAME_RULES.REVENUE_BASE;\n            \n            currentBudget += totalRevenue;\n            logEvents.push({ \n                id: `fin-rev-${Date.now()}-${agency.id}`, \n                date: today, \n                type: 'REVENUE', \n                label: 'Recettes', \n                deltaBudgetReal: totalRevenue, \n                description: `Facturation client (VE: ${agency.ve_current}).` \n            });\n\n            // 2. RENT & SOLIDARITY CLAUSE\n            const rent = GAME_RULES.AGENCY_RENT;\n            if (currentBudget >= rent) {\n                currentBudget -= rent;\n                logEvents.push({ id: `fin-rent-${Date.now()}-${agency.id}`, date: today, type: 'CRISIS', label: 'Loyer Agence', deltaBudgetReal: -rent, description: `Prélèvement automatique.` });\n            } else {\n                const paidByAgency = Math.max(0, currentBudget); \n                const deficit = rent - paidByAgency;\n                currentBudget -= paidByAgency; \n                \n                const membersCount = Math.max(1, agencyMembers.length);\n                const sharePerStudent = Math.ceil(deficit / membersCount);\n\n                logEvents.push({ \n                    id: `fin-rent-solidarity-${Date.now()}-${agency.id}`, \n                    date: today, \n                    type: 'CRISIS', \n                    label: 'CLAUSE SOLIDARITÉ', \n                    deltaBudgetReal: -paidByAgency, \n                    description: `Défaut de paiement. ${sharePerStudent} PiXi saisis sur chaque membre.` \n                });\n\n                agencyMembers = agencyMembers.map(m => ({\n                    ...m,\n                    wallet: (m.wallet || 0) - sharePerStudent\n                }));\n            }\n\n            // 3. SALARIES\n            let actualDisbursed = 0;\n            if (currentBudget >= 0) {\n                agencyMembers = agencyMembers.map(member => {\n                    const rawSalary = member.individualScore * GAME_RULES.SALARY_MULTIPLIER; \n                    const pay = Math.min(rawSalary, GAME_RULES.SALARY_CAP_FOR_STUDENT);\n                    actualDisbursed += pay;\n                    return { ...member, wallet: (member.wallet || 0) + pay };\n                });\n                \n                currentBudget -= actualDisbursed;\n                logEvents.push({ id: `fin-pay-${Date.now()}-${agency.id}`, date: today, type: 'PAYROLL', label: 'Salaires', deltaBudgetReal: -actualDisbursed, description: `Salaires versés.` });\n            } else {\n                logEvents.push({ id: `fin-pay-${Date.now()}-${agency.id}`, date: today, type: 'PAYROLL', label: 'Salaires Gelés', deltaBudgetReal: 0, description: `Dette active. Pas de salaire.` });\n            }\n\n            // 4. COST OF LIVING\n            agencyMembers = agencyMembers.map(member => {\n                let newWallet = (member.wallet || 0) - GAME_RULES.COST_OF_LIVING;\n                let newScore = member.individualScore;\n                if (newWallet < 0) {\n                    newScore = Math.max(0, newScore - GAME_RULES.POVERTY_SCORE_PENALTY);\n                }\n                return { ...member, wallet: newWallet, individualScore: newScore };\n            });\n\n            const ref = doc(db, \"agencies\", agency.id);\n            batch.update(ref, {\n                budget_real: currentBudget,\n                members: agencyMembers,\n                eventLog: [...agency.eventLog, ...logEvents]\n            });\n        });\n\n        if (processedCount > 0) {\n            await batch.commit();\n            toast('success', `Finance Classe ${targetClass}: Traitement Terminé.`);\n        }\n      } catch(e) { console.error(e); toast('error', \"Erreur Finance\"); }\n  };\n\n  const transferFunds = async (sourceId: string, targetId: string, amount: number) => { \n      const sourceAgency = agencies.find(a => a.members.some(m => m.id === sourceId));\n      if (!sourceAgency) return;\n      \n      const sourceStudent = sourceAgency.members.find(m => m.id === sourceId);\n      if(!sourceStudent || (sourceStudent.wallet || 0) < amount) {\n          toast('error', \"Fonds insuffisants.\");\n          return;\n      }\n\n      const targetAgency = agencies.find(a => a.members.some(m => m.id === targetId));\n      if(!targetAgency) return;\n\n      const batch = writeBatch(db);\n\n      // Debit source & KARMA BONUS (Altruisme)\n      const updatedSourceMembers = sourceAgency.members.map(m => \n          m.id === sourceId \n          ? { ...m, wallet: (m.wallet || 0) - amount, karma: (m.karma || 0) + 5 } \n          : m\n      );\n      batch.update(doc(db, \"agencies\", sourceAgency.id), { members: updatedSourceMembers });\n\n      // Credit target\n      const updatedTargetMembers = targetAgency.members.map(m => m.id === targetId ? { ...m, wallet: (m.wallet || 0) + amount } : m);\n      batch.update(doc(db, \"agencies\", targetAgency.id), { members: updatedTargetMembers });\n\n      await batch.commit();\n      toast('success', `Virement de ${amount} PiXi effectué.`);\n  };\n\n  const injectCapital = async (studentId: string, agencyId: string, amount: number) => { \n      const agency = agencies.find(a => a.id === agencyId);\n      if(!agency) return;\n      const student = agency.members.find(m => m.id === studentId);\n      if(!student || (student.wallet || 0) < amount) {\n          toast('error', \"Fonds insuffisants.\");\n          return;\n      }\n      \n      const tax = Math.floor(amount * GAME_RULES.INJECTION_TAX);\n      const netInjection = amount - tax;\n\n      const batch = writeBatch(db);\n      // KARMA BONUS (Dévouement)\n      const updatedMembers = agency.members.map(m => \n          m.id === studentId \n          ? { ...m, wallet: (m.wallet || 0) - amount, karma: (m.karma || 0) + 10 } \n          : m\n      );\n      \n      const today = new Date().toISOString().split('T')[0];\n      const newEvent: GameEvent = {\n          id: `inj-${Date.now()}`,\n          date: today,\n          type: 'INFO',\n          label: 'Injection Capital',\n          deltaBudgetReal: netInjection,\n          description: `${student.name} injecte ${amount} PiXi (Taxe: ${tax}).`\n      };\n\n      batch.update(doc(db, \"agencies\", agency.id), { \n          members: updatedMembers, \n          budget_real: agency.budget_real + netInjection,\n          eventLog: [...agency.eventLog, newEvent] \n      });\n      await batch.commit();\n      toast('success', `Injection: +${netInjection} PiXi (Taxe -${tax})`);\n  };\n\n  const requestScorePurchase = async (studentId: string, agencyId: string, amountPixi: number, amountScore: number) => { \n     const agency = agencies.find(a => a.id === agencyId);\n     if(!agency) return;\n     const newRequest: TransactionRequest = { id: `req-score-${Date.now()}`, studentId, studentName: agency.members.find(m=>m.id===studentId)?.name || '', type: 'BUY_SCORE', amountPixi, amountScore, status: 'PENDING', date: new Date().toISOString().split('T')[0] };\n     await updateDoc(doc(db, \"agencies\", agency.id), { transactionRequests: [...(agency.transactionRequests || []), newRequest] });\n     toast('success', \"Demande envoyée\");\n  };\n\n  const handleTransactionRequest = async (agency: Agency, request: TransactionRequest, approved: boolean) => {\n      const batch = writeBatch(db);\n      const agencyRef = doc(db, \"agencies\", agency.id);\n      const updatedRequests = (agency.transactionRequests || []).filter(r => r.id !== request.id);\n      if (!approved) { batch.update(agencyRef, { transactionRequests: updatedRequests }); await batch.commit(); return; }\n      \n      const updatedMembers = agency.members.map(m => m.id === request.studentId ? { ...m, wallet: (m.wallet || 0) - request.amountPixi, individualScore: Math.min(100, m.individualScore + request.amountScore) } : m);\n      batch.update(agencyRef, { transactionRequests: updatedRequests, members: updatedMembers });\n      await batch.commit();\n      toast('success', \"Transaction validée\");\n  };\n\n  return { processFinance, transferFunds, injectCapital, requestScorePurchase, handleTransactionRequest };\n};\n"
            }
          ]
        },
        {
          "path": "components/student/TeamView.tsx",
          "generationType": 1,
          "isDone": true,
          "description": "Mise à jour du Karma lors de la soumission d'une Peer Review (participation).",
          "diffs": [
            {
              "target": "",
              "replacement": "\nimport React, { useState } from 'react';\nimport { Agency, Student, PeerReview } from '../../types';\nimport { Clock, MessageCircle, Send, Lock, Coins, Award, Star, Wallet, Medal, HelpCircle, CheckCircle2 } from 'lucide-react';\nimport { Modal } from '../Modal';\nimport { GAME_RULES } from '../../constants';\nimport { useAuth } from '../../contexts/AuthContext';\nimport { useGame } from '../../contexts/GameContext'; // Import du GameContext\n\ninterface TeamViewProps {\n  agency: Agency;\n  onUpdateAgency: (agency: Agency) => void;\n}\n\nexport const TeamView: React.FC<TeamViewProps> = ({ agency, onUpdateAgency }) => {\n  const [selectedMember, setSelectedMember] = useState<Student | null>(null);\n  const [reviewMode, setReviewMode] = useState<Student | null>(null);\n  const [showSalaryInfo, setShowSalaryInfo] = useState(false);\n\n  const { currentUser: firebaseUser } = useAuth();\n  const { getCurrentGameWeek } = useGame(); // Récupération de la semaine actuelle\n  \n  // Correction Identity: Find the member that corresponds to the logged-in user\n  const currentUser = agency.members.find(m => m.id === firebaseUser?.uid);\n  const currentWeek = getCurrentGameWeek();\n\n  const handlePeerReview = (review: PeerReview) => {\n    // 1. Ajouter la review\n    // 2. Augmenter le Karma de l'auteur pour sa participation (+2 Karma)\n    const updatedMembers = agency.members.map(m => \n        m.id === currentUser?.id \n        ? { ...m, karma: (m.karma || 0) + 2 } \n        : m\n    );\n\n    onUpdateAgency({\n        ...agency,\n        members: updatedMembers,\n        peerReviews: [...agency.peerReviews, review]\n    });\n    setReviewMode(null);\n  };\n\n  const hasReviewedMemberThisWeek = (targetId: string) => {\n      if (!currentUser) return false;\n      return agency.peerReviews.some(r => \n          r.reviewerId === currentUser.id && \n          r.targetId === targetId && \n          r.weekId === currentWeek.toString()\n      );\n  };\n\n  return (\n    <div className=\"animate-in slide-in-from-right-4 duration-500 pb-20\">\n        \n        {/* Header Action */}\n        <div className=\"flex justify-between items-center mb-6\">\n             <div>\n                <h3 className=\"text-xl font-bold text-slate-900\">Membres du Studio</h3>\n                <p className=\"text-xs text-slate-500\">Semaine {currentWeek} en cours</p>\n             </div>\n             <div className=\"flex gap-2\">\n                <span className=\"text-xs text-slate-400 self-center hidden md:block\">Connecté en tant que <strong>{currentUser?.name || 'Visiteur'}</strong></span>\n             </div>\n        </div>\n\n        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n            {agency.members.map(member => {\n                const salary = member.individualScore * GAME_RULES.SALARY_MULTIPLIER;\n                const isMe = member.id === currentUser?.id;\n                const alreadyReviewed = hasReviewedMemberThisWeek(member.id);\n                \n                return (\n                    <div \n                        key={member.id} \n                        className=\"bg-white p-6 rounded-3xl border border-slate-100 shadow-sm flex flex-col gap-4 group hover:shadow-md transition-all relative overflow-hidden\"\n                    >\n                        <div className=\"flex items-center gap-6 cursor-pointer\" onClick={() => setSelectedMember(member)}>\n                            <img src={member.avatarUrl} className=\"w-20 h-20 rounded-2xl bg-slate-100 group-hover:scale-105 transition-transform\" alt={member.name} />\n                            <div className=\"flex-1\">\n                                <h3 className=\"text-xl font-bold text-slate-900 group-hover:text-indigo-600 transition-colors flex items-center gap-2\">\n                                    {member.name}\n                                    {/* BADGE DISPLAY */}\n                                    {member.badges && member.badges.length > 0 && member.badges.map(b => (\n                                        <span key={b.id} title={b.label} className=\"text-yellow-500 bg-yellow-50 p-1 rounded-full border border-yellow-200\">\n                                            <Medal size={14}/>\n                                        </span>\n                                    ))}\n                                </h3>\n                                \n                                {/* SALARY BADGE (CLICKABLE) */}\n                                <div className=\"flex flex-col items-start mt-1 gap-1\">\n                                    <span className=\"text-[10px] font-bold text-slate-400 uppercase tracking-wider\">{member.role}</span>\n                                    <button \n                                        onClick={(e) => { e.stopPropagation(); setShowSalaryInfo(true); }}\n                                        className=\"inline-flex items-center gap-1 px-3 py-1 bg-red-50 border border-red-100 rounded-full text-xs font-bold text-red-600 hover:bg-red-100 transition-colors\"\n                                    >\n                                        <Coins size={12} />\n                                        -{salary} PiXi / sem\n                                        <HelpCircle size={10} className=\"opacity-50\"/>\n                                    </button>\n                                </div>\n                            </div>\n                            <div className=\"text-right flex flex-col items-end gap-1\">\n                                <div>\n                                    <span className=\"block text-4xl font-display font-bold text-indigo-600 leading-none\">{member.individualScore}</span>\n                                    <span className=\"text-[10px] font-bold text-slate-400 uppercase\">Score</span>\n                                </div>\n                                <div className=\"flex items-center gap-1 text-xs font-bold text-yellow-600 bg-yellow-50 px-2 py-0.5 rounded-full border border-yellow-100\">\n                                    <Wallet size={10}/> {member.wallet || 0}\n                                </div>\n                            </div>\n                        </div>\n\n                        {/* Action Buttons */}\n                        <div className=\"flex gap-2 mt-2 pt-4 border-t border-slate-50\">\n                            <button \n                                onClick={() => setSelectedMember(member)}\n                                className=\"flex-1 py-2 text-xs font-bold text-slate-500 bg-slate-50 rounded-xl hover:bg-slate-100 transition-colors\"\n                            >\n                                Voir Bulletin\n                            </button>\n                            {!isMe && currentUser && (\n                                alreadyReviewed ? (\n                                    <button \n                                        disabled\n                                        className=\"flex-1 py-2 text-xs font-bold text-emerald-600 bg-emerald-50 rounded-xl cursor-not-allowed flex items-center justify-center gap-2\"\n                                    >\n                                        <CheckCircle2 size={14}/> Évalué\n                                    </button>\n                                ) : (\n                                    <button \n                                        onClick={() => setReviewMode(member)}\n                                        className=\"flex-1 py-2 text-xs font-bold text-indigo-600 bg-indigo-50 rounded-xl hover:bg-indigo-100 transition-colors flex items-center justify-center gap-2\"\n                                    >\n                                        <MessageCircle size={14}/> Évaluer\n                                    </button>\n                                )\n                            )}\n                        </div>\n                    </div>\n                );\n            })}\n        </div>\n\n        {/* MODAL: SALARY RULES */}\n        <Modal isOpen={showSalaryInfo} onClose={() => setShowSalaryInfo(false)} title=\"Règles Salariales\">\n            <div className=\"space-y-6\">\n                <div className=\"bg-red-50 p-4 rounded-xl border border-red-100 text-sm text-red-800\">\n                    <strong className=\"block mb-2\">Le Salaire = Charge pour l'agence.</strong>\n                    Chaque étudiant coûte de l'argent à son entreprise chaque semaine.\n                    <br/>Plus vous êtes performant (Score élevé), plus votre salaire est haut.\n                </div>\n                <ul className=\"space-y-3 text-sm text-slate-600\">\n                    <li className=\"flex gap-3 items-start\">\n                        <div className=\"p-1 bg-slate-100 rounded text-slate-500\"><Coins size={16}/></div>\n                        <div>\n                            <strong>Calcul :</strong> Score Individuel x {GAME_RULES.SALARY_MULTIPLIER} PiXi.\n                            <br/><span className=\"text-xs italic opacity-75\">Ex: Score 80 = 800 PiXi/semaine.</span>\n                        </div>\n                    </li>\n                    <li className=\"flex gap-3 items-start\">\n                        <div className=\"p-1 bg-slate-100 rounded text-slate-500\"><Wallet size={16}/></div>\n                        <div>\n                            <strong>Poche Perso :</strong> Vous recevez ce salaire dans votre portefeuille personnel (jusqu'à {GAME_RULES.SALARY_CAP_FOR_STUDENT} PiXi max).\n                            <br/><span className=\"text-xs italic opacity-75\">Le surplus éventuel est absorbé par les charges.</span>\n                        </div>\n                    </li>\n                    <li className=\"flex gap-3 items-start\">\n                        <div className=\"p-1 bg-slate-100 rounded text-slate-500\"><Award size={16}/></div>\n                        <div>\n                            <strong>Comment monter son score ?</strong>\n                            <ul className=\"list-disc pl-4 mt-1 space-y-1\">\n                                <li>Assiduité et Ponctualité (Review des pairs).</li>\n                                <li>Qualité du travail rendu.</li>\n                                <li>Bonus \"Bounty\" techniques validés par le prof.</li>\n                            </ul>\n                        </div>\n                    </li>\n                </ul>\n                <button onClick={() => setShowSalaryInfo(false)} className=\"w-full py-3 bg-slate-900 text-white font-bold rounded-xl hover:bg-slate-800\">Compris</button>\n            </div>\n        </Modal>\n\n        {/* MODAL: Détail Note Élève */}\n        <Modal isOpen={!!selectedMember} onClose={() => setSelectedMember(null)} title=\"Bulletin Individuel\">\n            {selectedMember && (\n                <div className=\"space-y-6\">\n                    <div className=\"flex items-center gap-4 mb-6\">\n                        <img src={selectedMember.avatarUrl} className=\"w-16 h-16 rounded-2xl bg-slate-100\" />\n                        <div>\n                            <div className=\"flex items-center gap-2\">\n                                <h4 className=\"text-xl font-bold text-slate-900\">{selectedMember.name}</h4>\n                                {selectedMember.badges?.map(b => (\n                                    <span key={b.id} className=\"text-[10px] bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded-full font-bold border border-yellow-200\">\n                                        {b.label}\n                                    </span>\n                                ))}\n                            </div>\n                            <p className=\"text-slate-500 text-sm\">{selectedMember.role}</p>\n                            <p className=\"text-red-500 font-bold text-xs mt-1\">Coût salarial: {selectedMember.individualScore * GAME_RULES.SALARY_MULTIPLIER} PiXi / sem</p>\n                        </div>\n                        <div className=\"ml-auto text-center\">\n                            <span className=\"block text-3xl font-display font-bold text-indigo-600\">{selectedMember.individualScore}</span>\n                            <span className=\"text-[10px] uppercase font-bold text-slate-400\">Total / 100</span>\n                        </div>\n                    </div>\n\n                    <div className=\"space-y-4\">\n                        <div className=\"bg-slate-50 rounded-xl p-4 border border-slate-100\">\n                             <div className=\"flex justify-between items-center mb-2\">\n                                <div className=\"flex items-center gap-2 text-slate-700 font-bold text-sm\">\n                                    <Wallet size={16} className=\"text-yellow-500\" /> Portefeuille Personnel\n                                </div>\n                                <span className=\"font-bold text-yellow-600\">{selectedMember.wallet || 0} PiXi</span>\n                             </div>\n                             <p className=\"text-xs text-slate-400 italic\">Accumulé via salaires et bonus.</p>\n                        </div>\n\n                        {/* Mock Breakdown Data for visualization */}\n                        <div className=\"bg-slate-50 rounded-xl p-4 border border-slate-100\">\n                             <div className=\"flex justify-between items-center mb-2\">\n                                <div className=\"flex items-center gap-2 text-slate-700 font-bold text-sm\">\n                                    <Clock size={16} className=\"text-emerald-500\" /> Assiduité & Ponctualité\n                                </div>\n                                <span className=\"font-bold text-emerald-600\">20/20</span>\n                             </div>\n                             <div className=\"w-full bg-slate-200 rounded-full h-2\">\n                                <div className=\"bg-emerald-500 h-2 rounded-full\" style={{ width: '100%' }}></div>\n                             </div>\n                        </div>\n\n                        <div className=\"bg-slate-50 rounded-xl p-4 border border-slate-100\">\n                             <div className=\"flex justify-between items-center mb-2\">\n                                <div className=\"flex items-center gap-2 text-slate-700 font-bold text-sm\">\n                                    <Award size={16} className=\"text-amber-500\" /> Qualité des Rendus (Perso)\n                                </div>\n                                <span className=\"font-bold text-amber-600\">{(selectedMember.individualScore || 0) - 25}/60</span>\n                             </div>\n                             <div className=\"w-full bg-slate-200 rounded-full h-2\">\n                                <div className=\"bg-amber-500 h-2 rounded-full\" style={{ width: `${((selectedMember.individualScore - 25)/60)*100}%` }}></div>\n                             </div>\n                        </div>\n\n                        <div className=\"bg-slate-50 rounded-xl p-4 border border-slate-100\">\n                             <div className=\"flex justify-between items-center mb-2\">\n                                <div className=\"flex items-center gap-2 text-slate-700 font-bold text-sm\">\n                                    <Star size={16} className=\"text-indigo-500\" /> Bonus Rôle & Implication\n                                </div>\n                                <span className=\"font-bold text-indigo-600\">5/20</span>\n                             </div>\n                             <div className=\"w-full bg-slate-200 rounded-full h-2\">\n                                <div className=\"bg-indigo-500 h-2 rounded-full\" style={{ width: '25%' }}></div>\n                             </div>\n                        </div>\n                    </div>\n                </div>\n            )}\n        </Modal>\n\n        {/* MODAL: Peer Review Form */}\n        {reviewMode && currentUser && (\n            <PeerReviewForm \n                reviewer={currentUser}\n                target={reviewMode}\n                weekId={currentWeek.toString()}\n                onClose={() => setReviewMode(null)}\n                onSubmit={handlePeerReview}\n            />\n        )}\n    </div>\n  );\n};\n\n// ----------------------------------------------------------------------\n// INTERNAL: Peer Review Form Component\n// ----------------------------------------------------------------------\ninterface PeerReviewFormProps {\n    reviewer: Student;\n    target: Student;\n    weekId: string;\n    onClose: () => void;\n    onSubmit: (review: PeerReview) => void;\n}\n\nconst PeerReviewForm: React.FC<PeerReviewFormProps> = ({ reviewer, target, weekId, onClose, onSubmit }) => {\n    const [attendance, setAttendance] = useState(3);\n    const [quality, setQuality] = useState(3);\n    const [involvement, setInvolvement] = useState(3);\n    const [comment, setComment] = useState(\"\");\n\n    const handleSubmit = () => {\n        const review: PeerReview = {\n            id: `rev-${Date.now()}`,\n            weekId: weekId, \n            date: new Date().toISOString().split('T')[0],\n            reviewerId: reviewer.id,\n            reviewerName: reviewer.name,\n            targetId: target.id,\n            targetName: target.name,\n            ratings: { attendance, quality, involvement },\n            comment\n        };\n        onSubmit(review);\n    };\n\n    return (\n        <Modal isOpen={true} onClose={onClose} title={`Évaluation Hebdo (Sem ${weekId}): ${target.name}`}>\n            <div className=\"space-y-6\">\n                <div className=\"bg-indigo-50 p-4 rounded-xl border border-indigo-100 text-sm text-indigo-800\">\n                    Soyez honnête et constructif. Ces notes impactent le score individuel de votre collègue.\n                    <br/><strong>Attention :</strong> Vous ne pouvez évaluer qu'une seule fois par semaine.\n                </div>\n\n                <div className=\"space-y-4\">\n                    <RangeInput label=\"Assiduité / Ponctualité\" value={attendance} onChange={setAttendance} icon={<Clock size={16} className=\"text-emerald-500\"/>} />\n                    <RangeInput label=\"Qualité du travail\" value={quality} onChange={setQuality} icon={<Award size={16} className=\"text-amber-500\"/>} />\n                    <RangeInput label=\"Implication / Esprit d'équipe\" value={involvement} onChange={setInvolvement} icon={<Star size={16} className=\"text-indigo-500\"/>} />\n                </div>\n\n                <div>\n                    <div className=\"flex justify-between items-end mb-2\">\n                        <label className=\"block text-sm font-bold text-slate-700\">Feedback Privé (Optionnel)</label>\n                        <span className=\"text-slate-400 flex items-center gap-1 bg-slate-50 px-2 py-1 rounded-md border border-slate-100 text-[10px]\">\n                            <Lock size={10} /> Visible uniquement par l'admin\n                        </span>\n                    </div>\n                    <textarea \n                        value={comment}\n                        onChange={e => setComment(e.target.value)}\n                        placeholder=\"Ex: Excellent travail sur le lighting, mais attention aux retards le matin...\"\n                        className=\"w-full p-3 rounded-xl border border-slate-200 text-sm bg-white text-slate-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 min-h-[80px]\"\n                    />\n                </div>\n\n                <button \n                    onClick={handleSubmit}\n                    className=\"w-full bg-slate-900 text-white font-bold py-3 rounded-xl hover:bg-indigo-600 transition-colors flex justify-center items-center gap-2\"\n                >\n                    <Send size={18} />\n                    Envoyer l'évaluation (Définitif)\n                </button>\n            </div>\n        </Modal>\n    );\n};\n\nconst RangeInput: React.FC<{label: string, value: number, onChange: (v: number) => void, icon: React.ReactNode}> = ({label, value, onChange, icon}) => (\n    <div>\n        <div className=\"flex justify-between mb-2\">\n            <label className=\"text-sm font-bold text-slate-700 flex items-center gap-2\">{icon} {label}</label>\n            <span className=\"font-bold text-slate-900\">{value}/5</span>\n        </div>\n        <input \n            type=\"range\" \n            min=\"1\" \n            max=\"5\" \n            step=\"0.5\"\n            value={value} \n            onChange={(e) => onChange(parseFloat(e.target.value))}\n            className=\"w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-600\"\n        />\n        <div className=\"flex justify-between text-[10px] text-slate-400 font-bold uppercase mt-1\">\n            <span>Médiocre</span>\n            <span>Excellent</span>\n        </div>\n    </div>\n);\n"
            }
          ]
        },
        {
          "path": "components/admin/dashboard/modals/GradingModal.tsx",
          "generationType": 1,
          "isDone": true,
          "description": "Impact du Karma lors de la notation (Malus retard, Bonus MVP).",
          "diffs": [
            {
              "target": "",
              "replacement": "\nimport React, { useState } from 'react';\nimport { Agency, Deliverable, GameEvent } from '../../../../types';\nimport { Modal } from '../../../Modal';\nimport { useUI } from '../../../../contexts/UIContext';\nimport { getAgencyPerformanceMultiplier } from '../../../../constants';\nimport { Mail, Star, Send } from 'lucide-react';\nimport { db, collection } from '../../../../services/firebase';\n\ninterface GradingModalProps {\n    isOpen: boolean;\n    onClose: () => void;\n    item: {agencyId: string, weekId: string, deliverable: Deliverable};\n    agencies: Agency[];\n    onUpdateAgency: (agency: Agency) => void;\n}\n\nexport const GradingModal: React.FC<GradingModalProps> = ({ isOpen, onClose, item, agencies, onUpdateAgency }) => {\n    const { toast } = useUI();\n    const [quality, setQuality] = useState<'A' | 'B' | 'C'>('B');\n    const [daysLate, setDaysLate] = useState<number>(0);\n    const [constraintBroken, setConstraintBroken] = useState<boolean>(false);\n    const [feedback, setFeedback] = useState(item.deliverable.feedback || \"\");\n    const [mvpId, setMvpId] = useState<string>(\"\");\n    const [isSaving, setIsSaving] = useState(false);\n\n    const agency = agencies.find(a => a.id === item.agencyId);\n    const baseScore = quality === 'A' ? 10 : quality === 'B' ? 4 : 0;\n    const penaltyLate = (daysLate || 0) * 5;\n    const penaltyConstraint = constraintBroken ? 10 : 0;\n    const rawDelta = baseScore - penaltyLate - penaltyConstraint;\n\n    const handleValidate = async () => {\n        if(!agency) return;\n        setIsSaving(true);\n\n        try {\n            // 1. CALCULS DE PERFORMANCE\n            const multiplier = getAgencyPerformanceMultiplier(agency);\n            const finalDelta = rawDelta > 0 ? Math.round(rawDelta * multiplier) : rawDelta;\n            const perfPercent = Math.round(multiplier * 100);\n\n            const currentWeek = agency.progress[item.weekId];\n            const isRejected = quality === 'C';\n            const finalStatus: 'validated' | 'rejected' = isRejected ? 'rejected' : 'validated';\n            \n            const updatedDeliverables = currentWeek.deliverables.map(d => \n                d.id === item.deliverable.id \n                ? { \n                    ...d, \n                    status: finalStatus,\n                    feedback: feedback,\n                    score: 100,\n                    grading: {\n                        quality,\n                        daysLate: daysLate || 0,\n                        constraintBroken,\n                        finalDelta: finalDelta || 0,\n                        mvpId: mvpId || null\n                    }\n                }\n                : d\n            );\n\n            let updatedProjectDef = agency.projectDef;\n            if (item.deliverable.id === 'd_charter' && isRejected) {\n                updatedProjectDef = { ...agency.projectDef, isLocked: false };\n            }\n\n            // 2. LOGIQUE KARMA (IMPACT MEMBERS)\n            let updatedMembers = agency.members.map(m => {\n                let newKarma = m.karma || 0;\n                let newScore = m.individualScore;\n\n                // A. Bonus MVP (+15 Karma, +5 Score)\n                if (quality === 'A' && mvpId && m.id === mvpId) {\n                    newKarma += 15;\n                    newScore = Math.min(100, m.individualScore + 5);\n                }\n\n                // B. Malus Retard (-2 Karma par jour par personne)\n                if (daysLate > 0) {\n                    newKarma -= (daysLate * 2);\n                }\n\n                return { ...m, karma: newKarma, individualScore: newScore };\n            });\n\n            const newEvent: GameEvent = {\n                id: `evt-${Date.now()}`,\n                date: new Date().toISOString().split('T')[0],\n                type: 'VE_DELTA',\n                label: isRejected ? `Rejet: ${item.deliverable.name}` : `Correction: ${item.deliverable.name}`,\n                deltaVE: finalDelta,\n                description: `Qualité ${quality} (${baseScore}pts) | Retard: ${daysLate}j (-${penaltyLate}) | Perf. ${perfPercent}%${mvpId ? ' | MVP Bonus' : ''}`\n            };\n\n            const updatedAgency = {\n                ...agency,\n                ve_current: Math.max(0, Math.min(100, agency.ve_current + finalDelta)),\n                projectDef: updatedProjectDef,\n                eventLog: [...agency.eventLog, newEvent],\n                members: updatedMembers,\n                progress: {\n                    ...agency.progress,\n                    [item.weekId]: {\n                        ...currentWeek,\n                        deliverables: updatedDeliverables\n                    }\n                }\n            };\n\n            // 3. SAUVEGARDE DB (AGENCY UPDATE)\n            await onUpdateAgency(updatedAgency);\n            \n            // 4. ENVOI EMAIL SEAMLESS (VIA FIRESTORE TRIGGER)\n            const recipients = agency.members\n                .map(m => m.email)\n                .filter(email => email && email.includes('@'));\n\n            if (recipients.length > 0) {\n                const mailSubject = `Correction RNP : ${item.deliverable.name} (${agency.name})`;\n                const mailBody = `\nBonjour l'équipe ${agency.name},\n\nVoici le retour officiel pour le livrable \"${item.deliverable.name}\" :\n\n- Qualité : ${quality}\n- Retard : ${daysLate} jour(s)\n- Impact VE : ${finalDelta >= 0 ? '+' : ''}${finalDelta}\n\nCommentaire de l'enseignant :\n\"${feedback}\"\n\nBon courage pour la suite.\nL'équipe RNP.\n                `;\n\n                await collection(db, 'mail').add({\n                    to: recipients,\n                    message: {\n                        subject: mailSubject,\n                        text: mailBody,\n                        html: mailBody.replace(/\\n/g, '<br>')\n                    }\n                });\n                \n                toast('success', `Correction enregistrée & Email envoyé (${recipients.length} destinataires)`);\n            } else {\n                toast('warning', \"Correction enregistrée, mais aucun email valide trouvé pour l'envoi.\");\n            }\n\n            onClose();\n        } catch (error) {\n            console.error(\"Erreur validation:\", error);\n            toast('error', \"Erreur lors de l'enregistrement.\");\n        } finally {\n            setIsSaving(false);\n        }\n    };\n\n    return (\n        <Modal isOpen={isOpen} onClose={onClose} title=\"Correction de Livrable\">\n            <div className=\"space-y-6\">\n                <div className=\"p-4 bg-slate-50 rounded-xl border border-slate-100\">\n                    <h4 className=\"font-bold text-lg text-slate-800\">{item.deliverable.name}</h4>\n                    {item.deliverable.fileUrl && (\n                        <a href={item.deliverable.fileUrl} target=\"_blank\" className=\"text-sm text-indigo-600 font-bold hover:underline block mt-1\">Voir le fichier rendu</a>\n                    )}\n                </div>\n                 <div className=\"space-y-5\">\n                    <div>\n                        <label className=\"block text-sm font-bold text-slate-700 mb-2\">Qualité du rendu</label>\n                        <div className=\"grid grid-cols-3 gap-2\">\n                            <button onClick={() => setQuality('A')} className={`py-3 px-2 rounded-xl border-2 font-bold text-sm transition-all ${quality === 'A' ? 'border-emerald-500 bg-emerald-50 text-emerald-700' : 'border-slate-100 hover:border-emerald-200'}`}>A (Excellence)</button>\n                            <button onClick={() => setQuality('B')} className={`py-3 px-2 rounded-xl border-2 font-bold text-sm transition-all ${quality === 'B' ? 'border-amber-500 bg-amber-50 text-amber-700' : 'border-slate-100 hover:border-amber-200'}`}>B (Standard)</button>\n                            <button onClick={() => setQuality('C')} className={`py-3 px-2 rounded-xl border-2 font-bold text-sm transition-all ${quality === 'C' ? 'border-red-500 bg-red-50 text-red-700' : 'border-slate-100 hover:border-red-200'}`}>C (Rejet)</button>\n                        </div>\n                    </div>\n                    \n                    {quality === 'A' && agency && (\n                        <div className=\"animate-in fade-in slide-in-from-top-2\">\n                            <label className=\"block text-sm font-bold text-emerald-700 mb-2 flex items-center gap-2\">\n                                <Star size={16} fill=\"currentColor\"/> Lead / MVP du Rendu (+5 Score / +15 Karma)\n                            </label>\n                            <select \n                                className=\"w-full p-2 border border-emerald-200 rounded-lg bg-emerald-50 text-emerald-900 text-sm font-bold outline-none focus:ring-2 focus:ring-emerald-500\"\n                                value={mvpId}\n                                onChange={e => setMvpId(e.target.value)}\n                            >\n                                <option value=\"\">-- Sélectionner un étudiant --</option>\n                                {agency.members.map(m => (\n                                    <option key={m.id} value={m.id}>{m.name}</option>\n                                ))}\n                            </select>\n                        </div>\n                    )}\n\n                    <div className=\"grid grid-cols-2 gap-4\">\n                        <div>\n                             <label className=\"block text-sm font-bold text-slate-700 mb-2\">Jours de Retard</label>\n                             <input \n                                type=\"number\" \n                                min=\"0\" \n                                value={daysLate} \n                                onChange={e => setDaysLate(e.target.value ? parseInt(e.target.value) : 0)} \n                                className=\"w-full p-3 border border-slate-200 rounded-xl\"\n                             />\n                        </div>\n                        <div className=\"flex items-end\">\n                             <label className=\"flex items-center gap-2 cursor-pointer p-3 border border-slate-200 rounded-xl w-full hover:bg-slate-50\">\n                                 <input type=\"checkbox\" checked={constraintBroken} onChange={e => setConstraintBroken(e.target.checked)} className=\"w-5 h-5 accent-red-500\"/>\n                                 <span className=\"text-sm font-bold text-slate-700\">Contrainte non respectée</span>\n                             </label>\n                        </div>\n                    </div>\n                     <div>\n                        <label className=\"block text-sm font-bold text-slate-700 mb-2\">Commentaire</label>\n                        <textarea value={feedback} onChange={(e) => setFeedback(e.target.value)} className=\"w-full p-3 rounded-xl border border-slate-200 text-sm bg-white\" placeholder=\"Feedback constructif...\" />\n                    </div>\n                 </div>\n                 \n                 <div className=\"pt-4 border-t border-slate-100 flex justify-between items-center\">\n                    <div className=\"font-bold\">\n                        Impact VE Brut: <span className={`${rawDelta >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>{rawDelta > 0 ? '+' : ''}{rawDelta}</span>\n                        {rawDelta > 0 && agency && (\n                            <span className=\"text-xs text-slate-400 block font-normal\">\n                                Multiplicateur Perf: x{getAgencyPerformanceMultiplier(agency).toFixed(2)}\n                            </span>\n                        )}\n                    </div>\n                    <button \n                        onClick={handleValidate} \n                        disabled={isSaving}\n                        className=\"px-6 py-3 bg-slate-900 text-white rounded-xl font-bold hover:bg-indigo-600 transition-colors disabled:opacity-50 flex items-center gap-2\"\n                    >\n                        {isSaving ? 'Envoi...' : <><Send size={16}/> Valider & Notifier</>}\n                    </button>\n                 </div>\n            </div>\n        </Modal>\n    );\n}\n"
            }
          ]
        },
        {
          "path": "components/AdminAnalytics.tsx",
          "generationType": 1,
          "isDone": true,
          "description": "Ajout du tableau Karma Police (Secret).",
          "diffs": [
            {
              "target": "",
              "replacement": "\nimport React, { useMemo, useState } from 'react';\nimport { Agency, Student } from '../types';\nimport { ResponsiveContainer, ScatterChart, Scatter, XAxis, YAxis, CartesianGrid, Tooltip, Legend, BarChart, Bar, RadarChart, PolarGrid, PolarAngleAxis, PolarRadiusAxis, Radar } from 'recharts';\nimport { TrendingUp, Users, Wallet, Trophy, AlertTriangle, Lightbulb, Activity, PieChart, Eye, EyeOff } from 'lucide-react';\n\ninterface AdminAnalyticsProps {\n    agencies: Agency[];\n}\n\nexport const AdminAnalytics: React.FC<AdminAnalyticsProps> = ({ agencies }) => {\n    const [showKarma, setShowKarma] = useState(false);\n    \n    // --- DATA PROCESSING ---\n    const activeAgencies = useMemo(() => agencies.filter(a => a.id !== 'unassigned'), [agencies]);\n    \n    const allStudents = useMemo(() => {\n        const students: (Student & { agencyName: string, agencyId: string })[] = [];\n        activeAgencies.forEach(a => {\n            a.members.forEach(m => students.push({ ...m, agencyName: a.name, agencyId: a.id }));\n        });\n        return students;\n    }, [activeAgencies]);\n\n    // 1. SCATTER DATA: TALENT vs AGENCY PERFORMANCE\n    const scatterData = useMemo(() => {\n        return activeAgencies.map(a => {\n            const avgScore = a.members.length > 0 \n                ? a.members.reduce((acc, m) => acc + m.individualScore, 0) / a.members.length \n                : 0;\n            return {\n                name: a.name,\n                ve: a.ve_current, // Y Axis\n                avgScore: Math.round(avgScore), // X Axis\n                classId: a.classId,\n                members: a.members.length\n            };\n        });\n    }, [activeAgencies]);\n\n    // 2. RADAR DATA: SOFT SKILLS (From Peer Reviews)\n    const radarData = useMemo(() => {\n        let totalAttendance = 0, totalQuality = 0, totalInvolvement = 0;\n        let count = 0;\n\n        activeAgencies.forEach(a => {\n            a.peerReviews.forEach(r => {\n                totalAttendance += r.ratings.attendance;\n                totalQuality += r.ratings.quality;\n                totalInvolvement += r.ratings.involvement;\n                count++;\n            });\n        });\n\n        if (count === 0) return [];\n\n        return [\n            { subject: 'Assiduité', A: parseFloat((totalAttendance / count).toFixed(2)), fullMark: 5 },\n            { subject: 'Qualité', A: parseFloat((totalQuality / count).toFixed(2)), fullMark: 5 },\n            { subject: 'Implication', A: parseFloat((totalInvolvement / count).toFixed(2)), fullMark: 5 },\n        ];\n    }, [activeAgencies]);\n\n    // 3. WEALTH DISTRIBUTION\n    const wealthData = useMemo(() => {\n        const sorted = [...allStudents].sort((a,b) => (b.wallet || 0) - (a.wallet || 0));\n        const top10 = sorted.slice(0, 10);\n        const flop5 = sorted.slice(-5).reverse();\n        return { top10, flop5 };\n    }, [allStudents]);\n\n    // 4. TOP PERFORMERS (High Potential)\n    const topPerformers = useMemo(() => {\n        return [...allStudents]\n            .sort((a,b) => b.individualScore - a.individualScore)\n            .slice(0, 5);\n    }, [allStudents]);\n\n    // 5. KARMA LIST\n    const karmaList = useMemo(() => {\n        return [...allStudents].sort((a,b) => (b.karma || 0) - (a.karma || 0));\n    }, [allStudents]);\n\n    // Custom Tooltip for Scatter\n    const ScatterTooltip = ({ active, payload }: any) => {\n        if (active && payload && payload.length) {\n            const data = payload[0].payload;\n            return (\n                <div className=\"bg-white p-3 border border-slate-200 shadow-xl rounded-xl text-xs\">\n                    <p className=\"font-bold text-slate-900 mb-1\">{data.name}</p>\n                    <p className=\"text-indigo-600 font-bold\">VE: {data.ve}</p>\n                    <p className=\"text-slate-500\">Moy. Talent: {data.avgScore}/100</p>\n                    <p className=\"text-slate-400 italic\">{data.members} membres</p>\n                </div>\n            );\n        }\n        return null;\n    };\n\n    return (\n        <div className=\"animate-in fade-in duration-500 pb-20\">\n            <div className=\"mb-8\">\n                <h2 className=\"text-3xl font-display font-bold text-slate-900 flex items-center gap-3\">\n                    <div className=\"p-2 bg-purple-100 rounded-xl text-purple-700\"><PieChart size={32}/></div>\n                    Centre d'Analyse\n                </h2>\n                <p className=\"text-slate-500 text-sm mt-1\">\n                    Métriques avancées pour détecter les anomalies et les talents cachés.\n                </p>\n            </div>\n\n            {/* KPI ROW */}\n            <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4 mb-8\">\n                <div className=\"bg-white p-4 rounded-2xl border border-slate-200 shadow-sm flex items-center gap-4\">\n                    <div className=\"p-3 bg-indigo-50 rounded-xl text-indigo-600\"><Users size={24}/></div>\n                    <div>\n                        <p className=\"text-xs text-slate-400 font-bold uppercase\">Effectif Total</p>\n                        <p className=\"text-2xl font-bold text-slate-900\">{allStudents.length}</p>\n                    </div>\n                </div>\n                <div className=\"bg-white p-4 rounded-2xl border border-slate-200 shadow-sm flex items-center gap-4\">\n                    <div className=\"p-3 bg-emerald-50 rounded-xl text-emerald-600\"><Activity size={24}/></div>\n                    <div>\n                        <p className=\"text-xs text-slate-400 font-bold uppercase\">Moyenne Promo</p>\n                        <p className=\"text-2xl font-bold text-slate-900\">\n                            {Math.round(allStudents.reduce((acc, s) => acc + s.individualScore, 0) / Math.max(1, allStudents.length))}\n                            <span className=\"text-sm text-slate-400 font-medium\">/100</span>\n                        </p>\n                    </div>\n                </div>\n                <div className=\"bg-white p-4 rounded-2xl border border-slate-200 shadow-sm flex items-center gap-4\">\n                    <div className=\"p-3 bg-yellow-50 rounded-xl text-yellow-600\"><Wallet size={24}/></div>\n                    <div>\n                        <p className=\"text-xs text-slate-400 font-bold uppercase\">Masse Monétaire</p>\n                        <p className=\"text-2xl font-bold text-slate-900\">\n                            {(allStudents.reduce((acc, s) => acc + (s.wallet || 0), 0) / 1000).toFixed(1)}k\n                            <span className=\"text-sm text-slate-400 font-medium\"> px</span>\n                        </p>\n                    </div>\n                </div>\n                <div className=\"bg-white p-4 rounded-2xl border border-slate-200 shadow-sm flex items-center gap-4\">\n                    <div className=\"p-3 bg-red-50 rounded-xl text-red-600\"><AlertTriangle size={24}/></div>\n                    <div>\n                        <p className=\"text-xs text-slate-400 font-bold uppercase\">Agences Fragiles</p>\n                        <p className=\"text-2xl font-bold text-slate-900\">\n                            {activeAgencies.filter(a => a.ve_current < 40 || a.budget_real < 0).length}\n                        </p>\n                    </div>\n                </div>\n            </div>\n\n            <div className=\"grid grid-cols-1 xl:grid-cols-2 gap-8 mb-8\">\n                \n                {/* 1. SCATTER CHART: Matrix Talent/Performance */}\n                <div className=\"bg-white p-6 rounded-3xl border border-slate-200 shadow-sm\">\n                    <div className=\"flex justify-between items-start mb-6\">\n                        <div>\n                            <h3 className=\"text-lg font-bold text-slate-900 flex items-center gap-2\">\n                                <Lightbulb size={20} className=\"text-amber-500\"/> Matrice Talent / Performance\n                            </h3>\n                            <p className=\"text-xs text-slate-500 mt-1\">\n                                <strong>Haut-Gauche :</strong> Agence performante mais équipe faible (Leadeurs ?).<br/>\n                                <strong>Bas-Droite :</strong> Talents gâchés (Bons élèves, mauvaise gestion).\n                            </p>\n                        </div>\n                    </div>\n                    <div className=\"h-[350px] w-full\">\n                        <ResponsiveContainer width=\"100%\" height=\"100%\">\n                            <ScatterChart margin={{ top: 20, right: 20, bottom: 20, left: 0 }}>\n                                <CartesianGrid strokeDasharray=\"3 3\" />\n                                <XAxis type=\"number\" dataKey=\"avgScore\" name=\"Moyenne Talent\" unit=\"/100\" domain={[0, 100]} />\n                                <YAxis type=\"number\" dataKey=\"ve\" name=\"Valeur Agence\" unit=\" VE\" domain={[0, 100]} />\n                                <Tooltip content={<ScatterTooltip />} cursor={{ strokeDasharray: '3 3' }} />\n                                <Legend />\n                                <Scatter name=\"Agences\" data={scatterData} fill=\"#6366f1\" shape=\"circle\" />\n                            </ScatterChart>\n                        </ResponsiveContainer>\n                    </div>\n                </div>\n\n                {/* 2. RADAR CHART: Soft Skills */}\n                <div className=\"bg-white p-6 rounded-3xl border border-slate-200 shadow-sm flex flex-col\">\n                    <h3 className=\"text-lg font-bold text-slate-900 flex items-center gap-2 mb-2\">\n                        <Users size={20} className=\"text-emerald-500\"/> Radar RH (Moyenne Promo)\n                    </h3>\n                    <p className=\"text-xs text-slate-500 mb-4\">Basé sur les évaluations hebdomadaires entre pairs.</p>\n                    \n                    <div className=\"flex-1 min-h-[300px]\">\n                        {radarData.length > 0 ? (\n                            <ResponsiveContainer width=\"100%\" height=\"100%\">\n                                <RadarChart cx=\"50%\" cy=\"50%\" outerRadius=\"80%\" data={radarData}>\n                                    <PolarGrid stroke=\"#e2e8f0\" />\n                                    <PolarAngleAxis dataKey=\"subject\" tick={{ fill: '#64748b', fontSize: 12, fontWeight: 'bold' }} />\n                                    <PolarRadiusAxis angle={30} domain={[0, 5]} tick={false} />\n                                    <Radar name=\"Promo\" dataKey=\"A\" stroke=\"#10b981\" fill=\"#10b981\" fillOpacity={0.4} />\n                                    <Tooltip \n                                        contentStyle={{borderRadius: '12px', border: 'none', boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1)'}}\n                                        itemStyle={{color: '#065f46', fontWeight: 'bold'}}\n                                    />\n                                </RadarChart>\n                            </ResponsiveContainer>\n                        ) : (\n                            <div className=\"h-full flex items-center justify-center text-slate-400 text-sm italic\">\n                                Pas assez de données RH.\n                            </div>\n                        )}\n                    </div>\n                </div>\n            </div>\n\n            <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8\">\n                \n                {/* 3. HIGH POTENTIALS */}\n                <div className=\"bg-slate-900 rounded-3xl p-6 text-white shadow-xl lg:col-span-1\">\n                    <h3 className=\"text-lg font-bold flex items-center gap-2 mb-6\">\n                        <Trophy size={20} className=\"text-yellow-400\"/> Top Performers\n                    </h3>\n                    <div className=\"space-y-4\">\n                        {topPerformers.map((student, i) => (\n                            <div key={student.id} className=\"flex items-center gap-3 p-3 bg-white/10 rounded-xl border border-white/5\">\n                                <div className=\"font-bold text-lg text-white/50 w-6\">#{i+1}</div>\n                                <img src={student.avatarUrl} className=\"w-10 h-10 rounded-full bg-slate-800\" />\n                                <div className=\"flex-1 overflow-hidden\">\n                                    <p className=\"font-bold text-sm truncate\">{student.name}</p>\n                                    <p className=\"text-[10px] text-slate-400 truncate\">{student.agencyName}</p>\n                                </div>\n                                <div className=\"text-right\">\n                                    <span className=\"block font-bold text-emerald-400\">{student.individualScore}</span>\n                                    <span className=\"text-[10px] text-slate-500\">SCORE</span>\n                                </div>\n                            </div>\n                        ))}\n                    </div>\n                </div>\n\n                {/* 4. WEALTH DISTRIBUTION */}\n                <div className=\"bg-white rounded-3xl p-6 border border-slate-200 shadow-sm lg:col-span-2\">\n                    <h3 className=\"text-lg font-bold text-slate-900 flex items-center gap-2 mb-6\">\n                        <TrendingUp size={20} className=\"text-indigo-500\"/> Inégalités Économiques (Top 10 vs Flop 5)\n                    </h3>\n                    <div className=\"h-[300px]\">\n                        <ResponsiveContainer width=\"100%\" height=\"100%\">\n                            <BarChart\n                                data={[...wealthData.top10, ...wealthData.flop5]}\n                                margin={{ top: 5, right: 30, left: 20, bottom: 5 }}\n                            >\n                                <CartesianGrid strokeDasharray=\"3 3\" vertical={false} stroke=\"#f1f5f9\"/>\n                                <XAxis dataKey=\"name\" tick={{fontSize: 10}} interval={0} angle={-20} textAnchor=\"end\" height={60}/>\n                                <YAxis />\n                                <Tooltip \n                                    cursor={{fill: '#f8fafc'}}\n                                    contentStyle={{borderRadius: '12px', border: '1px solid #e2e8f0'}}\n                                />\n                                <Bar dataKey=\"wallet\" fill=\"#6366f1\" radius={[4, 4, 0, 0]} />\n                            </BarChart>\n                        </ResponsiveContainer>\n                    </div>\n                </div>\n            </div>\n\n            {/* 5. SECRET KARMA POLICE */}\n            <div className=\"bg-slate-100 rounded-3xl p-6 border-2 border-slate-200 relative overflow-hidden\">\n                <div className=\"flex justify-between items-center mb-6\">\n                    <div>\n                        <h3 className=\"text-lg font-bold text-slate-700 flex items-center gap-2\">\n                            <EyeOff size={20}/> Karma Police (Secret)\n                        </h3>\n                        <p className=\"text-xs text-slate-500 mt-1\">Score caché comportemental (Donations +10, Retards -5, etc.)</p>\n                    </div>\n                    <button \n                        onClick={() => setShowKarma(!showKarma)}\n                        className={`px-4 py-2 rounded-xl text-sm font-bold flex items-center gap-2 transition-all ${showKarma ? 'bg-slate-900 text-white' : 'bg-white border text-slate-500'}`}\n                    >\n                        {showKarma ? <EyeOff size={16}/> : <Eye size={16}/>}\n                        {showKarma ? 'Masquer' : 'Révéler'}\n                    </button>\n                </div>\n\n                {showKarma ? (\n                    <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 animate-in fade-in slide-in-from-bottom-4\">\n                        {karmaList.slice(0, 12).map((s, i) => (\n                            <div key={s.id} className=\"bg-white p-3 rounded-xl flex items-center justify-between border border-slate-200\">\n                                <div className=\"flex items-center gap-3\">\n                                    <div className=\"text-xs font-bold text-slate-300 w-4\">#{i+1}</div>\n                                    <div>\n                                        <p className=\"font-bold text-sm text-slate-800\">{s.name}</p>\n                                        <p className=\"text-[10px] text-slate-400\">{s.agencyName}</p>\n                                    </div>\n                                </div>\n                                <div className={`font-mono font-bold ${(s.karma || 0) >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>\n                                    {(s.karma || 0) > 0 ? '+' : ''}{s.karma || 0}\n                                </div>\n                            </div>\n                        ))}\n                    </div>\n                ) : (\n                    <div className=\"h-24 flex items-center justify-center text-slate-400 text-sm italic\">\n                        Données masquées. Cliquez pour révéler.\n                    </div>\n                )}\n            </div>\n        </div>\n    );\n};\n"
            }
          ]
        }
      ]
    },
    "createdTimestamp": {
      "seconds": 1768528981,
      "nanos": 627000000
    },
    "doneTimestamp": {
      "seconds": 1768528995,
      "nanos": 194000000
    }
  },
  {
    "id": 122,
    "author": "user",
    "payload": {
      "type": "text",
      "text": "retire ces bonus\n\nAltruisme (Transfert d'argent) : +5 Karma (Aider un collègue).\nDévouement (Injection Capital) : +10 Karma (Sauver l'agence).\nParticipation (Faire une Review) : +2 Karma (Jouer le jeu RH).\n\nils sont dans la dynamique BASIQUE de jeu, ils vont en abuser, karma ou non\n\nmets le karma à 50 d'origine\n\non va en parler plus tard, mais il sera aussi très changeant dans un black market (ouvert uniquement de 22h à 4h GMT+1)",
      "files": [],
      "fileUploads": [],
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1768529529,
      "nanos": 215000000
    }
  },
  {
    "id": 123,
    "author": "model",
    "payload": {
      "type": "thinking",
      "text": "**Assessing the Modification**\n\nI'm currently focused on the proposed Karma system adjustments. My primary task is to pinpoint exactly which functions will lose the positive Karma bonuses. The goal is to refine the system based on the provided specifications, namely removing specific rewards for altruism, devotion, and participation, and considering that impact.\n\n\n**Updating the Implementation**\n\nI've zeroed in on the specifics now. I'm making a key adjustment: initial Karma will be set to 50 instead of 0. I'm removing the increment logic in `contexts/game/useFinanceLogic.ts` and `components/student/TeamView.tsx`. Also, I'm mentally preparing for a future \"Black Market\" feature, which requires some planning, but is for now merely conceptual. I'm keeping a strong eye on the constraints as I work. The task is complex.\n\n\n**Refining the Initial State**\n\nI'm now implementing the Karma starting value of 50. I've updated the `createStudent` function in `config/teams.ts` and confirmed that `karma` is initialized correctly there. I'm focusing on new user creation via auth in `authLogic.ts`. It seems the Karma data is on the Student object, not the User object. I'm checking `AdminMercato.tsx` to verify manual studio/student creations, specifically the `handleCreateSubmit` function. It looks like the members are created from `unassignedAgency`.\n\n\n**Finalizing the Adjustments**\n\nI've completed the Karma logic removal from both finance and peer review components. Specifically, I've removed the karma adjustments in `contexts/game/useFinanceLogic.ts` within the `transferFunds` and `injectCapital` functions, and in `components/student/TeamView.tsx` within the `handlePeerReview` function. The starting karma is now uniformly 50, as implemented in `config/teams.ts` when a new student is created. I've also verified this through the agency approval code path in `AdminMercato.tsx`, specifically checking the `handleApproveRequest` function.\n\n\n**Removing Karma Updates**\n\nI've now focused on removing the Karma adjustments within the finance and peer review components. I've removed the specific karma modification lines in both `transferFunds` and `injectCapital` functions within `contexts/game/useFinanceLogic.ts`. Also, I've entirely removed the Karma update logic within `components/student/TeamView.tsx` and modified the `handlePeerReview` function to exclude Karma adjustments.\n\n\n**Confirming Karma Logic**\n\nI'm now confirming the removal of all auto-karma bonuses and setting the baseline value. I've ensured the negative karma logic remains, as the focus was on the \"abuseable\" positive increments. The starting karma is consistently set to 50, and I'm currently reviewing `useFinanceLogic.ts` to confirm there is no accidental retention of karma bonuses.\n\n\n**Ensuring the Deductions**\n\nI've ensured that both `transferFunds` and `injectCapital` in `useFinanceLogic.ts` still manage wallet and agency budget changes, respectively, but no longer modify Karma. In `TeamView.tsx`, the `handlePeerReview` function still saves reviews correctly, now excluding any Karma modifications to the user object.\n\n\n",
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1768529529,
      "nanos": 215000000
    },
    "doneTimestamp": {
      "seconds": 1768529550,
      "nanos": 313000000
    }
  },
  {
    "id": 124,
    "author": "model",
    "payload": {
      "type": "text",
      "text": "C'est noté. C'est une décision de design très sage. Si le Karma récompense des actions mécaniques \"obligatoires\" (payer, voter), il devient une ressource à farmer (grind) plutôt qu'un indicateur de comportement.\n\nLe Karma devient donc une **valeur de réputation flottante** (Base 50) qui ne bougera que sur des événements critiques (Sanctions, MVP, et futur Black Market) plutôt que sur le quotidien.\n\nVoici les modifications pour retirer les gains automatiques et fixer la base à 50.\n\n### Spécifications des modifications\n\n1.  **Initialisation** : Dans `config/teams.ts`, tous les étudiants (mock data) démarrent avec **50 Karma** au lieu de 0.\n2.  **Finance** : Dans `useFinanceLogic.ts`, suppression du gain de Karma lors des fonctions `transferFunds` et `injectCapital`. L'action reste purement financière.\n3.  **RH** : Dans `TeamView.tsx`, suppression de la modification du profil étudiant lors d'une `peerReview`. On enregistre uniquement l'évaluation.\n\nVoici le code mis à jour :\n\n",
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1768529550,
      "nanos": 313000000
    },
    "doneTimestamp": {
      "seconds": 1768529550,
      "nanos": 313000000
    }
  },
  {
    "id": 125,
    "author": "model",
    "payload": {
      "type": "generationTable",
      "entries": [
        {
          "path": "config/teams.ts",
          "generationType": 1,
          "isDone": true,
          "description": "Initialisation du Karma à 50 (valeur neutre) pour tous les étudiants.",
          "diffs": [
            {
              "target": "",
              "replacement": "\nimport { Agency, CycleType, GameEvent, Student, Badge } from '../types';\nimport { BADGE_DEFINITIONS, S1_INDIVIDUAL_WINNERS, S1_AVERAGES } from './awards';\nimport { INITIAL_WEEKS } from './weeks';\nimport { GAME_RULES } from './rules';\n\n// --- LISTES DE RÉFÉRENCE POUR LES BADGES S1 (L'HISTORIQUE) ---\n// Ces listes servent uniquement à distribuer les badges aux bonnes personnes\nconst S1_GOLD_MEMBERS = [\"Zirwath\", \"Aubine\", \"Maëlys\", \"Tiffany\", \"Roxane\"];\nconst S1_SILVER_MEMBERS = [\"Rayane\", \"Erudice\", \"Pascal\", \"Jennifer\"];\nconst S1_BRONZE_MEMBERS = [\"Tryphose\", \"Sarah\", \"Grâce\", \"Stessy\"];\n\n// --- POOLS COMPLETS (POUR RÉFÉRENCE ET CHÔMAGE) ---\nconst STUDENTS_CLASSE_A_POOL = [\n    \"Marie-Trinité\", \"Jessica\", \"Lydia\", \"Ronelle\", \"Tiffany\",\n    \"Ian\", \"Kassandra\", \"Aubine\", \"Lidwine\", \"Sarah\",\n    \"Maëlys\", \"Rebecca\", \"Rolyx\", \"Emeraude\", \"Shaneen\",\n    \"Noriane\", \"Pascal\", \"Roxane\", \"Loan\", \"Korell\", \"Iris\"\n];\n\nconst STUDENTS_CLASSE_B_POOL = [\n    \"Tryphose\", \"Vianney\", \"Esther\", \"Achabys\", \"Zirwath\",\n    \"Elicia\", \"Loïs\", \"Coralie\", \"Ruth\", \"Lindsay\",\n    \"Ghintia\", \"Rayane\", \"Ashley\", \"Faghez\", \"Erudice\",\n    \"Myra\", \"Brunelle\", \"Stessy\", \"Duamel\", \"Grâce\", \"Jennifer\"\n];\n\n// --- DEFINITION DES EQUIPES MANUELLES ---\nconst TEAMS_A_SPECIFIC = [\n    [\"Roxane\", \"Sarah\"],\n    [\"Maëlys\", \"Ronelle\"],\n    [\"Iris\", \"Aubine\", \"Jessica\"],\n    [\"Shaneen\", \"Lydia\"],\n    [\"Rebecca\", \"Korell\"],\n    [\"Kassandra\", \"Pascal\"]\n];\n\nconst TEAMS_B_SPECIFIC = [\n    [\"Rayane\"],\n    [\"Faghez\", \"Achabys\"],\n    [\"Coralie\", \"Myra\"],\n    [\"Grâce\", \"Ashley\", \"Tryphose\"],\n    [\"Ruth\", \"Loïs\", \"Brunelle\"], // \"Ruth\" correspond à Ruth-De-Franck dans les stats S1\n    [\"Esther\", \"Erudice\"]\n];\n\nconst generateMockAgencies = (): Agency[] => {\n  const agencies: Agency[] = [];\n  let globalStudentIndex = 0;\n\n  // --- FONCTION DE CRÉATION D'ÉTUDIANT ---\n  const createStudent = (name: string, classId: 'A' | 'B'): Student => {\n      // 1. Récupération des données S1 (Score & Awards)\n      const individualAward = S1_INDIVIDUAL_WINNERS[name];\n      const averageS1 = S1_AVERAGES[name] || 10;\n      \n      // 2. Calcul du Score de départ S2\n      // Formule : SMIG (30) + Moyenne S1 (x2 pour base 40) + Bonus Badges (Indiv + Group)\n      const baseScore = 30;\n      const s1Part = averageS1 * 2;\n      \n      let bonusScore = 0;\n\n      // A. Bonus Badges Individuels\n      // Or = 10, Argent = 7.5, Bronze = 5\n      if (individualAward) {\n          if (individualAward.badge === 's1_gold') bonusScore += 10;\n          else if (individualAward.badge === 's1_silver') bonusScore += 7.5;\n          else if (individualAward.badge === 's1_bronze') bonusScore += 5;\n      }\n\n      // B. Bonus Badges Groupe\n      // Or = 10, Argent = 7.5, Bronze = 5\n      if (S1_GOLD_MEMBERS.includes(name)) {\n          bonusScore += 10; \n      } else if (S1_SILVER_MEMBERS.includes(name)) {\n          bonusScore += 7.5;\n      } else if (S1_BRONZE_MEMBERS.includes(name)) {\n          bonusScore += 5;\n      }\n\n      const calculatedScore = Math.round(baseScore + s1Part + bonusScore);\n\n      // 3. Attribution des Badges (Visuels)\n      const studentBadges: Badge[] = [];\n\n      // A. Badge Individuel (Major, Vice-Major...)\n      if (individualAward) {\n          const badgeDef = BADGE_DEFINITIONS.find(b => b.id === individualAward.badge);\n          if (badgeDef) studentBadges.push(badgeDef);\n      }\n\n      // B. Badge Historique Groupe S1 (Or/Argent/Bronze)\n      if (S1_GOLD_MEMBERS.includes(name)) {\n          const b = BADGE_DEFINITIONS.find(def => def.id === 's1_gold_group');\n          if (b) studentBadges.push(b);\n      }\n      if (S1_SILVER_MEMBERS.includes(name)) {\n          const b = BADGE_DEFINITIONS.find(def => def.id === 's1_silver_group');\n          if (b) studentBadges.push(b);\n      }\n      if (S1_BRONZE_MEMBERS.includes(name)) {\n          const b = BADGE_DEFINITIONS.find(def => def.id === 's1_bronze_group');\n          if (b) studentBadges.push(b);\n      }\n\n      return {\n        id: `s-${globalStudentIndex++}`, // ID technique unique\n        name: name,\n        role: 'Associé',\n        avatarUrl: `https://api.dicebear.com/7.x/avataaars/svg?seed=${name.replace(' ', '')}`,\n        individualScore: calculatedScore,\n        wallet: individualAward ? individualAward.amount : 0, // Cash prize S1 si applicable\n        karma: 50, // Karma initial NEUTRE (Base 50)\n        classId: classId,\n        connectionStatus: 'offline',\n        badges: studentBadges, // Liste des badges calculée\n        history: individualAward ? [{\n            date: \"2024-02-01\",\n            agencyId: \"system\",\n            agencyName: \"RNP Awards\",\n            action: \"JOINED\",\n            contextVE: 0,\n            contextBudget: 0,\n            reason: `Prix S1 (+${individualAward.amount} PiXi)`\n        }] : []\n      };\n  };\n\n  // --- 1. CRÉATION DES AGENCES CLASSE A (Assignées) ---\n  TEAMS_A_SPECIFIC.forEach((membersNames, index) => {\n      const agencyNum = index + 1;\n      const agencyId = `agency_A_${agencyNum}`;\n      const members = membersNames.map(name => createStudent(name, 'A'));\n\n      agencies.push({\n          id: agencyId,\n          name: `Agence A${agencyNum}`,\n          tagline: \"Nouvelle Agence S2\",\n          ve_current: 0, // START AT 0\n          status: 'critique', // Start in critic because VE < 40\n          classId: 'A',\n          budget_real: 0,\n          budget_valued: 0,\n          weeklyTax: 0,\n          weeklyRevenueModifier: 0,\n          eventLog: [\n             { id: `e-${agencyId}-1`, date: \"2024-02-01\", type: \"INFO\", label: \"Création Agence\", deltaVE: 0, description: \"Ouverture du compte PiXi (0).\" }\n          ],\n          members: members,\n          peerReviews: [],\n          currentCycle: CycleType.MARQUE_BRIEF,\n          projectDef: { problem: \"\", target: \"\", location: \"\", gesture: \"\", isLocked: false },\n          mercatoRequests: [],\n          transactionRequests: [], // Init empty\n          constraints: { space: \"\", style: \"\", client: \"\" },\n          progress: JSON.parse(JSON.stringify(INITIAL_WEEKS)),\n          branding: { color: 'indigo' }, // Couleur par défaut Classe A\n          badges: []\n      });\n  });\n\n  // --- 2. CRÉATION DES AGENCES CLASSE B (Assignées) ---\n  TEAMS_B_SPECIFIC.forEach((membersNames, index) => {\n      const agencyNum = index + 1;\n      const agencyId = `agency_B_${agencyNum}`;\n      const members = membersNames.map(name => createStudent(name, 'B'));\n\n      agencies.push({\n          id: agencyId,\n          name: `Agence B${agencyNum}`,\n          tagline: \"Nouvelle Agence S2\",\n          ve_current: 0, // START AT 0\n          status: 'critique',\n          classId: 'B',\n          budget_real: 0,\n          budget_valued: 0,\n          weeklyTax: 0,\n          weeklyRevenueModifier: 0,\n          eventLog: [\n             { id: `e-${agencyId}-1`, date: \"2024-02-01\", type: \"INFO\", label: \"Création Agence\", deltaVE: 0, description: \"Ouverture du compte PiXi (0).\" }\n          ],\n          members: members,\n          peerReviews: [],\n          currentCycle: CycleType.MARQUE_BRIEF,\n          projectDef: { problem: \"\", target: \"\", location: \"\", gesture: \"\", isLocked: false },\n          mercatoRequests: [],\n          transactionRequests: [], // Init empty\n          constraints: { space: \"\", style: \"\", client: \"\" },\n          progress: JSON.parse(JSON.stringify(INITIAL_WEEKS)),\n          branding: { color: 'cyan' }, // Couleur par défaut Classe B\n          badges: []\n      });\n  });\n\n  // --- 3. GESTION DES CHÔMEURS (Tous ceux qui ne sont pas dans les listes spécifiques) ---\n  const assignedA = TEAMS_A_SPECIFIC.flat();\n  const assignedB = TEAMS_B_SPECIFIC.flat();\n\n  const unemployedMembers: Student[] = [];\n\n  // Filtrer Classe A\n  STUDENTS_CLASSE_A_POOL.forEach(name => {\n      if (!assignedA.includes(name)) {\n          unemployedMembers.push(createStudent(name, 'A'));\n      }\n  });\n\n  // Filtrer Classe B\n  STUDENTS_CLASSE_B_POOL.forEach(name => {\n      if (!assignedB.includes(name)) {\n          unemployedMembers.push(createStudent(name, 'B'));\n      }\n  });\n\n  // Agence Chômage / Vivier\n  agencies.push({\n      id: 'unassigned',\n      name: \"Vivier / Chômage\",\n      tagline: \"En recherche d'opportunité\",\n      ve_current: 0,\n      status: 'critique',\n      classId: 'ALL', \n      budget_real: 0,\n      budget_valued: 0,\n      weeklyTax: 0,\n      weeklyRevenueModifier: 0,\n      eventLog: [],\n      members: unemployedMembers, // Tous les restants\n      peerReviews: [],\n      currentCycle: CycleType.MARQUE_BRIEF,\n      projectDef: { problem: \"\", target: \"\", location: \"\", gesture: \"\", isLocked: true },\n      mercatoRequests: [],\n      transactionRequests: [],\n      constraints: { space: \"\", style: \"\", client: \"\" },\n      progress: {},\n      branding: { color: 'slate' },\n      badges: []\n  });\n\n  return agencies;\n};\n\nexport const MOCK_AGENCIES: Agency[] = generateMockAgencies();\n"
            }
          ]
        },
        {
          "path": "contexts/game/useFinanceLogic.ts",
          "generationType": 1,
          "isDone": true,
          "description": "Retrait des bonus de Karma automatique lors des transactions financières.",
          "diffs": [
            {
              "target": "",
              "replacement": "\nimport { writeBatch, doc, updateDoc, db } from '../../services/firebase';\nimport { Agency, GameEvent, TransactionRequest } from '../../types';\nimport { GAME_RULES } from '../../constants';\n\nexport const useFinanceLogic = (agencies: Agency[], toast: (type: string, msg: string) => void) => {\n\n  const processFinance = async (targetClass: 'A' | 'B') => {\n      const today = new Date().toISOString().split('T')[0];\n      try {\n        const batch = writeBatch(db);\n        let processedCount = 0;\n\n        agencies.forEach(agency => {\n            if (agency.id === 'unassigned' || agency.classId !== targetClass) return;\n            processedCount++;\n\n            let currentBudget = agency.budget_real;\n            let logEvents: GameEvent[] = [];\n            // SAFETY: Ensure members array exists\n            let agencyMembers = [...(agency.members || [])];\n\n            // 1. REVENUES\n            const revenueVE = (agency.ve_current * GAME_RULES.REVENUE_VE_MULTIPLIER);\n            const bonuses = agency.weeklyRevenueModifier || 0;\n            const totalRevenue = revenueVE + bonuses + GAME_RULES.REVENUE_BASE;\n            \n            currentBudget += totalRevenue;\n            logEvents.push({ \n                id: `fin-rev-${Date.now()}-${agency.id}`, \n                date: today, \n                type: 'REVENUE', \n                label: 'Recettes', \n                deltaBudgetReal: totalRevenue, \n                description: `Facturation client (VE: ${agency.ve_current}).` \n            });\n\n            // 2. RENT & SOLIDARITY CLAUSE\n            const rent = GAME_RULES.AGENCY_RENT;\n            if (currentBudget >= rent) {\n                currentBudget -= rent;\n                logEvents.push({ id: `fin-rent-${Date.now()}-${agency.id}`, date: today, type: 'CRISIS', label: 'Loyer Agence', deltaBudgetReal: -rent, description: `Prélèvement automatique.` });\n            } else {\n                const paidByAgency = Math.max(0, currentBudget); \n                const deficit = rent - paidByAgency;\n                currentBudget -= paidByAgency; \n                \n                const membersCount = Math.max(1, agencyMembers.length);\n                const sharePerStudent = Math.ceil(deficit / membersCount);\n\n                logEvents.push({ \n                    id: `fin-rent-solidarity-${Date.now()}-${agency.id}`, \n                    date: today, \n                    type: 'CRISIS', \n                    label: 'CLAUSE SOLIDARITÉ', \n                    deltaBudgetReal: -paidByAgency, \n                    description: `Défaut de paiement. ${sharePerStudent} PiXi saisis sur chaque membre.` \n                });\n\n                agencyMembers = agencyMembers.map(m => ({\n                    ...m,\n                    wallet: (m.wallet || 0) - sharePerStudent\n                }));\n            }\n\n            // 3. SALARIES\n            let actualDisbursed = 0;\n            if (currentBudget >= 0) {\n                agencyMembers = agencyMembers.map(member => {\n                    const rawSalary = member.individualScore * GAME_RULES.SALARY_MULTIPLIER; \n                    const pay = Math.min(rawSalary, GAME_RULES.SALARY_CAP_FOR_STUDENT);\n                    actualDisbursed += pay;\n                    return { ...member, wallet: (member.wallet || 0) + pay };\n                });\n                \n                currentBudget -= actualDisbursed;\n                logEvents.push({ id: `fin-pay-${Date.now()}-${agency.id}`, date: today, type: 'PAYROLL', label: 'Salaires', deltaBudgetReal: -actualDisbursed, description: `Salaires versés.` });\n            } else {\n                logEvents.push({ id: `fin-pay-${Date.now()}-${agency.id}`, date: today, type: 'PAYROLL', label: 'Salaires Gelés', deltaBudgetReal: 0, description: `Dette active. Pas de salaire.` });\n            }\n\n            // 4. COST OF LIVING\n            agencyMembers = agencyMembers.map(member => {\n                let newWallet = (member.wallet || 0) - GAME_RULES.COST_OF_LIVING;\n                let newScore = member.individualScore;\n                if (newWallet < 0) {\n                    newScore = Math.max(0, newScore - GAME_RULES.POVERTY_SCORE_PENALTY);\n                }\n                return { ...member, wallet: newWallet, individualScore: newScore };\n            });\n\n            const ref = doc(db, \"agencies\", agency.id);\n            batch.update(ref, {\n                budget_real: currentBudget,\n                members: agencyMembers,\n                eventLog: [...agency.eventLog, ...logEvents]\n            });\n        });\n\n        if (processedCount > 0) {\n            await batch.commit();\n            toast('success', `Finance Classe ${targetClass}: Traitement Terminé.`);\n        }\n      } catch(e) { console.error(e); toast('error', \"Erreur Finance\"); }\n  };\n\n  const transferFunds = async (sourceId: string, targetId: string, amount: number) => { \n      const sourceAgency = agencies.find(a => a.members.some(m => m.id === sourceId));\n      if (!sourceAgency) return;\n      \n      const sourceStudent = sourceAgency.members.find(m => m.id === sourceId);\n      if(!sourceStudent || (sourceStudent.wallet || 0) < amount) {\n          toast('error', \"Fonds insuffisants.\");\n          return;\n      }\n\n      const targetAgency = agencies.find(a => a.members.some(m => m.id === targetId));\n      if(!targetAgency) return;\n\n      const batch = writeBatch(db);\n\n      // Debit source (PAS DE BONUS KARMA)\n      const updatedSourceMembers = sourceAgency.members.map(m => \n          m.id === sourceId \n          ? { ...m, wallet: (m.wallet || 0) - amount } \n          : m\n      );\n      batch.update(doc(db, \"agencies\", sourceAgency.id), { members: updatedSourceMembers });\n\n      // Credit target\n      const updatedTargetMembers = targetAgency.members.map(m => m.id === targetId ? { ...m, wallet: (m.wallet || 0) + amount } : m);\n      batch.update(doc(db, \"agencies\", targetAgency.id), { members: updatedTargetMembers });\n\n      await batch.commit();\n      toast('success', `Virement de ${amount} PiXi effectué.`);\n  };\n\n  const injectCapital = async (studentId: string, agencyId: string, amount: number) => { \n      const agency = agencies.find(a => a.id === agencyId);\n      if(!agency) return;\n      const student = agency.members.find(m => m.id === studentId);\n      if(!student || (student.wallet || 0) < amount) {\n          toast('error', \"Fonds insuffisants.\");\n          return;\n      }\n      \n      const tax = Math.floor(amount * GAME_RULES.INJECTION_TAX);\n      const netInjection = amount - tax;\n\n      const batch = writeBatch(db);\n      // PAS DE BONUS KARMA\n      const updatedMembers = agency.members.map(m => \n          m.id === studentId \n          ? { ...m, wallet: (m.wallet || 0) - amount } \n          : m\n      );\n      \n      const today = new Date().toISOString().split('T')[0];\n      const newEvent: GameEvent = {\n          id: `inj-${Date.now()}`,\n          date: today,\n          type: 'INFO',\n          label: 'Injection Capital',\n          deltaBudgetReal: netInjection,\n          description: `${student.name} injecte ${amount} PiXi (Taxe: ${tax}).`\n      };\n\n      batch.update(doc(db, \"agencies\", agency.id), { \n          members: updatedMembers, \n          budget_real: agency.budget_real + netInjection,\n          eventLog: [...agency.eventLog, newEvent] \n      });\n      await batch.commit();\n      toast('success', `Injection: +${netInjection} PiXi (Taxe -${tax})`);\n  };\n\n  const requestScorePurchase = async (studentId: string, agencyId: string, amountPixi: number, amountScore: number) => { \n     const agency = agencies.find(a => a.id === agencyId);\n     if(!agency) return;\n     const newRequest: TransactionRequest = { id: `req-score-${Date.now()}`, studentId, studentName: agency.members.find(m=>m.id===studentId)?.name || '', type: 'BUY_SCORE', amountPixi, amountScore, status: 'PENDING', date: new Date().toISOString().split('T')[0] };\n     await updateDoc(doc(db, \"agencies\", agency.id), { transactionRequests: [...(agency.transactionRequests || []), newRequest] });\n     toast('success', \"Demande envoyée\");\n  };\n\n  const handleTransactionRequest = async (agency: Agency, request: TransactionRequest, approved: boolean) => {\n      const batch = writeBatch(db);\n      const agencyRef = doc(db, \"agencies\", agency.id);\n      const updatedRequests = (agency.transactionRequests || []).filter(r => r.id !== request.id);\n      if (!approved) { batch.update(agencyRef, { transactionRequests: updatedRequests }); await batch.commit(); return; }\n      \n      const updatedMembers = agency.members.map(m => m.id === request.studentId ? { ...m, wallet: (m.wallet || 0) - request.amountPixi, individualScore: Math.min(100, m.individualScore + request.amountScore) } : m);\n      batch.update(agencyRef, { transactionRequests: updatedRequests, members: updatedMembers });\n      await batch.commit();\n      toast('success', \"Transaction validée\");\n  };\n\n  return { processFinance, transferFunds, injectCapital, requestScorePurchase, handleTransactionRequest };\n};\n"
            }
          ]
        },
        {
          "path": "components/student/TeamView.tsx",
          "generationType": 1,
          "isDone": true,
          "description": "Retrait du bonus de Karma lors de la participation à une Peer Review.",
          "diffs": [
            {
              "target": "",
              "replacement": "\nimport React, { useState } from 'react';\nimport { Agency, Student, PeerReview } from '../../types';\nimport { Clock, MessageCircle, Send, Lock, Coins, Award, Star, Wallet, Medal, HelpCircle, CheckCircle2 } from 'lucide-react';\nimport { Modal } from '../Modal';\nimport { GAME_RULES } from '../../constants';\nimport { useAuth } from '../../contexts/AuthContext';\nimport { useGame } from '../../contexts/GameContext'; // Import du GameContext\n\ninterface TeamViewProps {\n  agency: Agency;\n  onUpdateAgency: (agency: Agency) => void;\n}\n\nexport const TeamView: React.FC<TeamViewProps> = ({ agency, onUpdateAgency }) => {\n  const [selectedMember, setSelectedMember] = useState<Student | null>(null);\n  const [reviewMode, setReviewMode] = useState<Student | null>(null);\n  const [showSalaryInfo, setShowSalaryInfo] = useState(false);\n\n  const { currentUser: firebaseUser } = useAuth();\n  const { getCurrentGameWeek } = useGame(); // Récupération de la semaine actuelle\n  \n  // Correction Identity: Find the member that corresponds to the logged-in user\n  const currentUser = agency.members.find(m => m.id === firebaseUser?.uid);\n  const currentWeek = getCurrentGameWeek();\n\n  const handlePeerReview = (review: PeerReview) => {\n    // 1. Ajouter la review (PAS DE BONUS KARMA)\n    onUpdateAgency({\n        ...agency,\n        peerReviews: [...agency.peerReviews, review]\n    });\n    setReviewMode(null);\n  };\n\n  const hasReviewedMemberThisWeek = (targetId: string) => {\n      if (!currentUser) return false;\n      return agency.peerReviews.some(r => \n          r.reviewerId === currentUser.id && \n          r.targetId === targetId && \n          r.weekId === currentWeek.toString()\n      );\n  };\n\n  return (\n    <div className=\"animate-in slide-in-from-right-4 duration-500 pb-20\">\n        \n        {/* Header Action */}\n        <div className=\"flex justify-between items-center mb-6\">\n             <div>\n                <h3 className=\"text-xl font-bold text-slate-900\">Membres du Studio</h3>\n                <p className=\"text-xs text-slate-500\">Semaine {currentWeek} en cours</p>\n             </div>\n             <div className=\"flex gap-2\">\n                <span className=\"text-xs text-slate-400 self-center hidden md:block\">Connecté en tant que <strong>{currentUser?.name || 'Visiteur'}</strong></span>\n             </div>\n        </div>\n\n        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n            {agency.members.map(member => {\n                const salary = member.individualScore * GAME_RULES.SALARY_MULTIPLIER;\n                const isMe = member.id === currentUser?.id;\n                const alreadyReviewed = hasReviewedMemberThisWeek(member.id);\n                \n                return (\n                    <div \n                        key={member.id} \n                        className=\"bg-white p-6 rounded-3xl border border-slate-100 shadow-sm flex flex-col gap-4 group hover:shadow-md transition-all relative overflow-hidden\"\n                    >\n                        <div className=\"flex items-center gap-6 cursor-pointer\" onClick={() => setSelectedMember(member)}>\n                            <img src={member.avatarUrl} className=\"w-20 h-20 rounded-2xl bg-slate-100 group-hover:scale-105 transition-transform\" alt={member.name} />\n                            <div className=\"flex-1\">\n                                <h3 className=\"text-xl font-bold text-slate-900 group-hover:text-indigo-600 transition-colors flex items-center gap-2\">\n                                    {member.name}\n                                    {/* BADGE DISPLAY */}\n                                    {member.badges && member.badges.length > 0 && member.badges.map(b => (\n                                        <span key={b.id} title={b.label} className=\"text-yellow-500 bg-yellow-50 p-1 rounded-full border border-yellow-200\">\n                                            <Medal size={14}/>\n                                        </span>\n                                    ))}\n                                </h3>\n                                \n                                {/* SALARY BADGE (CLICKABLE) */}\n                                <div className=\"flex flex-col items-start mt-1 gap-1\">\n                                    <span className=\"text-[10px] font-bold text-slate-400 uppercase tracking-wider\">{member.role}</span>\n                                    <button \n                                        onClick={(e) => { e.stopPropagation(); setShowSalaryInfo(true); }}\n                                        className=\"inline-flex items-center gap-1 px-3 py-1 bg-red-50 border border-red-100 rounded-full text-xs font-bold text-red-600 hover:bg-red-100 transition-colors\"\n                                    >\n                                        <Coins size={12} />\n                                        -{salary} PiXi / sem\n                                        <HelpCircle size={10} className=\"opacity-50\"/>\n                                    </button>\n                                </div>\n                            </div>\n                            <div className=\"text-right flex flex-col items-end gap-1\">\n                                <div>\n                                    <span className=\"block text-4xl font-display font-bold text-indigo-600 leading-none\">{member.individualScore}</span>\n                                    <span className=\"text-[10px] font-bold text-slate-400 uppercase\">Score</span>\n                                </div>\n                                <div className=\"flex items-center gap-1 text-xs font-bold text-yellow-600 bg-yellow-50 px-2 py-0.5 rounded-full border border-yellow-100\">\n                                    <Wallet size={10}/> {member.wallet || 0}\n                                </div>\n                            </div>\n                        </div>\n\n                        {/* Action Buttons */}\n                        <div className=\"flex gap-2 mt-2 pt-4 border-t border-slate-50\">\n                            <button \n                                onClick={() => setSelectedMember(member)}\n                                className=\"flex-1 py-2 text-xs font-bold text-slate-500 bg-slate-50 rounded-xl hover:bg-slate-100 transition-colors\"\n                            >\n                                Voir Bulletin\n                            </button>\n                            {!isMe && currentUser && (\n                                alreadyReviewed ? (\n                                    <button \n                                        disabled\n                                        className=\"flex-1 py-2 text-xs font-bold text-emerald-600 bg-emerald-50 rounded-xl cursor-not-allowed flex items-center justify-center gap-2\"\n                                    >\n                                        <CheckCircle2 size={14}/> Évalué\n                                    </button>\n                                ) : (\n                                    <button \n                                        onClick={() => setReviewMode(member)}\n                                        className=\"flex-1 py-2 text-xs font-bold text-indigo-600 bg-indigo-50 rounded-xl hover:bg-indigo-100 transition-colors flex items-center justify-center gap-2\"\n                                    >\n                                        <MessageCircle size={14}/> Évaluer\n                                    </button>\n                                )\n                            )}\n                        </div>\n                    </div>\n                );\n            })}\n        </div>\n\n        {/* MODAL: SALARY RULES */}\n        <Modal isOpen={showSalaryInfo} onClose={() => setShowSalaryInfo(false)} title=\"Règles Salariales\">\n            <div className=\"space-y-6\">\n                <div className=\"bg-red-50 p-4 rounded-xl border border-red-100 text-sm text-red-800\">\n                    <strong className=\"block mb-2\">Le Salaire = Charge pour l'agence.</strong>\n                    Chaque étudiant coûte de l'argent à son entreprise chaque semaine.\n                    <br/>Plus vous êtes performant (Score élevé), plus votre salaire est haut.\n                </div>\n                <ul className=\"space-y-3 text-sm text-slate-600\">\n                    <li className=\"flex gap-3 items-start\">\n                        <div className=\"p-1 bg-slate-100 rounded text-slate-500\"><Coins size={16}/></div>\n                        <div>\n                            <strong>Calcul :</strong> Score Individuel x {GAME_RULES.SALARY_MULTIPLIER} PiXi.\n                            <br/><span className=\"text-xs italic opacity-75\">Ex: Score 80 = 800 PiXi/semaine.</span>\n                        </div>\n                    </li>\n                    <li className=\"flex gap-3 items-start\">\n                        <div className=\"p-1 bg-slate-100 rounded text-slate-500\"><Wallet size={16}/></div>\n                        <div>\n                            <strong>Poche Perso :</strong> Vous recevez ce salaire dans votre portefeuille personnel (jusqu'à {GAME_RULES.SALARY_CAP_FOR_STUDENT} PiXi max).\n                            <br/><span className=\"text-xs italic opacity-75\">Le surplus éventuel est absorbé par les charges.</span>\n                        </div>\n                    </li>\n                    <li className=\"flex gap-3 items-start\">\n                        <div className=\"p-1 bg-slate-100 rounded text-slate-500\"><Award size={16}/></div>\n                        <div>\n                            <strong>Comment monter son score ?</strong>\n                            <ul className=\"list-disc pl-4 mt-1 space-y-1\">\n                                <li>Assiduité et Ponctualité (Review des pairs).</li>\n                                <li>Qualité du travail rendu.</li>\n                                <li>Bonus \"Bounty\" techniques validés par le prof.</li>\n                            </ul>\n                        </div>\n                    </li>\n                </ul>\n                <button onClick={() => setShowSalaryInfo(false)} className=\"w-full py-3 bg-slate-900 text-white font-bold rounded-xl hover:bg-slate-800\">Compris</button>\n            </div>\n        </Modal>\n\n        {/* MODAL: Détail Note Élève */}\n        <Modal isOpen={!!selectedMember} onClose={() => setSelectedMember(null)} title=\"Bulletin Individuel\">\n            {selectedMember && (\n                <div className=\"space-y-6\">\n                    <div className=\"flex items-center gap-4 mb-6\">\n                        <img src={selectedMember.avatarUrl} className=\"w-16 h-16 rounded-2xl bg-slate-100\" />\n                        <div>\n                            <div className=\"flex items-center gap-2\">\n                                <h4 className=\"text-xl font-bold text-slate-900\">{selectedMember.name}</h4>\n                                {selectedMember.badges?.map(b => (\n                                    <span key={b.id} className=\"text-[10px] bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded-full font-bold border border-yellow-200\">\n                                        {b.label}\n                                    </span>\n                                ))}\n                            </div>\n                            <p className=\"text-slate-500 text-sm\">{selectedMember.role}</p>\n                            <p className=\"text-red-500 font-bold text-xs mt-1\">Coût salarial: {selectedMember.individualScore * GAME_RULES.SALARY_MULTIPLIER} PiXi / sem</p>\n                        </div>\n                        <div className=\"ml-auto text-center\">\n                            <span className=\"block text-3xl font-display font-bold text-indigo-600\">{selectedMember.individualScore}</span>\n                            <span className=\"text-[10px] uppercase font-bold text-slate-400\">Total / 100</span>\n                        </div>\n                    </div>\n\n                    <div className=\"space-y-4\">\n                        <div className=\"bg-slate-50 rounded-xl p-4 border border-slate-100\">\n                             <div className=\"flex justify-between items-center mb-2\">\n                                <div className=\"flex items-center gap-2 text-slate-700 font-bold text-sm\">\n                                    <Wallet size={16} className=\"text-yellow-500\" /> Portefeuille Personnel\n                                </div>\n                                <span className=\"font-bold text-yellow-600\">{selectedMember.wallet || 0} PiXi</span>\n                             </div>\n                             <p className=\"text-xs text-slate-400 italic\">Accumulé via salaires et bonus.</p>\n                        </div>\n\n                        {/* Mock Breakdown Data for visualization */}\n                        <div className=\"bg-slate-50 rounded-xl p-4 border border-slate-100\">\n                             <div className=\"flex justify-between items-center mb-2\">\n                                <div className=\"flex items-center gap-2 text-slate-700 font-bold text-sm\">\n                                    <Clock size={16} className=\"text-emerald-500\" /> Assiduité & Ponctualité\n                                </div>\n                                <span className=\"font-bold text-emerald-600\">20/20</span>\n                             </div>\n                             <div className=\"w-full bg-slate-200 rounded-full h-2\">\n                                <div className=\"bg-emerald-500 h-2 rounded-full\" style={{ width: '100%' }}></div>\n                             </div>\n                        </div>\n\n                        <div className=\"bg-slate-50 rounded-xl p-4 border border-slate-100\">\n                             <div className=\"flex justify-between items-center mb-2\">\n                                <div className=\"flex items-center gap-2 text-slate-700 font-bold text-sm\">\n                                    <Award size={16} className=\"text-amber-500\" /> Qualité des Rendus (Perso)\n                                </div>\n                                <span className=\"font-bold text-amber-600\">{(selectedMember.individualScore || 0) - 25}/60</span>\n                             </div>\n                             <div className=\"w-full bg-slate-200 rounded-full h-2\">\n                                <div className=\"bg-amber-500 h-2 rounded-full\" style={{ width: `${((selectedMember.individualScore - 25)/60)*100}%` }}></div>\n                             </div>\n                        </div>\n\n                        <div className=\"bg-slate-50 rounded-xl p-4 border border-slate-100\">\n                             <div className=\"flex justify-between items-center mb-2\">\n                                <div className=\"flex items-center gap-2 text-slate-700 font-bold text-sm\">\n                                    <Star size={16} className=\"text-indigo-500\" /> Bonus Rôle & Implication\n                                </div>\n                                <span className=\"font-bold text-indigo-600\">5/20</span>\n                             </div>\n                             <div className=\"w-full bg-slate-200 rounded-full h-2\">\n                                <div className=\"bg-indigo-500 h-2 rounded-full\" style={{ width: '25%' }}></div>\n                             </div>\n                        </div>\n                    </div>\n                </div>\n            )}\n        </Modal>\n\n        {/* MODAL: Peer Review Form */}\n        {reviewMode && currentUser && (\n            <PeerReviewForm \n                reviewer={currentUser}\n                target={reviewMode}\n                weekId={currentWeek.toString()}\n                onClose={() => setReviewMode(null)}\n                onSubmit={handlePeerReview}\n            />\n        )}\n    </div>\n  );\n};\n\n// ----------------------------------------------------------------------\n// INTERNAL: Peer Review Form Component\n// ----------------------------------------------------------------------\ninterface PeerReviewFormProps {\n    reviewer: Student;\n    target: Student;\n    weekId: string;\n    onClose: () => void;\n    onSubmit: (review: PeerReview) => void;\n}\n\nconst PeerReviewForm: React.FC<PeerReviewFormProps> = ({ reviewer, target, weekId, onClose, onSubmit }) => {\n    const [attendance, setAttendance] = useState(3);\n    const [quality, setQuality] = useState(3);\n    const [involvement, setInvolvement] = useState(3);\n    const [comment, setComment] = useState(\"\");\n\n    const handleSubmit = () => {\n        const review: PeerReview = {\n            id: `rev-${Date.now()}`,\n            weekId: weekId, \n            date: new Date().toISOString().split('T')[0],\n            reviewerId: reviewer.id,\n            reviewerName: reviewer.name,\n            targetId: target.id,\n            targetName: target.name,\n            ratings: { attendance, quality, involvement },\n            comment\n        };\n        onSubmit(review);\n    };\n\n    return (\n        <Modal isOpen={true} onClose={onClose} title={`Évaluation Hebdo (Sem ${weekId}): ${target.name}`}>\n            <div className=\"space-y-6\">\n                <div className=\"bg-indigo-50 p-4 rounded-xl border border-indigo-100 text-sm text-indigo-800\">\n                    Soyez honnête et constructif. Ces notes impactent le score individuel de votre collègue.\n                    <br/><strong>Attention :</strong> Vous ne pouvez évaluer qu'une seule fois par semaine.\n                </div>\n\n                <div className=\"space-y-4\">\n                    <RangeInput label=\"Assiduité / Ponctualité\" value={attendance} onChange={setAttendance} icon={<Clock size={16} className=\"text-emerald-500\"/>} />\n                    <RangeInput label=\"Qualité du travail\" value={quality} onChange={setQuality} icon={<Award size={16} className=\"text-amber-500\"/>} />\n                    <RangeInput label=\"Implication / Esprit d'équipe\" value={involvement} onChange={setInvolvement} icon={<Star size={16} className=\"text-indigo-500\"/>} />\n                </div>\n\n                <div>\n                    <div className=\"flex justify-between items-end mb-2\">\n                        <label className=\"block text-sm font-bold text-slate-700\">Feedback Privé (Optionnel)</label>\n                        <span className=\"text-slate-400 flex items-center gap-1 bg-slate-50 px-2 py-1 rounded-md border border-slate-100 text-[10px]\">\n                            <Lock size={10} /> Visible uniquement par l'admin\n                        </span>\n                    </div>\n                    <textarea \n                        value={comment}\n                        onChange={e => setComment(e.target.value)}\n                        placeholder=\"Ex: Excellent travail sur le lighting, mais attention aux retards le matin...\"\n                        className=\"w-full p-3 rounded-xl border border-slate-200 text-sm bg-white text-slate-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 min-h-[80px]\"\n                    />\n                </div>\n\n                <button \n                    onClick={handleSubmit}\n                    className=\"w-full bg-slate-900 text-white font-bold py-3 rounded-xl hover:bg-indigo-600 transition-colors flex justify-center items-center gap-2\"\n                >\n                    <Send size={18} />\n                    Envoyer l'évaluation (Définitif)\n                </button>\n            </div>\n        </Modal>\n    );\n};\n\nconst RangeInput: React.FC<{label: string, value: number, onChange: (v: number) => void, icon: React.ReactNode}> = ({label, value, onChange, icon}) => (\n    <div>\n        <div className=\"flex justify-between mb-2\">\n            <label className=\"text-sm font-bold text-slate-700 flex items-center gap-2\">{icon} {label}</label>\n            <span className=\"font-bold text-slate-900\">{value}/5</span>\n        </div>\n        <input \n            type=\"range\" \n            min=\"1\" \n            max=\"5\" \n            step=\"0.5\"\n            value={value} \n            onChange={(e) => onChange(parseFloat(e.target.value))}\n            className=\"w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-600\"\n        />\n        <div className=\"flex justify-between text-[10px] text-slate-400 font-bold uppercase mt-1\">\n            <span>Médiocre</span>\n            <span>Excellent</span>\n        </div>\n    </div>\n);\n"
            }
          ]
        }
      ]
    },
    "createdTimestamp": {
      "seconds": 1768529552,
      "nanos": 994000000
    },
    "doneTimestamp": {
      "seconds": 1768529568,
      "nanos": 920000000
    }
  },
  {
    "id": 127,
    "author": "user",
    "payload": {
      "type": "text",
      "text": "Good job\n\nmaintenant, parlons de notre marché noir, celui qui pourra contenir les black Ops, et autres \" dark moves \"\n\nNE CHANGES PAS LE CODE, ON EST EN IDEATION PURE POUR L'INSTANT",
      "files": [],
      "fileUploads": [],
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1768530027,
      "nanos": 946000000
    }
  },
  {
    "id": 128,
    "author": "model",
    "payload": {
      "type": "thinking",
      "text": "**Considering the Request's Scope**\n\nI'm initially defining the user's intent. The core of my analysis focuses on the term \"Black Market\" and its implications. I've broken down the request into key components: the need for ideation, the target concept of a black market, and the added context of 'Black Ops'. This seems like a promising starting point to begin a relevant ideation.\n\n\n**Deconstructing the \"Black Market\"**\n\nI'm now deeply focused on deconstructing the \"Black Market\" concept within the app's context. I'm exploring *where* it resides, *when* it's accessible (night hours, great!), currency options (PiXi or Karma?), and the crucial risk/reward dynamics. This builds on our recent \"Karma\" implementation, individual wallets, and market view. I'm actively brainstorming specific \"Dark Moves\" categories, starting with espionage-focused information gathering.\n\n\n**Expanding the Market Offerings**\n\nI'm now generating specific \"Dark Move\" ideas across various categories. I've fleshed out new options for Sabotage, including the existing \"Audit\" and brainstorming more aggressive moves like DDOS attacks and reputation manipulation via a \"Rumor Mill.\" Personal Gain options include fake reviews, certificates, and potential \"Money Laundering.\" I'm also considering redemption mechanics – could low Karma be bought back through an \"Indulgence\"? Finally, I've decided time-based visibility will govern market access.\n\n\n**Refining the Black Market**\n\nI'm now diving into the finer points. I'm imagining a \"Broker\" figure, maybe \"Shadow.\" The cost is now Karma-based: each transaction automatically reduces Karma. This ties into the concept that Karma tracks behavior. The structure of the proposal includes time-restricted access, PiXi and Karma currency, and a catalog of items with associated risks. I'm generating items like \"Deep Leak,\" \"Ghost Writer,\" and \"Diplomatic Immunity.\"\n\n\n**Developing Risk Mechanisms**\n\nI'm now focusing on risk and reward. Sabotage ideas include forcing an audit on another agency if fraud is detected. I'm also gamifying risk: each transaction has a failure chance leading to lost Karma and admin alerts. I'm excited to draft the response, structuring it around the Night Shift concept, time-based access, the catalog, the Karma economy, and UI/UX ideas like a glitch effect. I'm also evaluating constraints.\n\n\n**Analyzing Karma's Role**\n\nI've realized Karma, as currently designed, presents a challenge for explicit trading. Instead, I'm pivoting to a consumption model. The Black Market will now subtly deplete Karma, making students \"toxic\" without revealing the exact amount. It's a risk management mechanic where they're warned about reputation damage, encouraging thoughtful choices.\n\n\n",
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1768530027,
      "nanos": 946000000
    },
    "doneTimestamp": {
      "seconds": 1768530050,
      "nanos": 836000000
    }
  },
  {
    "id": 129,
    "author": "model",
    "payload": {
      "type": "text",
      "text": "C'est parti pour l'idéation pure. J'adore cette direction. Le **Marché Noir** (que l'on pourrait appeler le **\"Shadow Market\"** ou le **\"22-04\"**) va transformer l'expérience d'une simple gestion de classe en un véritable jeu de stratégie psychologique.\n\nL'idée de la **fenêtre temporelle (22h - 04h)** est brillante : elle gamifie l'insomnie étudiante et crée un sentiment d'exclusivité et de secret (\"Ce qui se passe la nuit reste la nuit\").\n\nVoici le concept détaillé pour ce **Marché Noir** :\n\n### 1. Le Concept : \"Le 22-04\"\n\n*   **Disponibilité :** Le bouton d'accès n'apparaît littéralement **que** si l'heure locale de l'utilisateur est entre 22h00 et 04h00. Le reste du temps, il est invisible ou désactivé (indiquant \"Fermé - Revenez la nuit\").\n*   **Monnaie :** On paie en **PiXi** (Wallet Personnel).\n*   **Coût Caché :** Chaque transaction coûte du **Karma**.\n    *   L'étudiant ne le sait pas *exactement*, mais un avertissement s'affiche : *\"Vos actions ont des conséquences sur votre réputation.\"*\n    *   Utiliser le Marché Noir transforme progressivement l'étudiant en \"profil toxique\" aux yeux de l'algorithme (et donc de l'enseignant).\n\n### 2. Le Catalogue \"Dark Moves\"\n\nVoici les items que l'on pourrait y vendre. Je les ai classés par type d'impact.\n\n#### A. Renseignement (Espionnage)\n*   **Le \"Deep Leak\" (300 PiXi)** :\n    *   *Effet :* Affiche un indice cryptique sur le brief ou la contrainte de la semaine prochaine.\n    *   *Utilité :* Permet de commencer à travailler ou de réfléchir avant les autres.\n*   **Le \"Salary Reveal\" (150 PiXi)** :\n    *   *Effet :* Révèle le montant exact du salaire (et donc le Score) d'un étudiant cible d'une autre agence.\n    *   *Utilité :* Indispensable pour négocier un débauchage (Mercato) précis.\n*   **L'Oracle Boursier (200 PiXi)** :\n    *   *Effet :* Indique si une \"Crise\" est programmée par l'admin dans les 48h.\n\n#### B. Sabotage (PvP - Player vs Player)\n*   **L'Audit Hostile (Déjà existant, mais déplacé ici)** :\n    *   Attaque la crédibilité d'une agence adverse.\n*   **Le \"DDOS\" Administratif (600 PiXi - Très Cher)** :\n    *   *Effet :* Bloque l'upload de fichiers pour une agence cible pendant 1h (juste avant la deadline, c'est mortel).\n    *   *Contre-mesure :* L'agence cible peut acheter un \"Firewall\" préventif.\n*   **La Rumeur (400 PiXi)** :\n    *   *Effet :* Inflige un malus temporaire de -2 VE à une agence cible pour \"Mauvaise Presse\".\n\n#### C. Corruption (Avantages Personnels)\n*   **Le Faux Certificat (500 PiXi)** :\n    *   *Effet :* Annule rétroactivement une pénalité de retard individuelle (supprime un retard noté dans le système).\n    *   *Risque :* 20% de chance que l'Admin s'en rende compte (Notification : \"Tentative de fraude détectée\"). Si pris : -20 Karma et -10 Score.\n*   **L'Achat de Vote (200 PiXi)** :\n    *   *Effet :* Ajoute un vote \"FANTÔME\" positif lors d'une procédure de recrutement ou de licenciement. Permet de faire pencher la balance démocratique.\n\n#### D. Blanchiment (Gestion de Dette)\n*   **Le Prêteur sur Gages (Shark Loan)** :\n    *   *Effet :* Vous recevez 1000 PiXi tout de suite.\n    *   *Coût :* Vous devez rembourser 1500 PiXi sous 2 semaines. Sinon, saisie automatique sur salaire + Banqueroute Perso.\n\n### 3. La Mécanique de Risque (RNG)\n\nLe Marché Noir ne doit pas être sûr à 100%. Il doit y avoir du frisson.\n\nPour chaque action \"agressive\" (Sabotage, Faux Certificat), il y a un **taux d'échec (Failure Rate)** :\n*   **Succès :** L'action passe, personne ne sait qui a fait le coup.\n*   **Échec Critique :** L'action échoue, l'argent est perdu, ET une notification publique est envoyée dans le News Ticker : *\"Une tentative de sabotage contre l'Agence X a échoué. L'auteur a laissé des traces...\"* (Sans nommer l'étudiant, mais en créant la paranoïa).\n\n### 4. Idées UI/UX (Ambiance)\n\n*   **Design :** Quand on entre dans le Marché Noir, l'interface change.\n    *   Fond noir/vert \"Matrix\" ou Cyberpunk sombre.\n    *   Police d'écriture monospace (type terminal).\n    *   Musique de fond ou sons d'ambiance (léger grésillement) ?\n*   **Le Vendeur :** Un personnage mystérieux (IA) qui vous parle.\n    *   *\"Il est tard, étudiant. Tu cherches un avantage ?\"*\n    *   *\"Attention, le Karma ne dort jamais.\"*\n\n### 5. Intégration avec le Karma\n\nC'est ici que ton système de Karma secret prend tout son sens :\n\n*   Achat d'info : **-2 Karma**\n*   Sabotage : **-10 Karma**\n*   Corruption : **-15 Karma**\n\nSi un étudiant abuse du Marché Noir, son Karma va chuter vers 0 ou négatif.\nL'enseignant verra dans son tableau \"Karma Police\" qui sont les \"Parrains\" de la mafia étudiante, sans que les étudiants ne sachent pourquoi le prof les surveille de plus près.\n\nQu'en penses-tu ? On garde cette structure pour la future implémentation ?",
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1768530050,
      "nanos": 836000000
    },
    "doneTimestamp": {
      "seconds": 1768530050,
      "nanos": 837000000
    }
  },
  {
    "id": 130,
    "author": "user",
    "payload": {
      "type": "text",
      "text": "Oui ! mais pas \" désactivé \", INVISIBLE, TOTALEMENT\n\net les dark moves, j'ai l'impression qu'ils ne sont pas suffisamment recherchés, j'ai l'impression que c'est TROP EN SURFACE, tu peux me proposer bien mieux\n\nj'aime particulièrement ton idée d'UI Matrix et le vendeur RP\n\nmais je trouve que tu n'as pas suffisamment étudié les possibilités, interactions, abus UX et réalités du jeu avant de proposer certains d'entre eux ( le salary reveal, le deep leak ou l'oracle boursier par exemple, bonnes idées, mais elles ne fonctionne pas sur un jeu qui t'explique en amont ses livrables des semaines suivantes et qui n'a aucune crise pré-programmée côté prof)\n\n\non a une bonne direction mais on doit la challenger\n\nNE CHANGES PAS LE CODE, ON EST EN IDEATION PURE POUR L'INSTANT",
      "files": [],
      "fileUploads": [],
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1768531034,
      "nanos": 524000000
    }
  },
  {
    "id": 131,
    "author": "model",
    "payload": {
      "type": "thinking",
      "text": "**Revising Invisible Concepts**\n\nI'm now zeroing in on the \"Black Market\" revamp. The key is invisibility outside of the specified timeframe. It's not about being merely disabled; it has to vanish entirely from the user interface until the clock strikes 22:00. This is the central constraint driving my current revisions.\n\n\n**Uncovering Game Exploits**\n\nI'm now shifting my focus, exploring exploitable loopholes within the game's existing mechanics. The *VE* system presents opportunities for artificial inflation and short-selling, while peer reviews open doors for vote manipulation and even doxxing. File deadlines offer chances for corruption and retroactive timestamping. I'm aiming for deeper, more meta interactions that exploit the core *RNP Manager* features. So far, the \"Matrix UI\" and \"RP Seller\" persona are sticking as possible design considerations.\n\n\n**Developing Covert Strategies**\n\nMy attention is now focused on \"Dark Operations,\" specifically psychological warfare and administrative sabotage. I'm building out categories for specific exploits. The Doxx, which breaks peer review anonymity, is taking shape, and \"The Ghost Headhunter\" concept is also coming along. \"The Corrupted Zip\" is also taking shape, involving files that appear valid but cause admin errors. I'm also developing cash transfer exploits and admin confusion tactics.\n\n\n**Constructing Deceitful Tactics**\n\nI'm now delving into exploitative strategies, specifically a \"Time Warp\" exploit that retroactively changes timestamps to avoid late penalties. I'm also devising a \"Offshore Account\" to conceal budget portions, creating the appearance of poverty. Additionally, the \"Short Selling\" tactic is forming, allowing bets on the VE scores of other agencies. Finally, I'm conceptualizing \"Indulgence Plenary,\" which allows wiping bad karma for a price.\n\n\n**Formulating Shadow Access**\n\nI'm now iterating on the Black Market's UI/UX. The \"Invisible\" element will be a time-based flicker, appearing at 22:00. This prompts a new persona, \"The Broker\", a cynical AI dealer. I'm also structuring the proposal, defining its access point (\"the glitch\"), the dealer's tone, the catalog by deeper categories (Social, Technical, Financial), and the costs: Money, Karma, and Risk. I also revamped the \"Salary Reveal\" to become the exciting \"Feedback Leak\", paying to see private feedback or logs.\n\n\n**Devising Agency Advantages**\n\nI'm now revising my \"Insider\" concept to exploit crisis management. Instead of triggering crises, the Black Market could offer \"Immunity,\" allowing an agency to be excluded from the next global crisis. This is a powerful, yet balanced mechanic. I'm also preparing to use dark, exciting language like \"Zero-Day Exploit\" to enhance the experience. I'm focusing on crafting a dangerous tone.\n\n\n",
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1768531034,
      "nanos": 524000000
    },
    "doneTimestamp": {
      "seconds": 1768531059,
      "nanos": 297000000
    }
  },
  {
    "id": 132,
    "author": "model",
    "payload": {
      "type": "text",
      "text": "C'est reçu 5/5. Tu as raison, mes premières propositions étaient trop \"gentilles\" et mécaniques. Pour qu'un **Marché Noir** soit excitant, il doit être **transgressif**, jouer sur la psychologie des étudiants (paranoïa, trahison, paresse) et exploiter les \"failles\" d'un système éducatif.\n\nVoici une refonte complète du concept **\"Le 22-04\"**, beaucoup plus vicieuse et méta.\n\n---\n\n### 1. L'Accès : Le \"Glitch\" Temporel\n\n*   **Invisibilité Totale :** En journée, le code n'est même pas rendu dans le DOM. Aucun bouton grisé. Rien.\n*   **L'Apparition :** À 22h00 précises, une icône \"Bug\" (un petit pixel mort ou un glitch visuel) apparaît discrètement dans le footer ou la sidebar.\n*   **L'Ambiances :**\n    *   Au clic, l'interface bascule en **Dark Mode inversé** (Terminal vert phosphorescent sur fond noir).\n    *   Le ton change. Ce n'est plus \"RNP Manager\", c'est **\"THE BACKDOOR\"**.\n    *   **Le Dealer (IA)** : Il ne te dit pas \"Bienvenue\". Il te dit : *\"Tu devrais dormir. Mais puisque tu es là, voyons ce que tu es prêt à sacrifier.\"*\n\n---\n\n### 2. Le Catalogue \"Deep Web\" (Revisité)\n\nOn oublie les bonus de jeu vidéo. Voici des outils de triche, de manipulation et de finance souterraine.\n\n#### A. Sabotage Administratif (L'Exploit \"Glitch\")\n*Cible : La relation Professeur-Élève et les rendus.*\n\n1.  **Le \"Corrupted File\" (800 PiXi)**\n    *   *Le concept :* L'étudiant n'a pas fini son rendu à temps.\n    *   *L'effet :* Le système génère un fichier `.pdf` ou `.mp4` qui a la bonne taille, le bon nom, mais qui est **techniquement corrompu**.\n    *   *Le but :* Quand le prof essaie de l'ouvrir pour corriger, ça plante. Le prof pense à un bug technique et demande un ré-upload.\n    *   *Le Gain :* L'étudiant gagne **24h à 48h de délai** \"légitime\" pour finir son travail sans pénalité de retard.\n    *   *Le Risque :* Si le prof analyse les métadonnées, il voit que c'est un faux fichier. (-50 VE).\n\n2.  **Le \"Timestamp Spoofing\" (1200 PiXi - Très Cher)**\n    *   *Le concept :* L'étudiant est en retard de 15 minutes.\n    *   *L'effet :* Modifie l'heure d'affichage du rendu dans le dashboard Admin. Un rendu déposé à 09h15 apparaît comme déposé à 08h59.\n    *   *Le Risque :* C'est visuel seulement. Si le prof a reçu une notif mail à 09h15, il saura.\n\n#### B. Guerre Psychologique (Le \"Social Engineering\")\n*Cible : La confiance au sein des équipes adverses.*\n\n3.  **Le \"Doxxing RH\" (600 PiXi)**\n    *   *Le concept :* L'anonymat des Peer Reviews est sacré... sauf ici.\n    *   *L'effet :* Révèle **qui** t'a mis une sale note cette semaine. \"C'est Julien qui t'a mis 1/5 en implication.\"\n    *   *Le But :* Créer du conflit interne, régler des comptes, ou purger l'agence.\n\n4.  **Le \"Ghost Offer\" (400 PiXi)**\n    *   *Le concept :* Semer la zizanie chez les concurrents.\n    *   *L'effet :* Envoie une fausse notification système à un membre d'une agence rivale : *\"L'Agence Alpha vous a envoyé une offre de recrutement secrète.\"*\n    *   *Le But :* L'Agence Alpha n'a rien envoyé, mais le membre cible va croire qu'il est désiré ailleurs. Il va se désengager de son équipe actuelle ou devenir arrogant.\n\n#### C. Finance de l'Ombre (Le \"Wolf of Wall Street\")\n*Cible : La VE et le PiXi.*\n\n5.  **Le \"Short Selling\" (Vente à Découvert)**\n    *   *Le concept :* Parier sur l'échec.\n    *   *L'action :* Tu mises 500 PiXi que l'Agence X va perdre de la VE cette semaine (mauvais rendu, crise).\n    *   *L'effet :* Si l'Agence X se plante (ou si tu les as sabotés...), tu gagnes 1000 PiXi.\n    *   *La perversité :* Ça incite les étudiants à saboter les oraux des autres pour s'enrichir.\n\n6.  **Le \"Tax Haven\" (Paradis Fiscal - 10% de frais)**\n    *   *Le concept :* Cacher de l'argent.\n    *   *L'effet :* Transférer du budget Agence vers une \"Caisse Noire\" invisible.\n    *   *Le But :* Si l'agence fait faillite (-5000), cet argent est sauvé. Si l'agence est trop riche et a peur d'un \"Audit de Richesse\" (taxe sur les riches), l'argent est invisible.\n\n#### D. Le Joker Ultime (Le \"Deus Ex Machina\")\n\n7.  **Le \"Rollback\" (Prix : 50% du Wallet + 80 Karma)**\n    *   *Le concept :* L'erreur fatale.\n    *   *L'effet :* Annule la toute dernière action faite sur l'app (ex: un virement d'argent par erreur, une démission rageuse, un fichier écrasé).\n    *   *Limite :* Ne fonctionne que si l'action a moins de 10 minutes.\n\n---\n\n### 3. Le Coût du \"Karma\" (Réputation Secrète)\n\nC'est là que ton système de Karma (invisible pour eux) brille.\n\n*   Acheter un \"Corrupted File\" = **-30 Karma**.\n*   Acheter un \"Doxxing RH\" = **-50 Karma**.\n\n**Conséquence long terme (Invisible) :**\nL'enseignant a un indicateur \"Indice de Toxicité\" sur son dashboard.\nSi un étudiant abuse du Marché Noir, son nom apparaît en ROUGE sur le dashboard prof avec la mention \"Profil à risque / Manipulateur\".\nLe prof ne saura pas *exactement* ce qu'il a fait (secret bancaire du jeu), mais il saura qu'il doit être plus sévère avec cet étudiant lors des jurys.\n\n### 4. L'Expérience Utilisateur (UX) du Marché\n\n*   **Pas de confirmation \"Êtes-vous sûr ?\".** Le clic est fatal. Tu cliques, tu paies.\n*   **Vitesse :** Les offres expirent. \"Le Short Selling ferme dans 10 minutes\". Ça crée de l'impulsion.\n*   **Le Reçu :** Pas de trace dans l'historique officiel (\"Transaction Inconnue\" ou \"Frais de maintenance\").\n\nQu'en penses-tu ? On est beaucoup plus dans une dynamique \"Mr. Robot\" / \"House of Cards\" scolaire qui colle avec l'idée d'apprendre à gérer une entreprise (et ses aspects sombres).",
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1768531059,
      "nanos": 297000000
    },
    "doneTimestamp": {
      "seconds": 1768531059,
      "nanos": 297000000
    }
  },
  {
    "id": 133,
    "author": "user",
    "payload": {
      "type": "text",
      "text": "Non, c'est pas bon...\n\nj'ai la finance de l'ombre, le doxxing rh et le Sabotage PvP qui me plaisent mais sans plus\n\nil me faut une dynamique plus riche\n\nNE CHANGES PAS LE CODE, ON EST EN IDEATION PURE POUR L'INSTANT",
      "files": [],
      "fileUploads": [],
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1768531499,
      "nanos": 896000000
    }
  },
  {
    "id": 134,
    "author": "model",
    "payload": {
      "type": "thinking",
      "text": "**Conceptualizing the Market**\n\nI'm currently focused on the core concept: a \"Black Market\" within an educational ERP game. I'm analyzing the requested features and how they fit into the game's context. The initial goal is clearly defined. Now, I'm working to outline the specific requirements to deliver a functional, engaging experience.\n\n\n**Exploring Transgression**\n\nI'm now thinking about how to make these concepts deeper and more engaging. I'm focusing on incorporating psychological elements, paranoia, and exploiting the school system mechanics, all without changing any code. I'm looking at what matters to students in the game, like grades, money, and workload, and brainstorming ways to gamify the \"dark side\" of these elements.\n\n\n**Refining the Concepts**\n\nI'm now diving into the specifics of the black market activities. The \"Pedagogical Leak\" involves insider grading information; \"The Whistleblower\" allows for triggering investigations against rivals. I'm also developing the \"Money Laundering\" and \"The Scapegoat\" concepts, adding depth to the \"Mafia\" category. These ideas bring some high-stakes situations for players!\n\n\n**Formulating \"Dark\" Strategies**\n\nI'm now thinking about strategies, like betting on or \"shorting\" student outcomes, aiming for increased player engagement. These will make the game feel riskier! I've been working on specific dark moves, like a \"Glitch\" item that simulates technical errors and a \"Mirror of Truth\" to exploit peer review paranoia. I'm also planning financial elements.\n\n\n**Developing Dark Opportunities**\n\nI'm now outlining some concrete \"dark\" opportunities. The first is a loan shark mechanic with rule-bending interest rates and automatic point seizures. Next, I'm working on assets that guarantee a minimum grade with a plagiarism risk, and the ability to sabotage an opposing agency for profit. These will bring player choices to the forefront.\n\n\n**Designing Consequences**\n\nI'm now integrating a \"Watchlist\" feature, triggered by excessive use of dark actions, introducing an element of risk and paranoia within the game. I'm also revising the proposal, shifting the focus towards a \"Real World Corruption Simulation\" philosophy and incorporating the pillars of subversion, paranoia, and greed to drive gameplay. I'm working to connect dark actions to actual game deliverables and peer reviews to align with feedback and deepen the mechanics, while ensuring appropriate cooldowns and costs.\n\n\n**Defining Rich Dynamics**\n\nI'm now focusing on making interactions between players rich and dramatic. I'm building \"Shadow Banking\" and \"Social Engineering\" features to enable some high-stakes competition. The \"Traitor\" mechanic is the most compelling aspect here, creating new conflicts within the game and keeping it fresh. I'm working to expand on these features.\n\n\n",
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1768531499,
      "nanos": 896000000
    },
    "doneTimestamp": {
      "seconds": 1768531525,
      "nanos": 297000000
    }
  },
  {
    "id": 135,
    "author": "model",
    "payload": {
      "type": "text",
      "text": "C'est le moment de passer au niveau supérieur. Tu as raison, les propositions précédentes étaient trop \"jeu vidéo classique\".\n\nPour que le **Marché Noir (Le 22-04)** soit mémorable, il doit simuler les aspects les plus sombres du monde de l'entreprise : **le délit d'initié, la prédation financière et la trahison interne.**\n\nVoici une proposition beaucoup plus \"systémique\" et vicieuse, basée sur l'interaction sociale et la manipulation des règles.\n\n---\n\n### Le Concept : \"Le 22-04\" est une Zone de Non-Droit\n\nL'accès reste le même (glitch visuel entre 22h et 04h).\nMais ce qu'on y trouve change radicalement. On ne vend plus des \"objets\", on vend des **Contrats** et des **Protocoles**.\n\n### 1. La Dynamique \"Taupe & Trahison\" (Le Judas Protocol)\n*Cible : La cohésion des équipes.*\n\nC'est la mécanique la plus riche pour créer de la paranoïa.\n\n*   **Le Contrat \"Agent Double\" (Gratuit à l'activation - Gain en PiXi)**\n    *   *Mécanique :* Un étudiant s'inscrit sur une liste secrète : \"Je suis prêt à trahir mon agence\".\n    *   *Le Marché :* Une agence rivale (riche) peut consulter cette liste anonyme (ex: \"Membre de l'Agence Alpha disponible\").\n    *   *L'Action :* L'agence rivale paie le traître (virement crypto indétectable) pour qu'il effectue une action précise :\n        1.  **Sabotage de Vote :** Voter \"NON\" à un recrutement vital.\n        2.  **Grève du Zèle :** Ne rien rendre cette semaine (faire baisser le Team Multiplier).\n    *   *Risque :* Si la VE de l'agence du traître chute trop, il coule avec. C'est un jeu d'équilibre dangereux.\n\n### 2. La Finance Prédatrice (Le Shadow Banking)\n*Cible : Les agences en difficulté (Dette).*\n\nAu lieu de simples virements, on introduit des produits financiers toxiques.\n\n*   **Le \"Vautour Loan\" (Prêt Usuraire)**\n    *   *Contexte :* Une agence est à -2000 PiXi. Elle risque la faillite (-5000) et la dissolution.\n    *   *L'Offre :* Un étudiant riche (ou une agence riche) propose via le 22-04 de payer la dette (2000 PiXi).\n    *   *La Contrepartie (Automatique via Smart Contract) :*\n        *   L'agence sauvée doit rembourser 3000 PiXi sous 3 semaines.\n        *   SI elle ne paie pas : **Saisie Automatique de VE**. Chaque point de VE gagné par l'agence est instantanément transféré au prêteur jusqu'à remboursement. L'agence travaille littéralement pour le prêteur (Esclavage de VE).\n\n*   **L'Assurance \"Anti-Crash\" (Racket)**\n    *   *Mécanique :* Un étudiant achète une \"Assurance\" contre les bugs de rendu.\n    *   *Le Twist :* L'argent de l'assurance va dans une \"Cagnotte Noire\" gérée par l'IA du jeu. Si personne n'a de crash, la cagnotte grossit.\n    *   *Le \"Rug Pull\" :* Une fois par mois, un étudiant peut tenter de **hacker la cagnotte** (coût en Karma extrême) pour voler tout l'argent accumulé par les peureux.\n\n### 3. La Manipulation de la Notation (Social Engineering)\n*Cible : L'algorithme de notation.*\n\nOn ne touche pas à la note du prof, on touche à la perception de l'algorithme.\n\n*   **Le \"MVP Spoofing\" (Usurpation de gloire)**\n    *   *Coût :* 1000 PiXi + 40 Karma.\n    *   *Effet :* Lors de la soumission d'un fichier, l'étudiant force son nom comme \"Auteur Principal\" dans les métadonnées internes du fichier (même si c'est faux).\n    *   *Résultat :* Si le rendu a \"A\", l'algorithme propose automatiquement cet étudiant comme MVP à l'enseignant. L'enseignant, voyant la suggestion système, a tendance à valider sans vérifier.\n\n*   **Le \"Bouclier RH\" (Immunité)**\n    *   *Coût :* 600 PiXi.\n    *   *Effet :* Bloque l'impact des Peer Reviews négatives pour la semaine.\n    *   *Subtilité :* Les collègues *pensent* que leur mauvaise note a été prise en compte. Mais le lundi matin, le score de la cible ne baisse pas.\n    *   *Conséquence :* Ça crée des tensions (\"Mais je t'ai mis 1/5, pourquoi tu as encore 100 de score ?? Bug ??\").\n\n### 4. L'Information Asymétrique (Délit d'initié)\n*Cible : La connaissance du jeu.*\n\n*   **Le \"Profiler IA\" (Deep Scan)**\n    *   *Coût :* 200 PiXi.\n    *   *Action :* Scanner un étudiant d'une autre agence.\n    *   *Résultat :* Révèle son **Karma exact** et son **Solde Bancaire**.\n    *   *Usage :* Savoir qui est \"riche et gentil\" pour lui demander de l'aide, ou qui est \"pauvre et toxique\" pour essayer de le débaucher (il sera désespéré).\n\n---\n\n### UX/UI : L'Ambiance \"Dark Web\"\n\nPour que ça marche, il faut une UX radicale :\n\n1.  **L'Anonymat Visuel :** Dans le 22-04, les noms sont remplacés par des pseudonymes générés (ex: *User-404*, *Ghost-Protocol*).\n2.  **Le Timer de Stress :** Les offres changent toutes les 30 minutes. \"Ce prêt expire dans 14:00\".\n3.  **La Trace :** Chaque action laisse une \"Trace Numérique\".\n    *   Sur le dashboard Admin, il y a un compteur global : \"Activité Suspecte Détectée : Élevée\".\n    *   L'enseignant sait que *quelque chose* se passe, mais ne sait pas *qui*. Il peut alors décider de lancer un \"Audit Général\" (Crise) pour punir tout le monde, créant une pression sociale sur les tricheurs.\n\n### Résumé de la nouvelle dynamique\n\nCe n'est plus : *\"J'achète un bonus pour avoir +2 points\".*\nC'est : *\"Je paie pour corrompre un membre de l'équipe adverse afin qu'il sabote leur rendu, ce qui permettra à mon agence de passer devant au classement VE.\"*\n\nEst-ce que cette direction \"House of Cards\" te convient mieux ? On peut commencer à spécifier le code pour le **Shadow Banking** (Prêts) et le **Judas Protocol** (Traîtres).",
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1768531525,
      "nanos": 297000000
    },
    "doneTimestamp": {
      "seconds": 1768531525,
      "nanos": 387000000
    }
  },
  {
    "id": 136,
    "author": "user",
    "payload": {
      "type": "text",
      "text": "Bon...on y est pas encore\n\nmais bon\n\npour l'instant implante le comme ceci :\n\nUX/UI : L'Ambiance \"Dark Web\"\nPour que ça marche, il faut une UX radicale :\nL'Anonymat Visuel : Dans le 22-04, les noms sont remplacés par des pseudonymes générés (ex: User-404, Ghost-Protocol).\nLe Timer de Stress : Les lots disponibles changent toutes les 72 heures.\nLa Trace : Chaque action laisse une \"Trace Numérique\".\nSur le dashboard Admin, il y a un compteur global : \"Activité Suspecte Détectée : Élevée\".\nL'enseignant sait que quelque chose se passe, mais ne sait pas qui. Il peut alors décider de lancer un \"Audit Général\" (Crise) pour punir tout le monde, créant une pression sociale sur les tricheurs.\n\nOffres validées pour \" THE BACKDOOR \"\n\nLe \"Short Selling\" (Vente à Découvert)\nLe concept : Parier sur l'échec.\nL'action : Tu mises 500 PiXi que l'Agence X va perdre de la VE cette semaine (mauvais rendu, crise).\nL'effet : Si l'Agence X se plante (ou si tu les as sabotés...), tu gagnes 1000 PiXi.\nLa perversité : Ça incite les étudiants à saboter les oraux des autres pour s'enrichir.\n\nLe \"Doxxing RH\" (600 PiXi)\nLe concept : L'anonymat des Peer Reviews est sacré... sauf ici.\nL'effet : Révèle qui t'a mis une sale note cette semaine. \"C'est Julien qui t'a mis 1/5 en implication.\"\nLe But : Créer du conflit interne, régler des comptes, ou purger l'agence.\n\nCorruption (Avantages Personnels)\nLe Faux Certificat (500 PiXi) :\nEffet : Annule rétroactivement une pénalité de retard individuelle (supprime un retard noté dans le système).\nRisque : 20% de chance que l'Admin s'en rende compte (Notification : \"Tentative de fraude détectée\"). Si pris : -20 Karma et -10 Score.\nL'Achat de Vote (200 PiXi) :\nEffet : Ajoute un vote \"FANTÔME\" positif lors d'une procédure de recrutement ou de licenciement. Permet de faire pencher la balance démocratique.\n\nL'Audit Hostile (Déjà existant, mais déplacé ici) :\nAttaque la crédibilité d'une agence adverse.",
      "files": [],
      "fileUploads": [],
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1768532248,
      "nanos": 407000000
    }
  },
  {
    "id": 137,
    "author": "model",
    "payload": {
      "type": "thinking",
      "text": "**Beginning Implementation Analysis**\n\nI'm currently dissecting the core request, which is the \"Black Market\" feature. I'm focusing on the intended goal and overall app context, which involves a gamified classroom management environment. I'm also establishing all the relevant features of the Black Market, as requested by the user. I'm taking notes on how best to provide a smooth, integrated implementation.\n\n\n**Defining Black Market Functionality**\n\nI've been drilling down on the specific features needed for this \"Black Market\". I'm defining the UX/UI (dark web terminal feel, timed offers), including the availability window and the items to be sold. I am documenting items such as Short Selling, Doxxing RH, Faux Certificat, Achat de Vote, and Audit Hostile, and the PiXi costs. I'm also ensuring the admin dashboard tracks a global \"Suspicious Activity\" counter, as requested. I'm taking notes on associated 'karma' implications.\n\n\n**Implementing Suspicion Tracking**\n\nI'm now incorporating \"Suspicious Activity\" tracking. I'm focusing on the data model changes, adding the `BlackMarketItem` type and the `suspicionMeter`. I will be using `GameEvent` logs to derive the suspicious activity, potentially tracking the `suspicionLevel` in the global game state. I'm also considering how to track active bets related to Short Selling, leaning towards adding `activeBets` to the `Student` structure.\n\n\n**Adding Active Bet Tracking**\n\nI'm expanding my tracking efforts. The \"Suspicious Activity\" tracking is progressing, and I'm currently focused on incorporating active bets, which I'll add to the `Student` interface. I'm also now building the game context by implementing specific trades and anonymous name generation, considering time checks for availability. I'm moving on to component design, starting with `TheBackdoor.tsx` and adding a Matrix-style UI, followed by updating related admin widgets and student views.\n\n\n**Refining Transactional Logic**\n\nI'm now refining the transaction handling within `useGameMechanics`. I'm starting by implementing the Short Selling purchase, noting the payout logic will go into `processPerformance`. I'm going to centralize bet tracking and place it on the Agency doc. I've designed the entry point for students, which is planned for the `StudentAgencyView`.\n\n\n**Expanding Black Market Items**\n\nI'm working on the data structures and implementing the mechanics for specific Black Market items. I'm focusing on the implementation details for \"Doxxing RH\", \"Faux Certificat\", and \"Achat de Vote\". I've planned the time checks, and decided to incorporate subtle UI elements like a footer \"Glitch Button\". I've also drafted anonymous name generation. I'm currently working on the specific code outputs and where the logic will reside.\n\n\n**Adding Integration Components**\n\nI'm now integrating the Black Market functionality into the existing UI. I've created the `TheBackdoor.tsx` component with a Matrix-style UI and imported it into the `StudentAgencyView.tsx`. This includes the logic for the time check and glitch button. The admin dashboard is getting an update, which now includes the \"Suspicious Activity\" counter within `DashboardWidgets.tsx`. I'm refining visual anonymity with name replacements, stress timers with expiration notifications, and adding `suspicionLevel` tracking to either the Agency or global state for traceability. I'm making a correction to Short Selling by logging the bet, and will adjust payout logic later.\n\n\n**Implementing UI Adjustments**\n\nI'm now implementing aesthetic UI adjustments and function corrections. I'm adding a `Bet` type to `types.ts`, and `performBlackOp` to `useGameMechanics.ts`. I'm working on the UI in `TheBackdoor.tsx` and its integration into `StudentAgencyView.tsx`, with admin monitoring in `DashboardWidgets.tsx`. I'm also implementing the Matrix aesthetic with Tailwind, setting up invisible button rendering, and considering item rotation using time-based seeds or hardcoding. I will also incorporate 'Le Faux Certificat' to cancel penalties, and I'll push votes to `mercatoRequests`.\n\n\n**Producing Item Display**\n\nI'm now focusing on displaying the validated Black Market items. I'm preparing for the XML output, and I'll use it to display in the UI. I will begin by ensuring I can display the items at the \"The Backdoor\" component. I'm focusing on the component's data flow, ensuring that the selected items are available, and correctly rendered.\n\n\n",
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1768532248,
      "nanos": 407000000
    },
    "doneTimestamp": {
      "seconds": 1768532280,
      "nanos": 31000000
    }
  },
  {
    "id": 138,
    "author": "model",
    "payload": {
      "type": "text",
      "text": "C'est parti. On rentre dans le dur.\n\nVoici l'implémentation du **Backdoor (Le 22-04)**.\n\n### Spécifications Techniques & Design\n\n1.  **Mécanique Temporelle (Le Glitch)**\n    *   Un hook vérifie l'heure locale du client.\n    *   Si `Heure >= 22` OU `Heure < 4` : Un composant \"Glitch\" invisible (pixel mort ou icône buggée) s'injecte dans le DOM du `StudentAgencyView`.\n    *   Sinon : Le composant est `null`. Il n'existe pas.\n\n2.  **Interface \"Matrix\" (The Backdoor)**\n    *   Une fois entré, tout bascule : Fond `#000000`, Texte `#00ff41` (Terminal Green), Font `Monospace`.\n    *   Les noms des utilisateurs (soi-même et les cibles) sont obfusqués : *User-X92*, *Ghost-Proxy*.\n    *   Pas de confirmation \"Êtes-vous sûr ?\". Un clic = Achat immédiat.\n\n3.  **Logique des Items (Black Ops)**\n    *   **Short Selling** : Enregistre un pari (Bet) dans la structure de l'étudiant.\n    *   **Doxxing RH** : Va chercher dans l'historique des `peerReviews`, trouve les notes < 3/5 et affiche le nom du coupable directement dans l'UI du marché noir.\n    *   **Faux Certificat** : Cherche un livrable avec `grading.daysLate > 0` et le remet à 0.\n    *   **Achat de Vote** : Injecte un vote 'APPROVE' artificiel dans une `MercatoRequest` ciblée.\n    *   **Audit Hostile** : (Déplacé ici) Lance une attaque sur la VE adverse.\n\n4.  **Côté Admin (La Trace)**\n    *   Ajout d'un compteur \"Activités Suspectes\" dans les widgets. Il compte les événements de type `BLACK_OP` sur les dernières 24h.\n\nVoici le code :\n\n",
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1768532280,
      "nanos": 31000000
    },
    "doneTimestamp": {
      "seconds": 1768532280,
      "nanos": 32000000
    }
  },
  {
    "id": 139,
    "author": "model",
    "payload": {
      "type": "generationTable",
      "entries": [
        {
          "path": "types.ts",
          "generationType": 1,
          "isDone": true,
          "description": "Ajout des types pour les paris (Short Selling) et mise à jour des structures pour le Black Market.",
          "diffs": [
            {
              "target": "",
              "replacement": "\nexport enum CycleType {\n  MARQUE_BRIEF = \"Cycle 1: Marque & Brief\",\n  NARRATION_IA = \"Cycle 2: Narration & IA\",\n  LOOKDEV = \"Cycle 3: Look-dev & Sélection\",\n  PACKAGING = \"Cycle 4: Packaging & Soutenance\"\n}\n\nexport interface PeerReview {\n  id: string;\n  date: string;\n  weekId: string;\n  reviewerId: string;\n  reviewerName: string;\n  targetId: string;\n  targetName: string;\n  ratings: {\n    attendance: number; // 1-5\n    quality: number; // 1-5\n    involvement: number; // 1-5\n  };\n  comment: string;\n}\n\n// NOUVEAU : Types de livrables pour le Mission Builder\nexport type DeliverableType = 'FILE' | 'LINK' | 'FORM_CHARTER' | 'FORM_NAMING' | 'SPECIAL_LOGO' | 'SPECIAL_BANNER';\n\nexport interface Deliverable {\n  id: string;\n  name: string;\n  description: string;\n  type?: DeliverableType; // NOUVEAU CHAMP (Optionnel pour rétrocompatibilité, défaut = FILE)\n  status: 'pending' | 'submitted' | 'validated' | 'rejected';\n  score?: number; // 0-100\n  feedback?: string;\n  fileUrl?: string;\n  deadline?: string; // NOUVEAU: Date limite de rendu\n  // Grading Details\n  submissionDate?: string;\n  grading?: {\n    quality: 'A' | 'B' | 'C' | 'REJECTED';\n    daysLate: number;\n    constraintBroken: boolean;\n    finalDelta: number;\n    mvpId?: string; // NEW: The student who carried the task\n  }\n}\n\nexport interface ClassSession {\n    date: string; // YYYY-MM-DD\n    slot: 'MATIN' | 'APRÈS-MIDI' | 'JOURNÉE';\n}\n\nexport interface WeekModule {\n  id: string;\n  title: string;\n  type: 'FUN/CHILL' | 'THÉORIE' | 'TECHNIQUE' | 'JURY';\n  objectives: string[];\n  deliverables: Deliverable[];\n  locked: boolean;\n  status?: 'pending' | 'in_progress' | 'validated';\n  schedule: {\n      classA: ClassSession | null;\n      classB: ClassSession | null;\n  };\n}\n\n// --- NEW: STUDENT HISTORY ---\nexport interface StudentHistoryEntry {\n    date: string;\n    agencyId: string;\n    agencyName: string;\n    action: 'JOINED' | 'LEFT' | 'FIRED' | 'RESIGNED' | 'MERGED';\n    contextVE: number;      // VE de l'agence au moment du départ/arrivée\n    contextBudget: number;  // Tréso de l'agence au moment du départ/arrivée\n    reason?: string;        // Motif (ex: \"Licenciement économique\", \"Démission\")\n}\n\nexport interface Badge {\n    id: string;\n    label: string;\n    description: string;\n    icon: string; // Identifier for Lucide icon or image path\n    unlockedAt?: string;\n}\n\n// --- NEW: BETTING SYSTEM (SHORT SELLING) ---\nexport interface Bet {\n    id: string;\n    targetAgencyId: string;\n    targetAgencyName: string;\n    amountWagered: number; // Mise (ex: 500)\n    weekId: string; // Semaine du pari\n    status: 'ACTIVE' | 'WON' | 'LOST';\n    date: string;\n}\n\nexport interface Student {\n  id: string;\n  name: string;\n  email?: string; // AJOUT : Email pour les notifications\n  role: string; // Standardisé (ex: \"Associé\")\n  avatarUrl: string;\n  individualScore: number; // 0-100\n  wallet: number; // NEW: Personal Funds in PiXi\n  karma?: number; // NEW: Hidden score based on behavior (+ = Altruiste, - = Toxique)\n  cvUrl?: string; // URL vers le PDF du CV\n  classId: 'A' | 'B'; // Gestion des deux promotions\n  connectionStatus?: 'online' | 'offline' | 'pending';\n  history?: StudentHistoryEntry[]; // Parcours professionnel\n  badges?: Badge[]; // NEW: Individual Badges\n  streak?: number; // NEW: Streak for performance\n  activeBets?: Bet[]; // NEW: Paris en cours\n}\n\nexport type EventType = 'CRISIS' | 'VE_DELTA' | 'BUDGET_DELTA' | 'CHECKPOINT' | 'INFO' | 'PAYROLL' | 'REVENUE' | 'BLACK_OP' | 'MERGER';\n\nexport interface GameEvent {\n  id: string;\n  date: string; // ISO String\n  type: EventType;\n  label: string; // Titre court (ex: \"Pénurie matériaux\")\n  description?: string;\n  deltaVE?: number; // Impact sur la VE (ex: -15)\n  deltaBudgetReal?: number;\n  deltaBudgetValued?: number;\n}\n\nexport interface ProjectDefinition {\n  problem: string;      // Problème réel et local\n  target: string;       // Qui souffre (Persona)\n  location: string;     // Où ça se passe\n  gesture: string;      // Geste architectural unique\n  theme?: string;       // NOUVEAU: Thématique globale\n  direction?: string;   // NOUVEAU: Direction Artistique / Intention\n  context?: string;     // NOUVEAU: Contexte sociétal ou urbain\n  isLocked: boolean;    // Validé par le prof ?\n}\n\nexport interface MercatoRequest {\n  id: string;\n  type: 'HIRE' | 'FIRE' | 'FOUND_AGENCY'; \n  studentId: string; // La cible du mouvement\n  studentName: string;\n  requesterId?: string; // Qui a fait la demande\n  targetAgencyId: string; // L'agence concernée (ou 'new' pour foundation)\n  status: 'PENDING' | 'REJECTED';\n  date: string;\n  motivation?: string; // Texte justificatif\n  votes?: { [studentId: string]: 'APPROVE' | 'REJECT' }; \n}\n\n// --- NEW: CHALLENGE REQUEST (AI GENERATED) ---\nexport interface ChallengeRequest {\n    id: string;\n    title: string;\n    description: string;\n    status: 'PENDING_VOTE' | 'ACCEPTED' | 'REJECTED';\n    date: string;\n    rewardVE: number; // Bonus si réussi\n    votes: { [studentId: string]: 'APPROVE' | 'REJECT' };\n}\n\n// --- NEW: MERGER REQUEST ---\nexport interface MergerRequest {\n    id: string;\n    requesterAgencyId: string;\n    requesterAgencyName: string;\n    targetAgencyId: string; // L'agence qui va se faire absorber\n    status: 'PENDING' | 'REJECTED';\n    date: string;\n    offerDetails: string; // Description de l'offre (ex: \"Rachat de dette\")\n}\n\n// --- NEW: FINANCIAL REQUESTS ---\nexport interface TransactionRequest {\n    id: string;\n    studentId: string;\n    studentName: string;\n    type: 'BUY_SCORE';\n    amountPixi: number;\n    amountScore: number;\n    status: 'PENDING' | 'REJECTED';\n    date: string;\n}\n\n// --- NEW: AI ANALYSIS TYPES ---\nexport interface AIInsight {\n    id: string;\n    type: 'URGENT' | 'WARNING' | 'OPPORTUNITY';\n    title: string;\n    analysis: string; // L'explication du \"Pourquoi\"\n    suggestedAction: {\n        label: string;\n        actionType: 'CRISIS' | 'REWARD' | 'MESSAGE' | 'AUDIT';\n        payload?: any; // Données pour pré-remplir l'action\n    };\n    targetAgencyId?: string;\n    targetStudentId?: string;\n}\n\n// --- NEW TYPES FOR GAMIFICATION ---\n\nexport type BrandColor = 'indigo' | 'emerald' | 'rose' | 'amber' | 'cyan' | 'slate';\n\nexport interface AgencyBranding {\n    color: BrandColor;\n    bannerUrl?: string;\n}\n\nexport interface Agency {\n  id: string;\n  name: string;\n  tagline: string;\n  logoUrl?: string;\n  members: Student[];\n  peerReviews: PeerReview[];\n  classId: 'A' | 'B' | 'ALL'; // ALL pour l'agence Chômage\n  \n  // Data Driven by Events\n  ve_current: number; // 0-100 (La note/valeur)\n  veCapOverride?: number; // NEW: Manual override for the VE Ceiling\n  budget_real: number; // En PiXi\n  budget_valued: number; // En PiXi\n  weeklyTax: number; // Pourcentage de charges hebdo (0.1 = 10%)\n  weeklyRevenueModifier: number; // Bonus/Malus récurrent en PiXi (ex: +500 par semaine grâce à un prix)\n  \n  status: 'stable' | 'fragile' | 'critique';\n  \n  eventLog: GameEvent[]; // Source of Truth\n  \n  currentCycle: CycleType;\n  \n  // New Project Structure\n  projectDef: ProjectDefinition;\n  \n  // Mercato Requests (Pending)\n  mercatoRequests: MercatoRequest[];\n  \n  // Financial Requests (Pending)\n  transactionRequests: TransactionRequest[];\n\n  // Merger Requests (Pending)\n  mergerRequests?: MergerRequest[];\n\n  // Active Challenges (AI)\n  challenges?: ChallengeRequest[];\n\n  // Legacy constraints\n  constraints: {\n    space: string;\n    style: string;\n    client: string;\n  };\n  \n  progress: {\n    [weekId: string]: WeekModule;\n  };\n\n  // --- NEW FIELDS ---\n  branding: AgencyBranding;\n  badges: Badge[];\n}\n\nexport interface AppState {\n  userRole: 'admin' | 'student';\n  selectedAgencyId: string | null;\n  agencies: Agency[];\n}\n\nexport interface CrisisPreset {\n  label: string;\n  description: string;\n  deltaVE: number;\n  deltaBudget: number;\n  icon: any;\n}\n\n// --- NEW: AWARDS ---\nexport interface CycleAwardDefinition {\n    id: string;\n    cycleId: CycleType;\n    title: string;\n    description: string;\n    veBonus: number;\n    weeklyBonus: number; // En PiXi/semaine (Récurrent)\n    iconName: 'compass' | 'mic' | 'eye' | 'crown';\n}\n\n// --- WIKI / RESOURCES ---\nexport interface WikiResource {\n    id: string;\n    title: string;\n    description?: string;\n    type: 'PDF' | 'VIDEO' | 'LINK' | 'ASSET';\n    url: string;\n    targetClass: 'ALL' | 'A' | 'B';\n    date: string;\n}\n"
            }
          ]
        },
        {
          "path": "contexts/game/useGameMechanics.ts",
          "generationType": 1,
          "isDone": true,
          "description": "Ajout de la logique 'performBlackOp' pour gérer les achats du marché noir (Short Selling, Doxxing, Fake Cert, etc).",
          "diffs": [
            {
              "target": "",
              "replacement": "\nimport { writeBatch, doc, updateDoc } from '../../services/firebase';\nimport { db } from '../../services/firebase';\nimport { Agency, GameEvent, MergerRequest, ChallengeRequest, Deliverable, Student, Bet, MercatoRequest } from '../../types';\nimport { calculateVECap, GAME_RULES, CONSTRAINTS_POOL } from '../../constants';\n\nexport const useGameMechanics = (agencies: Agency[], toast: (type: string, msg: string) => void, getCurrentGameWeek: () => number) => {\n\n  const updateAgency = async (updatedAgency: Agency) => {\n    try {\n        const veCap = calculateVECap(updatedAgency);\n        const finalVE = Math.min(updatedAgency.ve_current, veCap);\n        const agencyRef = doc(db, \"agencies\", updatedAgency.id);\n        await updateDoc(agencyRef, { ...updatedAgency, ve_current: finalVE });\n    } catch (e) {\n        console.error(e);\n        toast('error', 'Erreur sauvegarde');\n    }\n  };\n\n  const processPerformance = async (targetClass: 'A' | 'B') => {\n      const today = new Date().toISOString().split('T')[0];\n      try {\n        const batch = writeBatch(db);\n        let processedCount = 0;\n\n        agencies.forEach(agency => {\n            if (agency.id === 'unassigned' || agency.classId !== targetClass) return;\n            processedCount++;\n            \n            let logEvents: GameEvent[] = [];\n            const updatedMembers = (agency.members || []).map(member => {\n                const reviews = agency.peerReviews.filter(r => r.targetId === member.id);\n                if (reviews.length === 0) return member;\n                const avg = reviews.reduce((sum, r) => sum + ((r.ratings.attendance + r.ratings.quality + r.ratings.involvement)/3), 0) / reviews.length;\n                let scoreDelta = 0;\n                let newStreak = member.streak || 0;\n                if (avg > 4.5) { scoreDelta = 2; newStreak++; if (newStreak >= 3) { scoreDelta += 10; newStreak = 0; } } \n                else if (avg >= 4.0) { scoreDelta = 1; newStreak = 0; } \n                else if (avg < 2.0) { scoreDelta = -5; newStreak = 0; } \n                else { newStreak = 0; }\n                return { ...member, individualScore: Math.max(0, Math.min(100, member.individualScore + scoreDelta)), streak: newStreak };\n            });\n\n            let veAdjustment = 0;\n            const budget = agency.budget_real;\n            if (budget >= 2000) veAdjustment += Math.floor(budget / 2000);\n            else if (budget < 0) veAdjustment -= Math.ceil(Math.abs(budget) / 1000) * 2;\n\n            if (veAdjustment !== 0) {\n                logEvents.push({ id: `perf-ve-${Date.now()}-${agency.id}`, date: today, type: veAdjustment > 0 ? 'VE_DELTA' : 'CRISIS', label: 'Ajustement VE', deltaVE: veAdjustment, description: veAdjustment > 0 ? 'Trésorerie saine.' : 'Dette.' });\n            }\n\n            const veCap = calculateVECap(agency);\n            const finalVE = Math.min(Math.max(0, agency.ve_current + veAdjustment), veCap);\n\n            const ref = doc(db, \"agencies\", agency.id);\n            batch.update(ref, {\n                members: updatedMembers,\n                ve_current: finalVE,\n                peerReviews: [], \n                eventLog: [...agency.eventLog, ...logEvents],\n                status: finalVE >= 60 ? 'stable' : finalVE >= 40 ? 'fragile' : 'critique'\n            });\n        });\n\n        if (processedCount > 0) {\n            await batch.commit();\n            toast('success', `Performance Classe ${targetClass}: Terminée.`);\n        }\n      } catch(e) { console.error(e); toast('error', \"Erreur Performance\"); }\n  };\n\n  const shuffleConstraints = async (agencyId: string) => {\n    const agency = agencies.find(a => a.id === agencyId);\n    if (!agency) return;\n    const randomSpace = CONSTRAINTS_POOL.space[Math.floor(Math.random() * CONSTRAINTS_POOL.space.length)];\n    const randomStyle = CONSTRAINTS_POOL.style[Math.floor(Math.random() * CONSTRAINTS_POOL.style.length)];\n    const randomClient = CONSTRAINTS_POOL.client[Math.floor(Math.random() * CONSTRAINTS_POOL.client.length)];\n    await updateAgency({\n      ...agency,\n      constraints: { space: randomSpace, style: randomStyle, client: randomClient }\n    });\n    toast('info', 'Contraintes régénérées');\n  };\n\n  const performBlackOp = async (\n      studentId: string, \n      agencyId: string, \n      opType: 'SHORT_SELL' | 'DOXXING' | 'FAKE_CERT' | 'BUY_VOTE' | 'AUDIT_HOSTILE', \n      payload: any\n  ) => {\n      const studentAgency = agencies.find(a => a.id === agencyId);\n      if (!studentAgency) return;\n      const student = studentAgency.members.find(m => m.id === studentId);\n      if (!student) return;\n\n      const batch = writeBatch(db);\n      const agencyRef = doc(db, \"agencies\", agencyId);\n      const today = new Date().toISOString().split('T')[0];\n\n      // COÛTS & KARMA\n      let costPixi = 0;\n      let costKarma = 0;\n\n      switch(opType) {\n          case 'SHORT_SELL': costPixi = 500; costKarma = 5; break;\n          case 'DOXXING': costPixi = 600; costKarma = 10; break;\n          case 'FAKE_CERT': costPixi = 500; costKarma = 20; break; // Risqué\n          case 'BUY_VOTE': costPixi = 200; costKarma = 15; break;\n          case 'AUDIT_HOSTILE': costPixi = 500; costKarma = 10; break;\n      }\n\n      if ((student.wallet || 0) < costPixi) {\n          toast('error', \"Fonds insuffisants.\");\n          return;\n      }\n\n      // 1. DEDUCT COST FROM STUDENT\n      const updatedMembers = studentAgency.members.map(m => \n          m.id === studentId ? { ...m, wallet: (m.wallet || 0) - costPixi, karma: (m.karma || 50) - costKarma } : m\n      );\n      \n      // LOGIC PER OP TYPE\n      if (opType === 'SHORT_SELL') {\n          // Add Bet to Student\n          const targetAgency = agencies.find(a => a.id === payload.targetId);\n          if (!targetAgency) return;\n          \n          const newBet: Bet = {\n              id: `bet-${Date.now()}`,\n              targetAgencyId: payload.targetId,\n              targetAgencyName: targetAgency.name,\n              amountWagered: 500,\n              weekId: getCurrentGameWeek().toString(),\n              status: 'ACTIVE',\n              date: today\n          };\n\n          const memberIndex = updatedMembers.findIndex(m => m.id === studentId);\n          if (memberIndex > -1) {\n              updatedMembers[memberIndex].activeBets = [...(updatedMembers[memberIndex].activeBets || []), newBet];\n          }\n          \n          batch.update(agencyRef, { members: updatedMembers });\n          toast('success', \"Ordre de Vente à Découvert placé.\");\n\n      } else if (opType === 'DOXXING') {\n          // Just deduct money, UI handles the reveal\n          batch.update(agencyRef, { members: updatedMembers });\n          // No visual toast needed, the UI will show the data immediately\n      } else if (opType === 'FAKE_CERT') {\n          // Find week and deliverable\n          const weekId = payload.weekId;\n          const deliverableId = payload.deliverableId;\n          const week = studentAgency.progress[weekId];\n          \n          if (week) {\n              const updatedDeliverables = week.deliverables.map(d => {\n                  if (d.id === deliverableId && d.grading) {\n                      return { ...d, grading: { ...d.grading, daysLate: 0 } }; // ERASE DELAY\n                  }\n                  return d;\n              });\n              const updatedWeek = { ...week, deliverables: updatedDeliverables };\n              batch.update(agencyRef, { \n                  members: updatedMembers, \n                  [`progress.${weekId}`]: updatedWeek \n              });\n              toast('success', \"Certificat falsifié. Retard annulé.\");\n          }\n\n      } else if (opType === 'BUY_VOTE') {\n          const reqId = payload.requestId;\n          const targetAgency = agencies.find(a => a.mercatoRequests.some(r => r.id === reqId));\n          if (targetAgency) {\n              const req = targetAgency.mercatoRequests.find(r => r.id === reqId);\n              if (req) {\n                  const ghostId = `ghost-${Date.now()}`;\n                  const newVotes = { ...req.votes, [ghostId]: 'APPROVE' as const };\n                  const updatedReqs = targetAgency.mercatoRequests.map(r => r.id === reqId ? { ...r, votes: newVotes } : r);\n                  \n                  batch.update(doc(db, \"agencies\", targetAgency.id), { mercatoRequests: updatedReqs });\n                  \n                  // If paying student is in same agency, update members there. If different, update source agency.\n                  if (targetAgency.id === agencyId) {\n                      batch.update(agencyRef, { members: updatedMembers, mercatoRequests: updatedReqs });\n                  } else {\n                      batch.update(agencyRef, { members: updatedMembers });\n                  }\n                  toast('success', \"Vote fantôme injecté.\");\n              }\n          }\n\n      } else if (opType === 'AUDIT_HOSTILE') {\n          await triggerBlackOp(agencyId, payload.targetId, 'AUDIT');\n          // Update wallet separately because triggerBlackOp usually uses Agency Budget, here we use Personal Wallet\n          // But wait, triggerBlackOp is agency vs agency. Here prompt says \"Move it here\".\n          // Let's assume student pays for it personally in the Backdoor version.\n          const targetAgency = agencies.find(a => a.id === payload.targetId);\n          if (targetAgency) {\n               const isVulnerable = targetAgency.budget_real < 0 || targetAgency.ve_current < 40;\n               if (isVulnerable) {\n                   batch.update(doc(db, \"agencies\", targetAgency.id), {\n                       ve_current: Math.max(0, targetAgency.ve_current - 10),\n                       eventLog: [...targetAgency.eventLog, {\n                           id: `op-hit-${Date.now()}`, date: today, type: 'CRISIS', label: \"Audit Externe (Sanction)\", deltaVE: -10, description: \"Des irrégularités ont été exposées.\"\n                       }]\n                   });\n                   toast('success', \"Cible touchée ! -10 VE.\");\n               } else {\n                   // Risk: Admin sees suspicion. No automatic penalty here to keep \"Trace\" logic separate.\n                   toast('error', \"Cible saine. L'audit n'a rien trouvé.\");\n               }\n               batch.update(agencyRef, { members: updatedMembers });\n          }\n      }\n\n      // GLOBAL TRACE (For Admin)\n      // We add a 'BLACK_OP' event to the source agency to track activity, but without description to keep it vague for admin unless they dig\n      // Or we append to a global log. For now, let's append to agency log but marked as hidden/system or just \"Activite Suspecte\"\n      batch.update(agencyRef, {\n          eventLog: [...studentAgency.eventLog, {\n              id: `trace-${Date.now()}`,\n              date: today,\n              type: 'BLACK_OP',\n              label: 'Activité Suspecte',\n              deltaVE: 0,\n              description: \"Une transaction non-signée a été détectée sur le réseau.\"\n          }]\n      });\n\n      await batch.commit();\n  };\n\n  const triggerBlackOp = async (sourceAgencyId: string, targetAgencyId: string, type: 'AUDIT' | 'LEAK') => {\n      // LEGACY AGENCY-FUNDED BLACK OPS (KEPT FOR COMPATIBILITY OR IF CALLED FROM MARKET VIEW)\n      const week = getCurrentGameWeek();\n      if (week < GAME_RULES.UNLOCK_WEEK_BLACK_OPS) {\n          toast('error', `Disponible en Semaine ${GAME_RULES.UNLOCK_WEEK_BLACK_OPS} uniquement.`);\n          return;\n      }\n\n      const sourceAgency = agencies.find(a => a.id === sourceAgencyId);\n      const targetAgency = agencies.find(a => a.id === targetAgencyId);\n      if (!sourceAgency || !targetAgency) return;\n\n      const cost = type === 'AUDIT' ? GAME_RULES.COST_AUDIT : GAME_RULES.COST_LEAK;\n\n      if (sourceAgency.budget_real < cost) {\n          toast('error', \"Fonds insuffisants pour cette opération.\");\n          return;\n      }\n\n      const batch = writeBatch(db);\n      const today = new Date().toISOString().split('T')[0];\n\n      // 1. Pay Cost\n      const sourceRef = doc(db, \"agencies\", sourceAgency.id);\n      batch.update(sourceRef, {\n          budget_real: sourceAgency.budget_real - cost,\n          eventLog: [...sourceAgency.eventLog, {\n              id: `op-cost-${Date.now()}`, date: today, type: 'BLACK_OP', label: `Opération: ${type}`, deltaBudgetReal: -cost, description: `Paiement prestataire externe.`\n          }]\n      });\n\n      // 2. Execute Effect\n      if (type === 'LEAK') {\n          toast('success', \"Fuite obtenue : Le brief de la semaine prochaine contient une contrainte 'Low Tech'.\");\n      } else if (type === 'AUDIT') {\n          const isVulnerable = targetAgency.budget_real < 0 || targetAgency.ve_current < 40;\n          if (isVulnerable) {\n               const targetRef = doc(db, \"agencies\", targetAgency.id);\n               batch.update(targetRef, {\n                   ve_current: Math.max(0, targetAgency.ve_current - 10),\n                   eventLog: [...targetAgency.eventLog, {\n                       id: `op-hit-${Date.now()}`, date: today, type: 'CRISIS', label: \"Audit Externe (Sanction)\", deltaVE: -10, description: \"Des irrégularités ont été exposées par un audit concurrent.\"\n                   }]\n               });\n               toast('success', `Audit réussi ! ${targetAgency.name} perd 10 VE.`);\n          } else {\n               batch.update(sourceRef, {\n                   ve_current: Math.max(0, sourceAgency.ve_current - 20),\n                   eventLog: [...sourceAgency.eventLog, {\n                       id: `op-fail-${Date.now()}`, date: today, type: 'CRISIS', label: \"Procès Diffamation\", deltaVE: -20, description: \"L'audit n'a rien révélé. L'agence cible porte plainte.\"\n                   }]\n               });\n               toast('error', `Echec ! ${targetAgency.name} est clean. Vous perdez 20 VE pour diffamation.`);\n          }\n      }\n      await batch.commit();\n  };\n\n  const submitMercatoVote = async (agencyId: string, requestId: string, voterId: string, vote: 'APPROVE' | 'REJECT') => {\n      const agency = agencies.find(a => a.id === agencyId);\n      if(!agency) return;\n      const request = agency.mercatoRequests.find(r => r.id === requestId);\n      if(!request) return;\n\n      const newVotes = { ...request.votes, [voterId]: vote };\n      const approvals = Object.values(newVotes).filter(v => v === 'APPROVE').length;\n      let totalVoters = agency.members.length;\n      let threshold = GAME_RULES.VOTE_THRESHOLD_HIRE; \n      \n      if (request.type === 'FIRE' && request.requesterId !== request.studentId) { \n          totalVoters = Math.max(1, agency.members.length - 1); \n          threshold = GAME_RULES.VOTE_THRESHOLD_FIRE;\n      }\n\n      const batch = writeBatch(db);\n      if (approvals / totalVoters > threshold) {\n          const targetAgency = agencies.find(a => a.id === 'unassigned');\n          if(targetAgency) {\n               const student = agency.members.find(m => m.id === request.studentId);\n               if(student) {\n                   const updatedSource = agency.members.filter(m => m.id !== request.studentId);\n                   const updatedTarget = [...targetAgency.members, { ...student, history: [] }];\n                   batch.update(doc(db, \"agencies\", agency.id), { members: updatedSource, mercatoRequests: agency.mercatoRequests.filter(r => r.id !== requestId) });\n                   batch.update(doc(db, \"agencies\", targetAgency.id), { members: updatedTarget });\n               }\n          }\n      } else {\n          const updatedRequests = agency.mercatoRequests.map(r => r.id === requestId ? { ...r, votes: newVotes } : r);\n          batch.update(doc(db, \"agencies\", agency.id), { mercatoRequests: updatedRequests });\n      }\n      await batch.commit();\n      toast('success', \"Vote enregistré\");\n  };\n\n  const proposeMerger = async (sourceAgencyId: string, targetAgencyId: string) => {\n      const week = getCurrentGameWeek();\n      if (week < GAME_RULES.UNLOCK_WEEK_MERGERS) {\n          toast('error', `Fusions disponibles en Semaine ${GAME_RULES.UNLOCK_WEEK_MERGERS}.`);\n          return;\n      }\n      \n      const targetAgency = agencies.find(a => a.id === targetAgencyId);\n      if(!targetAgency) return;\n\n      if (targetAgency.ve_current > GAME_RULES.MERGER_VE_THRESHOLD) {\n           toast('error', \"Cette agence est trop stable pour être rachetée (VE > 40).\");\n           return;\n      }\n\n      const request: MergerRequest = {\n          id: `merger-${Date.now()}`,\n          requesterAgencyId: sourceAgencyId,\n          requesterAgencyName: agencies.find(a => a.id === sourceAgencyId)?.name || 'Inconnu',\n          targetAgencyId: targetAgencyId,\n          status: 'PENDING',\n          date: new Date().toISOString().split('T')[0],\n          offerDetails: \"Rachat complet de la dette et intégration des effectifs.\"\n      };\n\n      const targetRef = doc(db, \"agencies\", targetAgencyId);\n      await updateDoc(targetRef, {\n          mergerRequests: [...(targetAgency.mergerRequests || []), request]\n      });\n      toast('success', \"Proposition de rachat envoyée.\");\n  };\n\n  const finalizeMerger = async (mergerId: string, targetAgencyId: string, approved: boolean) => {\n      const targetAgency = agencies.find(a => a.id === targetAgencyId);\n      if(!targetAgency) return;\n      const request = targetAgency.mergerRequests?.find(r => r.id === mergerId);\n      if(!request) return;\n\n      const batch = writeBatch(db);\n      const updatedRequests = targetAgency.mergerRequests?.filter(r => r.id !== mergerId);\n      \n      if (!approved) {\n           batch.update(doc(db, \"agencies\", targetAgencyId), { mergerRequests: updatedRequests });\n           await batch.commit();\n           toast('info', \"Fusion refusée.\");\n           return;\n      }\n\n      const sourceAgency = agencies.find(a => a.id === request.requesterAgencyId);\n      if(!sourceAgency) return;\n\n      if (sourceAgency.members.length + targetAgency.members.length > GAME_RULES.MERGER_MAX_MEMBERS) {\n          toast('error', `Fusion impossible : La nouvelle équipe dépasserait ${GAME_RULES.MERGER_MAX_MEMBERS} membres.`);\n          return;\n      }\n\n      const newMembers = [...sourceAgency.members, ...targetAgency.members];\n      const newBudget = sourceAgency.budget_real + targetAgency.budget_real;\n      \n      batch.update(doc(db, \"agencies\", sourceAgency.id), {\n          members: newMembers,\n          budget_real: newBudget,\n          eventLog: [...sourceAgency.eventLog, {\n              id: `merger-win-${Date.now()}`, date: new Date().toISOString().split('T')[0], type: 'MERGER', label: \"Acquisition\", description: `Rachat de ${targetAgency.name}. Dette absorbée.`\n          }]\n      });\n\n      batch.update(doc(db, \"agencies\", targetAgency.id), {\n          members: [],\n          status: 'critique',\n          name: `${targetAgency.name} (Dissoute)`,\n          mergerRequests: []\n      });\n\n      await batch.commit();\n      toast('success', \"Fusion confirmée. Agence absorbée.\");\n  };\n\n  const sendChallenge = async (targetAgencyId: string, title: string, description: string) => {\n      const agency = agencies.find(a => a.id === targetAgencyId);\n      if (!agency) return;\n\n      const newChallenge: ChallengeRequest = {\n          id: `chal-${Date.now()}`,\n          title,\n          description,\n          status: 'PENDING_VOTE',\n          date: new Date().toISOString().split('T')[0],\n          rewardVE: 10,\n          votes: {}\n      };\n\n      const agencyRef = doc(db, \"agencies\", targetAgencyId);\n      await updateDoc(agencyRef, {\n          challenges: [...(agency.challenges || []), newChallenge]\n      });\n      toast('success', \"Challenge envoyé au vote !\");\n  };\n\n  const submitChallengeVote = async (agencyId: string, challengeId: string, voterId: string, vote: 'APPROVE' | 'REJECT') => {\n      const agency = agencies.find(a => a.id === agencyId);\n      if (!agency) return;\n      const challenge = agency.challenges?.find(c => c.id === challengeId);\n      if (!challenge) return;\n\n      const newVotes = { ...challenge.votes, [voterId]: vote };\n      const approvals = Object.values(newVotes).filter(v => v === 'APPROVE').length;\n      const totalVoters = agency.members.length;\n      \n      const isAccepted = (approvals / totalVoters) > GAME_RULES.VOTE_THRESHOLD_CHALLENGE;\n      \n      const batch = writeBatch(db);\n      const agencyRef = doc(db, \"agencies\", agency.id);\n\n      if (isAccepted) {\n          const updatedChallenges = agency.challenges?.map(c => \n              c.id === challengeId ? { ...c, status: 'ACCEPTED', votes: newVotes } : c\n          );\n          \n          const currentWeekId = getCurrentGameWeek().toString();\n          const weekData = agency.progress[currentWeekId];\n          if (weekData) {\n              const newDeliverable: Deliverable = {\n                  id: `d-special-${Date.now()}`,\n                  name: `CHALLENGE: ${challenge.title}`,\n                  description: challenge.description,\n                  status: 'pending',\n                  score: 0\n              };\n              \n              const updatedWeek = {\n                  ...weekData,\n                  deliverables: [...weekData.deliverables, newDeliverable]\n              };\n\n              batch.update(agencyRef, {\n                  challenges: updatedChallenges,\n                  [`progress.${currentWeekId}`]: updatedWeek,\n                  eventLog: [...agency.eventLog, {\n                      id: `chal-acc-${Date.now()}`, date: new Date().toISOString().split('T')[0], type: 'INFO',\n                      label: \"Challenge Accepté\", description: \"L'équipe a accepté le défi spécial. Mission ajoutée.\"\n                  }]\n              });\n              toast('success', \"Challenge accepté ! Mission créée.\");\n          }\n      } else {\n          const updatedChallenges = agency.challenges?.map(c => \n              c.id === challengeId ? { ...c, votes: newVotes } : c\n          );\n          batch.update(agencyRef, { challenges: updatedChallenges });\n      }\n\n      await batch.commit();\n  };\n\n  return { updateAgency, processPerformance, shuffleConstraints, triggerBlackOp, performBlackOp, submitMercatoVote, proposeMerger, finalizeMerger, sendChallenge, submitChallengeVote };\n};\n"
            }
          ]
        },
        {
          "path": "components/student/TheBackdoor.tsx",
          "generationType": 1,
          "isDone": true,
          "description": "Nouveau composant pour le marché noir (The Backdoor) avec UI Matrix et logique d'achat.",
          "diffs": [
            {
              "target": "",
              "replacement": "\nimport React, { useState, useEffect } from 'react';\nimport { Agency, Student, Deliverable } from '../../types';\nimport { useGame } from '../../contexts/GameContext';\nimport { useUI } from '../../contexts/UIContext';\nimport { Terminal, ShieldAlert, Eye, Vote, Lock, FileX, Skull } from 'lucide-react';\n\ninterface TheBackdoorProps {\n    agency: Agency;\n    allAgencies: Agency[];\n    currentUser: Student;\n    onClose: () => void;\n}\n\n// Pseudo-random user obfuscation\nconst generateAlias = (name: string) => {\n    const hash = name.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);\n    return `User-${hash.toString(16).toUpperCase().slice(0,4)}`;\n};\n\nexport const TheBackdoor: React.FC<TheBackdoorProps> = ({ agency, allAgencies, currentUser, onClose }) => {\n    const { performBlackOp } = useGame();\n    const { confirm, toast } = useUI();\n    const [terminalOutput, setTerminalOutput] = useState<string[]>([\"Initialisation protocole 22-04...\", \"Connexion sécurisée établie.\"]);\n    const [selectedItem, setSelectedItem] = useState<string | null>(null);\n    const [targetId, setTargetId] = useState<string>(\"\");\n    const [doxxResult, setDoxxResult] = useState<string | null>(null);\n\n    // Filter Targets\n    const rivalAgencies = allAgencies.filter(a => a.id !== 'unassigned' && a.id !== agency.id);\n    \n    const addToTerminal = (text: string) => {\n        setTerminalOutput(prev => [...prev, `> ${text}`]);\n    };\n\n    const handleBuy = async () => {\n        if (!selectedItem) return;\n\n        let opType: any = '';\n        let payload: any = {};\n        let cost = 0;\n\n        if (selectedItem === 'SHORT_SELL') {\n            if (!targetId) { addToTerminal(\"ERREUR: Cible manquante.\"); return; }\n            opType = 'SHORT_SELL';\n            payload = { targetId };\n            cost = 500;\n        } \n        else if (selectedItem === 'DOXXING') {\n            opType = 'DOXXING';\n            payload = {}; // Self agency check\n            cost = 600;\n        }\n        else if (selectedItem === 'FAKE_CERT') {\n            // Find a late deliverable\n            let lateDeliv: {weekId: string, delId: string} | null = null;\n            Object.values(agency.progress).forEach(w => {\n                w.deliverables.forEach(d => {\n                    if (d.grading && d.grading.daysLate > 0) lateDeliv = { weekId: w.id, delId: d.id };\n                });\n            });\n            \n            if (!lateDeliv) {\n                addToTerminal(\"ERREUR: Aucun retard détecté à effacer.\");\n                return;\n            }\n            opType = 'FAKE_CERT';\n            payload = { weekId: lateDeliv.weekId, deliverableId: lateDeliv.delId };\n            cost = 500;\n        }\n        else if (selectedItem === 'BUY_VOTE') {\n            if (!targetId) { addToTerminal(\"ERREUR: Requête cible manquante.\"); return; }\n            opType = 'BUY_VOTE';\n            payload = { requestId: targetId };\n            cost = 200;\n        }\n        else if (selectedItem === 'AUDIT_HOSTILE') {\n            if (!targetId) { addToTerminal(\"ERREUR: Cible manquante.\"); return; }\n            opType = 'AUDIT_HOSTILE';\n            payload = { targetId };\n            cost = 500;\n        }\n\n        if ((currentUser.wallet || 0) < cost) {\n            addToTerminal(\"ERREUR: Fonds insuffisants (PiXi).\");\n            return;\n        }\n\n        // EXECUTE\n        addToTerminal(`Exécution ${opType}...`);\n        await performBlackOp(currentUser.id, agency.id, opType, payload);\n        addToTerminal(\"Transaction terminée. Trace effacée (partiellement).\");\n\n        // UI FEEDBACK SPECIFIC\n        if (opType === 'DOXXING') {\n            const badReviews = agency.peerReviews.filter(r => \n                ((r.ratings.attendance + r.ratings.quality + r.ratings.involvement)/3) < 3\n            );\n            if (badReviews.length > 0) {\n                const reveal = badReviews.map(r => `${r.reviewerName} a noté ${r.targetName} (Moy: ${((r.ratings.attendance+r.ratings.quality+r.ratings.involvement)/3).toFixed(1)})`).join('\\n');\n                setDoxxResult(reveal);\n                addToTerminal(\"RÉSULTAT DOXXING OBTENU.\");\n            } else {\n                setDoxxResult(\"Aucune mauvaise note (< 3/5) détectée cette semaine.\");\n                addToTerminal(\"Rien à signaler.\");\n            }\n        }\n    };\n\n    return (\n        <div className=\"fixed inset-0 z-[100] bg-black text-[#00ff41] font-mono p-4 md:p-8 flex flex-col overflow-hidden animate-in fade-in duration-300\">\n            {/* HEADER */}\n            <div className=\"flex justify-between items-center border-b border-[#00ff41] pb-4 mb-4\">\n                <div>\n                    <h1 className=\"text-2xl md:text-4xl font-bold tracking-widest uppercase glitch-text\">THE BACKDOOR // 22-04</h1>\n                    <p className=\"text-xs opacity-70\">Connexion cryptée : {generateAlias(currentUser.name)}</p>\n                </div>\n                <button onClick={onClose} className=\"text-red-500 hover:text-red-400 border border-red-500 px-4 py-2 rounded uppercase text-xs font-bold hover:bg-red-900/20 transition-colors\">\n                    Fermer la connexion\n                </button>\n            </div>\n\n            <div className=\"flex-1 grid grid-cols-1 md:grid-cols-3 gap-8 overflow-hidden\">\n                \n                {/* LEFT: MARKET ITEMS */}\n                <div className=\"md:col-span-2 overflow-y-auto custom-scrollbar border-r border-[#00ff41]/30 pr-4 space-y-6\">\n                    \n                    <div className=\"mb-2 text-xs uppercase opacity-50\">--- ROTATION OFFRES (72H) ---</div>\n\n                    {/* ITEM 1: SHORT SELL */}\n                    <div \n                        onClick={() => { setSelectedItem('SHORT_SELL'); setTargetId(\"\"); }}\n                        className={`p-4 border border-[#00ff41]/50 cursor-pointer hover:bg-[#00ff41]/10 transition-all ${selectedItem === 'SHORT_SELL' ? 'bg-[#00ff41]/20 border-[#00ff41]' : ''}`}\n                    >\n                        <div className=\"flex justify-between items-start mb-2\">\n                            <h3 className=\"font-bold text-lg flex items-center gap-2\"><TrendingUp size={20} className=\"rotate-180\"/> Short Selling</h3>\n                            <span className=\"font-bold\">500 PiXi</span>\n                        </div>\n                        <p className=\"text-sm opacity-80 mb-2\">Parier sur la chute d'une agence. Si elle perd de la VE au prochain bilan, vous gagnez 1000 PiXi.</p>\n                        {selectedItem === 'SHORT_SELL' && (\n                            <select \n                                className=\"w-full bg-black border border-[#00ff41] p-2 text-sm mt-2 focus:outline-none\"\n                                onChange={(e) => setTargetId(e.target.value)}\n                            >\n                                <option value=\"\">-- CIBLE À SHORTER --</option>\n                                {rivalAgencies.map(a => <option key={a.id} value={a.id}>{a.name} (VE: {a.ve_current})</option>)}\n                            </select>\n                        )}\n                    </div>\n\n                    {/* ITEM 2: DOXXING RH */}\n                    <div \n                        onClick={() => { setSelectedItem('DOXXING'); setTargetId(\"\"); }}\n                        className={`p-4 border border-[#00ff41]/50 cursor-pointer hover:bg-[#00ff41]/10 transition-all ${selectedItem === 'DOXXING' ? 'bg-[#00ff41]/20 border-[#00ff41]' : ''}`}\n                    >\n                        <div className=\"flex justify-between items-start mb-2\">\n                            <h3 className=\"font-bold text-lg flex items-center gap-2\"><Eye size={20}/> Doxxing RH</h3>\n                            <span className=\"font-bold\">600 PiXi</span>\n                        </div>\n                        <p className=\"text-sm opacity-80\">Révèle l'identité des auteurs de mauvaises notes (< 3/5) dans votre agence cette semaine.</p>\n                        {doxxResult && selectedItem === 'DOXXING' && (\n                            <div className=\"mt-2 p-2 border border-red-500 text-red-500 text-xs whitespace-pre-line bg-red-900/10\">\n                                {doxxResult}\n                            </div>\n                        )}\n                    </div>\n\n                    {/* ITEM 3: FAUX CERTIFICAT */}\n                    <div \n                        onClick={() => { setSelectedItem('FAKE_CERT'); setTargetId(\"\"); }}\n                        className={`p-4 border border-[#00ff41]/50 cursor-pointer hover:bg-[#00ff41]/10 transition-all ${selectedItem === 'FAKE_CERT' ? 'bg-[#00ff41]/20 border-[#00ff41]' : ''}`}\n                    >\n                        <div className=\"flex justify-between items-start mb-2\">\n                            <h3 className=\"font-bold text-lg flex items-center gap-2\"><FileX size={20}/> Faux Certificat</h3>\n                            <span className=\"font-bold\">500 PiXi</span>\n                        </div>\n                        <p className=\"text-sm opacity-80\">Efface rétroactivement un retard noté sur un livrable. Risque de détection: 20%.</p>\n                    </div>\n\n                    {/* ITEM 4: ACHAT DE VOTE */}\n                    <div \n                        onClick={() => { setSelectedItem('BUY_VOTE'); setTargetId(\"\"); }}\n                        className={`p-4 border border-[#00ff41]/50 cursor-pointer hover:bg-[#00ff41]/10 transition-all ${selectedItem === 'BUY_VOTE' ? 'bg-[#00ff41]/20 border-[#00ff41]' : ''}`}\n                    >\n                        <div className=\"flex justify-between items-start mb-2\">\n                            <h3 className=\"font-bold text-lg flex items-center gap-2\"><Vote size={20}/> Bourrage d'Urne</h3>\n                            <span className=\"font-bold\">200 PiXi</span>\n                        </div>\n                        <p className=\"text-sm opacity-80\">Ajoute un vote \"APPROVE\" fantôme sur une demande Mercato active.</p>\n                        {selectedItem === 'BUY_VOTE' && (\n                            <select \n                                className=\"w-full bg-black border border-[#00ff41] p-2 text-sm mt-2 focus:outline-none\"\n                                onChange={(e) => setTargetId(e.target.value)}\n                            >\n                                <option value=\"\">-- SÉLECTIONNER VOTE --</option>\n                                {allAgencies.flatMap(a => a.mercatoRequests).filter(r => r.status === 'PENDING').map(r => (\n                                    <option key={r.id} value={r.id}>{r.type} : {r.studentName}</option>\n                                ))}\n                            </select>\n                        )}\n                    </div>\n\n                    {/* ITEM 5: AUDIT HOSTILE */}\n                    <div \n                        onClick={() => { setSelectedItem('AUDIT_HOSTILE'); setTargetId(\"\"); }}\n                        className={`p-4 border border-[#00ff41]/50 cursor-pointer hover:bg-[#00ff41]/10 transition-all ${selectedItem === 'AUDIT_HOSTILE' ? 'bg-[#00ff41]/20 border-[#00ff41]' : ''}`}\n                    >\n                        <div className=\"flex justify-between items-start mb-2\">\n                            <h3 className=\"font-bold text-lg flex items-center gap-2\"><Skull size={20}/> Audit Hostile</h3>\n                            <span className=\"font-bold\">500 PiXi</span>\n                        </div>\n                        <p className=\"text-sm opacity-80\">Attaque la crédibilité d'une agence adverse fragile. (-10 VE si succès).</p>\n                        {selectedItem === 'AUDIT_HOSTILE' && (\n                            <select \n                                className=\"w-full bg-black border border-[#00ff41] p-2 text-sm mt-2 focus:outline-none\"\n                                onChange={(e) => setTargetId(e.target.value)}\n                            >\n                                <option value=\"\">-- CIBLE À ATTAQUER --</option>\n                                {rivalAgencies.map(a => <option key={a.id} value={a.id}>{a.name}</option>)}\n                            </select>\n                        )}\n                    </div>\n\n                </div>\n\n                {/* RIGHT: TERMINAL & WALLET */}\n                <div className=\"flex flex-col gap-4\">\n                    <div className=\"border border-[#00ff41] p-4 bg-[#001100]\">\n                        <h4 className=\"text-xs uppercase font-bold mb-2 opacity-70\">Wallet Caché (Non-traçable)</h4>\n                        <div className=\"text-3xl font-bold\">{currentUser.wallet} PiXi</div>\n                    </div>\n\n                    <div className=\"flex-1 border border-[#00ff41] p-4 bg-black font-mono text-xs overflow-y-auto flex flex-col-reverse\">\n                        {terminalOutput.map((line, i) => (\n                            <div key={i} className=\"mb-1 opacity-80\">{line}</div>\n                        ))}\n                    </div>\n\n                    <button \n                        onClick={handleBuy}\n                        disabled={!selectedItem}\n                        className={`w-full py-4 font-bold text-black text-lg transition-all uppercase tracking-widest ${\n                            selectedItem ? 'bg-[#00ff41] hover:bg-white cursor-pointer' : 'bg-[#004411] cursor-not-allowed text-[#008822]'\n                        }`}\n                    >\n                        {selectedItem ? `CONFIRMER ACHAT` : 'SÉLECTIONNER OFFRE'}\n                    </button>\n                    \n                    <div className=\"text-[10px] text-center opacity-50\">\n                        Attention : Le Karma ne dort jamais.\n                    </div>\n                </div>\n            </div>\n            \n            <style>{`\n                .glitch-text {\n                    text-shadow: 2px 0 #ff0000, -2px 0 #0000ff;\n                }\n            `}</style>\n        </div>\n    );\n};\n"
            }
          ]
        },
        {
          "path": "components/StudentAgencyView.tsx",
          "generationType": 1,
          "isDone": true,
          "description": "Intégration du composant TheBackdoor avec vérification horaire (22h-04h).",
          "diffs": [
            {
              "target": "",
              "replacement": "\nimport React, { useState, useEffect } from 'react';\nimport { Agency, BrandColor, Student, GameEvent, MercatoRequest, ChallengeRequest } from '../types';\nimport { Target, Users, History, Wallet, TrendingUp, HelpCircle, Briefcase, Settings, Image as ImageIcon, Shield, Eye, Crown, BookOpen, Send, Repeat, ArrowUpRight, Building2, Zap, AlertTriangle, PartyPopper, Gavel, Landmark, Landmark as Bank, Check, X, Info, Rocket, Upload, Bug } from 'lucide-react';\nimport { MarketOverview } from './student/MarketOverview';\nimport { MissionsView } from './student/MissionsView';\nimport { TeamView } from './student/TeamView';\n// HistoryView removed from direct import as it is now inside MarketOverview\nimport { MercatoView } from './student/MercatoView';\nimport { WikiView } from './student/WikiView';\nimport { FAQView } from './student/FAQView';\nimport { TheBackdoor } from './student/TheBackdoor'; // IMPORT\nimport { Modal } from './Modal';\nimport { GAME_RULES, BADGE_DEFINITIONS } from '../constants';\nimport { ref, uploadBytes, getDownloadURL, storage } from '../services/firebase';\nimport { useUI } from '../contexts/UIContext';\nimport { useAuth } from '../contexts/AuthContext';\nimport { useGame } from '../contexts/GameContext';\n\ninterface StudentViewProps {\n  agency: Agency;\n  allAgencies: Agency[];\n  onUpdateAgency: (agency: Agency) => void;\n}\n\ntype TabType = 'MARKET' | 'MISSIONS' | 'TEAM' | 'RECRUITMENT' | 'RESOURCES' | 'HELP';\n\nconst COLOR_THEMES: Record<BrandColor, { bg: string, text: string }> = {\n    indigo: { bg: 'bg-indigo-600', text: 'text-indigo-600' },\n    emerald: { bg: 'bg-emerald-600', text: 'text-emerald-600' },\n    rose: { bg: 'bg-rose-600', text: 'text-rose-600' },\n    amber: { bg: 'bg-amber-500', text: 'text-amber-500' },\n    cyan: { bg: 'bg-cyan-500', text: 'text-cyan-500' },\n    slate: { bg: 'bg-slate-600', text: 'text-slate-600' },\n};\n\n// LIMITE IMAGES : 2 Mo\nconst MAX_IMAGE_SIZE = 2 * 1024 * 1024;\n\nexport const StudentAgencyView: React.FC<StudentViewProps> = ({ agency, allAgencies, onUpdateAgency }) => {\n  const { toast } = useUI();\n  const { currentUser } = useAuth();\n  const { transferFunds, injectCapital, requestScorePurchase, getCurrentGameWeek, updateAgenciesList, submitMercatoVote, submitChallengeVote } = useGame();\n  \n  const [activeTab, setActiveTab] = useState<TabType>('MARKET');\n  const [showVERules, setShowVERules] = useState(false);\n  const [showSettings, setShowSettings] = useState(false);\n  \n  const [unlockModal, setUnlockModal] = useState<{title: string, message: string, icon: any, confirmText: string} | null>(null);\n  const [notificationEvent, setNotificationEvent] = useState<GameEvent | null>(null);\n\n  // BACKDOOR STATE\n  const [showBackdoor, setShowBackdoor] = useState(false);\n  const [isBackdoorAvailable, setIsBackdoorAvailable] = useState(false);\n\n  const brandColor = agency.branding?.color || 'indigo';\n  const theme = COLOR_THEMES[brandColor];\n  const leaderboard = [...allAgencies].filter(a => a.id !== 'unassigned').sort((a, b) => b.ve_current - a.ve_current);\n  const myRank = leaderboard.findIndex(a => a.id === agency.id) + 1;\n  const rawSalary = agency.members.reduce((acc, member) => acc + (member.individualScore * GAME_RULES.SALARY_MULTIPLIER), 0);\n  const weeklyCharges = rawSalary * (1 + (agency.weeklyTax || 0)) + GAME_RULES.AGENCY_RENT;\n  const veRevenue = agency.ve_current * GAME_RULES.REVENUE_VE_MULTIPLIER;\n  const weeklyRevenue = GAME_RULES.REVENUE_BASE + veRevenue + (agency.weeklyRevenueModifier || 0);\n  const netWeekly = weeklyRevenue - weeklyCharges;\n  const myMemberProfile = agency.members.find(m => m.id === currentUser?.uid);\n\n  // TIME CHECK FOR BACKDOOR\n  useEffect(() => {\n      const checkTime = () => {\n          const hour = new Date().getHours();\n          // Available between 22h and 04h\n          const isOpen = hour >= 22 || hour < 4;\n          setIsBackdoorAvailable(isOpen);\n      };\n      checkTime();\n      const timer = setInterval(checkTime, 60000); // Check every minute\n      return () => clearInterval(timer);\n  }, []);\n\n  useEffect(() => {\n      const currentWeek = getCurrentGameWeek();\n      if (currentWeek >= GAME_RULES.UNLOCK_WEEK_BLACK_OPS) {\n          const hasSeenBlackOps = localStorage.getItem(`seen_unlock_blackops_${currentUser?.uid}`);\n          if (!hasSeenBlackOps) {\n              setUnlockModal({\n                  title: \"Intelligence Économique Activée\",\n                  message: \"Le marché se durcit. Vous avez désormais accès aux outils de veille stratégique.\\n\\nNouveauté : Audits concurrentiels et achat d'informations disponibles dans l'onglet 'Marché'.\",\n                  icon: <Eye size={32} className=\"text-yellow-500\"/>,\n                  confirmText: \"Compris, je reste vigilant\"\n              });\n              localStorage.setItem(`seen_unlock_blackops_${currentUser?.uid}`, 'true');\n              return; \n          }\n      }\n  }, [getCurrentGameWeek, currentUser]);\n\n  useEffect(() => {\n      if (agency.eventLog.length === 0) return;\n      const latestEvent = agency.eventLog[agency.eventLog.length - 1];\n      const NOTIFY_TYPES = ['CRISIS', 'VE_DELTA'];\n      if (NOTIFY_TYPES.includes(latestEvent.type)) {\n          const seenKey = `seen_event_${currentUser?.uid}_${latestEvent.id}`;\n          const hasSeen = localStorage.getItem(seenKey);\n          if (!hasSeen) setNotificationEvent(latestEvent);\n      }\n  }, [agency.eventLog, currentUser]);\n\n  const closeNotification = () => {\n      if (notificationEvent) {\n          localStorage.setItem(`seen_event_${currentUser?.uid}_${notificationEvent.id}`, 'true');\n          setNotificationEvent(null);\n      }\n  };\n\n  const handleColorChange = (color: BrandColor) => {\n      onUpdateAgency({ ...agency, branding: { ...agency.branding, color } });\n  };\n\n  const handleBannerUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {\n      if (e.target.files && e.target.files[0]) {\n          const file = e.target.files[0];\n          if (file.size > MAX_IMAGE_SIZE) {\n              toast('error', `Image trop lourde (${(file.size/1024/1024).toFixed(1)} Mo). Max 2 Mo.`);\n              return;\n          }\n          try {\n              const storageRef = ref(storage, `banners/${agency.id}_${Date.now()}`);\n              await uploadBytes(storageRef, file);\n              const url = await getDownloadURL(storageRef);\n              onUpdateAgency({ ...agency, branding: { ...agency.branding, bannerUrl: url } });\n              toast('success', 'Bannière mise à jour');\n          } catch (error) { toast('error', \"Erreur d'upload\"); }\n      }\n  };\n\n  const handleLogoUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {\n    if (e.target.files && e.target.files[0]) {\n        const file = e.target.files[0];\n        if (file.size > MAX_IMAGE_SIZE) {\n            toast('error', `Image trop lourde (${(file.size/1024/1024).toFixed(1)} Mo). Max 2 Mo.`);\n            return;\n        }\n        try {\n            const storageRef = ref(storage, `logos/${agency.id}_${Date.now()}`);\n            await uploadBytes(storageRef, file);\n            const url = await getDownloadURL(storageRef);\n            onUpdateAgency({ ...agency, logoUrl: url });\n            toast('success', 'Logo mis à jour');\n        } catch (error) { toast('error', \"Erreur d'upload du logo\"); }\n    }\n  };\n\n  if (showBackdoor && myMemberProfile) {\n      return <TheBackdoor agency={agency} allAgencies={allAgencies} currentUser={myMemberProfile} onClose={() => setShowBackdoor(false)} />;\n  }\n\n  return (\n    <div className=\"flex flex-col min-h-[calc(100vh-6rem)] font-sans relative\">\n        \n        {/* BACKDOOR TRIGGER (INVISIBLE UNLESS TIME MATCHES) */}\n        {isBackdoorAvailable && (\n            <button \n                onClick={() => setShowBackdoor(true)}\n                className=\"fixed bottom-4 right-4 z-[60] w-2 h-2 bg-transparent hover:bg-black/10 cursor-alias\"\n                title=\"?\"\n            >\n                <div className=\"w-full h-full animate-ping bg-green-500 opacity-20\"></div>\n            </button>\n        )}\n\n        {/* HEADER */}\n        <div className=\"relative mb-8 rounded-b-3xl md:rounded-3xl overflow-hidden bg-slate-100 min-h-[200px] md:min-h-[240px] shadow-md group\">\n            {agency.branding?.bannerUrl ? (\n                <img src={agency.branding.bannerUrl} className=\"absolute inset-0 w-full h-full object-cover\" alt=\"Banner\" />\n            ) : (\n                <div className={`absolute inset-0 opacity-10 ${theme.bg}`} style={{backgroundImage: 'radial-gradient(circle, #000 1px, transparent 1px)', backgroundSize: '20px 20px'}}></div>\n            )}\n            <div className=\"absolute inset-0 bg-gradient-to-t from-slate-900/90 via-slate-900/40 to-transparent\"></div>\n            {agency.id !== 'unassigned' && (\n                <button onClick={() => setShowSettings(true)} className=\"absolute top-4 right-4 p-2 bg-black/30 backdrop-blur-md rounded-full text-white hover:bg-black/50 transition-all opacity-0 group-hover:opacity-100 border border-white/10 z-20\">\n                    <Settings size={20}/>\n                </button>\n            )}\n            <div className=\"absolute bottom-0 left-0 right-0 p-6 flex flex-col xl:flex-row justify-between items-end xl:items-end gap-6 text-white\">\n                <div className=\"w-full xl:w-auto flex gap-4 items-end\">\n                    {/* AGENCY LOGO */}\n                    {agency.logoUrl && (\n                        <div className=\"w-20 h-20 md:w-24 md:h-24 rounded-2xl bg-white p-1 shadow-2xl shrink-0 animate-in zoom-in duration-300\">\n                            <img src={agency.logoUrl} className=\"w-full h-full object-contain rounded-xl\" alt=\"Logo\" />\n                        </div>\n                    )}\n                    <div className=\"flex-1\">\n                        <div className=\"flex items-center gap-3 mb-1\">\n                            {agency.id !== 'unassigned' && <span className=\"bg-white/20 backdrop-blur border border-white/10 px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider\">Rang #{myRank}</span>}\n                            <span className=\"text-slate-300 italic text-sm truncate\">\"{agency.tagline}\"</span>\n                        </div>\n                        <h2 className=\"text-4xl md:text-5xl font-display font-bold tracking-tight drop-shadow-lg leading-none mb-3\">{agency.name}</h2>\n                        <div className=\"flex items-center gap-1\">\n                            {agency.badges && agency.badges.map(b => (\n                                <div key={b.id} title={b.label} className=\"w-6 h-6 rounded-full bg-yellow-400 text-yellow-900 flex items-center justify-center shadow-lg border border-yellow-200\"><Shield size={12}/></div>\n                            ))}\n                        </div>\n                    </div>\n                </div>\n\n                {agency.id !== 'unassigned' && (\n                <div className=\"flex flex-col md:flex-row gap-4 w-full xl:w-auto bg-black/40 backdrop-blur-md p-4 rounded-2xl border border-white/10\">\n                    {myMemberProfile && (\n                        <div className=\"flex-1 md:text-right md:border-r border-white/20 md:pr-4\">\n                            <span className=\"text-[10px] font-bold text-yellow-300 uppercase tracking-widest block mb-1 flex items-center gap-1 md:justify-end\">\n                                <Wallet size={12}/> Mon Solde\n                            </span>\n                            <div className=\"text-lg font-bold text-white flex items-center md:justify-end gap-2\">\n                                <span className={`font-mono ${myMemberProfile.wallet && myMemberProfile.wallet < 0 ? 'text-red-400' : 'text-yellow-400'}`}>{myMemberProfile.wallet || 0} PiXi</span>\n                            </div>\n                        </div>\n                    )}\n                    \n                    <div className=\"flex-1 md:text-right md:border-r border-white/20 md:pr-4\">\n                        <span className=\"text-[10px] font-bold text-indigo-300 uppercase tracking-widest block mb-1 flex items-center gap-1 md:justify-end\">\n                            <Landmark size={12}/> Trésorerie Studio\n                        </span>\n                        <div className=\"text-lg font-bold text-white flex items-center md:justify-end gap-2\">\n                            <span className={`font-mono ${agency.budget_real < 0 ? 'text-red-400' : 'text-white'}`}>{agency.budget_real} PiXi</span>\n                        </div>\n                    </div>\n\n                    <div className=\"flex items-center justify-between md:justify-start gap-6 pl-2\">\n                        <div className=\"text-center\">\n                            <span className=\"text-[10px] font-bold text-slate-300 uppercase tracking-widest block mb-1\">Flux Net</span>\n                            <div className={`text-xl font-bold ${netWeekly >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>{netWeekly > 0 ? '+' : ''}{netWeekly.toFixed(0)}</div>\n                        </div>\n                        <div className=\"text-center\">\n                            <div \n                                onClick={() => setShowVERules(true)}\n                                className=\"text-[10px] font-bold text-slate-300 uppercase tracking-widest mb-1 flex items-center gap-1 justify-center cursor-pointer hover:text-white\"\n                            >\n                                VE <HelpCircle size={10}/>\n                            </div>\n                            <div className={`text-3xl font-display font-bold leading-none ${agency.ve_current >= 60 ? 'text-emerald-400' : 'text-amber-400'}`}>{agency.ve_current}</div>\n                        </div>\n                    </div>\n                </div>\n                )}\n            </div>\n        </div>\n\n        {/* VOTING BOOTHS (POPUP AUTOMATIQUE) */}\n        {myMemberProfile && (\n            <>\n                <VotingBooth \n                    agency={agency} \n                    currentUser={myMemberProfile} \n                    onVote={submitMercatoVote} \n                />\n                <ChallengeVotingBooth \n                    agency={agency}\n                    currentUser={myMemberProfile}\n                    onVote={submitChallengeVote}\n                />\n            </>\n        )}\n\n        {/* CONTENT */}\n        <div className=\"flex-1 mb-24 md:mb-8\">\n            {activeTab === 'MARKET' && agency.id !== 'unassigned' && <MarketOverview agency={agency} allAgencies={allAgencies} currentUser={myMemberProfile} />}\n            {activeTab === 'MISSIONS' && agency.id !== 'unassigned' && <MissionsView agency={agency} onUpdateAgency={onUpdateAgency} />}\n            {activeTab === 'TEAM' && agency.id !== 'unassigned' && <TeamView agency={agency} onUpdateAgency={onUpdateAgency} />}\n            {(activeTab === 'RECRUITMENT' || agency.id === 'unassigned') && (\n              <MercatoView \n                agency={agency} \n                allAgencies={allAgencies} \n                onUpdateAgency={onUpdateAgency} \n                onUpdateAgencies={updateAgenciesList} \n              />\n            )}\n            {activeTab === 'RESOURCES' && <WikiView agency={agency} />}\n            {activeTab === 'HELP' && <FAQView />}\n        </div>\n\n        {/* FOOTER NAV */}\n        <div className=\"fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-md border-t border-slate-200 p-2 z-50 md:relative md:bg-transparent md:border-t-0 md:p-0 md:mt-auto safe-area-bottom\">\n             <div className=\"max-w-7xl mx-auto flex md:justify-start gap-2 md:gap-4 overflow-x-auto no-scrollbar snap-x justify-between\">\n                {agency.id !== 'unassigned' && (\n                    <>\n                        <NavButton active={activeTab === 'MARKET'} onClick={() => setActiveTab('MARKET')} icon={<TrendingUp size={20} />} label=\"Tableau de Bord\" theme={theme} />\n                        <NavButton active={activeTab === 'MISSIONS'} onClick={() => setActiveTab('MISSIONS')} icon={<Target size={20} />} label=\"Missions\" theme={theme} />\n                        <NavButton active={activeTab === 'TEAM'} onClick={() => setActiveTab('TEAM')} icon={<Users size={20} />} label=\"Équipe\" theme={theme} />\n                    </>\n                )}\n                <NavButton active={activeTab === 'RESOURCES'} onClick={() => setActiveTab('RESOURCES')} icon={<BookOpen size={20} />} label=\"Wiki\" theme={theme} />\n                <NavButton active={activeTab === 'RECRUITMENT' || agency.id === 'unassigned'} onClick={() => setActiveTab('RECRUITMENT')} icon={<Briefcase size={20} />} label={agency.id === 'unassigned' ? \"Mon Statut\" : \"Recrutement\"} theme={theme} />\n                <NavButton active={activeTab === 'HELP'} onClick={() => setActiveTab('HELP')} icon={<HelpCircle size={20} />} label=\"Aide\" theme={theme} />\n             </div>\n        </div>\n\n        {/* MODALS */}\n        <Modal isOpen={showSettings} onClose={() => setShowSettings(false)} title=\"Identité Visuelle du Studio\">\n            <div className=\"space-y-6\">\n                <div>\n                    <label className=\"block text-sm font-bold text-slate-700 mb-2\">Logo de l'Agence (Carré)</label>\n                    <div className=\"flex items-center gap-4\">\n                        <div className=\"w-20 h-20 rounded-2xl bg-slate-100 border border-slate-200 overflow-hidden flex items-center justify-center shrink-0\">\n                            {agency.logoUrl ? <img src={agency.logoUrl} className=\"w-full h-full object-contain\" /> : <Landmark className=\"text-slate-300\" size={32}/>}\n                        </div>\n                        <label className=\"flex-1 flex flex-col items-center justify-center h-20 border-2 border-slate-300 border-dashed rounded-xl cursor-pointer bg-slate-50 hover:bg-slate-100 transition-colors\">\n                            <div className=\"flex flex-col items-center justify-center\">\n                                <Upload className=\"w-5 h-5 text-slate-400 mb-1\" />\n                                <p className=\"text-[10px] text-slate-500 font-bold uppercase\">Changer le Logo</p>\n                            </div>\n                            <input type=\"file\" className=\"hidden\" accept=\"image/*\" onChange={handleLogoUpload} />\n                        </label>\n                    </div>\n                </div>\n\n                <div>\n                    <label className=\"block text-sm font-bold text-slate-700 mb-2\">Couleur de Marque</label>\n                    <div className=\"flex gap-3\">\n                        {(['indigo', 'emerald', 'rose', 'amber', 'cyan'] as BrandColor[]).map(c => (\n                            <button key={c} onClick={() => handleColorChange(c)} className={`w-10 h-10 rounded-full border-2 ${COLOR_THEMES[c].bg} ${brandColor === c ? 'ring-4 ring-offset-2 ring-slate-200 border-white' : 'border-transparent opacity-60 hover:opacity-100'}`} />\n                        ))}\n                    </div>\n                </div>\n                <div>\n                    <label className=\"block text-sm font-bold text-slate-700 mb-2\">Bannière (Cover)</label>\n                    <label className=\"flex flex-col items-center justify-center w-full h-32 border-2 border-slate-300 border-dashed rounded-xl cursor-pointer bg-slate-50 hover:bg-slate-100 transition-colors\">\n                        <div className=\"flex flex-col items-center justify-center pt-5 pb-6\">\n                            <ImageIcon className=\"w-8 h-8 text-slate-400 mb-2\" />\n                            <p className=\"text-sm text-slate-500\">Cliquez pour changer la bannière</p>\n                        </div>\n                        <input type=\"file\" className=\"hidden\" accept=\"image/*\" onChange={handleBannerUpload} />\n                    </label>\n                </div>\n            </div>\n        </Modal>\n        \n        <Modal isOpen={showVERules} onClose={() => setShowVERules(false)} title=\"Comprendre la VE\">\n            <div className=\"space-y-6\">\n                <div className=\"bg-slate-50 p-4 rounded-2xl border border-slate-100\">\n                    <p className=\"text-sm text-slate-600 leading-relaxed mb-2\">\n                        La <strong>Valeur d'Entreprise (VE)</strong> est votre \"note de groupe\" dynamique (/100). \n                        <br/>Elle fluctue selon vos rendus, vos choix et les événements.\n                        <br/><br/>\n                        <strong>Attention :</strong> Si votre VE tombe à 0, c'est grave, mais la vraie mort est financière : <strong>-5000 PiXi = FAILLITE</strong>.\n                    </p>\n                </div>\n            </div>\n        </Modal>\n\n        {unlockModal && (\n            <Modal isOpen={!!unlockModal} onClose={() => setUnlockModal(null)} title={unlockModal.title}>\n                <div className=\"flex flex-col items-center text-center space-y-6\">\n                    <div className=\"p-6 rounded-full bg-slate-100 mb-2\">\n                        {unlockModal.icon}\n                    </div>\n                    <p className=\"text-slate-600 text-lg leading-relaxed whitespace-pre-line\">\n                        {unlockModal.message}\n                    </p>\n                    <button \n                        onClick={() => setUnlockModal(null)}\n                        className=\"w-full py-4 bg-slate-900 text-white font-bold rounded-xl hover:bg-indigo-600 transition-colors shadow-lg\"\n                    >\n                        {unlockModal.confirmText}\n                    </button>\n                </div>\n            </Modal>\n        )}\n\n        {notificationEvent && (\n            <Modal isOpen={!!notificationEvent} onClose={closeNotification} title={notificationEvent.type === 'CRISIS' ? \"ALERTE PRIORITAIRE\" : \"NOUVELLE IMPORTANTE\"}>\n                <div className=\"flex flex-col items-center text-center space-y-6\">\n                    <div className={`p-6 rounded-full mb-2 border-4 ${\n                        notificationEvent.type === 'CRISIS' || (notificationEvent.deltaVE || 0) < 0\n                        ? 'bg-red-50 border-red-100 text-red-600 animate-pulse'\n                        : 'bg-emerald-50 border-emerald-100 text-emerald-600'\n                    }`}>\n                        {notificationEvent.type === 'CRISIS' || (notificationEvent.deltaVE || 0) < 0\n                            ? <AlertTriangle size={48} strokeWidth={2.5}/>\n                            : (notificationEvent.deltaVE || 0) > 5 ? <PartyPopper size={48} strokeWidth={2.5}/> : <Zap size={48} strokeWidth={2.5}/>\n                        }\n                    </div>\n\n                    <div>\n                        <h3 className={`text-2xl font-black uppercase mb-2 ${\n                            notificationEvent.type === 'CRISIS' || (notificationEvent.deltaVE || 0) < 0 ? 'text-red-600' : 'text-emerald-600'\n                        }`}>\n                            {notificationEvent.label}\n                        </h3>\n                        <p className=\"text-slate-600 text-lg leading-relaxed font-medium\">\n                            {notificationEvent.description}\n                        </p>\n                    </div>\n\n                    <button \n                        onClick={closeNotification}\n                        className={`w-full py-4 text-white font-bold rounded-xl shadow-lg transition-transform active:scale-95 ${\n                            notificationEvent.type === 'CRISIS' || (notificationEvent.deltaVE || 0) < 0\n                            ? 'bg-red-600 hover:bg-red-700 shadow-red-200'\n                            : 'bg-emerald-600 hover:bg-emerald-700 shadow-emerald-200'\n                        }`}\n                    >\n                        {notificationEvent.type === 'CRISIS' ? \"J'AI PRIS CONNAISSANCE\" : \"GÉNIAL !\"}\n                    </button>\n                </div>\n            </Modal>\n        )}\n    </div>\n  );\n};\n\n// --- VOTING BOOTHS & COMPONENTS ---\nconst VotingBooth: React.FC<{agency: Agency, currentUser: Student, onVote: any}> = ({agency, currentUser, onVote}) => {\n    const pendingVote = agency.mercatoRequests.find(req => {\n        if (req.status !== 'PENDING') return false;\n        if (req.votes && req.votes[currentUser.id]) return false;\n        if (req.type === 'FIRE' && req.studentId === currentUser.id) return false;\n        return true;\n    });\n\n    if (!pendingVote) return null;\n    const isHire = pendingVote.type === 'HIRE';\n\n    return (\n        <Modal isOpen={true} onClose={() => {}} title=\"Session de Vote en cours\">\n            <div className=\"space-y-6\">\n                <div className={`p-4 rounded-xl border-l-4 ${isHire ? 'bg-emerald-50 border-emerald-500 text-emerald-800' : 'bg-red-50 border-red-500 text-red-800'}`}>\n                    <h4 className=\"font-bold text-lg mb-1 flex items-center gap-2\">\n                        {isHire ? <Users size={20}/> : <Gavel size={20}/>}\n                        {isHire ? \"Proposition de Recrutement\" : \"Proposition de Départ\"}\n                    </h4>\n                    <p className=\"text-sm\">Votre avis est requis pour valider cette décision d'agence.</p>\n                </div>\n\n                <div className=\"bg-white border border-slate-200 rounded-xl p-4 shadow-sm\">\n                    <p className=\"text-xs font-bold text-slate-400 uppercase tracking-wider mb-1\">Candidat / Cible</p>\n                    <p className=\"text-xl font-bold text-slate-900\">{pendingVote.studentName}</p>\n                    \n                    <div className=\"mt-4\">\n                        <p className=\"text-xs font-bold text-slate-400 uppercase tracking-wider mb-1\">Motivation / Motif</p>\n                        <p className=\"text-sm italic text-slate-600 bg-slate-50 p-3 rounded-lg border border-slate-100\">\n                            \"{pendingVote.motivation || 'Aucun motif fourni.'}\"\n                        </p>\n                    </div>\n                </div>\n\n                <div className=\"grid grid-cols-2 gap-4\">\n                    <button \n                        onClick={() => onVote(agency.id, pendingVote.id, currentUser.id, 'REJECT')}\n                        className=\"py-4 bg-white border-2 border-slate-200 text-slate-600 hover:border-red-200 hover:text-red-600 hover:bg-red-50 font-bold rounded-xl transition-all flex flex-col items-center gap-1\"\n                    >\n                        <X size={24}/>\n                        NON (Refuser)\n                    </button>\n                    <button \n                        onClick={() => onVote(agency.id, pendingVote.id, currentUser.id, 'APPROVE')}\n                        className=\"py-4 bg-slate-900 text-white hover:bg-emerald-600 font-bold rounded-xl transition-all flex flex-col items-center gap-1 shadow-lg\"\n                    >\n                        <Check size={24}/>\n                        OUI (Accepter)\n                    </button>\n                </div>\n            </div>\n        </Modal>\n    );\n};\n\nconst ChallengeVotingBooth: React.FC<{agency: Agency, currentUser: Student, onVote: any}> = ({agency, currentUser, onVote}) => {\n    const pendingChallenge = agency.challenges?.find(c => c.status === 'PENDING_VOTE' && (!c.votes || !c.votes[currentUser.id]));\n    if (!pendingChallenge) return null;\n\n    return (\n        <Modal isOpen={true} onClose={() => {}} title=\"⚠️ DÉFI SPÉCIAL DÉTECTÉ\">\n            <div className=\"space-y-6\">\n                <div className=\"bg-gradient-to-br from-indigo-900 to-slate-900 text-white p-6 rounded-2xl shadow-xl relative overflow-hidden\">\n                    <div className=\"relative z-10\">\n                        <div className=\"flex items-center gap-2 mb-2\">\n                            <Rocket className=\"text-yellow-400 animate-pulse\"/>\n                            <span className=\"text-xs font-bold uppercase tracking-widest text-indigo-300\">Opportunité IA</span>\n                        </div>\n                        <h3 className=\"text-2xl font-black mb-4 leading-tight\">{pendingChallenge.title}</h3>\n                        <p className=\"text-sm text-indigo-100 leading-relaxed bg-white/10 p-4 rounded-xl border border-white/10\">\n                            {pendingChallenge.description}\n                        </p>\n                    </div>\n                </div>\n\n                <div className=\"text-center\">\n                    <p className=\"text-sm text-slate-600 mb-4\">\n                        Si l'équipe accepte ce défi (Majorité &gt; {GAME_RULES.VOTE_THRESHOLD_CHALLENGE * 100}%), une <strong>mission spéciale</strong> sera ajoutée.\n                    </p>\n                    <div className=\"grid grid-cols-2 gap-4\">\n                        <button \n                            onClick={() => onVote(agency.id, pendingChallenge.id, currentUser.id, 'REJECT')}\n                            className=\"py-4 bg-white border-2 border-slate-200 text-slate-500 hover:text-red-500 hover:border-red-200 font-bold rounded-xl transition-all\"\n                        >\n                            Refuser\n                        </button>\n                        <button \n                            onClick={() => onVote(agency.id, pendingChallenge.id, currentUser.id, 'APPROVE')}\n                            className=\"py-4 bg-emerald-600 text-white hover:bg-emerald-500 font-bold rounded-xl transition-all shadow-lg shadow-emerald-200\"\n                        >\n                            Accepter le Défi\n                        </button>\n                    </div>\n                </div>\n            </div>\n        </Modal>\n    );\n};\n\nconst NavButton: React.FC<any> = ({ active, onClick, icon, label, theme }) => (\n    <button onClick={onClick} className={`snap-start flex flex-col md:flex-row items-center md:gap-3 p-2 md:p-4 rounded-xl transition-all min-w-[70px] md:min-w-[150px] justify-center md:justify-start ${active ? `${theme.bg} text-white transform scale-105 shadow-md` : 'hover:bg-slate-50 text-slate-400 hover:text-slate-600'}`}>\n        <div className={`p-1.5 rounded-full ${active ? 'bg-white/20' : ''}`}>{React.cloneElement(icon, { className: active ? 'text-white' : '' })}</div>\n        <span className={`text-[10px] md:text-base font-bold`}>{label}</span>\n    </button>\n);\n"
            }
          ]
        },
        {
          "path": "components/admin/dashboard/DashboardWidgets.tsx",
          "generationType": 1,
          "isDone": true,
          "description": "Ajout de la détection d'activité suspecte (BLACK_OP) dans les widgets admin.",
          "diffs": [
            {
              "target": "",
              "replacement": "\nimport React from 'react';\nimport { Agency, Deliverable, TransactionRequest } from '../../../types';\nimport { UserPlus, Briefcase, UserMinus, Wallet, CheckCircle2, UserCog, ArrowRight, X, Check, Eye, ShieldAlert } from 'lucide-react';\nimport { useGame } from '../../../contexts/GameContext';\nimport { GAME_RULES } from '../../../constants';\n\ninterface DashboardWidgetsProps {\n    pendingUsersCount: number;\n    pendingHires: number;\n    pendingFires: number;\n    pendingTransactions: {agency: Agency, request: TransactionRequest}[];\n    pendingReviews: {agency: Agency, weekId: string, deliverable: Deliverable}[];\n    activeAgencies: Agency[];\n    onNavigate: (view: string) => void;\n    onSetGradingItem: (item: any) => void;\n    onSetAuditAgency: (agency: Agency) => void;\n    readOnly?: boolean;\n}\n\n// --- LOGIQUE DE DETECTION RH (Interne au widget d'affichage) ---\nconst detectAnomalies = (agency: Agency): string[] => {\n    const anomalies: string[] = [];\n    if (agency.peerReviews.length > 2) {\n        const averageScore = agency.peerReviews.reduce((acc, r) => \n            acc + ((r.ratings.attendance + r.ratings.quality + r.ratings.involvement)/3), 0) / agency.peerReviews.length;\n        if (averageScore > 4.8) anomalies.push(\"Notes Suspectes\");\n    }\n    if (agency.budget_real <= GAME_RULES.BANKRUPTCY_THRESHOLD) anomalies.push(\"FAILLITE !!!\");\n    else if (agency.budget_real < 0) anomalies.push(\"Dette (Gel Salaire)\");\n    \n    if (agency.eventLog.length < 2) anomalies.push(\"Inactivité détectée\");\n    return anomalies;\n};\n\nexport const DashboardWidgets: React.FC<DashboardWidgetsProps> = ({ \n    pendingUsersCount, pendingHires, pendingFires, pendingTransactions, pendingReviews, activeAgencies, \n    onNavigate, onSetGradingItem, onSetAuditAgency, readOnly \n}) => {\n    \n    const { handleTransactionRequest } = useGame();\n\n    // Count Suspicious Activity (BLACK_OP events in last 24h across all agencies)\n    const suspicionCount = activeAgencies.reduce((acc, agency) => {\n        return acc + agency.eventLog.filter(e => e.type === 'BLACK_OP').length;\n    }, 0);\n\n    return (\n        <div className=\"xl:col-span-1 space-y-4\">\n            \n            {/* WIDGET: SUSPICIOUS ACTIVITY (NEW) */}\n            {suspicionCount > 0 && (\n                <div className=\"p-4 rounded-2xl border flex items-center justify-between cursor-pointer transition-all bg-red-900 border-red-700 text-white animate-pulse\">\n                    <div className=\"flex items-center gap-3\">\n                        <ShieldAlert size={20} className=\"text-red-300\"/>\n                        <div>\n                            <p className=\"text-xs font-bold uppercase opacity-80 text-red-200\">Activité Suspecte</p>\n                            <p className=\"font-bold text-lg leading-none\">{suspicionCount} incidents détectés</p>\n                        </div>\n                    </div>\n                </div>\n            )}\n\n            {/* WIDGET: PENDING USERS */}\n            <div \n                onClick={() => onNavigate('ACCESS')}\n                className={`p-4 rounded-2xl border flex items-center justify-between cursor-pointer transition-all hover:shadow-md ${\n                pendingUsersCount > 0 ? 'bg-indigo-600 border-indigo-700 text-white ring-4 ring-indigo-200' : 'bg-white border-slate-200 text-slate-500 hover:border-indigo-300'\n            }`}>\n                <div className=\"flex items-center gap-3\">\n                    <UserPlus size={20} className={pendingUsersCount > 0 ? \"text-indigo-200\" : \"text-slate-400\"}/>\n                    <div>\n                        <p className=\"text-xs font-bold uppercase opacity-80\">Salle d'attente</p>\n                        <p className=\"font-bold text-lg leading-none\">{pendingUsersCount} étudiants</p>\n                    </div>\n                </div>\n                {pendingUsersCount > 0 && <div className=\"animate-pulse w-3 h-3 bg-white rounded-full\"></div>}\n            </div>\n\n            {/* WIDGET: PENDING HIRES (EMBAUCHES) */}\n            <div \n                onClick={() => onNavigate('MERCATO')}\n                className={`p-4 rounded-2xl border flex items-center justify-between cursor-pointer transition-all hover:shadow-md ${\n                pendingHires > 0 ? 'bg-emerald-500 border-emerald-600 text-white ring-4 ring-emerald-200' : 'bg-white border-slate-200 text-slate-500 hover:border-emerald-300'\n            }`}>\n                <div className=\"flex items-center gap-3\">\n                    <Briefcase size={20} className={pendingHires > 0 ? \"text-emerald-100\" : \"text-slate-400\"}/>\n                    <div>\n                        <p className=\"text-xs font-bold uppercase opacity-80\">Embauches</p>\n                        <p className=\"font-bold text-lg leading-none\">{pendingHires} demandes</p>\n                    </div>\n                </div>\n                {pendingHires > 0 && <ArrowRight size={18} className=\"opacity-80\"/>}\n            </div>\n\n            {/* WIDGET: PENDING FIRES */}\n            <div \n                onClick={() => onNavigate('MERCATO')}\n                className={`p-4 rounded-2xl border flex items-center justify-between cursor-pointer transition-all hover:shadow-md ${\n                pendingFires > 0 ? 'bg-amber-500 border-amber-600 text-white ring-4 ring-amber-200' : 'bg-white border-slate-200 text-slate-500 hover:border-amber-300'\n            }`}>\n                <div className=\"flex items-center gap-3\">\n                    <UserMinus size={20} className={pendingFires > 0 ? \"text-amber-100\" : \"text-slate-400\"}/>\n                    <div>\n                        <p className=\"text-xs font-bold uppercase opacity-80\">Licenciements</p>\n                        <p className=\"font-bold text-lg leading-none\">{pendingFires} demandes</p>\n                    </div>\n                </div>\n                <ArrowRight size={18} className=\"opacity-50\"/>\n            </div>\n\n            {/* WIDGET: PENDING TRANSACTIONS (BUY SCORE) */}\n            {pendingTransactions.length > 0 && (\n                <div className=\"bg-white border border-amber-200 rounded-3xl p-5 shadow-sm\">\n                    <h3 className=\"text-base font-bold text-amber-800 mb-4 flex items-center gap-2\">\n                        <Wallet size={18} /> Achats Points ({pendingTransactions.length})\n                    </h3>\n                    <div className=\"space-y-2\">\n                        {pendingTransactions.map(({agency, request}) => (\n                            <div key={request.id} className=\"p-3 bg-amber-50 border border-amber-100 rounded-xl flex justify-between items-center\">\n                                <div>\n                                    <p className=\"text-xs font-bold text-slate-800\">{request.studentName}</p>\n                                    <p className=\"text-[10px] text-slate-500\">\n                                        +{request.amountScore} pts contre {request.amountPixi} PiXi\n                                    </p>\n                                </div>\n                                <div className=\"flex gap-1\">\n                                    <button onClick={() => handleTransactionRequest(agency, request, false)} className=\"p-1 bg-white hover:bg-red-100 text-red-500 rounded border border-red-100\"><X size={14}/></button>\n                                    <button onClick={() => handleTransactionRequest(agency, request, true)} className=\"p-1 bg-white hover:bg-emerald-100 text-emerald-500 rounded border border-emerald-100\"><Check size={14}/></button>\n                                </div>\n                            </div>\n                        ))}\n                    </div>\n                </div>\n            )}\n\n            {/* 1. Pending Reviews */}\n            <div className=\"bg-white border border-slate-200 rounded-3xl p-5 shadow-sm\">\n                <h3 className=\"text-base font-bold text-slate-900 mb-4 flex items-center gap-2\">\n                    <CheckCircle2 size={18} className=\"text-emerald-500\" />\n                    À Corriger ({pendingReviews.length})\n                </h3>\n                <div className=\"space-y-2 max-h-[250px] overflow-y-auto custom-scrollbar pr-1\">\n                    {pendingReviews.length === 0 ? (\n                         <div className=\"text-center py-6 text-slate-400 text-xs italic border-2 border-dashed border-slate-100 rounded-xl\">\n                            Tout est à jour.\n                        </div>\n                    ) : (\n                        pendingReviews.map((item) => (\n                            <div \n                                key={`${item.agency.id}-${item.deliverable.id}`}\n                                onClick={() => !readOnly && onSetGradingItem({agencyId: item.agency.id, weekId: item.weekId, deliverable: item.deliverable})}\n                                className={`p-3 bg-white border rounded-xl transition-all shadow-sm ${readOnly ? 'cursor-default opacity-70 border-slate-100' : 'cursor-pointer hover:bg-indigo-50 border-indigo-100 hover:border-indigo-300 group'}`}\n                            >\n                                <div className=\"flex justify-between mb-1\">\n                                    <span className=\"font-bold text-slate-700 text-xs\">{item.agency.name}</span>\n                                    <span className=\"text-[9px] font-bold bg-slate-100 px-1.5 py-0.5 rounded text-slate-500\">SEM {item.weekId}</span>\n                                </div>\n                                <p className=\"text-xs text-indigo-900 font-medium truncate\">{item.deliverable.name}</p>\n                            </div>\n                        ))\n                    )}\n                </div>\n            </div>\n\n            {/* 2. HR Audits */}\n            <div className=\"bg-white border border-slate-200 rounded-3xl p-5 shadow-sm\">\n                <h3 className=\"text-base font-bold text-slate-900 mb-4 flex items-center gap-2\">\n                    <UserCog size={18} className=\"text-purple-500\" />\n                    Audits RH Requis\n                </h3>\n                <div className=\"space-y-2\">\n                     {activeAgencies.filter(a => detectAnomalies(a).length > 0).length === 0 && (\n                          <div className=\"text-center py-6 text-slate-400 text-xs italic border-2 border-dashed border-slate-100 rounded-xl\">\n                            R.A.S\n                        </div>\n                     )}\n                     {activeAgencies.filter(a => detectAnomalies(a).length > 0).map(agency => (\n                         <div key={agency.id} className=\"flex justify-between items-center p-3 bg-red-50 border border-red-100 rounded-xl\">\n                             <div>\n                                 <div className=\"font-bold text-slate-800 text-xs\">{agency.name}</div>\n                                 <div className=\"text-[10px] text-red-600 font-bold\">{detectAnomalies(agency)[0]}</div>\n                             </div>\n                             <button onClick={() => onSetAuditAgency(agency)} className=\"p-1.5 bg-white text-red-500 rounded-lg hover:bg-red-100 border border-red-100\">\n                                 <Eye size={14}/>\n                             </button>\n                         </div>\n                     ))}\n                </div>\n            </div>\n        </div>\n    );\n};\n"
            }
          ]
        }
      ]
    },
    "createdTimestamp": {
      "seconds": 1768532284,
      "nanos": 711000000
    },
    "doneTimestamp": {
      "seconds": 1768532299,
      "nanos": 857000000
    }
  },
  {
    "id": 140,
    "author": "model",
    "payload": {
      "type": "fixingErrors",
      "diagnostics": [
        {
          "LIa": "components/student/TheBackdoor.tsx",
          "message": "Property 'performBlackOp' does not exist on type 'GameContextType'.",
          "line": 22,
          "column": 13
        },
        {
          "LIa": "components/student/TheBackdoor.tsx",
          "message": "Cannot find name 'TrendingUp'.",
          "line": 136,
          "column": 88
        }
      ]
    },
    "createdTimestamp": {
      "seconds": 1768532470,
      "nanos": 890000000
    },
    "doneTimestamp": {
      "seconds": 1768532516,
      "nanos": 943000000
    }
  },
  {
    "id": 141,
    "author": "model",
    "payload": {
      "type": "thinking",
      "text": "**Addressing Missing Functionality**\n\nI'm currently focused on the `TheBackdoor.tsx` component, specifically two errors. The first involves a missing `performBlackOp` function. It looks like I need to revisit `GameContext.tsx` to ensure that function is correctly defined and exported. I'll need to double check how the context is being used there.\n\n\n**Defining Missing Functionality**\n\nI've pinpointed the issue with `performBlackOp`; it's absent from the `GameContextType` interface and provider. I need to add it to the interface in `GameContext.tsx` and ensure it's passed through the provider value, as `useGameMechanics.ts` exports it. Additionally, I've identified a missing import causing the \"Cannot find name 'TrendingUp'\" error.\n\n\n**Refining Import Statements**\n\nI'm now zeroing in on the import issues. The \"Cannot find name 'TrendingUp'\" error is simple; I just need to add `TrendingUp` to the import statement in `TheBackdoor.tsx`. I'll also double check the import is in the right place. Additionally, I need to ensure that the signature of `performBlackOp`, confirmed in `useGameMechanics.ts`, aligns with the new additions to the `GameContextType` interface and the provider in `GameContext.tsx`.\n\n\n**Verifying Function Signature Alignment**\n\nI've verified that the `performBlackOp` function signature in `GameContext.tsx`, which relies on `useGameMechanics.ts`, is correctly aligned. The signature, now fully implemented, accepts `studentId`, `agencyId`, `opType`, and `payload` and returns a `Promise<void>`. I'm checking that all usages are correct. The final import and implementation are correct, so let's prepare the final files and review the logic for the last time.\n\n\n**Reviewing Context Imports**\n\nI'm now carefully examining the imports within `GameContext.tsx`. I've added `{ useAuth }` from `./AuthContext`, and included `doc`, `updateDoc`, `writeBatch`, `setDoc`, `deleteDoc`, and `db` from `../services/firebase`. Sub-hooks, namely `useGameSync`, `useFinanceLogic`, and `useGameMechanics`, have also been successfully imported from the game-specific modules. This groundwork will support the subsequent game logic implementations.\n\n\n**Expanding Game Mechanics**\n\nI'm now integrating crucial game mechanics to enhance the gameplay. I've defined several functions within the game context, including those for shuffling constraints, processing finances and performance, and resetting the game state. Student economy and resource handling are being addressed with functions for transferring funds, trading scores for cash, injecting capital, requesting score purchases, handling transaction requests, and submitting mercato votes. Additionally, I'm integrating black ops, mergers, and challenges with the implementation of `triggerBlackOp`, and `performBlackOp` with its parameter configuration.\n\n\n**Defining Merger Logic**\n\nI'm now focusing on integrating the proposed merger logic. I've defined `proposeMerger`, `finalizeMerger` functions, designed to manage mergers between agencies. I also added functions for handling game challenges, namely `sendChallenge` and `submitChallengeVote`. These functions are incorporated within the game context and support the overall game mechanics, which are essential for driving player interaction and strategic decisions within the simulation.\n\n\n**Refining Auto-Mode Integration**\n\nI'm now focusing on integrating the auto-mode functionality. I've initialized an `isAutoMode` state variable, essential for managing the automatic game progression, and I am incorporating a `checkSchedule` function within the `useEffect` hook to regularly check and update the game state, if `isAutoMode` is true. This will facilitate automated gameplay and require time-based checks. I also added code for managing roles with the `useEffect` hook to sync the role with the auth service.\n\n\n**Finalizing Data Updates**\n\nI'm currently finalizing the update for agencies. I have successfully implemented the `updateAgenciesList` function, which now uses `writeBatch` for efficient updates. It updates agencies in Firestore and incorporates error handling with a toast message. I'm also implementing the `deleteAgency` function with batch writes and considering the edge case of member assignment. I am planning on adding agency cleanup, and updating the agencies list.\n\n\n**Refining Agency Management**\n\nI'm now implementing the `deleteAgency` function. I've integrated batch writes to handle member transfers to the unassigned agency and agency deletion in Firestore, including comprehensive error handling with toast messages. I am also working on adding the `updateWeek` function to ensure weeks can be updated in Firestore with proper feedback to the user. I'm also planning to incorporate functionality to add and delete resources to support the wiki.\n\n\n**Defining Additional Functionality**\n\nI'm currently focused on defining additional functions within the game context to manage new features. I've added `deleteResource`, `selectAgency`, `toggleAutoMode`, and `resetGame` functions, while integrating the `tradeScoreForCash` functionality. These functions enhance the player experience by providing resource management, agency selection, auto-mode control, and game reset options.\n\n\n**Defining Context Functions**\n\nI'm now integrating the recently added functions into `GameContext.tsx`. I've included `handleTransactionRequest`, `submitMercatoVote`, `triggerBlackOp`, and related merger and challenge functions. I'm also preparing for the incorporation of the `getCurrentGameWeek` functionality into the context, further solidifying the core game mechanics.\n\n\n**Finalizing Backdoor Implementation**\n\nI'm now implementing the `TheBackdoor` component. I'm focusing on integrating the `performBlackOp` function, ensuring it correctly handles inputs like `agency`, `allAgencies`, `currentUser`, and `onClose`. I also am also incorporating pseudo-random user obfuscation using the `generateAlias` function. I'm focusing on state management, particularly for `terminalOutput`, `selectedItem`, and `targetId`. I am preparing to integrate the filtering of rival agencies.\n\n\n**Finalizing Black Ops Logic**\n\nI'm now incorporating logic for the `handleBuy` function, specifically for black ops within the `TheBackdoor` component. I'm focusing on handling different item purchases: short selling and doxxing. I'm carefully constructing the `opType` and `payload` based on the selected item, including error checking, and cost management. I also added a check for late deliverables for the `FAKE_CERT` black op, which will require target selection.\n\n\n**Validating Op Execution**\n\nI'm now carefully examining the `handleBuy` function's logic. I've integrated checks for black ops, validating target selection and adequate funds, which covers edge cases in `TheBackdoor`. I've implemented error messages and defined `opType` and `payload` based on the chosen item, including FAKE_CERT, BUY_VOTE and AUDIT_HOSTILE black ops. I'm verifying the execution flow, including the update of the terminal output.\n\n\n**Integrating Doxxing Feedback**\n\nI'm now integrating the UI feedback for the \"DOXXING\" black op within `TheBackdoor`. I've implemented logic to analyze peer reviews, identifying negative ratings. The results, either a list of low-rated reviews or a message indicating no issues, are displayed in the terminal output, providing clear feedback to the user regarding the outcome of their actions. I'm also ensuring the trace is correctly displayed.\n\n\n**Reviewing Item Display**\n\nI'm currently reviewing the item display within `TheBackdoor`. I've added the header with the connection cryptée alias, and close button. I'm focusing on the component's layout, ensuring it correctly renders the items, including the pseudo-random alias. I am also working on adding a rotation timer for the offer.\n\n\n**Enhancing Item Display**\n\nI'm working on the item display in `TheBackdoor`. I've added the short sell feature, focusing on user interaction and integrating the selector to choose the agency for short selling, ensuring seamless integration with the component's existing layout and functionality. I also fixed the error with the icon's import statement.\n\n\n**Refining Item Selection**\n\nI'm now refining item selection within the backdoor. I added functionality that allows the user to select the targeted agency for short selling using a dropdown menu populated with rival agencies. This is now fully integrated into the existing UI. I'm focusing on user interactions and state management to guarantee a cohesive experience.\n\n\n**Validating UI Feedback**\n\nI'm verifying that the \"DOXXING\" black op's feedback, showing low peer reviews within the `TheBackdoor` UI, functions as expected. I'm focusing on ensuring data is displayed correctly in the terminal. I'm also ensuring the correct flow to enhance the user experience.\n\n\n**Validating Item Display**\n\nI'm presently focusing on the item display in `TheBackdoor`. I've completed the integration of the \"short sell\" feature and integrated it seamlessly into the UI. I also integrated the \"FAKE_CERT\" black op. I'm focusing on ensuring its functionality is as intended.\n\n\n**Validating Black Op Inputs**\n\nI'm now carefully examining the input validation for black ops, particularly within the `handleBuy` function, where I am focusing on the \"BUY_VOTE\" operation. I'm making sure `targetId` is set correctly before operation execution.\n\n\n**Confirming Op Data Integrity**\n\nI'm now making sure all inputs for black ops are valid. I've concentrated on validating `BUY_VOTE`, ensuring `targetId` is correctly set before it runs. I am confident in the process.\n\n\n**Enhancing UI Feedback**\n\nI'm presently focused on the `TheBackdoor` component, specifically on refining the user interface to enhance feedback after black op executions. I'm verifying the display of terminal output, ensuring the results of actions like \"DOXXING\" are clearly presented to the user.\n\n\n**Refining Feedback Display**\n\nI'm now honing the display of UI feedback within `TheBackdoor`. I've added error handling to ensure clarity if `targetId` is missing for \"BUY_VOTE\" black ops. Furthermore, I've incorporated clear terminal output for black ops like \"DOXXING\", providing actionable feedback to users.\n\n\n**Validating Final Component**\n\nI'm now carefully reviewing `TheBackdoor` component for final validation. I've ensured seamless integration of all black op functionalities, with proper input validation and clear feedback. The UI now fully supports all black ops. I'm satisfied.\n\n\n",
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1768532477,
      "nanos": 421000000
    },
    "doneTimestamp": {
      "seconds": 1768532516,
      "nanos": 943000000
    }
  },
  {
    "id": 142,
    "author": "model",
    "payload": {
      "type": "generationTable",
      "entries": [
        {
          "path": "contexts/GameContext.tsx",
          "generationType": 2,
          "isDone": true,
          "description": "Add performBlackOp to GameContextType and Provider",
          "diffs": [
            {
              "target": "",
              "replacement": "import React, { createContext, useContext, useState, ReactNode, useEffect } from 'react';\nimport { Agency, WeekModule, WikiResource, TransactionRequest, MercatoRequest, MergerRequest, ChallengeRequest, Deliverable } from '../types';\nimport { useUI } from './UIContext';\nimport { useAuth } from './AuthContext';\nimport { doc, updateDoc, writeBatch, setDoc, deleteDoc, db } from '../services/firebase';\n\n// IMPORT SUB-HOOKS\nimport { useGameSync } from './game/useGameSync';\nimport { useFinanceLogic } from './game/useFinanceLogic';\nimport { useGameMechanics } from './game/useGameMechanics';\n\ninterface GameContextType {\n  // State\n  agencies: Agency[];\n  weeks: { [key: string]: WeekModule };\n  resources: WikiResource[];\n  role: 'admin' | 'student';\n  selectedAgencyId: string | null;\n  isAutoMode: boolean;\n  \n  // Actions\n  setRole: (role: 'admin' | 'student') => void;\n  selectAgency: (id: string | null) => void;\n  toggleAutoMode: () => void;\n  updateAgency: (agency: Agency) => void;\n  updateAgenciesList: (agencies: Agency[]) => void;\n  deleteAgency: (agencyId: string) => Promise<void>;\n  updateWeek: (weekId: string, week: WeekModule) => void;\n  \n  // Wiki Actions\n  addResource: (resource: WikiResource) => Promise<void>;\n  deleteResource: (id: string) => Promise<void>;\n\n  // Game Logic\n  shuffleConstraints: (agencyId: string) => void;\n  processFinance: (targetClass: 'A' | 'B') => Promise<void>;\n  processPerformance: (targetClass: 'A' | 'B') => Promise<void>;\n  resetGame: () => void;\n  \n  // Student Economy & RH\n  transferFunds: (sourceId: string, targetId: string, amount: number) => Promise<void>;\n  tradeScoreForCash: (studentId: string, scoreAmount: number) => Promise<void>;\n  injectCapital: (studentId: string, agencyId: string, amount: number) => Promise<void>;\n  requestScorePurchase: (studentId: string, agencyId: string, amountPixi: number, amountScore: number) => Promise<void>;\n  handleTransactionRequest: (agency: Agency, request: TransactionRequest, approved: boolean) => Promise<void>;\n  submitMercatoVote: (agencyId: string, requestId: string, voterId: string, vote: 'APPROVE' | 'REJECT') => Promise<void>;\n\n  // Black Ops & Mergers & Challenges\n  triggerBlackOp: (sourceAgencyId: string, targetAgencyId: string, type: 'AUDIT' | 'LEAK') => Promise<void>;\n  performBlackOp: (studentId: string, agencyId: string, opType: 'SHORT_SELL' | 'DOXXING' | 'FAKE_CERT' | 'BUY_VOTE' | 'AUDIT_HOSTILE', payload: any) => Promise<void>;\n  proposeMerger: (sourceAgencyId: string, targetAgencyId: string) => Promise<void>;\n  finalizeMerger: (mergerId: string, targetAgencyId: string, approved: boolean) => Promise<void>;\n  \n  sendChallenge: (targetAgencyId: string, title: string, description: string) => Promise<void>;\n  submitChallengeVote: (agencyId: string, challengeId: string, voterId: string, vote: 'APPROVE' | 'REJECT') => Promise<void>;\n\n  getCurrentGameWeek: () => number;\n}\n\nconst GameContext = createContext<GameContextType | undefined>(undefined);\n\nexport const useGame = () => {\n  const context = useContext(GameContext);\n  if (!context) throw new Error('useGame must be used within a GameProvider');\n  return context;\n};\n\nexport const GameProvider: React.FC<{ children: ReactNode }> = ({ children }) => {\n  const { toast } = useUI();\n  const { userData } = useAuth();\n  \n  // MAIN STATE\n  const [role, setRole] = useState<'admin' | 'student'>('student');\n  const [selectedAgencyId, setSelectedAgencyId] = useState<string | null>(null);\n  const [isAutoMode, setIsAutoMode] = useState(false);\n\n  // 1. SYNC HOOK (Data Layer)\n  const { agencies, weeks, resources, seedDatabase, setAgencies } = useGameSync(toast);\n\n  // HELPER\n  const getCurrentGameWeek = () => {\n      const unlockedWeeks = (Object.values(weeks) as WeekModule[]).filter(w => !w.locked).map(w => parseInt(w.id));\n      return unlockedWeeks.length > 0 ? Math.max(...unlockedWeeks) : 1;\n  };\n\n  // 2. LOGIC HOOKS\n  const finance = useFinanceLogic(agencies, toast);\n  const mechanics = useGameMechanics(agencies, toast, getCurrentGameWeek);\n\n  // Sync Role with Auth\n  useEffect(() => {\n    if (userData) {\n      if (userData.role === 'admin') setRole('admin');\n      else setRole('student');\n    }\n  }, [userData]);\n\n  // AUTO MODE SCHEDULER\n  useEffect(() => {\n      if (!isAutoMode) return;\n      const checkSchedule = () => {\n          const now = new Date();\n          const today = now.toISOString().split('T')[0];\n          console.log(`Auto Check: ${today}`);\n      };\n      const interval = setInterval(checkSchedule, 60000); \n      return () => clearInterval(interval);\n  }, [isAutoMode, weeks]);\n\n  // --- GENERIC ACTIONS (CRUD) ---\n  \n  const updateAgenciesList = async (newAgencies: Agency[]) => {\n      try {\n        const batch = writeBatch(db);\n        newAgencies.forEach(a => {\n            const ref = doc(db, \"agencies\", a.id);\n            batch.set(ref, a, { merge: true });\n        });\n        await batch.commit();\n      } catch(e) {\n         console.error(e);\n         toast('error', 'Erreur mise à jour multiple');\n      }\n  };\n\n  const deleteAgency = async (agencyId: string) => {\n      try {\n          const agencyToDelete = agencies.find(a => a.id === agencyId);\n          if (!agencyToDelete) return;\n\n          const batch = writeBatch(db);\n\n          if (agencyToDelete.members && agencyToDelete.members.length > 0) {\n              const unassignedRef = doc(db, \"agencies\", \"unassigned\");\n              const unassignedAgency = agencies.find(a => a.id === 'unassigned');\n              if (unassignedAgency) {\n                  const updatedMembers = [...(unassignedAgency.members || []), ...agencyToDelete.members];\n                  batch.update(unassignedRef, { members: updatedMembers });\n              }\n          }\n\n          const agencyRef = doc(db, \"agencies\", agencyId);\n          batch.delete(agencyRef);\n\n          await batch.commit();\n          toast('success', `Agence supprimée. Membres transférés au vivier.`);\n      } catch (e) {\n          console.error(e);\n          toast('error', \"Erreur lors de la suppression\");\n      }\n  };\n\n  const updateWeek = async (weekId: string, updatedWeek: WeekModule) => {\n    try {\n        const weekRef = doc(db, \"weeks\", weekId);\n        await updateDoc(weekRef, { ...updatedWeek });\n        toast('success', `Semaine ${weekId} mise à jour`);\n    } catch (e) {\n        console.error(e);\n        toast('error', 'Erreur maj semaine');\n    }\n  };\n\n  const addResource = async (resource: WikiResource) => {\n      await setDoc(doc(db, \"resources\", resource.id), resource);\n      toast('success', \"Ressource ajoutée\");\n  };\n\n  const deleteResource = async (id: string) => {\n      await deleteDoc(doc(db, \"resources\", id));\n      toast('success', \"Ressource supprimée\");\n  };\n\n  const selectAgency = (id: string | null) => setSelectedAgencyId(id);\n  const toggleAutoMode = () => setIsAutoMode(!isAutoMode);\n\n  const resetGame = async () => {\n      try { await seedDatabase(); } catch (e) { console.error(e); }\n  };\n\n  const tradeScoreForCash = async (studentId: string, scoreAmount: number) => { /* Impl future */ };\n\n  return (\n    <GameContext.Provider value={{\n      agencies, weeks, resources, role, selectedAgencyId, isAutoMode,\n      setRole, selectAgency, toggleAutoMode, updateAgency: mechanics.updateAgency, updateAgenciesList, deleteAgency, updateWeek,\n      addResource, deleteResource, shuffleConstraints: mechanics.shuffleConstraints, \n      processFinance: finance.processFinance, \n      processPerformance: mechanics.processPerformance, \n      resetGame,\n      transferFunds: finance.transferFunds, \n      tradeScoreForCash, \n      injectCapital: finance.injectCapital, \n      requestScorePurchase: finance.requestScorePurchase, \n      handleTransactionRequest: finance.handleTransactionRequest,\n      submitMercatoVote: mechanics.submitMercatoVote, \n      triggerBlackOp: mechanics.triggerBlackOp,\n      performBlackOp: mechanics.performBlackOp, \n      proposeMerger: mechanics.proposeMerger, \n      finalizeMerger: mechanics.finalizeMerger, \n      getCurrentGameWeek,\n      sendChallenge: mechanics.sendChallenge, \n      submitChallengeVote: mechanics.submitChallengeVote\n    }}>\n      {children}\n    </GameContext.Provider>\n  );\n};"
            }
          ]
        },
        {
          "path": "components/student/TheBackdoor.tsx",
          "generationType": 2,
          "isDone": true,
          "description": "Import TrendingUp",
          "diffs": [
            {
              "target": "",
              "replacement": "\nimport React, { useState, useEffect } from 'react';\nimport { Agency, Student, Deliverable } from '../../types';\nimport { useGame } from '../../contexts/GameContext';\nimport { useUI } from '../../contexts/UIContext';\nimport { Terminal, ShieldAlert, Eye, Vote, Lock, FileX, Skull, TrendingUp } from 'lucide-react';\n\ninterface TheBackdoorProps {\n    agency: Agency;\n    allAgencies: Agency[];\n    currentUser: Student;\n    onClose: () => void;\n}\n\n// Pseudo-random user obfuscation\nconst generateAlias = (name: string) => {\n    const hash = name.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);\n    return `User-${hash.toString(16).toUpperCase().slice(0,4)}`;\n};\n\nexport const TheBackdoor: React.FC<TheBackdoorProps> = ({ agency, allAgencies, currentUser, onClose }) => {\n    const { performBlackOp } = useGame();\n    const { confirm, toast } = useUI();\n    const [terminalOutput, setTerminalOutput] = useState<string[]>([\"Initialisation protocole 22-04...\", \"Connexion sécurisée établie.\"]);\n    const [selectedItem, setSelectedItem] = useState<string | null>(null);\n    const [targetId, setTargetId] = useState<string>(\"\");\n    const [doxxResult, setDoxxResult] = useState<string | null>(null);\n\n    // Filter Targets\n    const rivalAgencies = allAgencies.filter(a => a.id !== 'unassigned' && a.id !== agency.id);\n    \n    const addToTerminal = (text: string) => {\n        setTerminalOutput(prev => [...prev, `> ${text}`]);\n    };\n\n    const handleBuy = async () => {\n        if (!selectedItem) return;\n\n        let opType: any = '';\n        let payload: any = {};\n        let cost = 0;\n\n        if (selectedItem === 'SHORT_SELL') {\n            if (!targetId) { addToTerminal(\"ERREUR: Cible manquante.\"); return; }\n            opType = 'SHORT_SELL';\n            payload = { targetId };\n            cost = 500;\n        } \n        else if (selectedItem === 'DOXXING') {\n            opType = 'DOXXING';\n            payload = {}; // Self agency check\n            cost = 600;\n        }\n        else if (selectedItem === 'FAKE_CERT') {\n            // Find a late deliverable\n            let lateDeliv: {weekId: string, delId: string} | null = null;\n            Object.values(agency.progress).forEach(w => {\n                w.deliverables.forEach(d => {\n                    if (d.grading && d.grading.daysLate > 0) lateDeliv = { weekId: w.id, delId: d.id };\n                });\n            });\n            \n            if (!lateDeliv) {\n                addToTerminal(\"ERREUR: Aucun retard détecté à effacer.\");\n                return;\n            }\n            opType = 'FAKE_CERT';\n            payload = { weekId: lateDeliv.weekId, deliverableId: lateDeliv.delId };\n            cost = 500;\n        }\n        else if (selectedItem === 'BUY_VOTE') {\n            if (!targetId) { addToTerminal(\"ERREUR: Requête cible manquante.\"); return; }\n            opType = 'BUY_VOTE';\n            payload = { requestId: targetId };\n            cost = 200;\n        }\n        else if (selectedItem === 'AUDIT_HOSTILE') {\n            if (!targetId) { addToTerminal(\"ERREUR: Cible manquante.\"); return; }\n            opType = 'AUDIT_HOSTILE';\n            payload = { targetId };\n            cost = 500;\n        }\n\n        if ((currentUser.wallet || 0) < cost) {\n            addToTerminal(\"ERREUR: Fonds insuffisants (PiXi).\");\n            return;\n        }\n\n        // EXECUTE\n        addToTerminal(`Exécution ${opType}...`);\n        await performBlackOp(currentUser.id, agency.id, opType, payload);\n        addToTerminal(\"Transaction terminée. Trace effacée (partiellement).\");\n\n        // UI FEEDBACK SPECIFIC\n        if (opType === 'DOXXING') {\n            const badReviews = agency.peerReviews.filter(r => \n                ((r.ratings.attendance + r.ratings.quality + r.ratings.involvement)/3) < 3\n            );\n            if (badReviews.length > 0) {\n                const reveal = badReviews.map(r => `${r.reviewerName} a noté ${r.targetName} (Moy: ${((r.ratings.attendance+r.ratings.quality+r.ratings.involvement)/3).toFixed(1)})`).join('\\n');\n                setDoxxResult(reveal);\n                addToTerminal(\"RÉSULTAT DOXXING OBTENU.\");\n            } else {\n                setDoxxResult(\"Aucune mauvaise note (< 3/5) détectée cette semaine.\");\n                addToTerminal(\"Rien à signaler.\");\n            }\n        }\n    };\n\n    return (\n        <div className=\"fixed inset-0 z-[100] bg-black text-[#00ff41] font-mono p-4 md:p-8 flex flex-col overflow-hidden animate-in fade-in duration-300\">\n            {/* HEADER */}\n            <div className=\"flex justify-between items-center border-b border-[#00ff41] pb-4 mb-4\">\n                <div>\n                    <h1 className=\"text-2xl md:text-4xl font-bold tracking-widest uppercase glitch-text\">THE BACKDOOR // 22-04</h1>\n                    <p className=\"text-xs opacity-70\">Connexion cryptée : {generateAlias(currentUser.name)}</p>\n                </div>\n                <button onClick={onClose} className=\"text-red-500 hover:text-red-400 border border-red-500 px-4 py-2 rounded uppercase text-xs font-bold hover:bg-red-900/20 transition-colors\">\n                    Fermer la connexion\n                </button>\n            </div>\n\n            <div className=\"flex-1 grid grid-cols-1 md:grid-cols-3 gap-8 overflow-hidden\">\n                \n                {/* LEFT: MARKET ITEMS */}\n                <div className=\"md:col-span-2 overflow-y-auto custom-scrollbar border-r border-[#00ff41]/30 pr-4 space-y-6\">\n                    \n                    <div className=\"mb-2 text-xs uppercase opacity-50\">--- ROTATION OFFRES (72H) ---</div>\n\n                    {/* ITEM 1: SHORT SELL */}\n                    <div \n                        onClick={() => { setSelectedItem('SHORT_SELL'); setTargetId(\"\"); }}\n                        className={`p-4 border border-[#00ff41]/50 cursor-pointer hover:bg-[#00ff41]/10 transition-all ${selectedItem === 'SHORT_SELL' ? 'bg-[#00ff41]/20 border-[#00ff41]' : ''}`}\n                    >\n                        <div className=\"flex justify-between items-start mb-2\">\n                            <h3 className=\"font-bold text-lg flex items-center gap-2\"><TrendingUp size={20} className=\"rotate-180\"/> Short Selling</h3>\n                            <span className=\"font-bold\">500 PiXi</span>\n                        </div>\n                        <p className=\"text-sm opacity-80 mb-2\">Parier sur la chute d'une agence. Si elle perd de la VE au prochain bilan, vous gagnez 1000 PiXi.</p>\n                        {selectedItem === 'SHORT_SELL' && (\n                            <select \n                                className=\"w-full bg-black border border-[#00ff41] p-2 text-sm mt-2 focus:outline-none\"\n                                onChange={(e) => setTargetId(e.target.value)}\n                            >\n                                <option value=\"\">-- CIBLE À SHORTER --</option>\n                                {rivalAgencies.map(a => <option key={a.id} value={a.id}>{a.name} (VE: {a.ve_current})</option>)}\n                            </select>\n                        )}\n                    </div>\n\n                    {/* ITEM 2: DOXXING RH */}\n                    <div \n                        onClick={() => { setSelectedItem('DOXXING'); setTargetId(\"\"); }}\n                        className={`p-4 border border-[#00ff41]/50 cursor-pointer hover:bg-[#00ff41]/10 transition-all ${selectedItem === 'DOXXING' ? 'bg-[#00ff41]/20 border-[#00ff41]' : ''}`}\n                    >\n                        <div className=\"flex justify-between items-start mb-2\">\n                            <h3 className=\"font-bold text-lg flex items-center gap-2\"><Eye size={20}/> Doxxing RH</h3>\n                            <span className=\"font-bold\">600 PiXi</span>\n                        </div>\n                        <p className=\"text-sm opacity-80\">Révèle l'identité des auteurs de mauvaises notes (< 3/5) dans votre agence cette semaine.</p>\n                        {doxxResult && selectedItem === 'DOXXING' && (\n                            <div className=\"mt-2 p-2 border border-red-500 text-red-500 text-xs whitespace-pre-line bg-red-900/10\">\n                                {doxxResult}\n                            </div>\n                        )}\n                    </div>\n\n                    {/* ITEM 3: FAUX CERTIFICAT */}\n                    <div \n                        onClick={() => { setSelectedItem('FAKE_CERT'); setTargetId(\"\"); }}\n                        className={`p-4 border border-[#00ff41]/50 cursor-pointer hover:bg-[#00ff41]/10 transition-all ${selectedItem === 'FAKE_CERT' ? 'bg-[#00ff41]/20 border-[#00ff41]' : ''}`}\n                    >\n                        <div className=\"flex justify-between items-start mb-2\">\n                            <h3 className=\"font-bold text-lg flex items-center gap-2\"><FileX size={20}/> Faux Certificat</h3>\n                            <span className=\"font-bold\">500 PiXi</span>\n                        </div>\n                        <p className=\"text-sm opacity-80\">Efface rétroactivement un retard noté sur un livrable. Risque de détection: 20%.</p>\n                    </div>\n\n                    {/* ITEM 4: ACHAT DE VOTE */}\n                    <div \n                        onClick={() => { setSelectedItem('BUY_VOTE'); setTargetId(\"\"); }}\n                        className={`p-4 border border-[#00ff41]/50 cursor-pointer hover:bg-[#00ff41]/10 transition-all ${selectedItem === 'BUY_VOTE' ? 'bg-[#00ff41]/20 border-[#00ff41]' : ''}`}\n                    >\n                        <div className=\"flex justify-between items-start mb-2\">\n                            <h3 className=\"font-bold text-lg flex items-center gap-2\"><Vote size={20}/> Bourrage d'Urne</h3>\n                            <span className=\"font-bold\">200 PiXi</span>\n                        </div>\n                        <p className=\"text-sm opacity-80\">Ajoute un vote \"APPROVE\" fantôme sur une demande Mercato active.</p>\n                        {selectedItem === 'BUY_VOTE' && (\n                            <select \n                                className=\"w-full bg-black border border-[#00ff41] p-2 text-sm mt-2 focus:outline-none\"\n                                onChange={(e) => setTargetId(e.target.value)}\n                            >\n                                <option value=\"\">-- SÉLECTIONNER VOTE --</option>\n                                {allAgencies.flatMap(a => a.mercatoRequests).filter(r => r.status === 'PENDING').map(r => (\n                                    <option key={r.id} value={r.id}>{r.type} : {r.studentName}</option>\n                                ))}\n                            </select>\n                        )}\n                    </div>\n\n                    {/* ITEM 5: AUDIT HOSTILE */}\n                    <div \n                        onClick={() => { setSelectedItem('AUDIT_HOSTILE'); setTargetId(\"\"); }}\n                        className={`p-4 border border-[#00ff41]/50 cursor-pointer hover:bg-[#00ff41]/10 transition-all ${selectedItem === 'AUDIT_HOSTILE' ? 'bg-[#00ff41]/20 border-[#00ff41]' : ''}`}\n                    >\n                        <div className=\"flex justify-between items-start mb-2\">\n                            <h3 className=\"font-bold text-lg flex items-center gap-2\"><Skull size={20}/> Audit Hostile</h3>\n                            <span className=\"font-bold\">500 PiXi</span>\n                        </div>\n                        <p className=\"text-sm opacity-80\">Attaque la crédibilité d'une agence adverse fragile. (-10 VE si succès).</p>\n                        {selectedItem === 'AUDIT_HOSTILE' && (\n                            <select \n                                className=\"w-full bg-black border border-[#00ff41] p-2 text-sm mt-2 focus:outline-none\"\n                                onChange={(e) => setTargetId(e.target.value)}\n                            >\n                                <option value=\"\">-- CIBLE À ATTAQUER --</option>\n                                {rivalAgencies.map(a => <option key={a.id} value={a.id}>{a.name}</option>)}\n                            </select>\n                        )}\n                    </div>\n\n                </div>\n\n                {/* RIGHT: TERMINAL & WALLET */}\n                <div className=\"flex flex-col gap-4\">\n                    <div className=\"border border-[#00ff41] p-4 bg-[#001100]\">\n                        <h4 className=\"text-xs uppercase font-bold mb-2 opacity-70\">Wallet Caché (Non-traçable)</h4>\n                        <div className=\"text-3xl font-bold\">{currentUser.wallet} PiXi</div>\n                    </div>\n\n                    <div className=\"flex-1 border border-[#00ff41] p-4 bg-black font-mono text-xs overflow-y-auto flex flex-col-reverse\">\n                        {terminalOutput.map((line, i) => (\n                            <div key={i} className=\"mb-1 opacity-80\">{line}</div>\n                        ))}\n                    </div>\n\n                    <button \n                        onClick={handleBuy}\n                        disabled={!selectedItem}\n                        className={`w-full py-4 font-bold text-black text-lg transition-all uppercase tracking-widest ${\n                            selectedItem ? 'bg-[#00ff41] hover:bg-white cursor-pointer' : 'bg-[#004411] cursor-not-allowed text-[#008822]'\n                        }`}\n                    >\n                        {selectedItem ? `CONFIRMER ACHAT` : 'SÉLECTIONNER OFFRE'}\n                    </button>\n                    \n                    <div className=\"text-[10px] text-center opacity-50\">\n                        Attention : Le Karma ne dort jamais.\n                    </div>\n                </div>\n            </div>\n            \n            <style>{`\n                .glitch-text {\n                    text-shadow: 2px 0 #ff0000, -2px 0 #0000ff;\n                }\n            `}</style>\n        </div>\n    );\n};"
            }
          ]
        }
      ]
    },
    "createdTimestamp": {
      "seconds": 1768532516,
      "nanos": 943000000
    },
    "doneTimestamp": {
      "seconds": 1768532529,
      "nanos": 177000000
    }
  },
  {
    "id": 144,
    "author": "user",
    "payload": {
      "type": "text",
      "text": "Il me faut pouvoir voir la boutique dans les vues et simulations\n\naussi, il faut un max de 3 articles random chaque 72h",
      "files": [],
      "fileUploads": [],
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1768602286,
      "nanos": 708000000
    }
  },
  {
    "id": 145,
    "author": "model",
    "payload": {
      "type": "thinking",
      "text": "",
      "errorWhileThinking": true
    },
    "createdTimestamp": {
      "seconds": 1768602286,
      "nanos": 709000000
    },
    "doneTimestamp": {
      "seconds": 1768602320,
      "nanos": 21000000
    }
  },
  {
    "id": 146,
    "author": "model",
    "payload": {
      "type": "error",
      "error": "An internal error occurred.",
      "metadata": {
        "message": "Failed to run code assistant. Please try again."
      },
      "isCancelError": false,
      "isLoopingError": false
    },
    "createdTimestamp": {
      "seconds": 1768602320,
      "nanos": 21000000
    },
    "doneTimestamp": {
      "seconds": 1768602320,
      "nanos": 21000000
    }
  },
  {
    "id": 147,
    "author": "user",
    "payload": {
      "type": "text",
      "text": "Il me faut pouvoir voir la boutique dans les vues et simulations\naussi, il faut un max de 3 articles random chaque 72h",
      "files": [],
      "fileUploads": [],
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1768648984,
      "nanos": 308000000
    }
  },
  {
    "id": 148,
    "author": "model",
    "payload": {
      "type": "thinking",
      "text": "**Examining Visibility Constraints**\n\nI'm currently working on making the \"The Backdoor\" visible in simulations and views, regardless of the time constraints. My initial analysis involves understanding and adjusting the existing restrictions that might be hiding it, especially during the 22h-04h timeframe. I'm focusing on ensuring its consistent availability within the system.\n\n\n**Analyzing Shop Item Rotation**\n\nI'm now fully immersed in the item rotation. My focus is on creating a robust system for the shop, specifically to offer three random items every 72 hours. I have a firm grasp of the current implementation and its limitations. I'm exploring an algorithm to ensure consistency in item availability for all students within each 72-hour cycle.\n\n\n**Implementing Shop Item Logic**\n\nI'm now implementing the item rotation logic itself. I've decided to calculate a \"rotation index\" using the timestamp and a 72-hour period as the seed for a random number generator. I'll shuffle the item pool based on this index and select the top three. I've chosen to implement this within `TheBackdoor.tsx` for simplicity, perhaps with a small helper function. Next, I'll define the `SHOP_ITEMS` array, implement the selection logic (`getAvailableItems()`), and render only the selected items. I also need to make sure the shop is always visible.\n\n\n**Adapting Visibility Rules**\n\nI am now fine-tuning the visibility rules. I'm focusing on scenarios where the time check needs to be ignored. I've considered that if the system is simulating, or if the user has admin privileges, the strict time constraint should be bypassed. I'm leaning toward a `forceOpen` mechanism or simply relaxing the rule when specifically requested by the admin or simulator. This directly addresses the prompt, clarifying the requirements.\n\n\n**Modifying Accessibility Logic**\n\nMy current focus is on adapting the accessibility logic for the backdoor. I'm now modifying `StudentAgencyView`, specifically checking `userData?.role === 'admin'`. If the user has an admin role, the system will always consider the backdoor available, regardless of other constraints.\n\n\n\n**Developing Core Shop Mechanics**\n\nI'm now refining the item selection. I'm leveraging the timestamp epoch, specifically its division by 72 hours, as a robust seed for a consistent item shuffle without relying on server-side state. I've focused on ensuring the randomization remains predictable per student every 72 hours. With the pseudo-code complete, I am confident the random logic is sufficient. I also am implementing the admin override via role-check to handle simulation visibility. I'm getting ready to make changes to TheBackdoor.tsx, including dynamic rendering, and StudentAgencyView.tsx to allow for admin access.\n\n\n**Building Item Interactions**\n\nI'm now focusing on integrating the click handlers for each item. My plan is to render a generic item card but maintain the `handleBuy` switch case based on the item ID. I will define an `ALL_ITEMS` array with all the necessary metadata. The goal is to generate scarcity by selecting three items from a list of five, resulting in two items being unavailable every three days. I'll also add a dynamic timer display to show the next stock refresh.\n\n\n",
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1768648984,
      "nanos": 308000000
    },
    "doneTimestamp": {
      "seconds": 1768649014,
      "nanos": 983000000
    }
  },
  {
    "id": 149,
    "author": "model",
    "payload": {
      "type": "text",
      "text": "Voici les modifications pour répondre à tes deux demandes :\n1.  **Rotation de la Boutique** : J'ai implémenté un algorithme déterministe basé sur le temps. Toutes les 72h, le \"seed\" change et sélectionne aléatoirement 3 articles parmi le catalogue complet. Tous les étudiants voient la même sélection synchronisée.\n2.  **Visibilité Simulation** : J'ai modifié la condition d'affichage du \"glitch\" (le pixel déclencheur). Si l'utilisateur est un Admin (ou en mode simulation), le bouton apparaît tout le temps, peu importe l'heure.\n\nVoici les fichiers mis à jour :\n\n",
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1768649014,
      "nanos": 983000000
    },
    "doneTimestamp": {
      "seconds": 1768649014,
      "nanos": 986000000
    }
  },
  {
    "id": 150,
    "author": "model",
    "payload": {
      "type": "generationTable",
      "entries": [
        {
          "path": "components/student/TheBackdoor.tsx",
          "generationType": 1,
          "isDone": true,
          "description": "Mise en place de la rotation de stock (3 items max tous les 72h) et affichage dynamique.",
          "diffs": [
            {
              "target": "",
              "replacement": "\nimport React, { useState, useEffect, useMemo } from 'react';\nimport { Agency, Student } from '../../types';\nimport { useGame } from '../../contexts/GameContext';\nimport { useUI } from '../../contexts/UIContext';\nimport { TrendingUp, Eye, Vote, FileX, Skull, ShoppingBag, Clock } from 'lucide-react';\n\ninterface TheBackdoorProps {\n    agency: Agency;\n    allAgencies: Agency[];\n    currentUser: Student;\n    onClose: () => void;\n}\n\n// Pseudo-random user obfuscation\nconst generateAlias = (name: string) => {\n    const hash = name.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);\n    return `User-${hash.toString(16).toUpperCase().slice(0,4)}`;\n};\n\n// CATALOGUE COMPLET\nconst ALL_ITEMS = [\n    { \n        id: 'SHORT_SELL', \n        label: 'Short Selling', \n        price: 500, \n        icon: TrendingUp, \n        desc: \"Parier sur la chute d'une agence. Si elle perd de la VE au prochain bilan, vous gagnez 1000 PiXi.\",\n        requiresTarget: true \n    },\n    { \n        id: 'DOXXING', \n        label: 'Doxxing RH', \n        price: 600, \n        icon: Eye, \n        desc: \"Révèle l'identité des auteurs de mauvaises notes (< 3/5) dans votre agence cette semaine.\",\n        requiresTarget: false \n    },\n    { \n        id: 'FAKE_CERT', \n        label: 'Faux Certificat', \n        price: 500, \n        icon: FileX, \n        desc: \"Efface rétroactivement un retard noté sur un livrable. Risque de détection: 20%.\",\n        requiresTarget: false \n    },\n    { \n        id: 'BUY_VOTE', \n        label: 'Bourrage d\\'Urne', \n        price: 200, \n        icon: Vote, \n        desc: \"Ajoute un vote 'APPROVE' fantôme sur une demande Mercato active.\",\n        requiresTarget: true \n    },\n    { \n        id: 'AUDIT_HOSTILE', \n        label: 'Audit Hostile', \n        price: 500, \n        icon: Skull, \n        desc: \"Attaque la crédibilité d'une agence adverse fragile. (-10 VE si succès).\",\n        requiresTarget: true \n    }\n];\n\n// 72 Hours in milliseconds\nconst ROTATION_DURATION = 72 * 60 * 60 * 1000; \n\nexport const TheBackdoor: React.FC<TheBackdoorProps> = ({ agency, allAgencies, currentUser, onClose }) => {\n    const { performBlackOp } = useGame();\n    const { toast } = useUI();\n    \n    const [terminalOutput, setTerminalOutput] = useState<string[]>([\"Initialisation protocole 22-04...\", \"Connexion sécurisée établie.\"]);\n    const [selectedItem, setSelectedItem] = useState<string | null>(null);\n    const [targetId, setTargetId] = useState<string>(\"\");\n    const [doxxResult, setDoxxResult] = useState<string | null>(null);\n    const [timeLeft, setTimeLeft] = useState(\"\");\n\n    // Filter Targets\n    const rivalAgencies = allAgencies.filter(a => a.id !== 'unassigned' && a.id !== agency.id);\n\n    // --- ROTATION LOGIC ---\n    const stock = useMemo(() => {\n        const now = Date.now();\n        const currentCycle = Math.floor(now / ROTATION_DURATION);\n        \n        // Deterministic Random based on Cycle\n        const seededRandom = (seed: number) => {\n            const x = Math.sin(seed) * 10000;\n            return x - Math.floor(x);\n        };\n\n        // Shuffle ALL_ITEMS based on seed\n        const shuffled = [...ALL_ITEMS].sort((a, b) => {\n            const seedA = currentCycle + a.price; // Simple variation\n            const seedB = currentCycle + b.price;\n            return seededRandom(seedA) - seededRandom(seedB);\n        });\n\n        // Pick Top 3\n        return shuffled.slice(0, 3);\n    }, []);\n\n    useEffect(() => {\n        const timer = setInterval(() => {\n            const now = Date.now();\n            const nextRotation = (Math.floor(now / ROTATION_DURATION) + 1) * ROTATION_DURATION;\n            const diff = nextRotation - now;\n            \n            const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));\n            const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));\n            setTimeLeft(`${h}h ${m}m`);\n        }, 60000);\n        return () => clearInterval(timer);\n    }, []);\n    \n    const addToTerminal = (text: string) => {\n        setTerminalOutput(prev => [...prev, `> ${text}`]);\n    };\n\n    const handleBuy = async () => {\n        if (!selectedItem) return;\n\n        let opType: any = selectedItem;\n        let payload: any = {};\n        let cost = ALL_ITEMS.find(i => i.id === selectedItem)?.price || 0;\n\n        if (selectedItem === 'SHORT_SELL') {\n            if (!targetId) { addToTerminal(\"ERREUR: Cible manquante.\"); return; }\n            payload = { targetId };\n        } \n        else if (selectedItem === 'DOXXING') {\n            payload = {}; // Self agency check\n        }\n        else if (selectedItem === 'FAKE_CERT') {\n            // Find a late deliverable\n            let lateDeliv: {weekId: string, delId: string} | null = null;\n            Object.values(agency.progress).forEach(w => {\n                w.deliverables.forEach(d => {\n                    if (d.grading && d.grading.daysLate > 0) lateDeliv = { weekId: w.id, delId: d.id };\n                });\n            });\n            \n            if (!lateDeliv) {\n                addToTerminal(\"ERREUR: Aucun retard détecté à effacer.\");\n                return;\n            }\n            payload = { weekId: lateDeliv.weekId, deliverableId: lateDeliv.delId };\n        }\n        else if (selectedItem === 'BUY_VOTE') {\n            if (!targetId) { addToTerminal(\"ERREUR: Requête cible manquante.\"); return; }\n            payload = { requestId: targetId };\n        }\n        else if (selectedItem === 'AUDIT_HOSTILE') {\n            if (!targetId) { addToTerminal(\"ERREUR: Cible manquante.\"); return; }\n            payload = { targetId };\n        }\n\n        if ((currentUser.wallet || 0) < cost) {\n            addToTerminal(\"ERREUR: Fonds insuffisants (PiXi).\");\n            return;\n        }\n\n        // EXECUTE\n        addToTerminal(`Exécution ${opType}...`);\n        await performBlackOp(currentUser.id, agency.id, opType, payload);\n        addToTerminal(\"Transaction terminée. Trace effacée (partiellement).\");\n\n        // UI FEEDBACK SPECIFIC\n        if (opType === 'DOXXING') {\n            const badReviews = agency.peerReviews.filter(r => \n                ((r.ratings.attendance + r.ratings.quality + r.ratings.involvement)/3) < 3\n            );\n            if (badReviews.length > 0) {\n                const reveal = badReviews.map(r => `${r.reviewerName} a noté ${r.targetName} (Moy: ${((r.ratings.attendance+r.ratings.quality+r.ratings.involvement)/3).toFixed(1)})`).join('\\n');\n                setDoxxResult(reveal);\n                addToTerminal(\"RÉSULTAT DOXXING OBTENU.\");\n            } else {\n                setDoxxResult(\"Aucune mauvaise note (< 3/5) détectée cette semaine.\");\n                addToTerminal(\"Rien à signaler.\");\n            }\n        }\n    };\n\n    const getTargetSelector = (itemId: string) => {\n        if (itemId === 'SHORT_SELL' || itemId === 'AUDIT_HOSTILE') {\n            return (\n                <select \n                    className=\"w-full bg-black border border-[#00ff41] p-2 text-sm mt-2 focus:outline-none\"\n                    onChange={(e) => setTargetId(e.target.value)}\n                >\n                    <option value=\"\">-- SÉLECTIONNER CIBLE --</option>\n                    {rivalAgencies.map(a => <option key={a.id} value={a.id}>{a.name} (VE: {a.ve_current})</option>)}\n                </select>\n            );\n        }\n        if (itemId === 'BUY_VOTE') {\n            return (\n                <select \n                    className=\"w-full bg-black border border-[#00ff41] p-2 text-sm mt-2 focus:outline-none\"\n                    onChange={(e) => setTargetId(e.target.value)}\n                >\n                    <option value=\"\">-- SÉLECTIONNER VOTE --</option>\n                    {allAgencies.flatMap(a => a.mercatoRequests).filter(r => r.status === 'PENDING').map(r => (\n                        <option key={r.id} value={r.id}>{r.type} : {r.studentName}</option>\n                    ))}\n                </select>\n            );\n        }\n        return null;\n    };\n\n    return (\n        <div className=\"fixed inset-0 z-[100] bg-black text-[#00ff41] font-mono p-4 md:p-8 flex flex-col overflow-hidden animate-in fade-in duration-300\">\n            {/* HEADER */}\n            <div className=\"flex justify-between items-center border-b border-[#00ff41] pb-4 mb-4\">\n                <div>\n                    <h1 className=\"text-2xl md:text-4xl font-bold tracking-widest uppercase glitch-text\">THE BACKDOOR // 22-04</h1>\n                    <p className=\"text-xs opacity-70\">Connexion cryptée : {generateAlias(currentUser.name)}</p>\n                </div>\n                <button onClick={onClose} className=\"text-red-500 hover:text-red-400 border border-red-500 px-4 py-2 rounded uppercase text-xs font-bold hover:bg-red-900/20 transition-colors\">\n                    Fermer la connexion\n                </button>\n            </div>\n\n            <div className=\"flex-1 grid grid-cols-1 md:grid-cols-3 gap-8 overflow-hidden\">\n                \n                {/* LEFT: MARKET ITEMS */}\n                <div className=\"md:col-span-2 overflow-y-auto custom-scrollbar border-r border-[#00ff41]/30 pr-4 space-y-6\">\n                    \n                    <div className=\"mb-2 flex justify-between items-center text-xs uppercase opacity-50 border-b border-[#00ff41]/30 pb-2\">\n                        <span>--- STOCK DISPONIBLE (3 ITEMS MAX) ---</span>\n                        <span className=\"flex items-center gap-1\"><Clock size={12}/> REFRESH DANS : {timeLeft}</span>\n                    </div>\n\n                    {stock.map(item => (\n                        <div \n                            key={item.id}\n                            onClick={() => { setSelectedItem(item.id); setTargetId(\"\"); setDoxxResult(null); }}\n                            className={`p-4 border border-[#00ff41]/50 cursor-pointer hover:bg-[#00ff41]/10 transition-all ${selectedItem === item.id ? 'bg-[#00ff41]/20 border-[#00ff41]' : ''}`}\n                        >\n                            <div className=\"flex justify-between items-start mb-2\">\n                                <h3 className=\"font-bold text-lg flex items-center gap-2\">\n                                    <item.icon size={20} /> {item.label}\n                                </h3>\n                                <span className=\"font-bold\">{item.price} PiXi</span>\n                            </div>\n                            <p className=\"text-sm opacity-80 mb-2\">{item.desc}</p>\n                            \n                            {/* DYNAMIC INPUTS */}\n                            {selectedItem === item.id && getTargetSelector(item.id)}\n\n                            {/* DOXXING RESULT */}\n                            {selectedItem === 'DOXXING' && item.id === 'DOXXING' && doxxResult && (\n                                <div className=\"mt-2 p-2 border border-red-500 text-red-500 text-xs whitespace-pre-line bg-red-900/10 animate-in fade-in\">\n                                    {doxxResult}\n                                </div>\n                            )}\n                        </div>\n                    ))}\n\n                    {/* FILLER FOR EMPTY SLOTS VISUAL */}\n                    {[...Array(3 - stock.length)].map((_, i) => (\n                        <div key={i} className=\"p-4 border border-[#00ff41]/10 opacity-30 flex items-center justify-center h-24\">\n                            <span className=\"text-xs uppercase\">[ RUPTURE DE STOCK ]</span>\n                        </div>\n                    ))}\n\n                </div>\n\n                {/* RIGHT: TERMINAL & WALLET */}\n                <div className=\"flex flex-col gap-4\">\n                    <div className=\"border border-[#00ff41] p-4 bg-[#001100]\">\n                        <h4 className=\"text-xs uppercase font-bold mb-2 opacity-70\">Wallet Caché (Non-traçable)</h4>\n                        <div className=\"text-3xl font-bold\">{currentUser.wallet} PiXi</div>\n                    </div>\n\n                    <div className=\"flex-1 border border-[#00ff41] p-4 bg-black font-mono text-xs overflow-y-auto flex flex-col-reverse\">\n                        {terminalOutput.map((line, i) => (\n                            <div key={i} className=\"mb-1 opacity-80\">{line}</div>\n                        ))}\n                    </div>\n\n                    <button \n                        onClick={handleBuy}\n                        disabled={!selectedItem}\n                        className={`w-full py-4 font-bold text-black text-lg transition-all uppercase tracking-widest ${\n                            selectedItem ? 'bg-[#00ff41] hover:bg-white cursor-pointer' : 'bg-[#004411] cursor-not-allowed text-[#008822]'\n                        }`}\n                    >\n                        {selectedItem ? `CONFIRMER ACHAT` : 'SÉLECTIONNER OFFRE'}\n                    </button>\n                    \n                    <div className=\"text-[10px] text-center opacity-50\">\n                        Attention : Le Karma ne dort jamais.\n                    </div>\n                </div>\n            </div>\n            \n            <style>{`\n                .glitch-text {\n                    text-shadow: 2px 0 #ff0000, -2px 0 #0000ff;\n                }\n            `}</style>\n        </div>\n    );\n};\n"
            }
          ]
        },
        {
          "path": "components/StudentAgencyView.tsx",
          "generationType": 1,
          "isDone": true,
          "description": "Autoriser l'Admin (ou la simulation) à voir le Backdoor peu importe l'heure.",
          "diffs": [
            {
              "target": "",
              "replacement": "\nimport React, { useState, useEffect } from 'react';\nimport { Agency, BrandColor, Student, GameEvent, MercatoRequest, ChallengeRequest } from '../types';\nimport { Target, Users, History, Wallet, TrendingUp, HelpCircle, Briefcase, Settings, Image as ImageIcon, Shield, Eye, Crown, BookOpen, Send, Repeat, ArrowUpRight, Building2, Zap, AlertTriangle, PartyPopper, Gavel, Landmark, Landmark as Bank, Check, X, Info, Rocket, Upload, Bug } from 'lucide-react';\nimport { MarketOverview } from './student/MarketOverview';\nimport { MissionsView } from './student/MissionsView';\nimport { TeamView } from './student/TeamView';\n// HistoryView removed from direct import as it is now inside MarketOverview\nimport { MercatoView } from './student/MercatoView';\nimport { WikiView } from './student/WikiView';\nimport { FAQView } from './student/FAQView';\nimport { TheBackdoor } from './student/TheBackdoor'; // IMPORT\nimport { Modal } from './Modal';\nimport { GAME_RULES, BADGE_DEFINITIONS } from '../constants';\nimport { ref, uploadBytes, getDownloadURL, storage } from '../services/firebase';\nimport { useUI } from '../contexts/UIContext';\nimport { useAuth } from '../contexts/AuthContext';\nimport { useGame } from '../contexts/GameContext';\n\ninterface StudentViewProps {\n  agency: Agency;\n  allAgencies: Agency[];\n  onUpdateAgency: (agency: Agency) => void;\n}\n\ntype TabType = 'MARKET' | 'MISSIONS' | 'TEAM' | 'RECRUITMENT' | 'RESOURCES' | 'HELP';\n\nconst COLOR_THEMES: Record<BrandColor, { bg: string, text: string }> = {\n    indigo: { bg: 'bg-indigo-600', text: 'text-indigo-600' },\n    emerald: { bg: 'bg-emerald-600', text: 'text-emerald-600' },\n    rose: { bg: 'bg-rose-600', text: 'text-rose-600' },\n    amber: { bg: 'bg-amber-500', text: 'text-amber-500' },\n    cyan: { bg: 'bg-cyan-500', text: 'text-cyan-500' },\n    slate: { bg: 'bg-slate-600', text: 'text-slate-600' },\n};\n\n// LIMITE IMAGES : 2 Mo\nconst MAX_IMAGE_SIZE = 2 * 1024 * 1024;\n\nexport const StudentAgencyView: React.FC<StudentViewProps> = ({ agency, allAgencies, onUpdateAgency }) => {\n  const { toast } = useUI();\n  const { currentUser, userData } = useAuth();\n  const { transferFunds, injectCapital, requestScorePurchase, getCurrentGameWeek, updateAgenciesList, submitMercatoVote, submitChallengeVote } = useGame();\n  \n  const [activeTab, setActiveTab] = useState<TabType>('MARKET');\n  const [showVERules, setShowVERules] = useState(false);\n  const [showSettings, setShowSettings] = useState(false);\n  \n  const [unlockModal, setUnlockModal] = useState<{title: string, message: string, icon: any, confirmText: string} | null>(null);\n  const [notificationEvent, setNotificationEvent] = useState<GameEvent | null>(null);\n\n  // BACKDOOR STATE\n  const [showBackdoor, setShowBackdoor] = useState(false);\n  const [isBackdoorAvailable, setIsBackdoorAvailable] = useState(false);\n\n  const brandColor = agency.branding?.color || 'indigo';\n  const theme = COLOR_THEMES[brandColor];\n  const leaderboard = [...allAgencies].filter(a => a.id !== 'unassigned').sort((a, b) => b.ve_current - a.ve_current);\n  const myRank = leaderboard.findIndex(a => a.id === agency.id) + 1;\n  const rawSalary = agency.members.reduce((acc, member) => acc + (member.individualScore * GAME_RULES.SALARY_MULTIPLIER), 0);\n  const weeklyCharges = rawSalary * (1 + (agency.weeklyTax || 0)) + GAME_RULES.AGENCY_RENT;\n  const veRevenue = agency.ve_current * GAME_RULES.REVENUE_VE_MULTIPLIER;\n  const weeklyRevenue = GAME_RULES.REVENUE_BASE + veRevenue + (agency.weeklyRevenueModifier || 0);\n  const netWeekly = weeklyRevenue - weeklyCharges;\n  const myMemberProfile = agency.members.find(m => m.id === currentUser?.uid);\n\n  // TIME CHECK FOR BACKDOOR\n  useEffect(() => {\n      const checkTime = () => {\n          const hour = new Date().getHours();\n          // Available between 22h and 04h OR IF ADMIN (Simulation Mode)\n          const isOpen = hour >= 22 || hour < 4 || userData?.role === 'admin';\n          setIsBackdoorAvailable(isOpen);\n      };\n      checkTime();\n      const timer = setInterval(checkTime, 60000); // Check every minute\n      return () => clearInterval(timer);\n  }, [userData]);\n\n  useEffect(() => {\n      const currentWeek = getCurrentGameWeek();\n      if (currentWeek >= GAME_RULES.UNLOCK_WEEK_BLACK_OPS) {\n          const hasSeenBlackOps = localStorage.getItem(`seen_unlock_blackops_${currentUser?.uid}`);\n          if (!hasSeenBlackOps) {\n              setUnlockModal({\n                  title: \"Intelligence Économique Activée\",\n                  message: \"Le marché se durcit. Vous avez désormais accès aux outils de veille stratégique.\\n\\nNouveauté : Audits concurrentiels et achat d'informations disponibles dans l'onglet 'Marché'.\",\n                  icon: <Eye size={32} className=\"text-yellow-500\"/>,\n                  confirmText: \"Compris, je reste vigilant\"\n              });\n              localStorage.setItem(`seen_unlock_blackops_${currentUser?.uid}`, 'true');\n              return; \n          }\n      }\n  }, [getCurrentGameWeek, currentUser]);\n\n  useEffect(() => {\n      if (agency.eventLog.length === 0) return;\n      const latestEvent = agency.eventLog[agency.eventLog.length - 1];\n      const NOTIFY_TYPES = ['CRISIS', 'VE_DELTA'];\n      if (NOTIFY_TYPES.includes(latestEvent.type)) {\n          const seenKey = `seen_event_${currentUser?.uid}_${latestEvent.id}`;\n          const hasSeen = localStorage.getItem(seenKey);\n          if (!hasSeen) setNotificationEvent(latestEvent);\n      }\n  }, [agency.eventLog, currentUser]);\n\n  const closeNotification = () => {\n      if (notificationEvent) {\n          localStorage.setItem(`seen_event_${currentUser?.uid}_${notificationEvent.id}`, 'true');\n          setNotificationEvent(null);\n      }\n  };\n\n  const handleColorChange = (color: BrandColor) => {\n      onUpdateAgency({ ...agency, branding: { ...agency.branding, color } });\n  };\n\n  const handleBannerUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {\n      if (e.target.files && e.target.files[0]) {\n          const file = e.target.files[0];\n          if (file.size > MAX_IMAGE_SIZE) {\n              toast('error', `Image trop lourde (${(file.size/1024/1024).toFixed(1)} Mo). Max 2 Mo.`);\n              return;\n          }\n          try {\n              const storageRef = ref(storage, `banners/${agency.id}_${Date.now()}`);\n              await uploadBytes(storageRef, file);\n              const url = await getDownloadURL(storageRef);\n              onUpdateAgency({ ...agency, branding: { ...agency.branding, bannerUrl: url } });\n              toast('success', 'Bannière mise à jour');\n          } catch (error) { toast('error', \"Erreur d'upload\"); }\n      }\n  };\n\n  const handleLogoUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {\n    if (e.target.files && e.target.files[0]) {\n        const file = e.target.files[0];\n        if (file.size > MAX_IMAGE_SIZE) {\n            toast('error', `Image trop lourde (${(file.size/1024/1024).toFixed(1)} Mo). Max 2 Mo.`);\n            return;\n        }\n        try {\n            const storageRef = ref(storage, `logos/${agency.id}_${Date.now()}`);\n            await uploadBytes(storageRef, file);\n            const url = await getDownloadURL(storageRef);\n            onUpdateAgency({ ...agency, logoUrl: url });\n            toast('success', 'Logo mis à jour');\n        } catch (error) { toast('error', \"Erreur d'upload du logo\"); }\n    }\n  };\n\n  if (showBackdoor && myMemberProfile) {\n      return <TheBackdoor agency={agency} allAgencies={allAgencies} currentUser={myMemberProfile} onClose={() => setShowBackdoor(false)} />;\n  }\n\n  return (\n    <div className=\"flex flex-col min-h-[calc(100vh-6rem)] font-sans relative\">\n        \n        {/* BACKDOOR TRIGGER (INVISIBLE UNLESS TIME MATCHES) */}\n        {isBackdoorAvailable && (\n            <button \n                onClick={() => setShowBackdoor(true)}\n                className=\"fixed bottom-4 right-4 z-[60] w-2 h-2 bg-transparent hover:bg-black/10 cursor-alias\"\n                title=\"?\"\n            >\n                <div className=\"w-full h-full animate-ping bg-green-500 opacity-20\"></div>\n            </button>\n        )}\n\n        {/* HEADER */}\n        <div className=\"relative mb-8 rounded-b-3xl md:rounded-3xl overflow-hidden bg-slate-100 min-h-[200px] md:min-h-[240px] shadow-md group\">\n            {agency.branding?.bannerUrl ? (\n                <img src={agency.branding.bannerUrl} className=\"absolute inset-0 w-full h-full object-cover\" alt=\"Banner\" />\n            ) : (\n                <div className={`absolute inset-0 opacity-10 ${theme.bg}`} style={{backgroundImage: 'radial-gradient(circle, #000 1px, transparent 1px)', backgroundSize: '20px 20px'}}></div>\n            )}\n            <div className=\"absolute inset-0 bg-gradient-to-t from-slate-900/90 via-slate-900/40 to-transparent\"></div>\n            {agency.id !== 'unassigned' && (\n                <button onClick={() => setShowSettings(true)} className=\"absolute top-4 right-4 p-2 bg-black/30 backdrop-blur-md rounded-full text-white hover:bg-black/50 transition-all opacity-0 group-hover:opacity-100 border border-white/10 z-20\">\n                    <Settings size={20}/>\n                </button>\n            )}\n            <div className=\"absolute bottom-0 left-0 right-0 p-6 flex flex-col xl:flex-row justify-between items-end xl:items-end gap-6 text-white\">\n                <div className=\"w-full xl:w-auto flex gap-4 items-end\">\n                    {/* AGENCY LOGO */}\n                    {agency.logoUrl && (\n                        <div className=\"w-20 h-20 md:w-24 md:h-24 rounded-2xl bg-white p-1 shadow-2xl shrink-0 animate-in zoom-in duration-300\">\n                            <img src={agency.logoUrl} className=\"w-full h-full object-contain rounded-xl\" alt=\"Logo\" />\n                        </div>\n                    )}\n                    <div className=\"flex-1\">\n                        <div className=\"flex items-center gap-3 mb-1\">\n                            {agency.id !== 'unassigned' && <span className=\"bg-white/20 backdrop-blur border border-white/10 px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider\">Rang #{myRank}</span>}\n                            <span className=\"text-slate-300 italic text-sm truncate\">\"{agency.tagline}\"</span>\n                        </div>\n                        <h2 className=\"text-4xl md:text-5xl font-display font-bold tracking-tight drop-shadow-lg leading-none mb-3\">{agency.name}</h2>\n                        <div className=\"flex items-center gap-1\">\n                            {agency.badges && agency.badges.map(b => (\n                                <div key={b.id} title={b.label} className=\"w-6 h-6 rounded-full bg-yellow-400 text-yellow-900 flex items-center justify-center shadow-lg border border-yellow-200\"><Shield size={12}/></div>\n                            ))}\n                        </div>\n                    </div>\n                </div>\n\n                {agency.id !== 'unassigned' && (\n                <div className=\"flex flex-col md:flex-row gap-4 w-full xl:w-auto bg-black/40 backdrop-blur-md p-4 rounded-2xl border border-white/10\">\n                    {myMemberProfile && (\n                        <div className=\"flex-1 md:text-right md:border-r border-white/20 md:pr-4\">\n                            <span className=\"text-[10px] font-bold text-yellow-300 uppercase tracking-widest block mb-1 flex items-center gap-1 md:justify-end\">\n                                <Wallet size={12}/> Mon Solde\n                            </span>\n                            <div className=\"text-lg font-bold text-white flex items-center md:justify-end gap-2\">\n                                <span className={`font-mono ${myMemberProfile.wallet && myMemberProfile.wallet < 0 ? 'text-red-400' : 'text-yellow-400'}`}>{myMemberProfile.wallet || 0} PiXi</span>\n                            </div>\n                        </div>\n                    )}\n                    \n                    <div className=\"flex-1 md:text-right md:border-r border-white/20 md:pr-4\">\n                        <span className=\"text-[10px] font-bold text-indigo-300 uppercase tracking-widest block mb-1 flex items-center gap-1 md:justify-end\">\n                            <Landmark size={12}/> Trésorerie Studio\n                        </span>\n                        <div className=\"text-lg font-bold text-white flex items-center md:justify-end gap-2\">\n                            <span className={`font-mono ${agency.budget_real < 0 ? 'text-red-400' : 'text-white'}`}>{agency.budget_real} PiXi</span>\n                        </div>\n                    </div>\n\n                    <div className=\"flex items-center justify-between md:justify-start gap-6 pl-2\">\n                        <div className=\"text-center\">\n                            <span className=\"text-[10px] font-bold text-slate-300 uppercase tracking-widest block mb-1\">Flux Net</span>\n                            <div className={`text-xl font-bold ${netWeekly >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>{netWeekly > 0 ? '+' : ''}{netWeekly.toFixed(0)}</div>\n                        </div>\n                        <div className=\"text-center\">\n                            <div \n                                onClick={() => setShowVERules(true)}\n                                className=\"text-[10px] font-bold text-slate-300 uppercase tracking-widest mb-1 flex items-center gap-1 justify-center cursor-pointer hover:text-white\"\n                            >\n                                VE <HelpCircle size={10}/>\n                            </div>\n                            <div className={`text-3xl font-display font-bold leading-none ${agency.ve_current >= 60 ? 'text-emerald-400' : 'text-amber-400'}`}>{agency.ve_current}</div>\n                        </div>\n                    </div>\n                </div>\n                )}\n            </div>\n        </div>\n\n        {/* VOTING BOOTHS (POPUP AUTOMATIQUE) */}\n        {myMemberProfile && (\n            <>\n                <VotingBooth \n                    agency={agency} \n                    currentUser={myMemberProfile} \n                    onVote={submitMercatoVote} \n                />\n                <ChallengeVotingBooth \n                    agency={agency}\n                    currentUser={myMemberProfile}\n                    onVote={submitChallengeVote}\n                />\n            </>\n        )}\n\n        {/* CONTENT */}\n        <div className=\"flex-1 mb-24 md:mb-8\">\n            {activeTab === 'MARKET' && agency.id !== 'unassigned' && <MarketOverview agency={agency} allAgencies={allAgencies} currentUser={myMemberProfile} />}\n            {activeTab === 'MISSIONS' && agency.id !== 'unassigned' && <MissionsView agency={agency} onUpdateAgency={onUpdateAgency} />}\n            {activeTab === 'TEAM' && agency.id !== 'unassigned' && <TeamView agency={agency} onUpdateAgency={onUpdateAgency} />}\n            {(activeTab === 'RECRUITMENT' || agency.id === 'unassigned') && (\n              <MercatoView \n                agency={agency} \n                allAgencies={allAgencies} \n                onUpdateAgency={onUpdateAgency} \n                onUpdateAgencies={updateAgenciesList} \n              />\n            )}\n            {activeTab === 'RESOURCES' && <WikiView agency={agency} />}\n            {activeTab === 'HELP' && <FAQView />}\n        </div>\n\n        {/* FOOTER NAV */}\n        <div className=\"fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-md border-t border-slate-200 p-2 z-50 md:relative md:bg-transparent md:border-t-0 md:p-0 md:mt-auto safe-area-bottom\">\n             <div className=\"max-w-7xl mx-auto flex md:justify-start gap-2 md:gap-4 overflow-x-auto no-scrollbar snap-x justify-between\">\n                {agency.id !== 'unassigned' && (\n                    <>\n                        <NavButton active={activeTab === 'MARKET'} onClick={() => setActiveTab('MARKET')} icon={<TrendingUp size={20} />} label=\"Tableau de Bord\" theme={theme} />\n                        <NavButton active={activeTab === 'MISSIONS'} onClick={() => setActiveTab('MISSIONS')} icon={<Target size={20} />} label=\"Missions\" theme={theme} />\n                        <NavButton active={activeTab === 'TEAM'} onClick={() => setActiveTab('TEAM')} icon={<Users size={20} />} label=\"Équipe\" theme={theme} />\n                    </>\n                )}\n                <NavButton active={activeTab === 'RESOURCES'} onClick={() => setActiveTab('RESOURCES')} icon={<BookOpen size={20} />} label=\"Wiki\" theme={theme} />\n                <NavButton active={activeTab === 'RECRUITMENT' || agency.id === 'unassigned'} onClick={() => setActiveTab('RECRUITMENT')} icon={<Briefcase size={20} />} label={agency.id === 'unassigned' ? \"Mon Statut\" : \"Recrutement\"} theme={theme} />\n                <NavButton active={activeTab === 'HELP'} onClick={() => setActiveTab('HELP')} icon={<HelpCircle size={20} />} label=\"Aide\" theme={theme} />\n             </div>\n        </div>\n\n        {/* MODALS */}\n        <Modal isOpen={showSettings} onClose={() => setShowSettings(false)} title=\"Identité Visuelle du Studio\">\n            <div className=\"space-y-6\">\n                <div>\n                    <label className=\"block text-sm font-bold text-slate-700 mb-2\">Logo de l'Agence (Carré)</label>\n                    <div className=\"flex items-center gap-4\">\n                        <div className=\"w-20 h-20 rounded-2xl bg-slate-100 border border-slate-200 overflow-hidden flex items-center justify-center shrink-0\">\n                            {agency.logoUrl ? <img src={agency.logoUrl} className=\"w-full h-full object-contain\" /> : <Landmark className=\"text-slate-300\" size={32}/>}\n                        </div>\n                        <label className=\"flex-1 flex flex-col items-center justify-center h-20 border-2 border-slate-300 border-dashed rounded-xl cursor-pointer bg-slate-50 hover:bg-slate-100 transition-colors\">\n                            <div className=\"flex flex-col items-center justify-center\">\n                                <Upload className=\"w-5 h-5 text-slate-400 mb-1\" />\n                                <p className=\"text-[10px] text-slate-500 font-bold uppercase\">Changer le Logo</p>\n                            </div>\n                            <input type=\"file\" className=\"hidden\" accept=\"image/*\" onChange={handleLogoUpload} />\n                        </label>\n                    </div>\n                </div>\n\n                <div>\n                    <label className=\"block text-sm font-bold text-slate-700 mb-2\">Couleur de Marque</label>\n                    <div className=\"flex gap-3\">\n                        {(['indigo', 'emerald', 'rose', 'amber', 'cyan'] as BrandColor[]).map(c => (\n                            <button key={c} onClick={() => handleColorChange(c)} className={`w-10 h-10 rounded-full border-2 ${COLOR_THEMES[c].bg} ${brandColor === c ? 'ring-4 ring-offset-2 ring-slate-200 border-white' : 'border-transparent opacity-60 hover:opacity-100'}`} />\n                        ))}\n                    </div>\n                </div>\n                <div>\n                    <label className=\"block text-sm font-bold text-slate-700 mb-2\">Bannière (Cover)</label>\n                    <label className=\"flex flex-col items-center justify-center w-full h-32 border-2 border-slate-300 border-dashed rounded-xl cursor-pointer bg-slate-50 hover:bg-slate-100 transition-colors\">\n                        <div className=\"flex flex-col items-center justify-center pt-5 pb-6\">\n                            <ImageIcon className=\"w-8 h-8 text-slate-400 mb-2\" />\n                            <p className=\"text-sm text-slate-500\">Cliquez pour changer la bannière</p>\n                        </div>\n                        <input type=\"file\" className=\"hidden\" accept=\"image/*\" onChange={handleBannerUpload} />\n                    </label>\n                </div>\n            </div>\n        </Modal>\n        \n        <Modal isOpen={showVERules} onClose={() => setShowVERules(false)} title=\"Comprendre la VE\">\n            <div className=\"space-y-6\">\n                <div className=\"bg-slate-50 p-4 rounded-2xl border border-slate-100\">\n                    <p className=\"text-sm text-slate-600 leading-relaxed mb-2\">\n                        La <strong>Valeur d'Entreprise (VE)</strong> est votre \"note de groupe\" dynamique (/100). \n                        <br/>Elle fluctue selon vos rendus, vos choix et les événements.\n                        <br/><br/>\n                        <strong>Attention :</strong> Si votre VE tombe à 0, c'est grave, mais la vraie mort est financière : <strong>-5000 PiXi = FAILLITE</strong>.\n                    </p>\n                </div>\n            </div>\n        </Modal>\n\n        {unlockModal && (\n            <Modal isOpen={!!unlockModal} onClose={() => setUnlockModal(null)} title={unlockModal.title}>\n                <div className=\"flex flex-col items-center text-center space-y-6\">\n                    <div className=\"p-6 rounded-full bg-slate-100 mb-2\">\n                        {unlockModal.icon}\n                    </div>\n                    <p className=\"text-slate-600 text-lg leading-relaxed whitespace-pre-line\">\n                        {unlockModal.message}\n                    </p>\n                    <button \n                        onClick={() => setUnlockModal(null)}\n                        className=\"w-full py-4 bg-slate-900 text-white font-bold rounded-xl hover:bg-indigo-600 transition-colors shadow-lg\"\n                    >\n                        {unlockModal.confirmText}\n                    </button>\n                </div>\n            </Modal>\n        )}\n\n        {notificationEvent && (\n            <Modal isOpen={!!notificationEvent} onClose={closeNotification} title={notificationEvent.type === 'CRISIS' ? \"ALERTE PRIORITAIRE\" : \"NOUVELLE IMPORTANTE\"}>\n                <div className=\"flex flex-col items-center text-center space-y-6\">\n                    <div className={`p-6 rounded-full mb-2 border-4 ${\n                        notificationEvent.type === 'CRISIS' || (notificationEvent.deltaVE || 0) < 0\n                        ? 'bg-red-50 border-red-100 text-red-600 animate-pulse'\n                        : 'bg-emerald-50 border-emerald-100 text-emerald-600'\n                    }`}>\n                        {notificationEvent.type === 'CRISIS' || (notificationEvent.deltaVE || 0) < 0\n                            ? <AlertTriangle size={48} strokeWidth={2.5}/>\n                            : (notificationEvent.deltaVE || 0) > 5 ? <PartyPopper size={48} strokeWidth={2.5}/> : <Zap size={48} strokeWidth={2.5}/>\n                        }\n                    </div>\n\n                    <div>\n                        <h3 className={`text-2xl font-black uppercase mb-2 ${\n                            notificationEvent.type === 'CRISIS' || (notificationEvent.deltaVE || 0) < 0 ? 'text-red-600' : 'text-emerald-600'\n                        }`}>\n                            {notificationEvent.label}\n                        </h3>\n                        <p className=\"text-slate-600 text-lg leading-relaxed font-medium\">\n                            {notificationEvent.description}\n                        </p>\n                    </div>\n\n                    <button \n                        onClick={closeNotification}\n                        className={`w-full py-4 text-white font-bold rounded-xl shadow-lg transition-transform active:scale-95 ${\n                            notificationEvent.type === 'CRISIS' || (notificationEvent.deltaVE || 0) < 0\n                            ? 'bg-red-600 hover:bg-red-700 shadow-red-200'\n                            : 'bg-emerald-600 hover:bg-emerald-700 shadow-emerald-200'\n                        }`}\n                    >\n                        {notificationEvent.type === 'CRISIS' ? \"J'AI PRIS CONNAISSANCE\" : \"GÉNIAL !\"}\n                    </button>\n                </div>\n            </Modal>\n        )}\n    </div>\n  );\n};\n\n// --- VOTING BOOTHS & COMPONENTS ---\nconst VotingBooth: React.FC<{agency: Agency, currentUser: Student, onVote: any}> = ({agency, currentUser, onVote}) => {\n    const pendingVote = agency.mercatoRequests.find(req => {\n        if (req.status !== 'PENDING') return false;\n        if (req.votes && req.votes[currentUser.id]) return false;\n        if (req.type === 'FIRE' && req.studentId === currentUser.id) return false;\n        return true;\n    });\n\n    if (!pendingVote) return null;\n    const isHire = pendingVote.type === 'HIRE';\n\n    return (\n        <Modal isOpen={true} onClose={() => {}} title=\"Session de Vote en cours\">\n            <div className=\"space-y-6\">\n                <div className={`p-4 rounded-xl border-l-4 ${isHire ? 'bg-emerald-50 border-emerald-500 text-emerald-800' : 'bg-red-50 border-red-500 text-red-800'}`}>\n                    <h4 className=\"font-bold text-lg mb-1 flex items-center gap-2\">\n                        {isHire ? <Users size={20}/> : <Gavel size={20}/>}\n                        {isHire ? \"Proposition de Recrutement\" : \"Proposition de Départ\"}\n                    </h4>\n                    <p className=\"text-sm\">Votre avis est requis pour valider cette décision d'agence.</p>\n                </div>\n\n                <div className=\"bg-white border border-slate-200 rounded-xl p-4 shadow-sm\">\n                    <p className=\"text-xs font-bold text-slate-400 uppercase tracking-wider mb-1\">Candidat / Cible</p>\n                    <p className=\"text-xl font-bold text-slate-900\">{pendingVote.studentName}</p>\n                    \n                    <div className=\"mt-4\">\n                        <p className=\"text-xs font-bold text-slate-400 uppercase tracking-wider mb-1\">Motivation / Motif</p>\n                        <p className=\"text-sm italic text-slate-600 bg-slate-50 p-3 rounded-lg border border-slate-100\">\n                            \"{pendingVote.motivation || 'Aucun motif fourni.'}\"\n                        </p>\n                    </div>\n                </div>\n\n                <div className=\"grid grid-cols-2 gap-4\">\n                    <button \n                        onClick={() => onVote(agency.id, pendingVote.id, currentUser.id, 'REJECT')}\n                        className=\"py-4 bg-white border-2 border-slate-200 text-slate-600 hover:border-red-200 hover:text-red-600 hover:bg-red-50 font-bold rounded-xl transition-all flex flex-col items-center gap-1\"\n                    >\n                        <X size={24}/>\n                        NON (Refuser)\n                    </button>\n                    <button \n                        onClick={() => onVote(agency.id, pendingVote.id, currentUser.id, 'APPROVE')}\n                        className=\"py-4 bg-slate-900 text-white hover:bg-emerald-600 font-bold rounded-xl transition-all flex flex-col items-center gap-1 shadow-lg\"\n                    >\n                        <Check size={24}/>\n                        OUI (Accepter)\n                    </button>\n                </div>\n            </div>\n        </Modal>\n    );\n};\n\nconst ChallengeVotingBooth: React.FC<{agency: Agency, currentUser: Student, onVote: any}> = ({agency, currentUser, onVote}) => {\n    const pendingChallenge = agency.challenges?.find(c => c.status === 'PENDING_VOTE' && (!c.votes || !c.votes[currentUser.id]));\n    if (!pendingChallenge) return null;\n\n    return (\n        <Modal isOpen={true} onClose={() => {}} title=\"⚠️ DÉFI SPÉCIAL DÉTECTÉ\">\n            <div className=\"space-y-6\">\n                <div className=\"bg-gradient-to-br from-indigo-900 to-slate-900 text-white p-6 rounded-2xl shadow-xl relative overflow-hidden\">\n                    <div className=\"relative z-10\">\n                        <div className=\"flex items-center gap-2 mb-2\">\n                            <Rocket className=\"text-yellow-400 animate-pulse\"/>\n                            <span className=\"text-xs font-bold uppercase tracking-widest text-indigo-300\">Opportunité IA</span>\n                        </div>\n                        <h3 className=\"text-2xl font-black mb-4 leading-tight\">{pendingChallenge.title}</h3>\n                        <p className=\"text-sm text-indigo-100 leading-relaxed bg-white/10 p-4 rounded-xl border border-white/10\">\n                            {pendingChallenge.description}\n                        </p>\n                    </div>\n                </div>\n\n                <div className=\"text-center\">\n                    <p className=\"text-sm text-slate-600 mb-4\">\n                        Si l'équipe accepte ce défi (Majorité &gt; {GAME_RULES.VOTE_THRESHOLD_CHALLENGE * 100}%), une <strong>mission spéciale</strong> sera ajoutée.\n                    </p>\n                    <div className=\"grid grid-cols-2 gap-4\">\n                        <button \n                            onClick={() => onVote(agency.id, pendingChallenge.id, currentUser.id, 'REJECT')}\n                            className=\"py-4 bg-white border-2 border-slate-200 text-slate-500 hover:text-red-500 hover:border-red-200 font-bold rounded-xl transition-all\"\n                        >\n                            Refuser\n                        </button>\n                        <button \n                            onClick={() => onVote(agency.id, pendingChallenge.id, currentUser.id, 'APPROVE')}\n                            className=\"py-4 bg-emerald-600 text-white hover:bg-emerald-500 font-bold rounded-xl transition-all shadow-lg shadow-emerald-200\"\n                        >\n                            Accepter le Défi\n                        </button>\n                    </div>\n                </div>\n            </div>\n        </Modal>\n    );\n};\n\nconst NavButton: React.FC<any> = ({ active, onClick, icon, label, theme }) => (\n    <button onClick={onClick} className={`snap-start flex flex-col md:flex-row items-center md:gap-3 p-2 md:p-4 rounded-xl transition-all min-w-[70px] md:min-w-[150px] justify-center md:justify-start ${active ? `${theme.bg} text-white transform scale-105 shadow-md` : 'hover:bg-slate-50 text-slate-400 hover:text-slate-600'}`}>\n        <div className={`p-1.5 rounded-full ${active ? 'bg-white/20' : ''}`}>{React.cloneElement(icon, { className: active ? 'text-white' : '' })}</div>\n        <span className={`text-[10px] md:text-base font-bold`}>{label}</span>\n    </button>\n);\n"
            }
          ]
        }
      ]
    },
    "createdTimestamp": {
      "seconds": 1768649015,
      "nanos": 617000000
    },
    "doneTimestamp": {
      "seconds": 1768649038,
      "nanos": 18000000
    }
  }
]