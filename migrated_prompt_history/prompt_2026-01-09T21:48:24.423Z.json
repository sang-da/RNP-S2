[
  {
    "id": 25,
    "author": "user",
    "payload": {
      "type": "text",
      "text": "Je veux que tu ajoute un léger correctif\n\ncertains étudiants sont bloqués sur la page d'attente\n\nce sont des étudiants qui avaient accès à l'App, et qui sont déjà lié à leur Avatar\n\nje ne comprends pas pourquoi\n\nmais ils me disent que certains ont accès, là où d'autres ne l'ont pas\n\ndonc pour résoudre ça, j'aimerais que tu ajoute, en plus du workflow actuel, la possibilité pour les utilisateurs qui sont \" stuck \" alors que leurs UID est déjà linkée à un des noms d'étudiants, d'avoir un petit bouton pour résoudre le problème à leur échelle\n\naussi, j'ai un souci avec le fait que je ne peux plus ni refuser une connexion, ni faire en sorte que le compte devienne superviseur",
      "files": [],
      "fileUploads": [],
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1767995235,
      "nanos": 849000000
    }
  },
  {
    "id": 26,
    "author": "model",
    "payload": {
      "type": "thinking",
      "text": "**Investigating Student Connectivity**\n\nI'm currently focused on the `WaitingScreen` issue. It appears some students are stuck there despite being linked to profiles in the `agencies` collection. My immediate task is to understand why this connection isn't translating to the game state. I'm digging into the data flow to pinpoint the disconnect.\n\n\n**Diagnosing User Role Discrepancies**\n\nI'm now zeroing in on discrepancies between user roles and agency assignments. My concern is with students stuck on the `WaitingScreen` when they should have agency access. The problem seems to stem from sync issues between the `users` and `agencies` collections. I'm constructing a \"self-fix\" option for the `WaitingScreen`, to give users an immediate solution. Additionally, the admin interface logic needs an update, due to missing connection controls.\n\n\n**Implementing User Action Buttons**\n\nI've just added a \"Check Status\" button, and a new \"Force Refresh\" functionality. It's designed to help users diagnose their connection issues in real-time. This queries the `agencies` collection, and updates the user's role if found. Users will be given an immediate \"fix\" by refreshing. For users truly not linked, they will know.\n\n**Deconstructing Admin Controls**\n\nI'm now focused on refining the admin interface. I'm expanding the AdminAccess component for improved user management. I'm adding a section for handling \"Pending Users\" with actions to reject users (delete them) or promote them to supervisors. I plan to improve the admin abilities related to agency control.\n\n\n**Defining User Flow Changes**\n\nI'm now detailing the implementation plan. I'm modifying `WaitingScreen.tsx` to include a `handleSelfFix` function, which checks agency memberships and updates the user's Firestore document. I'm adding a \"Réparer mon compte\" button to trigger this. I'm also updating `AdminAccess.tsx` to handle \"Pending Users\" with buttons to reject or promote them to supervisors. I'm also refining the `WaitingScreen` for new users.\n\n\n**Incorporating Admin Enhancements**\n\nI'm now integrating the admin features. I'm focusing on the \"Pending\" user scenario within `AdminAccess`. I'm using the `disconnectedUsers` array to correctly capture users not yet linked to the game. I'm adding options to handle these users. I'll need to make the user visible, and provide the user with actions. Then, I'm working on the `WaitingScreen` component, verifying `useGame` will provide the required state for an active connection check. I'm focusing on how `WaitingScreen` interacts with the `agencies` data.\n\n\n**Executing Final Admin Actions**\n\nI'm now implementing the admin interface updates. I've located the `disconnectedUsers` in `AdminAccess.tsx` and am adding the \"Promouvoir\" (Promote to Supervisor) and \"Refuser\" (Reject/Delete) buttons. I'll implement `handlePromoteSupervisor` to update the user's role and `handleRejectUser` to delete the user. I'm focusing on user interface details, and the French language, with Tailwind styling. I'll add confirmation modals for safety. Then, I will generate the final XML output, documenting the changes to `WaitingScreen.tsx` and `AdminAccess.tsx`. I realized \"disconnected\" users are perfect for this flow, which means I can directly act upon them with the interface.\n\n\n**Codifying Agency Synchronization**\n\nI'm now writing the `handleSelfFix` function to resolve `WaitingScreen` issues. My current approach involves updating Firestore directly from the `agencies` data, treating the latter as the definitive source. I'm focusing on ensuring data freshness in both `userData` and the `users` collection, to get the user past the waiting screen.\n\n\n",
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1767995235,
      "nanos": 849000000
    },
    "doneTimestamp": {
      "seconds": 1767995259,
      "nanos": 775000000
    }
  },
  {
    "id": 27,
    "author": "model",
    "payload": {
      "type": "text",
      "text": "C'est un problème de synchronisation classique dans ce type d'architecture distribuée : l'utilisateur a son UID correctement inscrit dans l'équipe (collection `agencies`), mais son profil utilisateur (collection `users`) est resté bloqué sur le rôle `pending`.\n\nVoici les correctifs demandés :\n\n1.  **Dans `WaitingScreen.tsx`** : Ajout d'un bouton \"Dépannage / Forcer l'accès\". Ce bouton va scanner toutes les agences pour voir si l'étudiant s'y trouve déjà. Si oui, il force la mise à jour de son profil utilisateur en 'student' et recharge la page.\n2.  **Dans `AdminAccess.tsx`** : Ajout des boutons pour **Promouvoir en Superviseur** et **Refuser (Supprimer)** un utilisateur en attente dans la liste des utilisateurs déconnectés.\n\nVoici les modifications :\n\n",
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1767995259,
      "nanos": 775000000
    },
    "doneTimestamp": {
      "seconds": 1767995259,
      "nanos": 776000000
    }
  },
  {
    "id": 28,
    "author": "model",
    "payload": {
      "type": "generationTable",
      "entries": [
        {
          "path": "components/WaitingScreen.tsx",
          "generationType": 1,
          "isDone": true,
          "description": "Ajout d'un bouton d'auto-réparation pour les étudiants bloqués et amélioration de l'UX d'attente.",
          "diffs": [
            {
              "target": "",
              "replacement": "\nimport React, { useEffect, useState } from 'react';\nimport { Loader2, TrendingUp, Wallet, Users, AlertTriangle, Fingerprint, RefreshCw, CheckCircle2 } from 'lucide-react';\nimport { useAuth } from '../contexts/AuthContext';\nimport { useGame } from '../contexts/GameContext';\nimport { signOut, auth, db, doc, onSnapshot, updateDoc } from '../services/firebase';\nimport { MASCOTS } from '../constants';\nimport { useUI } from '../contexts/UIContext';\n\nconst ONBOARDING_SLIDES = [\n    {\n        icon: <TrendingUp size={48} className=\"text-emerald-500\" />,\n        title: \"La VE est Reine\",\n        text: \"Votre Valeur d'Entreprise (VE) détermine votre note finale (40%). Elle fluctue selon la qualité de vos rendus et vos décisions.\"\n    },\n    {\n        icon: <Wallet size={48} className=\"text-amber-500\" />,\n        title: \"Gérez votre Cash\",\n        text: \"Chaque étudiant coûte un salaire. Gérez votre trésorerie (PiXi) pour éviter la faillite et le malus de VE.\"\n    },\n    {\n        icon: <Users size={48} className=\"text-indigo-500\" />,\n        title: \"L'Agence avant tout\",\n        text: \"La performance collective prime. Un bon élément dans une agence qui coule ne suffira pas à valider le semestre.\"\n    },\n    {\n        icon: <AlertTriangle size={48} className=\"text-red-500\" />,\n        title: \"Gérez les Crises\",\n        text: \"Le marché est instable. Attendez-vous à des imprévus (Inflation, Pénuries) et réagissez vite.\"\n    }\n];\n\nexport const WaitingScreen: React.FC = () => {\n    const { userData } = useAuth();\n    const { agencies } = useGame(); // Accès aux données de jeu pour vérifier si l'étudiant est déjà dedans\n    const { toast } = useUI();\n    const [currentSlide, setCurrentSlide] = useState(0);\n    const [isChecking, setIsChecking] = useState(false);\n\n    // Auto-reload si le rôle change dans la base\n    useEffect(() => {\n        if (!userData?.uid) return;\n        try {\n            const unsub = onSnapshot(doc(db, \"users\", userData.uid), (doc) => {\n                if (doc.exists() && doc.data().role !== 'pending') {\n                    window.location.reload(); \n                }\n            });\n            return () => unsub();\n        } catch (e) { console.error(e); }\n    }, [userData]);\n\n    // Carousel Timer\n    useEffect(() => {\n        const timer = setInterval(() => {\n            setCurrentSlide((prev) => (prev + 1) % ONBOARDING_SLIDES.length);\n        }, 5000);\n        return () => clearInterval(timer);\n    }, []);\n\n    // --- SELF REPAIR FUNCTION ---\n    const handleSelfFix = async () => {\n        if (!userData?.uid) return;\n        setIsChecking(true);\n\n        try {\n            // 1. Chercher si l'UID est présent dans une agence\n            let foundAgency = null;\n            let foundMember = null;\n\n            for (const agency of agencies) {\n                const member = agency.members.find(m => m.id === userData.uid);\n                if (member) {\n                    foundAgency = agency;\n                    foundMember = member;\n                    break;\n                }\n            }\n\n            if (foundAgency && foundMember) {\n                // 2. Si trouvé, forcer la mise à jour du profil utilisateur\n                await updateDoc(doc(db, \"users\", userData.uid), {\n                    role: 'student',\n                    agencyId: foundAgency.id,\n                    studentProfileName: foundMember.name,\n                    linkedStudentId: userData.uid // Confirmer le lien\n                });\n                \n                toast('success', `Compte retrouvé ! Vous êtes dans \"${foundAgency.name}\". Redirection...`);\n                \n                // Petit délai pour l'UX avant reload\n                setTimeout(() => {\n                    window.location.reload();\n                }, 1500);\n            } else {\n                toast('info', \"Votre dossier n'est pas encore validé par l'enseignant. Veuillez patienter.\");\n            }\n        } catch (error) {\n            console.error(error);\n            toast('error', \"Erreur lors de la vérification.\");\n        } finally {\n            setIsChecking(false);\n        }\n    };\n\n    return (\n        <div className=\"min-h-screen bg-slate-50 flex flex-col items-center justify-center p-6 text-center font-sans relative overflow-hidden\">\n            {/* Background Decoration */}\n            <div className=\"absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-indigo-500 via-purple-500 to-amber-500\"></div>\n            \n            {/* MASCOTTE WAITING (Cloud) */}\n            <div className=\"mb-8 relative animate-bounce-slow\">\n                 <img src={MASCOTS.LANDING_HERO} className=\"w-48 drop-shadow-2xl\" alt=\"En attente...\" />\n                 {/* Petit loader discret intégré */}\n                 <div className=\"absolute bottom-2 right-10 bg-white p-1.5 rounded-full shadow-sm\">\n                    <Loader2 size={16} className=\"text-indigo-600 animate-spin\" />\n                 </div>\n            </div>\n            \n            <h1 className=\"text-3xl font-display font-bold text-slate-900 mb-2\">\n                Bienvenue, {userData?.displayName?.split(' ')[0]}\n            </h1>\n            <p className=\"text-slate-500 mb-6 max-w-md mx-auto\">\n                Votre compte est connecté, mais il n'est pas encore relié à votre profil dans le jeu.\n                <br/><br/>\n                <span className=\"text-indigo-600 font-bold bg-indigo-50 px-2 py-1 rounded\">Demandez à votre enseignant de valider la liaison.</span>\n            </p>\n\n            {/* BOUTON DE DÉPANNAGE (SELF FIX) */}\n            <button \n                onClick={handleSelfFix}\n                disabled={isChecking}\n                className=\"mb-8 px-6 py-3 bg-white border border-indigo-200 text-indigo-700 font-bold rounded-xl shadow-sm hover:bg-indigo-50 transition-all flex items-center gap-2 text-sm\"\n            >\n                {isChecking ? <Loader2 size={18} className=\"animate-spin\"/> : <RefreshCw size={18}/>}\n                Je devrais avoir accès (Vérifier mon statut)\n            </button>\n\n            {/* Carousel Card */}\n            <div className=\"bg-white p-8 rounded-3xl border border-slate-200 shadow-sm max-w-md w-full text-center relative overflow-hidden group hover:shadow-md transition-shadow\">\n                <div className=\"h-48 flex flex-col items-center justify-center transition-all duration-500\">\n                    <div className=\"mb-6 p-4 bg-slate-50 rounded-full group-hover:scale-110 transition-transform duration-500\">\n                        {ONBOARDING_SLIDES[currentSlide].icon}\n                    </div>\n                    <h3 className=\"text-xl font-bold text-slate-900 mb-2\">\n                        {ONBOARDING_SLIDES[currentSlide].title}\n                    </h3>\n                    <p className=\"text-sm text-slate-500 leading-relaxed max-w-xs mx-auto\">\n                        {ONBOARDING_SLIDES[currentSlide].text}\n                    </p>\n                </div>\n\n                {/* Progress Indicators */}\n                <div className=\"flex justify-center gap-2 mt-8\">\n                    {ONBOARDING_SLIDES.map((_, idx) => (\n                        <div \n                            key={idx} \n                            className={`h-1.5 rounded-full transition-all duration-300 ${\n                                idx === currentSlide ? 'w-8 bg-indigo-600' : 'w-2 bg-slate-200'\n                            }`}\n                        />\n                    ))}\n                </div>\n            </div>\n\n            <div className=\"mt-8 flex flex-col gap-4 items-center\">\n                {/* DEBUG UID */}\n                <div className=\"flex items-center gap-2 text-[10px] text-slate-400 font-mono bg-slate-100 px-3 py-1.5 rounded-full select-all cursor-text\">\n                    <Fingerprint size={12}/> ID: {userData?.uid}\n                </div>\n\n                <button \n                    onClick={() => signOut(auth)}\n                    className=\"text-slate-400 hover:text-red-500 font-bold text-sm transition-colors mt-2\"\n                >\n                    Annuler et se déconnecter\n                </button>\n            </div>\n        </div>\n    );\n};\n"
            }
          ]
        },
        {
          "path": "components/AdminAccess.tsx",
          "generationType": 1,
          "isDone": true,
          "description": "Ajout des boutons Promouvoir (Superviseur) et Refuser (Supprimer) dans la liste d'attente.",
          "diffs": [
            {
              "target": "",
              "replacement": "\nimport React, { useState, useMemo, useEffect } from 'react';\nimport { Agency, Student } from '../types';\nimport { Search, Wifi, WifiOff, Link, UserCheck, ShieldCheck, Loader2, Mail, Database, ServerCrash, FileClock, History, UserX, Trash2, Edit, Save, AlertCircle, RefreshCw, PlugZap, Shield, XCircle } from 'lucide-react';\nimport { collection, query, where, onSnapshot, doc, writeBatch, updateDoc, deleteDoc, db } from '../services/firebase';\nimport { useUI } from '../contexts/UIContext';\nimport { useGame } from '../contexts/GameContext'; \nimport { Modal } from './Modal';\n\ninterface AdminAccessProps {\n  agencies: Agency[];\n  onUpdateAgencies: (agencies: Agency[]) => void;\n  readOnly?: boolean;\n}\n\ninterface UserProfile {\n    uid: string;\n    displayName: string;\n    email: string;\n    photoURL: string;\n    role: 'admin' | 'student' | 'pending' | 'supervisor';\n}\n\nexport const AdminAccess: React.FC<AdminAccessProps> = ({ agencies, onUpdateAgencies, readOnly }) => {\n  const { toast, confirm } = useUI();\n  const { resetGame } = useGame();\n  const [searchTerm, setSearchTerm] = useState('');\n  const [allUsers, setAllUsers] = useState<UserProfile[]>([]);\n  const [isResetting, setIsResetting] = useState(false);\n\n  // 1. ÉCOUTE DE TOUS LES UTILISATEURS (Pour détecter les orphelins)\n  useEffect(() => {\n    const q = query(collection(db, \"users\"));\n    const unsubscribe = onSnapshot(q, (snapshot) => {\n        const users: UserProfile[] = [];\n        snapshot.forEach((doc) => {\n            users.push({ uid: doc.id, ...doc.data() } as UserProfile);\n        });\n        setAllUsers(users);\n    });\n    return () => unsubscribe();\n  }, []);\n\n  // Extraction des données de jeu\n  const allGameStudents = useMemo(() => {\n    const students: { student: Student, agency: Agency }[] = [];\n    agencies.forEach(agency => {\n        agency.members.forEach(member => {\n            students.push({ student: member, agency });\n        });\n    });\n    return students;\n  }, [agencies]);\n\n  // Filtrage des slots libres (IDs commençant par s- ou temporaires)\n  // Ce sont les \"coquilles vides\" qui attendent un vrai utilisateur\n  const availableSlots = useMemo(() => \n    allGameStudents\n        .filter(({student}) => student.id.startsWith('s-') || student.id.startsWith('agency_'))\n        .sort((a,b) => a.student.name.localeCompare(b.student.name))\n  , [allGameStudents]);\n\n  // USERS DISCONNECTED : Ceux qui sont connectés (Auth) mais pas liés au jeu (Agencies)\n  const disconnectedUsers = useMemo(() => {\n      return allUsers.filter(u => {\n          if (u.role === 'admin' || u.role === 'supervisor') return false;\n          // L'utilisateur est-il présent dans une agence avec son UID actuel ?\n          const isLinked = allGameStudents.some(ags => ags.student.id === u.uid);\n          return !isLinked;\n      });\n  }, [allUsers, allGameStudents]);\n\n  const handleAssignStudent = async (firebaseUser: UserProfile, targetStudentId: string) => {\n      if(readOnly) return;\n      const targetAgency = agencies.find(a => a.members.some(m => m.id === targetStudentId));\n      if (!targetAgency) return;\n\n      const oldMemberData = targetAgency.members.find(m => m.id === targetStudentId);\n      if (!oldMemberData) return;\n\n      // Auto-validation si les noms sont très proches\n      const similarity = firebaseUser.displayName?.toLowerCase() === oldMemberData.name.toLowerCase();\n      \n      const confirmed = similarity ? true : await confirm({\n          title: \"Confirmer la liaison\",\n          message: `Lier le compte Google \"${firebaseUser.displayName}\" \\n\\n➡️ au profil de jeu \"${oldMemberData.name}\" (${targetAgency.name}) ?\\n\\nL'ancien ID (${targetStudentId}) sera remplacé par l'ID Google (${firebaseUser.uid}).`,\n          confirmText: \"Valider la fusion\"\n      });\n\n      if (!confirmed) return;\n\n      try {\n          const batch = writeBatch(db);\n          \n          // 1. Update User Profile in 'users' collection\n          batch.update(doc(db, \"users\", firebaseUser.uid), {\n              role: 'student',\n              agencyId: targetAgency.id,\n              linkedStudentId: targetStudentId,\n              studentProfileName: oldMemberData.name,\n              lastLogin: new Date().toISOString()\n          });\n\n          // 2. Update Agency Member in 'agencies' collection (SWAP ID)\n          const updatedMembers = targetAgency.members.map(member => \n              member.id === targetStudentId \n              ? { \n                  ...member, \n                  id: firebaseUser.uid, // CRITICAL: Swap mock ID with real Auth UID\n                  avatarUrl: firebaseUser.photoURL || member.avatarUrl, \n                  connectionStatus: 'online' as const\n                } \n              : member\n          );\n          \n          batch.update(doc(db, \"agencies\", targetAgency.id), { members: updatedMembers });\n          \n          await batch.commit();\n          toast('success', `Compte lié : ${firebaseUser.displayName} est maintenant connecté.`);\n      } catch (error) { \n          console.error(error);\n          toast('error', \"Erreur technique lors de la liaison.\"); \n      }\n  };\n\n  const handleForceOffline = async (student: Student, agencyId: string) => {\n       if(readOnly || student.id.startsWith('s-')) return;\n       if (await confirm({ title: \"Délier l'étudiant ?\", message: \"L'étudiant sera déconnecté du jeu et retournera en salle d'attente.\\nSon profil de jeu redeviendra un slot vide (bot).\", confirmText: \"Délier (Reset)\", isDangerous: true })) {\n           try {\n               const batch = writeBatch(db);\n               // Générer un nouvel ID de bot pour occuper la place\n               const newMockId = `s-reset-${Date.now()}`; \n               const agency = agencies.find(a => a.id === agencyId);\n               if (!agency) return;\n\n               // On remet un ID \"s-...\" dans l'agence\n               const updatedMembers = agency.members.map(m => m.id === student.id ? { ...m, id: newMockId, connectionStatus: 'offline' as const } : m);\n               batch.update(doc(db, \"agencies\", agencyId), { members: updatedMembers });\n               \n               // On remet l'user en 'pending'\n               batch.update(doc(db, \"users\", student.id), { role: 'pending', agencyId: null });\n               \n               await batch.commit();\n               toast('success', \"Lien rompu. Slot libéré.\");\n           } catch (e) { toast('error', \"Erreur\"); }\n       }\n  };\n\n  const handlePromoteSupervisor = async (user: UserProfile) => {\n      if(readOnly) return;\n      if(await confirm({ title: \"Promouvoir Superviseur ?\", message: `L'utilisateur ${user.displayName} aura accès au Dashboard Admin en lecture seule.`, confirmText: \"Promouvoir\" })) {\n          try {\n              await updateDoc(doc(db, \"users\", user.uid), { role: 'supervisor' });\n              toast('success', `${user.displayName} est maintenant Superviseur.`);\n          } catch(e) { console.error(e); toast('error', \"Erreur promotion\"); }\n      }\n  };\n\n  const handleRejectUser = async (user: UserProfile) => {\n      if(readOnly) return;\n      if(await confirm({ title: \"Refuser la connexion ?\", message: `Attention : Cela va supprimer le profil de ${user.displayName} de la base de données. Il devra se reconnecter.`, confirmText: \"Supprimer\", isDangerous: true })) {\n          try {\n              await deleteDoc(doc(db, \"users\", user.uid));\n              toast('success', \"Utilisateur supprimé de la liste d'attente.\");\n          } catch(e) { console.error(e); toast('error', \"Erreur suppression\"); }\n      }\n  };\n\n  const filteredStudents = allGameStudents.filter(s => s.student.name.toLowerCase().includes(searchTerm.toLowerCase()));\n\n  return (\n    <div className=\"animate-in fade-in duration-500 pb-20\">\n         <div className=\"mb-8 flex flex-col md:flex-row justify-between items-start md:items-center gap-4\">\n            <div>\n                <h2 className=\"text-3xl font-display font-bold text-slate-900 flex items-center gap-3\">\n                    <div className=\"p-2 bg-indigo-100 rounded-xl text-indigo-600\"><PlugZap size={32}/></div>\n                    Accès & Connexions\n                </h2>\n                <p className=\"text-slate-500 text-sm mt-1\">Réparez les liens entre les comptes Google et les profils du jeu.</p>\n            </div>\n            {!readOnly && (\n                <button onClick={async () => { if(await confirm({title:\"Reset Complet\", message:\"ATTENTION : Ceci va réinitialiser toute la base de données (Agences, Membres, Scores). Tous les liens seront rompus.\", isDangerous:true})) { setIsResetting(true); await resetGame(); setIsResetting(false); }}} className=\"text-xs font-bold text-slate-400 hover:text-red-600 border px-3 py-2 rounded-lg flex items-center gap-2 transition-colors\">\n                    {isResetting ? <Loader2 className=\"animate-spin\" size={14}/> : <Database size={14}/>} Factory Reset\n                </button>\n            )}\n        </div>\n\n        {/* --- SECTION CRITIQUE : UTILISATEURS DÉCONNECTÉS --- */}\n        <div className={`mb-8 border-l-4 rounded-2xl p-6 shadow-lg transition-all ${disconnectedUsers.length > 0 ? 'bg-amber-50 border-amber-500' : 'bg-slate-50 border-slate-300'}`}>\n            <h3 className={`font-bold text-lg mb-2 flex items-center gap-2 ${disconnectedUsers.length > 0 ? 'text-amber-800' : 'text-slate-500'}`}>\n                {disconnectedUsers.length > 0 ? <AlertCircle size={24} className=\"animate-pulse\"/> : <UserCheck size={24}/>}\n                File d'Attente & Problèmes de Connexion ({disconnectedUsers.length})\n            </h3>\n            \n            {disconnectedUsers.length > 0 ? (\n                <>\n                    <p className=\"text-sm text-amber-800/80 mb-6\">\n                        Ces utilisateurs sont connectés à l'application mais <strong>ne sont pas liés</strong> à une agence. \n                        <br/>Sélectionnez leur profil \"Jeu\" (Slot) dans la liste de droite pour les reconnecter.\n                    </p>\n                    <div className=\"space-y-4\">\n                        {disconnectedUsers.map(user => (\n                            <div key={user.uid} className=\"bg-white p-4 rounded-xl border border-amber-200 shadow-sm flex flex-col xl:flex-row xl:items-center justify-between gap-4 animate-in slide-in-from-left-2\">\n                                {/* GAUCHE: L'utilisateur Google */}\n                                <div className=\"flex items-center gap-4 min-w-[300px]\">\n                                    <div className=\"relative\">\n                                        <img src={user.photoURL} className=\"w-12 h-12 rounded-full border-2 border-amber-100\" alt=\"Avatar\" />\n                                        <div className=\"absolute -bottom-1 -right-1 bg-amber-500 text-white text-[9px] px-1.5 py-0.5 rounded-full font-bold\">Google</div>\n                                    </div>\n                                    <div>\n                                        <p className=\"font-bold text-slate-900 text-base\">{user.displayName}</p>\n                                        <p className=\"text-xs text-slate-500 font-mono\">{user.email}</p>\n                                        <div className=\"flex gap-2 mt-1\">\n                                            <span className={`text-[9px] font-bold px-1.5 py-0.5 rounded uppercase ${user.role === 'pending' ? 'bg-slate-100 text-slate-500' : 'bg-red-100 text-red-500'}`}>\n                                                {user.role === 'pending' ? 'En attente' : 'Lien perdu'}\n                                            </span>\n                                            <span className=\"text-[9px] text-slate-300 font-mono\" title={user.uid}>ID: ...{user.uid.slice(-4)}</span>\n                                        </div>\n                                    </div>\n                                </div>\n\n                                {/* CENTRE: Les Actions Rapides (Reject / Promote) */}\n                                {!readOnly && (\n                                <div className=\"flex gap-2\">\n                                    <button \n                                        onClick={() => handleRejectUser(user)}\n                                        className=\"p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors border border-transparent hover:border-red-100\" \n                                        title=\"Refuser / Supprimer\"\n                                    >\n                                        <XCircle size={20}/>\n                                    </button>\n                                    <button \n                                        onClick={() => handlePromoteSupervisor(user)}\n                                        className=\"p-2 text-slate-400 hover:text-purple-500 hover:bg-purple-50 rounded-lg transition-colors border border-transparent hover:border-purple-100\" \n                                        title=\"Promouvoir Superviseur\"\n                                    >\n                                        <Shield size={20}/>\n                                    </button>\n                                </div>\n                                )}\n\n                                {/* CENTRE: L'icone de lien */}\n                                <div className=\"hidden xl:flex text-slate-300\">\n                                    <Link size={24} />\n                                </div>\n\n                                {/* DROITE: Le Slot à remplir */}\n                                <div className=\"flex-1 w-full\">\n                                    <select \n                                        className=\"w-full p-3 rounded-xl bg-indigo-50/50 text-indigo-900 text-sm font-bold border border-indigo-200 outline-none focus:ring-2 focus:ring-indigo-500 transition-all cursor-pointer hover:bg-indigo-50\"\n                                        onChange={(e) => handleAssignStudent(user, e.target.value)}\n                                        defaultValue=\"\"\n                                    >\n                                        <option value=\"\" disabled>⚡️ Sélectionner le profil à lier...</option>\n                                        {availableSlots.map(({student, agency}) => (\n                                            <option key={student.id} value={student.id}>\n                                                {student.name} — {agency.name} (Classe {agency.classId})\n                                            </option>\n                                        ))}\n                                    </select>\n                                </div>\n                            </div>\n                        ))}\n                    </div>\n                </>\n            ) : (\n                <p className=\"text-sm text-slate-500 italic\">Aucun utilisateur en attente. Tout le monde est connecté.</p>\n            )}\n        </div>\n\n        {/* SECTION : ANNUAIRE GLOBAL */}\n        <div className=\"bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden min-h-[400px]\">\n            <div className=\"p-4 border-b border-slate-100 flex flex-col md:flex-row justify-between items-center gap-4 bg-slate-50/50\">\n                 <h3 className=\"font-bold text-slate-700 flex items-center gap-2\"><ShieldCheck size={18} /> Annuaire & Statut des Liens</h3>\n                 <div className=\"relative w-full md:w-64\">\n                     <Search size={16} className=\"absolute left-3 top-3 text-slate-400\"/>\n                     <input type=\"text\" placeholder=\"Rechercher un profil...\" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className=\"w-full pl-9 pr-4 py-2 bg-white border border-slate-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500\"/>\n                 </div>\n            </div>\n            <div className=\"overflow-x-auto\">\n                <table className=\"w-full text-left\">\n                    <thead className=\"bg-slate-50 text-slate-500 text-xs uppercase font-bold\">\n                        <tr>\n                            <th className=\"p-4\">Profil Jeu</th>\n                            <th className=\"p-4\">Agence</th>\n                            <th className=\"p-4\">Classe</th>\n                            <th className=\"p-4\">État du lien</th>\n                            <th className=\"p-4 text-right\">Action</th>\n                        </tr>\n                    </thead>\n                    <tbody className=\"divide-y divide-slate-100\">\n                        {filteredStudents.map(({student, agency}) => {\n                            // Un ID qui commence par \"s-\" ou \"agency_\" est un ID généré/bot, donc pas lié à un vrai user Google (qui a un ID alphanumérique long)\n                            const isLinked = !student.id.startsWith('s-') && !student.id.startsWith('agency_');\n                            \n                            return (\n                                <tr key={student.id} className=\"hover:bg-slate-50 transition-colors\">\n                                    <td className=\"p-4\">\n                                        <div className=\"flex items-center gap-3\">\n                                            <img src={student.avatarUrl} className={`w-8 h-8 rounded-full ${isLinked ? '' : 'grayscale opacity-50'}`} />\n                                            <div>\n                                                <div className=\"font-bold text-slate-900 text-sm\">{student.name}</div>\n                                                <div className=\"text-[10px] text-slate-400 font-mono\">{student.id.slice(0, 8)}...</div>\n                                            </div>\n                                        </div>\n                                    </td>\n                                    <td className=\"p-4 text-sm text-slate-600 font-medium\">{agency.name}</td>\n                                    <td className=\"p-4\">\n                                        <span className={`text-[10px] font-bold px-2 py-1 rounded ${agency.classId === 'A' ? 'bg-blue-100 text-blue-600' : 'bg-purple-100 text-purple-600'}`}>\n                                            CLASSE {agency.classId}\n                                        </span>\n                                    </td>\n                                    <td className=\"p-4\">\n                                        {isLinked ? \n                                            <span className=\"inline-flex items-center gap-1.5 text-xs font-bold text-emerald-600 bg-emerald-50 px-2 py-1 rounded-full border border-emerald-100\">\n                                                <Wifi size={12}/> Connecté\n                                            </span> \n                                            : \n                                            <span className=\"inline-flex items-center gap-1.5 text-xs font-bold text-slate-400 bg-slate-100 px-2 py-1 rounded-full border border-slate-200\" title=\"En attente de liaison avec un compte Google\">\n                                                <WifiOff size={12}/> Slot Vide (Bot)\n                                            </span>\n                                        }\n                                    </td>\n                                    <td className=\"p-4 text-right\">\n                                        <div className=\"flex gap-2 justify-end\">\n                                            {isLinked && !readOnly && (\n                                                <button \n                                                    onClick={() => handleForceOffline(student, agency.id)} \n                                                    className=\"text-xs font-bold text-slate-400 hover:text-red-500 bg-white hover:bg-red-50 border border-slate-200 hover:border-red-200 px-3 py-1.5 rounded-lg transition-all flex items-center gap-2\" \n                                                    title=\"Rompre le lien (Kick)\"\n                                                >\n                                                    <UserX size={14}/> Délier\n                                                </button>\n                                            )}\n                                        </div>\n                                    </td>\n                                </tr>\n                            )\n                        })}\n                    </tbody>\n                </table>\n            </div>\n        </div>\n    </div>\n  );\n};\n"
            }
          ]
        }
      ]
    },
    "createdTimestamp": {
      "seconds": 1767995260,
      "nanos": 705000000
    },
    "doneTimestamp": {
      "seconds": 1767995273,
      "nanos": 737000000
    }
  }
]